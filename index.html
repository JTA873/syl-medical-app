// ========== RÃˆGLES FIRESTORE OPTIMISÃ‰ES POUR SYL MEDICAL ==========
// Ã€ copier dans Firebase Console â†’ Firestore Database â†’ Rules

rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // === FONCTION HELPER POUR ADMIN ===
    function isAdmin() {
      return request.auth != null && (
        // Admin par email (votre compte)
        request.auth.token.email == 'jadetaraf@hotmail.fr' ||
        // Admin par document dans collection admins
        exists(/databases/$(database)/documents/admins/$(request.auth.uid))
      );
    }
    
    // === FONCTION HELPER POUR PROPRIÃ‰TAIRE ===
    function isOwner(resourceUserId) {
      return request.auth != null && request.auth.uid == resourceUserId;
    }
    
    // === COLLECTION PATIENTS ===
    // âœ… Fonctionnait dÃ©jÃ  - accÃ¨s admin + patients peuvent voir leur dossier
    match /patients/{patientId} {
      // Admins peuvent tout faire
      allow read, write: if isAdmin();
      
      // Patients peuvent lire/modifier leur propre dossier
      allow read, write: if isOwner(patientId);
      
      // AccÃ¨s d'urgence en lecture seule (pour QR codes/NFC)
      allow read: if true;
    }
    
    // === COLLECTION USERS ===
    // ðŸ”§ CORRECTION: Permettre lecture admin pour debug
    match /users/{userId} {
      // Admins accÃ¨s complet pour gestion et debug
      allow read, write: if isAdmin();
      
      // Utilisateurs peuvent gÃ©rer leur profil
      allow read, write: if isOwner(userId);
      
      // Lecture limitÃ©e pour compatibilitÃ© (anciens comptes)
      allow read: if request.auth != null;
    }
    
    // === COLLECTION ACTIVEUSERS ===
    // ðŸ”§ CORRECTION: Permettre accÃ¨s admin pour monitoring
    match /activeUsers/{userEmail} {
      // Admins peuvent voir tous les utilisateurs connectÃ©s
      allow read, write: if isAdmin();
      
      // Utilisateurs peuvent mettre Ã  jour leur statut
      allow write: if request.auth != null && 
        request.auth.token.email == userEmail;
      
      // Lecture limitÃ©e pour l'utilisateur concernÃ©
      allow read: if request.auth != null && 
        request.auth.token.email == userEmail;
    }
    
    // === COLLECTION NFCTAGS ===
    // âœ… Fonctionnait dÃ©jÃ 
    match /nfcTags/{tagId} {
      // Admins gestion complÃ¨te
      allow read, write: if isAdmin();
      
      // Lecture publique pour urgences (scan NFC)
      allow read: if true;
    }
    
    // === COLLECTION ADMINS ===
    // ðŸ”§ CORRECTION: Permettre lecture admin pour debug
    match /admins/{adminId} {
      // Admins peuvent voir la liste des admins
      allow read, write: if isAdmin();
      
      // Un admin peut gÃ©rer son propre profil
      allow read, write: if isOwner(adminId);
    }
    
    // === COLLECTIONS SYSTÃˆME (analytics, logs, etc.) ===
    match /analytics/{document} {
      allow read, write: if isAdmin();
    }
    
    match /logs/{document} {
      allow read, write: if isAdmin();
      allow create: if request.auth != null; // Logs utilisateur
    }
    
    match /emergencyAccess/{document} {
      allow read: if true; // AccÃ¨s d'urgence
      allow write: if isAdmin();
    }
    
    // === COLLECTION POUR DEBUG ===
    match /debug/{document} {
      allow read, write: if isAdmin();
    }
    
    // === RÃˆGLE PAR DÃ‰FAUT SÃ‰CURISÃ‰E ===
    // Toute autre collection nÃ©cessite les droits admin
    match /{document=**} {
      allow read, write: if isAdmin();
    }
  }
}

// ========== EXPLICATIONS DES CORRECTIONS ==========
/*
ðŸ”§ CORRECTIONS APPORTÃ‰ES:

1. **Collection users**: 
   - Ajout allow read: if isAdmin() pour le debug
   - Ajout allow read: if request.auth != null pour compatibilitÃ©

2. **Collection activeUsers**:
   - Ajout allow read, write: if isAdmin() pour monitoring
   - Permissions spÃ©cifiques pour chaque utilisateur

3. **Collection admins**:
   - Ajout allow read, write: if isAdmin() pour debug
   - Permissions pour auto-gestion

4. **Nouvelles collections systÃ¨me**:
   - analytics, logs, emergencyAccess, debug
   - Permissions appropriÃ©es selon l'usage

ðŸŽ¯ RÃ‰SULTAT ATTENDU:
- debugFirebaseCollections() devrait maintenant accÃ©der Ã  toutes les collections
- Plus d'erreurs "Missing or insufficient permissions" pour l'admin
- Maintien de la sÃ©curitÃ© pour les utilisateurs normaux

ðŸ“‹ INSTRUCTIONS:
1. Copiez ces rÃ¨gles dans Firebase Console
2. Allez dans Firestore Database â†’ Rules
3. Remplacez le contenu par ces rÃ¨gles
4. Cliquez "Publier"
5. Testez debugFirebaseCollections() dans votre app
*/
