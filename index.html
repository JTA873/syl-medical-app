<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>SYL Medical - Syst√®me d'Urgence</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#3B82F6">
  <meta name="description" content="Application m√©dicale d'urgence - Acc√®s rapide aux informations vitales">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="SYL Medical">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="format-detection" content="telephone=no">
  <meta name="keywords" content="medical, urgence, NFC, sant√©, emergency"}
  
  <!-- Cache Control pour √©viter les probl√®mes de cache -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  
  <!-- Version de l'application pour forcer les mises √† jour -->
  <meta name="app-version" content="2.1.0">
  <meta name="build-date" content="2025-07-23">
  
  <!-- PWA -->
  <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIlNZTCBNZWRpY2FsIC0gU3lzdMOobWUgZCdVcmdlbmNlIiwKICAic2hvcnRfbmFtZSI6ICJTWUwgTWVkaWNhbCIsCiAgImRlc2NyaXB0aW9uIjogIkFwcGxpY2F0aW9uIG3DqWRpY2FsZSBkJ3VyZ2VuY2UiLAogICJzdGFydF91cmwiOiAiLyIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI0ZGRkZGRiIsCiAgInRoZW1lX2NvbG9yIjogIiMzQjgyRjYiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUI0Yld4dWN6MGlhSFIwY0RvdkwzZDNkeTUzTXk1dmNtY3ZNakF3TUM5emRtY2lJSFpwWlhkQ2IzZzlJakFnTUNBNE1EQWdPREF3SWo0OFl5QjRQU0k0TURBaUlIazlJalEzTWlJZ1kzZzlJakU1TWlJZ1kzazlJakk0SWlCeVBTSTFNaUl2UGp3dmMzWm5QZz09IiwKICAgICAgInNpemVzIjogIjUxMng1MTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIgogICAgfQogIF0sCiAgImNhdGVnb3JpZXMiOiBbIm1lZGljYWwiLCAiaGVhbHRoIiwgImVtZXJnZW5jeSJdCn0=">
  <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA4MDAgODAwIj48YyB4PSI4MDAiIHk9IjQ3MiIgY3g9IjE5MiIgY3k9IjI4IiByPSI1MiIvPjwvc3ZnPg==">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <!-- V√©rification du chargement des librairies -->
  <script>
    // Optimisations mobiles et PWA
    window.addEventListener('load', function() {
      console.log('QRious disponible:', typeof QRious !== 'undefined');
      console.log('jsPDF disponible:', typeof window.jspdf !== 'undefined');
      
      // Attendre un peu plus si les librairies ne sont pas encore charg√©es
      if (typeof QRious === 'undefined' || typeof window.jspdf === 'undefined') {
        console.warn('Librairies non charg√©es, nouvelle tentative dans 2s...');
        setTimeout(() => {
          console.log('QRious disponible (2e tentative):', typeof QRious !== 'undefined');
          console.log('jsPDF disponible (2e tentative):', typeof window.jspdf !== 'undefined');
        }, 2000);
      }
      
      // Optimisations PWA et performances mobiles
      initMobileOptimizations();
    });
    
    // Fonction d'optimisation mobile
    function initMobileOptimizations() {
      // D√©sactiver le zoom sur les inputs sur iOS
      if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
        const viewport = document.querySelector('meta[name=viewport]');
        if (viewport) {
          viewport.setAttribute('content', 
            'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no'
          );
        }
      }
      
      // Optimiser les scrolls sur mobile
      document.addEventListener('touchstart', function(){}, {passive: true});
      document.addEventListener('touchmove', function(){}, {passive: true});
      
      // Gestionnaire de resize pour optimiser l'affichage
      let resizeTimeout;
      window.addEventListener('resize', function() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(function() {
          // R√©ajuster l'interface apr√®s rotation d'√©cran
          if (window.innerWidth !== window.screen.width) {
            document.body.style.height = window.innerHeight + 'px';
          }
        }, 250);
      });
      
      // Am√©liorer les performances de scroll
      let ticking = false;
      function updateScrollPosition() {
        // Optimisations pendant le scroll
        ticking = false;
      }
      
      function requestTick() {
        if (!ticking) {
          requestAnimationFrame(updateScrollPosition);
          ticking = true;
        }
      }
      
      window.addEventListener('scroll', requestTick, {passive: true});
      
      // Pr√©charger les ressources critiques
      const criticalImages = document.querySelectorAll('img[data-critical]');
      criticalImages.forEach(img => {
        const src = img.dataset.src;
        if (src) {
          img.src = src;
        }
      });
      
      // Support offline basique
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js').catch(err => {
          console.log('Service Worker registration failed:', err);
        });
      }
      
      // D√©tection de la connectivit√©
      window.addEventListener('online', function() {
        console.log('üåê Connexion r√©tablie');
        showNetworkStatus('online');
      });
      
      window.addEventListener('offline', function() {
        console.log('üì¥ Connexion perdue');
        showNetworkStatus('offline');
      });
    }
    
    // Affichage du statut r√©seau
    function showNetworkStatus(status) {
      const existing = document.getElementById('network-status');
      if (existing) existing.remove();
      
      const statusEl = document.createElement('div');
      statusEl.id = 'network-status';
      statusEl.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-lg text-sm font-medium ${
        status === 'online' 
          ? 'bg-green-100 text-green-800 border border-green-200' 
          : 'bg-red-100 text-red-800 border border-red-200'
      }`;
      statusEl.textContent = status === 'online' ? 'üåê En ligne' : 'üì¥ Hors ligne';
      
      document.body.appendChild(statusEl);
      
      setTimeout(() => {
        if (statusEl.parentNode) {
          statusEl.remove();
        }
      }, 3000);
    }
    
    // Touch gestures am√©lior√©s
    function addTouchGestures() {
      let startY, endY;
      
      document.addEventListener('touchstart', function(e) {
        startY = e.touches[0].clientY;
      }, {passive: true});
      
      document.addEventListener('touchend', function(e) {
        endY = e.changedTouches[0].clientY;
        const deltaY = startY - endY;
        
        // Swipe up pour actualiser (sur certains √©crans)
        if (deltaY < -150 && window.scrollY === 0) {
          // Pull to refresh - optionnel
          console.log('Pull to refresh d√©tect√©');
        }
      }, {passive: true});
    }
    
    // Initialiser les gestes au chargement
    document.addEventListener('DOMContentLoaded', addTouchGestures);
  </script>
  <style>
    /* Reset et base mobile-first */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    html, body {
      height: 100%;
      overflow-x: hidden;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    }
    
    body {
      line-height: 1.6;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding-bottom: env(safe-area-inset-bottom);
    }
    
    /* Variables CSS pour th√®me coh√©rent */
    :root {
      --primary-color: #3B82F6;
      --primary-dark: #1E40AF;
      --secondary-color: #10B981;
      --danger-color: #EF4444;
      --warning-color: #F59E0B;
      --surface-color: #FFFFFF;
      --surface-dark: #F8FAFC;
      --text-primary: #1F2937;
      --text-secondary: #6B7280;
      --border-color: #E5E7EB;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      --radius-sm: 0.375rem;
      --radius-md: 0.5rem;
      --radius-lg: 0.75rem;
      --radius-xl: 1rem;
    }
    
    /* Legacy support - garde animations existantes */
    .animate-spin { animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .modal-bg { background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
    .modal { z-index: 50; }
    .icon { width: 1em; height: 1em; display: inline-block; vertical-align: middle; }
    .emergency-card { border-left: 4px solid #ef4444; }
    .critical-info { background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); }
    
    /* Mobile-first layout */
    .container {
      max-width: 100%;
      margin: 0 auto;
      padding: 0 1rem;
    }
    
    @media (min-width: 640px) {
      .container { max-width: 640px; }
    }
    
    @media (min-width: 768px) {
      .container { max-width: 768px; padding: 0 2rem; }
    }
    
    @media (min-width: 1024px) {
      .container { max-width: 1024px; }
    }
    
    /* Touch-friendly buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-height: 48px; /* iOS/Android touch target */
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: var(--radius-lg);
      font-weight: 600;
      font-size: 1rem;
      line-height: 1;
      text-decoration: none;
      cursor: pointer;
      transition: all 0.2s ease;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      position: relative;
      overflow: hidden;
    }
    
    .btn:active {
      transform: scale(0.98);
    }
    
    .btn-primary {
      background: var(--primary-color);
      color: white;
      box-shadow: var(--shadow-md);
    }
    
    .btn-primary:hover, .btn-primary:focus {
      background: var(--primary-dark);
      box-shadow: var(--shadow-lg);
    }
    
    /* Navigation mobile bottom */
    .mobile-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--surface-color);
      border-top: 1px solid var(--border-color);
      box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      padding: env(safe-area-inset-bottom) 0 0 0;
    }
    
    .mobile-nav-items {
      display: flex;
      justify-content: space-around;
      padding: 0.5rem 0;
    }
    
    .mobile-nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0.5rem;
      color: var(--text-secondary);
      text-decoration: none;
      transition: all 0.2s ease;
      min-width: 60px;
      border-radius: var(--radius-md);
    }
    
    .mobile-nav-item.active,
    .mobile-nav-item:hover {
      color: var(--primary-color);
      background: rgba(59, 130, 246, 0.1);
    }
    
    .mobile-nav-icon {
      font-size: 1.25rem;
      margin-bottom: 0.25rem;
    }
    
    .mobile-nav-label {
      font-size: 0.75rem;
      font-weight: 500;
    }
    
    /* Content spacing for mobile nav */
    .main-content {
      padding-bottom: 90px; /* Space for mobile nav */
    }
    
    @media (min-width: 768px) {
      .main-content {
        padding-bottom: 0;
      }
      .mobile-nav {
        display: none;
      }
    }
    
    /* Cards responsive */
    .card {
      background: var(--surface-color);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-lg);
      overflow: hidden;
      transition: all 0.3s ease;
      margin-bottom: 1rem;
    }
    
    .card:hover {
      box-shadow: var(--shadow-xl);
      transform: translateY(-2px);
    }
    
    .card-body {
      padding: 1.5rem;
    }
    
    /* Forms responsive */
    .form-input {
      width: 100%;
      min-height: 48px;
      padding: 0.75rem 1rem;
      border: 2px solid var(--border-color);
      border-radius: var(--radius-lg);
      font-size: 1rem;
      background: var(--surface-color);
      transition: all 0.2s ease;
      -webkit-appearance: none;
      appearance: none;
    }
    
    .form-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    /* Grid responsive */
    .grid {
      display: grid;
      gap: 1rem;
    }
    
    .grid-cols-1 { grid-template-columns: repeat(1, 1fr); }
    
    @media (min-width: 768px) {
      .md\:grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
      .md\:grid-cols-3 { grid-template-columns: repeat(3, 1fr); }
    }
    
    /* Spacing utilitaires */
    .p-4 { padding: 1rem; }
    .p-6 { padding: 1.5rem; }
    .mb-4 { margin-bottom: 1rem; }
    .mb-6 { margin-bottom: 1.5rem; }
    
    /* Typography responsive */
    .text-lg { font-size: 1.125rem; }
    .text-xl { font-size: 1.25rem; }
    .text-2xl { font-size: 1.5rem; }
    
    @media (min-width: 768px) {
      .md\:text-2xl { font-size: 1.5rem; }
      .md\:text-3xl { font-size: 1.875rem; }
    }
    
    .font-semibold { font-weight: 600; }
    .text-center { text-align: center; }
    
    /* Mode sombre et accessibilit√© conserv√©s */
    @media (prefers-color-scheme: dark) {
      .dark-mode {
        background: #1a1a1a;
        color: #ffffff;
      }
      .dark-mode .bg-white {
        background: #2d2d2d !important;
        color: #ffffff !important;
      }
      .dark-mode .text-gray-900 {
        color: #ffffff !important;
      }
      .dark-mode .border-gray-200 {
        border-color: #404040 !important;
      }
    }
    
    /* Focus am√©lior√© pour navigation clavier */
    button:focus, input:focus, select:focus, textarea:focus {
      outline: 3px solid #3B82F6;
      outline-offset: 2px;
    }
    
    /* Animations r√©duites pour les utilisateurs sensibles */
    @media (prefers-reduced-motion: reduce) {
      .animate-spin {
        animation: none;
      }
      .transition-colors {
        transition: none;
      }
    }
    
    /* Responsive am√©lior√© */
    @media (max-width: 640px) {
      .mobile-stack {
        flex-direction: column;
      }
      .mobile-full {
        width: 100%;
      }
    }
    
    /* Status indicators mobiles */
    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 0.5rem;
    }
    
    .status-online { background: var(--secondary-color); }
    .status-offline { background: var(--text-secondary); }
    .status-warning { background: var(--warning-color); }
    .status-danger { background: var(--danger-color); }
    
    /* Interface Admin Mobile-First */
    .admin-container {
      min-height: 100vh;
      background: var(--surface-dark);
      display: flex;
      flex-direction: column;
    }
    
    .admin-header {
      background: var(--surface-color);
      border-bottom: 1px solid var(--border-color);
      padding: 1rem;
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: var(--shadow-sm);
    }
    
    .admin-header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .admin-title-section {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .admin-icon {
      font-size: 1.5rem;
    }
    
    .admin-title {
      font-size: 1.25rem;
      font-weight: bold;
      color: var(--text-primary);
      margin: 0;
    }
    
    .admin-status {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }
    
    .status-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      background: #10B981;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    
    .status-text {
      font-size: 0.875rem;
      color: #10B981;
      font-weight: 500;
    }
    
    .admin-info {
      font-size: 0.875rem;
      color: var(--text-secondary);
    }
    
    .mobile-logout {
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
    }
    
    /* Navigation Admin Mobile */
    .admin-nav-mobile {
      background: var(--surface-color);
      border-bottom: 1px solid var(--border-color);
      padding: 0.5rem;
      display: flex;
      overflow-x: auto;
      gap: 0.25rem;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    
    .admin-nav-mobile::-webkit-scrollbar {
      display: none;
    }
    
    .admin-nav-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0.75rem 1rem;
      border-radius: var(--radius-lg);
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-size: 0.75rem;
      transition: all 0.2s;
      white-space: nowrap;
      min-width: 80px;
    }
    
    .admin-nav-btn.active {
      background: var(--primary-color);
      color: white;
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    
    .admin-nav-btn:hover:not(.active) {
      background: var(--surface-dark);
      color: var(--text-primary);
    }
    
    .nav-icon {
      font-size: 1.25rem;
      margin-bottom: 0.25rem;
    }
    
    .nav-label {
      font-weight: 500;
    }
    
    /* Navigation Admin Desktop */
    .admin-nav-desktop {
      display: none;
      position: fixed;
      left: 0;
      top: 0;
      width: 240px;
      height: 100vh;
      background: var(--surface-color);
      border-right: 1px solid var(--border-color);
      padding: 2rem 1rem;
      z-index: 5;
    }
    
    .admin-nav-btn-desktop {
      display: flex;
      align-items: center;
      width: 100%;
      padding: 0.75rem 1rem;
      margin-bottom: 0.5rem;
      border-radius: var(--radius-lg);
      background: transparent;
      border: none;
      color: var(--text-secondary);
      text-align: left;
      transition: all 0.2s;
      gap: 0.75rem;
    }
    
    .admin-nav-btn-desktop.active {
      background: var(--primary-color);
      color: white;
      box-shadow: var(--shadow-md);
    }
    
    .admin-nav-btn-desktop:hover:not(.active) {
      background: var(--surface-dark);
      color: var(--text-primary);
    }
    
    .nav-text {
      font-weight: 500;
    }
    
    /* Contenu Admin */
    .admin-content {
      flex: 1;
      padding: 1rem;
      overflow-y: auto;
    }
    
    .admin-section {
      max-width: 100%;
    }
    
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .section-title {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--text-primary);
      margin: 0;
    }
    
    .section-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    
    .mobile-action {
      padding: 0.5rem 0.75rem;
      font-size: 0.875rem;
    }
    
    /* Cards et conteneurs */
    .content-card {
      background: var(--surface-color);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border-color);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    
    .card-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 1rem;
    }
    
    .info-card {
      background: #FEF3C7;
      border: 1px solid #F59E0B;
      border-radius: var(--radius-lg);
      padding: 1rem;
      margin-bottom: 1.5rem;
    }
    
    .info-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }
    
    .info-icon {
      font-size: 1.25rem;
    }
    
    .info-title {
      font-weight: 600;
      color: #92400E;
      margin: 0;
    }
    
    .info-content {
      font-size: 0.875rem;
      color: #92400E;
    }
    
    .info-content p {
      margin: 0.25rem 0;
    }
    
    /* States vides */
    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
    }
    
    .empty-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }
    
    .empty-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
    }
    
    .empty-description {
      color: var(--text-secondary);
      margin-bottom: 1.5rem;
    }
    
    .help-card {
      background: #EBF8FF;
      border: 1px solid #3B82F6;
      border-radius: var(--radius-lg);
      padding: 1rem;
      text-align: left;
    }
    
    .help-title {
      font-weight: 600;
      color: #1E40AF;
      margin-bottom: 0.5rem;
    }
    
    .help-list {
      font-size: 0.875rem;
      color: #1E40AF;
      margin: 0;
      padding-left: 1rem;
    }
    
    /* Cartes patients mobile */
    .mobile-cards {
      display: grid;
      gap: 1rem;
    }
    
    .patient-card {
      background: var(--surface-color);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: 1rem;
      transition: all 0.2s;
    }
    
    .patient-card:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }
    
    .patient-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.75rem;
    }
    
    .patient-info {
      flex: 1;
    }
    
    .patient-name {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 1rem;
    }
    
    .patient-email {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-top: 0.25rem;
    }
    
    .patient-status {
      margin-left: 1rem;
    }
    
    .status-active {
      background: #10B981;
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: var(--radius-md);
      font-size: 0.75rem;
      font-weight: 500;
    }
    
    .status-inactive {
      background: var(--text-secondary);
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: var(--radius-md);
      font-size: 0.75rem;
      font-weight: 500;
    }
    
    .patient-details {
      display: grid;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    
    .detail-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .detail-label {
      font-size: 0.875rem;
      color: var(--text-secondary);
      font-weight: 500;
    }
    
    .detail-value {
      font-size: 0.875rem;
      color: var(--text-primary);
    }
    
    .blood-type {
      background: #FEE2E2;
      color: #B91C1C;
      padding: 0.25rem 0.5rem;
      border-radius: var(--radius-sm);
      font-weight: 500;
    }
    
    .patient-actions {
      display: flex;
      justify-content: center;
      gap: 1rem;
      padding-top: 0.75rem;
      border-top: 1px solid var(--border-color);
    }
    
    .action-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: none;
      font-size: 1.25rem;
      transition: all 0.2s;
      cursor: pointer;
    }
    
    .view-btn {
      background: #EBF8FF;
      color: #3B82F6;
    }
    
    .view-btn:hover {
      background: #3B82F6;
      color: white;
    }
    
    .nfc-btn {
      background: #F0FDF4;
      color: #10B981;
    }
    
    .nfc-btn:hover {
      background: #10B981;
      color: white;
    }
    
    .delete-btn {
      background: #FEF2F2;
      color: #EF4444;
    }
    
    .delete-btn:hover {
      background: #EF4444;
      color: white;
    }
    
    /* Table desktop */
    .desktop-table {
      display: none;
      overflow-x: auto;
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .data-table th,
    .data-table td {
      text-align: left;
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border-color);
    }
    
    .data-table th {
      background: var(--surface-dark);
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .table-patient-info {
      display: flex;
      flex-direction: column;
    }
    
    .patient-id {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }
    
    .blood-type-badge {
      background: #FEE2E2;
      color: #B91C1C;
      padding: 0.25rem 0.5rem;
      border-radius: var(--radius-sm);
      font-size: 0.75rem;
      font-weight: 500;
    }
    
    .nfc-badge {
      background: #EBF8FF;
      color: #3B82F6;
      padding: 0.25rem 0.5rem;
      border-radius: var(--radius-sm);
      font-size: 0.75rem;
      font-weight: 500;
    }
    
    .no-nfc {
      color: var(--text-secondary);
      font-size: 0.875rem;
    }
    
    .table-actions {
      display: flex;
      gap: 0.5rem;
    }
    
    .action-btn-small {
      padding: 0.25rem;
      border: none;
      border-radius: var(--radius-sm);
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .action-btn-small.view:hover {
      background: #EBF8FF;
      color: #3B82F6;
    }
    
    .action-btn-small.nfc:hover {
      background: #F0FDF4;
      color: #10B981;
    }
    
    .action-btn-small.delete:hover {
      background: #FEF2F2;
      color: #EF4444;
    }
    
    /* Workflow NFC Styles */
    .workflow-steps {
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 2rem 0;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .workflow-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      flex: 1;
      min-width: 150px;
    }
    
    .step-number {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: var(--text-secondary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.25rem;
      margin-bottom: 0.75rem;
      transition: all 0.3s;
    }
    
    .step-number.active {
      background: var(--primary-color);
      transform: scale(1.1);
      box-shadow: var(--shadow-lg);
    }
    
    .step-content h4 {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.25rem;
      font-size: 0.9rem;
    }
    
    .step-content p {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin: 0;
    }
    
    .workflow-arrow {
      font-size: 1.5rem;
      color: var(--text-secondary);
      font-weight: bold;
    }
    
    .workflow-section {
      margin: 2rem 0;
      padding: 1.5rem;
      background: var(--surface-dark);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-color);
    }
    
    .workflow-title {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 1rem;
    }
    
    .workflow-icon {
      font-size: 1.5rem;
    }
    
    .input-group {
      margin-bottom: 1.5rem;
    }
    
    .input-label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
    }
    
    .input-with-button {
      display: flex;
      gap: 0.5rem;
    }
    
    .input-with-button .form-input {
      flex: 1;
    }
    
    .scan-result {
      margin-top: 1rem;
      padding: 0.75rem;
      border-radius: var(--radius-md);
      font-size: 0.875rem;
    }
    
    .scan-result.success {
      background: #F0FDF4;
      color: #15803D;
      border: 1px solid #10B981;
    }
    
    .scan-result.error {
      background: #FEF2F2;
      color: #DC2626;
      border: 1px solid #EF4444;
    }
    
    /* Patient Selector */
    .patient-selector {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      margin-top: 0.5rem;
    }
    
    .patient-option {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem;
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .patient-option:hover {
      background: var(--surface-dark);
    }
    
    .patient-option.selected {
      background: #EBF8FF;
      border-color: var(--primary-color);
    }
    
    .patient-option-info {
      flex: 1;
    }
    
    .patient-option-name {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.25rem;
    }
    
    .patient-option-email {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 0.25rem;
    }
    
    .patient-option-details {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }
    
    .patient-option-action {
      margin-left: 1rem;
    }
    
    .select-btn {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: var(--radius-md);
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .select-btn:hover {
      background: var(--primary-dark);
    }
    
    .selected-patient {
      margin-top: 1rem;
      padding: 1rem;
      background: #F0FDF4;
      border: 1px solid #10B981;
      border-radius: var(--radius-md);
    }
    
    /* Programming Section */
    .programming-info {
      margin-bottom: 1.5rem;
    }
    
    .generated-link {
      background: var(--surface-color);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 0.75rem;
      font-family: monospace;
      font-size: 0.875rem;
      word-break: break-all;
      margin: 0.5rem 0;
    }
    
    .link-description {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin: 0;
    }
    
    .programming-actions {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    
    .programming-result {
      margin-top: 1rem;
      padding: 0.75rem;
      border-radius: var(--radius-md);
      font-size: 0.875rem;
    }
    
    .programming-result.success {
      background: #F0FDF4;
      color: #15803D;
      border: 1px solid #10B981;
    }
    
    .programming-result.error {
      background: #FEF2F2;
      color: #DC2626;
      border: 1px solid #EF4444;
    }
    
    /* NFC Assignments */
    .nfc-assignments {
      display: grid;
      gap: 1rem;
    }
    
    .nfc-assignment-card {
      background: var(--surface-color);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      transition: all 0.2s;
    }
    
    .nfc-assignment-card:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }
    
    .assignment-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1rem;
    }
    
    .tag-info {
      flex: 1;
    }
    
    .tag-id {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 1.125rem;
    }
    
    .tag-description {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-top: 0.25rem;
    }
    
    .assignment-patient {
      margin-bottom: 1rem;
      padding: 0.75rem;
      background: var(--surface-dark);
      border-radius: var(--radius-md);
    }
    
    .patient-name {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.25rem;
    }
    
    .patient-email {
      font-size: 0.875rem;
      color: var(--text-secondary);
    }
    
    .assignment-link {
      margin-bottom: 1rem;
    }
    
    .link-label {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
    }
    
    .emergency-link {
      background: var(--surface-color);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 0.5rem;
      font-family: monospace;
      font-size: 0.75rem;
      word-break: break-all;
      color: var(--primary-color);
    }
    
    .assignment-actions {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    
    .test-btn {
      background: #EBF8FF;
      color: #3B82F6;
    }
    
    .test-btn:hover {
      background: #3B82F6;
      color: white;
    }
    
    .edit-btn {
      background: #F3E8FF;
      color: #7C3AED;
    }
    
    .edit-btn:hover {
      background: #7C3AED;
      color: white;
    }
    
    .assignment-meta {
      border-top: 1px solid var(--border-color);
      padding-top: 0.75rem;
      color: var(--text-secondary);
      font-size: 0.75rem;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .workflow-steps {
        flex-direction: column;
        gap: 1.5rem;
      }
      
      .workflow-arrow {
        transform: rotate(90deg);
      }
      
      .programming-actions {
        flex-direction: column;
      }
      
      .assignment-actions {
        justify-content: center;
      }
    }
    
    /* Responsive design */
    @media (min-width: 768px) {
      .admin-nav-mobile {
        display: none;
      }
      
      .admin-nav-desktop {
        display: block;
      }
      
      .admin-content {
        margin-left: 240px;
        padding: 2rem;
      }
      
      .mobile-cards {
        display: none;
      }
      
      .desktop-table {
        display: block;
      }
      
      .mobile-action {
        padding: 0.75rem 1rem;
        font-size: 1rem;
      }
    }
    
    @media (min-width: 1024px) {
      .admin-content {
        padding: 2rem 3rem;
      }
      
      .section-title {
        font-size: 2rem;
      }
      
      .mobile-cards {
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      }
    }
  </style>
</head>
<body class="bg-gray-50">
<div id="app">
  <!-- Loading screen initial -->
  <div class="min-h-screen bg-gray-50 flex items-center justify-center" id="initialLoader">
    <div class="text-center">
      <div class="w-16 h-16 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
      <p class="text-gray-600">Chargement de SYL Medical...</p>
    </div>
  </div>
  
  <!-- Contenu principal avec navigation mobile -->
  <div class="main-content" id="mainApp" style="display: none;">
    <!-- Le contenu de l'app sera inject√© ici -->
  </div>
  
  <!-- Navigation mobile bottom (visible uniquement sur mobile) -->
  <nav class="mobile-nav" id="mobileNav" style="display: none;">
    <div class="mobile-nav-items">
      <a href="#" class="mobile-nav-item" id="nav-dashboard" onclick="switchTab('dashboard')">
        <div class="mobile-nav-icon">üè†</div>
        <div class="mobile-nav-label">Accueil</div>
      </a>
      <a href="#" class="mobile-nav-item" id="nav-profile" onclick="switchTab('profile')">
        <div class="mobile-nav-icon">üë§</div>
        <div class="mobile-nav-label">Profil</div>
      </a>
      <a href="#" class="mobile-nav-item" id="nav-emergency" onclick="switchTab('emergency')">
        <div class="mobile-nav-icon">üö®</div>
        <div class="mobile-nav-label">Urgence</div>
      </a>
      <a href="#" class="mobile-nav-item" id="nav-nfc" onclick="switchTab('nfc')">
        <div class="mobile-nav-icon">üì±</div>
        <div class="mobile-nav-label">NFC</div>
      </a>
      <a href="#" class="mobile-nav-item" id="nav-settings" onclick="switchTab('settings')">
        <div class="mobile-nav-icon">‚öôÔ∏è</div>
        <div class="mobile-nav-label">R√©glages</div>
      </a>
    </div>
  </nav>
</div>
<script>
// Gestion d'erreur globale
window.onerror = function(msg, url, lineNo, columnNo, error) {
  console.error('Erreur JavaScript:', msg, '√† la ligne', lineNo);
  document.getElementById('app').innerHTML = `
    <div class="min-h-screen bg-red-50 flex items-center justify-center p-4">
      <div class="bg-white rounded-lg shadow-lg p-6 max-w-md">
        <h2 class="text-xl font-bold text-red-600 mb-4">Erreur JavaScript</h2>
        <p class="text-gray-700 mb-2"><strong>Message:</strong> ${msg}</p>
        <p class="text-gray-700 mb-4"><strong>Ligne:</strong> ${lineNo}</p>
        <button onclick="location.reload()" class="bg-blue-600 text-white px-4 py-2 rounded">R√©essayer</button>
      </div>
    </div>
  `;
  return true;
};

console.log("SYL Medical - D√©but du chargement");

// ========== SYST√àME DE STOCKAGE FIRESTORE (REMPLACEMENT LOCALSTORAGE) ==========

// Configuration temps r√©el - tout sur Firestore
let isRealtimeEnabled = false;
let firestoreListeners = [];

// Fonction pour initialiser la synchronisation temps r√©el
async function initRealtimeSync() {
  if (!db || isRealtimeEnabled) return;
  
  console.log("üî• Initialisation de la synchronisation temps r√©el Firestore");
  
  try {
    // Listener pour les patients (remplace localStorage syl-patients)
    const patientsListener = db.collection('patients').onSnapshot((snapshot) => {
      console.log("üîÑ Mise √† jour temps r√©el des patients");
      const patients = [];
      snapshot.forEach(doc => {
        patients.push({
          id: doc.id,
          ...doc.data()
        });
      });
      
      // Notifier les changements √† l'interface
      window.dispatchEvent(new CustomEvent('patientsUpdated', { detail: patients }));
    }, (error) => {
      console.warn("‚ö†Ô∏è Listener patients en erreur (utilisation du cache local):", error.message);
      // Continuer avec les donn√©es locales
    });
    
    // Listener pour les utilisateurs (remplace localStorage syl-user)
    const usersListener = db.collection('users').onSnapshot((snapshot) => {
      console.log("üîÑ Mise √† jour temps r√©el des utilisateurs");
      const users = [];
      snapshot.forEach(doc => {
        users.push({
          id: doc.id,
          ...doc.data()
        });
      });
      
      window.dispatchEvent(new CustomEvent('usersUpdated', { detail: users }));
    }, (error) => {
      console.warn("‚ö†Ô∏è Listener utilisateurs en erreur (non critique):", error.message);
    });
    
    firestoreListeners.push(patientsListener, usersListener);
    isRealtimeEnabled = true;
    console.log("‚úÖ Synchronisation temps r√©el activ√©e");
    
  } catch (error) {
    console.warn("‚ö†Ô∏è Synchronisation temps r√©el partielle:", error.message);
    console.log("üì± Utilisation du mode hors ligne");
  }
}

// Fonction pour nettoyer les listeners
function cleanupRealtimeSync() {
  firestoreListeners.forEach(unsubscribe => unsubscribe());
  firestoreListeners = [];
  isRealtimeEnabled = false;
  console.log("üî• Listeners Firestore nettoy√©s");
}

// Remplacements des fonctions localStorage par Firestore

// Sauvegarder un patient (remplace localStorage.setItem pour patients)
async function savePatientToFirestore(patient) {
  if (!db) throw new Error("Firestore non initialis√©");
  
  try {
    // Utiliser l'UID de l'utilisateur comme ID du document patient
    const currentUser = getCurrentUser();
    const userId = currentUser?.uid || patient.uid;
    
    if (!userId) {
      throw new Error("Impossible de sauvegarder: UID utilisateur manquant");
    }
    
    const docRef = db.collection('patients').doc(userId);
    
    const patientData = {
      ...patient,
      uid: userId,
      id: userId, // Synchroniser id et uid
      lastModified: firebase.firestore.FieldValue.serverTimestamp(),
      modifiedBy: currentUser?.email || patient.email || 'unknown'
    };
    
    await docRef.set(patientData, { merge: true });
    console.log("üíæ Patient sauvegard√© sur Firestore:", userId);
    return userId;
    
  } catch (error) {
    console.error("‚ùå Erreur sauvegarde patient:", error);
    throw error;
  }
}

// Charger tous les patients (remplace JSON.parse(localStorage.getItem('syl-patients')))
async function loadPatientsFromFirestore() {
  if (!db) throw new Error("Firestore non initialis√©");
  
  try {
    const snapshot = await db.collection('patients').orderBy('lastModified', 'desc').get();
    const patients = [];
    
    snapshot.forEach(doc => {
      patients.push({
        id: doc.id,
        ...doc.data()
      });
    });
    
    console.log(`üìä ${patients.length} patients charg√©s depuis Firestore`);
    
    // Corriger automatiquement les donn√©es manquantes (admin uniquement)
    await autoFixPatientsData(snapshot);
    
    return patients;
    
  } catch (error) {
    console.error("‚ùå Erreur chargement patients:", error);
    return [];
  }
}

// Fonction pour corriger automatiquement les donn√©es manquantes des patients
async function autoFixPatientsData(snapshot) {
  if (!db || !snapshot) return;
  
  const currentUser = getCurrentUser();
  if (!currentUser || currentUser.role !== 'admin') return; // Seulement pour admin
  
  let fixCount = 0;
  const fixes = [];
  
  snapshot.forEach(doc => {
    const patient = doc.data();
    let needsFix = false;
    const updates = {};
    
    // V√©rifier uid
    if (!patient.uid) {
      updates.uid = doc.id;
      needsFix = true;
    }
    
    // V√©rifier id
    if (!patient.id) {
      updates.id = doc.id;
      needsFix = true;
    }
    
    // V√©rifier email
    if (!patient.email && patient.personalInfo?.email) {
      updates.email = patient.personalInfo.email;
      needsFix = true;
    }
    
    // V√©rifier role
    if (!patient.role) {
      updates.role = 'patient';
      needsFix = true;
    }
    
    if (needsFix) {
      fixes.push(
        db.collection('patients').doc(doc.id).update({
          ...updates,
          autoFixedAt: firebase.firestore.FieldValue.serverTimestamp()
        })
      );
      fixCount++;
    }
  });
  
  if (fixes.length > 0) {
    try {
      await Promise.all(fixes);
      console.log(`üîß ${fixCount} patients corrig√©s automatiquement (champs manquants ajout√©s)`);
    } catch (error) {
      console.warn('‚ö†Ô∏è Correction auto ignor√©e:', error.message);
    }
  }
}

// Supprimer un patient (remplace la logique localStorage)
async function deletePatientFromFirestore(patientId) {
  if (!db) throw new Error("Firestore non initialis√©");
  
  try {
    // Supprimer le document patient
    await db.collection('patients').doc(patientId).delete();
    
    // Supprimer aussi de la collection users si c'est un compte utilisateur
    const userQuery = await db.collection('users').where('patientId', '==', patientId).get();
    const deletePromises = [];
    userQuery.forEach(doc => {
      deletePromises.push(db.collection('users').doc(doc.id).delete());
    });
    
    await Promise.all(deletePromises);
    console.log("üóëÔ∏è Patient supprim√© de Firestore:", patientId);
    
  } catch (error) {
    console.error("‚ùå Erreur suppression patient:", error);
    throw error;
  }
}

// Sauvegarder l'utilisateur connect√© (remplace localStorage syl-user)
async function saveCurrentUserToFirestore(user) {
  if (!db) return;
  
  try {
    // Structure coh√©rente pour tous les utilisateurs
    const userDoc = {
      uid: user.uid,
      email: user.email,
      role: user.role || 'patient',
      displayName: user.displayName || null,
      phone: user.phone || null,
      profile: {
        firstName: user.profile?.firstName || user.firstName || '',
        lastName: user.profile?.lastName || user.lastName || '',
        phone: user.profile?.phone || user.phone || ''
      },
      lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
      isOnline: true,
      createdAt: user.createdAt || new Date().toISOString()
    };
    
    await db.collection('activeUsers').doc(user.email).set(userDoc, { merge: true });
    console.log("üë§ Utilisateur actif sauvegard√©:", user.email);
    
  } catch (error) {
    console.warn("‚ö†Ô∏è Sauvegarde statut utilisateur ignor√©e (non critique):", error.message);
    // Cette erreur n'est pas critique pour le fonctionnement de l'app
  }
}

// Nettoyer l'utilisateur √† la d√©connexion
async function removeCurrentUserFromFirestore(userEmail) {
  if (!db || !userEmail) return;
  
  try {
    await db.collection('activeUsers').doc(userEmail).update({
      isOnline: false,
      lastLogout: firebase.firestore.FieldValue.serverTimestamp()
    });
    console.log("üë§ Utilisateur marqu√© hors ligne:", userEmail);
    
  } catch (error) {
    console.error("‚ùå Erreur mise √† jour statut utilisateur:", error);
  }
}

// Migration automatique des utilisateurs vers patients
async function autoMigrateUsersToPatients() {
  if (!db) return;
  
  try {
    console.log("üîÑ Migration automatique des utilisateurs vers patients...");
    
    // Chercher tous les utilisateurs avec le r√¥le 'patient'
    const usersSnapshot = await db.collection('users').where('role', '==', 'patient').get();
    const migrationPromises = [];
    let migratedCount = 0;
    
    usersSnapshot.forEach(userDoc => {
      const userData = userDoc.data();
      
      // Cr√©er un document patient complet
      const patientData = {
        id: userDoc.id,
        uid: userData.uid || userDoc.id,
        email: userData.email,
        role: 'patient',
        personalInfo: userData.personalInfo || {
          firstName: userData.firstName || '',
          lastName: userData.lastName || '',
          birthDate: userData.birthDate || '',
          phone: userData.phone || '',
          address: userData.address || ''
        },
        medicalInfo: userData.medicalInfo || {
          allergies: [],
          medications: [],
          conditions: [],
          bloodType: '',
          emergencyNotes: ''
        },
        emergencyContact: userData.emergencyContact || {
          name: '',
          relationship: '',
          phone: ''
        },
        emergencyInfo: userData.emergencyInfo || {
          criticalNotes: ''
        },
        isActive: userData.isActive !== undefined ? userData.isActive : true,
        nfcTagId: userData.nfcTagId || null,
        createdAt: userData.createdAt || userData.timestamp || new Date().toISOString(),
        lastModified: firebase.firestore.FieldValue.serverTimestamp(),
        modifiedBy: 'auto-migration'
      };
      
      // Migration vers la collection patients
      const migrationPromise = db.collection('patients').doc(userDoc.id).set(patientData, { merge: true });
      migrationPromises.push(migrationPromise);
      migratedCount++;
    });
    
    if (migrationPromises.length > 0) {
      await Promise.all(migrationPromises);
      console.log(`‚úÖ Migration termin√©e: ${migratedCount} utilisateurs migr√©s vers patients`);
    } else {
      console.log("‚ÑπÔ∏è Aucun utilisateur √† migrer");
    }
    
  } catch (error) {
    console.error("‚ùå Erreur lors de la migration automatique:", error);
  }
}

// ========== GESTION DE VERSION ET CACHE ==========
const APP_VERSION = "2.1.0";
const BUILD_DATE = "2025-07-23";

// Fonction de nettoyage du cache et v√©rification de version
function checkAndUpdateVersion() {
  const storedVersion = localStorage.getItem('syl-app-version');
  const storedBuildDate = localStorage.getItem('syl-build-date');
  
  console.log(`üì± Version actuelle: ${APP_VERSION}, stock√©e: ${storedVersion}`);
  
  if (storedVersion !== APP_VERSION || storedBuildDate !== BUILD_DATE) {
    console.log("üîÑ Nouvelle version d√©tect√©e, nettoyage du cache...");
    
    // Sauvegarder les donn√©es utilisateur importantes
    const userData = localStorage.getItem('syl-user');
    const patientData = localStorage.getItem('syl-patients');
    
    // Nettoyer tout le localStorage sauf les donn√©es critiques
    const itemsToKeep = ['syl-user', 'syl-patients'];
    const allKeys = Object.keys(localStorage);
    
    allKeys.forEach(key => {
      if (!itemsToKeep.includes(key)) {
        localStorage.removeItem(key);
      }
    });
    
    // Mettre √† jour la version
    localStorage.setItem('syl-app-version', APP_VERSION);
    localStorage.setItem('syl-build-date', BUILD_DATE);
    
    // Forcer le rafra√Æchissement du cache du navigateur
    if ('caches' in window) {
      caches.keys().then(names => {
        names.forEach(name => {
          caches.delete(name);
        });
      });
    }
    
    console.log("‚úÖ Cache nettoy√©, version mise √† jour");
    
    // Afficher un message √† l'utilisateur sur mobile
    if (window.innerWidth <= 768) {
      setTimeout(() => {
        alert("üì± Application mise √† jour !\nLes am√©liorations ont √©t√© appliqu√©es.");
      }, 1000);
    }
  }
}

// V√©rification de version au chargement
checkAndUpdateVersion();

// D√©tection de probl√®mes de cache sur mobile
function detectMobileIssues() {
  const isMobile = window.innerWidth <= 768 || /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
  
  if (isMobile) {
    console.log("üì± Mobile d√©tect√©, optimisations activ√©es");
    
    // D√©sactiver le cache agressif sur mobile
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations().then(registrations => {
        registrations.forEach(registration => {
          registration.unregister();
        });
      });
    }
    
    // Nettoyage simple sans rechargement automatique
    console.log("‚úÖ Optimisations mobile appliqu√©es");
  }
}

detectMobileIssues();

// Configuration Firebase s√©curis√©e
const firebaseConfig = {
  apiKey: "AIzaSyDqII2vBhBybNhVcr1QktyhvVeBW2TO0KA",
  authDomain: "syl-medical-app-1c58a.firebaseapp.com",
  databaseURL: "https://syl-medical-app-1c58a-default-rtdb.firebaseio.com",
  projectId: "syl-medical-app-1c58a",
  storageBucket: "syl-medical-app-1c58a.firebasestorage.app",
  messagingSenderId: "765684422018",
  appId: "1:765684422018:web:19320fe1e546631fc86b9b",
  measurementId: "G-PD7TP5J233"
};

// Comptes admin pr√©d√©finis
const adminAccounts = {
  'jadetaraf@hotmail.fr': 'ADMINTARAF',
  'antho30640@hotmail.fr': 'ADMINADMIN'
};

// Variables Firebase globales
let db, auth, googleProvider;

// Initialiser Firebase avec gestion d'erreur robuste
try {
  firebase.initializeApp(firebaseConfig);
  db = firebase.firestore();
  auth = firebase.auth();
  googleProvider = new firebase.auth.GoogleAuthProvider();
  console.log("Firebase initialis√© avec succ√®s");
  
  // Configuration suppl√©mentaire pour mobile
  if (window.innerWidth <= 768) {
    auth.settings.appVerificationDisabledForTesting = false;
    db.settings({
      timestampsInSnapshots: true,
      cacheSizeBytes: 1048576 // 1MB cache
    });
  }
  
} catch (error) {
  console.error("Erreur Firebase:", error);
  document.getElementById('app').innerHTML = `
    <div class="min-h-screen bg-red-50 flex items-center justify-center p-4">
      <div class="bg-white rounded-lg shadow-lg p-6 max-w-md">
        <h2 class="text-xl font-bold text-red-600 mb-4">Erreur Firebase</h2>
        <p class="text-gray-700 mb-4">Impossible d'initialiser Firebase: ${error.message}</p>
        <div class="space-y-2">
          <button onclick="location.reload()" class="w-full bg-blue-600 text-white px-4 py-2 rounded">R√©essayer</button>
          <button onclick="clearAllCache()" class="w-full bg-red-600 text-white px-4 py-2 rounded">Vider le cache</button>
        </div>
      </div>
    </div>
  `;
}

// Fonction pour vider compl√®tement le cache
window.clearAllCache = function() {
  // Vider localStorage
  localStorage.clear();
  
  // Vider sessionStorage
  sessionStorage.clear();
  
  // Vider les caches du service worker
  if ('caches' in window) {
    caches.keys().then(names => {
      names.forEach(name => caches.delete(name));
    });
  }
  
  // D√©sinscrire les service workers
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistrations().then(registrations => {
      registrations.forEach(registration => registration.unregister());
    });
  }
  
  alert("Cache vid√© ! Rechargement en cours...");
  setTimeout(() => {
    window.location.href = window.location.href.split('?')[0] + '?nocache=' + Date.now();
  }, 1000);
};

// Gestion globale des erreurs JavaScript
window.addEventListener('error', function(e) {
  console.error('Erreur JavaScript d√©tect√©e:', e.error);
  
  // Sur mobile, proposer un nettoyage de cache en cas d'erreur
  if (window.innerWidth <= 768 && e.error && e.error.message) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white p-3 rounded-lg shadow-lg z-50 max-w-sm';
    errorDiv.innerHTML = `
      <div class="text-sm font-medium">Erreur d√©tect√©e</div>
      <div class="text-xs mt-1 opacity-90">${e.error.message.substring(0, 50)}...</div>
      <button onclick="this.parentElement.remove()" class="absolute top-1 right-1 text-white opacity-75 hover:opacity-100">√ó</button>
    `;
    document.body.appendChild(errorDiv);
    
    // Auto-suppression apr√®s 5 secondes
    setTimeout(() => {
      if (errorDiv.parentElement) {
        errorDiv.remove();
      }
    }, 5000);
  }
});

// D√©tection de perte de connexion r√©seau
window.addEventListener('online', function() {
  console.log('üì∂ Connexion r√©tablie');
  if (window.innerWidth <= 768) {
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 bg-green-500 text-white p-3 rounded-lg shadow-lg z-50';
    notification.innerHTML = 'üì∂ Connexion r√©tablie';
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 3000);
  }
});

window.addEventListener('offline', function() {
  console.log('üìµ Connexion perdue');
  if (window.innerWidth <= 768) {
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 bg-orange-500 text-white p-3 rounded-lg shadow-lg z-50';
    notification.innerHTML = 'üìµ Mode hors ligne';
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 3000);
  }
});

const icons = {
  heart: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path d="M12 21C12 21 7.5 16.5 4 12.5C1.5 9.5 3.5 5 8 5C10 5 12 7 12 7C12 7 14 5 16 5C20.5 5 22.5 9.5 20 12.5C16.5 16.5 12 21 12 21Z" stroke-width="2"/></svg>',
  user: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><circle cx="12" cy="8" r="4" stroke-width="2"/><path d="M6 20c0-2.22 3.58-4 6-4s6 1.78 6 4" stroke-width="2"/></svg>',
  stethoscope: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path d="M8 7v5a4 4 0 008 0V7" stroke-width="2"/><circle cx="12" cy="17" r="2" stroke-width="2"/></svg>',
  mail: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><rect x="3" y="5" width="18" height="14" rx="2"/><path d="M3 7l9 6 9-6" stroke-width="2"/></svg>',
  lock: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><rect x="5" y="11" width="14" height="9" rx="2"/><path d="M7 11V7a5 5 0 1110 0v4" stroke-width="2"/></svg>',
  eye: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M2 12s4-8 10-8 10 8 10 8-4 8-10 8-10-8-10-8z"/></svg>',
  eyeOff: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path d="M17.94 17.94A10.07 10.07 0 012 12s4-8 10-8a9.93 9.93 0 016.94 3.06"/><line x1="1" y1="1" x2="23" y2="23"/></svg>',
  plus: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>',
  trash: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><rect x="3" y="7" width="18" height="14" rx="2"/><line x1="8" y1="11" x2="8" y2="17"/><line x1="16" y1="11" x2="16" y2="17"/></svg>',
  check: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>',
  shield: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" /></svg>',
  smartphone: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><rect x="5" y="2" width="14" height="20" rx="2"/><circle cx="12" cy="18" r="1"/></svg>',
  clock: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
  alert: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><polygon points="12 2 2 22 22 22 12 2"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12" y2="8"/></svg>',
  activity: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>',
  users: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 00-3-3.87"/><path d="M9 21v-2a4 4 0 013-3.87"/><path d="M7 7a4 4 0 018 0"/><path d="M5 21v-2a4 4 0 013-3.87"/><path d="M5 7a4 4 0 018 0"/></svg>',
  userPlus: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 00-3-3.87"/><path d="M8 21v-2a4 4 0 013-3.87"/><path d="M12 7a4 4 0 018 0"/><path d="M2 8v6"/><path d="M5 11H2"/></svg>',
  edit: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path d="M11 4h2a2 2 0 012 2v6a2 2 0 01-2 2h-2a2 2 0 01-2-2V6a2 2 0 012-2z"/><path d="M19 20v-2a2 2 0 00-2-2h-2a2 2 0 00-2 2v2"/></svg>',
  logout: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>',
  search: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>',
  settings: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 11-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09a1.65 1.65 0 00-1-1.51 1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 11-2.83-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09a1.65 1.65 0 001.51-1 1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06a1.65 1.65 0 001.82.33h.09a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51h.09a1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06a1.65 1.65 0 00-.33 1.82v.09a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>',
  phone: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 16.92z"/></svg>',
  calendar: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>',
  medical: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>',
  emergency: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>',
  cross: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>',
  warning: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
  fire: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path d="M8.5 14.5A2.5 2.5 0 0011 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 11-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 002.5 2.5z"/></svg>'
};

// Donn√©es de r√©f√©rence m√©dicales
const MEDICAL_DATA = {
  bloodTypes: ['A+', 'A-', 'B+', 'B-', 'AB+', 'AB-', 'O+', 'O-'],
  chronicConditions: [
    'Diab√®te type 1', 'Diab√®te type 2', 'Hypertension art√©rielle', 'Insuffisance cardiaque',
    'Asthme', 'BPCO', '√âpilepsie', 'Maladie de Crohn', 'Polyarthrite rhumato√Øde',
    'Scl√©rose en plaques', 'Maladie de Parkinson', 'Alzheimer', 'Insuffisance r√©nale',
    'Cirrhose', 'Cancer', 'VIH/SIDA', 'H√©patite B', 'H√©patite C', 'Hypothyro√Ødie',
    'Hyperthyro√Ødie', 'Fibromyalgie', 'Lupus', 'Bipolarit√©', 'D√©pression majeure'
  ],
  commonAllergies: [
    'P√©nicilline', 'Aspirine', 'Iode', 'Latex', 'Arachides', 'Fruits de mer',
    '≈íufs', 'Lait', 'Soja', 'Gluten', 'Pollen', 'Acariens', 'Poils d\'animaux',
    'Morphine', 'Cod√©ine', 'AINS', 'Sulfamides', 'Anesth√©siques locaux'
  ],
  emergencyMedications: [
    'Adr√©naline auto-injecteur', 'Ventoline', 'Glucagon', 'Insuline rapide',
    'Diaz√©pam rectal', 'Trinitrine', 'Prednisone', 'Antihistaminiques',
    'Beta-bloquants', 'Digitaline', 'Warfarine', 'H√©parine'
  ],
  medicalDevices: [
    'Pacemaker', 'D√©fibrillateur implantable', 'Pompe √† insuline', 'Proth√®se de hanche',
    'Proth√®se de genou', 'Stent cardiaque', 'Valve cardiaque artificielle',
    'Implant cochl√©aire', 'Neurostimulateur', 'Port-√†-cath', 'Sonde gastrique',
    'Cath√©ter urinaire', 'Dialyse p√©riton√©ale'
  ]
};

// Fonctions de chiffrement pour les donn√©es sensibles
class EncryptionService {
  static async generateKey() {
    return await crypto.subtle.generateKey(
      { name: 'AES-GCM', length: 256 },
      true,
      ['encrypt', 'decrypt']
    );
  }
  
  static async encrypt(data, key) {
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const encodedData = new TextEncoder().encode(JSON.stringify(data));
    const encrypted = await crypto.subtle.encrypt(
      { name: 'AES-GCM', iv: iv },
      key,
      encodedData
    );
    return {
      data: Array.from(new Uint8Array(encrypted)),
      iv: Array.from(iv)
    };
  }
  
  static async decrypt(encryptedData, key) {
    const data = new Uint8Array(encryptedData.data);
    const iv = new Uint8Array(encryptedData.iv);
    const decrypted = await crypto.subtle.decrypt(
      { name: 'AES-GCM', iv: iv },
      key,
      data
    );
    return JSON.parse(new TextDecoder().decode(decrypted));
  }
}

// Fonctions Firebase
async function saveToFirebase(collection, data, id = null) {
  try {
    if (id) {
      await db.collection(collection).doc(id).set(data);
    } else {
      await db.collection(collection).add(data);
    }
    console.log('Donn√©es sauvegard√©es dans Firebase');
    return true;
  } catch (error) {
    console.error('Erreur Firebase:', error);
    return false;
  }
}

async function loadFromFirebase(collection, id) {
  try {
    const doc = await db.collection(collection).doc(id).get();
    if (doc.exists) {
      return doc.data();
    }
    return null;
  } catch (error) {
    console.error('Erreur Firebase:', error);
    return null;
  }
}

// Fonction pour sauvegarder l'utilisateur (VERSION FIRESTORE)
async function saveUser(user) {
  await setUser(user);
  
  // Synchronisation Firebase automatique pour les utilisateurs patients
  if (user.uid && user.role === 'patient') {
    try {
      await db.collection('users').doc(user.uid).set({
        ...user,
        lastModified: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });
      console.log("üë§ Utilisateur sauvegard√© sur Firestore:", user.email);
    } catch (error) {
      console.error("‚ùå Erreur sauvegarde utilisateur Firebase:", error);
    }
  }
}

// Variables globales pour l'utilisateur connect√© (cache en m√©moire)
let currentUserCache = null;

// Fonction pour obtenir l'utilisateur connect√©
function getUser() {
  return currentUserCache;
}

// Fonction pour obtenir l'utilisateur connect√© (alias)
function getCurrentUser() {
  return currentUserCache;
}

// Fonction pour d√©finir l'utilisateur connect√©
async function setUser(user) {
  currentUserCache = user;
  if (user) {
    await saveCurrentUserToFirestore(user);
  }
  console.log("üë§ Utilisateur connect√©:", user?.email || "aucun");
}

// Fonction pour d√©connecter l'utilisateur
async function clearUser() {
  if (currentUserCache?.email) {
    await removeCurrentUserFromFirestore(currentUserCache.email);
  }
  currentUserCache = null;
  console.log("üëã Utilisateur d√©connect√©");
}

// Nouvelles fonctionnalit√©s
class SYLUtilities {
  // G√©n√©ration QR Code d'urgence
  static generateEmergencyQR(medicalData) {
    const emergencyData = {
      name: `${medicalData.personalInfo.firstName} ${medicalData.personalInfo.lastName}`,
      bloodType: medicalData.personalInfo.bloodType,
      allergies: medicalData.medicalHistory.allergies,
      conditions: medicalData.medicalHistory.chronicDiseases,
      emergencyContact: medicalData.personalInfo.emergencyContact,
      criticalNotes: medicalData.emergencyInfo.criticalNotes,
      timestamp: new Date().toISOString()
    };
    
    // QR Code simple avec donn√©es base64
    const qrData = btoa(JSON.stringify(emergencyData));
    return `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(qrData)}`;
  }
  
  // G√©olocalisation d'urgence
  static async getEmergencyLocation() {
    return new Promise((resolve, reject) => {
      if (!navigator.geolocation) {
        reject('G√©olocalisation non support√©e');
        return;
      }
      
      navigator.geolocation.getCurrentPosition(
        position => resolve({
          latitude: position.coords.latitude,
          longitude: position.coords.longitude,
          accuracy: position.coords.accuracy,
          timestamp: new Date().toISOString()
        }),
        error => reject(error.message),
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
      );
    });
  }
  
  // Mode hors ligne
  static setupOfflineMode() {
    if ('serviceWorker' in navigator) {
      const swCode = `
        const CACHE_NAME = 'syl-medical-v1';
        const urlsToCache = [
          '/',
          'https://cdn.tailwindcss.com'
        ];

        self.addEventListener('install', event => {
          event.waitUntil(
            caches.open(CACHE_NAME)
              .then(cache => cache.addAll(urlsToCache))
          );
        });

        self.addEventListener('fetch', event => {
          event.respondWith(
            caches.match(event.request)
              .then(response => response || fetch(event.request))
          );
        });
      `;
      
      // Plut√¥t que d'utiliser blob URL, cr√©ons un service worker via data URI
      // ou v√©rifions si on peut l'√©viter compl√®tement
      if (location.protocol === 'https:' || location.hostname === 'localhost') {
        try {
          const blob = new Blob([swCode], { type: 'application/javascript' });
          const swUrl = URL.createObjectURL(blob);
          
          navigator.serviceWorker.register(swUrl)
            .then(registration => {
              console.log('Service Worker enregistr√©:', registration);
              // Nettoyer l'URL blob apr√®s l'enregistrement
              URL.revokeObjectURL(swUrl);
            })
            .catch(err => console.warn('Service Worker non disponible:', err));
        } catch (error) {
          console.warn('Service Worker blob registration failed:', error);
        }
      } else {
        console.log('Service Worker non disponible (HTTPS requis)');
      }
    }
  }
  
  // Notifications push
  static async requestNotificationPermission() {
    if ('Notification' in window) {
      const permission = await Notification.requestPermission();
      return permission === 'granted';
    }
    return false;
  }
  
  static showNotification(title, options) {
    if ('serviceWorker' in navigator && 'Notification' in window) {
      if (Notification.permission === 'granted') {
        // Utiliser le Service Worker pour afficher la notification si disponible
        if (navigator.serviceWorker.controller) {
          navigator.serviceWorker.ready.then(registration => {
            registration.showNotification(title, {
              icon: '/favicon.ico',
              badge: '/favicon.ico',
              tag: 'syl-medical',
              requireInteraction: true,
              ...options
            });
          }).catch(error => {
            console.warn('Service Worker notification failed, using fallback:', error);
            // Fallback vers Notification directe
            try {
              new Notification(title, {
                icon: '/favicon.ico',
                tag: 'syl-medical',
                ...options
              });
            } catch (notifError) {
              console.error('Notification fallback failed:', notifError);
            }
          });
        } else {
          // Pas de Service Worker actif, utiliser Notification directe
          try {
            new Notification(title, {
              icon: '/favicon.ico',
              tag: 'syl-medical',
              ...options
            });
          } catch (notifError) {
            console.error('Direct notification failed:', notifError);
          }
        }
      } else if (Notification.permission !== 'denied') {
        Notification.requestPermission().then(permission => {
          if (permission === 'granted') {
            this.showNotification(title, options);
          }
        });
      }
    } else {
      console.warn('Notifications not supported in this browser');
    }
  }
  
  // Export PDF
  static generatePDF(medicalData) {
    try {
      // Cr√©er un nouveau document PDF avec jsPDF
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('p', 'mm', 'a4');
      
      // Configuration des couleurs et styles
      const primaryColor = [220, 38, 38]; // Rouge
      const secondaryColor = [59, 130, 246]; // Bleu
      const grayColor = [107, 114, 128]; // Gris
      
      let yPosition = 20;
      const leftMargin = 20;
      const pageWidth = doc.internal.pageSize.width;
      const pageHeight = doc.internal.pageSize.height;
      
      // Fonction pour encoder le texte correctement
      const cleanText = (text) => {
        if (!text) return 'Non renseigne';
        return text.toString()
          .replace(/[√†√°√¢√£√§√•]/g, 'a')
          .replace(/[√®√©√™√´]/g, 'e')
          .replace(/[√¨√≠√Æ√Ø]/g, 'i')
          .replace(/[√≤√≥√¥√µ√∂]/g, 'o')
          .replace(/[√π√∫√ª√º]/g, 'u')
          .replace(/[√Ω√ø]/g, 'y')
          .replace(/[√ß]/g, 'c')
          .replace(/[√±]/g, 'n')
          .replace(/[√Ä√Å√Ç√É√Ñ√Ö]/g, 'A')
          .replace(/[√à√â√ä√ã]/g, 'E')
          .replace(/[√å√ç√é√è]/g, 'I')
          .replace(/[√í√ì√î√ï√ñ]/g, 'O')
          .replace(/[√ô√ö√õ√ú]/g, 'U')
          .replace(/[√ù]/g, 'Y')
          .replace(/[√á]/g, 'C')
          .replace(/[√ë]/g, 'N');
      };
      
      // Fonction pour ajouter une nouvelle page si n√©cessaire
      const checkPageBreak = (neededSpace) => {
        if (yPosition + neededSpace > pageHeight - 20) {
          doc.addPage();
          yPosition = 20;
          return true;
        }
        return false;
      };
      
      // En-t√™te du document
      doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
      doc.rect(0, 0, pageWidth, 30, 'F');
      
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(16);
      doc.setFont('helvetica', 'bold');
      doc.text('FICHE MEDICALE D\'URGENCE SYL', pageWidth / 2, 18, { align: 'center' });
      
      yPosition = 40;
      
      // Nom du patient
      doc.setTextColor(0, 0, 0);
      doc.setFontSize(16);
      doc.setFont('helvetica', 'bold');
      const firstName = cleanText(medicalData.personalInfo?.firstName || '');
      const lastName = cleanText(medicalData.personalInfo?.lastName || '');
      const fullName = `${firstName} ${lastName}`.trim();
      doc.text(fullName, pageWidth / 2, yPosition, { align: 'center' });
      yPosition += 15;
      
      // Date de g√©n√©ration
      doc.setFontSize(10);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(grayColor[0], grayColor[1], grayColor[2]);
      const now = new Date();
      const dateStr = `${now.getDate().toString().padStart(2, '0')}/${(now.getMonth() + 1).toString().padStart(2, '0')}/${now.getFullYear()} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
      doc.text(`Genere le ${dateStr}`, pageWidth / 2, yPosition, { align: 'center' });
      yPosition += 20;
      
      // Fonction pour ajouter une section
      const addSection = (title, content, isCritical = false) => {
        checkPageBreak(30);
        
        // Titre de section
        const bgColor = isCritical ? [254, 242, 242] : [249, 250, 251];
        const borderColor = isCritical ? primaryColor : [229, 231, 235];
        
        doc.setFillColor(bgColor[0], bgColor[1], bgColor[2]);
        doc.setDrawColor(borderColor[0], borderColor[1], borderColor[2]);
        doc.roundedRect(leftMargin, yPosition, pageWidth - 40, 12, 2, 2, 'FD');
        
        doc.setTextColor(isCritical ? primaryColor[0] : 0, isCritical ? primaryColor[1] : 0, isCritical ? primaryColor[2] : 0);
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.text(cleanText(title), leftMargin + 5, yPosition + 8);
        yPosition += 20;
        
        // Contenu
        doc.setTextColor(0, 0, 0);
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(10);
        
        if (Array.isArray(content)) {
          content.forEach(item => {
            checkPageBreak(6);
            doc.text(`‚Ä¢ ${cleanText(item)}`, leftMargin + 5, yPosition);
            yPosition += 6;
          });
        } else {
          const cleanContent = cleanText(content);
          const lines = doc.splitTextToSize(cleanContent, pageWidth - 50);
          lines.forEach(line => {
            checkPageBreak(6);
            doc.text(line, leftMargin + 5, yPosition);
            yPosition += 6;
          });
        }
        yPosition += 10;
      };
      
      // Calculer l'√¢ge
      const calculateAge = (birthDate) => {
        if (!birthDate) return 'Non renseigne';
        try {
          const today = new Date();
          const birth = new Date(birthDate);
          let age = today.getFullYear() - birth.getFullYear();
          const monthDiff = today.getMonth() - birth.getMonth();
          if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
            age--;
          }
          return age + ' ans';
        } catch {
          return 'Non renseigne';
        }
      };
      
      // Informations critiques
      const criticalInfo = [
        `Groupe sanguin: ${cleanText(medicalData.personalInfo?.bloodType) || 'Non renseigne'}`,
        `Age: ${calculateAge(medicalData.personalInfo?.dateOfBirth)}`,
        `Taille: ${cleanText(medicalData.personalInfo?.height) || 'Non renseigne'} cm`,
        `Poids: ${cleanText(medicalData.personalInfo?.weight) || 'Non renseigne'} kg`
      ];
      addSection('INFORMATIONS CRITIQUES', criticalInfo, true);
      
      // Allergies
      const allergies = medicalData.medicalHistory?.allergies?.length ? 
        medicalData.medicalHistory.allergies.map(allergy => cleanText(allergy)) : ['Aucune allergie connue'];
      addSection('ALLERGIES', allergies, true);
      
      // Traitements en cours
      const medications = medicalData.medicalHistory?.medications?.length ? 
        medicalData.medicalHistory.medications.map(med => cleanText(med)) : ['Aucun traitement en cours'];
      addSection('TRAITEMENTS EN COURS', medications);
      
      // Pathologies
      const diseases = medicalData.medicalHistory?.chronicDiseases?.length ? 
        medicalData.medicalHistory.chronicDiseases.map(disease => cleanText(disease)) : ['Aucune pathologie connue'];
      addSection('PATHOLOGIES CHRONIQUES', diseases);
      
      // M√©decin traitant
      if (medicalData.emergencyInfo?.primaryPhysician?.name) {
        const physicianInfo = [
          `Nom: ${cleanText(medicalData.emergencyInfo.primaryPhysician.name)}`,
          `Specialite: ${cleanText(medicalData.emergencyInfo.primaryPhysician.specialty) || 'Non renseignee'}`,
          `Telephone: ${cleanText(medicalData.emergencyInfo.primaryPhysician.phone) || 'Non renseigne'}`
        ];
        addSection('MEDECIN TRAITANT', physicianInfo);
      }
      
      // Contact d'urgence
      if (medicalData.personalInfo?.emergencyContact?.name) {
        const contactInfo = [
          `Nom: ${cleanText(medicalData.personalInfo.emergencyContact.name)}`,
          `Relation: ${cleanText(medicalData.personalInfo.emergencyContact.relationship) || 'Non renseignee'}`,
          `Telephone: ${cleanText(medicalData.personalInfo.emergencyContact.phone) || 'Non renseigne'}`
        ];
        addSection('CONTACT D\'URGENCE', contactInfo, true);
      }
      
      // Notes critiques
      if (medicalData.emergencyInfo?.criticalNotes) {
        addSection('NOTES CRITIQUES POUR LES SECOURS', cleanText(medicalData.emergencyInfo.criticalNotes), true);
      }
      
      // Num√©ros d'urgence
      const emergencyNumbers = [
        'SAMU: 15',
        'Pompiers: 18',
        'Police: 17',
        'Urgences europeennes: 112'
      ];
      addSection('NUMEROS D\'URGENCE', emergencyNumbers, true);
      
      // Footer
      checkPageBreak(20);
      doc.setFontSize(8);
      doc.setTextColor(grayColor[0], grayColor[1], grayColor[2]);
      doc.text('Document genere par SYL Medical - Usage strictement medical', pageWidth / 2, pageHeight - 15, { align: 'center' });
      doc.text('Donnees sensibles - Confidentialite medicale', pageWidth / 2, pageHeight - 10, { align: 'center' });
      
      // Sauvegarder le PDF
      const cleanFullName = fullName.replace(/[^a-zA-Z0-9]/g, '-') || 'Patient';
      const dateForFile = now.toISOString().split('T')[0];
      const fileName = `SYL-Medical-${cleanFullName}-${dateForFile}.pdf`;
      doc.save(fileName);
      
      console.log('PDF genere avec succes:', fileName);
      
    } catch (error) {
      console.error('Erreur lors de la generation du PDF:', error);
      alert('Erreur lors de la generation du PDF. Veuillez reessayer.');
    }
  }
  
  // API NFC pour l'acc√®s d'urgence
  static async handleNFCAccess(tagId) {
    try {
      const nfcTags = JSON.parse(localStorage.getItem('syl-nfc-tags') || '[]');
      const patients = JSON.parse(localStorage.getItem('syl-patients') || '[]');
      
      const tag = nfcTags.find(t => t.id === tagId);
      if (!tag || !tag.assignedTo) {
        throw new Error('Tag NFC non reconnu ou non assign√©');
      }
      
      const patient = patients.find(p => (p.id || p.uid) === tag.assignedTo);
      if (!patient) {
        throw new Error('Patient non trouv√© pour ce tag');
      }
      
      // R√©cup√©rer les donn√©es m√©dicales compl√®tes depuis Firebase si possible
      let medicalData = null;
      try {
        const doc = await db.collection('patients').doc(tag.assignedTo + '_medical').get();
        if (doc.exists) {
          medicalData = doc.data();
        }
      } catch (error) {
        console.warn('Impossible de r√©cup√©rer les donn√©es Firebase, utilisation des donn√©es locales');
      }
      
      // Fallback sur les donn√©es du patient si pas de donn√©es m√©dicales
      if (!medicalData && patient.medicalHistory) {
        medicalData = {
          personalInfo: patient.personalInfo,
          medicalHistory: patient.medicalHistory,
          emergencyInfo: patient.emergencyInfo
        };
      }
      
      if (!medicalData) {
        throw new Error('Aucune donn√©e m√©dicale disponible pour ce patient');
      }
      
      // Afficher l'interface d'urgence
      this.displayEmergencyInterface(medicalData, tagId);
      
      // Logger l'acc√®s
      SYLAnalytics.trackEvent('nfc_emergency_access', { 
        tagId, 
        patientId: tag.assignedTo,
        timestamp: new Date().toISOString()
      });
      
      return medicalData;
    } catch (error) {
      console.error('Erreur acc√®s NFC:', error);
      this.displayErrorInterface(error.message);
      throw error;
    }
  }
  
  static displayEmergencyInterface(medicalData, tagId) {
    // Cr√©er une interface d'urgence en plein √©cran
    const emergencyInterface = document.createElement('div');
    emergencyInterface.className = 'fixed inset-0 bg-red-600 z-50 overflow-y-auto';
    emergencyInterface.innerHTML = `
      <div class="min-h-screen p-4">
        <div class="max-w-4xl mx-auto">
          <div class="bg-white rounded-lg shadow-2xl overflow-hidden">
            <div class="bg-red-600 text-white p-6 text-center">
              <h1 class="text-3xl font-bold">üöë ACC√àS D'URGENCE M√âDICALE</h1>
              <p class="text-xl mt-2">Tag NFC: ${tagId}</p>
              <p class="text-lg">Acc√®s le ${new Date().toLocaleString('fr-FR')}</p>
            </div>
            
            <div class="p-6 space-y-6">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-red-50 border-l-4 border-red-500 p-4">
                  <h2 class="text-xl font-bold text-red-800 mb-4">IDENTIT√â PATIENT</h2>
                  <div class="space-y-2">
                    <p><strong>Nom:</strong> ${medicalData.personalInfo.lastName}</p>
                    <p><strong>Pr√©nom:</strong> ${medicalData.personalInfo.firstName}</p>
                    <p><strong>Date de naissance:</strong> ${medicalData.personalInfo.dateOfBirth}</p>
                    <p><strong>Groupe sanguin:</strong> <span class="bg-red-600 text-white px-3 py-1 rounded font-bold text-lg">${medicalData.personalInfo.bloodType || 'NON RENSEIGN√â'}</span></p>
                  </div>
                </div>
                
                <div class="bg-orange-50 border-l-4 border-orange-500 p-4">
                  <h2 class="text-xl font-bold text-orange-800 mb-4">CONTACT D'URGENCE</h2>
                  <div class="space-y-2">
                    <p><strong>Nom:</strong> ${medicalData.personalInfo.emergencyContact.name}</p>
                    <p><strong>Relation:</strong> ${medicalData.personalInfo.emergencyContact.relation}</p>
                    <p><strong>T√©l√©phone:</strong> <a href="tel:${medicalData.personalInfo.emergencyContact.phone}" class="text-blue-600 underline text-lg font-bold">${medicalData.personalInfo.emergencyContact.phone}</a></p>
                  </div>
                </div>
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4">
                  <h2 class="text-xl font-bold text-yellow-800 mb-4">‚ö†Ô∏è ALLERGIES CRITIQUES</h2>
                  <div class="space-y-1">
                    ${medicalData.medicalHistory.allergies?.length ? 
                      medicalData.medicalHistory.allergies.map(a => `<span class="bg-red-500 text-white px-2 py-1 rounded mr-1 mb-1 inline-block">${a}</span>`).join('') : 
                      '<p class="text-gray-500">Aucune allergie connue</p>'
                    }
                  </div>
                </div>
                
                <div class="bg-blue-50 border-l-4 border-blue-500 p-4">
                  <h2 class="text-xl font-bold text-blue-800 mb-4">üíä TRAITEMENTS EN COURS</h2>
                  <div class="space-y-1">
                    ${medicalData.medicalHistory.medications?.length ? 
                      medicalData.medicalHistory.medications.map(m => `<span class="bg-blue-500 text-white px-2 py-1 rounded mr-1 mb-1 inline-block">${m}</span>`).join('') : 
                      '<p class="text-gray-500">Aucun traitement</p>'
                    }
                  </div>
                </div>
              </div>
              
              <div class="bg-purple-50 border-l-4 border-purple-500 p-4">
                <h2 class="text-xl font-bold text-purple-800 mb-4">üè• PATHOLOGIES & CONDITIONS</h2>
                <div class="space-y-1">
                  ${medicalData.medicalHistory.chronicDiseases?.length ? 
                    medicalData.medicalHistory.chronicDiseases.map(c => `<span class="bg-purple-500 text-white px-2 py-1 rounded mr-1 mb-1 inline-block">${c}</span>`).join('') : 
                    '<p class="text-gray-500">Aucune pathologie chronique</p>'
                  }
                </div>
              </div>
              
              ${medicalData.emergencyInfo?.criticalNotes ? `
              <div class="bg-red-100 border-2 border-red-300 p-4 rounded-lg">
                <h2 class="text-xl font-bold text-red-800 mb-4">üö® NOTES CRITIQUES POUR LES SECOURS</h2>
                <p class="text-red-700 text-lg">${medicalData.emergencyInfo.criticalNotes}</p>
              </div>
              ` : ''}
              
              <div class="flex flex-wrap gap-4 justify-center">
                <a href="tel:15" class="bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg px-6 py-3 text-lg">üìû SAMU 15</a>
                <a href="tel:18" class="bg-orange-600 hover:bg-orange-700 text-white font-bold rounded-lg px-6 py-3 text-lg">üöí Pompiers 18</a>
                <a href="tel:112" class="bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg px-6 py-3 text-lg">üÜò Urgences 112</a>
                <button onclick="SYLUtilities.generatePDF(${JSON.stringify(medicalData).replace(/"/g, '&quot;')})" class="bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg px-6 py-3 text-lg">üìÑ Export PDF</button>
                <button onclick="this.closest('.fixed').remove()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold rounded-lg px-6 py-3 text-lg">‚ùå Fermer</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
    
    document.body.appendChild(emergencyInterface);
    
    // Notification sonore si possible
    try {
      const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+HyvmwhBRuBzvLZiTcIGGm98OScTgwOUarm7bZkHgU2jdXxxXkpBSV+zPDckT0IEl+25OqoVRMKRZ/h8r5vIAUdgM3y2Ik3CRZqve/jm04MDlCr5ey2ZSAEOIzU8cV5KgUme8rx3I87CRBtueXrrFgSCUOc3/O+byAFHYDN8tiJNwkWar3v45tODA5Qqubstm');
      audio.play().catch(() => {}); // Ignorer les erreurs audio
    } catch (e) {}
    
    // Auto-fermeture apr√®s 5 minutes par s√©curit√©
    setTimeout(() => {
      if (document.body.contains(emergencyInterface)) {
        emergencyInterface.remove();
      }
    }, 300000);
  }
  
  static displayErrorInterface(errorMessage) {
    const errorInterface = document.createElement('div');
    errorInterface.className = 'fixed inset-0 bg-red-900 bg-opacity-90 z-50 flex items-center justify-center';
    errorInterface.innerHTML = `
      <div class="bg-white rounded-lg p-8 max-w-md mx-4 text-center">
        <div class="text-red-600 text-6xl mb-4">‚ùå</div>
        <h2 class="text-2xl font-bold text-gray-900 mb-4">Erreur d'acc√®s NFC</h2>
        <p class="text-gray-700 mb-6">${errorMessage}</p>
        <div class="space-y-4">
          <button onclick="this.closest('.fixed').remove()" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold rounded-lg px-6 py-3">Fermer</button>
          <div class="flex gap-2">
            <a href="tel:15" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg px-4 py-2">SAMU 15</a>
            <a href="tel:112" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg px-4 py-2">112</a>
          </div>
        </div>
      </div>
    `;
    document.body.appendChild(errorInterface);
  }
}

// Initialisation PWA et mode hors ligne
if (typeof window !== 'undefined') {
  SYLUtilities.setupOfflineMode();
  SYLUtilities.requestNotificationPermission();
}

function showLogin() {
  const mainApp = document.getElementById('mainApp') || document.getElementById('app');
  mainApp.innerHTML = `
<div class="min-h-screen bg-gradient-to-br from-blue-50 via-white to-green-50 flex items-center justify-center p-4">
  <div class="w-full max-w-md">
    <div class="card">
      <div class="card-body">
        <div class="text-center mb-8">
          <div class="mx-auto w-16 h-16 bg-gradient-to-r from-blue-600 to-green-600 rounded-full flex items-center justify-center mb-4">
            ${icons.heart}
          </div>
          <h1 class="text-2xl md:text-3xl font-bold text-gray-900">SYL Medical</h1>
          <p class="text-gray-600 mt-2">Syst√®me d'Urgence M√©dicale</p>
        </div>

        <!-- Interface simplifi√©e pour patients -->
        <div class="mb-6">
          <div class="text-center p-4 bg-blue-50 rounded-lg border-2 border-blue-600">
            <div class="text-blue-600 text-3xl mb-2">${icons.user}</div>
            <h3 class="text-lg font-semibold text-blue-800">Espace Patient</h3>
          <p class="text-sm text-blue-600">Connectez-vous ou cr√©ez votre compte m√©dical</p>
        </div>
      </div>

      <!-- Onglets de connexion -->
      <div class="flex space-x-2 mb-4">
        <button class="flex-1 py-2 px-4 text-sm rounded-lg bg-blue-600 text-white" id="tabEmail">Email</button>
        <button class="flex-1 py-2 px-4 text-sm rounded-lg bg-gray-200 text-gray-600" id="tabGoogle">Google</button>
        <button class="flex-1 py-2 px-4 text-sm rounded-lg bg-gray-400 text-gray-500 cursor-not-allowed" disabled title="N√©cessite la facturation Firebase">SMS (Bient√¥t)</button>
      </div>

      <!-- Formulaire Email -->
      <div id="emailForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
          <div class="relative">
            <input type="email" id="email" required placeholder="votre@email.com"
              class="w-full px-3 py-2 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">${icons.mail}</span>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Mot de passe</label>
          <input type="password" id="password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"/>
        </div>
        <div class="flex space-x-2">
          <button id="loginEmail" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg px-6 py-3">
            ${icons.lock} Se connecter
          </button>
          <button id="registerEmail" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg px-6 py-3">
            ${icons.user} S'inscrire
          </button>
        </div>
      </div>

      <!-- Formulaire Google -->
      <div id="googleForm" class="hidden">
        <button id="loginGoogle" class="w-full bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg px-6 py-3 flex items-center justify-center gap-2">
          <svg class="w-5 h-5" viewBox="0 0 24 24"><path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
          Se connecter avec Google
        </button>
        <div class="mt-4 p-3 bg-blue-50 rounded-lg">
          <p class="text-blue-700 text-sm">üìù <strong>Note :</strong> Si vous obtenez une erreur "domaine non autoris√©", ajoutez votre domaine dans Firebase Console ‚Üí Authentication ‚Üí Settings ‚Üí Authorized domains</p>
        </div>
      </div>

      <div class="mt-8 pt-6 border-t border-gray-200">
        <div class="text-xs text-gray-500 space-y-1">
          <p>üöë Acc√®s d'urgence instantan√©</p>
          <p>üîí Authentification Firebase s√©curis√©e</p>
          <p>üè• Conforme RGPD & HDS</p>
          <p>‚ö° Synchronisation temps r√©el</p>
        </div>
      </div>
    </div>
  </div>
</div>
  `;

  let role = 'patient'; // Toujours patient par d√©faut
  let activeTab = 'email';

  // Plus besoin de gestion des r√¥les - automatiquement patient

  // Gestion des onglets
  function switchTab(tab) {
    activeTab = tab;
    // Reset tous les onglets
    document.getElementById('tabEmail').classList.remove('bg-blue-600', 'text-white');
    document.getElementById('tabEmail').classList.add('bg-gray-200', 'text-gray-600');
    document.getElementById('tabGoogle').classList.remove('bg-blue-600', 'text-white');
    document.getElementById('tabGoogle').classList.add('bg-gray-200', 'text-gray-600');
    
    // Activer l'onglet s√©lectionn√©
    if (tab === 'email') {
      document.getElementById('tabEmail').classList.remove('bg-gray-200', 'text-gray-600');
      document.getElementById('tabEmail').classList.add('bg-blue-600', 'text-white');
    } else if (tab === 'google') {
      document.getElementById('tabGoogle').classList.remove('bg-gray-200', 'text-gray-600');
      document.getElementById('tabGoogle').classList.add('bg-blue-600', 'text-white');
    }
    
    // Afficher le bon formulaire
    document.getElementById('emailForm').classList.add('hidden');
    document.getElementById('googleForm').classList.add('hidden');
    document.getElementById(tab + 'Form').classList.remove('hidden');
  }

  document.getElementById('tabEmail').onclick = () => switchTab('email');
  document.getElementById('tabGoogle').onclick = () => switchTab('google');

  // Authentification par email
  document.getElementById('loginEmail').onclick = async () => {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    
    if (!email || !password) {
      alert('Veuillez remplir tous les champs');
      return;
    }
    
    try {
      showLoader();
      
      // V√©rification admin en local d'abord (d√©tection automatique)
      if (adminAccounts[email] === password) {
        console.log('üîë Connexion admin d√©tect√©e pour:', email);
        const adminData = {
          uid: 'admin_' + email.replace(/[^a-zA-Z0-9]/g, '_'),
          email: email,
          role: 'admin',
          profile: {
            firstName: 'Admin',
            lastName: 'Syst√®me',
            phone: ''
          },
          createdAt: new Date().toISOString()
        };
        saveUser(adminData);
        hideLoader();
        renderApp();
        return;
      }
      
      // Connexion Firebase pour les patients
      const userCredential = await auth.signInWithEmailAndPassword(email, password);
      await handleAuthSuccess(userCredential.user, 'patient');
    } catch (error) {
      hideLoader();
      console.error('Erreur de connexion:', error);
      alert('Erreur de connexion: ' + getErrorMessage(error.code || 'unknown'));
    }
  };

  document.getElementById('registerEmail').onclick = async () => {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    
    if (password.length < 6) {
      alert('Le mot de passe doit contenir au moins 6 caract√®res');
      return;
    }
    
    try {
      showLoader();
      const userCredential = await auth.createUserWithEmailAndPassword(email, password);
      // Toutes les inscriptions sont des patients (sauf l'admin qui utilise le syst√®me local)
      await handleAuthSuccess(userCredential.user, 'patient');
    } catch (error) {
      hideLoader();
      alert('Erreur d\'inscription: ' + getErrorMessage(error.code));
    }
  };

  // Authentification par Google
  document.getElementById('loginGoogle').onclick = async () => {
    try {
      showLoader();
      const result = await auth.signInWithPopup(googleProvider);
      await handleAuthSuccess(result.user, role);
    } catch (error) {
      hideLoader();
      if (error.code === 'auth/unauthorized-domain') {
        alert('‚ùå Domaine non autoris√©.\n\nüìù Solution :\n1. Allez dans Firebase Console\n2. Authentication ‚Üí Settings ‚Üí Authorized domains\n3. Ajoutez "localhost" et votre domaine');
      } else {
        alert('Erreur de connexion Google: ' + getErrorMessage(error.code));
      }
    }
  };
}

async function handleAuthSuccess(firebaseUser, role) {
  try {
    const userData = {
      uid: firebaseUser.uid,
      email: firebaseUser.email,
      phone: firebaseUser.phoneNumber,
      displayName: firebaseUser.displayName,
      role: role,
      profile: {
        firstName: role === 'patient' ? (firebaseUser.displayName?.split(' ')[0] || 'Patient') : 'Dr. ' + (firebaseUser.displayName?.split(' ')[0] || 'M√©decin'),
        lastName: firebaseUser.displayName?.split(' ').slice(1).join(' ') || '',
        phone: firebaseUser.phoneNumber || '',
        ...(role === 'medecin' && { 
          speciality: 'M√©decine g√©n√©rale', 
          hospital: '√âtablissement de sant√©' 
        })
      },
      createdAt: new Date().toISOString()
    };
    
    saveUser(userData);
    hideLoader();
    renderApp();
  } catch (error) {
    hideLoader();
    console.error('Erreur lors de la sauvegarde:', error);
    alert('Connexion r√©ussie mais erreur de sauvegarde');
  }
}

function getErrorMessage(errorCode) {
  switch (errorCode) {
    case 'auth/user-not-found':
      return 'Aucun compte trouv√© avec cet email';
    case 'auth/wrong-password':
      return 'Mot de passe incorrect';
    case 'auth/email-already-in-use':
      return 'Cet email est d√©j√† utilis√©';
    case 'auth/weak-password':
      return 'Mot de passe trop faible (min 6 caract√®res)';
    case 'auth/invalid-email':
      return 'Email invalide';
    case 'auth/too-many-requests':
      return 'Trop de tentatives, r√©essayez plus tard';
    default:
      return 'Erreur de connexion';
  }
}

function hideLoader() {
  const loader = document.querySelector('.animate-spin')?.parentElement?.parentElement;
  if (loader) loader.remove();
}

function showLoader(callback = null) {
  document.getElementById('app').innerHTML = `
    <div class="min-h-screen bg-gray-50 flex items-center justify-center">
      <div class="text-center">
        <div class="w-16 h-16 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
        <p class="text-gray-600">Authentification en cours...</p>
      </div>
    </div>
  `;
  if (callback) setTimeout(callback, 800);
}

// Syst√®me de rappels et notifications
class ReminderSystem {
  static init() {
    this.checkReminders();
    setInterval(() => this.checkReminders(), 60000); // V√©rification chaque minute
  }
  
  static checkReminders() {
    const medicalData = JSON.parse(localStorage.getItem('syl-medicalData') || '{}');
    const reminders = JSON.parse(localStorage.getItem('syl-reminders') || '[]');
    const now = new Date();
    
    reminders.forEach(reminder => {
      const reminderTime = new Date(reminder.dateTime);
      if (reminderTime <= now && !reminder.notified) {
        SYLUtilities.showNotification(`üíä Rappel: ${reminder.title}`, {
          body: reminder.message,
          icon: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA4MDAgODAwIj48YyB4PSI4MDAiIHk9IjQ3MiIgY3g9IjE5MiIgY3k9IjI4IiByPSI1MiIvPjwvc3ZnPg==',
          tag: reminder.id
        });
        reminder.notified = true;
      }
    });
    
    localStorage.setItem('syl-reminders', JSON.stringify(reminders));
  }
  
  static addReminder(title, message, dateTime) {
    const reminders = JSON.parse(localStorage.getItem('syl-reminders') || '[]');
    const reminder = {
      id: Date.now().toString(),
      title,
      message,
      dateTime,
      notified: false,
      created: new Date().toISOString()
    };
    reminders.push(reminder);
    localStorage.setItem('syl-reminders', JSON.stringify(reminders));
    return reminder;
  }
}

// V√©rification de s√©curit√© et validation des donn√©es
class DataValidator {
  static validateMedicalData(data) {
    const errors = [];
    
    if (!data.personalInfo?.firstName) {
      errors.push('Pr√©nom requis');
    }
    
    if (!data.personalInfo?.lastName) {
      errors.push('Nom requis');
    }
    
    if (!data.personalInfo?.bloodType) {
      errors.push('Groupe sanguin recommand√© pour les urgences');
    }
    
    if (!data.personalInfo?.emergencyContact?.phone) {
      errors.push('Contact d\'urgence requis');
    }
    
    return errors;
  }
  
  static sanitizeInput(input) {
    if (typeof input !== 'string') return input;
    return input.replace(/[<>]/g, '').trim();
  }
}

// Initialisation des syst√®mes
// ============ DEBUG SILENCIEUX AUTOMATIQUE ============
// S'ex√©cute automatiquement au chargement de la page (admin uniquement)
async function silentDebugCheck() {
  const currentUser = getCurrentUser();
  if (!currentUser || currentUser.role !== 'admin') return;
  
  console.log('%cüîç DEBUG SILENCIEUX ACTIV√â', 'background: #3b82f6; color: white; padding: 4px 8px; border-radius: 4px; font-weight: bold;');
  
  try {
    // V√©rifier l'√©tat de Firebase
    if (!db) {
      console.warn('‚ö†Ô∏è Firebase non initialis√©');
      return;
    }
    
    // Analyser les collections principales
    const collections = ['patients', 'users', 'activeUsers', 'admins', 'nfcTags'];
    const stats = {};
    
    for (const collectionName of collections) {
      try {
        const snapshot = await db.collection(collectionName).limit(10).get();
        stats[collectionName] = {
          count: snapshot.size,
          accessible: true
        };
        
        // Analyser la structure des donn√©es
        if (snapshot.size > 0) {
          const firstDoc = snapshot.docs[0].data();
          const fields = Object.keys(firstDoc);
          stats[collectionName].fields = fields.length;
          stats[collectionName].sampleFields = fields.slice(0, 5);
        }
      } catch (error) {
        stats[collectionName] = {
          accessible: false,
          error: error.message
        };
      }
    }
    
    // Logger les r√©sultats
    console.group('üìä √âtat des Collections Firebase');
    Object.entries(stats).forEach(([collection, data]) => {
      if (data.accessible) {
        console.log(`‚úÖ ${collection}: ${data.count} docs, ${data.fields || 0} champs`);
        if (data.sampleFields) {
          console.log(`   Exemples: ${data.sampleFields.join(', ')}`);
        }
      } else {
        console.warn(`‚ùå ${collection}: ${data.error}`);
      }
    });
    console.groupEnd();
    
    // V√©rifier la coh√©rence des IDs
    try {
      const patientsSnapshot = await db.collection('patients').limit(5).get();
      const idIssues = [];
      
      patientsSnapshot.forEach(doc => {
        const data = doc.data();
        if (doc.id !== data.uid && doc.id !== data.id) {
          idIssues.push({
            docId: doc.id,
            dataUid: data.uid,
            dataId: data.id
          });
        }
      });
      
      if (idIssues.length > 0) {
        console.warn('‚ö†Ô∏è Incoh√©rences d\'IDs d√©tect√©es:', idIssues);
      } else {
        console.log('‚úÖ IDs coh√©rents dans la collection patients');
      }
    } catch (error) {
      console.warn('‚ö†Ô∏è Impossible de v√©rifier les IDs:', error.message);
    }
    
  } catch (error) {
    console.error('‚ùå Erreur debug silencieux:', error);
  }
}

document.addEventListener('DOMContentLoaded', () => {
  ReminderSystem.init();
  
  // Lancer le debug silencieux apr√®s 2 secondes (laisser le temps √† l'app de se charger)
  setTimeout(() => {
    silentDebugCheck();
  }, 2000);
});

// ----------- PATIENT DASHBOARD -----------
function renderPatientDashboard(user) {
  let medicalData = JSON.parse(localStorage.getItem('syl-medicalData') || 'null');
  if (!medicalData) {
    medicalData = {
      personalInfo: {
        firstName: user.profile.firstName,
        lastName: user.profile.lastName,
        dateOfBirth: '',
        bloodType: '',
        height: '',
        weight: '',
        emergencyContact: { name: '', relation: '', phone: '' },
        secondaryContact: { name: '', relation: '', phone: '' },
        address: '',
        city: '',
        postalCode: '',
        nationalId: '',
        socialSecurityNumber: '',
        insuranceNumber: '',
        preferredHospital: '',
        organDonor: false,
        advanceDirectives: false
      },
      medicalHistory: {
        allergies: [],
        medications: [],
        conditions: [],
        surgeries: [],
        chronicDiseases: [],
        medicalDevices: [],
        emergencyMedications: []
      },
      emergencyInfo: {
        primaryPhysician: { name: '', phone: '', specialty: '' },
        pharmacist: { name: '', phone: '', address: '' },
        lastUpdate: new Date().toISOString(),
        criticalNotes: '',
        contraindications: [],
        riskFactors: []
      },
      braceletId: '',
      isActive: false
    };
  }
  localStorage.setItem('syl-medicalData', JSON.stringify(medicalData));
  let activeTab = 'emergency';
  render();

  function render() {
    const appContainer = document.getElementById('mainApp') || document.getElementById('app');
    appContainer.innerHTML = `
    <div class="min-h-screen bg-gray-50">
      <!-- Header mobile-friendly -->
      <header class="bg-white shadow-sm border-b sticky top-0 z-40">
        <div class="container flex justify-between items-center h-16">
          <div class="flex items-center">
            ${icons.heart}<h1 class="text-lg md:text-xl font-bold text-gray-900 ml-2">SYL Medical</h1>
          </div>
          <div class="flex items-center space-x-2 md:space-x-4">
            <div class="text-xs md:text-sm text-gray-600 hidden sm:block">Bonjour, ${user.profile.firstName}</div>
            <button id="logoutBtn" class="btn btn-secondary btn-sm desktop-only">${icons.logout} <span class="hidden md:inline ml-1">D√©connexion</span></button>
          </div>
        </div>
      </header>
      
      <div class="container py-4 md:py-8">
        <!-- Navigation tabs mobile -->
        <div class="mobile-only mb-6">
          <div class="grid grid-cols-2 gap-2 mb-4">
            <button class="btn ${activeTab==='emergency' ? 'btn-primary':'btn-secondary'}" data-tab="emergency">
              üö® <span class="ml-1">Urgence</span>
            </button>
            <button class="btn ${activeTab==='profile' ? 'btn-primary':'btn-secondary'}" data-tab="profile">
              üë§ <span class="ml-1">Profil</span>
            </button>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <button class="btn ${activeTab==='medical' ? 'btn-primary':'btn-secondary'}" data-tab="medical">
              üè• <span class="ml-1">M√©dical</span>
            </button>
            <button class="btn ${activeTab==='history' ? 'btn-primary':'btn-secondary'}" data-tab="history">
              üìä <span class="ml-1">Historique</span>
            </button>
          </div>
        </div>
        
        <!-- Layout desktop/mobile -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 lg:gap-8">
          <!-- Sidebar desktop -->
          <div class="lg:col-span-1 desktop-only">
            <nav class="space-y-2">
              <button class="w-full flex items-center px-4 py-3 text-left rounded-lg transition-colors ${activeTab==='emergency' ? 'bg-red-100 text-red-700 border-l-4 border-red-600':'text-gray-600 hover:bg-gray-100'}" data-tab="emergency">${icons.emergency} <span class="ml-3">üöë Urgence</span></button>
              <button class="w-full flex items-center px-4 py-3 text-left rounded-lg transition-colors ${activeTab==='profile' ? 'bg-blue-100 text-blue-700 border-l-4 border-blue-600':'text-gray-600 hover:bg-gray-100'}" data-tab="profile">${icons.user} <span class="ml-3">Profil complet</span></button>
              <button class="w-full flex items-center px-4 py-3 text-left rounded-lg transition-colors ${activeTab==='medical' ? 'bg-blue-100 text-blue-700 border-l-4 border-blue-600':'text-gray-600 hover:bg-gray-100'}" data-tab="medical">${icons.medical} <span class="ml-3">M√©dical</span></button>
              <button class="w-full flex items-center px-4 py-3 text-left rounded-lg transition-colors ${activeTab==='history' ? 'bg-blue-100 text-blue-700 border-l-4 border-blue-600':'text-gray-600 hover:bg-gray-100'}" data-tab="history">${icons.activity} <span class="ml-3">Historique</span></button>
              <button class="w-full flex items-center px-4 py-3 text-left rounded-lg transition-colors ${activeTab==='bracelet' ? 'bg-blue-100 text-blue-700 border-l-4 border-blue-600':'text-gray-600 hover:bg-gray-100'}" data-tab="bracelet">${icons.smartphone} <span class="ml-3">Bracelet</span></button>
              <button class="w-full flex items-center px-4 py-3 text-left rounded-lg transition-colors ${activeTab==='reminders' ? 'bg-blue-100 text-blue-700 border-l-4 border-blue-600':'text-gray-600 hover:bg-gray-100'}" data-tab="reminders">${icons.clock} <span class="ml-3">Rappels</span></button>
            </nav>
          </div>
          <div class="lg:col-span-3">
            ${activeTab === 'emergency' ? renderEmergencyTab() : ''}
            ${activeTab === 'profile' ? renderProfileTab() : ''}
            ${activeTab === 'medical' ? renderMedicalTab() : ''}
            ${activeTab === 'history' ? renderHistoryTab() : ''}
            ${activeTab === 'bracelet' ? renderBraceletTab() : ''}
            ${activeTab === 'reminders' ? renderRemindersTab() : ''}
          </div>
        </div>
      </div>
    </div>
`;
    document.getElementById('logoutBtn').onclick = () => { logout(); };
    document.querySelectorAll('[data-tab]').forEach(btn => btn.onclick = () => { activeTab = btn.getAttribute('data-tab'); render(); });
    if (activeTab === 'emergency') tabEmergencyEvents();
    if (activeTab === 'profile') tabProfileEvents();
    if (activeTab === 'medical') tabMedicalEvents();
    if (activeTab === 'bracelet') tabBraceletEvents();
    if (activeTab === 'reminders') tabRemindersEvents();
  }

  function renderEmergencyTab() {
    return `
      <div class="space-y-6">
        <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-lg">
          <div class="flex items-center">
            <div class="text-red-500 mr-3">${icons.emergency}</div>
            <h2 class="text-2xl font-bold text-red-800">INFORMATIONS D'URGENCE</h2>
          </div>
          <p class="text-red-700 mt-2">Ces informations sont critiques pour les secours</p>
        </div>

        <!-- Carte d'identit√© d'urgence -->
        <div class="bg-white rounded-xl shadow-lg border-l-4 border-red-500 p-6">
          <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
            ${icons.cross} <span class="ml-2">CARTE D'URGENCE M√âDICALE</span>
          </h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="space-y-4">
              <div class="bg-red-50 p-4 rounded-lg">
                <h4 class="font-bold text-red-800">IDENTIT√â</h4>
                <p><strong>Nom:</strong> ${medicalData.personalInfo.lastName}</p>
                <p><strong>Pr√©nom:</strong> ${medicalData.personalInfo.firstName}</p>
                <p><strong>N√©(e) le:</strong> ${medicalData.personalInfo.dateOfBirth}</p>
                <p><strong>Groupe sanguin:</strong> <span class="bg-red-600 text-white px-2 py-1 rounded font-bold">${medicalData.personalInfo.bloodType || 'NON RENSEIGN√â'}</span></p>
              </div>
              <div class="bg-orange-50 p-4 rounded-lg">
                <h4 class="font-bold text-orange-800">CONTACTS D'URGENCE</h4>
                <p><strong>Principal:</strong> ${medicalData.personalInfo.emergencyContact.name} (${medicalData.personalInfo.emergencyContact.relation})</p>
                <p><strong>T√©l:</strong> ${medicalData.personalInfo.emergencyContact.phone}</p>
                <p><strong>Secondaire:</strong> ${medicalData.personalInfo.secondaryContact.name}</p>
                <p><strong>T√©l:</strong> ${medicalData.personalInfo.secondaryContact.phone}</p>
              </div>
            </div>
            <div class="space-y-4">
              <div class="bg-yellow-50 p-4 rounded-lg">
                <h4 class="font-bold text-yellow-800">‚ö†Ô∏è ALLERGIES CRITIQUES</h4>
                ${medicalData.medicalHistory.allergies.length ? medicalData.medicalHistory.allergies.map(a => `<span class="bg-red-500 text-white px-2 py-1 rounded text-sm mr-1 mb-1 inline-block">${a}</span>`).join('') : '<p class="text-gray-500">Aucune allergie connue</p>'}
              </div>
              <div class="bg-blue-50 p-4 rounded-lg">
                <h4 class="font-bold text-blue-800">üíä TRAITEMENTS EN COURS</h4>
                ${medicalData.medicalHistory.medications.length ? medicalData.medicalHistory.medications.slice(0,5).map(m => `<span class="bg-blue-500 text-white px-2 py-1 rounded text-sm mr-1 mb-1 inline-block">${m}</span>`).join('') : '<p class="text-gray-500">Aucun traitement</p>'}
              </div>
              <div class="bg-purple-50 p-4 rounded-lg">
                <h4 class="font-bold text-purple-800">üè• PATHOLOGIES</h4>
                ${medicalData.medicalHistory.chronicDiseases.length ? medicalData.medicalHistory.chronicDiseases.map(c => `<span class="bg-purple-500 text-white px-2 py-1 rounded text-sm mr-1 mb-1 inline-block">${c}</span>`).join('') : '<p class="text-gray-500">Aucune pathologie chronique</p>'}
              </div>
            </div>
          </div>
          ${medicalData.emergencyInfo.criticalNotes ? `
          <div class="mt-6 bg-red-100 border border-red-300 p-4 rounded-lg">
            <h4 class="font-bold text-red-800 mb-2">üö® NOTES CRITIQUES POUR LES SECOURS</h4>
            <p class="text-red-700">${medicalData.emergencyInfo.criticalNotes}</p>
          </div>
          ` : ''}
        </div>

        <!-- M√©decin traitant -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">üë®‚Äç‚öïÔ∏è M√©decin traitant</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Dr. Nom" value="${medicalData.emergencyInfo.primaryPhysician.name}" id="physicianName">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Sp√©cialit√©" value="${medicalData.emergencyInfo.primaryPhysician.specialty}" id="physicianSpecialty">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="T√©l√©phone" value="${medicalData.emergencyInfo.primaryPhysician.phone}" id="physicianPhone">
          </div>
          <button id="savePhysician" class="bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg px-4 py-2 flex items-center gap-2">
            üíæ Sauvegarder m√©decin traitant
          </button>
        </div>

        <!-- Notes critiques -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">üö® Notes critiques pour les secours</h3>
          <textarea class="w-full px-3 py-2 border border-gray-300 rounded-lg h-24 mb-4" placeholder="Informations vitales √† communiquer aux secours (ex: risque d'allergie, contre-indications sp√©cifiques...)" id="criticalNotes">${medicalData.emergencyInfo.criticalNotes}</textarea>
          <button id="saveCriticalNotes" class="bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg px-4 py-2 flex items-center gap-2">
            üíæ Sauvegarder notes critiques
          </button>
        </div>

        <!-- QR Code et Export du profil patient -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">üì± Profil m√©dical num√©rique</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- QR Code -->
            <div class="text-center">
              <h4 class="font-medium text-gray-800 mb-3">QR Code du profil</h4>
              <div id="qrCodeContainer" class="mb-4">
                <canvas id="qrCodeCanvas" class="mx-auto border border-gray-300 rounded-lg"></canvas>
              </div>
              <p class="text-sm text-gray-600 mb-4">
                Scannez pour acc√©der √† votre profil m√©dical en ligne
              </p>
              <div class="flex gap-2 justify-center">
                <button id="refreshQR" class="bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg px-3 py-2 text-sm flex items-center gap-1">
                  üîÑ Actualiser
                </button>
                <button id="downloadQR" class="bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg px-3 py-2 text-sm flex items-center gap-1">
                  üì• T√©l√©charger
                </button>
              </div>
            </div>
            
            <!-- PDF Export -->
            <div class="text-center">
              <h4 class="font-medium text-gray-800 mb-3">Fiche m√©dicale PDF</h4>
              <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                <div class="text-4xl mb-2">üìÑ</div>
                <p class="text-sm text-gray-600">
                  Exportez votre fiche m√©dicale compl√®te au format PDF
                </p>
              </div>
              <button id="generatePDF" class="bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-lg px-4 py-2 flex items-center gap-2 mx-auto">
                üìÑ G√©n√©rer fiche PDF
              </button>
              <p class="text-xs text-gray-500 mt-2">
                Inclut toutes vos informations m√©dicales
              </p>
            </div>
          </div>
        </div>

        <!-- Urgences m√©dicales -->
        <div class="bg-white rounded-xl shadow-lg border-2 border-red-200 p-6">
          <h3 class="text-lg font-semibold text-red-600 mb-4 flex items-center">
            üö® Urgences m√©dicales
          </h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- SAMU -->
            <div class="text-center p-4 bg-red-50 rounded-lg border border-red-200">
              <div class="text-3xl mb-2">üöë</div>
              <h4 class="font-bold text-red-800 mb-2">SAMU</h4>
              <p class="text-sm text-red-600 mb-3">Urgences m√©dicales</p>
              <button id="callSAMU" class="bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg px-4 py-2 text-lg w-full">
                üìû Appeler le 15
              </button>
            </div>
            
            <!-- Autres urgences -->
            <div class="text-center p-4 bg-orange-50 rounded-lg border border-orange-200">
              <div class="text-3xl mb-2">üÜò</div>
              <h4 class="font-bold text-orange-800 mb-2">Autres urgences</h4>
              <div class="space-y-2 text-sm">
                <div class="flex justify-between items-center">
                  <span>Pompiers:</span>
                  <a href="tel:18" class="bg-orange-600 hover:bg-orange-700 text-white px-3 py-1 rounded text-xs">18</a>
                </div>
                <div class="flex justify-between items-center">
                  <span>Police:</span>
                  <a href="tel:17" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs">17</a>
                </div>
                <div class="flex justify-between items-center">
                  <span>Urgences EU:</span>
                  <a href="tel:112" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-xs">112</a>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Section d'urgence simplifi√©e -->
        </button>
      </div>
    `;
  }

  function renderProfileTab() {
    const currentYear = new Date().getFullYear();
    const years = Array.from({length: 100}, (_, i) => currentYear - i);
    const months = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
    const braceletColors = ['Rouge', 'Bleu', 'Vert', 'Noir', 'Rose', 'Orange', 'Violet', 'Gris'];
    
    return `
      <div class="space-y-6">
        <div class="flex justify-between items-center">
          <h2 class="text-2xl font-bold text-gray-900">Profil Complet</h2>
          <button id="saveProfile" class="bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg px-6 py-2 flex items-center gap-2">${icons.check} Sauvegarder</button>
        </div>

        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Informations personnelles <span class="text-red-500">*</span></h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Pr√©nom <span class="text-red-500">*</span></label>
              <input required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Pr√©nom" value="${medicalData.personalInfo.firstName || ''}" id="pfFirstName">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Nom <span class="text-red-500">*</span></label>
              <input required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Nom" value="${medicalData.personalInfo.lastName || ''}" id="pfLastName">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Email <span class="text-red-500">*</span></label>
              <input required type="email" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="email@exemple.com" value="${medicalData.personalInfo.email || user.email || ''}" id="pfEmail">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">T√©l√©phone <span class="text-red-500">*</span></label>
              <input required type="tel" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="06 12 34 56 78" value="${medicalData.personalInfo.phone || ''}" id="pfPhone">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Date de naissance <span class="text-red-500">*</span></label>
              <input required type="date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" value="${medicalData.personalInfo.dateOfBirth || ''}" id="pfBirth">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">√Çge (calcul√© automatiquement)</label>
              <input readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600" placeholder="Calcul√© depuis la date de naissance" value="${medicalData.personalInfo.age || ''}" id="pfAge">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Groupe sanguin <span class="text-red-500">*</span></label>
              <select required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" id="pfBlood">
                <option value="">S√©lectionnez votre groupe sanguin</option>
                ${MEDICAL_DATA.bloodTypes.map(type => `<option value="${type}" ${medicalData.personalInfo.bloodType===type?'selected':''}>${type}</option>`).join('')}
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Couleur de bracelet <span class="text-red-500">*</span></label>
              <select required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" id="pfBraceletColor">
                <option value="">Choisissez une couleur</option>
                ${braceletColors.map(color => `<option value="${color}" ${medicalData.personalInfo.braceletColor===color?'selected':''}>${color}</option>`).join('')}
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Taille (cm)</label>
              <input type="number" min="50" max="250" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="175" value="${medicalData.personalInfo.height || ''}" id="pfHeight">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Poids (kg)</label>
              <input type="number" min="20" max="300" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="70" value="${medicalData.personalInfo.weight || ''}" id="pfWeight">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">N¬∞ S√©curit√© Sociale</label>
              <input class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="1 23 45 67 890 123 45" value="${medicalData.personalInfo.socialSecurityNumber || ''}" id="pfSSN">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">N¬∞ Mutuelle</label>
              <input class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Num√©ro d'adh√©rent" value="${medicalData.personalInfo.insuranceNumber || ''}" id="pfInsurance">
            </div>
          </div>
          
          <div class="mt-6">
            <h4 class="font-semibold text-gray-900 mb-4">Adresse</h4>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-1">Adresse</label>
                <input class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="123 rue de la Paix" value="${medicalData.personalInfo.address || ''}" id="pfAddress">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Code postal</label>
                <input class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="75001" value="${medicalData.personalInfo.postalCode || ''}" id="pfPostal">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Ville</label>
                <input class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Paris" value="${medicalData.personalInfo.city || ''}" id="pfCity">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">H√¥pital de r√©f√©rence</label>
                <input class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="CHU de..." value="${medicalData.personalInfo.preferredHospital || ''}" id="pfHospital">
              </div>
            </div>
          </div>
          
          <div class="mt-6 space-y-4">
            <h4 class="font-semibold text-gray-900">Contacts d'urgence</h4>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Contact principal</label>
                <input class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Nom du contact" value="${medicalData.personalInfo.emergencyContact?.name || ''}" id="pfContact1Name">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Relation</label>
                <select class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" id="pfContact1Rel">
                  <option value="">Choisir...</option>
                  <option value="Conjoint(e)" ${medicalData.personalInfo.emergencyContact?.relation === 'Conjoint(e)' ? 'selected' : ''}>Conjoint(e)</option>
                  <option value="P√®re" ${medicalData.personalInfo.emergencyContact?.relation === 'P√®re' ? 'selected' : ''}>P√®re</option>
                  <option value="M√®re" ${medicalData.personalInfo.emergencyContact?.relation === 'M√®re' ? 'selected' : ''}>M√®re</option>
                  <option value="Fils" ${medicalData.personalInfo.emergencyContact?.relation === 'Fils' ? 'selected' : ''}>Fils</option>
                  <option value="Fille" ${medicalData.personalInfo.emergencyContact?.relation === 'Fille' ? 'selected' : ''}>Fille</option>
                  <option value="Fr√®re" ${medicalData.personalInfo.emergencyContact?.relation === 'Fr√®re' ? 'selected' : ''}>Fr√®re</option>
                  <option value="S≈ìur" ${medicalData.personalInfo.emergencyContact?.relation === 'S≈ìur' ? 'selected' : ''}>S≈ìur</option>
                  <option value="Ami(e)" ${medicalData.personalInfo.emergencyContact?.relation === 'Ami(e)' ? 'selected' : ''}>Ami(e)</option>
                  <option value="Autre" ${medicalData.personalInfo.emergencyContact?.relation === 'Autre' ? 'selected' : ''}>Autre</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">T√©l√©phone</label>
                <input type="tel" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="06 12 34 56 78" value="${medicalData.personalInfo.emergencyContact?.phone || ''}" id="pfContact1Phone">
              </div>
            </div>
          </div>

          <div class="mt-6 space-y-2">
            <label class="flex items-center">
              <input type="checkbox" ${medicalData.personalInfo.organDonor ? 'checked' : ''} id="pfOrganDonor" class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
              <span>Je suis donneur d'organes</span>
            </label>
            <label class="flex items-center">
              <input type="checkbox" ${medicalData.personalInfo.advanceDirectives ? 'checked' : ''} id="pfDirectives" class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
              <span>J'ai r√©dig√© des directives anticip√©es</span>
            </label>
          </div>
        </div>
      </div>
    `;
  }

  function renderMedicalTab() {
    return `
      <div class="space-y-6">
        <h2 class="text-2xl font-bold text-gray-900">Dossier M√©dical Complet</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          ${renderMedicalListManager('Allergies', 'allergies', MEDICAL_DATA.commonAllergies)}
          ${renderMedicalListManager('M√©dicaments actuels', 'medications', MEDICAL_DATA.emergencyMedications)}
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          ${renderMedicalListManager('Pathologies chroniques', 'chronicDiseases', MEDICAL_DATA.chronicConditions)}
          ${renderMedicalListManager('Dispositifs m√©dicaux', 'medicalDevices', MEDICAL_DATA.medicalDevices)}
        </div>
        
        ${renderMedicalListManager('Interventions chirurgicales', 'surgeries', [])}
        ${renderMedicalListManager('M√©dicaments d\'urgence', 'emergencyMedications', MEDICAL_DATA.emergencyMedications)}
        ${renderMedicalListManager('Contre-indications', 'contraindications', [])}
        ${renderMedicalListManager('Facteurs de risque', 'riskFactors', [])}
      </div>
    `;
  }

  function renderMedicalListManager(title, listType, suggestions) {
    const list = listType.includes('.') ? 
      medicalData.medicalHistory[listType.split('.')[1]] || medicalData.emergencyInfo[listType.split('.')[1]] :
      medicalData.medicalHistory[listType] || medicalData.emergencyInfo[listType] || [];
    
    return `
      <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">${title}</h3>
        <div class="space-y-3">
          <div class="flex gap-2">
            <input type="text" list="suggestions_${listType}" placeholder="Ajouter..." class="flex-1 px-3 py-2 border border-gray-300 rounded-lg" id="add_${listType}">
            <datalist id="suggestions_${listType}">
              ${suggestions.map(item => `<option value="${item}">`).join('')}
            </datalist>
            <button class="bg-blue-600 hover:bg-blue-700 text-white rounded-lg px-3 py-2" id="btn_${listType}">${icons.plus}</button>
          </div>
          <div class="space-y-2" id="list_${listType}">
            ${list.map((item, idx) => `
              <div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg">
                <span class="text-gray-700">${item}</span>
                <button class="text-red-600 hover:text-red-700" data-del="${listType}" data-idx="${idx}">${icons.trash}</button>
              </div>
            `).join('')}
          </div>
        </div>
      </div>
    `;
  }

  function renderHistoryTab() {
    return `<div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
      <h2 class="text-xl font-bold text-gray-900 mb-4">Historique m√©dical</h2>
      <p class="text-gray-600">Aucune consultation enregistr√©e.</p>
      <div class="mt-4 p-4 bg-blue-50 rounded-lg">
        <p class="text-blue-700">Derni√®re mise √† jour: ${new Date(medicalData.emergencyInfo.lastUpdate).toLocaleString('fr-FR')}</p>
      </div>
    </div>`;
  }

  function renderBraceletTab() {
    return `
      <div class="space-y-6">
        <h2 class="text-2xl font-bold text-gray-900">Mon Bracelet SYL</h2>
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-8">
          <div class="text-center">
            <div class="mx-auto w-32 h-32 bg-gradient-to-r from-red-600 to-orange-600 rounded-full flex items-center justify-center mb-6">${icons.smartphone}</div>
            <h3 class="text-2xl font-semibold text-gray-900 mb-4">Bracelet d'urgence m√©dicale</h3>
            <p class="text-gray-600 mb-8 text-lg">Synchronisez vos derni√®res donn√©es m√©dicales sur votre bracelet NFC</p>
            
            <div class="mb-8 p-6 bg-blue-50 rounded-xl">
              <h4 class="font-bold text-blue-800 mb-2">üì± Synchronisation simple</h4>
              <p class="text-blue-700">1. Cliquez sur "Resynchroniser"<br>2. Approchez votre bracelet<br>3. Vos donn√©es sont mises √† jour !</p>
            </div>

            <button class="bg-red-600 text-white hover:bg-red-700 rounded-xl px-8 py-4 font-bold text-lg shadow-lg transform hover:scale-105 transition-all" id="resyncBracelet">
              üîÑ Resynchroniser mon bracelet
            </button>
            
            <div id="nfcStatus" class="mt-6 text-center hidden">
              <div class="inline-flex items-center px-4 py-2 bg-blue-100 text-blue-800 rounded-lg">
                <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-2"></div>
                Approchez votre bracelet du t√©l√©phone...
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  function renderRemindersTab() {
    const reminders = JSON.parse(localStorage.getItem('syl-reminders') || '[]');
    return `
      <div class="space-y-6">
        <div class="flex justify-between items-center">
          <h2 class="text-2xl font-bold text-gray-900">Rappels M√©dicaux</h2>
          <button id="addReminder" class="bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg px-6 py-2 flex items-center gap-2">${icons.plus} Nouveau rappel</button>
        </div>

        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Cr√©er un rappel</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Titre du rappel</label>
              <input type="text" id="reminderTitle" placeholder="Ex: Prendre Doliprane" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
              <select id="reminderType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                <option value="medication">üíä M√©dicament</option>
                <option value="appointment">üè• Rendez-vous m√©dical</option>
                <option value="checkup">üîç Contr√¥le m√©dical</option>
                <option value="exercise">üèÉ Activit√© physique</option>
                <option value="treatment">ü©π Traitement</option>
                <option value="other">üìù Autre</option>
              </select>
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Date</label>
              <input type="date" id="reminderDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Heure</label>
              <input type="time" id="reminderTime" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Mode de rappel</label>
              <select id="reminderMethod" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                <option value="notification">üì± Notification smartphone</option>
                <option value="email">üìß Email</option>
                <option value="sms">üí¨ SMS</option>
                <option value="all">üîî Tous les modes</option>
              </select>
            </div>
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">Message personnalis√©</label>
            <textarea id="reminderMessage" placeholder="Message personnalis√© pour le rappel..." class="w-full px-3 py-2 border border-gray-300 rounded-lg h-20 focus:ring-2 focus:ring-blue-500"></textarea>
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">R√©p√©tition</label>
            <select id="reminderRepeat" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" onchange="toggleRepeatOptions()">
              <option value="none">Aucune</option>
              <option value="hourly">Toutes les X heures</option>
              <option value="daily">Quotidien</option>
              <option value="weekly">Hebdomadaire</option>
              <option value="weekdays">Jours sp√©cifiques</option>
              <option value="monthly">Mensuel</option>
            </select>
          </div>
          
          <div id="hourlyOptions" class="mb-4 hidden">
            <label class="block text-sm font-medium text-gray-700 mb-1">R√©p√©ter toutes les</label>
            <div class="flex items-center gap-2">
              <input type="number" id="hourInterval" min="1" max="24" value="1" class="w-20 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
              <span class="text-gray-600">heure(s)</span>
            </div>
          </div>
          
          <div id="weekdaysOptions" class="mb-4 hidden">
            <label class="block text-sm font-medium text-gray-700 mb-2">Jours de la semaine</label>
            <div class="grid grid-cols-4 gap-2">
              <label class="flex items-center gap-2 text-sm">
                <input type="checkbox" id="weekday-1" value="1" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                Lundi
              </label>
              <label class="flex items-center gap-2 text-sm">
                <input type="checkbox" id="weekday-2" value="2" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                Mardi
              </label>
              <label class="flex items-center gap-2 text-sm">
                <input type="checkbox" id="weekday-3" value="3" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                Mercredi
              </label>
              <label class="flex items-center gap-2 text-sm">
                <input type="checkbox" id="weekday-4" value="4" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                Jeudi
              </label>
              <label class="flex items-center gap-2 text-sm">
                <input type="checkbox" id="weekday-5" value="5" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                Vendredi
              </label>
              <label class="flex items-center gap-2 text-sm">
                <input type="checkbox" id="weekday-6" value="6" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                Samedi
              </label>
              <label class="flex items-center gap-2 text-sm">
                <input type="checkbox" id="weekday-0" value="0" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                Dimanche
              </label>
            </div>
          </div>
          <button id="saveReminder" class="bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg px-6 py-2 flex items-center gap-2">${icons.check} Cr√©er le rappel</button>
        </div>

        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Rappels programm√©s (${reminders.length})</h3>
          <div class="space-y-3" id="remindersList">
            ${reminders.length ? reminders.map((reminder, idx) => `
              <div class="flex items-start justify-between bg-gray-50 p-4 rounded-lg ${reminder.notified ? 'opacity-50' : ''} hover:bg-gray-100 transition-colors">
                <div class="flex-1">
                  <div class="flex items-center gap-2 mb-1">
                    <h4 class="font-medium text-gray-900">${reminder.title}</h4>
                    <span class="text-xs px-2 py-1 rounded-full ${reminder.type === 'medication' ? 'bg-purple-100 text-purple-800' : reminder.type === 'appointment' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800'}">${reminder.type}</span>
                  </div>
                  <p class="text-sm text-gray-600 mb-2">${reminder.message || 'Rappel m√©dical'}</p>
                  <div class="flex items-center gap-4 text-xs text-gray-500">
                    <span>üìÖ ${new Date(reminder.dateTime).toLocaleDateString('fr-FR')}</span>
                    <span>üïí ${new Date(reminder.dateTime).toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})}</span>
                    <span>${reminder.method === 'notification' ? 'üì±' : reminder.method === 'email' ? 'üìß' : reminder.method === 'sms' ? 'üí¨' : 'üîî'} ${reminder.method || 'notification'}</span>
                    ${reminder.repeat && reminder.repeat !== 'none' ? `<span>üîÑ ${getRepeatDisplayText(reminder)}</span>` : ''}
                  </div>
                </div>
                <div class="flex items-center gap-2 ml-4">
                  ${reminder.notified ? '<span class="text-green-600 text-sm">‚úÖ Envoy√©</span>' : '<span class="text-orange-600 text-sm">‚è∞ En attente</span>'}
                  <button class="text-red-600 hover:text-red-700 p-1" onclick="deleteReminder(${idx})" title="Supprimer">${icons.trash}</button>
                </div>
              </div>
            `).join('') : '<div class="text-center py-12"><div class="text-gray-400 text-6xl mb-4">‚è∞</div><p class="text-gray-500 text-lg">Aucun rappel programm√©</p><p class="text-gray-400 text-sm">Cr√©ez votre premier rappel m√©dical</p></div>'}
          </div>
        </div>
      </div>
    `;
  }

  function tabEmergencyEvents() {
    // Event listeners pour les nouveaux boutons de sauvegarde
    document.getElementById('savePhysician')?.addEventListener('click', async () => {
      medicalData.emergencyInfo.primaryPhysician.name = document.getElementById('physicianName').value;
      medicalData.emergencyInfo.primaryPhysician.specialty = document.getElementById('physicianSpecialty').value;
      medicalData.emergencyInfo.primaryPhysician.phone = document.getElementById('physicianPhone').value;
      medicalData.emergencyInfo.lastUpdate = new Date().toISOString();
      localStorage.setItem('syl-medicalData', JSON.stringify(medicalData));
      
      // Synchronisation Firebase
      if (user.uid) {
        try {
          const patientData = { ...medicalData, uid: user.uid, email: user.email };
          await savePatientToFirestore(patientData);
          SYLUtilities.showNotification('M√©decin traitant sauvegard√©', {
            body: 'Les informations de votre m√©decin traitant ont √©t√© mises √† jour'
          });
        } catch (error) {
          console.error('Erreur sync Firebase:', error);
          alert('‚ö†Ô∏è M√©decin sauvegard√© localement. Synchronisation Firebase √©chou√©e.');
        }
      } else {
        alert('‚úÖ M√©decin traitant sauvegard√© !');
      }
    });

    document.getElementById('saveCriticalNotes')?.addEventListener('click', async () => {
      medicalData.emergencyInfo.criticalNotes = document.getElementById('criticalNotes').value;
      medicalData.emergencyInfo.lastUpdate = new Date().toISOString();
      localStorage.setItem('syl-medicalData', JSON.stringify(medicalData));
      
      // Synchronisation Firebase
      if (user.uid) {
        try {
          const patientData = { ...medicalData, uid: user.uid, email: user.email };
          await savePatientToFirestore(patientData);
          SYLUtilities.showNotification('Notes critiques sauvegard√©es', {
            body: 'Vos notes critiques d\'urgence ont √©t√© mises √† jour'
          });
        } catch (error) {
          console.error('Erreur sync Firebase:', error);
          alert('‚ö†Ô∏è Notes sauvegard√©es localement. Synchronisation Firebase √©chou√©e.');
        }
      } else {
        alert('‚úÖ Notes critiques sauvegard√©es !');
      }
    });

    // G√©n√©ration automatique du QR code avec d√©lai pour s'assurer que la librairie est charg√©e
    setTimeout(() => {
      generatePatientQRCode();
    }, 500);
    
    // Event listeners pour le QR code
    document.getElementById('refreshQR')?.addEventListener('click', () => {
      generatePatientQRCode();
      SYLUtilities.showNotification('QR Code actualis√©', {
        body: 'Le QR code a √©t√© mis √† jour avec vos derni√®res informations'
      });
    });

    document.getElementById('downloadQR')?.addEventListener('click', () => {
      const canvas = document.getElementById('qrCodeCanvas');
      const link = document.createElement('a');
      link.download = `SYL-Medical-QR-${user.profile?.firstName || 'Patient'}.png`;
      link.href = canvas.toDataURL();
      link.click();
      SYLUtilities.showNotification('QR Code t√©l√©charg√©', {
        body: 'Le QR code de votre profil m√©dical a √©t√© t√©l√©charg√©'
      });
    });

    // Event listener pour la g√©n√©ration PDF
    document.getElementById('generatePDF')?.addEventListener('click', () => {
      SYLUtilities.generatePDF(medicalData);
      SYLUtilities.showNotification('Fiche PDF g√©n√©r√©e', {
        body: 'Votre fiche m√©dicale compl√®te a √©t√© t√©l√©charg√©e au format PDF'
      });
    });

    // Event listener pour l'appel SAMU
    document.getElementById('callSAMU')?.addEventListener('click', () => {
      if (confirm('üöë Vous vous appr√™tez √† composer le 15 (SAMU).\n\nEn cas d\'urgence m√©dicale vitale, confirmez l\'appel.\n\nVoulez-vous continuer ?')) {
        window.open('tel:15');
        SYLUtilities.showNotification('Appel SAMU', {
          body: 'Mise en relation avec le 15...'
        });
      }
    });
  }

  // Fonction pour g√©n√©rer le QR code du patient avec informations m√©dicales directes
  async function generatePatientQRCode() {
    try {
      // Cr√©er un contenu d'urgence ultra-compact
      const emergencyInfo = await createSimpleEmergencyInfo();
      
      const canvas = document.getElementById('qrCodeCanvas');
      if (canvas) {
        // V√©rifier si QRious est disponible
        if (typeof QRious === 'undefined') {
          console.warn('QRious library not loaded, using fallback');
          // Fallback : afficher les infos en texte
          const ctx = canvas.getContext('2d');
          canvas.width = 256;
          canvas.height = 256;
          ctx.fillStyle = '#f3f4f6';
          ctx.fillRect(0, 0, 256, 256);
          ctx.fillStyle = '#1f2937';
          ctx.font = '14px Arial';
          ctx.textAlign = 'center';
          ctx.fillText('URGENCE MEDICALE', 128, 100);
          ctx.font = '12px Arial';
          ctx.fillText('QR en cours...', 128, 120);
          ctx.fillText(`Patient: ${user.email}`, 128, 140);
          return;
        }
        
        // Utiliser QRious pour g√©n√©rer le QR code
        try {
          const qr = new QRious({
            element: canvas,
            value: emergencyInfo,
            size: 256,
            level: 'L', // Plus de donn√©es possibles
            background: 'white',
            foreground: 'black'
          });
          
          console.log('QR Code m√©dical g√©n√©r√© - Taille:', emergencyInfo.length, 'caract√®res');
          console.log('Contenu:', emergencyInfo);
        } catch (qrError) {
          console.error('Erreur QRious:', qrError);
          // Fallback en cas d'erreur
          const ctx = canvas.getContext('2d');
          canvas.width = 256;
          canvas.height = 256;
          ctx.fillStyle = '#fee2e2';
          ctx.fillRect(0, 0, 256, 256);
          ctx.fillStyle = '#dc2626';
          ctx.font = '16px Arial';
          ctx.textAlign = 'center';
          ctx.fillText('Erreur QR Code', 128, 120);
          ctx.font = '12px Arial';
          ctx.fillText('Contenu trop long', 128, 140);
        }
      } else {
        console.error('Canvas QR code non trouv√©');
      }
    } catch (error) {
      console.error('Erreur g√©n√©ration QR code:', error);
      // Afficher une erreur visible sur le canvas
      const canvas = document.getElementById('qrCodeCanvas');
      if (canvas) {
        const ctx = canvas.getContext('2d');
        canvas.width = 256;
        canvas.height = 256;
        ctx.fillStyle = '#fee2e2';
        ctx.fillRect(0, 0, 256, 256);
        ctx.fillStyle = '#dc2626';
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('Erreur QR Code', 128, 120);
        ctx.font = '12px Arial';
        ctx.fillText('Erreur syst√®me', 128, 140);
      }
    }
  }

  // Fonction pour cr√©er un contenu d'urgence ultra-simple
  async function createSimpleEmergencyInfo() {
    try {
      // R√©cup√©rer les donn√©es du patient connect√© depuis la collection patients
      let patient = {};
      
      console.log('üîç Recherche patient dans collection patients pour email:', user.email);
      
      if (user && user.email) {
        // Chercher directement dans patients par le champ email
        console.log('üîç Requ√™te dans collection patients where email ==', user.email);
        const patientQuery = await db.collection('patients')
          .where('email', '==', user.email)
          .limit(1)
          .get();
        
        console.log('üìÑ Nombre de documents trouv√©s:', patientQuery.size);
        
        if (!patientQuery.empty) {
          patient = patientQuery.docs[0].data();
          console.log('‚úÖ Patient trouv√© par email dans patients:', patient);
          console.log('üìÑ ID du document:', patientQuery.docs[0].id);
        } else {
          console.log('‚ùå Aucun patient trouv√© avec cet email');
          
          // Debug: lister quelques patients pour voir la structure
          console.log('üîç Debug - Listage de quelques patients pour v√©rifier:');
          const debugQuery = await db.collection('patients').limit(3).get();
          debugQuery.forEach((doc, index) => {
            const data = doc.data();
            console.log(`Patient ${index + 1}:`, {
              id: doc.id,
              email: data.email,
              nom: data.nom,
              prenom: data.prenom
            });
          });
        }
      }
      
      console.log('üìä Donn√©es patient finales:', patient);
      
      // Si toujours pas de donn√©es, utiliser les infos de base de l'utilisateur
      if (!patient || (!patient.nom && !patient.prenom)) {
        console.log('‚ö†Ô∏è Pas de donn√©es patient compl√®tes, utilisation fallback');
        // Extraire le nom depuis l'email
        const emailParts = user.email.split('@')[0].split('.');
        patient = {
          email: user.email,
          prenom: emailParts[0] ? emailParts[0].charAt(0).toUpperCase() + emailParts[0].slice(1) : 'Patient',
          nom: emailParts[1] ? emailParts[1].charAt(0).toUpperCase() + emailParts[1].slice(1) : 'SYL',
          ...patient // Garder les donn√©es existantes s'il y en a
        };
      }
      
      const age = patient.dateNaissance ? 
        new Date().getFullYear() - new Date(patient.dateNaissance).getFullYear() : 'N/A';
      
      // Version ultra-minimaliste avec vraies donn√©es
      let emergencyText = `URGENCE MEDICALE
${patient.prenom || 'Patient'} ${patient.nom || 'SYL'}
Age: ${age}
Sang: ${patient.groupeSanguin || 'N/A'}
Allergies: ${patient.allergies ? patient.allergies.substring(0, 30) : 'Aucune'}
Contact: ${patient.contactUrgence || patient.telephone || 'N/A'}
Email: ${patient.email || user.email}
ID: ${user.uid ? user.uid.substring(0, 6) : 'N/A'}`;

      // Nettoyer pour QR code
      emergencyText = emergencyText
        .replace(/[^\x20-\x7E\n]/g, '') // ASCII seulement
        .trim();

      console.log('üìã Contenu QR final:', emergencyText);
      console.log('üìè Taille:', emergencyText.length, 'caract√®res');
      return emergencyText;
      
    } catch (error) {
      console.error('‚ùå Erreur cr√©ation info urgence:', error);
      // Version ultra-minimale en cas d'erreur
      return `URGENCE MEDICALE
Patient: ${user.email || 'Utilisateur connecte'}
ID: ${user.uid ? user.uid.substring(0, 6) : 'N/A'}
Contact: SYL Medical
Email: ${user.email || 'N/A'}`;
    }
  }

  // Fonction pour cr√©er le texte d'urgence m√©dicale format√©
  async function createEmergencyInfoText() {
    try {
      // R√©cup√©rer les donn√©es du patient connect√© depuis Firestore
      let patient = {};
      
      if (user && user.uid) {
        const patientDoc = await db.collection('patients').doc(user.uid).get();
        if (patientDoc.exists) {
          patient = patientDoc.data();
        } else {
          // Fallback: chercher par email
          const patientQuery = await db.collection('patients')
            .where('email', '==', user.email)
            .limit(1)
            .get();
          
          if (!patientQuery.empty) {
            patient = patientQuery.docs[0].data();
          }
        }
      }
      
      const now = new Date();
      const age = patient.dateNaissance ? 
        new Date().getFullYear() - new Date(patient.dateNaissance).getFullYear() : 'N/A';
      
      let emergencyText = `üö® URGENCE M√âDICALE üö®
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üë§ PATIENT: ${patient.prenom || 'Non renseign√©'} ${patient.nom || 'Non renseign√©'}
üìÖ N√©(e) le: ${patient.dateNaissance || 'Non renseign√©'} (${age} ans)
ü©∏ Groupe sanguin: ${patient.groupeSanguin || 'Non renseign√©'}

‚ö†Ô∏è ALLERGIES:
${patient.allergies && patient.allergies.trim() ? patient.allergies : '‚Ä¢ Aucune allergie connue'}

üíä TRAITEMENTS EN COURS:
${patient.traitements && patient.traitements.trim() ? patient.traitements : '‚Ä¢ Aucun traitement en cours'}

üè• PATHOLOGIES:
${patient.pathologies && patient.pathologies.trim() ? patient.pathologies : '‚Ä¢ Aucune pathologie connue'}

üìû CONTACT URGENCE:
${patient.contactUrgence || 'Non renseign√©'}

üë®‚Äç‚öïÔ∏è M√âDECIN TRAITANT:
${patient.medecinTraitant || 'Non renseign√©'}

üÜî ID Patient: ${user.uid ? user.uid.substring(0, 8) : 'N/A'}
ÔøΩ Email: ${user.email || 'Non renseign√©'}
ÔøΩüìÖ Derni√®re MAJ: ${now.toLocaleDateString('fr-FR')}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚ö° SYL Medical - Syst√®me d'Urgence`;

      // Nettoyer le texte pour √©viter les caract√®res probl√©matiques
      emergencyText = emergencyText
        .replace(/[\u0000-\u001F\u007F-\u009F]/g, '') // Supprimer caract√®res de contr√¥le
        .replace(/\s+$/gm, '') // Supprimer espaces en fin de ligne
        .trim();

      return emergencyText;
      
    } catch (error) {
      console.error('Erreur cr√©ation info urgence:', error);
      // Fallback avec info minimale et compacte
      return `URGENCE MEDICALE
PATIENT: ${user.email || 'Utilisateur connecte'}
ID: ${user.uid ? user.uid.substring(0, 8) : 'N/A'}
DATE: ${new Date().toLocaleDateString('fr-FR')}

Donnees patient non disponibles
Contactez services urgence

SYL Medical`;
    }
  }

  function tabProfileEvents() {
    // Calcul automatique de l'√¢ge
    const birthInput = document.getElementById('pfBirth');
    const ageInput = document.getElementById('pfAge');
    
    function calculateAge() {
      const birthDate = birthInput.value;
      if (birthDate) {
        const today = new Date();
        const birth = new Date(birthDate);
        let age = today.getFullYear() - birth.getFullYear();
        const monthDiff = today.getMonth() - birth.getMonth();
        
        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
          age--;
        }
        
        ageInput.value = age >= 0 ? `${age} ans` : '';
        medicalData.personalInfo.age = age;
      } else {
        ageInput.value = '';
        medicalData.personalInfo.age = '';
      }
    }
    
    // Calculer l'√¢ge √† l'ouverture si date existe
    calculateAge();
    
    // Recalculer l'√¢ge quand la date change
    birthInput.addEventListener('change', calculateAge);
    
    document.getElementById('saveProfile').onclick = async () => {
      // Validation des champs requis
      const requiredFields = [
        { id: 'pfFirstName', name: 'Pr√©nom' },
        { id: 'pfLastName', name: 'Nom' },
        { id: 'pfEmail', name: 'Email' },
        { id: 'pfPhone', name: 'T√©l√©phone' },
        { id: 'pfBirth', name: 'Date de naissance' },
        { id: 'pfBlood', name: 'Groupe sanguin' },
        { id: 'pfBraceletColor', name: 'Couleur de bracelet' }
      ];
      
      const missingFields = [];
      for (const field of requiredFields) {
        const value = document.getElementById(field.id).value.trim();
        if (!value) {
          missingFields.push(field.name);
          document.getElementById(field.id).classList.add('border-red-500', 'bg-red-50');
        } else {
          document.getElementById(field.id).classList.remove('border-red-500', 'bg-red-50');
        }
      }
      
      if (missingFields.length > 0) {
        alert(`‚ö†Ô∏è Veuillez remplir les champs obligatoires :\n‚Ä¢ ${missingFields.join('\n‚Ä¢ ')}`);
        return;
      }
      
      // Validation email
      const email = document.getElementById('pfEmail').value;
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        alert('‚ö†Ô∏è Veuillez saisir un email valide');
        document.getElementById('pfEmail').classList.add('border-red-500', 'bg-red-50');
        return;
      }
      
      // Sauvegarde des donn√©es
      medicalData.personalInfo.firstName = document.getElementById('pfFirstName').value;
      medicalData.personalInfo.lastName = document.getElementById('pfLastName').value;
      medicalData.personalInfo.email = document.getElementById('pfEmail').value;
      medicalData.personalInfo.phone = document.getElementById('pfPhone').value;
      medicalData.personalInfo.dateOfBirth = document.getElementById('pfBirth').value;
      medicalData.personalInfo.age = document.getElementById('pfAge').value;
      medicalData.personalInfo.bloodType = document.getElementById('pfBlood').value;
      medicalData.personalInfo.braceletColor = document.getElementById('pfBraceletColor').value;
      medicalData.personalInfo.height = document.getElementById('pfHeight').value;
      medicalData.personalInfo.weight = document.getElementById('pfWeight').value;
      medicalData.personalInfo.socialSecurityNumber = document.getElementById('pfSSN').value;
      medicalData.personalInfo.insuranceNumber = document.getElementById('pfInsurance').value;
      medicalData.personalInfo.address = document.getElementById('pfAddress').value;
      medicalData.personalInfo.city = document.getElementById('pfCity').value;
      medicalData.personalInfo.postalCode = document.getElementById('pfPostal').value;
      medicalData.personalInfo.preferredHospital = document.getElementById('pfHospital').value;
      
      if (!medicalData.personalInfo.emergencyContact) medicalData.personalInfo.emergencyContact = {};
      medicalData.personalInfo.emergencyContact.name = document.getElementById('pfContact1Name').value;
      medicalData.personalInfo.emergencyContact.relation = document.getElementById('pfContact1Rel').value;
      medicalData.personalInfo.emergencyContact.phone = document.getElementById('pfContact1Phone').value;
      
      medicalData.personalInfo.organDonor = document.getElementById('pfOrganDonor').checked;
      medicalData.personalInfo.advanceDirectives = document.getElementById('pfDirectives').checked;
      
      // Marquer le profil comme complet
      medicalData.profileComplete = true;
      medicalData.lastUpdated = new Date().toISOString();
      
      localStorage.setItem('syl-medicalData', JSON.stringify(medicalData));
      
      // Synchronisation Firebase avec UID utilisateur comme ID
      if (user.uid) {
        try {
          const patientData = { ...medicalData, uid: user.uid, email: user.email };
          await savePatientToFirestore(patientData);
          alert('‚úÖ Profil sauvegard√© et synchronis√© avec Firebase !');
        } catch (error) {
          console.error('Erreur sync Firebase:', error);
          alert('‚ö†Ô∏è Profil sauvegard√© localement. Synchronisation Firebase √©chou√©e.');
        }
      } else {
        alert('‚úÖ Profil sauvegard√© !');
      }
      render();
    };
  }

  function tabMedicalEvents() {
    const listTypes = ['allergies', 'medications', 'chronicDiseases', 'medicalDevices', 'surgeries', 'emergencyMedications', 'contraindications', 'riskFactors'];
    listTypes.forEach(type => {
      const btnEl = document.getElementById(`btn_${type}`);
      if (btnEl) {
        btnEl.onclick = async () => {
          const v = document.getElementById(`add_${type}`).value.trim();
          if (v) {
            if (medicalData.medicalHistory[type]) {
              medicalData.medicalHistory[type].push(v);
            } else if (medicalData.emergencyInfo[type]) {
              medicalData.emergencyInfo[type].push(v);
            }
            localStorage.setItem('syl-medicalData', JSON.stringify(medicalData));
            
            // Synchronisation Firebase avec UID utilisateur comme ID
            if (user.uid) {
              try {
                const patientData = { ...medicalData, uid: user.uid, email: user.email };
                await savePatientToFirestore(patientData);
              } catch (error) {
                console.error('Erreur sync Firebase:', error);
              }
            }
            render();
          }
        };
      }
      document.querySelectorAll(`[data-del="${type}"]`).forEach(btn => btn.onclick = async () => {
        const idx = parseInt(btn.getAttribute('data-idx'));
        if (medicalData.medicalHistory[type]) {
          medicalData.medicalHistory[type].splice(idx, 1);
        } else if (medicalData.emergencyInfo[type]) {
          medicalData.emergencyInfo[type].splice(idx, 1);
        }
        localStorage.setItem('syl-medicalData', JSON.stringify(medicalData));
        
        // Synchronisation Firebase avec UID utilisateur comme ID
        if (user.uid) {
          try {
            const patientData = { ...medicalData, uid: user.uid, email: user.email };
            await savePatientToFirestore(patientData);
          } catch (error) {
            console.error('Erreur sync Firebase:', error);
          }
        }
        render();
      });
    });
  }

  function tabBraceletEvents() {
    document.getElementById('resyncBracelet').onclick = async () => {
      const statusEl = document.getElementById('nfcStatus');
      statusEl.classList.remove('hidden');
      
      try {
        // Simulation d'une √©criture NFC avec timeout
        const nfcData = {
          patientId: user.uid,
          email: user.email,
          firstName: user.profile.firstName,
          lastName: user.profile.lastName || '',
          bloodType: medicalData.personalInfo?.bloodType || 'Non d√©fini',
          allergies: medicalData.medicalHistory?.allergies || [],
          emergencyContact: medicalData.emergencyContact?.phone || '',
          lastSync: new Date().toISOString()
        };
        
        // Simuler l'attente de l'approche du bracelet
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        // Sauvegarder dans Firebase
        if (user.uid) {
          await savePatientToFirestore({
            ...medicalData,
            uid: user.uid,
            email: user.email,
            lastNfcSync: new Date().toISOString()
          });
        }
        
        statusEl.innerHTML = `
          <div class="inline-flex items-center px-4 py-2 bg-green-100 text-green-800 rounded-lg">
            ‚úÖ Bracelet synchronis√© avec succ√®s !
          </div>
        `;
        
        SYLUtilities.showNotification('üîÑ Bracelet synchronis√©', {
          body: 'Vos donn√©es m√©dicales ont √©t√© mises √† jour sur votre bracelet NFC',
          icon: '/icon-192x192.png'
        });
        
        setTimeout(() => {
          statusEl.classList.add('hidden');
        }, 3000);
        
      } catch (error) {
        console.error('Erreur synchronisation bracelet:', error);
        statusEl.innerHTML = `
          <div class="inline-flex items-center px-4 py-2 bg-red-100 text-red-800 rounded-lg">
            ‚ùå Erreur de synchronisation
          </div>
        `;
        setTimeout(() => {
          statusEl.classList.add('hidden');
        }, 3000);
      }
    };
  }

  // Fonction pour afficher/masquer les options de r√©p√©tition
  function toggleRepeatOptions() {
    const repeatType = document.getElementById('reminderRepeat').value;
    const hourlyOptions = document.getElementById('hourlyOptions');
    const weekdaysOptions = document.getElementById('weekdaysOptions');
    
    // Masquer toutes les options d'abord
    hourlyOptions.classList.add('hidden');
    weekdaysOptions.classList.add('hidden');
    
    // Afficher les options selon le type s√©lectionn√©
    if (repeatType === 'hourly') {
      hourlyOptions.classList.remove('hidden');
    } else if (repeatType === 'weekdays') {
      weekdaysOptions.classList.remove('hidden');
    }
  }

  // Fonction pour formater l'affichage de la r√©p√©tition
  function getRepeatDisplayText(reminder) {
    if (!reminder.repeat || reminder.repeat === 'none') return '';
    
    switch (reminder.repeat) {
      case 'hourly':
        const hours = reminder.repeatOptions?.hourInterval || 1;
        return hours === 1 ? 'Toutes les heures' : `Toutes les ${hours}h`;
      case 'daily':
        return 'Quotidien';
      case 'weekly':
        return 'Hebdomadaire';
      case 'weekdays':
        if (reminder.repeatOptions?.weekdays?.length) {
          const dayNames = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];
          const selectedDays = reminder.repeatOptions.weekdays.map(day => dayNames[day]).join(', ');
          return `${selectedDays}`;
        }
        return 'Jours sp√©cifiques';
      case 'monthly':
        return 'Mensuel';
      default:
        return reminder.repeat;
    }
  }

  function tabRemindersEvents() {
    document.getElementById('saveReminder')?.addEventListener('click', () => {
      const title = document.getElementById('reminderTitle').value.trim();
      const type = document.getElementById('reminderType').value;
      const date = document.getElementById('reminderDate').value;
      const time = document.getElementById('reminderTime').value;
      const message = document.getElementById('reminderMessage').value.trim();
      const method = document.getElementById('reminderMethod').value;
      const repeat = document.getElementById('reminderRepeat').value;
      
      // R√©cup√©rer les options de r√©p√©tition avanc√©es
      let repeatOptions = {};
      if (repeat === 'hourly') {
        repeatOptions.hourInterval = parseInt(document.getElementById('hourInterval').value) || 1;
      } else if (repeat === 'weekdays') {
        const selectedDays = [];
        for (let i = 0; i <= 6; i++) {
          const checkbox = document.getElementById(`weekday-${i}`);
          if (checkbox && checkbox.checked) {
            selectedDays.push(i);
          }
        }
        repeatOptions.weekdays = selectedDays;
        if (selectedDays.length === 0) {
          alert('‚ö†Ô∏è Veuillez s√©lectionner au moins un jour de la semaine');
          return;
        }
      }
      
      if (!title || !date || !time) {
        alert('‚ö†Ô∏è Veuillez remplir les champs obligatoires:\n‚Ä¢ Titre\n‚Ä¢ Date\n‚Ä¢ Heure');
        return;
      }
      
      const dateTime = new Date(`${date}T${time}`);
      const now = new Date();
      
      if (dateTime <= now) {
        alert('‚ö†Ô∏è La date et l\'heure doivent √™tre dans le futur');
        return;
      }
      
      const reminder = {
        id: Date.now(),
        title,
        type,
        message: message || `Rappel: ${title}`,
        method,
        repeat,
        repeatOptions,
        dateTime: dateTime.toISOString(),
        createdAt: now.toISOString(),
        notified: false,
        active: true
      };
      
      // Sauvegarder le rappel
      const reminders = JSON.parse(localStorage.getItem('syl-reminders') || '[]');
      reminders.push(reminder);
      localStorage.setItem('syl-reminders', JSON.stringify(reminders));
      
      // Programmer la notification
      scheduleReminder(reminder);
      
      // Reset form
      document.getElementById('reminderTitle').value = '';
      document.getElementById('reminderMessage').value = '';
      document.getElementById('reminderDate').value = '';
      document.getElementById('reminderTime').value = '';
      document.getElementById('reminderRepeat').value = 'none';
      document.getElementById('hourInterval').value = '1';
      
      // Reset checkboxes
      for (let i = 0; i <= 6; i++) {
        const checkbox = document.getElementById(`weekday-${i}`);
        if (checkbox) checkbox.checked = false;
      }
      
      // Masquer les options de r√©p√©tition
      document.getElementById('hourlyOptions').classList.add('hidden');
      document.getElementById('weekdaysOptions').classList.add('hidden');
      
      // Notification de confirmation
      const methodText = method === 'notification' ? 'notification smartphone' : 
                        method === 'email' ? 'email' : 
                        method === 'sms' ? 'SMS' : 'tous les modes';
      
      SYLUtilities.showNotification('‚úÖ Rappel cr√©√©', {
        body: `"${title}" programm√© pour le ${dateTime.toLocaleDateString('fr-FR')} √† ${dateTime.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})} par ${methodText}`,
        icon: '/icon-192x192.png'
      });
      
      render();
    });
  }
  
  // Fonction pour programmer un rappel
  function scheduleReminder(reminder) {
    const now = new Date();
    const reminderTime = new Date(reminder.dateTime);
    const delay = reminderTime.getTime() - now.getTime();
    
    if (delay > 0) {
      setTimeout(() => {
        sendReminderNotification(reminder);
      }, delay);
      
      console.log(`üìÖ Rappel "${reminder.title}" programm√© dans ${Math.round(delay / 1000 / 60)} minutes`);
    }
  }
  
  // Fonction pour envoyer les notifications
  function sendReminderNotification(reminder) {
    const methods = reminder.method === 'all' ? ['notification', 'email', 'sms'] : [reminder.method];
    
    methods.forEach(method => {
      switch (method) {
        case 'notification':
          SYLUtilities.showNotification(`üîî Rappel: ${reminder.title}`, {
            body: reminder.message,
            icon: '/icon-192x192.png',
            requireInteraction: true
          });
          break;
          
        case 'email':
          // Simulation d'envoi d'email
          console.log(`üìß Email envoy√© pour: ${reminder.title}`);
          SYLUtilities.showNotification('üìß Email de rappel envoy√©', {
            body: `Email envoy√© pour "${reminder.title}"`
          });
          break;
          
        case 'sms':
          // Simulation d'envoi de SMS
          console.log(`üí¨ SMS envoy√© pour: ${reminder.title}`);
          SYLUtilities.showNotification('üí¨ SMS de rappel envoy√©', {
            body: `SMS envoy√© pour "${reminder.title}"`
          });
          break;
      }
    });
    
    // Marquer comme notifi√©
    const reminders = JSON.parse(localStorage.getItem('syl-reminders') || '[]');
    const index = reminders.findIndex(r => r.id === reminder.id);
    if (index !== -1) {
      reminders[index].notified = true;
      reminders[index].notifiedAt = new Date().toISOString();
      localStorage.setItem('syl-reminders', JSON.stringify(reminders));
    }
  }
}

// Fonctions globales pour les rappels
function deleteReminder(index) {
  if (confirm('Supprimer ce rappel ?')) {
    const reminders = JSON.parse(localStorage.getItem('syl-reminders') || '[]');
    reminders.splice(index, 1);
    localStorage.setItem('syl-reminders', JSON.stringify(reminders));
    
    // Re-render si on est sur la page des rappels
    const activeTabEl = document.querySelector('[data-tab].bg-blue-100');
    if (activeTabEl && activeTabEl.getAttribute('data-tab') === 'reminders') {
      // Recharger la section des rappels
      location.reload();
    }
  }
}

// DEPRECATED: Les fonctions localStorage ne sont plus utilis√©es - 100% Firebase
function savePatientsWithTimestamp(patients) {
  console.warn('‚ö†Ô∏è savePatientsWithTimestamp est obsol√®te - utilisation de Firebase uniquement');
  // Ne fait plus rien - fonction conserv√©e pour compatibilit√© temporaire
}

function loadPatientsWithTimestamp() {
  console.warn('‚ö†Ô∏è loadPatientsWithTimestamp est obsol√®te - utilisation de Firebase uniquement');
  // Retourne une structure vide pour compatibilit√©
  return {
    patients: [],
    isStale: false,
    age: 0,
    source: 'deprecated'
  };
}

// Fonction globale pour charger les patients depuis Firebase
async function loadPatientsFromFirebase() {
  try {
    if (!db || typeof db.collection !== 'function') {
      throw new Error('Firebase non initialis√© correctement');
    }

    // V√©rifier l'authentification (admin local OU Firebase)
    const currentUser = firebase.auth().currentUser;
    const localUser = getUser();
    
    // Accepter les admins locaux m√™me s'ils ne sont pas connect√©s √† Firebase
    if (!currentUser && (!localUser || localUser.role !== 'admin')) {
      throw new Error('Vous devez √™tre connect√© pour acc√©der aux donn√©es Firebase');
    }
    
    if (localUser && localUser.role === 'admin') {
      console.log('üîë Admin local d√©tect√©, acc√®s Firebase autoris√©:', localUser.email);
    } else if (currentUser) {
      console.log('Utilisateur Firebase connect√©:', currentUser.email);
      console.log('UID:', currentUser.uid);
    }
    console.log('Tentative de chargement des patients depuis Firebase...');
    
    // Essayer diff√©rentes approches selon les permissions
    let firebaseUsers = [];
    let permissionTestPassed = false;
    
    // Test 1: Essayer de lire sa propre donn√©e utilisateur
    try {
      const userDoc = await db.collection('users').doc(currentUser.uid).get();
      console.log('‚úÖ Lecture du profil utilisateur r√©ussie');
      permissionTestPassed = true;
      
      const userData = userDoc.data();
      if (userData && (userData.role === 'admin' || userData.role === 'Admin')) {
        console.log('‚úÖ Utilisateur admin d√©tect√©');
      } else {
        console.log('‚ö†Ô∏è Utilisateur non-admin:', userData?.role);
      }
    } catch (userError) {
      console.error('‚ùå Impossible de lire le profil utilisateur:', userError);
    }
    
    // Test 2: Essayer de lire tous les utilisateurs (pour admin)
    if (permissionTestPassed) {
      try {
        const usersSnapshot = await db.collection('users').limit(3).get();
        console.log('‚úÖ Test lecture collection users r√©ussi, documents:', usersSnapshot.size);
      } catch (readError) {
        console.error('‚ùå Lecture collection users refus√©e:', readError.code);
        
        // Afficher un guide d√©taill√© pour r√©soudre le probl√®me
        const errorModal = document.createElement('div');
        errorModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        errorModal.innerHTML = `
          <div class="bg-white rounded-lg p-6 max-w-2xl mx-4 max-h-96 overflow-y-auto">
            <h3 class="text-lg font-bold text-red-600 mb-4">üîí Probl√®me de Permissions Firebase</h3>
            <div class="space-y-4 text-sm">
              <div class="bg-yellow-50 border border-yellow-200 rounded p-3">
                <p><strong>Utilisateur connect√©:</strong> ${currentUser.email}</p>
                <p><strong>UID:</strong> ${currentUser.uid}</p>
              </div>
              
              <div class="bg-blue-50 border border-blue-200 rounded p-3">
                <h4 class="font-bold text-blue-800 mb-2">üìã Solutions rapides:</h4>
                <ol class="space-y-1 text-blue-700">
                  <li><strong>1. R√®gles temporaires (d√©veloppement):</strong></li>
                  <li class="ml-4 font-mono text-xs bg-gray-100 p-2 rounded">allow read, write: if request.auth != null;</li>
                  <li><strong>2. Ajoutez votre UID comme admin dans Firestore</strong></li>
                  <li><strong>3. V√©rifiez que le document users/${currentUser.uid} existe</strong></li>
                </ol>
              </div>
              
              <div class="bg-green-50 border border-green-200 rounded p-3">
                <h4 class="font-bold text-green-800 mb-2">üîß R√®gles Firestore recommand√©es:</h4>
                <pre class="text-xs bg-gray-100 p-2 rounded overflow-x-auto">rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      allow read: if request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    match /patients/{patientId} {
      allow read, write: if request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'medecin'];
    }
  }
}</pre>
              </div>
            </div>
            <button onclick="this.closest('.fixed').remove()" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white rounded px-4 py-2">Fermer</button>
          </div>
        `;
        document.body.appendChild(errorModal);
        
        throw new Error('Permissions insuffisantes pour lire la collection users');
      }
    }
    
    // Charger les utilisateurs patients
    const usersSnapshot = await db.collection('users').where('role', '==', 'patient').get();
    
    usersSnapshot.forEach(doc => {
      const userData = doc.data();
      firebaseUsers.push({
        id: doc.id,
        uid: userData.uid || doc.id,
        email: userData.email,
        role: userData.role,
        ...userData
      });
    });
    
    console.log('Utilisateurs patients trouv√©s:', firebaseUsers.length);
    
    if (firebaseUsers.length === 0) {
      alert('‚ÑπÔ∏è Aucun patient trouv√© dans Firebase.\n\nAssurez-vous que:\n- Des utilisateurs avec role="patient" existent\n- Vos r√®gles Firestore permettent la lecture\n- Vous √™tes connect√© avec les bonnes permissions');
      return false;
    }
    
    // R√©cup√©rer les donn√©es m√©dicales
    const patientsSnapshot = await db.collection('patients').get();
    const medicalDataMap = {};
    
    patientsSnapshot.forEach(doc => {
      const data = doc.data();
      const userId = doc.id.replace('_medical', '');
      medicalDataMap[userId] = data;
    });
    
    console.log('Donn√©es m√©dicales trouv√©es:', Object.keys(medicalDataMap).length);
    
    // Fusionner les donn√©es
    const completePatients = firebaseUsers.map(user => {
      const medicalData = medicalDataMap[user.uid] || {};
      return {
        ...user,
        personalInfo: medicalData.personalInfo || {
          firstName: user.profile?.firstName || user.displayName?.split(' ')[0] || 'Pr√©nom',
          lastName: user.profile?.lastName || user.displayName?.split(' ').slice(1).join(' ') || 'Nom',
          bloodType: 'N/A'
        },
        medicalHistory: medicalData.medicalHistory || {
          allergies: [],
          medications: [],
          chronicDiseases: []
        },
        emergencyInfo: medicalData.emergencyInfo || {
          criticalNotes: ''
        },
        isActive: medicalData.isActive !== undefined ? medicalData.isActive : true,
        nfcTagId: medicalData.nfcTagId || null,
        createdAt: user.createdAt || new Date().toISOString()
      };
    });
    
    console.log(`‚úÖ ${completePatients.length} patients charg√©s depuis Firebase`);
    alert(`‚úÖ ${completePatients.length} patients charg√©s depuis Firebase !`);
    location.reload();
    return true;
    
  } catch (error) {
    console.error('Erreur chargement Firebase:', error);
    
    let errorMessage = 'Erreur Firebase: ';
    if (error.code === 'permission-denied') {
      errorMessage += 'Permissions insuffisantes.\n\nSolutions possibles:\n1. V√©rifiez vos r√®gles Firestore\n2. Assurez-vous d\'√™tre connect√©\n3. Contactez l\'administrateur';
    } else if (error.code === 'unavailable') {
      errorMessage += 'Service Firebase indisponible.\nV√©rifiez votre connexion internet.';
    } else {
      errorMessage += error.message;
    }
    
    alert('‚ùå ' + errorMessage);
    return false;
  }
}

// ----------- FONCTIONS GLOBALES POUR WORKFLOW NFC -----------

// Variables globales pour le workflow NFC
let currentScannedTag = null;
let selectedPatientId = null;
let globalPatients = []; // Pour acc√®s depuis les fonctions globales

function checkTagStep() {
  const tagId = document.getElementById('nfcTagId')?.value;
  if (tagId && tagId.trim() !== '') {
    currentScannedTag = tagId.trim();
    showScanResult(`‚úÖ Tag d√©tect√©: ${currentScannedTag}`, 'success');
    showStep2();
  }
}

function scanNFCTag() {
  // Utiliser le vrai syst√®me NFC (comme dans setupNFCEvents)
  scanNFCForWorkflow();
}

async function scanNFCForWorkflow() {
  try {
    // V√©rifier le support NFC
    if (!('NDEFReader' in window)) {
      // Fallback avec simulation si NFC non support√©
      if (confirm('NFC non support√© sur cet appareil. Voulez-vous utiliser la simulation pour tester ?')) {
        const simulatedTagId = 'NFC_' + Date.now().toString(36).toUpperCase();
        document.getElementById('nfcTagId').value = simulatedTagId;
        checkTagStep();
      }
      return;
    }

    // V√©rifier les permissions
    const permission = await navigator.permissions.query({ name: 'nfc' });
    if (permission.state === 'denied') {
      throw new Error('Permissions NFC refus√©es. Activez le NFC dans les param√®tres du navigateur.');
    }

    // V√©rifier HTTPS
    if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
      throw new Error('NFC n√©cessite HTTPS. Utilisez un serveur HTTPS ou localhost.');
    }

    // D√©marrer le scan NFC
    let ndef;
    try {
      ndef = new NDEFReader();
    } catch (constructorError) {
      console.error('Erreur constructor NDEFReader:', constructorError);
      throw new Error('Impossible d\'initialiser le lecteur NFC. V√©rifiez que le NFC est activ√© et que vous utilisez un navigateur compatible.');
    }
    
    // Afficher un modal de scan en cours
    const scanModal = document.createElement('div');
    scanModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    scanModal.innerHTML = `
      <div class="bg-white rounded-lg p-6 max-w-md mx-4 text-center">
        <div class="animate-pulse mb-4">
          <div class="w-16 h-16 bg-blue-600 rounded-full mx-auto flex items-center justify-center text-white text-2xl">
            üì±
          </div>
        </div>
        <h3 class="text-lg font-bold text-gray-900 mb-2">Scan NFC en cours...</h3>
        <p class="text-gray-600 mb-4">Approchez votre tag NFC du t√©l√©phone</p>
        <button id="cancelNFCScan" class="bg-gray-500 hover:bg-gray-600 text-white rounded px-4 py-2">Annuler</button>
      </div>
    `;
    document.body.appendChild(scanModal);

    // G√©rer l'annulation
    document.getElementById('cancelNFCScan').onclick = () => {
      scanModal.remove();
      console.log('Scan NFC annul√©');
    };

    // D√©marrer le scan
    await ndef.scan();
    console.log('üì± Scan NFC d√©marr√©, approchez votre tag...');

    // √âcouter les tags d√©tect√©s
    ndef.addEventListener('reading', ({ message, serialNumber }) => {
      scanModal.remove(); // Fermer le modal
      
      console.log('üì± Tag NFC d√©tect√©!', { serialNumber, message });
      
      let tagId = serialNumber || 'UNKNOWN';
      let tagData = [];
      let tagContent = '';

      // Analyser le contenu du tag
      if (message && message.records.length > 0) {
        message.records.forEach(record => {
          let content = '';
          if (record.recordType === 'text') {
            content = new TextDecoder().decode(record.data);
          } else if (record.recordType === 'url') {
            content = new TextDecoder().decode(record.data);
          } else {
            content = `Donn√©es binaires (${record.data.byteLength} bytes)`;
          }
          
          tagData.push({
            recordType: record.recordType,
            mediaType: record.mediaType || 'N/A',
            content: content,
            size: record.data.byteLength
          });
        });
      } else {
        tagContent = 'Tag vide';
        tagId = serialNumber || 'NFC_' + Date.now();
      }

      // Formater l'ID si n√©cessaire
      if (!tagId.startsWith('NFC_') && !tagId.startsWith('SYL_')) {
        tagId = 'NFC_' + tagId;
      }

      // Mettre √† jour le champ de l'interface
      const nfcTagIdField = document.getElementById('nfcTagId');
      if (nfcTagIdField) {
        nfcTagIdField.value = tagId;
      }
      
      // Afficher les d√©tails du tag scann√©
      showScanResult(`‚úÖ Tag NFC d√©tect√©: ${tagId}${tagData.length > 0 ? ` (${tagData.length} enregistrement(s))` : ' (vide)'}`, 'success');
      
      // Passer √† l'√©tape suivante
      checkTagStep();
      
      console.log('üì± Tag scann√© avec succ√®s:', {
        id: tagId,
        serialNumber: serialNumber,
        content: tagData
      });
    });

    // Timeout pour le scan
    setTimeout(() => {
      if (document.body.contains(scanModal)) {
        scanModal.remove();
        showScanResult('‚è∞ Timeout du scan NFC. R√©essayez.', 'error');
      }
    }, 30000); // 30 secondes

  } catch (error) {
    console.error('Erreur NFC:', error);
    
    let errorMessage = 'Erreur NFC: ';
    if (error.name === 'NotAllowedError') {
      errorMessage += 'Permissions NFC refus√©es. Activez le NFC dans les param√®tres.';
    } else if (error.name === 'NotSupportedError') {
      errorMessage += 'NFC non support√© sur cet appareil.';
    } else if (error.message.includes('HTTPS')) {
      errorMessage += 'NFC n√©cessite HTTPS. Testez sur un serveur s√©curis√©.';
    } else {
      errorMessage += error.message;
    }
    
    showScanResult(`‚ùå ${errorMessage}`, 'error');
    
    // Proposer une simulation en cas d'erreur
    if (confirm(errorMessage + '\n\nVoulez-vous utiliser la simulation NFC pour tester ?')) {
      const simulatedTagId = 'NFC_' + Date.now().toString(36).toUpperCase();
      document.getElementById('nfcTagId').value = simulatedTagId;
      showScanResult(`üîß Simulation: Tag ${simulatedTagId} g√©n√©r√©`, 'success');
      checkTagStep();
    }
  }
}

function showScanResult(message, type) {
  const resultDiv = document.getElementById('tagScanResult');
  if (resultDiv) {
    resultDiv.innerHTML = message;
    resultDiv.className = `scan-result ${type}`;
    resultDiv.style.display = 'block';
  }
}

function showStep2() {
  // Activer √©tape 2
  const step2 = document.getElementById('step2');
  if (step2) {
    step2.style.display = 'block';
    // Mettre √† jour l'indicateur visuel
    const stepNumber = document.querySelector('.workflow-step:nth-child(3) .step-number');
    if (stepNumber) {
      stepNumber.classList.add('active');
    }
  }
}

function showStep3() {
  // Activer √©tape 3
  const step3 = document.getElementById('step3');
  if (step3) {
    step3.style.display = 'block';
    // Mettre √† jour l'indicateur visuel
    const stepNumber = document.querySelector('.workflow-step:nth-child(5) .step-number');
    if (stepNumber) {
      stepNumber.classList.add('active');
    }
    
    // G√©n√©rer le lien d'urgence
    const emergencyLink = `${window.location.origin}/OLDINDEX.html?patient=${selectedPatientId}&access=medical`;
    const linkDiv = document.getElementById('generatedLink');
    if (linkDiv) {
      linkDiv.textContent = emergencyLink;
    }
  }
}

function searchPatients(query) {
  const patientOptions = document.querySelectorAll('.patient-option');
  const searchTerm = query.toLowerCase();
  
  patientOptions.forEach(option => {
    const name = option.querySelector('.patient-option-name')?.textContent.toLowerCase() || '';
    const email = option.querySelector('.patient-option-email')?.textContent.toLowerCase() || '';
    
    if (name.includes(searchTerm) || email.includes(searchTerm)) {
      option.style.display = 'flex';
    } else {
      option.style.display = 'none';
    }
  });
}

function selectPatient(patientId) {
  selectedPatientId = patientId;
  
  // Mettre √† jour l'interface visuelle
  document.querySelectorAll('.patient-option').forEach(option => {
    option.classList.remove('selected');
  });
  
  const selectedOption = document.querySelector(`[data-patient-id="${patientId}"]`);
  if (selectedOption) {
    selectedOption.classList.add('selected');
  }
  
  // Trouver les donn√©es du patient
  const patient = globalPatients.find(p => (p.id || p.uid) === patientId);
  if (patient) {
    // Afficher les infos du patient s√©lectionn√©
    const selectedInfo = document.getElementById('selectedPatientInfo');
    if (selectedInfo) {
      selectedInfo.innerHTML = `
        <div class="selected-patient-header">
          <h5>‚úÖ Patient s√©lectionn√©:</h5>
        </div>
        <div class="selected-patient-details">
          <strong>${patient.personalInfo?.firstName} ${patient.personalInfo?.lastName}</strong><br>
          üìß ${patient.email}<br>
          ${patient.personalInfo?.bloodType ? `ü©∏ Groupe sanguin: ${patient.personalInfo.bloodType}<br>` : ''}
          ${patient.personalInfo?.phone ? `üìû ${patient.personalInfo.phone}<br>` : ''}
        </div>
      `;
      selectedInfo.style.display = 'block';
    }
    
    // Afficher l'√©tape 3
    showStep3();
    
    // G√©n√©rer automatiquement la fiche patient mise √† jour
    generatePatientMedicalCard(patient);
  }
}

function generatePatientMedicalCard(patient) {
  // Cette fonction g√©n√®re/met √† jour automatiquement la fiche m√©dicale du patient
  // bas√©e sur ses donn√©es actuelles dans Firebase
  
  console.log('üè• G√©n√©ration de la fiche m√©dicale pour:', patient.email);
  
  // Cr√©er ou mettre √† jour la fiche m√©dicale compl√®te
  const medicalCard = {
    patientId: patient.id || patient.uid,
    timestamp: new Date().toISOString(),
    personalInfo: {
      firstName: patient.personalInfo?.firstName || '',
      lastName: patient.personalInfo?.lastName || '',
      birthDate: patient.personalInfo?.birthDate || '',
      phone: patient.personalInfo?.phone || '',
      address: patient.personalInfo?.address || '',
      bloodType: patient.personalInfo?.bloodType || ''
    },
    medicalInfo: {
      allergies: patient.medicalInfo?.allergies || [],
      medications: patient.medicalInfo?.medications || [],
      conditions: patient.medicalInfo?.conditions || [],
      emergencyNotes: patient.medicalInfo?.emergencyNotes || ''
    },
    emergencyContact: {
      name: patient.emergencyContact?.name || '',
      relationship: patient.emergencyContact?.relationship || '',
      phone: patient.emergencyContact?.phone || ''
    },
    accessLink: `${window.location.origin}/OLDINDEX.html?patient=${patient.id || patient.uid}&access=medical`
  };
  
  // Sauvegarder dans localStorage pour acc√®s rapide
  localStorage.setItem(`medicalCard_${patient.id || patient.uid}`, JSON.stringify(medicalCard));
  
  console.log('‚úÖ Fiche m√©dicale g√©n√©r√©e et sauvegard√©e');
  return medicalCard;
}

function writePatientToNFC() {
  if (!currentScannedTag || !selectedPatientId) {
    alert('‚ùå Veuillez d\'abord scanner un tag et s√©lectionner un patient');
    return;
  }
  
  const emergencyLink = `${window.location.origin}/OLDINDEX.html?patient=${selectedPatientId}&access=medical`;
  
  // Utiliser le vrai syst√®me d'√©criture NFC
  writeNFCReal(currentScannedTag, emergencyLink);
}

async function writeNFCReal(tagId, link) {
  const resultDiv = document.getElementById('programmingResult');
  
  try {
    // V√©rifier le support NFC
    if (!('NDEFReader' in window)) {
      // Fallback simulation si NFC non support√©
      simulateNFCWrite(tagId, link);
      return;
    }

    // V√©rifier HTTPS
    if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
      throw new Error('NFC n√©cessite HTTPS pour l\'√©criture.');
    }

    if (resultDiv) {
      resultDiv.innerHTML = '‚è≥ Pr√©paration de l\'√©criture NFC...';
      resultDiv.className = 'programming-result';
      resultDiv.style.display = 'block';
    }

    // Initialiser le writer NFC
    let ndef;
    try {
      ndef = new NDEFReader();
    } catch (constructorError) {
      console.error('Erreur constructor NDEFReader:', constructorError);
      throw new Error('Impossible d\'initialiser l\'√©criture NFC.');
    }

    // Afficher modal d'√©criture
    const writeModal = document.createElement('div');
    writeModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    writeModal.innerHTML = `
      <div class="bg-white rounded-lg p-6 max-w-md mx-4 text-center">
        <div class="animate-pulse mb-4">
          <div class="w-16 h-16 bg-purple-600 rounded-full mx-auto flex items-center justify-center text-white text-2xl">
            ‚úçÔ∏è
          </div>
        </div>
        <h3 class="text-lg font-bold text-gray-900 mb-2">√âcriture NFC en cours...</h3>
        <p class="text-gray-600 mb-4">Approchez votre tag NFC du t√©l√©phone pour l'√©criture</p>
        <p class="text-sm text-blue-600 mb-4">Lien √† √©crire: ${link}</p>
        <button id="cancelNFCWrite" class="bg-gray-500 hover:bg-gray-600 text-white rounded px-4 py-2">Annuler</button>
      </div>
    `;
    document.body.appendChild(writeModal);

    // G√©rer l'annulation
    document.getElementById('cancelNFCWrite').onclick = () => {
      writeModal.remove();
      if (resultDiv) {
        resultDiv.innerHTML = '‚ùå √âcriture NFC annul√©e';
        resultDiv.className = 'programming-result error';
      }
    };

    if (resultDiv) {
      resultDiv.innerHTML = 'üì± Approchez votre tag NFC pour l\'√©criture...';
    }

    // √âcrire sur le tag
    await ndef.write({
      records: [{
        recordType: "url",
        data: link
      }]
    });

    writeModal.remove();
    
    // Sauvegarder l'association dans Firebase
    const nfcTagData = {
      id: tagId,
      assignedTo: selectedPatientId,
      emergencyLink: link,
      assignedAt: new Date().toISOString(),
      status: 'active'
    };
    
    await db.collection('nfcTags').doc(tagId).set(nfcTagData, { merge: true });
    
    // Mettre √† jour le patient avec l'ID du tag
    const patient = globalPatients.find(p => (p.id || p.uid) === selectedPatientId);
    if (patient) {
      await db.collection('patients').doc(selectedPatientId).update({
        nfcTagId: tagId,
        lastModified: firebase.firestore.FieldValue.serverTimestamp()
      });
    }
    
    if (resultDiv) {
      resultDiv.innerHTML = `
        ‚úÖ Tag NFC programm√© avec succ√®s !<br>
        üè∑Ô∏è Tag: ${tagId}<br>
        üîó Lien: ${link}<br>
        üë§ Patient: ${patient?.personalInfo?.firstName} ${patient?.personalInfo?.lastName}<br>
        üì± <strong>√âcriture NFC r√©elle effectu√©e</strong>
      `;
      resultDiv.className = 'programming-result success';
    }
    
    console.log('‚úÖ Tag NFC √©crit avec succ√®s:', {
      tagId,
      link,
      patientId: selectedPatientId
    });
    
    // R√©initialiser le workflow apr√®s succ√®s
    setTimeout(() => {
      resetNFCWorkflow();
    }, 5000);
    
  } catch (error) {
    console.error('Erreur lors de l\'√©criture NFC:', error);
    
    // Fermer le modal s'il est ouvert
    const modal = document.querySelector('.fixed.inset-0');
    if (modal) modal.remove();
    
    let errorMessage = 'Erreur √©criture NFC: ';
    if (error.name === 'NotAllowedError') {
      errorMessage += 'Permissions NFC refus√©es pour l\'√©criture.';
    } else if (error.name === 'NotSupportedError') {
      errorMessage += '√âcriture NFC non support√©e.';
    } else if (error.message.includes('HTTPS')) {
      errorMessage += 'HTTPS requis pour √©criture NFC.';
    } else {
      errorMessage += error.message;
    }
    
    if (resultDiv) {
      resultDiv.innerHTML = `‚ùå ${errorMessage}`;
      resultDiv.className = 'programming-result error';
    }
    
    // Proposer fallback simulation
    if (confirm(errorMessage + '\n\nVoulez-vous simuler l\'√©criture pour tester ?')) {
      simulateNFCWrite(tagId, link);
    }
  }
}

function simulateNFCWrite(tagId, link) {
  const resultDiv = document.getElementById('programmingResult');
  
  // Simuler l'√©criture
  if (resultDiv) {
    resultDiv.innerHTML = '‚è≥ Programmation du tag en cours...';
    resultDiv.className = 'programming-result';
    resultDiv.style.display = 'block';
  }
  
  setTimeout(async () => {
    try {
      // Enregistrer l'association dans Firebase
      const nfcTagData = {
        id: tagId,
        assignedTo: selectedPatientId,
        emergencyLink: link,
        assignedAt: new Date().toISOString(),
        status: 'active'
      };
      
      // Sauvegarder dans Firestore
      await db.collection('nfcTags').doc(tagId).set(nfcTagData, { merge: true });
      
      // Mettre √† jour le patient avec l'ID du tag
      const patient = globalPatients.find(p => (p.id || p.uid) === selectedPatientId);
      if (patient) {
        await db.collection('patients').doc(selectedPatientId).update({
          nfcTagId: tagId,
          lastModified: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
      
      if (resultDiv) {
        resultDiv.innerHTML = `
          ‚úÖ Tag NFC programm√© avec succ√®s !<br>
          üè∑Ô∏è Tag: ${tagId}<br>
          üîó Lien: ${link}<br>
          üë§ Patient: ${patient?.personalInfo?.firstName} ${patient?.personalInfo?.lastName}
        `;
        resultDiv.className = 'programming-result success';
      }
      
      // R√©initialiser le workflow
      setTimeout(() => {
        resetNFCWorkflow();
      }, 3000);
      
    } catch (error) {
      console.error('Erreur lors de la programmation:', error);
      if (resultDiv) {
        resultDiv.innerHTML = `‚ùå Erreur: ${error.message}`;
        resultDiv.className = 'programming-result error';
      }
    }
  }, 2000);
}

function testNFCLink() {
  if (!selectedPatientId) {
    alert('‚ùå Aucun patient s√©lectionn√©');
    return;
  }
  
  const link = `${window.location.origin}/OLDINDEX.html?patient=${selectedPatientId}&access=medical`;
  window.open(link, '_blank');
}

function resetNFCWorkflow() {
  // R√©initialiser les variables
  currentScannedTag = null;
  selectedPatientId = null;
  
  // R√©initialiser l'interface
  const nfcTagId = document.getElementById('nfcTagId');
  const step2 = document.getElementById('step2');
  const step3 = document.getElementById('step3');
  
  if (nfcTagId) nfcTagId.value = '';
  if (step2) step2.style.display = 'none';
  if (step3) step3.style.display = 'none';
  
  // R√©initialiser les indicateurs visuels
  document.querySelectorAll('.step-number').forEach(step => {
    step.classList.remove('active');
  });
  const firstStep = document.querySelector('.step-number');
  if (firstStep) firstStep.classList.add('active');
  
  // Cacher les r√©sultats
  const scanResult = document.getElementById('tagScanResult');
  const programmingResult = document.getElementById('programmingResult');
  const selectedInfo = document.getElementById('selectedPatientInfo');
  
  if (scanResult) scanResult.style.display = 'none';
  if (programmingResult) programmingResult.style.display = 'none';
  if (selectedInfo) selectedInfo.style.display = 'none';
  
  // Recharger l'interface admin
  location.reload();
}

// Fonctions pour la gestion des associations existantes
function testNFCAssignment(tagId) {
  // Ces fonctions utilisent les variables globales d√©finies dans renderAdminDashboard
  if (window.nfcTags) {
    const tag = window.nfcTags.find(t => t.id === tagId);
    if (tag && tag.assignedTo) {
      const link = `${window.location.origin}/OLDINDEX.html?patient=${tag.assignedTo}&access=medical`;
      window.open(link, '_blank');
    }
  }
}

function reprogramNFC(tagId) {
  if (confirm(`Voulez-vous reprogrammer le tag ${tagId} ?`)) {
    // R√©initialiser et pr√©remplir avec ce tag
    currentScannedTag = tagId;
    const nfcTagIdField = document.getElementById('nfcTagId');
    if (nfcTagIdField) {
      nfcTagIdField.value = tagId;
      showScanResult(`‚úÖ Tag ${tagId} s√©lectionn√© pour reprogrammation`, 'success');
      showStep2();
    }
  }
}

function removeNFCAssignment(tagId) {
  if (confirm(`Voulez-vous dissocier le tag ${tagId} ?`)) {
    // Supprimer l'association
    db.collection('nfcTags').doc(tagId).update({
      assignedTo: firebase.firestore.FieldValue.delete(),
      emergencyLink: firebase.firestore.FieldValue.delete(),
      assignedAt: firebase.firestore.FieldValue.delete()
    }).then(() => {
      console.log('‚úÖ Association supprim√©e');
      location.reload();
    }).catch(error => {
      console.error('Erreur:', error);
      alert('Erreur lors de la suppression');
    });
  }
}

// Fonction pour cr√©er un patient de test pour les liens d'urgence
function createTestPatient() {
  const testPatient = {
    id: 'test_patient_123',
    uid: 'test_patient_123',
    email: 'patient.test@example.com',
    role: 'patient',
    personalInfo: {
      firstName: 'Jean',
      lastName: 'Dupont',
      dateOfBirth: '1985-03-15',
      bloodType: 'O+',
      height: '175',
      weight: '70',
      phone: '06 12 34 56 78',
      emergencyContact: {
        name: 'Marie Dupont',
        relationship: '√âpouse',
        phone: '06 98 76 54 32'
      }
    },
    medicalHistory: {
      allergies: ['P√©nicilline', 'Fruits √† coque'],
      medications: ['Doliprane 1000mg - 1 comprim√© matin et soir', 'Ventoline - En cas de besoin'],
      chronicDiseases: ['Asthme l√©ger', 'Hypertension']
    },
    emergencyInfo: {
      criticalNotes: 'ALLERGIE S√âV√àRE √Ä LA P√âNICILLINE - RISQUE DE CHOC ANAPHYLACTIQUE'
    },
    isActive: true
  };
  
  // Sauvegarder dans localStorage pour test
  const patients = JSON.parse(localStorage.getItem('syl-patients') || '[]');
  const existingIndex = patients.findIndex(p => (p.id || p.uid) === testPatient.id);
  if (existingIndex >= 0) {
    patients[existingIndex] = testPatient;
  } else {
    patients.push(testPatient);
  }
  localStorage.setItem('syl-patients', JSON.stringify(patients));
  
  console.log('‚úÖ Patient de test cr√©√©:', testPatient);
  return testPatient;
}

// Cr√©er automatiquement le patient de test au chargement pour d√©monstration
if (typeof window !== 'undefined') {
  // Attendre que la page soit charg√©e
  window.addEventListener('load', () => {
    setTimeout(() => {
      createTestPatient();
    }, 1000);
  });
}

function refreshNFCList() {
  location.reload();
}

// ----------- ADMIN DASHBOARD (VERSION FIRESTORE TEMPS R√âEL) -----------
async function renderAdminDashboard(user) {
  let patients = [];
  let nfcTags = [];
  let activeTab = 'patients';
  
  console.log("üî• Dashboard Admin - Mode Firestore temps r√©el");
  
  // Lancer le debug silencieux pour l'admin
  setTimeout(() => silentDebugCheck(), 3000);
  
  // Initialiser la synchronisation temps r√©el
  await initRealtimeSync();
  
  // Charger les donn√©es initiales depuis Firestore
  try {
    patients = await loadPatientsFromFirestore();
    
    // D√©finir les variables globales pour les fonctions NFC
    globalPatients = patients;
    window.nfcTags = nfcTags; // Accessible globalement
    
    // Migration automatique : v√©rifier s'il y a des utilisateurs patients non migr√©s
    if (patients.length === 0) {
      console.log("üîÑ Aucun patient trouv√©, v√©rification des utilisateurs √† migrer...");
      await autoMigrateUsersToPatients();
      // Recharger apr√®s migration
      patients = await loadPatientsFromFirestore();
      globalPatients = patients; // Mettre √† jour la variable globale
    }
    
    // Charger les tags NFC depuis Firestore
    const nfcSnapshot = await db.collection('nfcTags').get();
    nfcTags = [];
    nfcSnapshot.forEach(doc => {
      nfcTags.push({
        id: doc.id,
        ...doc.data()
      });
    });
    
    // Mettre √† jour la variable globale NFC
    window.nfcTags = nfcTags;
    
  } catch (error) {
    console.error("‚ùå Erreur chargement donn√©es admin:", error);
    patients = [];
    nfcTags = [];
  }
  
  // √âcouter les mises √† jour temps r√©el
  window.addEventListener('patientsUpdated', (event) => {
    patients = event.detail;
    console.log("üîÑ Patients mis √† jour en temps r√©el:", patients.length);
    render(); // Re-render l'interface
  });
  
  render();

  function render() {
    document.getElementById('app').innerHTML = `
    <div class="min-h-screen bg-gray-50">
      <!-- Header admin responsive -->
      <header class="bg-white shadow-sm border-b sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center h-16">
          <div class="flex items-center">
            <div class="text-2xl mr-3">‚öôÔ∏è</div>
            <h1 class="text-xl font-bold text-gray-900">SYL Admin</h1>
          </div>
          <div class="flex items-center space-x-4">
            <div class="flex items-center space-x-2">
              <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
              <span class="text-sm text-green-600 font-medium hidden sm:block">Temps r√©el</span>
            </div>
            <div class="text-sm text-gray-600 hidden md:block">Admin: ${user.profile.firstName}</div>
            <button id="logoutBtn" class="border-2 border-purple-600 text-purple-600 hover:bg-purple-50 font-medium rounded-lg px-3 py-1 sm:px-4 sm:py-2 flex items-center gap-2 text-sm">
              üö™ <span class="hidden sm:inline">D√©connexion</span>
            </button>
          </div>
        </div>
      </header>
      
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 sm:py-8">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 lg:gap-8">
          <!-- Navigation desktop sidebar -->
          <div class="lg:col-span-1">
            <nav class="space-y-2 bg-white rounded-xl shadow-lg border border-gray-200 p-4">
              <button class="w-full flex items-center px-4 py-3 text-left rounded-lg transition-colors ${activeTab==='patients' ? 'bg-purple-100 text-purple-700 border-l-4 border-purple-600':'text-gray-600 hover:bg-gray-100'}" data-tab="patients">
                üë•<span class="ml-3">Patients</span>
              </button>
              <button class="w-full flex items-center px-4 py-3 text-left rounded-lg transition-colors ${activeTab==='nfc' ? 'bg-purple-100 text-purple-700 border-l-4 border-purple-600':'text-gray-600 hover:bg-gray-100'}" data-tab="nfc">
                üì±<span class="ml-3">Tags NFC</span>
              </button>
              <button class="w-full flex items-center px-4 py-3 text-left rounded-lg transition-colors ${activeTab==='associations' ? 'bg-purple-100 text-purple-700 border-l-4 border-purple-600':'text-gray-600 hover:bg-gray-100'}" data-tab="associations">
                üîó<span class="ml-3">Associations</span>
              </button>
              <button class="w-full flex items-center px-4 py-3 text-left rounded-lg transition-colors ${activeTab==='analytics' ? 'bg-purple-100 text-purple-700 border-l-4 border-purple-600':'text-gray-600 hover:bg-gray-100'}" data-tab="analytics">
                üìä<span class="ml-3">Analytics</span>
              </button>
              <button class="w-full flex items-center px-4 py-3 text-left rounded-lg transition-colors ${activeTab==='debug' ? 'bg-purple-100 text-purple-700 border-l-4 border-purple-600':'text-gray-600 hover:bg-gray-100'}" data-tab="debug">
                üîß<span class="ml-3">Debug</span>
              </button>
            </nav>
          </div>
          
          <!-- Contenu principal -->
          <div class="lg:col-span-3">
            <!-- Navigation mobile tabs (visible uniquement sur mobile) -->
            <div class="lg:hidden mb-4">
              <div class="flex space-x-1 bg-white rounded-xl shadow-lg border border-gray-200 p-1">
                <button class="flex-1 text-center py-2 px-3 rounded-lg text-sm font-medium transition-colors ${activeTab==='patients' ? 'bg-purple-600 text-white':'text-gray-600 hover:bg-gray-100'}" data-tab="patients">
                  üë•
                </button>
                <button class="flex-1 text-center py-2 px-3 rounded-lg text-sm font-medium transition-colors ${activeTab==='nfc' ? 'bg-purple-600 text-white':'text-gray-600 hover:bg-gray-100'}" data-tab="nfc">
                  üì±
                </button>
                <button class="flex-1 text-center py-2 px-3 rounded-lg text-sm font-medium transition-colors ${activeTab==='associations' ? 'bg-purple-600 text-white':'text-gray-600 hover:bg-gray-100'}" data-tab="associations">
                  üîó
                </button>
                <button class="flex-1 text-center py-2 px-3 rounded-lg text-sm font-medium transition-colors ${activeTab==='analytics' ? 'bg-purple-600 text-white':'text-gray-600 hover:bg-gray-100'}" data-tab="analytics">
                  üìä
                </button>
                <button class="flex-1 text-center py-2 px-3 rounded-lg text-sm font-medium transition-colors ${activeTab==='debug' ? 'bg-purple-600 text-white':'text-gray-600 hover:bg-gray-100'}" data-tab="debug">
                  üîß
                </button>
              </div>
            </div>
            
            <!-- Contenu des onglets -->
            <div class="bg-white rounded-xl shadow-lg border border-gray-200 min-h-96">
              ${activeTab === 'patients' ? renderPatientsTab() : ''}
              ${activeTab === 'nfc' ? renderNFCTab() : ''}
              ${activeTab === 'associations' ? renderAssociationsTab() : ''}
              ${activeTab === 'analytics' ? renderAnalyticsTab() : ''}
              ${activeTab === 'debug' ? renderDebugTab() : ''}
            </div>
          </div>
        </div>
      </div>
    </div>
    `;
    
    document.getElementById('logoutBtn').onclick = () => { logout(); };
    
    // Gestion navigation mobile et desktop
    document.querySelectorAll('[data-tab]').forEach(btn => {
      btn.onclick = () => { 
        activeTab = btn.getAttribute('data-tab'); 
        render(); 
      };
    });
    
    // Gestion sp√©cifique mobile pour les swipe gestures
    if (window.innerWidth <= 768) {
      let startX, currentX;
      const adminNav = document.querySelector('.admin-nav-mobile');
      
      adminNav.addEventListener('touchstart', (e) => {
        startX = e.touches[0].clientX;
      }, {passive: true});
      
      adminNav.addEventListener('touchmove', (e) => {
        currentX = e.touches[0].clientX;
      }, {passive: true});
      
      adminNav.addEventListener('touchend', () => {
        const diffX = startX - currentX;
        if (Math.abs(diffX) > 50) {
          // Swipe horizontal pour changer d'onglet
          const tabs = ['patients', 'nfc', 'associations', 'analytics', 'debug'];
          const currentIndex = tabs.indexOf(activeTab);
          
          if (diffX > 0 && currentIndex < tabs.length - 1) {
            // Swipe gauche = onglet suivant
            activeTab = tabs[currentIndex + 1];
            render();
          } else if (diffX < 0 && currentIndex > 0) {
            // Swipe droite = onglet pr√©c√©dent
            activeTab = tabs[currentIndex - 1];
            render();
          }
        }
      }, {passive: true});
    }
    
    if (activeTab === 'patients') setupPatientsEvents();
    if (activeTab === 'nfc') setupNFCEvents();
    if (activeTab === 'associations') setupAssociationsEvents();
    if (activeTab === 'debug') setupDebugEvents();
  }

  function renderPatientsTab() {
    return `
      <div class="admin-section">
        <!-- Header section mobile -->
        <div class="section-header">
          <h2 class="section-title">Gestion des Patients</h2>
          <div class="section-actions">
            <button onclick="deleteAllPatients()" class="btn-danger mobile-action" title="Supprimer tous">
              <span class="btn-icon">üóëÔ∏è</span>
              <span class="btn-text">Suppr. Tout</span>
            </button>
            <button id="refreshPatients" class="btn-primary mobile-action">
              <span class="btn-icon">üîÑ</span>
              <span class="btn-text">Actualiser</span>
            </button>
          </div>
        </div>

        <!-- Recherche mobile -->
        <div class="search-container">
          <div class="search-input-wrapper">
            <input type="text" id="searchPatient" placeholder="Rechercher par nom, email..." class="search-input">
            <button id="searchBtn" class="search-btn">üîç</button>
          </div>
        </div>

        <!-- Aide admin mobile -->
        <div class="info-card">
          <div class="info-header">
            <span class="info-icon">‚ö†Ô∏è</span>
            <h4 class="info-title">Gestion Administrative</h4>
          </div>
          <div class="info-content">
            <p><strong>üóëÔ∏è Suppression:</strong> Clic sur l'ic√¥ne rouge</p>
            <p><strong>üö® Suppr. Masse:</strong> Bouton "SUPPR. TOUT" - Irr√©versible!</p>
            <p><strong>üîß Debug Auth:</strong> Si probl√®me inscription</p>
          </div>
        </div>

        <!-- Liste patients mobile-first -->
        <div class="content-card">
          <h3 class="card-title">Liste des Patients (${patients.length})</h3>
          ${patients.length === 0 ? `
            <div class="empty-state">
              <div class="empty-icon">üë•</div>
              <h4 class="empty-title">Aucun patient trouv√©</h4>
              <p class="empty-description">Cliquez sur "Actualiser" pour charger les patients depuis Firebase.</p>
              <div class="help-card">
                <h5 class="help-title">Pour r√©soudre les erreurs :</h5>
                <ol class="help-list">
                  <li>V√©rifiez la connexion admin</li>
                  <li>Configurez les r√®gles Firestore</li>
                  <li>Assurez-vous que des patients existent</li>
                </ol>
              </div>
            </div>
          ` : `
          <!-- Mobile Cards View -->
          <div class="mobile-cards">
            ${patients.map(patient => `
              <div class="patient-card">
                <div class="patient-header">
                  <div class="patient-info">
                    <div class="patient-name">${patient.personalInfo?.firstName || 'N/A'} ${patient.personalInfo?.lastName || 'N/A'}</div>
                    <div class="patient-email">${patient.email || 'N/A'}</div>
                  </div>
                  <div class="patient-status">
                    ${patient.isActive ? '<span class="status-active">Actif</span>' : '<span class="status-inactive">Inactif</span>'}
                  </div>
                </div>
                
                <div class="patient-details">
                  <div class="detail-item">
                    <span class="detail-label">ID:</span>
                    <span class="detail-value">${patient.id || patient.uid || 'N/A'}</span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">Groupe sang.:</span>
                    <span class="detail-value blood-type">${patient.personalInfo?.bloodType || 'N/A'}</span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">Tag NFC:</span>
                    <span class="detail-value">${patient.nfcTagId ? `üè∑Ô∏è ${patient.nfcTagId}` : '‚ùå Non assign√©'}</span>
                  </div>
                </div>
                
                <div class="patient-actions">
                  <button onclick="viewPatient('${patient.id || patient.uid}')" class="action-btn view-btn" title="Voir">
                    üëÅÔ∏è
                  </button>
                  <button onclick="assignNFC('${patient.id || patient.uid}')" class="action-btn nfc-btn" title="NFC">
                    üì±
                  </button>
                  <button onclick="deletePatient('${patient.id || patient.uid}', '${patient.personalInfo?.firstName || ''} ${patient.personalInfo?.lastName || ''}')" class="action-btn delete-btn" title="Supprimer">
                    üóëÔ∏è
                  </button>
                </div>
              </div>
            `).join('')}
          </div>
          
          <!-- Desktop Table View (hidden on mobile) -->
          <div class="desktop-table">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Patient</th>
                  <th>Email</th>
                  <th>Groupe Sang.</th>
                  <th>Tag NFC</th>
                  <th>Statut</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${patients.map(patient => `
                  <tr>
                    <td>
                      <div class="table-patient-info">
                        <div class="patient-name">${patient.personalInfo?.firstName || 'N/A'} ${patient.personalInfo?.lastName || 'N/A'}</div>
                        <div class="patient-id">ID: ${patient.id || patient.uid || 'N/A'}</div>
                      </div>
                    </td>
                    <td>${patient.email || 'N/A'}</td>
                    <td><span class="blood-type-badge">${patient.personalInfo?.bloodType || 'N/A'}</span></td>
                    <td>
                      ${patient.nfcTagId ? `<span class="nfc-badge">${patient.nfcTagId}</span>` : '<span class="no-nfc">Non assign√©</span>'}
                    </td>
                    <td>
                      ${patient.isActive ? '<span class="status-active">Actif</span>' : '<span class="status-inactive">Inactif</span>'}
                    </td>
                    <td>
                      <div class="table-actions">
                        <button onclick="viewPatient('${patient.id || patient.uid}')" class="action-btn-small view" title="Voir">${icons.eye}</button>
                        <button onclick="assignNFC('${patient.id || patient.uid}')" class="action-btn-small nfc" title="NFC">${icons.smartphone}</button>
                        <button onclick="deletePatient('${patient.id || patient.uid}', '${patient.personalInfo?.firstName || ''} ${patient.personalInfo?.lastName || ''}')" class="action-btn-small delete" title="Supprimer">${icons.trash}</button>
                      </div>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
          `}
        </div>
      </div>
    `;
  }

  function renderNFCTab() {
    return `
      <div class="admin-section">
        <!-- Header section -->
        <div class="section-header">
          <h2 class="section-title">Gestion des Tags NFC</h2>
          <div class="section-actions">
            <button onclick="refreshNFCList()" class="btn-secondary mobile-action">
              <span class="btn-icon">üîÑ</span>
              <span class="btn-text">Actualiser</span>
            </button>
          </div>
        </div>

        <!-- Workflow NFC am√©lior√© -->
        <div class="content-card">
          <h3 class="card-title">üì± Workflow NFC Patient</h3>
          
          <!-- √âtapes visuelles du workflow -->
          <div class="workflow-steps">
            <div class="workflow-step">
              <div class="step-number active">1</div>
              <div class="step-content">
                <h4>Scanner le Tag NFC</h4>
                <p>Scannez ou entrez l'ID du tag physique</p>
              </div>
            </div>
            <div class="workflow-arrow">‚Üí</div>
            <div class="workflow-step">
              <div class="step-number">2</div>
              <div class="step-content">
                <h4>S√©lectionner Patient</h4>
                <p>Choisissez le patient √† associer</p>
              </div>
            </div>
            <div class="workflow-arrow">‚Üí</div>
            <div class="workflow-step">
              <div class="step-number">3</div>
              <div class="step-content">
                <h4>Programmer Tag</h4>
                <p>√âcrire le lien fiche patient sur le tag</p>
              </div>
            </div>
          </div>

          <!-- √âtape 1: Scanner Tag -->
          <div class="workflow-section" id="step1">
            <h4 class="workflow-title">
              <span class="workflow-icon">üì±</span>
              √âtape 1: Scanner le Tag NFC
            </h4>
            <div class="input-group">
              <label for="nfcTagId" class="input-label">ID du Tag NFC *</label>
              <div class="input-with-button">
                <input type="text" id="nfcTagId" placeholder="Ex: NFC-001, ABC123..." 
                       class="form-input" onchange="checkTagStep()">
                <button id="scanNFCBtn" class="btn-primary" onclick="scanNFCTag()">
                  <span class="btn-icon">üì±</span>
                  Scanner
                </button>
              </div>
            </div>
            <div id="tagScanResult" class="scan-result"></div>
          </div>

          <!-- √âtape 2: S√©lectionner Patient -->
          <div class="workflow-section" id="step2" style="display: none;">
            <h4 class="workflow-title">
              <span class="workflow-icon">üë§</span>
              √âtape 2: S√©lectionner le Patient
            </h4>
            
            <!-- Recherche de patient -->
            <div class="input-group">
              <label class="input-label">Rechercher un patient</label>
              <input type="text" id="patientSearch" placeholder="Nom, pr√©nom, email..." 
                     class="form-input" oninput="searchPatients(this.value)">
            </div>

            <!-- Liste des patients -->
            <div class="patient-selector" id="patientSelector">
              ${patients.map(patient => `
                <div class="patient-option" onclick="selectPatient('${patient.id || patient.uid}')" 
                     data-patient-id="${patient.id || patient.uid}">
                  <div class="patient-option-info">
                    <div class="patient-option-name">
                      ${patient.personalInfo?.firstName || 'N/A'} ${patient.personalInfo?.lastName || 'N/A'}
                    </div>
                    <div class="patient-option-email">${patient.email}</div>
                    <div class="patient-option-details">
                      ${patient.personalInfo?.bloodType ? `ü©∏ ${patient.personalInfo.bloodType}` : ''} 
                      ${patient.nfcTagId ? `üì± ${patient.nfcTagId}` : ''}
                    </div>
                  </div>
                  <div class="patient-option-action">
                    <button class="select-btn">S√©lectionner</button>
                  </div>
                </div>
              `).join('')}
            </div>
            
            <div id="selectedPatientInfo" class="selected-patient"></div>
          </div>

          <!-- √âtape 3: Programmer Tag -->
          <div class="workflow-section" id="step3" style="display: none;">
            <h4 class="workflow-title">
              <span class="workflow-icon">‚úçÔ∏è</span>
              √âtape 3: Programmer le Tag NFC
            </h4>
            
            <div class="programming-info">
              <div class="info-card">
                <h5>üîó Lien qui sera √©crit sur le tag:</h5>
                <div class="generated-link" id="generatedLink"></div>
                <p class="link-description">
                  Ce lien permettra d'acc√©der directement √† la fiche m√©dicale d'urgence du patient
                </p>
              </div>
            </div>

            <div class="programming-actions">
              <button id="writeToNFCBtn" class="btn-success" onclick="writePatientToNFC()">
                <span class="btn-icon">‚úçÔ∏è</span>
                Programmer le Tag NFC
              </button>
              <button class="btn-secondary" onclick="testNFCLink()">
                <span class="btn-icon">üß™</span>
                Tester le Lien
              </button>
            </div>
            
            <div id="programmingResult" class="programming-result"></div>
          </div>
        </div>

        <!-- Liste des associations existantes -->
        <div class="content-card">
          <h3 class="card-title">üìã Tags NFC Programm√©s (${nfcTags.filter(tag => tag.assignedTo).length})</h3>
          
          <div class="nfc-assignments">
            ${nfcTags.filter(tag => tag.assignedTo).map(tag => {
              const patient = patients.find(p => (p.id || p.uid) === tag.assignedTo);
              return `
                <div class="nfc-assignment-card">
                  <div class="assignment-header">
                    <div class="tag-info">
                      <div class="tag-id">üì± ${tag.id}</div>
                      <div class="tag-description">${tag.description || 'Aucune description'}</div>
                    </div>
                    <div class="assignment-status">
                      <span class="status-active">Actif</span>
                    </div>
                  </div>
                  
                  <div class="assignment-patient">
                    <div class="patient-name">
                      üë§ ${patient ? `${patient.personalInfo?.firstName} ${patient.personalInfo?.lastName}` : 'Patient introuvable'}
                    </div>
                    <div class="patient-email">${patient?.email || 'N/A'}</div>
                  </div>
                  
                  <div class="assignment-link">
                    <div class="link-label">üîó Lien d'urgence:</div>
                    <div class="emergency-link">${window.location.origin}/OLDINDEX.html?patient=${tag.assignedTo}&access=medical</div>
                  </div>
                  
                  <div class="assignment-actions">
                    <button onclick="testNFCAssignment('${tag.id}')" class="action-btn test-btn">
                      <span class="btn-icon">üß™</span>
                      Tester
                    </button>
                    <button onclick="reprogramNFC('${tag.id}')" class="action-btn edit-btn">
                      <span class="btn-icon">‚úèÔ∏è</span>
                      Reprogrammer
                    </button>
                    <button onclick="removeNFCAssignment('${tag.id}')" class="action-btn delete-btn">
                      <span class="btn-icon">üóëÔ∏è</span>
                      Dissocier
                    </button>
                  </div>
                  
                  <div class="assignment-meta">
                    <small>Programm√© le: ${new Date(tag.assignedAt || tag.createdAt).toLocaleDateString('fr-FR')}</small>
                  </div>
                </div>
              `;
            }).join('')}
            
            ${nfcTags.filter(tag => tag.assignedTo).length === 0 ? `
              <div class="empty-state">
                <div class="empty-icon">üì±</div>
                <h4 class="empty-title">Aucun tag programm√©</h4>
                <p class="empty-description">Commencez par scanner un tag et s√©lectionner un patient</p>
              </div>
            ` : ''}
          </div>
        </div>
      </div>
    `;
  }

  function renderAssociationsTab() {
    const associations = nfcTags.filter(tag => tag.assignedTo);
    return `
      <div class="space-y-6">
        <h2 class="text-2xl font-bold text-gray-900">Associations Patient-NFC</h2>
        
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Cr√©er une nouvelle association</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <select id="selectPatient" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
              <option value="">S√©lectionner un patient</option>
              ${patients.map(patient => `
                <option value="${patient.id || patient.uid}">${patient.personalInfo?.firstName} ${patient.personalInfo?.lastName} (${patient.email})</option>
              `).join('')}
            </select>
            <select id="selectNFCTag" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
              <option value="">S√©lectionner un Tag NFC</option>
              ${nfcTags.filter(tag => !tag.assignedTo).map(tag => `
                <option value="${tag.id}">${tag.id} ${tag.description ? `(${tag.description})` : ''}</option>
              `).join('')}
            </select>
            <button id="createAssociation" class="bg-purple-600 hover:bg-purple-700 text-white rounded-lg px-4 py-2">${icons.shield} Associer</button>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Associations actives (${associations.length})</h3>
          <div class="space-y-4">
            ${associations.map(tag => {
              const patient = patients.find(p => (p.id || p.uid) === tag.assignedTo);
              return `
                <div class="flex items-center justify-between bg-gradient-to-r from-purple-50 to-blue-50 p-4 rounded-lg border">
                  <div class="flex items-center space-x-4">
                    <div class="w-12 h-12 bg-purple-600 rounded-full flex items-center justify-center text-white font-bold">
                      ${icons.smartphone}
                    </div>
                    <div>
                      <div class="font-medium text-gray-900">Tag: ${tag.id}</div>
                      <div class="text-sm text-gray-600">Patient: ${patient ? `${patient.personalInfo?.firstName} ${patient.personalInfo?.lastName}` : 'Patient non trouv√©'}</div>
                      <div class="text-sm text-blue-600">Associ√© le: ${new Date(tag.assignedAt).toLocaleDateString('fr-FR')}</div>
                    </div>
                  </div>
                  <div class="flex gap-2">
                    <button onclick="testNFC('${tag.id}')" class="bg-blue-600 hover:bg-blue-700 text-white rounded px-3 py-1 text-sm">${icons.activity} Test</button>
                    <button onclick="removeAssociation('${tag.id}')" class="bg-red-600 hover:bg-red-700 text-white rounded px-3 py-1 text-sm">${icons.trash} Dissocier</button>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      </div>
    `;
  }

  function renderAnalyticsTab() {
    const analytics = JSON.parse(localStorage.getItem('syl-analytics') || '[]');
    const totalPatients = patients.length;
    const activePatients = patients.filter(p => p.isActive).length;
    const totalNFCTags = nfcTags.length;
    const assignedTags = nfcTags.filter(tag => tag.assignedTo).length;
    
    return `
      <div class="space-y-6">
        <h2 class="text-2xl font-bold text-gray-900">Tableau de bord Analytics</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
            <div class="flex items-center">
              <div class="w-12 h-12 bg-blue-600 rounded-lg flex items-center justify-center text-white">
                ${icons.users}
              </div>
              <div class="ml-4">
                <div class="text-2xl font-bold text-gray-900">${totalPatients}</div>
                <div class="text-sm text-gray-600">Total Patients</div>
              </div>
            </div>
          </div>
          
          <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
            <div class="flex items-center">
              <div class="w-12 h-12 bg-green-600 rounded-lg flex items-center justify-center text-white">
                ${icons.check}
              </div>
              <div class="ml-4">
                <div class="text-2xl font-bold text-gray-900">${activePatients}</div>
                <div class="text-sm text-gray-600">Patients Actifs</div>
              </div>
            </div>
          </div>
          
          <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
            <div class="flex items-center">
              <div class="w-12 h-12 bg-purple-600 rounded-lg flex items-center justify-center text-white">
                ${icons.smartphone}
              </div>
              <div class="ml-4">
                <div class="text-2xl font-bold text-gray-900">${totalNFCTags}</div>
                <div class="text-sm text-gray-600">Tags NFC</div>
              </div>
            </div>
          </div>
          
          <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
            <div class="flex items-center">
              <div class="w-12 h-12 bg-orange-600 rounded-lg flex items-center justify-center text-white">
                ${icons.shield}
              </div>
              <div class="ml-4">
                <div class="text-2xl font-bold text-gray-900">${assignedTags}</div>
                <div class="text-sm text-gray-600">Tags Assign√©s</div>
              </div>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">√âv√©nements r√©cents</h3>
          <div class="space-y-3">
            ${analytics.slice(-10).reverse().map(event => `
              <div class="flex items-center justify-between py-2 border-b border-gray-100">
                <div>
                  <div class="font-medium text-gray-900">${event.name}</div>
                  <div class="text-sm text-gray-600">${new Date(event.timestamp).toLocaleString('fr-FR')}</div>
                </div>
                <div class="text-sm text-gray-500">${event.sessionId}</div>
              </div>
            `).join('')}
          </div>
        </div>
      </div>
    `;
  }

  function renderDebugTab() {
    return `
      <div class="space-y-6">
        <div class="flex justify-between items-center">
          <h2 class="text-2xl font-bold text-gray-900">Debug & Maintenance</h2>
          <div class="flex gap-2">
            <button id="runQuickDiag" class="bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg px-4 py-2 flex items-center gap-2">
              üè• Diagnostic Rapide
            </button>
          </div>
        </div>

        <!-- Diagnostic System -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">üîç Analyse des Collections Firebase</h3>
          
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <button id="analyzeCollections" class="bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-lg px-4 py-3 flex items-center justify-center gap-2">
              üìä Analyser Collections
            </button>
            
            <button id="cleanupData" class="bg-orange-600 hover:bg-orange-700 text-white font-medium rounded-lg px-4 py-3 flex items-center justify-center gap-2">
              üßπ Nettoyer (Test)
            </button>
            
            <button id="migrateSchema" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-lg px-4 py-3 flex items-center justify-center gap-2">
              üöÄ Migrer Sch√©ma
            </button>
          </div>

          <div id="debugOutput" class="bg-gray-50 border border-gray-200 rounded-lg p-4 h-64 overflow-y-auto font-mono text-sm">
            <div class="text-gray-500">üîß Debug SYL Medical - Console active</div>
            <div class="text-blue-600">üìù Cliquez sur les boutons ci-dessus pour analyser vos donn√©es</div>
            <div class="text-purple-600">üìä ${patients.length} patients d√©tect√©s</div>
          </div>
        </div>

        <!-- Status Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
            <div class="flex items-center mb-4">
              <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">üî•</div>
              <div class="ml-4">
                <h4 class="text-lg font-semibold text-gray-900">Firebase</h4>
                <p class="text-sm text-gray-600">√âtat connexion</p>
              </div>
            </div>
            <div class="text-green-600 font-medium">‚úÖ Connect√©</div>
          </div>

          <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
            <div class="flex items-center mb-4">
              <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">üìä</div>
              <div class="ml-4">
                <h4 class="text-lg font-semibold text-gray-900">Collections</h4>
                <p class="text-sm text-gray-600">Documents</p>
              </div>
            </div>
            <div class="text-blue-600 font-medium">${patients.length} patients</div>
          </div>

          <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
            <div class="flex items-center mb-4">
              <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">üíæ</div>
              <div class="ml-4">
                <h4 class="text-lg font-semibold text-gray-900">Cache</h4>
                <p class="text-sm text-gray-600">Local</p>
              </div>
            </div>
            <div class="text-green-600 font-medium">‚úÖ Actif</div>
          </div>
        </div>

        <!-- Console Commands -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">üõ†Ô∏è Commandes Console Disponibles</h3>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
            <div class="bg-gray-50 rounded-lg p-3 cursor-pointer hover:bg-gray-100" onclick="window.debugFirebaseCollections?.();">
              <code class="text-purple-600 font-bold">debugFirebaseCollections()</code>
              <p class="text-gray-600 mt-1">Analyse compl√®te des collections</p>
            </div>
            
            <div class="bg-gray-50 rounded-lg p-3 cursor-pointer hover:bg-gray-100" onclick="window.cleanupFirebaseData?.();">
              <code class="text-purple-600 font-bold">cleanupFirebaseData()</code>
              <p class="text-gray-600 mt-1">Nettoie et normalise les donn√©es</p>
            </div>
            
            <div class="bg-gray-50 rounded-lg p-3 cursor-pointer hover:bg-gray-100" onclick="window.migrateToStandardSchema?.();">
              <code class="text-purple-600 font-bold">migrateToStandardSchema()</code>
              <p class="text-gray-600 mt-1">Migration vers sch√©ma standard</p>
            </div>
            
            <div class="bg-gray-50 rounded-lg p-3 cursor-pointer hover:bg-gray-100" onclick="window.quickDiagnosis?.();">
              <code class="text-purple-600 font-bold">quickDiagnosis()</code>
              <p class="text-gray-600 mt-1">Diagnostic rapide du syst√®me</p>
            </div>
          </div>
          
          <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
            <p class="text-blue-700 text-sm">üí° <strong>Astuce :</strong> Ouvrez la console d√©veloppeur (F12) pour voir les r√©sultats d√©taill√©s</p>
          </div>
        </div>
      </div>
    `;
  }

  function setupPatientsEvents() {
    document.getElementById('refreshPatients')?.addEventListener('click', async () => {
      // D√©tection mobile pour synchronisation forc√©e
      const isMobile = window.innerWidth <= 768 || /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      
      if (isMobile && confirm('üì± Mobile d√©tect√©. Faire une synchronisation forc√©e (recommand√©) ?')) {
        window.forceMobileSync();
        return;
      }
      
      // Recharger les patients depuis Firebase (mode normal)
      try {
        if (db && typeof db.collection === 'function') {
          console.log('Chargement des utilisateurs depuis Firebase...');
          
          // R√©cup√©rer tous les utilisateurs avec le r√¥le 'patient'
          const usersSnapshot = await db.collection('users').where('role', '==', 'patient').get();
          const firebaseUsers = [];
          
          usersSnapshot.forEach(doc => {
            const userData = doc.data();
            firebaseUsers.push({
              id: doc.id,
              uid: userData.uid || doc.id,
              email: userData.email,
              role: userData.role,
              ...userData
            });
          });
          
          console.log('Utilisateurs trouv√©s:', firebaseUsers.length);
          
          // R√©cup√©rer aussi les donn√©es m√©dicales associ√©es
          const patientsSnapshot = await db.collection('patients').get();
          const medicalDataMap = {};
          
          patientsSnapshot.forEach(doc => {
            const data = doc.data();
            const userId = doc.id.replace('_medical', '');
            medicalDataMap[userId] = data;
          });
          
          console.log('Donn√©es m√©dicales trouv√©es:', Object.keys(medicalDataMap).length);
          
          // Fusionner les donn√©es utilisateur et m√©dicales
          const completePatients = firebaseUsers.map(user => {
            const medicalData = medicalDataMap[user.uid] || {};
            return {
              ...user,
              personalInfo: medicalData.personalInfo || {
                firstName: user.profile?.firstName || 'Pr√©nom',
                lastName: user.profile?.lastName || 'Nom',
                bloodType: 'N/A'
              },
              medicalHistory: medicalData.medicalHistory || {
                allergies: [],
                medications: [],
                chronicDiseases: []
              },
              emergencyInfo: medicalData.emergencyInfo || {
                criticalNotes: ''
              },
              isActive: medicalData.isActive !== undefined ? medicalData.isActive : true,
              nfcTagId: medicalData.nfcTagId || null,
              createdAt: user.createdAt || new Date().toISOString()
            };
          });
          
          if (completePatients.length > 0) {
            patients = completePatients;
            localStorage.setItem('syl-patients', JSON.stringify(patients));
            render();
            alert(`‚úÖ ${patients.length} patients charg√©s depuis Firebase !`);
            return;
          } else {
            alert('‚ÑπÔ∏è Aucun patient trouv√© dans Firebase.');
          }
        }
        
      } catch (error) {
        console.error('Erreur refresh patients:', error);
        alert('‚ùå Erreur Firebase: ' + error.message);
      }
    });

    document.getElementById('syncEmergencyData')?.addEventListener('click', async () => {
      // D'abord, v√©rifier Firebase
      if (typeof firebase === 'undefined' || !firebase.firestore) {
        alert('‚ùå Firebase n\'est pas configur√© !\n\nPour utiliser la synchronisation d\'urgence :\n1. Configurez Firebase dans votre projet\n2. Ajoutez les scripts Firebase\n3. Initialisez la connexion');
        return;
      }
      
      // V√©rifier l'authentification (admin local OU Firebase)
      const currentUser = firebase.auth().currentUser;
      const localUser = getUser();
      
      if (!currentUser && (!localUser || localUser.role !== 'admin')) {
        alert('‚ùå Vous devez √™tre connect√© pour synchroniser !\n\nConnectez-vous d\'abord avec un compte admin.');
        return;
      }
      
      if (!confirm('Synchroniser toutes les donn√©es d\'urgence vers Firebase ?\n\nCela permettra l\'acc√®s d\'urgence depuis tous les appareils.')) {
        return;
      }
      
      // Afficher un indicateur de progression
      const syncModal = document.createElement('div');
      syncModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      syncModal.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-md mx-4 text-center">
          <div class="w-16 h-16 bg-orange-600 rounded-full mx-auto flex items-center justify-center text-white text-2xl mb-4 animate-pulse">
            üîÑ
          </div>
          <h3 class="text-lg font-bold text-gray-900 mb-2">Synchronisation en cours...</h3>
          <p class="text-gray-600 mb-4">Sauvegarde des donn√©es d'urgence dans Firebase</p>
          <div class="bg-gray-200 rounded-full h-2 mb-4">
            <div id="syncProgress" class="bg-orange-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
          </div>
          <p id="syncStatus" class="text-sm text-gray-500">0 / ${patients.length} patients</p>
          <div class="mt-4 text-xs text-gray-500">
            Utilisateur: ${firebase.auth().currentUser?.email || 'Anonyme'}
          </div>
        </div>
      `;
      document.body.appendChild(syncModal);
      
      let syncCount = 0;
      let errorCount = 0;
      
      for (let i = 0; i < patients.length; i++) {
        const patient = patients[i];
        try {
          await saveEmergencyData(patient);
          syncCount++;
          console.log(`‚úÖ Patient ${patient.personalInfo?.firstName} ${patient.personalInfo?.lastName} synchronis√©`);
        } catch (error) {
          errorCount++;
          console.error('‚ùå Erreur sync patient:', patient.id, error);
        }
        
        // Mettre √† jour la progress bar
        const progress = ((i + 1) / patients.length) * 100;
        document.getElementById('syncProgress').style.width = progress + '%';
        document.getElementById('syncStatus').textContent = `${syncCount} / ${patients.length} patients synchronis√©s`;
        
        // Petit d√©lai pour √©viter de surcharger Firebase
        await new Promise(resolve => setTimeout(resolve, 200));
      }
      
      // Fermer le modal et afficher le r√©sultat
      syncModal.remove();
      
      if (errorCount === 0) {
        alert(`‚úÖ ${syncCount} patients synchronis√©s avec succ√®s !\n\nLes fiches sont maintenant accessibles depuis n'importe quel appareil.`);
      } else {
        alert(`‚ö†Ô∏è Synchronisation termin√©e :\n‚Ä¢ ${syncCount} patients synchronis√©s\n‚Ä¢ ${errorCount} erreurs\n\nV√©rifiez la console pour plus de d√©tails.`);
      }
    });

    document.getElementById('testFirebaseAccess')?.addEventListener('click', async () => {
      const testModal = document.createElement('div');
      testModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      testModal.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-2xl mx-4">
          <h3 class="text-lg font-bold text-gray-900 mb-4">üîß Test de connectivit√© Firebase</h3>
          <div id="testResults" class="space-y-3">
            <div class="flex items-center">
              <div class="animate-spin w-4 h-4 border-2 border-blue-600 border-t-transparent rounded-full mr-3"></div>
              <span>Test en cours...</span>
            </div>
          </div>
          <button onclick="this.closest('.fixed').remove()" class="mt-4 w-full bg-gray-500 hover:bg-gray-600 text-white rounded px-4 py-2">Fermer</button>
        </div>
      `;
      document.body.appendChild(testModal);
      
      const results = document.getElementById('testResults');
      results.innerHTML = '';
      
      // Test 1: Firebase disponible
      const addResult = (icon, text, isGood = true) => {
        results.innerHTML += `
          <div class="flex items-center ${isGood ? 'text-green-600' : 'text-red-600'}">
            <span class="mr-3">${icon}</span>
            <span>${text}</span>
          </div>
        `;
      };
      
      if (typeof firebase === 'undefined') {
        addResult('‚ùå', 'Firebase SDK non charg√©', false);
        return;
      }
      addResult('‚úÖ', 'Firebase SDK charg√©');
      
      if (!firebase.firestore) {
        addResult('‚ùå', 'Firestore non initialis√©', false);
        return;
      }
      addResult('‚úÖ', 'Firestore disponible');
      
      // Test 2: Authentification
      const currentUser = firebase.auth().currentUser;
      if (!currentUser) {
        addResult('‚ùå', 'Aucun utilisateur connect√©', false);
        return;
      }
      addResult('‚úÖ', `Utilisateur connect√©: ${currentUser.email}`);
      
      // Test 3: Acc√®s aux collections
      const db = firebase.firestore();
      try {
        const testRead = await db.collection('users').limit(1).get();
        addResult('‚úÖ', `Collection 'users' accessible (${testRead.size} document(s))`);
      } catch (error) {
        addResult('‚ùå', `Erreur collection 'users': ${error.message}`, false);
      }
      
      try {
        const testEmergency = await db.collection('emergency_access').limit(1).get();
        addResult('‚úÖ', `Collection 'emergency_access' accessible (${testEmergency.size} document(s))`);
      } catch (error) {
        addResult('‚ùå', `Erreur collection 'emergency_access': ${error.message}`, false);
      }
      
      // Test 4: Donn√©es patients locales
      const localPatients = JSON.parse(localStorage.getItem('syl-patients') || '[]');
      addResult('‚ÑπÔ∏è', `${localPatients.length} patients en local`);
      
      if (localPatients.length > 0) {
        const samplePatient = localPatients[0];
        addResult('‚ÑπÔ∏è', `Exemple: ${samplePatient.personalInfo?.firstName || 'N/A'} ${samplePatient.personalInfo?.lastName || 'N/A'}`);
      }
    });

    document.getElementById('clearAllData')?.addEventListener('click', () => {
      if (confirm('√ätes-vous s√ªr de vouloir vider le cache local ? Cette action supprimera tous les patients et tags NFC en local. Vous devrez recharger depuis Firebase.')) {
        localStorage.removeItem('syl-patients');
        localStorage.removeItem('syl-nfc-tags');
        localStorage.removeItem('syl-medicalData');
        localStorage.removeItem('syl-analytics');
        localStorage.removeItem('syl-reminders');
        alert('Cache vid√© ! Rechargement de la page...');
        location.reload();
      }
    });

    document.getElementById('searchPatient')?.addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      const filteredPatients = patients.filter(patient => 
        (patient.personalInfo?.firstName?.toLowerCase().includes(searchTerm)) ||
        (patient.personalInfo?.lastName?.toLowerCase().includes(searchTerm)) ||
        (patient.email?.toLowerCase().includes(searchTerm)) ||
        (patient.id?.toLowerCase().includes(searchTerm))
      );
      // Re-render la table avec les patients filtr√©s
      // TODO: Impl√©menter le filtrage en temps r√©el
    });

    // Event listener pour le bouton de synchronisation mobile
    document.getElementById('forceMobileSyncBtn')?.addEventListener('click', () => {
      if (confirm('üîÑ Synchronisation forc√©e mobile ?\n\nCela va :\n‚Ä¢ Nettoyer tout le cache\n‚Ä¢ Recharger les donn√©es depuis Firebase\n‚Ä¢ Peut prendre quelques secondes')) {
        window.forceMobileSync();
      }
    });
  }

  // Fonction pour afficher le contenu d√©taill√© d'un tag NFC
  function showNFCContentModal(tagId, serialNumber, tagData) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
      <div class="bg-white rounded-lg p-6 max-w-lg mx-4 max-h-96 overflow-y-auto">
        <h3 class="text-lg font-bold text-gray-900 mb-4">üì± Contenu du tag NFC</h3>
        
        <div class="space-y-4">
          <!-- ID du tag -->
          <div class="bg-blue-50 border border-blue-200 rounded p-3">
            <h4 class="font-medium text-blue-800 mb-1">ID du tag</h4>
            <code class="text-sm font-mono text-blue-900">${tagId}</code>
          </div>
          
          <!-- Num√©ro de s√©rie -->
          ${serialNumber ? `
            <div class="bg-gray-50 border border-gray-200 rounded p-3">
              <h4 class="font-medium text-gray-800 mb-1">Num√©ro de s√©rie</h4>
              <code class="text-sm font-mono text-gray-700">${serialNumber}</code>
            </div>
          ` : ''}
          
          <!-- Donn√©es du tag -->
          <div class="bg-green-50 border border-green-200 rounded p-3">
            <h4 class="font-medium text-green-800 mb-2">Contenu (${tagData.length} enregistrement${tagData.length > 1 ? 's' : ''})</h4>
            ${tagData.length > 0 ? tagData.map((data, index) => `
              <div class="mb-3 pb-3 ${index < tagData.length - 1 ? 'border-b border-green-200' : ''}">
                <div class="flex justify-between items-center mb-1">
                  <span class="text-xs font-medium text-green-700 bg-green-100 px-2 py-1 rounded">
                    ${data.type}${data.mediaType !== 'N/A' ? ` (${data.mediaType})` : ''}
                  </span>
                  <span class="text-xs text-gray-500">${data.size} bytes</span>
                </div>
                <div class="text-sm text-gray-700 break-all">
                  ${data.content.length > 200 ? data.content.substring(0, 200) + '...' : data.content}
                </div>
              </div>
            `).join('') : '<p class="text-sm text-gray-600">Tag vide</p>'}
          </div>
        </div>
        
        <div class="flex gap-2 mt-6">
          <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white rounded px-4 py-2">
            Fermer
          </button>
          <button onclick="navigator.clipboard.writeText('${tagId}').then(() => alert('ID copi√© !')); this.closest('.fixed').remove();" class="bg-gray-500 hover:bg-gray-600 text-white rounded px-4 py-2">
            Copier ID
          </button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  }

  function setupNFCEvents() {
    document.getElementById('scanNFC')?.addEventListener('click', async () => {
      try {
        // V√©rifier le support NFC
        if (!('NDEFReader' in window)) {
          // Fallback avec simulation
          showNFCSimulationModal();
          return;
        }

        // V√©rifier les permissions
        const permission = await navigator.permissions.query({ name: 'nfc' });
        if (permission.state === 'denied') {
          throw new Error('Permissions NFC refus√©es. Activez le NFC dans les param√®tres du navigateur.');
        }

        // V√©rifier HTTPS
        if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
          throw new Error('NFC n√©cessite HTTPS. Utilisez un serveur HTTPS ou localhost.');
        }

        // D√©marrer le scan NFC
        let ndef;
        try {
          ndef = new NDEFReader();
        } catch (constructorError) {
          console.error('Erreur constructor NDEFReader:', constructorError);
          throw new Error('Impossible d\'initialiser le lecteur NFC. V√©rifiez que le NFC est activ√© et que vous utilisez un navigateur compatible.');
        }
        
        // Afficher un modal de scan en cours
        const scanModal = document.createElement('div');
        scanModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        scanModal.innerHTML = `
          <div class="bg-white rounded-lg p-6 max-w-md mx-4 text-center">
            <div class="animate-pulse mb-4">
              <div class="w-16 h-16 bg-blue-600 rounded-full mx-auto flex items-center justify-center text-white text-2xl">
                üì±
              </div>
            </div>
            <h3 class="text-lg font-bold text-gray-900 mb-2">Scan NFC en cours...</h3>
            <p class="text-gray-600 mb-4">Approchez votre tag NFC du t√©l√©phone</p>
            <button id="cancelNFCScan" class="bg-gray-500 hover:bg-gray-600 text-white rounded px-4 py-2">Annuler</button>
          </div>
        `;
        document.body.appendChild(scanModal);

        // G√©rer l'annulation
        document.getElementById('cancelNFCScan').onclick = () => {
          scanModal.remove();
        };

        // D√©marrer le scan
        await ndef.scan();
        console.log('üì° Scan NFC d√©marr√©');

        // √âcouter la d√©tection
        ndef.addEventListener('reading', ({ message, serialNumber }) => {
          scanModal.remove();
          
          let tagId = '';
          let tagContent = '';
          let tagData = [];
          
          // Analyser les donn√©es du tag
          if (message.records.length > 0) {
            message.records.forEach((record, index) => {
              const decoder = new TextDecoder();
              let content = '';
              
              if (record.recordType === 'text') {
                content = decoder.decode(record.data);
                tagContent = content;
                tagId = content;
              } else if (record.recordType === 'url') {
                content = decoder.decode(record.data);
                tagContent = content;
                // Extraire l'ID depuis l'URL si possible
                const urlMatch = content.match(/[?&](nfc|patient|tag)=([^&]+)/);
                if (urlMatch) {
                  tagId = urlMatch[2];
                } else {
                  tagId = 'URL_' + Date.now();
                }
              } else if (record.recordType === 'mime') {
                content = decoder.decode(record.data);
                tagContent = content;
              } else {
                content = 'Donn√©es binaires (' + record.data.byteLength + ' bytes)';
              }
              
              tagData.push({
                type: record.recordType,
                mediaType: record.mediaType || 'N/A',
                content: content,
                size: record.data.byteLength
              });
            });
          } else {
            tagContent = 'Tag vide';
            tagId = serialNumber || 'NFC_' + Date.now();
          }

          // Formater l'ID si n√©cessaire
          if (!tagId.startsWith('NFC_') && !tagId.startsWith('SYL_')) {
            tagId = 'NFC_' + tagId;
          }

          // Mettre √† jour le champ seulement s'il existe (interface admin)
          const nfcTagIdField = document.getElementById('nfcTagId');
          if (nfcTagIdField) {
            nfcTagIdField.value = tagId;
          }
          
          // Afficher les d√©tails du contenu du tag
          showNFCContentModal(tagId, serialNumber, tagData);
        });

        // Timeout pour le scan
        setTimeout(() => {
          if (document.body.contains(scanModal)) {
            scanModal.remove();
            alert('‚è∞ Timeout du scan NFC. R√©essayez.');
          }
        }, 30000); // 30 secondes

      } catch (error) {
        console.error('Erreur NFC:', error);
        
        let errorMessage = 'Erreur NFC: ';
        if (error.name === 'NotAllowedError') {
          errorMessage += 'Permissions NFC refus√©es. Activez le NFC dans les param√®tres.';
        } else if (error.name === 'NotSupportedError') {
          errorMessage += 'NFC non support√© sur cet appareil.';
        } else if (error.message.includes('HTTPS')) {
          errorMessage += 'NFC n√©cessite HTTPS. Testez sur un serveur s√©curis√©.';
        } else {
          errorMessage += error.message;
        }
        
        // Proposer une simulation
        if (confirm(errorMessage + '\n\nVoulez-vous utiliser la simulation NFC ?')) {
          showNFCSimulationModal();
        }
      }
    });

    // Fonction pour la simulation NFC
    function showNFCSimulationModal() {
      const simModal = document.createElement('div');
      simModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      simModal.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-md mx-4">
          <h3 class="text-lg font-bold text-gray-900 mb-4">üé≠ Simulation NFC</h3>
          <p class="text-gray-600 mb-4">G√©n√©ration d'un tag NFC virtuel pour les tests</p>
          <div class="space-y-3">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Type de tag</label>
              <select id="nfcSimType" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                <option value="random">G√©n√©rer al√©atoirement</option>
                <option value="bracelet">Bracelet m√©dical</option>
                <option value="card">Carte m√©dicale</option>
                <option value="keychain">Porte-cl√©s</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ID personnalis√© (optionnel)</label>
              <input type="text" id="nfcSimCustom" placeholder="Ex: MON_TAG_123" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            </div>
          </div>
          <div class="flex gap-2 mt-6">
            <button id="generateNFCTag" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white rounded px-4 py-2">G√©n√©rer</button>
            <button onclick="this.closest('.fixed').remove()" class="bg-gray-500 hover:bg-gray-600 text-white rounded px-4 py-2">Annuler</button>
          </div>
        </div>
      `;
      document.body.appendChild(simModal);

      document.getElementById('generateNFCTag').onclick = () => {
        const type = document.getElementById('nfcSimType').value;
        const custom = document.getElementById('nfcSimCustom').value.trim();
        
        let tagId = '';
        if (custom) {
          tagId = custom.startsWith('NFC_') || custom.startsWith('SYL_') ? custom : 'NFC_' + custom;
        } else {
          const random = Math.random().toString(36).substr(2, 8).toUpperCase();
          switch (type) {
            case 'bracelet': tagId = 'SYL_BRACELET_' + random; break;
            case 'card': tagId = 'SYL_CARD_' + random; break;
            case 'keychain': tagId = 'SYL_KEY_' + random; break;
            default: tagId = 'NFC_' + random;
          }
        }
        
        // Mettre √† jour le champ seulement s'il existe (interface admin)
        const nfcTagIdField = document.getElementById('nfcTagId');
        if (nfcTagIdField) {
          nfcTagIdField.value = tagId;
        }
        simModal.remove();
        showNFCSuccessModal(tagId, true);
      };
    }

    // Fonction pour afficher le succ√®s
    function showNFCSuccessModal(tagId, isSimulated = false) {
      const successModal = document.createElement('div');
      successModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      successModal.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-md mx-4 text-center">
          <div class="w-16 h-16 bg-green-600 rounded-full mx-auto flex items-center justify-center text-white text-2xl mb-4">
            ${isSimulated ? 'üé≠' : 'üì±'}
          </div>
          <h3 class="text-lg font-bold text-green-600 mb-2">Tag NFC ${isSimulated ? 'simul√©' : 'd√©tect√©'} !</h3>
          <div class="bg-gray-100 rounded p-3 mb-4">
            <code class="text-sm font-mono">${tagId}</code>
          </div>
          <p class="text-gray-600 text-sm mb-4">${isSimulated ? 'Tag virtuel g√©n√©r√© pour les tests' : 'Tag physique d√©tect√© avec succ√®s'}</p>
          <button onclick="this.closest('.fixed').remove()" class="bg-green-600 hover:bg-green-700 text-white rounded px-6 py-2">Continuer</button>
        </div>
      `;
      document.body.appendChild(successModal);
      
      // Auto-fermer apr√®s 3 secondes
      setTimeout(() => {
        if (document.body.contains(successModal)) {
          successModal.remove();
        }
      }, 3000);
    }

    // Fonction pour √©crire des donn√©es sur un tag NFC
    document.getElementById('writeNFC')?.addEventListener('click', async () => {
      const nfcTagIdField = document.getElementById('nfcTagId');
      const nfcTagDescriptionField = document.getElementById('nfcTagDescription');
      
      if (!nfcTagIdField || !nfcTagDescriptionField) {
        console.error('√âl√©ments NFC non trouv√©s dans le DOM');
        return;
      }
      
      const tagId = nfcTagIdField.value.trim();
      const description = nfcTagDescriptionField.value.trim();
      
      if (!tagId) {
        alert('Veuillez d\'abord entrer un ID de tag ou scanner un tag');
        return;
      }

      try {
        if (!('NDEFReader' in window)) {
          alert('‚ö†Ô∏è √âcriture NFC non support√©e sur cet appareil.\n\nLe tag sera enregistr√© sans donn√©es physiques.');
          return;
        }

        // V√©rifier HTTPS
        if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
          throw new Error('NFC n√©cessite HTTPS pour l\'√©criture');
        }

        // Cr√©er le modal d'√©criture
        const writeModal = document.createElement('div');
        writeModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        writeModal.innerHTML = `
          <div class="bg-white rounded-lg p-6 max-w-md mx-4">
            <h3 class="text-lg font-bold text-gray-900 mb-4">‚úçÔ∏è √âcriture NFC</h3>
            <div class="space-y-3 mb-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ID du tag</label>
                <div class="bg-gray-100 rounded p-2">
                  <code class="text-sm">${tagId}</code>
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                <div class="bg-gray-100 rounded p-2 text-sm">
                  ${description || 'Aucune description'}
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Type de donn√©es</label>
                <select id="nfcDataType" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                  <option value="text">Texte (ID du tag)</option>
                  <option value="url">URL (acc√®s d'urgence)</option>
                  <option value="contact">Contact d'urgence</option>
                  <option value="patient">Lien fiche m√©dicale patient</option>
                </select>
              </div>
              <div id="patientSelection" class="hidden">
                <label class="block text-sm font-medium text-gray-700 mb-1">S√©lectionner un patient</label>
                <select id="nfcPatientSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                  <option value="">Choisir un patient...</option>
                  ${patients.map(patient => `
                    <option value="${patient.id || patient.uid}">
                      ${patient.personalInfo?.firstName || ''} ${patient.personalInfo?.lastName || ''} 
                      ${patient.email ? `(${patient.email})` : ''}
                    </option>
                  `).join('')}
                </select>
              </div>
            </div>
            <div class="bg-blue-50 border border-blue-200 rounded p-3 mb-4">
              <p class="text-sm text-blue-800">üì± Approchez le tag NFC de votre appareil pour √©crire les donn√©es</p>
            </div>
            <div class="flex gap-2">
              <button id="startNFCWrite" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white rounded px-4 py-2">√âcrire</button>
              <button onclick="this.closest('.fixed').remove()" class="bg-gray-500 hover:bg-gray-600 text-white rounded px-4 py-2">Annuler</button>
            </div>
          </div>
        `;
        document.body.appendChild(writeModal);

        // G√©rer l'affichage de la s√©lection de patient
        document.getElementById('nfcDataType').onchange = (e) => {
          const patientSelection = document.getElementById('patientSelection');
          if (e.target.value === 'patient') {
            patientSelection.classList.remove('hidden');
          } else {
            patientSelection.classList.add('hidden');
          }
        };

        document.getElementById('startNFCWrite').onclick = async () => {
          try {
            // V√©rifications de s√©curit√© avant d'instancier NDEFReader
            if (!('NDEFReader' in window)) {
              throw new Error('NDEFReader non disponible sur cet appareil');
            }

            // V√©rifier HTTPS
            if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
              throw new Error('NFC n√©cessite HTTPS pour l\'√©criture');
            }

            // V√©rifier les permissions
            try {
              const permission = await navigator.permissions.query({ name: 'nfc' });
              if (permission.state === 'denied') {
                throw new Error('Permissions NFC refus√©es');
              }
            } catch (permError) {
              console.warn('Impossible de v√©rifier les permissions NFC:', permError);
            }

            const dataType = document.getElementById('nfcDataType').value;
            
            // Cr√©er l'instance NDEFReader dans un try-catch
            let ndef;
            try {
              ndef = new NDEFReader();
            } catch (constructorError) {
              console.error('Erreur constructor NDEFReader:', constructorError);
              throw new Error('Impossible d\'initialiser le lecteur NFC. V√©rifiez que le NFC est activ√© et que vous utilisez un navigateur compatible.');
            }
            
            // Pr√©parer les donn√©es selon le type
            let ndefMessage;
            switch (dataType) {
              case 'url':
                const emergencyUrl = `${window.location.origin}${window.location.pathname}?nfc=${tagId}`;
                ndefMessage = { records: [{ recordType: 'url', data: emergencyUrl }] };
                break;
              case 'contact':
                const vcard = `BEGIN:VCARD
VERSION:3.0
FN:SYL Medical Emergency
ORG:SYL Medical
TEL:15
NOTE:Tag d'urgence m√©dicale ID: ${tagId}
END:VCARD`;
                ndefMessage = { records: [{ recordType: 'mime', mediaType: 'text/vcard', data: vcard }] };
                break;
              case 'patient':
                const selectedPatientId = document.getElementById('nfcPatientSelect').value;
                if (!selectedPatientId) {
                  alert('Veuillez s√©lectionner un patient');
                  return;
                }
                const selectedPatient = patients.find(p => (p.id || p.uid) === selectedPatientId);
                if (!selectedPatient) {
                  alert('Patient non trouv√©');
                  return;
                }
                // Cr√©er l'URL vers la fiche m√©dicale du patient
                const patientMedicalUrl = `${window.location.origin}${window.location.pathname}?patient=${selectedPatientId}&access=medical`;
                ndefMessage = { records: [{ recordType: 'url', data: patientMedicalUrl }] };
                break;
              default: // text
                ndefMessage = { records: [{ recordType: 'text', data: tagId }] };
            }

            // Afficher le statut d'√©criture
            writeModal.querySelector('.bg-white').innerHTML = `
              <div class="text-center py-8">
                <div class="animate-pulse mb-4">
                  <div class="w-16 h-16 bg-purple-600 rounded-full mx-auto flex items-center justify-center text-white text-2xl">
                    ‚úçÔ∏è
                  </div>
                </div>
                <h3 class="text-lg font-bold text-gray-900 mb-2">√âcriture en cours...</h3>
                <p class="text-gray-600 mb-4">Maintenez le tag NFC proche de l'appareil</p>
                <button onclick="this.closest('.fixed').remove()" class="bg-gray-500 hover:bg-gray-600 text-white rounded px-4 py-2">Annuler</button>
              </div>
            `;

            // √âcrire sur le tag
            await ndef.write(ndefMessage);
            
            // Succ√®s
            writeModal.querySelector('.bg-white').innerHTML = `
              <div class="text-center py-8">
                <div class="w-16 h-16 bg-green-600 rounded-full mx-auto flex items-center justify-center text-white text-2xl mb-4">
                  ‚úÖ
                </div>
                <h3 class="text-lg font-bold text-green-600 mb-2">√âcriture r√©ussie !</h3>
                <div class="bg-gray-100 rounded p-3 mb-4">
                  <code class="text-sm font-mono">${tagId}</code>
                </div>
                <p class="text-gray-600 text-sm mb-4">Donn√©es √©crites avec succ√®s sur le tag NFC</p>
                <button onclick="this.closest('.fixed').remove()" class="bg-green-600 hover:bg-green-700 text-white rounded px-6 py-2">Terminer</button>
              </div>
            `;

            // Auto-fermer apr√®s 3 secondes
            setTimeout(() => {
              if (document.body.contains(writeModal)) {
                writeModal.remove();
              }
            }, 3000);

          } catch (writeError) {
            console.error('Erreur √©criture NFC:', writeError);
            writeModal.querySelector('.bg-white').innerHTML = `
              <div class="text-center py-8">
                <div class="w-16 h-16 bg-red-600 rounded-full mx-auto flex items-center justify-center text-white text-2xl mb-4">
                  ‚ùå
                </div>
                <h3 class="text-lg font-bold text-red-600 mb-2">Erreur d'√©criture</h3>
                <p class="text-gray-600 text-sm mb-4">${writeError.message}</p>
                <button onclick="this.closest('.fixed').remove()" class="bg-red-600 hover:bg-red-700 text-white rounded px-6 py-2">Fermer</button>
              </div>
            `;
          }
        };

      } catch (error) {
        console.error('Erreur NFC:', error);
        alert('‚ùå Erreur: ' + error.message);
      }
    });

    document.getElementById('registerNFC')?.addEventListener('click', () => {
      const nfcTagIdField = document.getElementById('nfcTagId');
      const nfcTagDescriptionField = document.getElementById('nfcTagDescription');
      
      if (!nfcTagIdField || !nfcTagDescriptionField) {
        console.error('√âl√©ments NFC non trouv√©s dans le DOM');
        return;
      }
      
      const tagId = nfcTagIdField.value.trim();
      const description = nfcTagDescriptionField.value.trim();
      
      if (!tagId) {
        alert('Veuillez entrer un ID de tag NFC');
        return;
      }
      
      if (nfcTags.find(tag => tag.id === tagId)) {
        alert('Ce tag NFC existe d√©j√†');
        return;
      }
      
      const newTag = {
        id: tagId,
        description: description,
        createdAt: new Date().toISOString(),
        assignedTo: null,
        assignedAt: null
      };
      
      nfcTags.push(newTag);
      localStorage.setItem('syl-nfc-tags', JSON.stringify(nfcTags));
      
      // Reset form
      if (nfcTagIdField) nfcTagIdField.value = '';
      if (nfcTagDescriptionField) nfcTagDescriptionField.value = '';
      
      SYLUtilities.showNotification('Tag NFC enregistr√©', { body: `Tag ${tagId} ajout√© avec succ√®s` });
      SYLAnalytics.trackEvent('nfc_tag_registered', { tagId });
      render();
    });
  }

  function setupAssociationsEvents() {
    document.getElementById('createAssociation')?.addEventListener('click', () => {
      const patientId = document.getElementById('selectPatient').value;
      const tagId = document.getElementById('selectNFCTag').value;
      
      if (!patientId || !tagId) {
        alert('Veuillez s√©lectionner un patient et un tag NFC');
        return;
      }
      
      // Mettre √† jour le tag NFC
      const tag = nfcTags.find(t => t.id === tagId);
      if (tag) {
        tag.assignedTo = patientId;
        tag.assignedAt = new Date().toISOString();
      }
      
      // Mettre √† jour le patient
      const patient = patients.find(p => (p.id || p.uid) === patientId);
      if (patient) {
        patient.nfcTagId = tagId;
        
        // Sauvegarder les donn√©es d'urgence pour l'acc√®s public
        saveEmergencyData(patient);
      }
      
      localStorage.setItem('syl-nfc-tags', JSON.stringify(nfcTags));
      localStorage.setItem('syl-patients', JSON.stringify(patients));
      
      SYLUtilities.showNotification('Association cr√©√©e', { 
        body: `Tag ${tagId} associ√© au patient` 
      });
      SYLAnalytics.trackEvent('nfc_association_created', { patientId, tagId });
      render();
    });
  }

  function setupDebugEvents() {
    // Fonction de log dans l'interface
    function logToDebugOutput(message, type = 'info') {
      const output = document.getElementById('debugOutput');
      if (!output) return;
      
      const timestamp = new Date().toLocaleTimeString();
      const typeClass = type === 'error' ? 'text-red-600' : type === 'success' ? 'text-green-600' : 'text-blue-600';
      
      const logElement = document.createElement('div');
      logElement.className = `mb-1 ${typeClass}`;
      logElement.innerHTML = `<span class="text-gray-500">[${timestamp}]</span> ${message}`;
      
      output.appendChild(logElement);
      output.scrollTop = output.scrollHeight;
    }

    // Diagnostic rapide
    document.getElementById('runQuickDiag')?.addEventListener('click', async () => {
      logToDebugOutput("üè• D√©marrage du diagnostic rapide...", 'info');
      
      try {
        const result = await window.quickDiagnosis();
        logToDebugOutput(`‚úÖ Diagnostic termin√©: Firebase=${result.firebase}, User=${!!result.user}`, 'success');
      } catch (error) {
        logToDebugOutput(`‚ùå Erreur diagnostic: ${error.message}`, 'error');
      }
    });
    
    // Analyse des collections
    document.getElementById('analyzeCollections')?.addEventListener('click', async () => {
      logToDebugOutput("üìä Analyse des collections Firebase...", 'info');
      
      try {
        const analysis = await window.debugFirebaseCollections();
        
        // R√©sumer les r√©sultats
        Object.entries(analysis).forEach(([collection, data]) => {
          if (data.error) {
            logToDebugOutput(`‚ùå ${collection}: ${data.error}`, 'error');
          } else {
            logToDebugOutput(`‚úÖ ${collection}: ${data.count} documents`, 'success');
          }
        });
        
        logToDebugOutput("üìã Analyse termin√©e - Voir console F12", 'info');
        
      } catch (error) {
        logToDebugOutput(`‚ùå Erreur analyse: ${error.message}`, 'error');
      }
    });
    
    // Nettoyage des donn√©es
    document.getElementById('cleanupData')?.addEventListener('click', async () => {
      logToDebugOutput("üßπ Nettoyage (mode test)...", 'info');
      
      try {
        const actions = await window.cleanupFirebaseData({ dryRun: true });
        logToDebugOutput(`üìã ${actions.length} actions identifi√©es`, 'info');
      } catch (error) {
        logToDebugOutput(`‚ùå Erreur: ${error.message}`, 'error');
      }
    });
    
    // Migration du sch√©ma
    document.getElementById('migrateSchema')?.addEventListener('click', async () => {
      if (!confirm('Migration du sch√©ma - Continuer?')) return;
      
      logToDebugOutput("üöÄ Migration...", 'info');
      
      try {
        await window.migrateToStandardSchema();
        logToDebugOutput("‚úÖ Migration termin√©e", 'success');
        setTimeout(() => window.renderApp?.(), 1000);
      } catch (error) {
        logToDebugOutput(`‚ùå Erreur: ${error.message}`, 'error');
      }
    });
  }
}

// Fonctions globales pour l'admin
async function viewPatient(patientId) {
  console.log('üîç Chargement patient:', patientId);
  
  try {
    // Charger depuis Firebase
    const patientDoc = await db.collection('patients').doc(patientId).get();
    
    if (!patientDoc.exists) {
      alert('Patient non trouv√© dans Firebase');
      return;
    }
    
    const patient = patientDoc.data();
    console.log('‚úÖ Patient charg√©:', patient);
    
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
      <div class="bg-white rounded-lg p-6 max-w-2xl mx-4 max-h-96 overflow-y-auto">
        <h3 class="text-lg font-bold mb-4">D√©tails du Patient</h3>
        <div class="grid grid-cols-2 gap-4">
          <div><strong>Nom:</strong> ${patient.personalInfo?.firstName || ''} ${patient.personalInfo?.lastName || ''}</div>
          <div><strong>Email:</strong> ${patient.email || 'N/A'}</div>
          <div><strong>Groupe sanguin:</strong> ${patient.personalInfo?.bloodType || 'N/A'}</div>
          <div><strong>Date de naissance:</strong> ${patient.personalInfo?.dateOfBirth || 'N/A'}</div>
          <div><strong>T√©l√©phone urgence:</strong> ${patient.personalInfo?.emergencyContact?.phone || 'N/A'}</div>
          <div><strong>Tag NFC:</strong> ${patient.nfcTagId || 'Non assign√©'}</div>
        </div>
        <div class="mt-4">
          <strong>Allergies:</strong> ${patient.medicalHistory?.allergies?.join(', ') || 'Aucune'}
        </div>
        <div class="mt-4">
          <strong>M√©dicaments:</strong> ${patient.medicalHistory?.medications?.join(', ') || 'Aucun'}
        </div>
        <button onclick="this.closest('.fixed').remove()" class="mt-4 w-full bg-gray-500 hover:bg-gray-600 text-white rounded px-4 py-2">Fermer</button>
      </div>
    `;
    document.body.appendChild(modal);
    
  } catch (error) {
    console.error('‚ùå Erreur chargement patient:', error);
    alert('Erreur lors du chargement du patient: ' + error.message);
  }
}

function assignNFC(patientId) {
  const nfcTags = JSON.parse(localStorage.getItem('syl-nfc-tags') || '[]');
  const availableTags = nfcTags.filter(tag => !tag.assignedTo);
  
  if (availableTags.length === 0) {
    alert('Aucun tag NFC disponible. Veuillez d\'abord enregistrer des tags.');
    return;
  }
  
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
  modal.innerHTML = `
    <div class="bg-white rounded-lg p-6 max-w-md mx-4">
      <h3 class="text-lg font-bold mb-4">Assigner un Tag NFC</h3>
      <select id="modalSelectTag" class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-4">
        <option value="">S√©lectionner un tag</option>
        ${availableTags.map(tag => `<option value="${tag.id}">${tag.id} ${tag.description ? `(${tag.description})` : ''}</option>`).join('')}
      </select>
      <div class="flex gap-2">
        <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white rounded px-4 py-2">Annuler</button>
        <button onclick="confirmAssignNFC('${patientId}')" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white rounded px-4 py-2">Assigner</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

function confirmAssignNFC(patientId) {
  const tagId = document.getElementById('modalSelectTag').value;
  if (!tagId) {
    alert('Veuillez s√©lectionner un tag');
    return;
  }
  
  const nfcTags = JSON.parse(localStorage.getItem('syl-nfc-tags') || '[]');
  const patients = JSON.parse(localStorage.getItem('syl-patients') || '[]');
  
  // Mettre √† jour le tag
  const tag = nfcTags.find(t => t.id === tagId);
  if (tag) {
    tag.assignedTo = patientId;
    tag.assignedAt = new Date().toISOString();
  }
  
  // Mettre √† jour le patient
  const patient = patients.find(p => (p.id || p.uid) === patientId);
  if (patient) {
    patient.nfcTagId = tagId;
    
    // Sauvegarder les donn√©es d'urgence dans Firebase pour l'acc√®s public
    saveEmergencyData(patient);
  }
  
  localStorage.setItem('syl-nfc-tags', JSON.stringify(nfcTags));
  localStorage.setItem('syl-patients', JSON.stringify(patients));
  
  document.querySelector('.fixed').remove();
  SYLUtilities.showNotification('Tag assign√©', { body: `Tag ${tagId} assign√© avec succ√®s` });
  location.reload(); // Recharger pour mettre √† jour l'affichage
}

// Fonction pour sauvegarder les donn√©es d'urgence dans une collection publique
async function saveEmergencyData(patient) {
  if (typeof firebase === 'undefined' || !firebase.firestore) {
    console.log('‚ö†Ô∏è Firebase non disponible pour sauvegarder les donn√©es d\'urgence');
    return;
  }
  
  try {
    // S'assurer que l'utilisateur est authentifi√©
    const localUser = getCurrentUser();
    if (!firebase.auth().currentUser && !(localUser && localUser.role === 'admin')) {
      console.log('‚ö†Ô∏è Pas d\'utilisateur authentifi√©, impossible de sauvegarder');
      throw new Error('Authentification requise pour sauvegarder dans Firebase');
    }
    
    const db = firebase.firestore();
    const patientId = patient.id || patient.uid;
    
    if (!patientId) {
      throw new Error('ID patient manquant');
    }
    
    // Donn√©es COMPL√àTES n√©cessaires pour l'urgence
    const emergencyData = {
      personalInfo: {
        firstName: patient.personalInfo?.firstName || '',
        lastName: patient.personalInfo?.lastName || '',
        dateOfBirth: patient.personalInfo?.dateOfBirth || '',
        bloodType: patient.personalInfo?.bloodType || '',
        height: patient.personalInfo?.height || '',
        weight: patient.personalInfo?.weight || '',
        emergencyContact: patient.personalInfo?.emergencyContact || {}
      },
      medicalHistory: {
        allergies: patient.medicalHistory?.allergies || [],
        medications: patient.medicalHistory?.medications || [],
        chronicDiseases: patient.medicalHistory?.chronicDiseases || []
      },
      emergencyInfo: {
        criticalNotes: patient.emergencyInfo?.criticalNotes || ''
      },
      lastUpdated: new Date().toISOString(),
      nfcTagId: patient.nfcTagId || null
    };
    
    // Sauvegarder dans la collection emergency_access
    await db.collection('emergency_access').doc(patientId).set(emergencyData);
    console.log('‚úÖ Donn√©es d\'urgence sauvegard√©es pour acc√®s public:', patientId, `${emergencyData.personalInfo.firstName} ${emergencyData.personalInfo.lastName}`);
    
  } catch (error) {
    console.error('‚ùå Erreur lors de la sauvegarde des donn√©es d\'urgence:', error);
    throw error; // Propager l'erreur pour que la synchronisation puisse la capturer
  }
}

// ========== FONCTIONS DE SUPPRESSION ADMIN ==========

// Supprimer un patient
function deletePatient(patientId, patientName) {
  if (!confirm(`‚ö†Ô∏è ATTENTION !\n\nVoulez-vous vraiment supprimer le patient :\n"${patientName}" ?\n\nCette action est IRR√âVERSIBLE et supprimera :\n‚Ä¢ Toutes les donn√©es m√©dicales\n‚Ä¢ L'association NFC (si existante)\n‚Ä¢ Les donn√©es d'urgence Firebase\n\nTapez "SUPPRIMER" pour confirmer.`)) {
    return;
  }
  
  const confirmation = prompt('Pour confirmer la suppression, tapez "SUPPRIMER" :');
  if (confirmation !== 'SUPPRIMER') {
    alert('Suppression annul√©e.');
    return;
  }
  
  try {
    // 1. Supprimer des patients locaux
    let patients = JSON.parse(localStorage.getItem('syl-patients') || '[]');
    const patientIndex = patients.findIndex(p => (p.id || p.uid) === patientId);
    
    if (patientIndex === -1) {
      alert('Patient non trouv√© dans les donn√©es locales.');
      return;
    }
    
    const deletedPatient = patients[patientIndex];
    patients.splice(patientIndex, 1);
    localStorage.setItem('syl-patients', JSON.stringify(patients));
    
    // 2. Lib√©rer le tag NFC associ√©
    if (deletedPatient.nfcTagId) {
      let nfcTags = JSON.parse(localStorage.getItem('syl-nfc-tags') || '[]');
      const tagIndex = nfcTags.findIndex(tag => tag.id === deletedPatient.nfcTagId);
      if (tagIndex !== -1) {
        nfcTags[tagIndex].assignedTo = null;
        nfcTags[tagIndex].assignedAt = null;
        localStorage.setItem('syl-nfc-tags', JSON.stringify(nfcTags));
        console.log(`üè∑Ô∏è Tag NFC ${deletedPatient.nfcTagId} lib√©r√©`);
      }
    }
    
    // 3. Supprimer des donn√©es d'urgence Firebase (si possible)
    deleteEmergencyDataFirebase(patientId);
    
    // 4. Supprimer de Firebase Auth (si c'est un utilisateur Firebase)
    deleteFirebaseUser(deletedPatient.email);
    
    console.log(`‚úÖ Patient supprim√©: ${patientName} (${patientId})`);
    alert(`‚úÖ Patient "${patientName}" supprim√© avec succ√®s.\n\n‚Ä¢ Donn√©es locales supprim√©es\n‚Ä¢ Tag NFC lib√©r√©\n‚Ä¢ Suppression Firebase en cours...`);
    
    // Rafra√Æchir l'affichage
    location.reload();
    
  } catch (error) {
    console.error('‚ùå Erreur lors de la suppression:', error);
    alert(`‚ùå Erreur lors de la suppression: ${error.message}`);
  }
}

// Supprimer les donn√©es d'urgence Firebase
async function deleteEmergencyDataFirebase(patientId) {
  if (typeof firebase === 'undefined' || !firebase.firestore) {
    console.log('‚ö†Ô∏è Firebase non disponible pour supprimer les donn√©es d\'urgence');
    return;
  }
  
  try {
    const db = firebase.firestore();
    
    // Supprimer de la collection emergency_access
    await db.collection('emergency_access').doc(patientId).delete();
    console.log(`‚úÖ Donn√©es d'urgence Firebase supprim√©es: ${patientId}`);
    
    // Supprimer de la collection users si elle existe
    try {
      await db.collection('users').doc(patientId).delete();
      console.log(`‚úÖ Utilisateur Firebase supprim√©: ${patientId}`);
    } catch (userError) {
      console.log(`‚ÑπÔ∏è Utilisateur Firebase non trouv√© ou d√©j√† supprim√©: ${patientId}`);
    }
    
  } catch (error) {
    console.error('‚ùå Erreur lors de la suppression Firebase:', error);
  }
}

// Supprimer un utilisateur Firebase Auth (admin uniquement)
async function deleteFirebaseUser(email) {
  console.log(`üîê Demande de suppression utilisateur Firebase: ${email}`);
  
  // Note: La suppression d'un utilisateur Firebase Auth n√©cessite les privil√®ges Admin SDK
  // Cette fonction notifie seulement l'admin qu'une action manuelle peut √™tre n√©cessaire
  
  const adminEmails = Object.keys(adminAccounts);
  if (adminEmails.includes(email)) {
    console.log('‚ö†Ô∏è Impossible de supprimer un compte admin');
    return;
  }
  
  // Dans un environnement de production, ceci ferait appel √† une Cloud Function
  // qui utilise l'Admin SDK pour supprimer l'utilisateur
  console.log(`‚ÑπÔ∏è Suppression utilisateur Firebase √† effectuer manuellement: ${email}`);
}

// Fonction pour supprimer tous les patients (VERSION FIRESTORE)
async function deleteAllPatients() {
  const adminUser = getUser();
  if (!adminUser || adminUser.role !== 'admin') {
    alert('‚ùå Acc√®s refus√© - Admin uniquement');
    return;
  }
  
  if (!confirm('‚ö†Ô∏è SUPPRIMER TOUS LES PATIENTS ?\n\nCette action supprimera d√©finitivement :\n‚Ä¢ Tous les patients du syst√®me\n‚Ä¢ Toutes leurs donn√©es m√©dicales\n‚Ä¢ Les associations NFC\n\n√ätes-vous s√ªr ?')) {
    return;
  }
  
  const confirmation = prompt('Pour confirmer, tapez "SUPPRIMER" :');
  if (confirmation !== 'SUPPRIMER') {
    alert('Suppression annul√©e.');
    return;
  }
  
  if (!db) {
    alert('‚ùå Erreur: Firebase non initialis√©');
    return;
  }
  
  try {
    // Afficher un indicateur de progression
    const progressDiv = document.createElement('div');
    progressDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    progressDiv.innerHTML = `
      <div class="bg-white rounded-lg p-6 text-center">
        <div class="animate-spin h-8 w-8 border-b-2 border-red-600 mx-auto mb-4"></div>
        <p class="text-lg font-medium">Suppression en cours...</p>
        <p id="deleteProgress" class="text-sm text-gray-600">Initialisation...</p>
      </div>
    `;
    document.body.appendChild(progressDiv);
    
    const updateProgress = (message) => {
      document.getElementById('deleteProgress').textContent = message;
    };
    
    // 1. Supprimer tous les patients
    updateProgress('Suppression des patients...');
    const patientsSnapshot = await db.collection('patients').get();
    const patientCount = patientsSnapshot.size;
    
    const patientDeletePromises = [];
    patientsSnapshot.forEach(doc => {
      patientDeletePromises.push(db.collection('patients').doc(doc.id).delete());
    });
    
    await Promise.all(patientDeletePromises);
    updateProgress(`${patientCount} patients supprim√©s`);
    
    // 2. Supprimer tous les utilisateurs patients
    updateProgress('Suppression des comptes utilisateurs...');
    const usersSnapshot = await db.collection('users').where('role', '==', 'patient').get();
    const userCount = usersSnapshot.size;
    
    const userDeletePromises = [];
    usersSnapshot.forEach(doc => {
      userDeletePromises.push(db.collection('users').doc(doc.id).delete());
    });
    
    await Promise.all(userDeletePromises);
    updateProgress(`${userCount} comptes utilisateurs supprim√©s`);
    
    // 3. Lib√©rer tous les tags NFC
    updateProgress('Lib√©ration des tags NFC...');
    const nfcSnapshot = await db.collection('nfcTags').get();
    const nfcUpdatePromises = [];
    
    nfcSnapshot.forEach(doc => {
      nfcUpdatePromises.push(
        db.collection('nfcTags').doc(doc.id).update({
          assignedTo: null,
          assignedAt: null,
          lastModified: firebase.firestore.FieldValue.serverTimestamp()
        })
      );
    });
    
    await Promise.all(nfcUpdatePromises);
    updateProgress('Tags NFC lib√©r√©s');
    
    // Supprimer l'indicateur de progression
    document.body.removeChild(progressDiv);
    
    console.log(`‚úÖ Suppression termin√©e: ${patientCount} patients, ${userCount} comptes`);
    alert(`‚úÖ Suppression termin√©e !\n\n‚Ä¢ ${patientCount} patients supprim√©s\n‚Ä¢ ${userCount} comptes utilisateurs supprim√©s\n‚Ä¢ Tags NFC lib√©r√©s\n\nLes changements sont synchronis√©s en temps r√©el.`);
    
  } catch (error) {
    // Supprimer l'indicateur de progression en cas d'erreur
    const progressDiv = document.querySelector('.fixed.inset-0');
    if (progressDiv) document.body.removeChild(progressDiv);
    
    console.error('‚ùå Erreur lors de la suppression:', error);
    alert(`‚ùå Erreur lors de la suppression: ${error.message}`);
  }
}

// ========== NETTOYAGE FIREBASE AUTH ==========

// Fonction pour diagnostiquer les comptes "fant√¥mes" Firebase Auth
async function diagnoseFirebaseAuthIssues() {
  const adminUser = getUser();
  if (!adminUser || adminUser.role !== 'admin') {
    alert('‚ùå Acc√®s refus√© - Admin uniquement');
    return;
  }
  
  if (!auth) {
    alert('‚ùå Firebase Auth non initialis√©');
    return;
  }
  
  try {
    console.log('üîç Diagnostic des comptes Firebase Auth...');
    
    // Obtenir la liste des patients locaux
    const localPatients = JSON.parse(localStorage.getItem('syl-patients') || '[]');
    const localEmails = localPatients.map(p => p.email).filter(Boolean);
    
    console.log(`üìä Patients locaux: ${localPatients.length}`);
    console.log(`üìß Emails locaux:`, localEmails);
    
    // Informations pour l'admin
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
      <div class="bg-white rounded-lg p-6 max-w-2xl mx-4 max-h-96 overflow-y-auto">
        <h3 class="text-lg font-bold mb-4 text-red-600">üîç Diagnostic Firebase Auth</h3>
        
        <div class="space-y-4">
          <div class="bg-yellow-50 border border-yellow-200 rounded p-3">
            <h4 class="font-semibold text-yellow-800">Situation d√©tect√©e :</h4>
            <p class="text-sm text-yellow-700">Des comptes Firebase Auth existent encore apr√®s suppression des donn√©es locales.</p>
          </div>
          
          <div class="bg-blue-50 border border-blue-200 rounded p-3">
            <h4 class="font-semibold text-blue-800">Patients locaux actuels :</h4>
            <p class="text-sm text-blue-700">${localPatients.length} patients dans le stockage local</p>
            ${localEmails.length > 0 ? 
              `<div class="text-xs text-blue-600 mt-1">Emails: ${localEmails.join(', ')}</div>` : 
              '<div class="text-xs text-blue-600 mt-1">Aucun email local</div>'
            }
          </div>
          
          <div class="bg-green-50 border border-green-200 rounded p-3">
            <h4 class="font-semibold text-green-800">Solutions recommand√©es :</h4>
            <ol class="text-sm text-green-700 space-y-1 ml-4 list-decimal">
              <li>Essayez de vous connecter avec l'email probl√©matique</li>
              <li>Si connexion impossible, utilisez un email diff√©rent temporairement</li>
              <li>Contactez Firebase Support pour suppression manuelle des comptes Auth</li>
              <li>Ou attendez 30 jours (suppression automatique des comptes inactifs)</li>
            </ol>
          </div>
          
          <div class="bg-red-50 border border-red-200 rounded p-3">
            <h4 class="font-semibold text-red-800">Actions avanc√©es :</h4>
            <div class="text-sm text-red-700 space-y-2">
              <button onclick="attemptAuthRecovery()" class="bg-orange-600 text-white px-3 py-1 rounded text-xs hover:bg-orange-700">
                üîß Tentative de r√©cup√©ration automatique
              </button>
              <button onclick="showFirebaseAuthAdvice()" class="bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700">
                üìö Guide Firebase Auth
              </button>
            </div>
          </div>
        </div>
        
        <button onclick="this.closest('.fixed').remove()" class="mt-4 w-full bg-gray-500 hover:bg-gray-600 text-white rounded px-4 py-2">
          Fermer
        </button>
      </div>
    `;
    document.body.appendChild(modal);
    
  } catch (error) {
    console.error('‚ùå Erreur lors du diagnostic:', error);
    alert(`‚ùå Erreur lors du diagnostic: ${error.message}`);
  }
}

// Tentative de r√©cup√©ration automatique
async function attemptAuthRecovery() {
  try {
    console.log('üîÑ Tentative de r√©cup√©ration automatique...');
    
    // D√©connecter l'utilisateur actuel si connect√©
    if (auth.currentUser) {
      await auth.signOut();
      console.log('üë§ Utilisateur actuel d√©connect√©');
    }
    
    // Nettoyer les donn√©es locales corrompues
    const keysToClean = [
      'firebase:authUser:AIzaSyDqII2vBhBybNhVcr1QktyhvVeBW2TO0KA:[DEFAULT]',
      'firebase:persistence:AIzaSyDqII2vBhBybNhVcr1QktyhvVeBW2TO0KA:[DEFAULT]'
    ];
    
    keysToClean.forEach(key => {
      if (localStorage.getItem(key)) {
        localStorage.removeItem(key);
        console.log(`üßπ Cl√© nettoy√©e: ${key}`);
      }
    });
    
    // Forcer un rafra√Æchissement
    setTimeout(() => {
      alert('üîÑ R√©cup√©ration tent√©e !\n\nLa page va se recharger pour appliquer les changements.');
      location.reload();
    }, 1000);
    
  } catch (error) {
    console.error('‚ùå Erreur lors de la r√©cup√©ration:', error);
    alert(`‚ùå Erreur lors de la r√©cup√©ration: ${error.message}`);
  }
}

// Guide Firebase Auth
function showFirebaseAuthAdvice() {
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
  modal.innerHTML = `
    <div class="bg-white rounded-lg p-6 max-w-3xl mx-4 max-h-96 overflow-y-auto">
      <h3 class="text-lg font-bold mb-4 text-blue-600">üìö Guide Firebase Authentication</h3>
      
      <div class="space-y-4 text-sm">
        <div class="bg-gray-50 border rounded p-3">
          <h4 class="font-semibold text-gray-800">üîß Solution 1: Console Firebase</h4>
          <ol class="text-gray-700 space-y-1 ml-4 list-decimal mt-2">
            <li>Allez sur <code class="bg-gray-200 px-1 rounded">console.firebase.google.com</code></li>
            <li>S√©lectionnez votre projet: <code class="bg-gray-200 px-1 rounded">syl-medical-app-1c58a</code></li>
            <li>Cliquez sur "Authentication" ‚Üí "Users"</li>
            <li>Trouvez l'email probl√©matique et cliquez sur "Delete user"</li>
          </ol>
        </div>
        
        <div class="bg-gray-50 border rounded p-3">
          <h4 class="font-semibold text-gray-800">üí° Solution 2: Email temporaire</h4>
          <p class="text-gray-700 mt-2">Utilisez un email temporaire pour cr√©er un compte test :</p>
          <ul class="text-gray-600 space-y-1 ml-4 list-disc mt-1">
            <li><code class="bg-gray-200 px-1 rounded">test@example.com</code></li>
            <li><code class="bg-gray-200 px-1 rounded">demo+1@gmail.com</code></li>
            <li><code class="bg-gray-200 px-1 rounded">votre.email+test@gmail.com</code></li>
          </ul>
        </div>
        
        <div class="bg-gray-50 border rounded p-3">
          <h4 class="font-semibold text-gray-800">‚è∞ Solution 3: Attendre</h4>
          <p class="text-gray-700 mt-2">Firebase supprime automatiquement les comptes inactifs apr√®s 30 jours sans connexion.</p>
        </div>
      </div>
      
      <button onclick="this.closest('.fixed').remove()" class="mt-4 w-full bg-blue-500 hover:bg-blue-600 text-white rounded px-4 py-2">
        Compris !
      </button>
    </div>
  `;
  document.body.appendChild(modal);
}

function deleteNFCTag(tagId) {
  if (!confirm('Supprimer ce tag NFC ? Cette action est irr√©versible.')) {
    return;
  }
  
  let nfcTags = JSON.parse(localStorage.getItem('syl-nfc-tags') || '[]');
  nfcTags = nfcTags.filter(tag => tag.id !== tagId);
  localStorage.setItem('syl-nfc-tags', JSON.stringify(nfcTags));
  
  SYLUtilities.showNotification('Tag supprim√©', { body: `Tag ${tagId} supprim√©` });
  location.reload();
}

function removeAssociation(tagId) {
  if (!confirm('Dissocier ce tag NFC du patient ?')) {
    return;
  }
  
  const nfcTags = JSON.parse(localStorage.getItem('syl-nfc-tags') || '[]');
  const patients = JSON.parse(localStorage.getItem('syl-patients') || '[]');
  
  // Mettre √† jour le tag
  const tag = nfcTags.find(t => t.id === tagId);
  if (tag) {
    const patientId = tag.assignedTo;
    tag.assignedTo = null;
    tag.assignedAt = null;
    
    // Mettre √† jour le patient
    const patient = patients.find(p => (p.id || p.uid) === patientId);
    if (patient) {
      patient.nfcTagId = null;
    }
  }
  
  localStorage.setItem('syl-nfc-tags', JSON.stringify(nfcTags));
  localStorage.setItem('syl-patients', JSON.stringify(patients));
  
  SYLUtilities.showNotification('Association supprim√©e', { body: `Tag ${tagId} dissoci√©` });
  location.reload();
}

// Fonction pour tester un tag NFC sp√©cifique
function testNFCTag(tagId) {
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
  modal.innerHTML = `
    <div class="bg-white rounded-lg p-6 max-w-md mx-4 text-center">
      <div class="w-16 h-16 bg-blue-600 rounded-full mx-auto flex items-center justify-center text-white text-2xl mb-4">
        üß™
      </div>
      <h3 class="text-lg font-bold text-gray-900 mb-4">Test du Tag NFC</h3>
      <div class="bg-gray-100 rounded p-3 mb-4">
        <code class="text-sm font-mono">${tagId}</code>
      </div>
      <div class="space-y-3">
        <button onclick="testNFCRead('${tagId}')" class="w-full bg-blue-600 hover:bg-blue-700 text-white rounded px-4 py-2">üì± Tester la lecture</button>
        <button onclick="testNFCEmergency('${tagId}')" class="w-full bg-red-600 hover:bg-red-700 text-white rounded px-4 py-2">üöë Simuler acc√®s d'urgence</button>
        <button onclick="this.closest('.fixed').remove()" class="w-full bg-gray-500 hover:bg-gray-600 text-white rounded px-4 py-2">Fermer</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

// Fonction pour programmer un tag NFC avec des donn√©es
function writeNFCTagData(tagId) {
  const nfcTags = JSON.parse(localStorage.getItem('syl-nfc-tags') || '[]');
  const tag = nfcTags.find(t => t.id === tagId);
  
  if (!tag) {
    alert('Tag non trouv√©');
    return;
  }

  // Remplir les champs et d√©clencher l'√©criture
  const nfcTagIdField = document.getElementById('nfcTagId');
  const nfcTagDescriptionField = document.getElementById('nfcTagDescription');
  const writeNFCButton = document.getElementById('writeNFC');
  
  if (!nfcTagIdField || !nfcTagDescriptionField || !writeNFCButton) {
    alert('Interface d\'√©criture NFC non disponible dans ce contexte');
    return;
  }
  
  nfcTagIdField.value = tagId;
  nfcTagDescriptionField.value = tag.description || '';
  
  // D√©clencher l'√©v√©nement d'√©criture
  writeNFCButton.click();
}

// Tester la lecture d'un tag NFC
async function testNFCRead(tagId) {
  try {
    if (!('NDEFReader' in window)) {
      alert('üì± API NFC non support√©e sur cet appareil.\n\nTest simul√© : Le tag contiendrait les donn√©es d\'urgence du patient associ√©.');
      return;
    }

    const readModal = document.createElement('div');
    readModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    readModal.innerHTML = `
      <div class="bg-white rounded-lg p-6 max-w-md mx-4 text-center">
        <div class="animate-pulse mb-4">
          <div class="w-16 h-16 bg-blue-600 rounded-full mx-auto flex items-center justify-center text-white text-2xl">
            üì±
          </div>
        </div>
        <h3 class="text-lg font-bold text-gray-900 mb-2">Lecture NFC en cours...</h3>
        <p class="text-gray-600 mb-4">Approchez le tag ${tagId} de votre appareil</p>
        <button onclick="this.closest('.fixed').remove()" class="bg-gray-500 hover:bg-gray-600 text-white rounded px-4 py-2">Annuler</button>
      </div>
    `;
    document.body.appendChild(readModal);

    const ndef = new NDEFReader();
    await ndef.scan();

    ndef.addEventListener('reading', ({ message, serialNumber }) => {
      readModal.remove();
      
      let content = 'Aucune donn√©e lisible';
      if (message.records.length > 0) {
        const record = message.records[0];
        if (record.recordType === 'text') {
          content = new TextDecoder().decode(record.data);
        } else if (record.recordType === 'url') {
          content = new TextDecoder().decode(record.data);
        }
      }

      const resultModal = document.createElement('div');
      resultModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      resultModal.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-md mx-4">
          <h3 class="text-lg font-bold text-green-600 mb-4">‚úÖ Lecture r√©ussie</h3>
          <div class="space-y-3">
            <div>
              <label class="block text-sm font-medium text-gray-700">Tag ID:</label>
              <div class="bg-gray-100 rounded p-2 text-sm font-mono">${tagId}</div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Num√©ro de s√©rie:</label>
              <div class="bg-gray-100 rounded p-2 text-sm font-mono">${serialNumber || 'Non disponible'}</div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Contenu:</label>
              <div class="bg-gray-100 rounded p-2 text-sm">${content}</div>
            </div>
          </div>
          <button onclick="this.closest('.fixed').remove()" class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white rounded px-4 py-2">Fermer</button>
        </div>
      `;
      document.body.appendChild(resultModal);
    });

    // Timeout
    setTimeout(() => {
      if (document.body.contains(readModal)) {
        readModal.remove();
        alert('‚è∞ Timeout de lecture. R√©essayez.');
      }
    }, 30000);

  } catch (error) {
    console.error('Erreur test lecture NFC:', error);
    alert('‚ùå Erreur de lecture: ' + error.message);
  }
}

// Simuler un acc√®s d'urgence
function testNFCEmergency(tagId) {
  const nfcTags = JSON.parse(localStorage.getItem('syl-nfc-tags') || '[]');
  const patients = JSON.parse(localStorage.getItem('syl-patients') || '[]');
  
  const tag = nfcTags.find(t => t.id === tagId);
  const patient = patients.find(p => (p.id || p.uid) === tag?.assignedTo);
  
  if (!patient) {
    alert('‚ùå Aucun patient associ√© √† ce tag.\n\nAssociez d\'abord un patient au tag pour tester l\'acc√®s d\'urgence.');
    return;
  }
  
  // Simuler l'interface d'urgence
  const emergencyModal = document.createElement('div');
  emergencyModal.className = 'fixed inset-0 bg-red-900 bg-opacity-95 flex items-center justify-center z-50';
  emergencyModal.innerHTML = `
    <div class="bg-white rounded-lg p-6 max-w-2xl mx-4 border-4 border-red-600">
      <div class="text-center mb-6">
        <div class="w-16 h-16 bg-red-600 rounded-full mx-auto flex items-center justify-center text-white text-2xl mb-4">
          üöë
        </div>
        <h2 class="text-2xl font-bold text-red-600 mb-2">ACC√àS D'URGENCE ACTIV√â</h2>
        <p class="text-gray-600">Tag NFC: ${tagId}</p>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bg-red-50 border-2 border-red-200 rounded-lg p-4">
          <h3 class="font-bold text-red-800 mb-3">üë§ Patient</h3>
          <div class="space-y-2 text-sm">
            <div><strong>Nom:</strong> ${patient.personalInfo?.firstName} ${patient.personalInfo?.lastName}</div>
            <div><strong>N√©(e) le:</strong> ${patient.personalInfo?.dateOfBirth || 'Non renseign√©'}</div>
            <div><strong>Groupe sanguin:</strong> <span class="bg-red-600 text-white px-2 py-1 rounded text-xs">${patient.personalInfo?.bloodType || 'Non renseign√©'}</span></div>
          </div>
        </div>
        
        <div class="bg-orange-50 border-2 border-orange-200 rounded-lg p-4">
          <h3 class="font-bold text-orange-800 mb-3">‚ö†Ô∏è Alertes M√©dicales</h3>
          <div class="space-y-2 text-sm">
            <div><strong>Allergies:</strong> ${patient.medicalHistory?.allergies?.join(', ') || 'Aucune connue'}</div>
            <div><strong>M√©dicaments:</strong> ${patient.medicalHistory?.medications?.join(', ') || 'Aucun'}</div>
            <div><strong>Maladies chroniques:</strong> ${patient.medicalHistory?.chronicDiseases?.join(', ') || 'Aucune'}</div>
          </div>
        </div>
        
        <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4">
          <h3 class="font-bold text-blue-800 mb-3">üìû Contact d'Urgence</h3>
          <div class="space-y-2 text-sm">
            <div><strong>Nom:</strong> ${patient.personalInfo?.emergencyContact?.name || 'Non renseign√©'}</div>
            <div><strong>Relation:</strong> ${patient.personalInfo?.emergencyContact?.relation || 'Non renseign√©'}</div>
            <div><strong>T√©l√©phone:</strong> 
              <a href="tel:${patient.personalInfo?.emergencyContact?.phone}" class="text-blue-600 underline">
                ${patient.personalInfo?.emergencyContact?.phone || 'Non renseign√©'}
              </a>
            </div>
          </div>
        </div>
        
        <div class="bg-yellow-50 border-2 border-yellow-200 rounded-lg p-4">
          <h3 class="font-bold text-yellow-800 mb-3">üìù Notes Critiques</h3>
          <div class="text-sm">
            ${patient.emergencyInfo?.criticalNotes || 'Aucune note critique'}
          </div>
        </div>
      </div>
      
      <div class="flex gap-2 mt-6">
        <button onclick="window.open('tel:15')" class="flex-1 bg-red-600 hover:bg-red-700 text-white rounded px-4 py-2 font-bold">üìû SAMU (15)</button>
        <button onclick="this.closest('.fixed').remove()" class="bg-gray-500 hover:bg-gray-600 text-white rounded px-4 py-2">Fermer Test</button>
      </div>
    </div>
  `;
  document.body.appendChild(emergencyModal);
  
  // Enregistrer l'acc√®s d'urgence
  SYLAnalytics.trackEvent('emergency_access_test', { tagId, patientId: patient.id || patient.uid });
}

function testNFC(tagId) {
  const nfcTags = JSON.parse(localStorage.getItem('syl-nfc-tags') || '[]');
  const patients = JSON.parse(localStorage.getItem('syl-patients') || '[]');
  
  const tag = nfcTags.find(t => t.id === tagId);
  const patient = patients.find(p => (p.id || p.uid) === tag?.assignedTo);
  
  if (!patient) {
    alert('Patient non trouv√© pour ce tag');
    return;
  }
  
  // Simuler l'acc√®s d'urgence
  const emergencyData = {
    patient: `${patient.personalInfo?.firstName} ${patient.personalInfo?.lastName}`,
    bloodType: patient.personalInfo?.bloodType,
    allergies: patient.medicalHistory?.allergies,
    emergencyContact: patient.personalInfo?.emergencyContact?.phone,
    lastAccess: new Date().toISOString()
  };
  
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
  modal.innerHTML = `
    <div class="bg-white rounded-lg p-6 max-w-md mx-4">
      <h3 class="text-lg font-bold mb-4 text-green-600">‚úÖ Test NFC R√©ussi</h3>
      <div class="space-y-2">
        <div><strong>Tag:</strong> ${tagId}</div>
        <div><strong>Patient:</strong> ${emergencyData.patient}</div>
        <div><strong>Groupe sanguin:</strong> ${emergencyData.bloodType || 'N/A'}</div>
        <div><strong>Contact urgence:</strong> ${emergencyData.emergencyContact || 'N/A'}</div>
      </div>
      <button onclick="this.closest('.fixed').remove()" class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white rounded px-4 py-2">Fermer</button>
    </div>
  `;
  document.body.appendChild(modal);
  
  SYLAnalytics.trackEvent('nfc_test', { tagId, patientId: patient.id });
}

// ----------- MEDECIN DASHBOARD -----------
async function renderMedecinDashboard(user) {
  let patients = [];
  
  // Charger les patients depuis Firebase uniquement
  try {
    const patientsSnapshot = await db.collection('patients').get();
    patients = patientsSnapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));
    console.log(`‚úÖ ${patients.length} patients charg√©s depuis Firebase`);
  } catch (error) {
    console.error('‚ùå Erreur chargement patients:', error);
    alert('‚ùå Impossible de charger les patients depuis Firebase.\n\nV√©rifiez votre connexion et vos permissions.');
  }
  
  let searchTerm = '';
  let selectedPatient = null;
  let activeTab = 'patients';
  render();

  function render() {
    const filteredPatients = patients.filter(patient =>
      `${patient.personalInfo.firstName} ${patient.personalInfo.lastName}`.toLowerCase().includes(searchTerm.toLowerCase())
    );
    document.getElementById('app').innerHTML = `
      <div class="min-h-screen bg-gray-50">
        <header class="bg-white shadow-sm border-b">
          <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center h-16">
            <div class="flex items-center">
              ${icons.stethoscope}
              <div class="ml-3">
                <h1 class="text-xl font-bold text-gray-900">SYL Medical Pro</h1>
                <p class="text-xs text-gray-500">${user.profile.speciality||''} ‚Ä¢ ${user.profile.hospital||''}</p>
              </div>
            </div>
            <div class="flex items-center space-x-4">
              <div class="text-sm text-gray-600">Dr. ${user.profile.firstName} ${user.profile.lastName}</div>
              <button id="logoutBtn" class="border-2 border-green-600 text-green-600 hover:bg-green-50 font-medium rounded-lg px-4 py-2 flex items-center gap-2">${icons.logout} D√©connexion</button>
            </div>
          </div>
        </header>
        
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
          <div class="mb-8">
            <!-- Navigation tabs -->
            <div class="flex space-x-4 mb-6">
              <button class="px-4 py-2 rounded-lg ${activeTab==='patients' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'}" data-tab="patients">Patients</button>
              <button class="px-4 py-2 rounded-lg ${activeTab==='emergency' ? 'bg-red-600 text-white' : 'bg-gray-200 text-gray-700'}" data-tab="emergency">üöë Acc√®s Urgence</button>
            </div>

            ${activeTab === 'patients' ? renderPatientsTab(filteredPatients) : ''}
            ${activeTab === 'emergency' ? renderEmergencyAccessTab() : ''}
          </div>
        </div>

        ${selectedPatient ? renderPatientModal(selectedPatient) : ''}
      </div>
    `;
    
    document.getElementById('logoutBtn').onclick = () => { logout(); };
    document.querySelectorAll('[data-tab]').forEach(btn => btn.onclick = () => { activeTab = btn.getAttribute('data-tab'); render(); });
    
    if (activeTab === 'patients') patientsTabEvents(filteredPatients);
    if (activeTab === 'emergency') emergencyTabEvents();
    if (selectedPatient) modalEvents();
  }

  function renderPatientsTab(filteredPatients) {
    return `
      <h2 class="text-2xl font-bold text-gray-900 mb-4">Patients</h2>
      
      <!-- Barre de recherche -->
      <div class="flex items-center space-x-4 mb-6">
        <div class="flex-1 relative">
          ${icons.search}
          <input type="text" placeholder="Rechercher un patient..." value="${searchTerm}" id="searchPatient" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
        </div>
        <button class="bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg px-6 py-2 flex items-center gap-2" id="addPatient">${icons.userPlus} Nouveau patient</button>
      </div>

      <!-- Stats rapides -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4 flex items-center">
          ${icons.users}<div class="ml-3"><p class="text-2xl font-bold text-gray-900">${patients.length}</p><p class="text-sm text-gray-600">Patients totaux</p></div>
        </div>
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4 flex items-center">
          ${icons.activity}<div class="ml-3"><p class="text-2xl font-bold text-gray-900">${patients.filter(p=>p.isActive).length}</p><p class="text-sm text-gray-600">Actifs</p></div>
        </div>
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4 flex items-center">
          ${icons.alert}<div class="ml-3"><p class="text-2xl font-bold text-gray-900">${patients.filter(p=>p.emergencyInfo?.criticalNotes).length}</p><p class="text-sm text-gray-600">Alertes</p></div>
        </div>
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4 flex items-center">
          ${icons.clock}<div class="ml-3"><p class="text-2xl font-bold text-gray-900">5</p><p class="text-sm text-gray-600">RDV aujourd'hui</p></div>
        </div>
      </div>

      <!-- Liste des patients -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        ${filteredPatients.map(patient => `
          <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4 mb-4 hover:shadow-lg transition-shadow cursor-pointer ${patient.emergencyInfo?.criticalNotes ? 'border-l-4 border-red-500' : ''}" data-patient="${patient.id}">
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-3">
                <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-green-500 rounded-full flex items-center justify-center">${icons.user}</div>
                <div>
                  <h3 class="font-semibold text-gray-900">${patient.personalInfo.firstName} ${patient.personalInfo.lastName}</h3>
                  <p class="text-sm text-gray-500">Groupe: ${patient.personalInfo.bloodType || 'Non renseign√©'} ‚Ä¢ ${patient.lastAccess}</p>
                  ${patient.emergencyInfo?.criticalNotes ? `<p class="text-xs text-red-600 font-bold">‚ö†Ô∏è Notes d'urgence</p>` : ''}
                </div>
              </div>
              <div class="flex items-center space-x-2">
                ${patient.isActive ? '<div class="w-3 h-3 bg-green-500 rounded-full"></div>' : ''}
                <span class="text-xs text-gray-400">Actif</span>
              </div>
            </div>
            
            <div class="mt-3 flex flex-wrap gap-2">
              ${(patient.medicalHistory.chronicDiseases || patient.medicalHistory.conditions || []).slice(0, 2).map(condition => `<span class="px-2 py-1 bg-orange-100 text-orange-700 text-xs rounded-full">${condition}</span>`).join('')}
              ${(patient.medicalHistory.chronicDiseases || patient.medicalHistory.conditions || []).length > 2 ? `<span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded-full">+${(patient.medicalHistory.chronicDiseases || patient.medicalHistory.conditions || []).length - 2} autres</span>` : ''}
            </div>
            
            ${patient.medicalHistory.allergies?.length ? `
            <div class="mt-2 p-2 bg-red-50 rounded">
              <p class="text-xs text-red-700 font-bold">Allergies: ${patient.medicalHistory.allergies.slice(0,3).join(', ')}</p>
            </div>
            ` : ''}
          </div>
        `).join('')}
      </div>
    `;
  }

  function renderEmergencyAccessTab() {
    return `
      <div class="space-y-6">
        <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-lg">
          <h2 class="text-2xl font-bold text-red-800 flex items-center">
            ${icons.emergency} <span class="ml-2">ACC√àS D'URGENCE M√âDICAL</span>
          </h2>
          <p class="text-red-700 mt-2">Recherche rapide par code d'urgence ou nom</p>
        </div>

        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Recherche d'urgence</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Code d'urgence (bracelet)</label>
              <input type="text" placeholder="SYL-XXXXXX" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-lg font-mono" id="emergencyCode">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Nom du patient</label>
              <input type="text" placeholder="Nom ou pr√©nom" class="w-full px-3 py-2 border border-gray-300 rounded-lg" id="emergencyName">
            </div>
          </div>
          <div class="mt-4 flex space-x-4">
            <button class="bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg px-6 py-3 flex items-center gap-2" id="searchEmergency">
              ${icons.search} RECHERCHE D'URGENCE
            </button>
            <button class="bg-orange-600 hover:bg-orange-700 text-white font-bold rounded-lg px-6 py-3 flex items-center gap-2">
              ${icons.phone} APPELER SAMU (15)
            </button>
          </div>
        </div>

        <!-- Patients avec alertes -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">‚ö†Ô∏è Patients avec alertes d'urgence</h3>
          <div class="space-y-3">
            ${patients.filter(p => p.emergencyInfo?.criticalNotes).map(patient => `
              <div class="border-l-4 border-red-500 bg-red-50 p-4 rounded cursor-pointer hover:bg-red-100" data-patient="${patient.id}">
                <div class="flex justify-between items-start">
                  <div>
                    <h4 class="font-bold text-red-800">${patient.personalInfo.firstName} ${patient.personalInfo.lastName}</h4>
                    <p class="text-red-700">${patient.emergencyInfo.criticalNotes}</p>
                    <p class="text-sm text-red-600">Groupe sanguin: ${patient.personalInfo.bloodType || 'Non renseign√©'}</p>
                  </div>
                  <span class="bg-red-600 text-white px-2 py-1 rounded text-xs font-bold">CRITIQUE</span>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      </div>
    `;
  }

  function renderPatientModal(patient) {
    return `
      <div class="fixed inset-0 modal-bg flex items-center justify-center p-4 modal">
        <div class="bg-white rounded-xl max-w-6xl w-full max-h-[95vh] overflow-y-auto shadow-lg">
          <div class="p-6 border-b border-gray-200 flex justify-between items-center">
            <div>
              <h2 class="text-2xl font-bold text-gray-900">${patient.personalInfo.firstName} ${patient.personalInfo.lastName}</h2>
              <p class="text-gray-600">Dossier m√©dical d'urgence complet</p>
            </div>
            <button class="bg-gray-200 text-gray-800 rounded-lg px-4 py-2" id="closeModal">‚úï</button>
          </div>

          <div class="p-6 space-y-6">
            <!-- Informations d'urgence critiques -->
            ${patient.emergencyInfo?.criticalNotes ? `
            <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-lg">
              <h3 class="font-bold text-red-800 mb-2">üö® NOTES CRITIQUES D'URGENCE</h3>
              <p class="text-red-700 font-medium">${patient.emergencyInfo.criticalNotes}</p>
            </div>
            ` : ''}

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <!-- Identit√© -->
              <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4">
                <h3 class="font-semibold text-gray-900 mb-3">üë§ Identit√©</h3>
                <div class="space-y-2 text-sm">
                  <p><strong>N√©(e) le:</strong> ${patient.personalInfo.dateOfBirth}</p>
                  <p><strong>Groupe sanguin:</strong> <span class="bg-red-600 text-white px-2 py-1 rounded font-bold">${patient.personalInfo.bloodType || 'NON RENSEIGN√â'}</span></p>
                  <p><strong>Taille:</strong> ${patient.personalInfo.height} cm</p>
                  <p><strong>Poids:</strong> ${patient.personalInfo.weight} kg</p>
                </div>
              </div>

              <!-- Allergies -->
              <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4">
                <h3 class="font-semibold text-gray-900 mb-3">‚ö†Ô∏è Allergies</h3>
                <div class="space-y-1">
                  ${(patient.medicalHistory.allergies || []).length ? patient.medicalHistory.allergies.map(allergy => `<span class="inline-block px-2 py-1 bg-red-100 text-red-700 text-xs rounded-full mr-2 mb-1">${allergy}</span>`).join('') : '<p class="text-gray-500 text-sm">Aucune allergie connue</p>'}
                </div>
              </div>

              <!-- M√©dicaments -->
              <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4">
                <h3 class="font-semibold text-gray-900 mb-3">üíä Traitements</h3>
                <div class="space-y-1">
                  ${(patient.medicalHistory.medications || []).length ? patient.medicalHistory.medications.map(medication => `<span class="inline-block px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full mr-2 mb-1">${medication}</span>`).join('') : '<p class="text-gray-500 text-sm">Aucun traitement</p>'}
                </div>
              </div>

              <!-- Pathologies -->
              <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4">
                <h3 class="font-semibold text-gray-900 mb-3">üè• Pathologies</h3>
                <div class="space-y-1">
                  ${(patient.medicalHistory.chronicDiseases || patient.medicalHistory.conditions || []).length ? (patient.medicalHistory.chronicDiseases || patient.medicalHistory.conditions).map(condition => `<span class="inline-block px-2 py-1 bg-orange-100 text-orange-700 text-xs rounded-full mr-2 mb-1">${condition}</span>`).join('') : '<p class="text-gray-500 text-sm">Aucune pathologie</p>'}
                </div>
              </div>

              <!-- Contre-indications -->
              <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4">
                <h3 class="font-semibold text-gray-900 mb-3">üö´ Contre-indications</h3>
                <div class="space-y-1">
                  ${(patient.emergencyInfo?.contraindications || []).length ? patient.emergencyInfo.contraindications.map(contra => `<span class="inline-block px-2 py-1 bg-yellow-100 text-yellow-700 text-xs rounded-full mr-2 mb-1">${contra}</span>`).join('') : '<p class="text-gray-500 text-sm">Aucune contre-indication</p>'}
                </div>
              </div>

              <!-- Dispositifs m√©dicaux -->
              <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4">
                <h3 class="font-semibold text-gray-900 mb-3">üîß Dispositifs</h3>
                <div class="space-y-1">
                  ${(patient.medicalHistory.medicalDevices || []).length ? patient.medicalHistory.medicalDevices.map(device => `<span class="inline-block px-2 py-1 bg-purple-100 text-purple-700 text-xs rounded-full mr-2 mb-1">${device}</span>`).join('') : '<p class="text-gray-500 text-sm">Aucun dispositif</p>'}
                </div>
              </div>
            </div>

            <div class="flex justify-end space-x-4">
              <button class="border-2 border-blue-600 text-blue-600 hover:bg-blue-50 font-medium rounded-lg px-4 py-2 flex items-center gap-2" id="editPatient">${icons.edit} Modifier</button>
              <button class="bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg px-4 py-2 flex items-center gap-2">${icons.activity} Nouvelle consultation</button>
              <button class="bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg px-4 py-2 flex items-center gap-2">${icons.emergency} D√©clarer urgence</button>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  function patientsTabEvents(filteredPatients) {
    document.getElementById('searchPatient').oninput = (e) => { searchTerm = e.target.value; render(); };
    document.getElementById('addPatient').onclick = () => showAddPatientModal();
    document.querySelectorAll('[data-patient]').forEach(card => card.onclick = () => {
      selectedPatient = patients.find(p=>p.id===card.getAttribute('data-patient'));
      render();
    });
  }

  function emergencyTabEvents() {
    document.getElementById('searchEmergency').onclick = () => {
      const code = document.getElementById('emergencyCode').value;
      const name = document.getElementById('emergencyName').value;
      
      let foundPatient = null;
      if (code) {
        foundPatient = patients.find(p => p.braceletId === code);
      } else if (name) {
        foundPatient = patients.find(p => 
          p.personalInfo.firstName.toLowerCase().includes(name.toLowerCase()) || 
          p.personalInfo.lastName.toLowerCase().includes(name.toLowerCase())
        );
      }
      
      if (foundPatient) {
        selectedPatient = foundPatient;
        render();
      } else {
        alert('Patient non trouv√©');
      }
    };
    
    document.querySelectorAll('[data-patient]').forEach(card => card.onclick = () => {
      selectedPatient = patients.find(p=>p.id===card.getAttribute('data-patient'));
      render();
    });
  }

  function modalEvents() {
    document.getElementById('closeModal').onclick = () => { selectedPatient = null; render(); };
    if (document.getElementById('editPatient')) {
      document.getElementById('editPatient').onclick = () => showEditPatientModal(selectedPatient);
    }
  }

  function showEditPatientModal(patient) {
    // Modal d'√©dition du patient
    document.getElementById('app').querySelector('.modal').innerHTML = `
      <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto shadow-lg">
        <div class="p-6 border-b border-gray-200 flex justify-between items-center">
          <h2 class="text-2xl font-bold text-gray-900">Modifier ${patient.personalInfo.firstName} ${patient.personalInfo.lastName}</h2>
          <button class="bg-gray-200 text-gray-800 rounded-lg px-4 py-2" id="closeEditModal">‚úï</button>
        </div>
        <div class="p-6 space-y-4">
          <div class="grid grid-cols-2 gap-4">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" id="editFirstName" value="${patient.personalInfo.firstName}" placeholder="Pr√©nom">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" id="editLastName" value="${patient.personalInfo.lastName}" placeholder="Nom">
            <input type="date" class="w-full px-3 py-2 border border-gray-300 rounded-lg" id="editBirth" value="${patient.personalInfo.dateOfBirth}">
            <select class="w-full px-3 py-2 border border-gray-300 rounded-lg" id="editBlood">
              <option value="">Groupe sanguin</option>
              ${MEDICAL_DATA.bloodTypes.map(type => `<option value="${type}" ${patient.personalInfo.bloodType===type?'selected':''}>${type}</option>`).join('')}
            </select>
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" id="editHeight" value="${patient.personalInfo.height}" placeholder="Taille (cm)">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" id="editWeight" value="${patient.personalInfo.weight}" placeholder="Poids (kg)">
          </div>
          <textarea class="w-full px-3 py-2 border border-gray-300 rounded-lg h-20" id="editCriticalNotes" placeholder="Notes critiques d'urgence">${patient.emergencyInfo?.criticalNotes || ''}</textarea>
          <button class="bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg px-6 py-2" id="saveEditPatient">Sauvegarder</button>
        </div>
      </div>
    `;
    document.getElementById('closeEditModal').onclick = () => render();
    document.getElementById('saveEditPatient').onclick = async () => {
      patient.personalInfo.firstName = document.getElementById('editFirstName').value;
      patient.personalInfo.lastName = document.getElementById('editLastName').value;
      patient.personalInfo.dateOfBirth = document.getElementById('editBirth').value;
      patient.personalInfo.bloodType = document.getElementById('editBlood').value;
      patient.personalInfo.height = document.getElementById('editHeight').value;
      patient.personalInfo.weight = document.getElementById('editWeight').value;
      if (!patient.emergencyInfo) patient.emergencyInfo = {};
      patient.emergencyInfo.criticalNotes = document.getElementById('editCriticalNotes').value;
      localStorage.setItem('syl-patients', JSON.stringify(patients));
      
      // Synchronisation Firebase automatique
      await saveToFirebase('patients', patient, patient.id);
      alert('‚úÖ Patient modifi√© et synchronis√© avec Firebase !');
      render();
    };
  }

  function showAddPatientModal() {
    document.body.insertAdjacentHTML('beforeend', `
      <div class="fixed inset-0 modal-bg flex items-center justify-center p-4 modal">
        <div class="bg-white rounded-xl max-w-md w-full overflow-y-auto shadow-lg p-6">
          <h2 class="text-2xl font-bold text-gray-900 mb-4">Nouveau patient</h2>
          <div class="space-y-3">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" id="newFirstName" placeholder="Pr√©nom">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" id="newLastName" placeholder="Nom">
            <input type="date" class="w-full px-3 py-2 border border-gray-300 rounded-lg" id="newBirth">
            <select class="w-full px-3 py-2 border border-gray-300 rounded-lg" id="newBlood">
              <option value="">Groupe sanguin</option>
              ${MEDICAL_DATA.bloodTypes.map(type => `<option value="${type}">${type}</option>`).join('')}
            </select>
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" id="newHeight" placeholder="Taille (cm)">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" id="newWeight" placeholder="Poids (kg)">
          </div>
          <div class="flex space-x-2 mt-4">
            <button class="bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg px-6 py-2" id="saveNewPatient">Ajouter</button>
            <button class="bg-gray-200 text-gray-800 rounded-lg px-6 py-2" id="cancelNewPatient">Annuler</button>
          </div>
        </div>
      </div>
    `);
    document.getElementById('cancelNewPatient').onclick = () => { document.querySelector('.modal').remove(); };
    document.getElementById('saveNewPatient').onclick = async () => {
      const patient = {
        id: Math.random().toString(36).substr(2,9),
        personalInfo: {
          firstName: document.getElementById('newFirstName').value,
          lastName: document.getElementById('newLastName').value,
          dateOfBirth: document.getElementById('newBirth').value,
          bloodType: document.getElementById('newBlood').value,
          height: document.getElementById('newHeight').value,
          weight: document.getElementById('newWeight').value
        },
        medicalHistory: { allergies: [], medications: [], conditions: [], chronicDiseases: [], medicalDevices: [] },
        emergencyInfo: { criticalNotes: '', contraindications: [] },
        lastAccess: new Date().toISOString().split('T')[0],
        isActive: true
      };
      patients.push(patient);
      localStorage.setItem('syl-patients', JSON.stringify(patients));
      
      // Synchronisation Firebase automatique
      await saveToFirebase('patients', patient, patient.id);
      alert('‚úÖ Nouveau patient ajout√© et synchronis√© avec Firebase !');
      document.querySelector('.modal').remove();
      render();
    };
  }
}

// Fonction pour afficher la fiche m√©dicale d'un patient via NFC
async function showPatientMedicalRecord(patientId) {
  // IMPORTANT: Pour permettre l'acc√®s d'urgence depuis n'importe quel appareil,
  // les r√®gles Firebase doivent autoriser la lecture anonyme des collections patients et users
  // 
  // R√àGLES FIRESTORE RECOMMAND√âES :
  /*
  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      // Collection d'acc√®s d'urgence - LECTURE PUBLIQUE
      match /emergency_access/{patientId} {
        allow read: if true;  // ‚ö†Ô∏è ACC√àS PUBLIC pour les urgences
        allow write: if request.auth != null;
      }
      
      // Collections principales - ACC√àS AUTHENTIFI√â
      match /users/{userId} {
        allow read, write: if request.auth != null;
      }
      match /patients/{patientId} {
        allow read, write: if request.auth != null;
      }
    }
  }
  */
  //
  // CONFIGURATION AUTHENTIFICATION :
  // ‚Ä¢ Activer "Authentification anonyme" dans Firebase Console
  // ‚Ä¢ Autoriser les domaines dans les "Domaines autoris√©s"
  //
  
  // D'abord essayer de r√©cup√©rer depuis localStorage
  let patients = JSON.parse(localStorage.getItem('syl-patients') || '[]');
  let patient = patients.find(p => (p.id || p.uid) === patientId);
  
  // Si pas trouv√© localement, essayer de r√©cup√©rer depuis Firebase
  if (!patient && typeof firebase !== 'undefined' && firebase.firestore) {
    console.log('üîç Patient non trouv√© localement, recherche dans Firebase...');
    
    // Afficher un indicateur de chargement
    document.getElementById('app').innerHTML = `
      <div class="min-h-screen bg-blue-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-lg p-8 max-w-md text-center">
          <div class="w-16 h-16 bg-blue-600 rounded-full mx-auto flex items-center justify-center text-white text-2xl mb-4 animate-pulse">
            üîç
          </div>
          <h2 class="text-xl font-bold text-blue-600 mb-2">Recherche du patient...</h2>
          <p class="text-gray-600 mb-4">R√©cup√©ration des donn√©es m√©dicales depuis la base de donn√©es</p>
          <div class="animate-pulse bg-gray-200 h-2 rounded mb-4"></div>
          <p class="text-sm text-gray-500">ID: ${patientId}</p>
        </div>
      </div>
    `;
    
    try {
      const db = firebase.firestore();
      
      // Essayer d'abord une authentification anonyme pour les acc√®s d'urgence
      if (!firebase.auth().currentUser) {
        console.log('üöë Authentification anonyme pour acc√®s d\'urgence...');
        try {
          await firebase.auth().signInAnonymously();
          console.log('‚úÖ Authentification anonyme r√©ussie');
        } catch (authError) {
          console.log('‚ö†Ô∏è √âchec authentification anonyme:', authError.message);
          // Continuer quand m√™me, peut-√™tre que les r√®gles permettent l'acc√®s
        }
      }
      
      // Chercher dans la collection users
      const userDoc = await db.collection('users').doc(patientId).get();
      if (userDoc.exists) {
        const userData = userDoc.data();
        console.log('üë§ Donn√©es utilisateur trouv√©es dans Firebase');
        
        // Chercher les donn√©es m√©dicales associ√©es
        const medicalDoc = await db.collection('patients').doc(patientId).get();
        const medicalData = medicalDoc.exists ? medicalDoc.data() : {};
        
        // Fusionner les donn√©es
        patient = {
          id: patientId,
          uid: patientId,
          email: userData.email,
          role: userData.role,
          personalInfo: medicalData.personalInfo || userData.personalInfo || {},
          medicalHistory: medicalData.medicalHistory || {},
          emergencyInfo: medicalData.emergencyInfo || {},
          isActive: userData.isActive !== false
        };
        
        console.log('‚úÖ Patient reconstitu√© depuis Firebase:', patient.personalInfo?.firstName, patient.personalInfo?.lastName);
      } else {
        console.log('‚ùå Patient non trouv√© dans Firebase users');
        
        // Essayer directement dans la collection patients comme fallback
        console.log('üîÑ Tentative de recherche directe dans collection patients...');
        const directPatientDoc = await db.collection('patients').doc(patientId).get();
        if (directPatientDoc.exists) {
          const patientData = directPatientDoc.data();
          patient = {
            id: patientId,
            uid: patientId,
            ...patientData
          };
          console.log('‚úÖ Patient trouv√© directement dans collection patients');
        } else {
          // Derni√®re tentative : chercher dans une collection publique d'urgence
          console.log('üöë Recherche dans collection emergency_access...');
          try {
            const emergencyDoc = await db.collection('emergency_access').doc(patientId).get();
            if (emergencyDoc.exists) {
              const emergencyData = emergencyDoc.data();
              patient = {
                id: patientId,
                uid: patientId,
                personalInfo: emergencyData.personalInfo || {},
                medicalHistory: emergencyData.medicalHistory || {},
                emergencyInfo: emergencyData.emergencyInfo || {},
                isActive: true
              };
              console.log('‚úÖ Patient trouv√© dans collection emergency_access');
            }
          } catch (emergencyError) {
            console.log('‚ùå Collection emergency_access non accessible:', emergencyError.message);
          }
        }
      }
    } catch (error) {
      console.error('Erreur Firebase lors de la recherche du patient:', error);
      
      // Afficher l'erreur sp√©cifique pour le debug
      document.getElementById('app').innerHTML = `
        <div class="min-h-screen bg-orange-50 flex items-center justify-center">
          <div class="bg-white rounded-lg shadow-lg p-8 max-w-md text-center">
            <div class="w-16 h-16 bg-orange-600 rounded-full mx-auto flex items-center justify-center text-white text-2xl mb-4">
              ‚ö†Ô∏è
            </div>
            <h2 class="text-xl font-bold text-orange-600 mb-2">Erreur d'acc√®s Firebase</h2>
            <p class="text-gray-600 mb-4">Impossible d'acc√©der √† la base de donn√©es</p>
            <div class="text-sm text-left bg-gray-100 rounded p-3 mb-4">
              <strong>Erreur:</strong> ${error.message}<br>
              <strong>Code:</strong> ${error.code || 'N/A'}<br>
              <strong>ID Patient:</strong> ${patientId}
            </div>
            <div class="text-xs text-gray-500 mb-4">
              Cette erreur indique probablement un probl√®me de configuration Firebase ou de r√®gles de s√©curit√©.
            </div>
            <button onclick="location.href='${window.location.pathname}'" class="bg-blue-600 hover:bg-blue-700 text-white rounded px-4 py-2">
              Retour √† l'application
            </button>
          </div>
        </div>
      `;
      return; // Arr√™ter ici pour afficher l'erreur
    }
  }
  
  if (!patient) {
    document.getElementById('app').innerHTML = `
      <div class="min-h-screen bg-red-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-lg p-8 max-w-md text-center">
          <div class="w-16 h-16 bg-red-600 rounded-full mx-auto flex items-center justify-center text-white text-2xl mb-4">
            ‚ùå
          </div>
          <h2 class="text-xl font-bold text-red-600 mb-2">Patient non trouv√©</h2>
          <p class="text-gray-600 mb-4">L'ID patient "${patientId}" n'existe pas dans la base de donn√©es.</p>
          <div class="text-sm text-gray-500 mb-4">
            <p>Causes possibles :</p>
            <ul class="text-left mt-2 space-y-1">
              <li>‚Ä¢ Tag NFC non synchronis√©</li>
              <li>‚Ä¢ Patient supprim√© de la base</li>
              <li>‚Ä¢ Probl√®me de connexion r√©seau</li>
            </ul>
          </div>
          <button onclick="location.href='${window.location.pathname}'" class="bg-blue-600 hover:bg-blue-700 text-white rounded px-4 py-2">
            Retour √† l'application
          </button>
        </div>
      </div>
    `;
    return;
  }
  
  // Calculer l'√¢ge
  const calculateAge = (birthDate) => {
    if (!birthDate) return 'N/A';
    const today = new Date();
    const birth = new Date(birthDate);
    let age = today.getFullYear() - birth.getFullYear();
    const monthDiff = today.getMonth() - birth.getMonth();
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
      age--;
    }
    return age + ' ans';
  };
  
  // Afficher la fiche d'information m√©dicale d'urgence (lecture seule)
  document.getElementById('app').innerHTML = `
    <div class="min-h-screen bg-gradient-to-br from-red-50 to-pink-100">
      <!-- En-t√™te d'urgence -->
      <div class="bg-red-600 text-white py-4">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="flex items-center justify-between">
            <div class="flex items-center">
              <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center text-red-600 font-bold mr-4">
                üöë
              </div>
              <div>
                <h1 class="text-2xl font-bold">FICHE M√âDICALE D'URGENCE</h1>
                <p class="text-red-100">Informations vitales - Acc√®s via NFC</p>
              </div>
            </div>
            <button onclick="location.href='${window.location.pathname}'" class="bg-red-700 hover:bg-red-800 text-white rounded-lg px-4 py-2">
              Fermer
            </button>
          </div>
        </div>
      </div>
      
      <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Identification du patient -->
        <div class="bg-white rounded-xl shadow-xl border-2 border-red-200 p-6 mb-6">
          <div class="text-center mb-6">
            <h2 class="text-3xl font-bold text-gray-900 mb-2">
              ${patient.personalInfo?.firstName || ''} ${patient.personalInfo?.lastName || ''}
            </h2>
            <div class="inline-flex items-center px-4 py-2 bg-blue-100 rounded-full">
              <span class="text-blue-800 font-medium">√Çge: ${calculateAge(patient.personalInfo?.dateOfBirth)}</span>
            </div>
          </div>
          
          <!-- Informations vitales en grand -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="text-center p-4 bg-red-50 rounded-xl border-2 border-red-200">
              <div class="text-2xl font-bold text-red-600 mb-1">${patient.personalInfo?.bloodType || '?'}</div>
              <div class="text-sm font-medium text-gray-700">Groupe sanguin</div>
            </div>
            <div class="text-center p-4 bg-blue-50 rounded-xl border-2 border-blue-200">
              <div class="text-2xl font-bold text-blue-600 mb-1">${patient.personalInfo?.height || '?'}</div>
              <div class="text-sm font-medium text-gray-700">Taille (cm)</div>
            </div>
            <div class="text-center p-4 bg-green-50 rounded-xl border-2 border-green-200">
              <div class="text-2xl font-bold text-green-600 mb-1">${patient.personalInfo?.weight || '?'}</div>
              <div class="text-sm font-medium text-gray-700">Poids (kg)</div>
            </div>
            <div class="text-center p-4 bg-purple-50 rounded-xl border-2 border-purple-200">
              <div class="text-2xl font-bold text-purple-600 mb-1">${patient.personalInfo?.dateOfBirth || '?'}</div>
              <div class="text-sm font-medium text-gray-700">Naissance</div>
            </div>
          </div>
        </div>
        
        ${patient.emergencyInfo?.criticalNotes ? `
        <!-- ALERTE CRITIQUE -->
        <div class="bg-red-600 text-white rounded-xl p-6 mb-6 border-4 border-red-700">
          <div class="flex items-center mb-3">
            <span class="text-3xl mr-3">‚ö†Ô∏è</span>
            <h3 class="text-xl font-bold">ALERTE M√âDICALE CRITIQUE</h3>
          </div>
          <p class="text-lg font-medium">${patient.emergencyInfo.criticalNotes}</p>
        </div>
        ` : ''}
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- ALLERGIES -->
          <div class="bg-white rounded-xl shadow-lg border-l-4 border-red-500 p-6">
            <h3 class="text-xl font-bold text-red-600 mb-4 flex items-center">
              <span class="text-2xl mr-2">‚ö†Ô∏è</span> ALLERGIES
            </h3>
            ${patient.medicalHistory?.allergies?.length ? 
              patient.medicalHistory.allergies.map(allergy => `
                <div class="bg-red-100 border-2 border-red-300 rounded-lg px-4 py-3 mb-2">
                  <span class="text-red-800 font-bold text-lg">${allergy}</span>
                </div>
              `).join('') : 
              '<div class="bg-gray-100 rounded-lg px-4 py-3 text-gray-600 font-medium">Aucune allergie connue</div>'
            }
          </div>
          
          <!-- M√âDICAMENTS -->
          <div class="bg-white rounded-xl shadow-lg border-l-4 border-blue-500 p-6">
            <h3 class="text-xl font-bold text-blue-600 mb-4 flex items-center">
              <span class="text-2xl mr-2">üíä</span> M√âDICAMENTS
            </h3>
            ${patient.medicalHistory?.medications?.length ? 
              patient.medicalHistory.medications.map(medication => `
                <div class="bg-blue-100 border-2 border-blue-300 rounded-lg px-4 py-3 mb-2">
                  <span class="text-blue-800 font-medium">${medication}</span>
                </div>
              `).join('') : 
              '<div class="bg-gray-100 rounded-lg px-4 py-3 text-gray-600 font-medium">Aucun m√©dicament</div>'
            }
          </div>
          
          <!-- PATHOLOGIES -->
          <div class="bg-white rounded-xl shadow-lg border-l-4 border-orange-500 p-6">
            <h3 class="text-xl font-bold text-orange-600 mb-4 flex items-center">
              <span class="text-2xl mr-2">üè•</span> PATHOLOGIES
            </h3>
            ${patient.medicalHistory?.chronicDiseases?.length ? 
              patient.medicalHistory.chronicDiseases.map(disease => `
                <div class="bg-orange-100 border-2 border-orange-300 rounded-lg px-4 py-3 mb-2">
                  <span class="text-orange-800 font-medium">${disease}</span>
                </div>
              `).join('') : 
              '<div class="bg-gray-100 rounded-lg px-4 py-3 text-gray-600 font-medium">Aucune pathologie connue</div>'
            }
          </div>
          
          <!-- CONTACT D'URGENCE -->
          <div class="bg-white rounded-xl shadow-lg border-l-4 border-green-500 p-6">
            <h3 class="text-xl font-bold text-green-600 mb-4 flex items-center">
              <span class="text-2xl mr-2">üìû</span> CONTACT D'URGENCE
            </h3>
            ${patient.personalInfo?.emergencyContact?.name ? `
              <div class="bg-green-100 border-2 border-green-300 rounded-lg px-4 py-3 mb-3">
                <div class="font-bold text-green-800 text-lg">${patient.personalInfo.emergencyContact.name}</div>
                <div class="text-green-700">${patient.personalInfo.emergencyContact.relationship || ''}</div>
              </div>
            ` : ''}
            ${patient.personalInfo?.emergencyContact?.phone ? `
              <a href="tel:${patient.personalInfo.emergencyContact.phone}" 
                 class="block w-full bg-green-600 hover:bg-green-700 text-white text-center rounded-lg px-4 py-3 font-bold text-lg">
                üìû ${patient.personalInfo.emergencyContact.phone}
              </a>
            ` : '<div class="bg-gray-100 rounded-lg px-4 py-3 text-gray-600 font-medium">Aucun contact d\'urgence</div>'}
          </div>
        </div>
        
        <!-- ACTIONS D'URGENCE -->
        <div class="mt-6 bg-white rounded-xl shadow-xl border-2 border-red-300 p-6">
          <h3 class="text-2xl font-bold text-red-600 mb-4 text-center">üö® NUM√âROS D'URGENCE</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <a href="tel:15" class="block bg-red-600 hover:bg-red-700 text-white text-center rounded-xl px-6 py-4 font-bold text-lg transition-colors">
              <div class="text-2xl mb-1">üöë</div>
              <div>SAMU</div>
              <div class="text-xl">15</div>
            </a>
            <a href="tel:18" class="block bg-orange-600 hover:bg-orange-700 text-white text-center rounded-xl px-6 py-4 font-bold text-lg transition-colors">
              <div class="text-2xl mb-1">üöí</div>
              <div>POMPIERS</div>
              <div class="text-xl">18</div>
            </a>
            <a href="tel:112" class="block bg-blue-600 hover:bg-blue-700 text-white text-center rounded-xl px-6 py-4 font-bold text-lg transition-colors">
              <div class="text-2xl mb-1">üÜò</div>
              <div>URGENCES</div>
              <div class="text-xl">112</div>
            </a>
          </div>
        </div>
        
        <!-- Footer informatif -->
        <div class="mt-6 text-center text-gray-500 text-sm">
          <p>üìã Fiche d'information m√©dicale ‚Ä¢ Consultation seule ‚Ä¢ ${new Date().toLocaleString('fr-FR')}</p>
          <p class="mt-1">üîí Donn√©es sensibles - Usage strictement m√©dical</p>
        </div>
      </div>
    </div>
  `;
  
  // Enregistrer l'acc√®s
  SYLAnalytics.trackEvent('patient_medical_access', { 
    patientId: patient.id || patient.uid, 
    accessMethod: 'nfc_link',
    accessTime: new Date().toISOString()
  });
}

// Fonction pour afficher le profil patient public (QR code)
async function showPatientPublicProfile(patientId) {
  try {
    // R√©cup√©rer les donn√©es patient depuis Firebase
    const patientsSnapshot = await db.collection('patients').doc(patientId).get();
    let patient = null;
    
    if (patientsSnapshot.exists) {
      patient = { id: patientsSnapshot.id, ...patientsSnapshot.data() };
    }
    
    if (!patient) {
      document.getElementById('app').innerHTML = `
        <div class="min-h-screen bg-gray-50 flex items-center justify-center">
          <div class="bg-white rounded-lg shadow-lg p-8 max-w-md text-center">
            <div class="w-16 h-16 bg-blue-600 rounded-full mx-auto flex items-center justify-center text-white text-2xl mb-4">
              üë§
            </div>
            <h2 class="text-xl font-bold text-gray-800 mb-2">Profil non trouv√©</h2>
            <p class="text-gray-600 mb-4">Aucun profil patient trouv√© pour cet ID.</p>
            <button onclick="location.href='${window.location.pathname}'" class="bg-blue-600 hover:bg-blue-700 text-white rounded px-4 py-2">
              Retour √† l'application
            </button>
          </div>
        </div>
      `;
      return;
    }

    // Calculer l'√¢ge
    const calculateAge = (birthDate) => {
      if (!birthDate) return 'N/A';
      const today = new Date();
      const birth = new Date(birthDate);
      let age = today.getFullYear() - birth.getFullYear();
      const monthDiff = today.getMonth() - birth.getMonth();
      if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
        age--;
      }
      return age + ' ans';
    };

    // Afficher le profil patient public
    document.getElementById('app').innerHTML = `
      <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
        <!-- En-t√™te du profil -->
        <div class="bg-blue-600 text-white py-6">
          <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between">
              <div class="flex items-center">
                <div class="w-12 h-12 bg-white rounded-lg flex items-center justify-center text-blue-600 font-bold mr-4">
                  üë§
                </div>
                <div>
                  <h1 class="text-3xl font-bold">Profil M√©dical SYL</h1>
                  <p class="text-blue-100">Informations de sant√© personnelles</p>
                </div>
              </div>
              <button onclick="location.href='${window.location.pathname}'" class="bg-blue-700 hover:bg-blue-800 text-white rounded-lg px-4 py-2">
                Retour
              </button>
            </div>
          </div>
        </div>

        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
          <!-- Identification du patient -->
          <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6 mb-6">
            <div class="text-center mb-6">
              <div class="w-20 h-20 bg-blue-100 rounded-full mx-auto flex items-center justify-center text-blue-600 text-2xl mb-4">
                üë§
              </div>
              <h2 class="text-3xl font-bold text-gray-900 mb-2">
                ${patient.personalInfo?.firstName || ''} ${patient.personalInfo?.lastName || ''}
              </h2>
              <div class="inline-flex items-center px-4 py-2 bg-blue-100 rounded-full">
                <span class="text-blue-800 font-medium">√Çge: ${calculateAge(patient.personalInfo?.dateOfBirth)}</span>
              </div>
            </div>
          </div>

          <!-- Informations personnelles -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <!-- Informations vitales -->
            <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
              <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                ü©∏ Informations vitales
              </h3>
              <div class="space-y-3">
                <div class="flex justify-between">
                  <span class="text-gray-600">Groupe sanguin:</span>
                  <span class="font-medium text-red-600">${patient.personalInfo?.bloodType || 'Non renseign√©'}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600">Taille:</span>
                  <span class="font-medium">${patient.personalInfo?.height || 'Non renseign√©'} cm</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600">Poids:</span>
                  <span class="font-medium">${patient.personalInfo?.weight || 'Non renseign√©'} kg</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600">Bracelet:</span>
                  <span class="font-medium text-blue-600">${patient.personalInfo?.braceletColor || 'Non choisi'}</span>
                </div>
              </div>
            </div>

            <!-- M√©decin traitant -->
            <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
              <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                üë®‚Äç‚öïÔ∏è M√©decin traitant
              </h3>
              <div class="space-y-3">
                ${patient.emergencyInfo?.primaryPhysician?.name ? `
                  <div class="p-3 bg-green-50 rounded-lg">
                    <div class="font-medium text-green-800">${patient.emergencyInfo.primaryPhysician.name}</div>
                    <div class="text-sm text-green-600">${patient.emergencyInfo.primaryPhysician.specialty || ''}</div>
                    ${patient.emergencyInfo.primaryPhysician.phone ? `
                      <div class="text-sm text-green-600 mt-1">üìû ${patient.emergencyInfo.primaryPhysician.phone}</div>
                    ` : ''}
                  </div>
                ` : `
                  <div class="p-3 bg-gray-100 rounded-lg text-gray-600">
                    Aucun m√©decin traitant renseign√©
                  </div>
                `}
              </div>
            </div>
          </div>

          <!-- Allergies et pathologies -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <!-- Allergies -->
            <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
              <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                ‚ö†Ô∏è Allergies
              </h3>
              ${patient.medicalHistory?.allergies?.length ? 
                patient.medicalHistory.allergies.map(allergy => `
                  <div class="bg-red-50 border border-red-200 rounded-lg px-3 py-2 mb-2">
                    <span class="text-red-800 font-medium">${allergy}</span>
                  </div>
                `).join('') : 
                '<div class="bg-gray-100 rounded-lg px-3 py-2 text-gray-600">Aucune allergie connue</div>'
              }
            </div>

            <!-- Pathologies -->
            <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
              <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                üè• Pathologies
              </h3>
              ${patient.medicalHistory?.chronicDiseases?.length ? 
                patient.medicalHistory.chronicDiseases.map(disease => `
                  <div class="bg-orange-50 border border-orange-200 rounded-lg px-3 py-2 mb-2">
                    <span class="text-orange-800 font-medium">${disease}</span>
                  </div>
                `).join('') : 
                '<div class="bg-gray-100 rounded-lg px-3 py-2 text-gray-600">Aucune pathologie connue</div>'
              }
            </div>
          </div>

          <!-- Contact d'urgence -->
          ${patient.personalInfo?.emergencyContact?.name ? `
            <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6 mb-6">
              <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                üìû Contact d'urgence
              </h3>
              <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                <div class="font-medium text-green-800 text-lg">${patient.personalInfo.emergencyContact.name}</div>
                <div class="text-green-700">${patient.personalInfo.emergencyContact.relationship || ''}</div>
                ${patient.personalInfo.emergencyContact.phone ? `
                  <div class="text-green-700 mt-2">üìû ${patient.personalInfo.emergencyContact.phone}</div>
                ` : ''}
              </div>
            </div>
          ` : ''}

          <!-- Footer -->
          <div class="mt-8 text-center text-gray-500 text-sm">
            <p>üì± Profil m√©dical SYL ‚Ä¢ Consultation: ${new Date().toLocaleString('fr-FR')}</p>
            <p class="mt-1">üîí Informations personnelles de sant√©</p>
          </div>
        </div>
      </div>
    `;

    // Enregistrer l'acc√®s
    SYLAnalytics.trackEvent('patient_profile_access', { 
      patientId: patient.id || patient.uid, 
      accessMethod: 'qr_code',
      accessTime: new Date().toISOString()
    });

  } catch (error) {
    console.error('Erreur lors de l\'affichage du profil patient:', error);
    document.getElementById('app').innerHTML = `
      <div class="min-h-screen bg-gray-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-lg p-8 max-w-md text-center">
          <div class="w-16 h-16 bg-red-600 rounded-full mx-auto flex items-center justify-center text-white text-2xl mb-4">
            ‚ùå
          </div>
          <h2 class="text-xl font-bold text-red-600 mb-2">Erreur de chargement</h2>
          <p class="text-gray-600 mb-4">Impossible de charger le profil patient.</p>
          <button onclick="location.href='${window.location.pathname}'" class="bg-blue-600 hover:bg-blue-700 text-white rounded px-4 py-2">
            Retour √† l'application
          </button>
        </div>
      </div>
    `;
  }
}

// ----------- MAIN -----------
function renderApp() {
  console.log("renderApp appellee");
  
  try {
    // Masquer le loader initial et afficher l'app
    const initialLoader = document.getElementById('initialLoader');
    const mainApp = document.getElementById('mainApp');
    const mobileNav = document.getElementById('mobileNav');
    
    if (initialLoader) initialLoader.style.display = 'none';
    
    // PRIORIT√â 1: V√©rifier d'abord si on est en mode acc√®s d'urgence
    const urlParams = new URLSearchParams(window.location.search);
    const patientId = urlParams.get('patient');
    const accessType = urlParams.get('access');
    
    if (patientId && accessType === 'medical') {
      console.log('üöë Mode acc√®s fiche m√©dicale prioritaire:', patientId);
      if (mainApp) mainApp.style.display = 'block';
      if (mobileNav) mobileNav.style.display = 'none'; // Pas de nav en mode urgence
      showPatientMedicalRecord(patientId);
      return; // Arr√™ter ici pour √©viter d'√©craser l'affichage
    }
    
    // V√©rifier que Firebase est charg√©
    if (typeof firebase === 'undefined') {
      console.error("Firebase n'est pas charge");
      if (mainApp) mainApp.style.display = 'block';
      if (mobileNav) mobileNav.style.display = 'none';
      showLogin();
      return;
    }
    
    // R√©cup√©rer l'utilisateur local
    const localUser = getUser();
    
    if (localUser) {
      console.log("Utilisateur connect√©, r√¥le:", localUser.role);
      
      // Afficher l'app et la navigation mobile
      if (mainApp) mainApp.style.display = 'block';
      if (mobileNav && localUser.role !== 'admin') {
        mobileNav.style.display = 'block';
        updateMobileNavForRole(localUser.role);
      }
      
      if (localUser.role === 'patient') {
        renderPatientDashboard(localUser);
      } else if (localUser.role === 'medecin') {
        renderMedecinDashboard(localUser);
      } else if (localUser.role === 'admin') {
        renderAdminDashboard(localUser);
        // Admin utilise la navigation desktop, pas mobile
        if (mobileNav) mobileNav.style.display = 'none';
      } else {
        console.error("R√¥le utilisateur inconnu:", localUser.role);
        clearUser();
        showLogin();
      }
    } else {
      // Pas d'utilisateur connect√©
      console.log("Redirection vers login");
      if (mainApp) mainApp.style.display = 'block';
      if (mobileNav) mobileNav.style.display = 'none';
      showLogin();
    }
  } catch (error) {
    console.error("Erreur dans renderApp:", error);
    const mainApp = document.getElementById('mainApp');
    const mobileNav = document.getElementById('mobileNav');
    if (mainApp) mainApp.style.display = 'block';
    if (mobileNav) mobileNav.style.display = 'none';
    showLogin();
  }
}

// Fonction pour adapter la navigation mobile selon le r√¥le
function updateMobileNavForRole(role) {
  const mobileNav = document.getElementById('mobileNav');
  if (!mobileNav) return;
  
  // Navigation pour patients
  if (role === 'patient') {
    mobileNav.innerHTML = `
      <div class="mobile-nav-items">
        <a href="#" class="mobile-nav-item" id="nav-dashboard" onclick="switchTabMobile('dashboard')">
          <div class="mobile-nav-icon">üè†</div>
          <div class="mobile-nav-label">Accueil</div>
        </a>
        <a href="#" class="mobile-nav-item" id="nav-profile" onclick="switchTabMobile('profile')">
          <div class="mobile-nav-icon">üë§</div>
          <div class="mobile-nav-label">Profil</div>
        </a>
        <a href="#" class="mobile-nav-item" id="nav-emergency" onclick="switchTabMobile('emergency')">
          <div class="mobile-nav-icon">üö®</div>
          <div class="mobile-nav-label">Urgence</div>
        </a>
        <a href="#" class="mobile-nav-item" id="nav-nfc" onclick="switchTabMobile('nfc')">
          <div class="mobile-nav-icon">üì±</div>
          <div class="mobile-nav-label">NFC</div>
        </a>
        <a href="#" class="mobile-nav-item" id="nav-settings" onclick="logout()">
          <div class="mobile-nav-icon">üö™</div>
          <div class="mobile-nav-label">Sortir</div>
        </a>
      </div>
    `;
  }
  
  // Navigation pour m√©decins
  if (role === 'medecin') {
    mobileNav.innerHTML = `
      <div class="mobile-nav-items">
        <a href="#" class="mobile-nav-item" id="nav-dashboard" onclick="switchTabMobile('dashboard')">
          <div class="mobile-nav-icon">üè•</div>
          <div class="mobile-nav-label">Patients</div>
        </a>
        <a href="#" class="mobile-nav-item" id="nav-nfc" onclick="switchTabMobile('nfc')">
          <div class="mobile-nav-icon">üì±</div>
          <div class="mobile-nav-label">NFC</div>
        </a>
        <a href="#" class="mobile-nav-item" id="nav-emergency" onclick="switchTabMobile('emergency')">
          <div class="mobile-nav-icon">üö®</div>
          <div class="mobile-nav-label">Urgences</div>
        </a>
        <a href="#" class="mobile-nav-item" id="nav-settings" onclick="logout()">
          <div class="mobile-nav-icon">üö™</div>
          <div class="mobile-nav-label">Sortir</div>
        </a>
      </div>
    `;
  }
}

// Fonction pour changer d'onglet sur mobile
function switchTabMobile(tabName) {
  // Retirer la classe active de tous les onglets
  document.querySelectorAll('.mobile-nav-item').forEach(item => {
    item.classList.remove('active');
  });
  
  // Ajouter la classe active √† l'onglet s√©lectionn√©
  const activeTab = document.getElementById(`nav-${tabName}`);
  if (activeTab) {
    activeTab.classList.add('active');
  }
  
  // G√©rer l'affichage du contenu selon l'onglet
  const user = getUser();
  if (!user) return;
  
  switch(tabName) {
    case 'dashboard':
      if (user.role === 'patient') {
        renderPatientDashboard(user);
      } else if (user.role === 'medecin') {
        renderMedecinDashboard(user);
      }
      break;
    case 'profile':
      if (user.role === 'patient') {
        showTab('monProfil');
      }
      break;
    case 'emergency':
      showTab('situationUrgence');
      break;
    case 'nfc':
      showTab('gestionNFC');
      break;
    default:
      console.log('Onglet non reconnu:', tabName);
  }
}

// Fonction de d√©connexion mise √† jour
function logout() {
  // Emp√™cher les clics multiples
  if (window.loggingOut) {
    console.log('D√©connexion d√©j√† en cours...');
    return;
  }
  
  window.loggingOut = true;
  
  const finishLogout = () => {
    clearUser();
    window.loggingOut = false;
    renderApp();
    console.log('‚úÖ D√©connexion termin√©e');
  };
  
  try {
    if (typeof firebase !== 'undefined' && firebase.auth && firebase.auth().currentUser) {
      console.log('üîÑ D√©connexion Firebase...');
      firebase.auth().signOut()
        .then(() => {
          console.log('‚úÖ Firebase d√©connect√©');
          finishLogout();
        })
        .catch((error) => {
          console.error('‚ùå Erreur d√©connexion Firebase:', error);
          finishLogout();
        });
    } else {
      console.log('üîÑ D√©connexion locale seulement');
      finishLogout();
    }
  } catch (error) {
    console.error('‚ùå Erreur logout:', error);
    finishLogout();
  }
}

// Am√©lioration des performances - Debounce pour les sauvegardes
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// Sauvegarde automatique avec debounce
const autoSave = debounce((data) => {
  localStorage.setItem('syl-medicalData', JSON.stringify(data));
  console.log('üîÑ Sauvegarde automatique effectu√©e');
}, 2000);

// Monitoring et analytics basiques
class SYLAnalytics {
  static init() {
    this.startTime = Date.now();
    this.trackEvent('app_start');
  }
  
  static trackEvent(eventName, data = {}) {
    const event = {
      name: eventName,
      timestamp: new Date().toISOString(),
      data: data,
      sessionId: this.getSessionId()
    };
    
    const events = JSON.parse(localStorage.getItem('syl-analytics') || '[]');
    events.push(event);
    
    // Garder seulement les 100 derniers √©v√©nements
    if (events.length > 100) {
      events.splice(0, events.length - 100);
    }
    
    localStorage.setItem('syl-analytics', JSON.stringify(events));
  }
  
  static getSessionId() {
    if (!this.sessionId) {
      this.sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }
    return this.sessionId;
  }
}

// V√©rification de la sant√© de l'application
class HealthChecker {
  static checkSystemHealth() {
    const checks = [];
    
    // V√©rifier localStorage
    try {
      localStorage.setItem('test', 'test');
      localStorage.removeItem('test');
      checks.push({ name: 'localStorage', status: 'OK' });
    } catch (e) {
      checks.push({ name: 'localStorage', status: 'ERREUR', error: e.message });
    }
    
    // V√©rifier Firebase
    try {
      if (firebase.app()) {
        checks.push({ name: 'Firebase', status: 'OK' });
      }
    } catch (e) {
      checks.push({ name: 'Firebase', status: 'ERREUR', error: e.message });
    }
    
    // V√©rifier les API du navigateur
    checks.push({ 
      name: 'G√©olocalisation', 
      status: navigator.geolocation ? 'OK' : 'NON SUPPORT√â' 
    });
    
    checks.push({ 
      name: 'Notifications', 
      status: 'Notification' in window ? 'OK' : 'NON SUPPORT√â' 
    });
    
    checks.push({ 
      name: 'Service Worker', 
      status: 'serviceWorker' in navigator ? 'OK' : 'NON SUPPORT√â' 
    });
    
    return checks;
  }
  
  static displayHealthStatus() {
    const checks = this.checkSystemHealth();
    console.group('üè• √âtat de sant√© SYL Medical');
    checks.forEach(check => {
      const icon = check.status === 'OK' ? '‚úÖ' : check.status === 'NON SUPPORT√â' ? '‚ö†Ô∏è' : '‚ùå';
      console.log(`${icon} ${check.name}: ${check.status}${check.error ? ` (${check.error})` : ''}`);
    });
    console.groupEnd();
  }
}

// Initialisation am√©lior√©e
document.addEventListener('DOMContentLoaded', () => {
  // PRIORIT√â ABSOLUE: V√©rifier d'abord les modes d'acc√®s d'urgence
  const urlParams = new URLSearchParams(window.location.search);
  const nfcTagId = urlParams.get('nfc') || urlParams.get('tag');
  const patientId = urlParams.get('patient');
  const accessType = urlParams.get('access');
  
  // Mode acc√®s fiche m√©dicale patient (priorit√© absolue)
  if (patientId && accessType === 'medical') {
    console.log('üöë MODE URGENCE: Acc√®s fiche m√©dicale patient d√©tect√©:', patientId);
    
    // Essayer imm√©diatement, puis avec d√©lai si Firebase n'est pas pr√™t
    showPatientMedicalRecord(patientId).catch(() => {
      console.log('‚è≥ Premi√®re tentative √©chou√©e, attente Firebase...');
      setTimeout(() => {
        showPatientMedicalRecord(patientId);
      }, 2000);
    });
    
    return; // Arr√™t complet pour √©viter toute interf√©rence
  }
  
  // Mode acc√®s profil patient public (QR code)
  if (patientId && !accessType) {
    console.log('üì± MODE QR: Acc√®s profil patient public d√©tect√©:', patientId);
    
    // Essayer imm√©diatement, puis avec d√©lai si Firebase n'est pas pr√™t
    showPatientPublicProfile(patientId).catch(() => {
      console.log('‚è≥ Premi√®re tentative √©chou√©e, attente Firebase...');
      setTimeout(() => {
        showPatientPublicProfile(patientId);
      }, 2000);
    });
    
    return; // Arr√™t complet pour √©viter toute interf√©rence
  }
  
  // Mode acc√®s NFC d'urgence
  if (nfcTagId) {
    console.log('üöë MODE URGENCE: Acc√®s d\'urgence d√©tect√© pour tag:', nfcTagId);
    SYLUtilities.handleNFCAccess(nfcTagId).catch(error => {
      console.error('Erreur acc√®s NFC:', error);
    });
    return; // Ne pas initialiser l'interface normale
  }
  
  // Initialiser les syst√®mes normaux seulement si pas en mode urgence
  SYLAnalytics.init();
  ReminderSystem.init();
  HealthChecker.displayHealthStatus();
  
  // √âcouter les √©v√©nements NFC si support√©
  if ('NDEFReader' in window) {
    try {
      const ndef = new NDEFReader();
      ndef.addEventListener('reading', ({ message }) => {
        const tagId = message.records[0]?.data ? new TextDecoder().decode(message.records[0].data) : null;
        if (tagId && (tagId.startsWith('SYL_') || tagId.startsWith('NFC_'))) {
          console.log('üè∑Ô∏è Tag NFC SYL d√©tect√©:', tagId);
          SYLUtilities.handleNFCAccess(tagId);
        }
      });
      
      // D√©marrer la lecture NFC automatiquement
      ndef.scan().then(() => {
        console.log('üì° Lecteur NFC activ√©');
      }).catch(error => {
        console.log('‚ùå Impossible d\'activer le lecteur NFC:', error.message);
      });
    } catch (error) {
      console.log('‚ö†Ô∏è API NFC non disponible:', error.message);
    }
  }
  
  // V√©rifier les mises √† jour p√©riodiquement
  setInterval(() => {
    HealthChecker.displayHealthStatus();
  }, 300000); // Toutes les 5 minutes
  
  // Afficher les informations de version
  console.log('%cüè• SYL Medical v2.1 Admin Enhanced', 'color: #3B82F6; font-size: 16px; font-weight: bold;');
  console.log('Nouvelles fonctionnalit√©s Admin:');
  console.log('‚Ä¢ üë®‚Äç  Tableau de bord administrateur');
  console.log('‚Ä¢ üè∑Ô∏è Gestion des tags NFC');
  console.log('‚Ä¢ üîó Association patient-NFC');
  console.log('‚Ä¢ üöë Acc√®s d\'urgence par NFC');
  console.log('‚Ä¢   Analytics et monitoring');
  console.log('‚Ä¢ üîç Recherche et filtrage patients');
});

// Init - Attendre que Firebase soit pr√™t avec timeout
let authInitialized = false;

firebase.auth().onAuthStateChanged((user) => {
  console.log("Auth state changed:", user ? "connect√©" : "d√©connect√©");
  authInitialized = true;
  
  // V√©rifier d'abord si on est en mode urgence avant de rendre l'app normale
  const urlParams = new URLSearchParams(window.location.search);
  const patientId = urlParams.get('patient');
  const accessType = urlParams.get('access');
  const nfcTagId = urlParams.get('nfc') || urlParams.get('tag');
  
  if ((patientId && accessType === 'medical') || nfcTagId) {
    console.log("üöë Mode urgence d√©tect√© - √©viter renderApp()");
    return; // Ne pas appeler renderApp() en mode urgence
  }
  
  renderApp();
  
  // Initialiser la synchronisation temps r√©el Firestore
  setTimeout(async () => {
    try {
      console.log("üî• Initialisation du syst√®me temps r√©el");
      await initRealtimeSync();
    } catch (err) {
      console.log("Erreur init temps r√©el:", err);
    }
  }, 2000); // Attendre 2 secondes apr√®s le rendu
  
  // D√©marrer la synchronisation automatique apr√®s le rendu (avec d√©lai)
  setTimeout(async () => {
    try {
      console.log("üöÄ D√©marrage de la premi√®re auto-synchronisation");
      await window.autoSyncPatients();
    } catch (err) {
      console.log("Premi√®re auto-sync √©chou√©e:", err);
    }
  }, 3000); // Attendre 3 secondes apr√®s le rendu
});

// Timeout de s√©curit√© si Firebase ne r√©pond pas
setTimeout(() => {
  if (!authInitialized) {
    // V√©rifier d'abord si on est en mode urgence
    const urlParams = new URLSearchParams(window.location.search);
    const patientId = urlParams.get('patient');
    const accessType = urlParams.get('access');
    const nfcTagId = urlParams.get('nfc') || urlParams.get('tag');
    
    if ((patientId && accessType === 'medical') || nfcTagId) {
      console.log("üöë Mode urgence d√©tect√© - pas de timeout");
      return;
    }
    
    console.log("Timeout Firebase - Chargement forc√© de l'interface");
    showLogin();
  }
}, 5000); // 5 secondes

// Test imm√©diat si Firebase est d√©j√† pr√™t
if (firebase.auth().currentUser !== undefined) {
  // V√©rifier d'abord si on est en mode urgence
  const urlParams = new URLSearchParams(window.location.search);
  const patientId = urlParams.get('patient');
  const accessType = urlParams.get('access');
  const nfcTagId = urlParams.get('nfc') || urlParams.get('tag');
  
  if ((patientId && accessType === 'medical') || nfcTagId) {
    console.log("üöë Mode urgence d√©tect√© - pas de renderApp() imm√©diat");
  } else {
    console.log("Firebase d√©j√† pr√™t");
    renderApp();
  }
}

// ========== NOUVELLES FONCTIONS SIMPLIFI√âES ==========

// Dashboard patient simplifi√© (sans NFC)
function showPatientDashboard() {
  const user = getUser();
  if (!user || user.role !== USER_TYPES.PATIENT) {
    showLogin();
    return;
  }

  document.getElementById('app').innerHTML = `
    <div class="min-h-screen bg-gray-50">
      <!-- Header Patient -->
      <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="flex justify-between items-center h-16">
            <div class="flex items-center">
              <div class="w-10 h-10 bg-gradient-to-r from-blue-600 to-green-600 rounded-full flex items-center justify-center mr-3">
                ${icons.heart}
              </div>
              <div>
                <h1 class="text-xl font-semibold text-gray-900">SYL Medical</h1>
                <p class="text-sm text-gray-500">Mon espace patient</p>
              </div>
            </div>
            <div class="flex items-center space-x-4">
              <div class="text-right">
                <p class="text-sm font-medium text-gray-900">${user.personalInfo.firstName} ${user.personalInfo.lastName}</p>
                <p class="text-xs text-gray-500">${user.email}</p>
              </div>
              <button onclick="logout()" class="text-gray-500 hover:text-red-600">
                ${icons.logout}
              </button>
            </div>
          </div>
        </div>
      </header>

      <!-- Navigation simplifi√©e -->
      <nav class="bg-white border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="flex space-x-8" id="patientTabs">
            <button class="py-4 px-1 border-b-2 border-blue-500 text-blue-600 font-medium text-sm" data-tab="overview">
              ${icons.activity} Vue d'ensemble
            </button>
            <button class="py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm" data-tab="medical">
              ${icons.medical} Mes donn√©es m√©dicales
            </button>
            <button class="py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm" data-tab="emergency">
              ${icons.emergency} Ma fiche d'urgence
            </button>
            <button class="py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm" data-tab="profile">
              ${icons.settings} Mon profil
            </button>
          </div>
        </div>
      </nav>

      <!-- Contenu principal -->
      <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div id="patientContent">
          <!-- Le contenu sera charg√© ici -->
        </div>
      </main>
    </div>

    <!-- Chat m√©dical simplifi√© -->
    <div id="medicalChatBot" class="fixed bottom-6 right-6 z-50">
      <button id="chatToggle" class="bg-green-600 hover:bg-green-700 text-white rounded-full p-4 shadow-lg transition-all duration-200 transform hover:scale-105">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
        </svg>
      </button>
      <div id="chatWindow" class="hidden absolute bottom-16 right-0 w-80 h-96 bg-white rounded-lg shadow-xl border border-gray-200">
        <div class="bg-green-600 text-white p-4 rounded-t-lg">
          <h3 class="font-semibold">Assistant M√©dical SYL</h3>
          <p class="text-sm opacity-90">Je vous aide √† compl√©ter votre fiche</p>
        </div>
        <div id="chatMessages" class="p-4 h-64 overflow-y-auto">
          <div class="text-sm text-gray-600 mb-4">
            üë®‚Äç‚öïÔ∏è Bonjour ! Je vais vous aider √† compl√©ter votre fiche m√©dicale. Je peux vous poser des questions sur :
            <ul class="mt-2 space-y-1 text-xs">
              <li>ü©∏ Votre groupe sanguin</li>
              <li>üíä Vos m√©dicaments actuels</li>
              <li>üö´ Vos allergies</li>
              <li>üè• Vos ant√©c√©dents m√©dicaux</li>
              <li>üìû Votre contact d'urgence</li>
            </ul>
            <p class="mt-3 text-xs text-green-600">Tapez "commencer" pour d√©buter l'√©valuation m√©dicale</p>
          </div>
        </div>
        <div class="p-4 border-t">
          <div class="flex space-x-2">
            <input type="text" id="chatInput" placeholder="Tapez 'commencer' ou votre question..." 
              class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500"/>
            <button id="chatSend" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
              ${icons.arrow}
            </button>
          </div>
        </div>
      </div>
    </div>
  `;

  // Initialisation des onglets
  initSimplePatientTabs();
  
  // Initialisation du chat m√©dical
  initMedicalChatBot();
  
  // Charger la vue d'ensemble par d√©faut
  showPatientOverview();
}

// Gestion des onglets simplifi√©e
function initSimplePatientTabs() {
  const tabs = document.querySelectorAll('#patientTabs button');
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      // Reset tous les onglets
      tabs.forEach(t => {
        t.classList.remove('border-blue-500', 'text-blue-600');
        t.classList.add('border-transparent', 'text-gray-500');
      });
      
      // Activer l'onglet cliqu√©
      tab.classList.remove('border-transparent', 'text-gray-500');
      tab.classList.add('border-blue-500', 'text-blue-600');
      
      // Charger le contenu correspondant
      const tabName = tab.getAttribute('data-tab');
      switch(tabName) {
        case 'overview':
          showPatientOverview();
          break;
        case 'medical':
          showSimpleMedicalForm();
          break;
        case 'emergency':
          showEmergencyCard();
          break;
        case 'profile':
          showProfileForm();
          break;
      }
    });
  });
}

// Vue d'ensemble simplifi√©e
function showPatientOverview() {
  const user = getUser();
  const content = document.getElementById('patientContent');
  
  const completedFields = calculateCompletionFields(user);
  const completionPercentage = Math.round((completedFields.completed / completedFields.total) * 100);
  
  content.innerHTML = `
    <div class="space-y-6">
      <!-- R√©sum√© de progression -->
      <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">üëã Bienvenue, ${user.personalInfo.firstName}</h2>
        
        <div class="bg-blue-50 p-4 rounded-lg mb-6">
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm font-medium text-blue-700">Compl√©tude de votre fiche m√©dicale</span>
            <span class="text-sm font-bold text-blue-700">${completionPercentage}%</span>
          </div>
          <div class="w-full bg-blue-200 rounded-full h-2">
            <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: ${completionPercentage}%"></div>
          </div>
          <p class="text-xs text-blue-600 mt-2">${completedFields.completed}/${completedFields.total} informations renseign√©es</p>
        </div>

        <!-- Actions rapides -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <button onclick="document.querySelector('[data-tab=medical]').click()" 
            class="p-4 border border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors text-left">
            <div class="text-blue-600 text-2xl mb-2">${icons.medical}</div>
            <h3 class="font-medium text-gray-900">Compl√©ter mes donn√©es</h3>
            <p class="text-sm text-gray-600">Allergies, m√©dicaments, ant√©c√©dents</p>
          </button>
          
          <button onclick="document.querySelector('[data-tab=emergency]').click()" 
            class="p-4 border border-gray-200 rounded-lg hover:border-red-500 hover:bg-red-50 transition-colors text-left">
            <div class="text-red-600 text-2xl mb-2">${icons.emergency}</div>
            <h3 class="font-medium text-gray-900">Ma fiche d'urgence</h3>
            <p class="text-sm text-gray-600">Visualiser et t√©l√©charger</p>
          </button>
          
          <button onclick="document.querySelector('[data-tab=profile]').click()" 
            class="p-4 border border-gray-200 rounded-lg hover:border-green-500 hover:bg-green-50 transition-colors text-left">
            <div class="text-green-600 text-2xl mb-2">${icons.user}</div>
            <h3 class="font-medium text-gray-900">Mon profil</h3>
            <p class="text-sm text-gray-600">Informations personnelles</p>
          </button>
        </div>
      </div>

      <!-- Informations importantes -->
      <div class="bg-green-50 border-l-4 border-green-400 p-4 rounded">
        <div class="flex">
          <div class="flex-shrink-0">
            <div class="text-green-400 text-xl">${icons.check}</div>
          </div>
          <div class="ml-3">
            <h3 class="text-sm font-medium text-green-800">Vos donn√©es sont s√©curis√©es</h3>
            <div class="mt-2 text-sm text-green-700">
              <ul class="list-disc pl-5 space-y-1">
                <li>Chiffrement bout-√†-bout de vos donn√©es m√©dicales</li>
                <li>Acc√®s d'urgence possible via QR Code personnel</li>
                <li>Conformit√© RGPD et respect de votre vie priv√©e</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
}

// Chat m√©dical sp√©cialis√©
function initMedicalChatBot() {
  const chatToggle = document.getElementById('chatToggle');
  const chatWindow = document.getElementById('chatWindow');
  const chatInput = document.getElementById('chatInput');
  const chatSend = document.getElementById('chatSend');

  chatToggle.addEventListener('click', () => {
    chatWindow.classList.toggle('hidden');
  });

  const sendMessage = () => {
    const message = chatInput.value.trim().toLowerCase();
    if (!message) return;

    // Ajouter le message de l'utilisateur
    addMedicalChatMessage(chatInput.value, 'user');
    chatInput.value = '';

    // G√©n√©rer une r√©ponse m√©dicale sp√©cialis√©e
    setTimeout(() => {
      const response = generateMedicalResponse(message);
      addMedicalChatMessage(response, 'bot');
    }, 1000);
  };

  chatSend.addEventListener('click', sendMessage);
  chatInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage();
  });
}

function addMedicalChatMessage(message, sender) {
  const chatMessages = document.getElementById('chatMessages');
  const messageDiv = document.createElement('div');
  messageDiv.className = `mb-3 ${sender === 'user' ? 'text-right' : 'text-left'}`;
  
  messageDiv.innerHTML = `
    <div class="${sender === 'user' ? 'bg-green-600 text-white ml-8' : 'bg-gray-100 text-gray-800 mr-8'} 
                rounded-lg px-3 py-2 text-sm inline-block">
      ${message}
    </div>
  `;
  
  chatMessages.appendChild(messageDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

function generateMedicalResponse(message) {
  const medicalQuestions = {
    'commencer': `Parfait ! Commen√ßons par quelques questions essentielles :

ü©∏ **Connaissez-vous votre groupe sanguin ?** (A+, A-, B+, B-, AB+, AB-, O+, O-)

Tapez votre groupe sanguin ou "je ne sais pas"`,

    'groupe sanguin': 'Excellent ! Votre groupe sanguin est crucial en cas d\'urgence. Maintenant, **prenez-vous actuellement des m√©dicaments ?** Si oui, listez-les avec leur dosage.',

    'medicament': `Merci pour ces informations. Maintenant, **avez-vous des allergies ?** 

Les allergies courantes incluent :
‚Ä¢ P√©nicilline, Aspirine
‚Ä¢ Arachides, Fruits de mer
‚Ä¢ Latex, Iode
‚Ä¢ Autres m√©dicaments

Listez toutes vos allergies connues.`,

    'allergie': `Important ! Vos allergies sont not√©es. **Avez-vous des ant√©c√©dents m√©dicaux ou conditions chroniques ?**

Exemples : Diab√®te, Hypertension, Asthme, √âpilepsie, etc.`,

    'antecedent': `Tr√®s bien. **Qui dois-je contacter en cas d'urgence ?**

Donnez-moi :
‚Ä¢ Nom complet
‚Ä¢ Relation (conjoint, parent, ami...)
‚Ä¢ Num√©ro de t√©l√©phone`,

    'contact': `Excellent ! Vos informations sont maintenant plus compl√®tes. **Y a-t-il des informations critiques que les secours devraient absolument conna√Ætre ?**

Par exemple : pacemaker, dialyse, handicap, etc.`,

    'aide': `Je peux vous aider avec :
‚Ä¢ ü©∏ Groupe sanguin
‚Ä¢ üíä M√©dicaments actuels  
‚Ä¢ üö´ Allergies
‚Ä¢ üè• Ant√©c√©dents m√©dicaux
‚Ä¢ üìû Contact d'urgence
‚Ä¢ ‚ö†Ô∏è Notes critiques

Tapez le sujet qui vous int√©resse !`
  };

  // Rechercher une r√©ponse appropri√©e
  for (const [keyword, response] of Object.entries(medicalQuestions)) {
    if (message.includes(keyword)) {
      return response;
    }
  }

  // R√©ponse par d√©faut
  return `Je ne comprends pas cette question m√©dicale. Tapez "aide" pour voir les sujets que je peux traiter, ou "commencer" pour l'√©valuation compl√®te.`;
}

function calculateCompletionFields(user) {
  let completed = 0;
  const total = 10;
  
  if (user.personalInfo?.firstName) completed++;
  if (user.personalInfo?.lastName) completed++;
  if (user.personalInfo?.dateOfBirth) completed++;
  if (user.personalInfo?.bloodType) completed++;
  if (user.personalInfo?.emergencyContact?.name) completed++;
  if (user.personalInfo?.emergencyContact?.phone) completed++;
  if (user.medicalHistory?.allergies?.length > 0) completed++;
  if (user.medicalHistory?.medications?.length > 0) completed++;
  if (user.medicalHistory?.chronicDiseases?.length > 0) completed++;
  if (user.emergencyInfo?.criticalNotes) completed++;
  
  return { completed, total };
}

// Fonction de d√©connexion simplifi√©e
function logout() {
  if (confirm('Voulez-vous vraiment vous d√©connecter ?')) {
    clearUser();
    if (auth && auth.currentUser) {
      auth.signOut();
    }
    showLogin();
  }
}

// Ic√¥nes manquantes
if (!icons.arrow) {
  icons.arrow = '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>';
}

// ========== OPTIMISATIONS MOBILE FINALES ==========

// Fonction de diagnostic et r√©paration pour mobile
window.diagnosticAndRepair = function() {
  console.log("üîß Diagnostic et r√©paration en cours...");
  
  const issues = [];
  const repairs = [];
  
  // V√©rifier la m√©moire
  if (performance.memory) {
    const memoryUsage = performance.memory.usedJSHeapSize / performance.memory.jsHeapSizeLimit;
    if (memoryUsage > 0.8) {
      issues.push("M√©moire satur√©e");
      repairs.push("Nettoyage de la m√©moire");
    }
  }
  
  // V√©rifier le localStorage
  try {
    const testKey = 'syl-test-' + Date.now();
    localStorage.setItem(testKey, 'test');
    localStorage.removeItem(testKey);
  } catch (e) {
    issues.push("Stockage local plein");
    repairs.push("Nettoyage du stockage");
  }
  
  // V√©rifier Firebase
  if (!firebase || !db || !auth) {
    issues.push("Firebase non initialis√©");
    repairs.push("R√©initialisation Firebase");
  }
  
  // Effectuer les r√©parations
  if (issues.length > 0) {
    console.log("üö® Probl√®mes d√©tect√©s:", issues);
    console.log("üîß R√©parations:", repairs);
    
    // Nettoyer la m√©moire
    if (window.gc) {
      window.gc();
    }
    
    // Nettoyer le cache
    clearExpiredCache();
    
    // Note: Firebase sera r√©initialis√© naturellement au prochain chargement
    console.log("‚ö†Ô∏è Probl√®mes d√©tect√©s mais pas de rechargement automatique");
    
    return false;
  }
  
  console.log("‚úÖ Aucun probl√®me d√©tect√©");
  return true;
};

// Nettoyage du cache expir√©
function clearExpiredCache() {
  const now = Date.now();
  const maxAge = 7 * 24 * 60 * 60 * 1000; // 7 jours
  
  Object.keys(localStorage).forEach(key => {
    if (key.startsWith('syl-cache-')) {
      try {
        const item = JSON.parse(localStorage.getItem(key));
        if (item.timestamp && (now - item.timestamp) > maxAge) {
          localStorage.removeItem(key);
          console.log("üóëÔ∏è Cache expir√© supprim√©:", key);
        }
      } catch (e) {
        // Supprimer les √©l√©ments corrompus
        localStorage.removeItem(key);
      }
    }
  });
}

// Fonction de synchronisation automatique des patients (100% FIREBASE - AUCUN localStorage)
window.autoSyncPatients = async function() {
  console.log("üîÑ Synchronisation automatique Firebase...");
  
  // V√©rifier si on est admin
  const localUser = getCurrentUser();
  if (!localUser || localUser.role !== 'admin') {
    console.log("üë§ Auto-sync : r√©serv√© aux admins");
    return;
  }
  
  // V√©rifier si Firebase est disponible
  if (!firebase || !db || typeof db.collection !== 'function') {
    console.log("üî• Auto-sync : Firebase non disponible");
    return;
  }
  
  try {
    // Charger UNIQUEMENT depuis Firebase
    const patientsSnapshot = await db.collection('patients').get();
    const patients = [];
    
    patientsSnapshot.forEach(doc => {
      patients.push({
        id: doc.id,
        ...doc.data()
      });
    });
    
    console.log(`üìä Firebase: ${patients.length} patients synchronis√©s`);
    
    // V√©rifier s'il y a des utilisateurs √† migrer vers patients
    const usersSnapshot = await db.collection('users').where('role', '==', 'patient').get();
    let newPatients = 0;
    
    for (const userDoc of usersSnapshot.docs) {
      const userData = userDoc.data();
      const userId = userDoc.id;
      
      // V√©rifier si ce patient existe d√©j√†
      const existsInPatients = patients.some(p => p.uid === userId || p.id === userId);
      
      if (!existsInPatients) {
        // Migrer vers patients
        console.log(`üîÑ Migration: ${userData.email} ‚Üí collection patients`);
        await db.collection('patients').doc(userId).set({
          uid: userId,
          id: userId,
          email: userData.email,
          role: 'patient',
          ...userData,
          migratedFrom: 'users',
          migratedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
        newPatients++;
      }
    }
    
    if (newPatients > 0) {
      console.log(`‚úÖ Auto-sync: ${newPatients} patients migr√©s de users ‚Üí patients`);
    } else {
      console.log(`‚úÖ Auto-sync: Aucune migration n√©cessaire`);
    }
    
  } catch (error) {
    console.error(`‚ùå Erreur auto-sync:`, error);
  }
};

// Fonction pour afficher une notification discr√®te
function showDiscreetNotification(message) {
  const notification = document.createElement('div');
  notification.className = 'fixed bottom-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300';
  notification.textContent = message;
  
  document.body.appendChild(notification);
  
  // Animation d'entr√©e
  setTimeout(() => {
    notification.classList.remove('translate-x-full');
  }, 100);
  
  // Animation de sortie et suppression
  setTimeout(() => {
    notification.classList.add('translate-x-full');
    setTimeout(() => {
      document.body.removeChild(notification);
    }, 300);
  }, 3000);
}

// Fonction de synchronisation forc√©e pour mobile
window.forceMobileSync = function() {
  console.log("üîÑ Synchronisation forc√©e pour mobile...");
  
  // 1. Nettoyer tout le cache navigateur
  if ('caches' in window) {
    caches.keys().then(names => {
      names.forEach(name => caches.delete(name));
      console.log("üóëÔ∏è Cache navigateur nettoy√©");
    });
  }
  
  // 2. Nettoyer le localStorage (sauf donn√©es utilisateur critiques)
  const itemsToKeep = ['syl-user', 'syl-app-version', 'syl-build-date'];
  const allKeys = Object.keys(localStorage);
  
  allKeys.forEach(key => {
    if (!itemsToKeep.includes(key)) {
      localStorage.removeItem(key);
    }
  });
  console.log("üóëÔ∏è LocalStorage nettoy√©");
  
  // 3. D√©sactiver le cache pour cette session
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistrations().then(registrations => {
      registrations.forEach(registration => {
        registration.unregister();
      });
      console.log("üóëÔ∏è Service Workers d√©sactiv√©s");
    });
  }
  
  // 4. Forcer le rechargement des donn√©es depuis Firebase
  if (window.loadPatientsFromFirebase) {
    window.loadPatientsFromFirebase().then(() => {
      console.log("‚úÖ Donn√©es Firebase recharg√©es");
      // Forcer le re-render de l'interface
      if (window.renderApp) {
        window.renderApp();
      }
    }).catch(err => {
      console.error("‚ùå Erreur rechargement Firebase:", err);
      // En cas d'erreur, rechargement complet
      location.reload(true);
    });
  } else {
    // Si pas d'acc√®s Firebase, rechargement complet
    location.reload(true);
  }
  
  return true;
};

// Optimisations automatiques pour mobile
if (window.innerWidth <= 768) {
  console.log("üì± Activation des optimisations mobile");
  
  // Diagnostic √† la demande uniquement (pas automatique)
  console.log("‚úÖ Diagnostic disponible via diagnosticAndRepair()");
  
  // Nettoyage pr√©ventif du cache toutes les heures
  setInterval(clearExpiredCache, 60 * 60 * 1000);
  
  // Auto-synchronisation des nouveaux patients (mobile) - plus fr√©quente
  setInterval(async () => {
    try {
      await window.autoSyncPatients();
    } catch (err) {
      console.log("Auto-sync mobile error:", err);
    }
  }, 2 * 60 * 1000); // Toutes les 2 minutes sur mobile
  
  // Optimiser les performances de Firebase sur mobile
  if (db) {
    db.enablePersistence({ synchronizeTabs: false }).catch(err => {
      console.log("Persistence d√©j√† activ√©e:", err);
    });
  }
  
  // Pr√©charger les images critiques
  const criticalImages = [
    'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA4MDAgODAwIj48YyB4PSI4MDAiIHk9IjQ3MiIgY3g9IjE5MiIgY3k9IjI4IiByPSI1MiIvPjwvc3ZnPg=='
  ];
  
  criticalImages.forEach(src => {
    const img = new Image();
    img.src = src;
  });
} else {
  console.log("üíª Activation des optimisations PC");
  
  // Auto-synchronisation des nouveaux patients (PC) - moins fr√©quente
  setInterval(async () => {
    try {
      await window.autoSyncPatients();
    } catch (err) {
      console.log("Auto-sync PC error:", err);
    }
  }, 5 * 60 * 1000); // Toutes les 5 minutes sur PC
}

// Gestionnaire de visibilit√© de la page pour √©conomiser la batterie
document.addEventListener('visibilitychange', function() {
  if (document.hidden) {
    console.log("üì± Page cach√©e, r√©duction de l'activit√©");
    // R√©duire les timers et animations
  } else {
    console.log("üì± Page visible, reprise normale");
    // V√©rifier si une mise √† jour est n√©cessaire
    checkAndUpdateVersion();
    
    // Synchroniser les nouveaux patients quand l'onglet redevient actif
    setTimeout(async () => {
      try {
        console.log("üëÅÔ∏è Page redevenue visible - auto-sync");
        await window.autoSyncPatients();
      } catch (err) {
        console.log("Auto-sync au retour √©chou√©:", err);
      }
    }, 1000);
  }
});

// Message de debug pour les d√©veloppeurs
console.log(`üöÄ SYL Medical ${APP_VERSION} (${BUILD_DATE}) - Optimis√© pour mobile`);

// ========== SYST√àME DE DEBUG FIREBASE AVANC√â ==========

// Analyseur automatique des collections Firebase
window.debugFirebaseCollections = async function() {
  if (!db) {
    console.error("‚ùå Firebase non initialis√©");
    return;
  }
  
  console.log("üîç ANALYSE COMPL√àTE DES COLLECTIONS FIREBASE");
  console.log("=".repeat(60));
  
  const collections = ['patients', 'users', 'activeUsers', 'nfcTags', 'admins'];
  const analysis = {};
  
  for (const collectionName of collections) {
    try {
      console.log(`\nüìÅ Analyse de la collection "${collectionName}"...`);
      
      const snapshot = await db.collection(collectionName).get();
      const docs = [];
      const fieldStats = {};
      const typeStats = {};
      
      snapshot.forEach(doc => {
        const data = doc.data();
        docs.push({
          id: doc.id,
          data: data,
          size: JSON.stringify(data).length
        });
        
        // Analyser les champs et types
        analyzeFields(data, fieldStats, typeStats, '');
      });
      
      analysis[collectionName] = {
        count: docs.length,
        docs: docs,
        fieldStats: fieldStats,
        typeStats: typeStats,
        totalSize: docs.reduce((sum, doc) => sum + doc.size, 0)
      };
      
      // Afficher l'analyse
      console.log(`üìä Collection "${collectionName}":`);
      console.log(`   ‚Ä¢ Documents: ${docs.length}`);
      console.log(`   ‚Ä¢ Taille totale: ${(analysis[collectionName].totalSize / 1024).toFixed(2)} KB`);
      console.log(`   ‚Ä¢ Champs uniques: ${Object.keys(fieldStats).length}`);
      
      // Afficher les champs les plus fr√©quents
      const sortedFields = Object.entries(fieldStats)
        .sort((a, b) => b[1].count - a[1].count)
        .slice(0, 10);
      
      console.log(`   ‚Ä¢ Top champs:`);
      sortedFields.forEach(([field, stats]) => {
        const coverage = ((stats.count / docs.length) * 100).toFixed(1);
        // Protection pour √©viter les erreurs de type
        const typesSet = stats.types instanceof Set ? stats.types : new Set(Array.isArray(stats.types) ? stats.types : []);
        const typesArray = Array.from(typesSet);
        console.log(`     - ${field}: ${stats.count}/${docs.length} (${coverage}%) [${typesArray.join(', ')}]`);
      });
      
      // D√©tecter les incoh√©rences
      const inconsistencies = detectInconsistencies(docs, fieldStats);
      if (inconsistencies.length > 0) {
        console.warn(`   ‚ö†Ô∏è Incoh√©rences d√©tect√©es:`);
        inconsistencies.forEach(inc => console.warn(`     - ${inc}`));
      }
      
    } catch (error) {
      console.error(`‚ùå Erreur analyse collection "${collectionName}":`, error.message);
      analysis[collectionName] = { error: error.message };
    }
  }
  
  // G√©n√©rer des recommandations de nettoyage
  console.log("\nüõ†Ô∏è RECOMMANDATIONS DE NETTOYAGE:");
  console.log("=".repeat(40));
  generateCleanupRecommendations(analysis);
  
  // R√©sum√© global
  const successCount = Object.values(analysis).filter(data => !data.error).length;
  const errorCount = Object.values(analysis).filter(data => data.error).length;
  console.log(`\nüìä R√âSUM√â: ${successCount} collections analys√©es, ${errorCount} erreurs de permissions`);
  
  if (errorCount > 0) {
    console.log("\nüí° SOLUTION pour les erreurs de permissions:");
    console.log("1. V√©rifiez les r√®gles Firestore dans Firebase Console");
    console.log("2. Ajoutez les permissions pour ces collections:");
    Object.entries(analysis).forEach(([collection, data]) => {
      if (data.error && data.error.includes('permissions')) {
        console.log(`   - ${collection}: allow read: if isAdmin();`);
      }
    });
  }
  
  return analysis;
};

// Fonction d'analyse r√©cursive des champs
function analyzeFields(obj, fieldStats, typeStats, prefix = '') {
  if (!obj || typeof obj !== 'object') return;
  
  Object.entries(obj).forEach(([key, value]) => {
    const fieldPath = prefix ? `${prefix}.${key}` : key;
    const valueType = getDetailedType(value);
    
    if (!fieldStats[fieldPath]) {
      fieldStats[fieldPath] = { count: 0, types: new Set() };
    }
    
    fieldStats[fieldPath].count++;
    fieldStats[fieldPath].types.add(valueType);
    
    typeStats[valueType] = (typeStats[valueType] || 0) + 1;
    
    // Analyse r√©cursive pour les objets
    if (valueType === 'object' && value !== null) {
      analyzeFields(value, fieldStats, typeStats, fieldPath);
    }
  });
}

// D√©tection du type d√©taill√©
function getDetailedType(value) {
  if (value === null) return 'null';
  if (value === undefined) return 'undefined';
  if (Array.isArray(value)) return 'array';
  if (value instanceof Date) return 'date';
  if (typeof value === 'object' && value.seconds !== undefined) return 'timestamp';
  return typeof value;
}

// D√©tection des incoh√©rences
function detectInconsistencies(docs, fieldStats) {
  const issues = [];
  
  // Champs avec types multiples
  Object.entries(fieldStats).forEach(([field, stats]) => {
    // Protection pour √©viter les erreurs de type
    const typesSet = stats.types instanceof Set ? stats.types : new Set(Array.isArray(stats.types) ? stats.types : []);
    if (typesSet.size > 1) {
      const typesArray = Array.from(typesSet);
      issues.push(`"${field}" a plusieurs types: ${typesArray.join(', ')}`);
    }
  });
  
  // Documents avec structures tr√®s diff√©rentes
  if (docs.length > 1) {
    const fieldCounts = docs.map(doc => Object.keys(flattenObject(doc.data)).length);
    const avgFields = fieldCounts.reduce((a, b) => a + b, 0) / fieldCounts.length;
    const outliers = docs.filter((doc, i) => Math.abs(fieldCounts[i] - avgFields) > avgFields * 0.5);
    
    if (outliers.length > 0) {
      issues.push(`${outliers.length} documents avec structure atypique`);
    }
  }
  
  return issues;
}

// Aplatir un objet pour compter les champs
function flattenObject(obj, prefix = '') {
  const flattened = {};
  Object.entries(obj || {}).forEach(([key, value]) => {
    const newKey = prefix ? `${prefix}.${key}` : key;
    if (value && typeof value === 'object' && !Array.isArray(value)) {
      Object.assign(flattened, flattenObject(value, newKey));
    } else {
      flattened[newKey] = value;
    }
  });
  return flattened;
}

// G√©n√©rer des recommandations de nettoyage
function generateCleanupRecommendations(analysis) {
  Object.entries(analysis).forEach(([collection, data]) => {
    if (data.error) {
      if (data.error.includes('permissions')) {
        console.log(`üîí ${collection}: Permissions insuffisantes - Collection accessible mais lecture limit√©e`);
      } else {
        console.log(`‚ùå ${collection}: Erreur technique - ${data.error}`);
      }
      return;
    }
    
    console.log(`\nüìÅ ${collection.toUpperCase()}:`);
    
    if (data.count === 0) {
      console.log(`   ‚Ä¢ Collection vide - ${collection === 'nfcTags' ? 'Normal (fonctionnalit√© future)' : 'Consid√©rer la suppression'}`);
      return;
    }
    
    // Recommandations bas√©es sur les champs
    const requiredFields = getRequiredFieldsForCollection(collection);
    const missingFields = requiredFields.filter(field => 
      !data.fieldStats[field] || data.fieldStats[field].count < data.count * 0.8
    );
    
    if (missingFields.length > 0) {
      console.log(`   ‚Ä¢ Champs manquants (>20%): ${missingFields.join(', ')}`);
    } else {
      console.log(`   ‚Ä¢ ‚úÖ Structure conforme - Tous les champs requis pr√©sents`);
    }
    
    // Champs avec types incoh√©rents
    const inconsistentFields = Object.entries(data.fieldStats)
      .filter(([field, stats]) => {
        const typesSet = stats.types instanceof Set ? stats.types : new Set(Array.isArray(stats.types) ? stats.types : []);
        return typesSet.size > 1;
      })
      .map(([field]) => field);
    
    if (inconsistentFields.length > 0) {
      console.log(`   ‚Ä¢ ‚ö†Ô∏è Types incoh√©rents: ${inconsistentFields.join(', ')}`);
    }
    
    // Taille excessive
    if (data.totalSize > 100000) { // > 100KB
      console.log(`   ‚Ä¢ üì¶ Taille importante: ${(data.totalSize / 1024).toFixed(2)} KB - Optimisation recommand√©e`);
    }
    
    // Complexit√© des documents
    if (data.docs.length > 0) {
      const avgFields = Object.keys(data.fieldStats).length / data.docs.length;
      if (avgFields > 50) {
        console.log(`   ‚Ä¢ üîß Structure complexe: ${avgFields.toFixed(1)} champs/document en moyenne`);
      }
    }
  });
}

// D√©finir les champs requis par collection
function getRequiredFieldsForCollection(collection) {
  const schemas = {
    patients: ['id', 'email', 'personalInfo.firstName', 'personalInfo.lastName', 'role'],
    users: ['uid', 'email', 'role'],
    activeUsers: ['email', 'isOnline', 'lastLogin'],
    nfcTags: ['id', 'patientId', 'isActive'],
    admins: ['uid', 'email', 'permissions']
  };
  return schemas[collection] || [];
}

// Nettoyage automatique des donn√©es
window.cleanupFirebaseData = async function(options = {}) {
  console.log("üßπ NETTOYAGE AUTOMATIQUE DES DONN√âES");
  console.log("=".repeat(40));
  
  const {
    dryRun = true,
    fixTypes = true,
    addMissingFields = true,
    removeEmptyCollections = false
  } = options;
  
  if (dryRun) {
    console.log("üîç MODE TEST - Aucune modification ne sera effectu√©e");
  }
  
  const analysis = await window.debugFirebaseCollections();
  const cleanupActions = [];
  
  for (const [collection, data] of Object.entries(analysis)) {
    if (data.error) continue;
    
    for (const doc of data.docs) {
      const fixes = await generateDocumentFixes(collection, doc, data.fieldStats);
      if (fixes.length > 0) {
        cleanupActions.push({
          collection,
          docId: doc.id,
          fixes: fixes
        });
      }
    }
  }
  
  console.log(`\nüìã ${cleanupActions.length} actions de nettoyage identifi√©es`);
  
  if (!dryRun && cleanupActions.length > 0) {
    console.log("üîß Application des corrections...");
    // Appliquer les corrections ici
    for (const action of cleanupActions) {
      await applyDocumentFixes(action);
    }
    console.log("‚úÖ Nettoyage termin√©");
  }
  
  return cleanupActions;
};

// G√©n√©rer les corrections pour un document
async function generateDocumentFixes(collection, doc, fieldStats) {
  const fixes = [];
  const schema = getStandardSchema(collection);
  
  // Ajouter les champs manquants
  Object.entries(schema).forEach(([field, defaultValue]) => {
    if (!hasNestedField(doc.data, field)) {
      fixes.push({
        type: 'add_field',
        field: field,
        value: defaultValue
      });
    }
  });
  
  // Corriger les types incoh√©rents
  Object.entries(fieldStats).forEach(([field, stats]) => {
    if (stats.types.size > 1) {
      const currentValue = getNestedField(doc.data, field);
      const expectedType = getMostCommonType(stats.types);
      if (currentValue !== undefined && getDetailedType(currentValue) !== expectedType) {
        fixes.push({
          type: 'fix_type',
          field: field,
          currentValue: currentValue,
          expectedType: expectedType
        });
      }
    }
  });
  
  return fixes;
}

// Sch√©mas standards pour chaque collection
function getStandardSchema(collection) {
  const schemas = {
    patients: {
      'id': '',
      'email': '',
      'role': 'patient',
      'personalInfo.firstName': '',
      'personalInfo.lastName': '',
      'personalInfo.birthDate': '',
      'personalInfo.phone': '',
      'personalInfo.address': '',
      'personalInfo.bloodType': '',
      'medicalInfo.allergies': [],
      'medicalInfo.medications': [],
      'medicalInfo.conditions': [],
      'medicalInfo.emergencyNotes': '',
      'emergencyContact.name': '',
      'emergencyContact.relationship': '',
      'emergencyContact.phone': '',
      'isActive': true,
      'nfcTagId': null,
      'createdAt': new Date().toISOString(),
      'lastModified': firebase.firestore.FieldValue.serverTimestamp()
    },
    users: {
      'uid': '',
      'email': '',
      'role': 'patient',
      'profile.firstName': '',
      'profile.lastName': '',
      'profile.phone': '',
      'createdAt': new Date().toISOString()
    },
    nfcTags: {
      'id': '',
      'patientId': null,
      'isActive': true,
      'createdAt': new Date().toISOString()
    }
  };
  return schemas[collection] || {};
}

// Utilitaires pour les champs imbriqu√©s
function hasNestedField(obj, path) {
  return path.split('.').reduce((current, key) => current && current[key] !== undefined, obj);
}

function getNestedField(obj, path) {
  return path.split('.').reduce((current, key) => current && current[key], obj);
}

function getMostCommonType(types) {
  const typeArray = Array.from(types);
  if (typeArray.includes('string')) return 'string';
  if (typeArray.includes('object')) return 'object';
  if (typeArray.includes('array')) return 'array';
  return typeArray[0] || 'unknown';
}

// Fonctions de debug pour la synchronisation automatique
window.debugAutoSync = async function() {
  console.log("üìä √âtat de la synchronisation:");
  console.log("‚Ä¢ Source de donn√©es: 100% Firebase (aucun localStorage)");
  console.log("‚Ä¢ Plateforme:", window.innerWidth <= 768 ? "Mobile (sync 2min)" : "PC (sync 5min)");
  
  try {
    const patientsSnapshot = await db.collection('patients').get();
    console.log("‚Ä¢ Patients Firebase:", patientsSnapshot.size);
    
    if (patientsSnapshot.size > 0) {
      const fields = patientsSnapshot.docs.map(doc => Object.keys(flattenObject(doc.data())).length);
      console.log("‚Ä¢ Complexit√© moyenne:", (fields.reduce((a,b) => a+b, 0) / fields.length).toFixed(1), "champs/patient");
    }
  } catch (error) {
    console.error("‚ùå Erreur lecture Firebase:", error);
  }
};

window.forceAutoSync = function() {
  console.log("üîÑ Synchronisation manuelle forc√©e...");
  return window.autoSyncPatients();
};

// Appliquer les corrections √† un document
async function applyDocumentFixes(action) {
  if (!db) return;
  
  try {
    const docRef = db.collection(action.collection).doc(action.docId);
    const updateData = {};
    
    for (const fix of action.fixes) {
      switch (fix.type) {
        case 'add_field':
          setNestedField(updateData, fix.field, fix.value);
          console.log(`‚ûï Ajout ${fix.field} = ${fix.value} dans ${action.collection}/${action.docId}`);
          break;
          
        case 'fix_type':
          const convertedValue = convertType(fix.currentValue, fix.expectedType);
          setNestedField(updateData, fix.field, convertedValue);
          console.log(`üîß Conversion ${fix.field}: ${fix.currentValue} ‚Üí ${convertedValue} dans ${action.collection}/${action.docId}`);
          break;
      }
    }
    
    if (Object.keys(updateData).length > 0) {
      await docRef.update(updateData);
      console.log(`‚úÖ Document ${action.docId} mis √† jour`);
    }
    
  } catch (error) {
    console.error(`‚ùå Erreur correction ${action.collection}/${action.docId}:`, error.message);
  }
}

// D√©finir une valeur dans un objet avec un chemin imbriqu√©
function setNestedField(obj, path, value) {
  const keys = path.split('.');
  const lastKey = keys.pop();
  const target = keys.reduce((current, key) => {
    if (!current[key]) current[key] = {};
    return current[key];
  }, obj);
  target[lastKey] = value;
}

// Convertir un type vers un autre
function convertType(value, targetType) {
  switch (targetType) {
    case 'string':
      return String(value || '');
    case 'number':
      return Number(value) || 0;
    case 'boolean':
      return Boolean(value);
    case 'array':
      return Array.isArray(value) ? value : [];
    case 'object':
      return (value && typeof value === 'object') ? value : {};
    case 'timestamp':
      return firebase.firestore.FieldValue.serverTimestamp();
    default:
      return value;
  }
}

// Migrer automatiquement les donn√©es vers une structure normalis√©e
window.migrateToStandardSchema = async function(collection = null) {
  console.log("üöÄ MIGRATION VERS SCH√âMA STANDARD");
  console.log("=".repeat(40));
  
  const collectionsToMigrate = collection ? [collection] : ['patients', 'users'];
  
  for (const coll of collectionsToMigrate) {
    console.log(`\nüìÅ Migration de la collection "${coll}"...`);
    
    try {
      const snapshot = await db.collection(coll).get();
      let migratedCount = 0;
      
      for (const doc of snapshot.docs) {
        const data = doc.data();
        const standardizedData = standardizeDocument(coll, data);
        
        if (JSON.stringify(data) !== JSON.stringify(standardizedData)) {
          await doc.ref.set(standardizedData, { merge: true });
          migratedCount++;
          console.log(`‚úÖ Document ${doc.id} standardis√©`);
        }
      }
      
      console.log(`üìä Collection "${coll}": ${migratedCount} documents migr√©s sur ${snapshot.size}`);
      
    } catch (error) {
      console.error(`‚ùå Erreur migration "${coll}":`, error.message);
    }
  }
  
  console.log("\nüéâ Migration termin√©e !");
};

// Standardiser un document selon son type
function standardizeDocument(collection, data) {
  const standardized = { ...data };
  
  switch (collection) {
    case 'patients':
      return standardizePatientDocument(standardized);
    case 'users':
      return standardizeUserDocument(standardized);
    default:
      return standardized;
  }
}

// Standardiser un document patient
function standardizePatientDocument(data) {
  const standard = {
    id: data.id || data.uid || '',
    uid: data.uid || data.id || '',
    email: data.email || '',
    role: 'patient',
    personalInfo: {
      firstName: data.personalInfo?.firstName || data.firstName || data.profile?.firstName || '',
      lastName: data.personalInfo?.lastName || data.lastName || data.profile?.lastName || '',
      birthDate: data.personalInfo?.birthDate || data.birthDate || '',
      phone: data.personalInfo?.phone || data.phone || data.profile?.phone || '',
      address: data.personalInfo?.address || data.address || '',
      bloodType: data.personalInfo?.bloodType || data.bloodType || ''
    },
    medicalInfo: {
      allergies: data.medicalInfo?.allergies || data.allergies || [],
      medications: data.medicalInfo?.medications || data.medications || [],
      conditions: data.medicalInfo?.conditions || data.conditions || [],
      emergencyNotes: data.medicalInfo?.emergencyNotes || data.emergencyNotes || ''
    },
    emergencyContact: {
      name: data.emergencyContact?.name || '',
      relationship: data.emergencyContact?.relationship || '',
      phone: data.emergencyContact?.phone || ''
    },
    isActive: data.isActive !== undefined ? data.isActive : true,
    nfcTagId: data.nfcTagId || null,
    createdAt: data.createdAt || data.timestamp || new Date().toISOString(),
    lastModified: firebase.firestore.FieldValue.serverTimestamp()
  };
  
  return standard;
}

// Standardiser un document utilisateur
function standardizeUserDocument(data) {
  return {
    uid: data.uid || data.id || '',
    email: data.email || '',
    role: data.role || 'patient',
    profile: {
      firstName: data.profile?.firstName || data.firstName || '',
      lastName: data.profile?.lastName || data.lastName || '',
      phone: data.profile?.phone || data.phone || ''
    },
    createdAt: data.createdAt || data.timestamp || new Date().toISOString(),
    lastModified: firebase.firestore.FieldValue.serverTimestamp()
  };
}

console.log("üõ†Ô∏è Fonctions debug disponibles:");
console.log("‚Ä¢ debugAutoSync() - Voir l'√©tat de sync");
console.log("‚Ä¢ forceAutoSync() - Forcer une sync maintenant");
console.log("‚Ä¢ forceMobileSync() - Sync compl√®te mobile");
console.log("‚Ä¢ debugFirebaseCollections() - Analyser toutes les collections");
console.log("‚Ä¢ cleanupFirebaseData({dryRun: false}) - Nettoyer les donn√©es");
console.log("‚Ä¢ migrateToStandardSchema() - Migrer vers sch√©ma standard");

// Fonction de diagnostic rapide
window.quickDiagnosis = async function() {
  console.log("üè• DIAGNOSTIC RAPIDE SYL MEDICAL");
  console.log("=".repeat(40));
  
  // √âtat Firebase
  console.log("üî• Firebase:", typeof firebase !== 'undefined' ? "‚úÖ OK" : "‚ùå Erreur");
  
  // √âtat de l'utilisateur
  const user = getUser();
  console.log("üë§ Utilisateur:", user ? `‚úÖ ${user.email} (${user.role})` : "‚ùå Non connect√©");
  
  // √âtat des collections (rapide)
  if (db) {
    try {
      const patientsCount = (await db.collection('patients').limit(1).get()).size;
      console.log("üìä Collections:", patientsCount >= 0 ? "‚úÖ Accessibles" : "‚ùå Inaccessibles");
    } catch (error) {
      console.log("üìä Collections:", "‚ùå Erreur permissions");
    }
  }
  
  // √âtat localStorage
  const localData = localStorage.getItem('syl-patients');
  console.log("üíæ Cache local:", localData ? "‚úÖ Pr√©sent" : "‚ö†Ô∏è Vide");
  
  // Recommandations
  console.log("\nüí° Actions recommand√©es:");
  if (!user) console.log("   ‚Ä¢ Se connecter avec un compte admin");
  if (db) console.log("   ‚Ä¢ Ex√©cuter debugFirebaseCollections() pour analyse compl√®te");
  else console.log("   ‚Ä¢ V√©rifier la configuration Firebase");
  
  return {
    firebase: typeof firebase !== 'undefined',
    user: user,
    collections: !!db,
    localStorage: !!localData
  };
};

// Test final de fonctionnement
setTimeout(() => {
  if (typeof renderApp === 'function') {
    console.log("‚úÖ Application pr√™te");
  } else {
    console.error("‚ùå Erreur critique: renderApp non d√©finie");
    location.reload();
  }
}, 2000);

// Nettoyage des listeners Firestore √† la fermeture de la page
window.addEventListener('beforeunload', async () => {
  console.log("üîÑ Nettoyage avant fermeture de page");
  cleanupRealtimeSync();
  
  // Marquer l'utilisateur comme hors ligne
  const user = getCurrentUser();
  if (user?.email) {
    await removeCurrentUserFromFirestore(user.email);
  }
});

// Gestion des erreurs globales pour Firestore
window.addEventListener('error', (event) => {
  if (event.error && event.error.message.includes('firestore')) {
    console.error("‚ùå Erreur Firestore globale:", event.error);
  }
});

console.log("üî• Syst√®me Firestore temps r√©el initialis√©");
</script>
</body>
</html>
