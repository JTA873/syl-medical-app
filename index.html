<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>SYL Medical - Système d'Urgence</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <style>
    .animate-spin { animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .modal-bg { background: rgba(0,0,0,0.5); }
    .modal { z-index: 50; }
    .icon { width: 1em; height: 1em; display: inline-block; vertical-align: middle; }
    .emergency-card { border-left: 4px solid #ef4444; }
    .critical-info { background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); }
  </style>
</head>
<body class="bg-gray-50">
<div id="app"></div>
<script>
// Configuration Firebase intégrée
const firebaseConfig = {
  apiKey: "AIzaSyDqII2vBhBybNhVcr1QktyhvVeBW2TO0KA",
  authDomain: "syl-medical-app-1c58a.firebaseapp.com",
  databaseURL: "https://syl-medical-app-1c58a-default-rtdb.firebaseio.com",
  projectId: "syl-medical-app-1c58a",
  storageBucket: "syl-medical-app-1c58a.firebasestorage.app",
  messagingSenderId: "765684422018",
  appId: "1:765684422018:web:19320fe1e546631fc86b9b",
  measurementId: "G-PD7TP5J233"
};

// Initialiser Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

// Configuration de l'authentification
const googleProvider = new firebase.auth.GoogleAuthProvider();
const phoneProvider = new firebase.auth.PhoneAuthProvider();

const icons = {
  heart: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path d="M12 21C12 21 7.5 16.5 4 12.5C1.5 9.5 3.5 5 8 5C10 5 12 7 12 7C12 7 14 5 16 5C20.5 5 22.5 9.5 20 12.5C16.5 16.5 12 21 12 21Z" stroke-width="2"/></svg>',
  user: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><circle cx="12" cy="8" r="4" stroke-width="2"/><path d="M6 20c0-2.22 3.58-4 6-4s6 1.78 6 4" stroke-width="2"/></svg>',
  stethoscope: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path d="M8 7v5a4 4 0 008 0V7" stroke-width="2"/><circle cx="12" cy="17" r="2" stroke-width="2"/></svg>',
  mail: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><rect x="3" y="5" width="18" height="14" rx="2"/><path d="M3 7l9 6 9-6" stroke-width="2"/></svg>',
  lock: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><rect x="5" y="11" width="14" height="9" rx="2"/><path d="M7 11V7a5 5 0 1110 0v4" stroke-width="2"/></svg>',
  eye: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M2 12s4-8 10-8 10 8 10 8-4 8-10 8-10-8-10-8z"/></svg>',
  eyeOff: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path d="M17.94 17.94A10.07 10.07 0 012 12s4-8 10-8a9.93 9.93 0 016.94 3.06"/><line x1="1" y1="1" x2="23" y2="23"/></svg>',
  plus: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>',
  trash: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><rect x="3" y="7" width="18" height="14" rx="2"/><line x1="8" y1="11" x2="8" y2="17"/><line x1="16" y1="11" x2="16" y2="17"/></svg>',
  check: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>',
  shield: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" /></svg>',
  smartphone: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><rect x="5" y="2" width="14" height="20" rx="2"/><circle cx="12" cy="18" r="1"/></svg>',
  clock: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
  alert: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><polygon points="12 2 2 22 22 22 12 2"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12" y2="8"/></svg>',
  activity: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>',
  users: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 00-3-3.87"/><path d="M9 21v-2a4 4 0 013-3.87"/><path d="M7 7a4 4 0 018 0"/><path d="M5 21v-2a4 4 0 013-3.87"/><path d="M5 7a4 4 0 018 0"/></svg>',
  userPlus: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 00-3-3.87"/><path d="M8 21v-2a4 4 0 013-3.87"/><path d="M12 7a4 4 0 018 0"/><path d="M2 8v6"/><path d="M5 11H2"/></svg>',
  edit: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path d="M11 4h2a2 2 0 012 2v6a2 2 0 01-2 2h-2a2 2 0 01-2-2V6a2 2 0 012-2z"/><path d="M19 20v-2a2 2 0 00-2-2h-2a2 2 0 00-2 2v2"/></svg>',
  logout: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>',
  search: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>',
  settings: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 11-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09a1.65 1.65 0 00-1-1.51 1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 11-2.83-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09a1.65 1.65 0 001.51-1 1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06a1.65 1.65 0 001.82.33h.09a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51h.09a1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06a1.65 1.65 0 00-.33 1.82v.09a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>',
  phone: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 16.92z"/></svg>',
  calendar: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>',
  medical: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>',
  emergency: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>',
  cross: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>',
  warning: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
  fire: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path d="M8.5 14.5A2.5 2.5 0 0011 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 11-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 002.5 2.5z"/></svg>'
};

// Données de référence médicales
const MEDICAL_DATA = {
  bloodTypes: ['A+', 'A-', 'B+', 'B-', 'AB+', 'AB-', 'O+', 'O-'],
  chronicConditions: [
    'Diabète type 1', 'Diabète type 2', 'Hypertension artérielle', 'Insuffisance cardiaque',
    'Asthme', 'BPCO', 'Épilepsie', 'Maladie de Crohn', 'Polyarthrite rhumatoïde',
    'Sclérose en plaques', 'Maladie de Parkinson', 'Alzheimer', 'Insuffisance rénale',
    'Cirrhose', 'Cancer', 'VIH/SIDA', 'Hépatite B', 'Hépatite C', 'Hypothyroïdie',
    'Hyperthyroïdie', 'Fibromyalgie', 'Lupus', 'Bipolarité', 'Dépression majeure'
  ],
  commonAllergies: [
    'Pénicilline', 'Aspirine', 'Iode', 'Latex', 'Arachides', 'Fruits de mer',
    'Œufs', 'Lait', 'Soja', 'Gluten', 'Pollen', 'Acariens', 'Poils d\'animaux',
    'Morphine', 'Codéine', 'AINS', 'Sulfamides', 'Anesthésiques locaux'
  ],
  emergencyMedications: [
    'Adrénaline auto-injecteur', 'Ventoline', 'Glucagon', 'Insuline rapide',
    'Diazépam rectal', 'Trinitrine', 'Prednisone', 'Antihistaminiques',
    'Beta-bloquants', 'Digitaline', 'Warfarine', 'Héparine'
  ],
  medicalDevices: [
    'Pacemaker', 'Défibrillateur implantable', 'Pompe à insuline', 'Prothèse de hanche',
    'Prothèse de genou', 'Stent cardiaque', 'Valve cardiaque artificielle',
    'Implant cochléaire', 'Neurostimulateur', 'Port-à-cath', 'Sonde gastrique',
    'Cathéter urinaire', 'Dialyse péritonéale'
  ]
};

// Fonctions Firebase
async function saveToFirebase(collection, data, id = null) {
  try {
    if (id) {
      await db.collection(collection).doc(id).set(data);
    } else {
      await db.collection(collection).add(data);
    }
    console.log('Données sauvegardées dans Firebase');
    return true;
  } catch (error) {
    console.error('Erreur Firebase:', error);
    return false;
  }
}

async function loadFromFirebase(collection, id) {
  try {
    const doc = await db.collection(collection).doc(id).get();
    if (doc.exists) {
      return doc.data();
    }
    return null;
  } catch (error) {
    console.error('Erreur Firebase:', error);
    return null;
  }
}

function saveUser(user) {
  localStorage.setItem('syl-user', JSON.stringify(user));
  // Synchronisation Firebase automatique
  if (user.uid) {
    saveToFirebase('users', user, user.uid);
  }
}

function getUser() {
  const u = localStorage.getItem('syl-user');
  return u ? JSON.parse(u) : null;
}

function clearUser() {
  localStorage.removeItem('syl-user');
}

function showLogin() {
  document.getElementById('app').innerHTML = `
<div class="min-h-screen bg-gradient-to-br from-blue-50 via-white to-green-50 flex items-center justify-center p-4">
  <div class="w-full max-w-md">
    <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-8">
      <div class="text-center mb-8">
        <div class="mx-auto w-16 h-16 bg-gradient-to-r from-blue-600 to-green-600 rounded-full flex items-center justify-center mb-4">
          ${icons.heart}
        </div>
        <h1 class="text-2xl font-bold text-gray-900">SYL Medical</h1>
        <p class="text-gray-600 mt-2">Système d'Urgence Médicale</p>
      </div>

      <!-- Sélection du rôle -->
      <div class="grid grid-cols-2 gap-4 mb-6">
        <button type="button" id="rolePatient" class="p-3 rounded-lg border-2 border-blue-600 bg-blue-50 text-blue-700">
          ${icons.user} <span class="text-sm font-medium">Patient</span>
        </button>
        <button type="button" id="roleMedecin" class="p-3 rounded-lg border-2 border-gray-300 hover:border-gray-400">
          ${icons.stethoscope} <span class="text-sm font-medium">Médecin</span>
        </button>
      </div>

      <!-- Onglets de connexion -->
      <div class="flex space-x-2 mb-4">
        <button class="flex-1 py-2 px-4 text-sm rounded-lg bg-blue-600 text-white" id="tabEmail">Email</button>
        <button class="flex-1 py-2 px-4 text-sm rounded-lg bg-gray-200 text-gray-600" id="tabPhone">Téléphone</button>
        <button class="flex-1 py-2 px-4 text-sm rounded-lg bg-gray-200 text-gray-600" id="tabGoogle">Google</button>
      </div>

      <!-- Formulaire Email -->
      <div id="emailForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
          <div class="relative">
            <input type="email" id="email" required placeholder="votre@email.com"
              class="w-full px-3 py-2 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">${icons.mail}</span>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Mot de passe</label>
          <input type="password" id="password" required placeholder="••••••••"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"/>
        </div>
        <div class="flex space-x-2">
          <button id="loginEmail" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg px-6 py-3">
            ${icons.lock} Se connecter
          </button>
          <button id="registerEmail" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg px-6 py-3">
            ${icons.user} S'inscrire
          </button>
        </div>
      </div>

      <!-- Formulaire Téléphone -->
      <div id="phoneForm" class="space-y-4 hidden">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Numéro de téléphone</label>
          <input type="tel" id="phoneNumber" placeholder="+33 6 12 34 56 78"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"/>
        </div>
        <div id="recaptcha-container"></div>
        <button id="sendSMS" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-medium rounded-lg px-6 py-3">
          ${icons.smartphone} Envoyer SMS
        </button>
        <div id="codeVerification" class="space-y-4 hidden">
          <input type="text" id="verificationCode" placeholder="Code de vérification"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg"/>
          <button id="verifyCode" class="w-full bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg px-6 py-3">
            ${icons.check} Vérifier le code
          </button>
        </div>
      </div>

      <!-- Formulaire Google -->
      <div id="googleForm" class="hidden">
        <button id="loginGoogle" class="w-full bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg px-6 py-3 flex items-center justify-center gap-2">
          <svg class="w-5 h-5" viewBox="0 0 24 24"><path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
          Se connecter avec Google
        </button>
      </div>

      <div class="mt-8 pt-6 border-t border-gray-200">
        <div class="text-xs text-gray-500 space-y-1">
          <p>🚑 Accès d'urgence instantané</p>
          <p>🔒 Authentification Firebase sécurisée</p>
          <p>🏥 Conforme RGPD & HDS</p>
          <p>⚡ Synchronisation temps réel</p>
        </div>
      </div>
    </div>
  </div>
</div>
  `;

  let role = 'patient';
  let activeTab = 'email';
  let confirmationResult = null;

  // Gestion des rôles
  document.getElementById('rolePatient').onclick = () => {
    role = 'patient';
    document.getElementById('rolePatient').classList.add('border-blue-600', 'bg-blue-50', 'text-blue-700');
    document.getElementById('rolePatient').classList.remove('border-gray-300');
    document.getElementById('roleMedecin').classList.remove('border-green-600', 'bg-green-50', 'text-green-700');
    document.getElementById('roleMedecin').classList.add('border-gray-300');
  };
  document.getElementById('roleMedecin').onclick = () => {
    role = 'medecin';
    document.getElementById('roleMedecin').classList.add('border-green-600', 'bg-green-50', 'text-green-700');
    document.getElementById('roleMedecin').classList.remove('border-gray-300');
    document.getElementById('rolePatient').classList.remove('border-blue-600', 'bg-blue-50', 'text-blue-700');
    document.getElementById('rolePatient').classList.add('border-gray-300');
  };

  // Gestion des onglets
  function switchTab(tab) {
    activeTab = tab;
    document.querySelectorAll('[id^="tab"]').forEach(btn => {
      btn.classList.remove('bg-blue-600', 'text-white');
      btn.classList.add('bg-gray-200', 'text-gray-600');
    });
    document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.remove('bg-gray-200', 'text-gray-600');
    document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('bg-blue-600', 'text-white');
    
    document.querySelectorAll('[id$="Form"]').forEach(form => form.classList.add('hidden'));
    document.getElementById(tab + 'Form').classList.remove('hidden');
  }

  document.getElementById('tabEmail').onclick = () => switchTab('email');
  document.getElementById('tabPhone').onclick = () => switchTab('phone');
  document.getElementById('tabGoogle').onclick = () => switchTab('google');

  // Authentification par email
  document.getElementById('loginEmail').onclick = async () => {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    
    try {
      showLoader();
      const userCredential = await auth.signInWithEmailAndPassword(email, password);
      await handleAuthSuccess(userCredential.user, role);
    } catch (error) {
      hideLoader();
      alert('Erreur de connexion: ' + getErrorMessage(error.code));
    }
  };

  document.getElementById('registerEmail').onclick = async () => {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    
    if (password.length < 6) {
      alert('Le mot de passe doit contenir au moins 6 caractères');
      return;
    }
    
    try {
      showLoader();
      const userCredential = await auth.createUserWithEmailAndPassword(email, password);
      await handleAuthSuccess(userCredential.user, role);
    } catch (error) {
      hideLoader();
      alert('Erreur d\'inscription: ' + getErrorMessage(error.code));
    }
  };

  // Authentification par Google
  document.getElementById('loginGoogle').onclick = async () => {
    try {
      showLoader();
      const result = await auth.signInWithPopup(googleProvider);
      await handleAuthSuccess(result.user, role);
    } catch (error) {
      hideLoader();
      alert('Erreur de connexion Google: ' + getErrorMessage(error.code));
    }
  };

  // Authentification par SMS
  window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
    'size': 'normal',
    'callback': (response) => {
      document.getElementById('sendSMS').disabled = false;
    }
  });

  document.getElementById('sendSMS').onclick = async () => {
    const phoneNumber = document.getElementById('phoneNumber').value;
    
    try {
      confirmationResult = await auth.signInWithPhoneNumber(phoneNumber, window.recaptchaVerifier);
      document.getElementById('codeVerification').classList.remove('hidden');
      alert('SMS envoyé ! Vérifiez votre téléphone.');
    } catch (error) {
      alert('Erreur d\'envoi SMS: ' + getErrorMessage(error.code));
    }
  };

  document.getElementById('verifyCode').onclick = async () => {
    const code = document.getElementById('verificationCode').value;
    
    try {
      showLoader();
      const result = await confirmationResult.confirm(code);
      await handleAuthSuccess(result.user, role);
    } catch (error) {
      hideLoader();
      alert('Code incorrect');
    }
  };
}

async function handleAuthSuccess(firebaseUser, role) {
  try {
    const userData = {
      uid: firebaseUser.uid,
      email: firebaseUser.email,
      phone: firebaseUser.phoneNumber,
      displayName: firebaseUser.displayName,
      role: role,
      profile: {
        firstName: role === 'patient' ? (firebaseUser.displayName?.split(' ')[0] || 'Patient') : 'Dr. ' + (firebaseUser.displayName?.split(' ')[0] || 'Médecin'),
        lastName: firebaseUser.displayName?.split(' ').slice(1).join(' ') || '',
        phone: firebaseUser.phoneNumber || '',
        ...(role === 'medecin' && { 
          speciality: 'Médecine générale', 
          hospital: 'Établissement de santé' 
        })
      },
      createdAt: new Date().toISOString()
    };
    
    saveUser(userData);
    hideLoader();
    renderApp();
  } catch (error) {
    hideLoader();
    console.error('Erreur lors de la sauvegarde:', error);
    alert('Connexion réussie mais erreur de sauvegarde');
  }
}

function getErrorMessage(errorCode) {
  switch (errorCode) {
    case 'auth/user-not-found':
      return 'Aucun compte trouvé avec cet email';
    case 'auth/wrong-password':
      return 'Mot de passe incorrect';
    case 'auth/email-already-in-use':
      return 'Cet email est déjà utilisé';
    case 'auth/weak-password':
      return 'Mot de passe trop faible';
    case 'auth/invalid-email':
      return 'Email invalide';
    case 'auth/too-many-requests':
      return 'Trop de tentatives, réessayez plus tard';
    default:
      return errorCode;
  }
}

function hideLoader() {
  const loader = document.querySelector('.animate-spin')?.parentElement?.parentElement;
  if (loader) loader.remove();
}

function showLoader(callback = null) {
  document.getElementById('app').innerHTML = `
    <div class="min-h-screen bg-gray-50 flex items-center justify-center">
      <div class="text-center">
        <div class="w-16 h-16 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
        <p class="text-gray-600">Authentification en cours...</p>
      </div>
    </div>
  `;
  if (callback) setTimeout(callback, 800);
}

// ----------- PATIENT DASHBOARD -----------
function renderPatientDashboard(user) {
  let medicalData = JSON.parse(localStorage.getItem('syl-medicalData') || 'null');
  if (!medicalData) {
    medicalData = {
      personalInfo: {
        firstName: user.profile.firstName,
        lastName: user.profile.lastName,
        dateOfBirth: '',
        bloodType: '',
        height: '',
        weight: '',
        emergencyContact: { name: '', relation: '', phone: '' },
        secondaryContact: { name: '', relation: '', phone: '' },
        address: '',
        city: '',
        postalCode: '',
        nationalId: '',
        socialSecurityNumber: '',
        insuranceNumber: '',
        preferredHospital: '',
        organDonor: false,
        advanceDirectives: false
      },
      medicalHistory: {
        allergies: [],
        medications: [],
        conditions: [],
        surgeries: [],
        chronicDiseases: [],
        medicalDevices: [],
        emergencyMedications: []
      },
      emergencyInfo: {
        primaryPhysician: { name: '', phone: '', specialty: '' },
        pharmacist: { name: '', phone: '', address: '' },
        lastUpdate: new Date().toISOString(),
        criticalNotes: '',
        contraindications: [],
        riskFactors: []
      },
      braceletId: '',
      isActive: false
    };
  }
  localStorage.setItem('syl-medicalData', JSON.stringify(medicalData));
  let activeTab = 'emergency';
  render();

  function render() {
    document.getElementById('app').innerHTML = `
    <div class="min-h-screen bg-gray-50">
      <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center h-16">
          <div class="flex items-center">
            ${icons.heart}<h1 class="text-xl font-bold text-gray-900 ml-3">SYL Patient</h1>
          </div>
          <div class="flex items-center space-x-4">
            <div class="text-sm text-gray-600">Bonjour, ${user.profile.firstName}</div>
            <button id="logoutBtn" class="border-2 border-blue-600 text-blue-600 hover:bg-blue-50 font-medium rounded-lg px-4 py-2 flex items-center gap-2">${icons.logout} Déconnexion</button>
          </div>
        </div>
      </header>
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
          <div class="lg:col-span-1">
            <nav class="space-y-2">
              <button class="w-full flex items-center px-4 py-3 text-left rounded-lg transition-colors ${activeTab==='emergency' ? 'bg-red-100 text-red-700 border-l-4 border-red-600':'text-gray-600 hover:bg-gray-100'}" data-tab="emergency">${icons.emergency} <span class="ml-3">🚑 Urgence</span></button>
              <button class="w-full flex items-center px-4 py-3 text-left rounded-lg transition-colors ${activeTab==='profile' ? 'bg-blue-100 text-blue-700 border-l-4 border-blue-600':'text-gray-600 hover:bg-gray-100'}" data-tab="profile">${icons.user} <span class="ml-3">Profil complet</span></button>
              <button class="w-full flex items-center px-4 py-3 text-left rounded-lg transition-colors ${activeTab==='medical' ? 'bg-blue-100 text-blue-700 border-l-4 border-blue-600':'text-gray-600 hover:bg-gray-100'}" data-tab="medical">${icons.medical} <span class="ml-3">Médical</span></button>
              <button class="w-full flex items-center px-4 py-3 text-left rounded-lg transition-colors ${activeTab==='history' ? 'bg-blue-100 text-blue-700 border-l-4 border-blue-600':'text-gray-600 hover:bg-gray-100'}" data-tab="history">${icons.activity} <span class="ml-3">Historique</span></button>
              <button class="w-full flex items-center px-4 py-3 text-left rounded-lg transition-colors ${activeTab==='bracelet' ? 'bg-blue-100 text-blue-700 border-l-4 border-blue-600':'text-gray-600 hover:bg-gray-100'}" data-tab="bracelet">${icons.smartphone} <span class="ml-3">Bracelet</span></button>
            </nav>
          </div>
          <div class="lg:col-span-3">
            ${activeTab === 'emergency' ? renderEmergencyTab() : ''}
            ${activeTab === 'profile' ? renderProfileTab() : ''}
            ${activeTab === 'medical' ? renderMedicalTab() : ''}
            ${activeTab === 'history' ? renderHistoryTab() : ''}
            ${activeTab === 'bracelet' ? renderBraceletTab() : ''}
          </div>
        </div>
      </div>
    </div>
`;
    document.getElementById('logoutBtn').onclick = () => { logout(); };
    document.querySelectorAll('[data-tab]').forEach(btn => btn.onclick = () => { activeTab = btn.getAttribute('data-tab'); render(); });
    if (activeTab === 'emergency') tabEmergencyEvents();
    if (activeTab === 'profile') tabProfileEvents();
    if (activeTab === 'medical') tabMedicalEvents();
    if (activeTab === 'bracelet') tabBraceletEvents();
  }

  function renderEmergencyTab() {
    return `
      <div class="space-y-6">
        <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-lg">
          <div class="flex items-center">
            <div class="text-red-500 mr-3">${icons.emergency}</div>
            <h2 class="text-2xl font-bold text-red-800">INFORMATIONS D'URGENCE</h2>
          </div>
          <p class="text-red-700 mt-2">Ces informations sont critiques pour les secours</p>
        </div>

        <!-- Carte d'identité d'urgence -->
        <div class="bg-white rounded-xl shadow-lg border-l-4 border-red-500 p-6">
          <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
            ${icons.cross} <span class="ml-2">CARTE D'URGENCE MÉDICALE</span>
          </h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="space-y-4">
              <div class="bg-red-50 p-4 rounded-lg">
                <h4 class="font-bold text-red-800">IDENTITÉ</h4>
                <p><strong>Nom:</strong> ${medicalData.personalInfo.lastName}</p>
                <p><strong>Prénom:</strong> ${medicalData.personalInfo.firstName}</p>
                <p><strong>Né(e) le:</strong> ${medicalData.personalInfo.dateOfBirth}</p>
                <p><strong>Groupe sanguin:</strong> <span class="bg-red-600 text-white px-2 py-1 rounded font-bold">${medicalData.personalInfo.bloodType || 'NON RENSEIGNÉ'}</span></p>
              </div>
              <div class="bg-orange-50 p-4 rounded-lg">
                <h4 class="font-bold text-orange-800">CONTACTS D'URGENCE</h4>
                <p><strong>Principal:</strong> ${medicalData.personalInfo.emergencyContact.name} (${medicalData.personalInfo.emergencyContact.relation})</p>
                <p><strong>Tél:</strong> ${medicalData.personalInfo.emergencyContact.phone}</p>
                <p><strong>Secondaire:</strong> ${medicalData.personalInfo.secondaryContact.name}</p>
                <p><strong>Tél:</strong> ${medicalData.personalInfo.secondaryContact.phone}</p>
              </div>
            </div>
            <div class="space-y-4">
              <div class="bg-yellow-50 p-4 rounded-lg">
                <h4 class="font-bold text-yellow-800">⚠️ ALLERGIES CRITIQUES</h4>
                ${medicalData.medicalHistory.allergies.length ? medicalData.medicalHistory.allergies.map(a => `<span class="bg-red-500 text-white px-2 py-1 rounded text-sm mr-1 mb-1 inline-block">${a}</span>`).join('') : '<p class="text-gray-500">Aucune allergie connue</p>'}
              </div>
              <div class="bg-blue-50 p-4 rounded-lg">
                <h4 class="font-bold text-blue-800">💊 TRAITEMENTS EN COURS</h4>
                ${medicalData.medicalHistory.medications.length ? medicalData.medicalHistory.medications.slice(0,5).map(m => `<span class="bg-blue-500 text-white px-2 py-1 rounded text-sm mr-1 mb-1 inline-block">${m}</span>`).join('') : '<p class="text-gray-500">Aucun traitement</p>'}
              </div>
              <div class="bg-purple-50 p-4 rounded-lg">
                <h4 class="font-bold text-purple-800">🏥 PATHOLOGIES</h4>
                ${medicalData.medicalHistory.chronicDiseases.length ? medicalData.medicalHistory.chronicDiseases.map(c => `<span class="bg-purple-500 text-white px-2 py-1 rounded text-sm mr-1 mb-1 inline-block">${c}</span>`).join('') : '<p class="text-gray-500">Aucune pathologie chronique</p>'}
              </div>
            </div>
          </div>
          ${medicalData.emergencyInfo.criticalNotes ? `
          <div class="mt-6 bg-red-100 border border-red-300 p-4 rounded-lg">
            <h4 class="font-bold text-red-800 mb-2">🚨 NOTES CRITIQUES POUR LES SECOURS</h4>
            <p class="text-red-700">${medicalData.emergencyInfo.criticalNotes}</p>
          </div>
          ` : ''}
        </div>

        <!-- Médecin traitant -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">👨‍⚕️ Médecin traitant</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Dr. Nom" value="${medicalData.emergencyInfo.primaryPhysician.name}" id="physicianName">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Spécialité" value="${medicalData.emergencyInfo.primaryPhysician.specialty}" id="physicianSpecialty">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Téléphone" value="${medicalData.emergencyInfo.primaryPhysician.phone}" id="physicianPhone">
          </div>
        </div>

        <!-- Notes critiques -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">🚨 Notes critiques pour les secours</h3>
          <textarea class="w-full px-3 py-2 border border-gray-300 rounded-lg h-24" placeholder="Informations vitales à communiquer aux secours (ex: risque d'allergie, contre-indications spécifiques...)" id="criticalNotes">${medicalData.emergencyInfo.criticalNotes}</textarea>
        </div>

        <button id="saveEmergency" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg px-6 py-3 text-lg">
          ${icons.check} SAUVEGARDER LES INFOS D'URGENCE
        </button>
      </div>
    `;
  }

  function renderProfileTab() {
    return `
      <div class="space-y-6">
        <div class="flex justify-between items-center">
          <h2 class="text-2xl font-bold text-gray-900">Profil Complet</h2>
          <button id="saveProfile" class="bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg px-6 py-2 flex items-center gap-2">${icons.check} Sauvegarder</button>
        </div>

        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Informations personnelles</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Prénom" value="${medicalData.personalInfo.firstName}" id="pfFirstName">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Nom" value="${medicalData.personalInfo.lastName}" id="pfLastName">
            <input type="date" class="w-full px-3 py-2 border border-gray-300 rounded-lg" value="${medicalData.personalInfo.dateOfBirth}" id="pfBirth">
            <select class="w-full px-3 py-2 border border-gray-300 rounded-lg" id="pfBlood">
              <option value="">Groupe sanguin</option>
              ${MEDICAL_DATA.bloodTypes.map(type => `<option value="${type}" ${medicalData.personalInfo.bloodType===type?'selected':''}>${type}</option>`).join('')}
            </select>
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Taille (cm)" value="${medicalData.personalInfo.height}" id="pfHeight">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Poids (kg)" value="${medicalData.personalInfo.weight}" id="pfWeight">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="N° Sécurité Sociale" value="${medicalData.personalInfo.socialSecurityNumber}" id="pfSSN">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="N° Mutuelle" value="${medicalData.personalInfo.insuranceNumber}" id="pfInsurance">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Adresse" value="${medicalData.personalInfo.address}" id="pfAddress">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Ville" value="${medicalData.personalInfo.city}" id="pfCity">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Code postal" value="${medicalData.personalInfo.postalCode}" id="pfPostal">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Hôpital de référence" value="${medicalData.personalInfo.preferredHospital}" id="pfHospital">
          </div>
          
          <div class="mt-6 space-y-4">
            <h4 class="font-semibold text-gray-900">Contacts d'urgence</h4>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Contact principal" value="${medicalData.personalInfo.emergencyContact.name}" id="pfContact1Name">
              <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Relation" value="${medicalData.personalInfo.emergencyContact.relation}" id="pfContact1Rel">
              <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Téléphone" value="${medicalData.personalInfo.emergencyContact.phone}" id="pfContact1Phone">
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Contact secondaire" value="${medicalData.personalInfo.secondaryContact.name}" id="pfContact2Name">
              <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Relation" value="${medicalData.personalInfo.secondaryContact.relation}" id="pfContact2Rel">
              <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Téléphone" value="${medicalData.personalInfo.secondaryContact.phone}" id="pfContact2Phone">
            </div>
          </div>

          <div class="mt-6 space-y-2">
            <label class="flex items-center">
              <input type="checkbox" ${medicalData.personalInfo.organDonor ? 'checked' : ''} id="pfOrganDonor" class="mr-2">
              <span>Donneur d'organes</span>
            </label>
            <label class="flex items-center">
              <input type="checkbox" ${medicalData.personalInfo.advanceDirectives ? 'checked' : ''} id="pfDirectives" class="mr-2">
              <span>Directives anticipées rédigées</span>
            </label>
          </div>
        </div>
      </div>
    `;
  }

  function renderMedicalTab() {
    return `
      <div class="space-y-6">
        <h2 class="text-2xl font-bold text-gray-900">Dossier Médical Complet</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          ${renderMedicalListManager('Allergies', 'allergies', MEDICAL_DATA.commonAllergies)}
          ${renderMedicalListManager('Médicaments actuels', 'medications', MEDICAL_DATA.emergencyMedications)}
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          ${renderMedicalListManager('Pathologies chroniques', 'chronicDiseases', MEDICAL_DATA.chronicConditions)}
          ${renderMedicalListManager('Dispositifs médicaux', 'medicalDevices', MEDICAL_DATA.medicalDevices)}
        </div>
        
        ${renderMedicalListManager('Interventions chirurgicales', 'surgeries', [])}
        ${renderMedicalListManager('Médicaments d\'urgence', 'emergencyMedications', MEDICAL_DATA.emergencyMedications)}
        ${renderMedicalListManager('Contre-indications', 'contraindications', [])}
        ${renderMedicalListManager('Facteurs de risque', 'riskFactors', [])}
      </div>
    `;
  }

  function renderMedicalListManager(title, listType, suggestions) {
    const list = listType.includes('.') ? 
      medicalData.medicalHistory[listType.split('.')[1]] || medicalData.emergencyInfo[listType.split('.')[1]] :
      medicalData.medicalHistory[listType] || medicalData.emergencyInfo[listType] || [];
    
    return `
      <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">${title}</h3>
        <div class="space-y-3">
          <div class="flex gap-2">
            <input type="text" list="suggestions_${listType}" placeholder="Ajouter..." class="flex-1 px-3 py-2 border border-gray-300 rounded-lg" id="add_${listType}">
            <datalist id="suggestions_${listType}">
              ${suggestions.map(item => `<option value="${item}">`).join('')}
            </datalist>
            <button class="bg-blue-600 hover:bg-blue-700 text-white rounded-lg px-3 py-2" id="btn_${listType}">${icons.plus}</button>
          </div>
          <div class="space-y-2" id="list_${listType}">
            ${list.map((item, idx) => `
              <div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg">
                <span class="text-gray-700">${item}</span>
                <button class="text-red-600 hover:text-red-700" data-del="${listType}" data-idx="${idx}">${icons.trash}</button>
              </div>
            `).join('')}
          </div>
        </div>
      </div>
    `;
  }

  function renderHistoryTab() {
    return `<div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
      <h2 class="text-xl font-bold text-gray-900 mb-4">Historique médical</h2>
      <p class="text-gray-600">Aucune consultation enregistrée.</p>
      <div class="mt-4 p-4 bg-blue-50 rounded-lg">
        <p class="text-blue-700">Dernière mise à jour: ${new Date(medicalData.emergencyInfo.lastUpdate).toLocaleString('fr-FR')}</p>
      </div>
    </div>`;
  }

  function renderBraceletTab() {
    return `
      <div class="space-y-6">
        <h2 class="text-2xl font-bold text-gray-900">Bracelet SYL d'Urgence</h2>
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
          <div class="text-center">
            <div class="mx-auto w-24 h-24 bg-gradient-to-r from-red-600 to-orange-600 rounded-full flex items-center justify-center mb-4">${icons.smartphone}</div>
            <h3 class="text-xl font-semibold text-gray-900 mb-2">Bracelet d'urgence médicale</h3>
            <p class="text-gray-600 mb-6">${medicalData.isActive ? 'Votre bracelet est actif et accessible aux secours' : 'Activez votre bracelet pour l\'accès d\'urgence'}</p>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
              <div class="bg-red-50 p-4 rounded-lg">${icons.emergency}<p class="text-sm font-medium text-red-700">Accès Urgence 24h/24</p></div>
              <div class="bg-blue-50 p-4 rounded-lg">${icons.shield}<p class="text-sm font-medium text-blue-700">NFC Sécurisé</p></div>
              <div class="bg-green-50 p-4 rounded-lg">${icons.clock}<p class="text-sm font-medium text-green-700">Sync Temps Réel</p></div>
            </div>

            <div class="mb-6 p-4 bg-yellow-50 rounded-lg">
              <h4 class="font-bold text-yellow-800 mb-2">🚨 Code d'accès d'urgence</h4>
              <p class="text-2xl font-mono font-bold text-yellow-900">${medicalData.braceletId || 'SYL-' + Math.random().toString(36).substr(2,6).toUpperCase()}</p>
              <p class="text-sm text-yellow-700 mt-1">À communiquer aux secours pour accès immédiat</p>
            </div>

            <button class="${medicalData.isActive ? 'bg-gray-200 text-gray-600' : 'bg-red-600 text-white hover:bg-red-700'} rounded-lg px-6 py-3 font-bold" id="activateBracelet">
              ${medicalData.isActive ? 'Bracelet d\'Urgence Activé' : 'Activer le Bracelet d\'Urgence'}
            </button>
          </div>
        </div>
      </div>
    `;
  }

  function tabEmergencyEvents() {
    document.getElementById('saveEmergency').onclick = async () => {
      medicalData.emergencyInfo.primaryPhysician.name = document.getElementById('physicianName').value;
      medicalData.emergencyInfo.primaryPhysician.specialty = document.getElementById('physicianSpecialty').value;
      medicalData.emergencyInfo.primaryPhysician.phone = document.getElementById('physicianPhone').value;
      medicalData.emergencyInfo.criticalNotes = document.getElementById('criticalNotes').value;
      medicalData.emergencyInfo.lastUpdate = new Date().toISOString();
      localStorage.setItem('syl-medicalData', JSON.stringify(medicalData));
      
      // Synchronisation Firebase automatique
      if (user.uid) {
        const success = await saveToFirebase('patients', medicalData, user.uid + '_medical');
        if (success) {
          alert('✅ Données d\'urgence sauvegardées et synchronisées avec Firebase !');
        } else {
          alert('⚠️ Données sauvegardées localement. Synchronisation Firebase échouée.');
        }
      } else {
        alert('✅ Données d\'urgence sauvegardées !');
      }
      render();
    };
  }

  function tabProfileEvents() {
    document.getElementById('saveProfile').onclick = async () => {
      medicalData.personalInfo.firstName = document.getElementById('pfFirstName').value;
      medicalData.personalInfo.lastName = document.getElementById('pfLastName').value;
      medicalData.personalInfo.dateOfBirth = document.getElementById('pfBirth').value;
      medicalData.personalInfo.bloodType = document.getElementById('pfBlood').value;
      medicalData.personalInfo.height = document.getElementById('pfHeight').value;
      medicalData.personalInfo.weight = document.getElementById('pfWeight').value;
      medicalData.personalInfo.socialSecurityNumber = document.getElementById('pfSSN').value;
      medicalData.personalInfo.insuranceNumber = document.getElementById('pfInsurance').value;
      medicalData.personalInfo.address = document.getElementById('pfAddress').value;
      medicalData.personalInfo.city = document.getElementById('pfCity').value;
      medicalData.personalInfo.postalCode = document.getElementById('pfPostal').value;
      medicalData.personalInfo.preferredHospital = document.getElementById('pfHospital').value;
      medicalData.personalInfo.emergencyContact.name = document.getElementById('pfContact1Name').value;
      medicalData.personalInfo.emergencyContact.relation = document.getElementById('pfContact1Rel').value;
      medicalData.personalInfo.emergencyContact.phone = document.getElementById('pfContact1Phone').value;
      medicalData.personalInfo.secondaryContact.name = document.getElementById('pfContact2Name').value;
      medicalData.personalInfo.secondaryContact.relation = document.getElementById('pfContact2Rel').value;
      medicalData.personalInfo.secondaryContact.phone = document.getElementById('pfContact2Phone').value;
      medicalData.personalInfo.organDonor = document.getElementById('pfOrganDonor').checked;
      medicalData.personalInfo.advanceDirectives = document.getElementById('pfDirectives').checked;
      localStorage.setItem('syl-medicalData', JSON.stringify(medicalData));
      
      // Synchronisation Firebase automatique
      if (user.uid) {
        const success = await saveToFirebase('patients', medicalData, user.uid + '_medical');
        if (success) {
          alert('✅ Profil sauvegardé et synchronisé avec Firebase !');
        } else {
          alert('⚠️ Profil sauvegardé localement. Synchronisation Firebase échouée.');
        }
      } else {
        alert('✅ Profil sauvegardé !');
      }
      render();
    };
  }

  function tabMedicalEvents() {
    const listTypes = ['allergies', 'medications', 'chronicDiseases', 'medicalDevices', 'surgeries', 'emergencyMedications', 'contraindications', 'riskFactors'];
    listTypes.forEach(type => {
      const btnEl = document.getElementById(`btn_${type}`);
      if (btnEl) {
        btnEl.onclick = async () => {
          const v = document.getElementById(`add_${type}`).value.trim();
          if (v) {
            if (medicalData.medicalHistory[type]) {
              medicalData.medicalHistory[type].push(v);
            } else if (medicalData.emergencyInfo[type]) {
              medicalData.emergencyInfo[type].push(v);
            }
            localStorage.setItem('syl-medicalData', JSON.stringify(medicalData));
            
            // Synchronisation Firebase automatique
            if (user.uid) {
              await saveToFirebase('patients', medicalData, user.uid + '_medical');
            }
            render();
          }
        };
      }
      document.querySelectorAll(`[data-del="${type}"]`).forEach(btn => btn.onclick = async () => {
        const idx = parseInt(btn.getAttribute('data-idx'));
        if (medicalData.medicalHistory[type]) {
          medicalData.medicalHistory[type].splice(idx, 1);
        } else if (medicalData.emergencyInfo[type]) {
          medicalData.emergencyInfo[type].splice(idx, 1);
        }
        localStorage.setItem('syl-medicalData', JSON.stringify(medicalData));
        
        // Synchronisation Firebase automatique
        if (user.uid) {
          await saveToFirebase('patients', medicalData, user.uid + '_medical');
        }
        render();
      });
    });
  }

  function tabBraceletEvents() {
    document.getElementById('activateBracelet').onclick = async () => {
      medicalData.isActive = true;
      if (!medicalData.braceletId) {
        medicalData.braceletId = 'SYL-' + Math.random().toString(36).substr(2,6).toUpperCase();
      }
      localStorage.setItem('syl-medicalData', JSON.stringify(medicalData));
      
      // Synchronisation Firebase automatique
      if (user.uid) {
        const success = await saveToFirebase('patients', medicalData, user.uid + '_medical');
        if (success) {
          alert('✅ Bracelet d\'urgence activé et synchronisé avec Firebase !');
        } else {
          alert('⚠️ Bracelet activé localement. Synchronisation Firebase échouée.');
        }
      } else {
        alert('✅ Bracelet d\'urgence activé !');
      }
      render();
    };
  }
}

// ----------- MEDECIN DASHBOARD -----------
function renderMedecinDashboard(user) {
  let patients = JSON.parse(localStorage.getItem('syl-patients') || 'null');
  if (!patients) {
    patients = [
      {
        id: '1',
        personalInfo: { firstName: 'Jean', lastName: 'Martin', dateOfBirth: '1978-05-15', bloodType: 'O+', height: '175', weight: '80' },
        medicalHistory: { allergies: ['Pénicilline', 'Pollen'], medications: ['Metformine 500mg'], conditions: ['Diabète type 2'], chronicDiseases: ['Diabète type 2', 'Hypertension'] },
        emergencyInfo: { criticalNotes: 'Risque hypoglycémie', contraindications: ['Corticoïdes'] },
        lastAccess: '2024-01-15',
        isActive: true
      },
      {
        id: '2',
        personalInfo: { firstName: 'Marie', lastName: 'Dubois', dateOfBirth: '1985-08-22', bloodType: 'A+', height: '165', weight: '65' },
        medicalHistory: { allergies: ['Aspirine'], medications: ['Levothyrox'], conditions: ['Hypothyroïdie'], chronicDiseases: ['Hypothyroïdie'] },
        emergencyInfo: { criticalNotes: '', contraindications: [] },
        lastAccess: '2024-01-14',
        isActive: true
      }
    ];
    localStorage.setItem('syl-patients', JSON.stringify(patients));
  }
  let searchTerm = '';
  let selectedPatient = null;
  let activeTab = 'patients';
  render();

  function render() {
    const filteredPatients = patients.filter(patient =>
      `${patient.personalInfo.firstName} ${patient.personalInfo.lastName}`.toLowerCase().includes(searchTerm.toLowerCase())
    );
    document.getElementById('app').innerHTML = `
      <div class="min-h-screen bg-gray-50">
        <header class="bg-white shadow-sm border-b">
          <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center h-16">
            <div class="flex items-center">
              ${icons.stethoscope}
              <div class="ml-3">
                <h1 class="text-xl font-bold text-gray-900">SYL Medical Pro</h1>
                <p class="text-xs text-gray-500">${user.profile.speciality||''} • ${user.profile.hospital||''}</p>
              </div>
            </div>
            <div class="flex items-center space-x-4">
              <div class="text-sm text-gray-600">Dr. ${user.profile.firstName} ${user.profile.lastName}</div>
              <button id="logoutBtn" class="border-2 border-green-600 text-green-600 hover:bg-green-50 font-medium rounded-lg px-4 py-2 flex items-center gap-2">${icons.logout} Déconnexion</button>
            </div>
          </div>
        </header>
        
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
          <div class="mb-8">
            <!-- Navigation tabs -->
            <div class="flex space-x-4 mb-6">
              <button class="px-4 py-2 rounded-lg ${activeTab==='patients' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'}" data-tab="patients">Patients</button>
              <button class="px-4 py-2 rounded-lg ${activeTab==='emergency' ? 'bg-red-600 text-white' : 'bg-gray-200 text-gray-700'}" data-tab="emergency">🚑 Accès Urgence</button>
            </div>

            ${activeTab === 'patients' ? renderPatientsTab(filteredPatients) : ''}
            ${activeTab === 'emergency' ? renderEmergencyAccessTab() : ''}
          </div>
        </div>

        ${selectedPatient ? renderPatientModal(selectedPatient) : ''}
      </div>
    `;
    
    document.getElementById('logoutBtn').onclick = () => { logout(); };
    document.querySelectorAll('[data-tab]').forEach(btn => btn.onclick = () => { activeTab = btn.getAttribute('data-tab'); render(); });
    
    if (activeTab === 'patients') patientsTabEvents(filteredPatients);
    if (activeTab === 'emergency') emergencyTabEvents();
    if (selectedPatient) modalEvents();
  }

  function renderPatientsTab(filteredPatients) {
    return `
      <h2 class="text-2xl font-bold text-gray-900 mb-4">Patients</h2>
      
      <!-- Barre de recherche -->
      <div class="flex items-center space-x-4 mb-6">
        <div class="flex-1 relative">
          ${icons.search}
          <input type="text" placeholder="Rechercher un patient..." value="${searchTerm}" id="searchPatient" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
        </div>
        <button class="bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg px-6 py-2 flex items-center gap-2" id="addPatient">${icons.userPlus} Nouveau patient</button>
      </div>

      <!-- Stats rapides -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4 flex items-center">
          ${icons.users}<div class="ml-3"><p class="text-2xl font-bold text-gray-900">${patients.length}</p><p class="text-sm text-gray-600">Patients totaux</p></div>
        </div>
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4 flex items-center">
          ${icons.activity}<div class="ml-3"><p class="text-2xl font-bold text-gray-900">${patients.filter(p=>p.isActive).length}</p><p class="text-sm text-gray-600">Actifs</p></div>
        </div>
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4 flex items-center">
          ${icons.alert}<div class="ml-3"><p class="text-2xl font-bold text-gray-900">${patients.filter(p=>p.emergencyInfo?.criticalNotes).length}</p><p class="text-sm text-gray-600">Alertes</p></div>
        </div>
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4 flex items-center">
          ${icons.clock}<div class="ml-3"><p class="text-2xl font-bold text-gray-900">5</p><p class="text-sm text-gray-600">RDV aujourd'hui</p></div>
        </div>
      </div>

      <!-- Liste des patients -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        ${filteredPatients.map(patient => `
          <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4 mb-4 hover:shadow-lg transition-shadow cursor-pointer ${patient.emergencyInfo?.criticalNotes ? 'border-l-4 border-red-500' : ''}" data-patient="${patient.id}">
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-3">
                <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-green-500 rounded-full flex items-center justify-center">${icons.user}</div>
                <div>
                  <h3 class="font-semibold text-gray-900">${patient.personalInfo.firstName} ${patient.personalInfo.lastName}</h3>
                  <p class="text-sm text-gray-500">Groupe: ${patient.personalInfo.bloodType || 'Non renseigné'} • ${patient.lastAccess}</p>
                  ${patient.emergencyInfo?.criticalNotes ? `<p class="text-xs text-red-600 font-bold">⚠️ Notes d'urgence</p>` : ''}
                </div>
              </div>
              <div class="flex items-center space-x-2">
                ${patient.isActive ? '<div class="w-3 h-3 bg-green-500 rounded-full"></div>' : ''}
                <span class="text-xs text-gray-400">Actif</span>
              </div>
            </div>
            
            <div class="mt-3 flex flex-wrap gap-2">
              ${(patient.medicalHistory.chronicDiseases || patient.medicalHistory.conditions || []).slice(0, 2).map(condition => `<span class="px-2 py-1 bg-orange-100 text-orange-700 text-xs rounded-full">${condition}</span>`).join('')}
              ${(patient.medicalHistory.chronicDiseases || patient.medicalHistory.conditions || []).length > 2 ? `<span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded-full">+${(patient.medicalHistory.chronicDiseases || patient.medicalHistory.conditions || []).length - 2} autres</span>` : ''}
            </div>
            
            ${patient.medicalHistory.allergies?.length ? `
            <div class="mt-2 p-2 bg-red-50 rounded">
              <p class="text-xs text-red-700 font-bold">Allergies: ${patient.medicalHistory.allergies.slice(0,3).join(', ')}</p>
            </div>
            ` : ''}
          </div>
        `).join('')}
      </div>
    `;
  }

  function renderEmergencyAccessTab() {
    return `
      <div class="space-y-6">
        <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-lg">
          <h2 class="text-2xl font-bold text-red-800 flex items-center">
            ${icons.emergency} <span class="ml-2">ACCÈS D'URGENCE MÉDICAL</span>
          </h2>
          <p class="text-red-700 mt-2">Recherche rapide par code d'urgence ou nom</p>
        </div>

        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Recherche d'urgence</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Code d'urgence (bracelet)</label>
              <input type="text" placeholder="SYL-XXXXXX" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-lg font-mono" id="emergencyCode">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Nom du patient</label>
              <input type="text" placeholder="Nom ou prénom" class="w-full px-3 py-2 border border-gray-300 rounded-lg" id="emergencyName">
            </div>
          </div>
          <div class="mt-4 flex space-x-4">
            <button class="bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg px-6 py-3 flex items-center gap-2" id="searchEmergency">
              ${icons.search} RECHERCHE D'URGENCE
            </button>
            <button class="bg-orange-600 hover:bg-orange-700 text-white font-bold rounded-lg px-6 py-3 flex items-center gap-2">
              ${icons.phone} APPELER SAMU (15)
            </button>
          </div>
        </div>

        <!-- Patients avec alertes -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">⚠️ Patients avec alertes d'urgence</h3>
          <div class="space-y-3">
            ${patients.filter(p => p.emergencyInfo?.criticalNotes).map(patient => `
              <div class="border-l-4 border-red-500 bg-red-50 p-4 rounded cursor-pointer hover:bg-red-100" data-patient="${patient.id}">
                <div class="flex justify-between items-start">
                  <div>
                    <h4 class="font-bold text-red-800">${patient.personalInfo.firstName} ${patient.personalInfo.lastName}</h4>
                    <p class="text-red-700">${patient.emergencyInfo.criticalNotes}</p>
                    <p class="text-sm text-red-600">Groupe sanguin: ${patient.personalInfo.bloodType || 'Non renseigné'}</p>
                  </div>
                  <span class="bg-red-600 text-white px-2 py-1 rounded text-xs font-bold">CRITIQUE</span>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      </div>
    `;
  }

  function renderPatientModal(patient) {
    return `
      <div class="fixed inset-0 modal-bg flex items-center justify-center p-4 modal">
        <div class="bg-white rounded-xl max-w-6xl w-full max-h-[95vh] overflow-y-auto shadow-lg">
          <div class="p-6 border-b border-gray-200 flex justify-between items-center">
            <div>
              <h2 class="text-2xl font-bold text-gray-900">${patient.personalInfo.firstName} ${patient.personalInfo.lastName}</h2>
              <p class="text-gray-600">Dossier médical d'urgence complet</p>
            </div>
            <button class="bg-gray-200 text-gray-800 rounded-lg px-4 py-2" id="closeModal">✕</button>
          </div>

          <div class="p-6 space-y-6">
            <!-- Informations d'urgence critiques -->
            ${patient.emergencyInfo?.criticalNotes ? `
            <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-lg">
              <h3 class="font-bold text-red-800 mb-2">🚨 NOTES CRITIQUES D'URGENCE</h3>
              <p class="text-red-700 font-medium">${patient.emergencyInfo.criticalNotes}</p>
            </div>
            ` : ''}

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <!-- Identité -->
              <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4">
                <h3 class="font-semibold text-gray-900 mb-3">👤 Identité</h3>
                <div class="space-y-2 text-sm">
                  <p><strong>Né(e) le:</strong> ${patient.personalInfo.dateOfBirth}</p>
                  <p><strong>Groupe sanguin:</strong> <span class="bg-red-600 text-white px-2 py-1 rounded font-bold">${patient.personalInfo.bloodType || 'NON RENSEIGNÉ'}</span></p>
                  <p><strong>Taille:</strong> ${patient.personalInfo.height} cm</p>
                  <p><strong>Poids:</strong> ${patient.personalInfo.weight} kg</p>
                </div>
              </div>

              <!-- Allergies -->
              <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4">
                <h3 class="font-semibold text-gray-900 mb-3">⚠️ Allergies</h3>
                <div class="space-y-1">
                  ${(patient.medicalHistory.allergies || []).length ? patient.medicalHistory.allergies.map(allergy => `<span class="inline-block px-2 py-1 bg-red-100 text-red-700 text-xs rounded-full mr-2 mb-1">${allergy}</span>`).join('') : '<p class="text-gray-500 text-sm">Aucune allergie connue</p>'}
                </div>
              </div>

              <!-- Médicaments -->
              <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4">
                <h3 class="font-semibold text-gray-900 mb-3">💊 Traitements</h3>
                <div class="space-y-1">
                  ${(patient.medicalHistory.medications || []).length ? patient.medicalHistory.medications.map(medication => `<span class="inline-block px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full mr-2 mb-1">${medication}</span>`).join('') : '<p class="text-gray-500 text-sm">Aucun traitement</p>'}
                </div>
              </div>

              <!-- Pathologies -->
              <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4">
                <h3 class="font-semibold text-gray-900 mb-3">🏥 Pathologies</h3>
                <div class="space-y-1">
                  ${(patient.medicalHistory.chronicDiseases || patient.medicalHistory.conditions || []).length ? (patient.medicalHistory.chronicDiseases || patient.medicalHistory.conditions).map(condition => `<span class="inline-block px-2 py-1 bg-orange-100 text-orange-700 text-xs rounded-full mr-2 mb-1">${condition}</span>`).join('') : '<p class="text-gray-500 text-sm">Aucune pathologie</p>'}
                </div>
              </div>

              <!-- Contre-indications -->
              <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4">
                <h3 class="font-semibold text-gray-900 mb-3">🚫 Contre-indications</h3>
                <div class="space-y-1">
                  ${(patient.emergencyInfo?.contraindications || []).length ? patient.emergencyInfo.contraindications.map(contra => `<span class="inline-block px-2 py-1 bg-yellow-100 text-yellow-700 text-xs rounded-full mr-2 mb-1">${contra}</span>`).join('') : '<p class="text-gray-500 text-sm">Aucune contre-indication</p>'}
                </div>
              </div>

              <!-- Dispositifs médicaux -->
              <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4">
                <h3 class="font-semibold text-gray-900 mb-3">🔧 Dispositifs</h3>
                <div class="space-y-1">
                  ${(patient.medicalHistory.medicalDevices || []).length ? patient.medicalHistory.medicalDevices.map(device => `<span class="inline-block px-2 py-1 bg-purple-100 text-purple-700 text-xs rounded-full mr-2 mb-1">${device}</span>`).join('') : '<p class="text-gray-500 text-sm">Aucun dispositif</p>'}
                </div>
              </div>
            </div>

            <div class="flex justify-end space-x-4">
              <button class="border-2 border-blue-600 text-blue-600 hover:bg-blue-50 font-medium rounded-lg px-4 py-2 flex items-center gap-2" id="editPatient">${icons.edit} Modifier</button>
              <button class="bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg px-4 py-2 flex items-center gap-2">${icons.activity} Nouvelle consultation</button>
              <button class="bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg px-4 py-2 flex items-center gap-2">${icons.emergency} Déclarer urgence</button>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  function patientsTabEvents(filteredPatients) {
    document.getElementById('searchPatient').oninput = (e) => { searchTerm = e.target.value; render(); };
    document.getElementById('addPatient').onclick = () => showAddPatientModal();
    document.querySelectorAll('[data-patient]').forEach(card => card.onclick = () => {
      selectedPatient = patients.find(p=>p.id===card.getAttribute('data-patient'));
      render();
    });
  }

  function emergencyTabEvents() {
    document.getElementById('searchEmergency').onclick = () => {
      const code = document.getElementById('emergencyCode').value;
      const name = document.getElementById('emergencyName').value;
      
      let foundPatient = null;
      if (code) {
        foundPatient = patients.find(p => p.braceletId === code);
      } else if (name) {
        foundPatient = patients.find(p => 
          p.personalInfo.firstName.toLowerCase().includes(name.toLowerCase()) || 
          p.personalInfo.lastName.toLowerCase().includes(name.toLowerCase())
        );
      }
      
      if (foundPatient) {
        selectedPatient = foundPatient;
        render();
      } else {
        alert('Patient non trouvé');
      }
    };
    
    document.querySelectorAll('[data-patient]').forEach(card => card.onclick = () => {
      selectedPatient = patients.find(p=>p.id===card.getAttribute('data-patient'));
      render();
    });
  }

  function modalEvents() {
    document.getElementById('closeModal').onclick = () => { selectedPatient = null; render(); };
    if (document.getElementById('editPatient')) {
      document.getElementById('editPatient').onclick = () => showEditPatientModal(selectedPatient);
    }
  }

  function showEditPatientModal(patient) {
    // Modal d'édition du patient
    document.getElementById('app').querySelector('.modal').innerHTML = `
      <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto shadow-lg">
        <div class="p-6 border-b border-gray-200 flex justify-between items-center">
          <h2 class="text-2xl font-bold text-gray-900">Modifier ${patient.personalInfo.firstName} ${patient.personalInfo.lastName}</h2>
          <button class="bg-gray-200 text-gray-800 rounded-lg px-4 py-2" id="closeEditModal">✕</button>
        </div>
        <div class="p-6 space-y-4">
          <div class="grid grid-cols-2 gap-4">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" id="editFirstName" value="${patient.personalInfo.firstName}" placeholder="Prénom">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" id="editLastName" value="${patient.personalInfo.lastName}" placeholder="Nom">
            <input type="date" class="w-full px-3 py-2 border border-gray-300 rounded-lg" id="editBirth" value="${patient.personalInfo.dateOfBirth}">
            <select class="w-full px-3 py-2 border border-gray-300 rounded-lg" id="editBlood">
              <option value="">Groupe sanguin</option>
              ${MEDICAL_DATA.bloodTypes.map(type => `<option value="${type}" ${patient.personalInfo.bloodType===type?'selected':''}>${type}</option>`).join('')}
            </select>
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" id="editHeight" value="${patient.personalInfo.height}" placeholder="Taille (cm)">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" id="editWeight" value="${patient.personalInfo.weight}" placeholder="Poids (kg)">
          </div>
          <textarea class="w-full px-3 py-2 border border-gray-300 rounded-lg h-20" id="editCriticalNotes" placeholder="Notes critiques d'urgence">${patient.emergencyInfo?.criticalNotes || ''}</textarea>
          <button class="bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg px-6 py-2" id="saveEditPatient">Sauvegarder</button>
        </div>
      </div>
    `;
    document.getElementById('closeEditModal').onclick = () => render();
    document.getElementById('saveEditPatient').onclick = async () => {
      patient.personalInfo.firstName = document.getElementById('editFirstName').value;
      patient.personalInfo.lastName = document.getElementById('editLastName').value;
      patient.personalInfo.dateOfBirth = document.getElementById('editBirth').value;
      patient.personalInfo.bloodType = document.getElementById('editBlood').value;
      patient.personalInfo.height = document.getElementById('editHeight').value;
      patient.personalInfo.weight = document.getElementById('editWeight').value;
      if (!patient.emergencyInfo) patient.emergencyInfo = {};
      patient.emergencyInfo.criticalNotes = document.getElementById('editCriticalNotes').value;
      localStorage.setItem('syl-patients', JSON.stringify(patients));
      
      // Synchronisation Firebase automatique
      await saveToFirebase('patients', patient, patient.id);
      alert('✅ Patient modifié et synchronisé avec Firebase !');
      render();
    };
  }

  function showAddPatientModal() {
    document.body.insertAdjacentHTML('beforeend', `
      <div class="fixed inset-0 modal-bg flex items-center justify-center p-4 modal">
        <div class="bg-white rounded-xl max-w-md w-full overflow-y-auto shadow-lg p-6">
          <h2 class="text-2xl font-bold text-gray-900 mb-4">Nouveau patient</h2>
          <div class="space-y-3">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" id="newFirstName" placeholder="Prénom">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" id="newLastName" placeholder="Nom">
            <input type="date" class="w-full px-3 py-2 border border-gray-300 rounded-lg" id="newBirth">
            <select class="w-full px-3 py-2 border border-gray-300 rounded-lg" id="newBlood">
              <option value="">Groupe sanguin</option>
              ${MEDICAL_DATA.bloodTypes.map(type => `<option value="${type}">${type}</option>`).join('')}
            </select>
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" id="newHeight" placeholder="Taille (cm)">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" id="newWeight" placeholder="Poids (kg)">
          </div>
          <div class="flex space-x-2 mt-4">
            <button class="bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg px-6 py-2" id="saveNewPatient">Ajouter</button>
            <button class="bg-gray-200 text-gray-800 rounded-lg px-6 py-2" id="cancelNewPatient">Annuler</button>
          </div>
        </div>
      </div>
    `);
    document.getElementById('cancelNewPatient').onclick = () => { document.querySelector('.modal').remove(); };
    document.getElementById('saveNewPatient').onclick = async () => {
      const patient = {
        id: Math.random().toString(36).substr(2,9),
        personalInfo: {
          firstName: document.getElementById('newFirstName').value,
          lastName: document.getElementById('newLastName').value,
          dateOfBirth: document.getElementById('newBirth').value,
          bloodType: document.getElementById('newBlood').value,
          height: document.getElementById('newHeight').value,
          weight: document.getElementById('newWeight').value
        },
        medicalHistory: { allergies: [], medications: [], conditions: [], chronicDiseases: [], medicalDevices: [] },
        emergencyInfo: { criticalNotes: '', contraindications: [] },
        lastAccess: new Date().toISOString().split('T')[0],
        isActive: true
      };
      patients.push(patient);
      localStorage.setItem('syl-patients', JSON.stringify(patients));
      
      // Synchronisation Firebase automatique
      await saveToFirebase('patients', patient, patient.id);
      alert('✅ Nouveau patient ajouté et synchronisé avec Firebase !');
      document.querySelector('.modal').remove();
      render();
    };
  }
}

// ----------- MAIN -----------
function renderApp() {
  // Vérifier l'état d'authentification Firebase
  auth.onAuthStateChanged((firebaseUser) => {
    if (firebaseUser) {
      // Utilisateur connecté
      const user = getUser();
      if (user && user.uid === firebaseUser.uid) {
        if (user.role === 'patient') {
          renderPatientDashboard(user);
        } else if (user.role === 'medecin') {
          renderMedecinDashboard(user);
        }
      } else {
        // Utilisateur Firebase mais pas de données locales
        showLogin();
      }
    } else {
      // Pas d'utilisateur connecté
      showLogin();
    }
  });
}

// Fonction de déconnexion mise à jour
function logout() {
  auth.signOut().then(() => {
    clearUser();
    renderApp();
  }).catch((error) => {
    console.error('Erreur de déconnexion:', error);
  });
}

// Init - Attendre que Firebase soit prêt
firebase.auth().onAuthStateChanged(() => {
  renderApp();
});
</script>
</body>
</html>
