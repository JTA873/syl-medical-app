<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>SYL Medical - Système d'Urgence</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#3B82F6">
  <meta name="description" content="Application médicale d'urgence - Accès rapide aux informations vitales">
  
  <!-- PWA -->
  <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIlNZTCBNZWRpY2FsIC0gU3lzdMOobWUgZCdVcmdlbmNlIiwKICAic2hvcnRfbmFtZSI6ICJTWUwgTWVkaWNhbCIsCiAgImRlc2NyaXB0aW9uIjogIkFwcGxpY2F0aW9uIG3DqWRpY2FsZSBkJ3VyZ2VuY2UiLAogICJzdGFydF91cmwiOiAiLyIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI0ZGRkZGRiIsCiAgInRoZW1lX2NvbG9yIjogIiMzQjgyRjYiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUI0Yld4dWN6MGlhSFIwY0RvdkwzZDNkeTUzTXk1dmNtY3ZNakF3TUM5emRtY2lJSFpwWlhkQ2IzZzlJakFnTUNBNE1EQWdPREF3SWo0OFl5QjRQU0k0TURBaUlIazlJalEzTWlJZ1kzZzlJakU1TWlJZ1kzazlJakk0SWlCeVBTSTFNaUl2UGp3dmMzWm5QZz09IiwKICAgICAgInNpemVzIjogIjUxMng1MTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIgogICAgfQogIF0sCiAgImNhdGVnb3JpZXMiOiBbIm1lZGljYWwiLCAiaGVhbHRoIiwgImVtZXJnZW5jeSJdCn0=">
  <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA4MDAgODAwIj48YyB4PSI4MDAiIHk9IjQ3MiIgY3g9IjE5MiIgY3k9IjI4IiByPSI1MiIvPjwvc3ZnPg==">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <style>
    .animate-spin { animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .modal-bg { background: rgba(0,0,0,0.5); }
    .modal { z-index: 50; }
    .icon { width: 1em; height: 1em; display: inline-block; vertical-align: middle; }
    .emergency-card { border-left: 4px solid #ef4444; }
    .critical-info { background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); }
    
    /* Mode sombre */
    @media (prefers-color-scheme: dark) {
      .dark-mode {
        background: #1a1a1a;
        color: #ffffff;
      }
      .dark-mode .bg-white {
        background: #2d2d2d !important;
        color: #ffffff !important;
      }
      .dark-mode .text-gray-900 {
        color: #ffffff !important;
      }
      .dark-mode .border-gray-200 {
        border-color: #404040 !important;
      }
    }
    
    /* Accessibilité */
    .high-contrast {
      filter: contrast(150%);
    }
    
    .large-text {
      font-size: 1.2em;
    }
    
    /* Focus amélioré pour navigation clavier */
    button:focus, input:focus, select:focus, textarea:focus {
      outline: 3px solid #3B82F6;
      outline-offset: 2px;
    }
    
    /* Animations réduites pour les utilisateurs sensibles */
    @media (prefers-reduced-motion: reduce) {
      .animate-spin {
        animation: none;
      }
      .transition-colors {
        transition: none;
      }
    }
    
    /* Responsive amélioré */
    @media (max-width: 640px) {
      .mobile-stack {
        flex-direction: column;
      }
      .mobile-full {
        width: 100%;
      }
    }
  </style>
</head>
<body class="bg-gray-50">
<div id="app">
  <div class="min-h-screen bg-gray-50 flex items-center justify-center">
    <div class="text-center">
      <div class="w-16 h-16 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
      <p class="text-gray-600">Chargement de SYL Medical...</p>
    </div>
  </div>
</div>
<script>
// Gestion d'erreur globale
window.onerror = function(msg, url, lineNo, columnNo, error) {
  console.error('Erreur JavaScript:', msg, 'à la ligne', lineNo);
  document.getElementById('app').innerHTML = `
    <div class="min-h-screen bg-red-50 flex items-center justify-center p-4">
      <div class="bg-white rounded-lg shadow-lg p-6 max-w-md">
        <h2 class="text-xl font-bold text-red-600 mb-4">Erreur JavaScript</h2>
        <p class="text-gray-700 mb-2"><strong>Message:</strong> ${msg}</p>
        <p class="text-gray-700 mb-4"><strong>Ligne:</strong> ${lineNo}</p>
        <button onclick="location.reload()" class="bg-blue-600 text-white px-4 py-2 rounded">Réessayer</button>
      </div>
    </div>
  `;
  return true;
};

console.log("SYL Medical - Début du chargement");

// Configuration Firebase sécurisée
const firebaseConfig = {
  apiKey: "AIzaSyDqII2vBhBybNhVcr1QktyhvVeBW2TO0KA",
  authDomain: "syl-medical-app-1c58a.firebaseapp.com",
  databaseURL: "https://syl-medical-app-1c58a-default-rtdb.firebaseio.com",
  projectId: "syl-medical-app-1c58a",
  storageBucket: "syl-medical-app-1c58a.firebasestorage.app",
  messagingSenderId: "765684422018",
  appId: "1:765684422018:web:19320fe1e546631fc86b9b",
  measurementId: "G-PD7TP5J233"
};

// Comptes admin prédéfinis
const adminAccounts = {
  'jadetaraf@hotmail.fr': 'ADMINTARAF'
};

// Variables Firebase globales
let db, auth, googleProvider;

// Initialiser Firebase
try {
  firebase.initializeApp(firebaseConfig);
  db = firebase.firestore();
  auth = firebase.auth();
  googleProvider = new firebase.auth.GoogleAuthProvider();
  console.log("Firebase initialisé avec succès");
} catch (error) {
  console.error("Erreur Firebase:", error);
  document.getElementById('app').innerHTML = `
    <div class="min-h-screen bg-red-50 flex items-center justify-center p-4">
      <div class="bg-white rounded-lg shadow-lg p-6 max-w-md">
        <h2 class="text-xl font-bold text-red-600 mb-4">Erreur Firebase</h2>
        <p class="text-gray-700">Impossible d'initialiser Firebase: ${error.message}</p>
        <button onclick="location.reload()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded">Réessayer</button>
      </div>
    </div>
  `;
}

const icons = {
  heart: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path d="M12 21C12 21 7.5 16.5 4 12.5C1.5 9.5 3.5 5 8 5C10 5 12 7 12 7C12 7 14 5 16 5C20.5 5 22.5 9.5 20 12.5C16.5 16.5 12 21 12 21Z" stroke-width="2"/></svg>',
  user: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><circle cx="12" cy="8" r="4" stroke-width="2"/><path d="M6 20c0-2.22 3.58-4 6-4s6 1.78 6 4" stroke-width="2"/></svg>',
  stethoscope: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path d="M8 7v5a4 4 0 008 0V7" stroke-width="2"/><circle cx="12" cy="17" r="2" stroke-width="2"/></svg>',
  mail: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><rect x="3" y="5" width="18" height="14" rx="2"/><path d="M3 7l9 6 9-6" stroke-width="2"/></svg>',
  lock: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><rect x="5" y="11" width="14" height="9" rx="2"/><path d="M7 11V7a5 5 0 1110 0v4" stroke-width="2"/></svg>',
  eye: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M2 12s4-8 10-8 10 8 10 8-4 8-10 8-10-8-10-8z"/></svg>',
  eyeOff: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path d="M17.94 17.94A10.07 10.07 0 012 12s4-8 10-8a9.93 9.93 0 016.94 3.06"/><line x1="1" y1="1" x2="23" y2="23"/></svg>',
  plus: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>',
  trash: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><rect x="3" y="7" width="18" height="14" rx="2"/><line x1="8" y1="11" x2="8" y2="17"/><line x1="16" y1="11" x2="16" y2="17"/></svg>',
  check: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>',
  shield: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" /></svg>',
  smartphone: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><rect x="5" y="2" width="14" height="20" rx="2"/><circle cx="12" cy="18" r="1"/></svg>',
  clock: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
  alert: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><polygon points="12 2 2 22 22 22 12 2"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12" y2="8"/></svg>',
  activity: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>',
  users: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 00-3-3.87"/><path d="M9 21v-2a4 4 0 013-3.87"/><path d="M7 7a4 4 0 018 0"/><path d="M5 21v-2a4 4 0 013-3.87"/><path d="M5 7a4 4 0 018 0"/></svg>',
  userPlus: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 00-3-3.87"/><path d="M8 21v-2a4 4 0 013-3.87"/><path d="M12 7a4 4 0 018 0"/><path d="M2 8v6"/><path d="M5 11H2"/></svg>',
  edit: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path d="M11 4h2a2 2 0 012 2v6a2 2 0 01-2 2h-2a2 2 0 01-2-2V6a2 2 0 012-2z"/><path d="M19 20v-2a2 2 0 00-2-2h-2a2 2 0 00-2 2v2"/></svg>',
  logout: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>',
  search: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>',
  settings: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 11-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09a1.65 1.65 0 00-1-1.51 1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 11-2.83-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09a1.65 1.65 0 001.51-1 1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06a1.65 1.65 0 001.82.33h.09a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51h.09a1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06a1.65 1.65 0 00-.33 1.82v.09a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>',
  phone: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 16.92z"/></svg>',
  calendar: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>',
  medical: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>',
  emergency: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>',
  cross: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>',
  warning: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
  fire: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path d="M8.5 14.5A2.5 2.5 0 0011 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 11-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 002.5 2.5z"/></svg>'
};

// Données de référence médicales
const MEDICAL_DATA = {
  bloodTypes: ['A+', 'A-', 'B+', 'B-', 'AB+', 'AB-', 'O+', 'O-'],
  chronicConditions: [
    'Diabète type 1', 'Diabète type 2', 'Hypertension artérielle', 'Insuffisance cardiaque',
    'Asthme', 'BPCO', 'Épilepsie', 'Maladie de Crohn', 'Polyarthrite rhumatoïde',
    'Sclérose en plaques', 'Maladie de Parkinson', 'Alzheimer', 'Insuffisance rénale',
    'Cirrhose', 'Cancer', 'VIH/SIDA', 'Hépatite B', 'Hépatite C', 'Hypothyroïdie',
    'Hyperthyroïdie', 'Fibromyalgie', 'Lupus', 'Bipolarité', 'Dépression majeure'
  ],
  commonAllergies: [
    'Pénicilline', 'Aspirine', 'Iode', 'Latex', 'Arachides', 'Fruits de mer',
    'Œufs', 'Lait', 'Soja', 'Gluten', 'Pollen', 'Acariens', 'Poils d\'animaux',
    'Morphine', 'Codéine', 'AINS', 'Sulfamides', 'Anesthésiques locaux'
  ],
  emergencyMedications: [
    'Adrénaline auto-injecteur', 'Ventoline', 'Glucagon', 'Insuline rapide',
    'Diazépam rectal', 'Trinitrine', 'Prednisone', 'Antihistaminiques',
    'Beta-bloquants', 'Digitaline', 'Warfarine', 'Héparine'
  ],
  medicalDevices: [
    'Pacemaker', 'Défibrillateur implantable', 'Pompe à insuline', 'Prothèse de hanche',
    'Prothèse de genou', 'Stent cardiaque', 'Valve cardiaque artificielle',
    'Implant cochléaire', 'Neurostimulateur', 'Port-à-cath', 'Sonde gastrique',
    'Cathéter urinaire', 'Dialyse péritonéale'
  ]
};

// Fonctions de chiffrement pour les données sensibles
class EncryptionService {
  static async generateKey() {
    return await crypto.subtle.generateKey(
      { name: 'AES-GCM', length: 256 },
      true,
      ['encrypt', 'decrypt']
    );
  }
  
  static async encrypt(data, key) {
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const encodedData = new TextEncoder().encode(JSON.stringify(data));
    const encrypted = await crypto.subtle.encrypt(
      { name: 'AES-GCM', iv: iv },
      key,
      encodedData
    );
    return {
      data: Array.from(new Uint8Array(encrypted)),
      iv: Array.from(iv)
    };
  }
  
  static async decrypt(encryptedData, key) {
    const data = new Uint8Array(encryptedData.data);
    const iv = new Uint8Array(encryptedData.iv);
    const decrypted = await crypto.subtle.decrypt(
      { name: 'AES-GCM', iv: iv },
      key,
      data
    );
    return JSON.parse(new TextDecoder().decode(decrypted));
  }
}

// Fonctions Firebase
async function saveToFirebase(collection, data, id = null) {
  try {
    if (id) {
      await db.collection(collection).doc(id).set(data);
    } else {
      await db.collection(collection).add(data);
    }
    console.log('Données sauvegardées dans Firebase');
    return true;
  } catch (error) {
    console.error('Erreur Firebase:', error);
    return false;
  }
}

async function loadFromFirebase(collection, id) {
  try {
    const doc = await db.collection(collection).doc(id).get();
    if (doc.exists) {
      return doc.data();
    }
    return null;
  } catch (error) {
    console.error('Erreur Firebase:', error);
    return null;
  }
}

function saveUser(user) {
  localStorage.setItem('syl-user', JSON.stringify(user));
  // Synchronisation Firebase automatique
  if (user.uid) {
    saveToFirebase('users', user, user.uid);
  }
}

function getUser() {
  const u = localStorage.getItem('syl-user');
  return u ? JSON.parse(u) : null;
}

function clearUser() {
  localStorage.removeItem('syl-user');
}

// Nouvelles fonctionnalités
class SYLUtilities {
  // Génération QR Code d'urgence
  static generateEmergencyQR(medicalData) {
    const emergencyData = {
      name: `${medicalData.personalInfo.firstName} ${medicalData.personalInfo.lastName}`,
      bloodType: medicalData.personalInfo.bloodType,
      allergies: medicalData.medicalHistory.allergies,
      conditions: medicalData.medicalHistory.chronicDiseases,
      emergencyContact: medicalData.personalInfo.emergencyContact,
      criticalNotes: medicalData.emergencyInfo.criticalNotes,
      timestamp: new Date().toISOString()
    };
    
    // QR Code simple avec données base64
    const qrData = btoa(JSON.stringify(emergencyData));
    return `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(qrData)}`;
  }
  
  // Géolocalisation d'urgence
  static async getEmergencyLocation() {
    return new Promise((resolve, reject) => {
      if (!navigator.geolocation) {
        reject('Géolocalisation non supportée');
        return;
      }
      
      navigator.geolocation.getCurrentPosition(
        position => resolve({
          latitude: position.coords.latitude,
          longitude: position.coords.longitude,
          accuracy: position.coords.accuracy,
          timestamp: new Date().toISOString()
        }),
        error => reject(error.message),
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
      );
    });
  }
  
  // Mode hors ligne
  static setupOfflineMode() {
    if ('serviceWorker' in navigator) {
      const swCode = `
        const CACHE_NAME = 'syl-medical-v1';
        const urlsToCache = [
          '/',
          'https://cdn.tailwindcss.com'
        ];

        self.addEventListener('install', event => {
          event.waitUntil(
            caches.open(CACHE_NAME)
              .then(cache => cache.addAll(urlsToCache))
          );
        });

        self.addEventListener('fetch', event => {
          event.respondWith(
            caches.match(event.request)
              .then(response => response || fetch(event.request))
          );
        });
      `;
      
      const blob = new Blob([swCode], { type: 'application/javascript' });
      const swUrl = URL.createObjectURL(blob);
      
      navigator.serviceWorker.register(swUrl)
        .then(() => console.log('Service Worker enregistré'))
        .catch(err => console.log('Erreur Service Worker:', err));
    }
  }
  
  // Notifications push
  static async requestNotificationPermission() {
    if ('Notification' in window) {
      const permission = await Notification.requestPermission();
      return permission === 'granted';
    }
    return false;
  }
  
  static showNotification(title, options) {
    if (Notification.permission === 'granted') {
      new Notification(title, {
        icon: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA4MDAgODAwIj48YyB4PSI4MDAiIHk9IjQ3MiIgY3g9IjE5MiIgY3k9IjI4IiByPSI1MiIvPjwvc3ZnPg==',
        badge: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA4MDAgODAwIj48YyB4PSI4MDAiIHk9IjQ3MiIgY3g9IjE5MiIgY3k9IjI4IiByPSI1MiIvPjwvc3ZnPg==',
        ...options
      });
    }
  }
  
  // Export PDF
  static generatePDF(medicalData) {
    const emergencyInfo = `
<!DOCTYPE html>
<html>
<head>
  <title>SYL Medical - Fiche d'urgence</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .header { text-align: center; color: #dc2626; border-bottom: 3px solid #dc2626; padding-bottom: 10px; }
    .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
    .critical { background-color: #fef2f2; border-color: #dc2626; }
    .label { font-weight: bold; color: #374151; }
    .value { color: #1f2937; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  </style>
</head>
<body>
  <div class="header">
    <h1>🚑 FICHE MÉDICALE D'URGENCE</h1>
    <h2>${medicalData.personalInfo.firstName} ${medicalData.personalInfo.lastName}</h2>
  </div>
  
  <div class="section critical">
    <h3>INFORMATIONS CRITIQUES</h3>
    <div class="grid">
      <div><span class="label">Groupe sanguin:</span> <span class="value">${medicalData.personalInfo.bloodType || 'Non renseigné'}</span></div>
      <div><span class="label">Date de naissance:</span> <span class="value">${medicalData.personalInfo.dateOfBirth}</span></div>
    </div>
  </div>
  
  <div class="section">
    <h3>ALLERGIES</h3>
    <p class="value">${medicalData.medicalHistory.allergies.join(', ') || 'Aucune allergie connue'}</p>
  </div>
  
  <div class="section">
    <h3>TRAITEMENTS EN COURS</h3>
    <p class="value">${medicalData.medicalHistory.medications.join(', ') || 'Aucun traitement'}</p>
  </div>
  
  <div class="section">
    <h3>CONTACT D'URGENCE</h3>
    <p class="value">${medicalData.personalInfo.emergencyContact.name} (${medicalData.personalInfo.emergencyContact.relation})<br>
    Tél: ${medicalData.personalInfo.emergencyContact.phone}</p>
  </div>
  
  ${medicalData.emergencyInfo.criticalNotes ? `
  <div class="section critical">
    <h3>NOTES CRITIQUES</h3>
    <p class="value">${medicalData.emergencyInfo.criticalNotes}</p>
  </div>
  ` : ''}
  
  <div class="section">
    <p style="text-align: center; color: #6b7280; font-size: 12px;">
      Généré le ${new Date().toLocaleString('fr-FR')} par SYL Medical
    </p>
  </div>
</body>
</html>
    `;
    
    const blob = new Blob([emergencyInfo], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `fiche-urgence-${medicalData.personalInfo.firstName}-${new Date().toISOString().split('T')[0]}.html`;
    a.click();
    URL.revokeObjectURL(url);
  }
  
  // API NFC pour l'accès d'urgence
  static async handleNFCAccess(tagId) {
    try {
      const nfcTags = JSON.parse(localStorage.getItem('syl-nfc-tags') || '[]');
      const patients = JSON.parse(localStorage.getItem('syl-patients') || '[]');
      
      const tag = nfcTags.find(t => t.id === tagId);
      if (!tag || !tag.assignedTo) {
        throw new Error('Tag NFC non reconnu ou non assigné');
      }
      
      const patient = patients.find(p => (p.id || p.uid) === tag.assignedTo);
      if (!patient) {
        throw new Error('Patient non trouvé pour ce tag');
      }
      
      // Récupérer les données médicales complètes depuis Firebase si possible
      let medicalData = null;
      try {
        const doc = await db.collection('patients').doc(tag.assignedTo + '_medical').get();
        if (doc.exists) {
          medicalData = doc.data();
        }
      } catch (error) {
        console.warn('Impossible de récupérer les données Firebase, utilisation des données locales');
      }
      
      // Fallback sur les données du patient si pas de données médicales
      if (!medicalData && patient.medicalHistory) {
        medicalData = {
          personalInfo: patient.personalInfo,
          medicalHistory: patient.medicalHistory,
          emergencyInfo: patient.emergencyInfo
        };
      }
      
      if (!medicalData) {
        throw new Error('Aucune donnée médicale disponible pour ce patient');
      }
      
      // Afficher l'interface d'urgence
      this.displayEmergencyInterface(medicalData, tagId);
      
      // Logger l'accès
      SYLAnalytics.trackEvent('nfc_emergency_access', { 
        tagId, 
        patientId: tag.assignedTo,
        timestamp: new Date().toISOString()
      });
      
      return medicalData;
    } catch (error) {
      console.error('Erreur accès NFC:', error);
      this.displayErrorInterface(error.message);
      throw error;
    }
  }
  
  static displayEmergencyInterface(medicalData, tagId) {
    // Créer une interface d'urgence en plein écran
    const emergencyInterface = document.createElement('div');
    emergencyInterface.className = 'fixed inset-0 bg-red-600 z-50 overflow-y-auto';
    emergencyInterface.innerHTML = `
      <div class="min-h-screen p-4">
        <div class="max-w-4xl mx-auto">
          <div class="bg-white rounded-lg shadow-2xl overflow-hidden">
            <div class="bg-red-600 text-white p-6 text-center">
              <h1 class="text-3xl font-bold">🚑 ACCÈS D'URGENCE MÉDICALE</h1>
              <p class="text-xl mt-2">Tag NFC: ${tagId}</p>
              <p class="text-lg">Accès le ${new Date().toLocaleString('fr-FR')}</p>
            </div>
            
            <div class="p-6 space-y-6">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-red-50 border-l-4 border-red-500 p-4">
                  <h2 class="text-xl font-bold text-red-800 mb-4">IDENTITÉ PATIENT</h2>
                  <div class="space-y-2">
                    <p><strong>Nom:</strong> ${medicalData.personalInfo.lastName}</p>
                    <p><strong>Prénom:</strong> ${medicalData.personalInfo.firstName}</p>
                    <p><strong>Date de naissance:</strong> ${medicalData.personalInfo.dateOfBirth}</p>
                    <p><strong>Groupe sanguin:</strong> <span class="bg-red-600 text-white px-3 py-1 rounded font-bold text-lg">${medicalData.personalInfo.bloodType || 'NON RENSEIGNÉ'}</span></p>
                  </div>
                </div>
                
                <div class="bg-orange-50 border-l-4 border-orange-500 p-4">
                  <h2 class="text-xl font-bold text-orange-800 mb-4">CONTACT D'URGENCE</h2>
                  <div class="space-y-2">
                    <p><strong>Nom:</strong> ${medicalData.personalInfo.emergencyContact.name}</p>
                    <p><strong>Relation:</strong> ${medicalData.personalInfo.emergencyContact.relation}</p>
                    <p><strong>Téléphone:</strong> <a href="tel:${medicalData.personalInfo.emergencyContact.phone}" class="text-blue-600 underline text-lg font-bold">${medicalData.personalInfo.emergencyContact.phone}</a></p>
                  </div>
                </div>
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4">
                  <h2 class="text-xl font-bold text-yellow-800 mb-4">⚠️ ALLERGIES CRITIQUES</h2>
                  <div class="space-y-1">
                    ${medicalData.medicalHistory.allergies?.length ? 
                      medicalData.medicalHistory.allergies.map(a => `<span class="bg-red-500 text-white px-2 py-1 rounded mr-1 mb-1 inline-block">${a}</span>`).join('') : 
                      '<p class="text-gray-500">Aucune allergie connue</p>'
                    }
                  </div>
                </div>
                
                <div class="bg-blue-50 border-l-4 border-blue-500 p-4">
                  <h2 class="text-xl font-bold text-blue-800 mb-4">💊 TRAITEMENTS EN COURS</h2>
                  <div class="space-y-1">
                    ${medicalData.medicalHistory.medications?.length ? 
                      medicalData.medicalHistory.medications.map(m => `<span class="bg-blue-500 text-white px-2 py-1 rounded mr-1 mb-1 inline-block">${m}</span>`).join('') : 
                      '<p class="text-gray-500">Aucun traitement</p>'
                    }
                  </div>
                </div>
              </div>
              
              <div class="bg-purple-50 border-l-4 border-purple-500 p-4">
                <h2 class="text-xl font-bold text-purple-800 mb-4">🏥 PATHOLOGIES & CONDITIONS</h2>
                <div class="space-y-1">
                  ${medicalData.medicalHistory.chronicDiseases?.length ? 
                    medicalData.medicalHistory.chronicDiseases.map(c => `<span class="bg-purple-500 text-white px-2 py-1 rounded mr-1 mb-1 inline-block">${c}</span>`).join('') : 
                    '<p class="text-gray-500">Aucune pathologie chronique</p>'
                  }
                </div>
              </div>
              
              ${medicalData.emergencyInfo?.criticalNotes ? `
              <div class="bg-red-100 border-2 border-red-300 p-4 rounded-lg">
                <h2 class="text-xl font-bold text-red-800 mb-4">🚨 NOTES CRITIQUES POUR LES SECOURS</h2>
                <p class="text-red-700 text-lg">${medicalData.emergencyInfo.criticalNotes}</p>
              </div>
              ` : ''}
              
              <div class="flex flex-wrap gap-4 justify-center">
                <a href="tel:15" class="bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg px-6 py-3 text-lg">📞 SAMU 15</a>
                <a href="tel:18" class="bg-orange-600 hover:bg-orange-700 text-white font-bold rounded-lg px-6 py-3 text-lg">🚒 Pompiers 18</a>
                <a href="tel:112" class="bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg px-6 py-3 text-lg">🆘 Urgences 112</a>
                <button onclick="SYLUtilities.generatePDF(${JSON.stringify(medicalData).replace(/"/g, '&quot;')})" class="bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg px-6 py-3 text-lg">📄 Export PDF</button>
                <button onclick="this.closest('.fixed').remove()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold rounded-lg px-6 py-3 text-lg">❌ Fermer</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
    
    document.body.appendChild(emergencyInterface);
    
    // Notification sonore si possible
    try {
      const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+HyvmwhBRuBzvLZiTcIGGm98OScTgwOUarm7bZkHgU2jdXxxXkpBSV+zPDckT0IEl+25OqoVRMKRZ/h8r5vIAUdgM3y2Ik3CRZqve/jm04MDlCr5ey2ZSAEOIzU8cV5KgUme8rx3I87CRBtueXrrFgSCUOc3/O+byAFHYDN8tiJNwkWar3v45tODA5Qqubstm');
      audio.play().catch(() => {}); // Ignorer les erreurs audio
    } catch (e) {}
    
    // Auto-fermeture après 5 minutes par sécurité
    setTimeout(() => {
      if (document.body.contains(emergencyInterface)) {
        emergencyInterface.remove();
      }
    }, 300000);
  }
  
  static displayErrorInterface(errorMessage) {
    const errorInterface = document.createElement('div');
    errorInterface.className = 'fixed inset-0 bg-red-900 bg-opacity-90 z-50 flex items-center justify-center';
    errorInterface.innerHTML = `
      <div class="bg-white rounded-lg p-8 max-w-md mx-4 text-center">
        <div class="text-red-600 text-6xl mb-4">❌</div>
        <h2 class="text-2xl font-bold text-gray-900 mb-4">Erreur d'accès NFC</h2>
        <p class="text-gray-700 mb-6">${errorMessage}</p>
        <div class="space-y-4">
          <button onclick="this.closest('.fixed').remove()" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold rounded-lg px-6 py-3">Fermer</button>
          <div class="flex gap-2">
            <a href="tel:15" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg px-4 py-2">SAMU 15</a>
            <a href="tel:112" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg px-4 py-2">112</a>
          </div>
        </div>
      </div>
    `;
    document.body.appendChild(errorInterface);
  }
}

// Initialisation PWA et mode hors ligne
if (typeof window !== 'undefined') {
  SYLUtilities.setupOfflineMode();
  SYLUtilities.requestNotificationPermission();
}

function showLogin() {
  document.getElementById('app').innerHTML = `
<div class="min-h-screen bg-gradient-to-br from-blue-50 via-white to-green-50 flex items-center justify-center p-4">
  <div class="w-full max-w-md">
    <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-8">
      <div class="text-center mb-8">
        <div class="mx-auto w-16 h-16 bg-gradient-to-r from-blue-600 to-green-600 rounded-full flex items-center justify-center mb-4">
          ${icons.heart}
        </div>
        <h1 class="text-2xl font-bold text-gray-900">SYL Medical</h1>
        <p class="text-gray-600 mt-2">Système d'Urgence Médicale</p>
      </div>

      <!-- Sélection du rôle -->
      <div class="grid grid-cols-3 gap-4 mb-6">
        <button type="button" id="rolePatient" class="p-3 rounded-lg border-2 border-blue-600 bg-blue-50 text-blue-700">
          ${icons.user} <span class="text-sm font-medium">Patient</span>
        </button>
        <button type="button" id="roleMedecin" class="p-3 rounded-lg border-2 border-gray-300 hover:border-gray-400">
          ${icons.stethoscope} <span class="text-sm font-medium">Médecin</span>
        </button>
        <button type="button" id="roleAdmin" class="p-3 rounded-lg border-2 border-gray-300 hover:border-gray-400">
          ${icons.settings} <span class="text-sm font-medium">Admin</span>
        </button>
      </div>

      <!-- Onglets de connexion -->
      <div class="flex space-x-2 mb-4">
        <button class="flex-1 py-2 px-4 text-sm rounded-lg bg-blue-600 text-white" id="tabEmail">Email</button>
        <button class="flex-1 py-2 px-4 text-sm rounded-lg bg-gray-200 text-gray-600" id="tabGoogle">Google</button>
        <button class="flex-1 py-2 px-4 text-sm rounded-lg bg-gray-400 text-gray-500 cursor-not-allowed" disabled title="Nécessite la facturation Firebase">SMS (Bientôt)</button>
      </div>

      <!-- Formulaire Email -->
      <div id="emailForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
          <div class="relative">
            <input type="email" id="email" required placeholder="votre@email.com"
              class="w-full px-3 py-2 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">${icons.mail}</span>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Mot de passe</label>
          <input type="password" id="password" required placeholder="••••••••"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"/>
        </div>
        <div class="flex space-x-2">
          <button id="loginEmail" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg px-6 py-3">
            ${icons.lock} Se connecter
          </button>
          <button id="registerEmail" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg px-6 py-3">
            ${icons.user} S'inscrire
          </button>
        </div>
      </div>

      <!-- Formulaire Google -->
      <div id="googleForm" class="hidden">
        <button id="loginGoogle" class="w-full bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg px-6 py-3 flex items-center justify-center gap-2">
          <svg class="w-5 h-5" viewBox="0 0 24 24"><path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
          Se connecter avec Google
        </button>
        <div class="mt-4 p-3 bg-blue-50 rounded-lg">
          <p class="text-blue-700 text-sm">📝 <strong>Note :</strong> Si vous obtenez une erreur "domaine non autorisé", ajoutez votre domaine dans Firebase Console → Authentication → Settings → Authorized domains</p>
        </div>
      </div>

      <div class="mt-8 pt-6 border-t border-gray-200">
        <div class="text-xs text-gray-500 space-y-1">
          <p>🚑 Accès d'urgence instantané</p>
          <p>🔒 Authentification Firebase sécurisée</p>
          <p>🏥 Conforme RGPD & HDS</p>
          <p>⚡ Synchronisation temps réel</p>
        </div>
      </div>
    </div>
  </div>
</div>
  `;

  let role = 'patient';
  let activeTab = 'email';

  // Gestion des rôles
  document.getElementById('rolePatient').onclick = () => {
    role = 'patient';
    updateRoleSelection('rolePatient', 'blue');
  };
  document.getElementById('roleMedecin').onclick = () => {
    role = 'medecin';
    updateRoleSelection('roleMedecin', 'green');
  };
  document.getElementById('roleAdmin').onclick = () => {
    role = 'admin';
    updateRoleSelection('roleAdmin', 'purple');
  };

  function updateRoleSelection(selectedId, color) {
    // Reset tous les boutons
    ['rolePatient', 'roleMedecin', 'roleAdmin'].forEach(id => {
      const btn = document.getElementById(id);
      btn.classList.remove('border-blue-600', 'bg-blue-50', 'text-blue-700');
      btn.classList.remove('border-green-600', 'bg-green-50', 'text-green-700');
      btn.classList.remove('border-purple-600', 'bg-purple-50', 'text-purple-700');
      btn.classList.add('border-gray-300');
    });
    
    // Activer le bouton sélectionné
    const selectedBtn = document.getElementById(selectedId);
    selectedBtn.classList.remove('border-gray-300');
    selectedBtn.classList.add(`border-${color}-600`, `bg-${color}-50`, `text-${color}-700`);
  }

  // Gestion des onglets
  function switchTab(tab) {
    activeTab = tab;
    // Reset tous les onglets
    document.getElementById('tabEmail').classList.remove('bg-blue-600', 'text-white');
    document.getElementById('tabEmail').classList.add('bg-gray-200', 'text-gray-600');
    document.getElementById('tabGoogle').classList.remove('bg-blue-600', 'text-white');
    document.getElementById('tabGoogle').classList.add('bg-gray-200', 'text-gray-600');
    
    // Activer l'onglet sélectionné
    if (tab === 'email') {
      document.getElementById('tabEmail').classList.remove('bg-gray-200', 'text-gray-600');
      document.getElementById('tabEmail').classList.add('bg-blue-600', 'text-white');
    } else if (tab === 'google') {
      document.getElementById('tabGoogle').classList.remove('bg-gray-200', 'text-gray-600');
      document.getElementById('tabGoogle').classList.add('bg-blue-600', 'text-white');
    }
    
    // Afficher le bon formulaire
    document.getElementById('emailForm').classList.add('hidden');
    document.getElementById('googleForm').classList.add('hidden');
    document.getElementById(tab + 'Form').classList.remove('hidden');
  }

  document.getElementById('tabEmail').onclick = () => switchTab('email');
  document.getElementById('tabGoogle').onclick = () => switchTab('google');

  // Authentification par email
  document.getElementById('loginEmail').onclick = async () => {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    
    if (!email || !password) {
      alert('Veuillez remplir tous les champs');
      return;
    }
    
    try {
      showLoader();
      
      // Vérification admin en local d'abord
      if (role === 'admin' && adminAccounts[email] === password) {
        const adminData = {
          uid: 'admin_' + email.replace(/[^a-zA-Z0-9]/g, '_'),
          email: email,
          role: 'admin',
          profile: {
            firstName: 'Admin',
            lastName: 'Système',
            phone: ''
          },
          createdAt: new Date().toISOString()
        };
        saveUser(adminData);
        hideLoader();
        renderApp();
        return;
      }
      
      // Connexion Firebase pour les autres rôles
      const userCredential = await auth.signInWithEmailAndPassword(email, password);
      await handleAuthSuccess(userCredential.user, role);
    } catch (error) {
      hideLoader();
      console.error('Erreur de connexion:', error);
      alert('Erreur de connexion: ' + getErrorMessage(error.code || 'unknown'));
    }
  };

  document.getElementById('registerEmail').onclick = async () => {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    
    if (password.length < 6) {
      alert('Le mot de passe doit contenir au moins 6 caractères');
      return;
    }
    
    try {
      showLoader();
      const userCredential = await auth.createUserWithEmailAndPassword(email, password);
      await handleAuthSuccess(userCredential.user, role);
    } catch (error) {
      hideLoader();
      alert('Erreur d\'inscription: ' + getErrorMessage(error.code));
    }
  };

  // Authentification par Google
  document.getElementById('loginGoogle').onclick = async () => {
    try {
      showLoader();
      const result = await auth.signInWithPopup(googleProvider);
      await handleAuthSuccess(result.user, role);
    } catch (error) {
      hideLoader();
      if (error.code === 'auth/unauthorized-domain') {
        alert('❌ Domaine non autorisé.\n\n📝 Solution :\n1. Allez dans Firebase Console\n2. Authentication → Settings → Authorized domains\n3. Ajoutez "localhost" et votre domaine');
      } else {
        alert('Erreur de connexion Google: ' + getErrorMessage(error.code));
      }
    }
  };
}

async function handleAuthSuccess(firebaseUser, role) {
  try {
    const userData = {
      uid: firebaseUser.uid,
      email: firebaseUser.email,
      phone: firebaseUser.phoneNumber,
      displayName: firebaseUser.displayName,
      role: role,
      profile: {
        firstName: role === 'patient' ? (firebaseUser.displayName?.split(' ')[0] || 'Patient') : 'Dr. ' + (firebaseUser.displayName?.split(' ')[0] || 'Médecin'),
        lastName: firebaseUser.displayName?.split(' ').slice(1).join(' ') || '',
        phone: firebaseUser.phoneNumber || '',
        ...(role === 'medecin' && { 
          speciality: 'Médecine générale', 
          hospital: 'Établissement de santé' 
        })
      },
      createdAt: new Date().toISOString()
    };
    
    saveUser(userData);
    hideLoader();
    renderApp();
  } catch (error) {
    hideLoader();
    console.error('Erreur lors de la sauvegarde:', error);
    alert('Connexion réussie mais erreur de sauvegarde');
  }
}

function getErrorMessage(errorCode) {
  switch (errorCode) {
    case 'auth/user-not-found':
      return 'Aucun compte trouvé avec cet email';
    case 'auth/wrong-password':
      return 'Mot de passe incorrect';
    case 'auth/email-already-in-use':
      return 'Cet email est déjà utilisé';
    case 'auth/weak-password':
      return 'Mot de passe trop faible';
    case 'auth/invalid-email':
      return 'Email invalide';
    case 'auth/too-many-requests':
      return 'Trop de tentatives, réessayez plus tard';
    case 'unknown':
      return 'Erreur de connexion inconnue';
    default:
      return errorCode || 'Erreur de connexion';
  }
}

function hideLoader() {
  const loader = document.querySelector('.animate-spin')?.parentElement?.parentElement;
  if (loader) loader.remove();
}

function showLoader(callback = null) {
  document.getElementById('app').innerHTML = `
    <div class="min-h-screen bg-gray-50 flex items-center justify-center">
      <div class="text-center">
        <div class="w-16 h-16 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
        <p class="text-gray-600">Authentification en cours...</p>
      </div>
    </div>
  `;
  if (callback) setTimeout(callback, 800);
}

// Système de rappels et notifications
class ReminderSystem {
  static init() {
    this.checkReminders();
    setInterval(() => this.checkReminders(), 60000); // Vérification chaque minute
  }
  
  static checkReminders() {
    const medicalData = JSON.parse(localStorage.getItem('syl-medicalData') || '{}');
    const reminders = JSON.parse(localStorage.getItem('syl-reminders') || '[]');
    const now = new Date();
    
    reminders.forEach(reminder => {
      const reminderTime = new Date(reminder.dateTime);
      if (reminderTime <= now && !reminder.notified) {
        SYLUtilities.showNotification(`💊 Rappel: ${reminder.title}`, {
          body: reminder.message,
          icon: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA4MDAgODAwIj48YyB4PSI4MDAiIHk9IjQ3MiIgY3g9IjE5MiIgY3k9IjI4IiByPSI1MiIvPjwvc3ZnPg==',
          tag: reminder.id
        });
        reminder.notified = true;
      }
    });
    
    localStorage.setItem('syl-reminders', JSON.stringify(reminders));
  }
  
  static addReminder(title, message, dateTime) {
    const reminders = JSON.parse(localStorage.getItem('syl-reminders') || '[]');
    const reminder = {
      id: Date.now().toString(),
      title,
      message,
      dateTime,
      notified: false,
      created: new Date().toISOString()
    };
    reminders.push(reminder);
    localStorage.setItem('syl-reminders', JSON.stringify(reminders));
    return reminder;
  }
}

// Vérification de sécurité et validation des données
class DataValidator {
  static validateMedicalData(data) {
    const errors = [];
    
    if (!data.personalInfo?.firstName) {
      errors.push('Prénom requis');
    }
    
    if (!data.personalInfo?.lastName) {
      errors.push('Nom requis');
    }
    
    if (!data.personalInfo?.bloodType) {
      errors.push('Groupe sanguin recommandé pour les urgences');
    }
    
    if (!data.personalInfo?.emergencyContact?.phone) {
      errors.push('Contact d\'urgence requis');
    }
    
    return errors;
  }
  
  static sanitizeInput(input) {
    if (typeof input !== 'string') return input;
    return input.replace(/[<>]/g, '').trim();
  }
}

// Initialisation des systèmes
document.addEventListener('DOMContentLoaded', () => {
  ReminderSystem.init();
});

// ----------- PATIENT DASHBOARD -----------
function renderPatientDashboard(user) {
  let medicalData = JSON.parse(localStorage.getItem('syl-medicalData') || 'null');
  if (!medicalData) {
    medicalData = {
      personalInfo: {
        firstName: user.profile.firstName,
        lastName: user.profile.lastName,
        dateOfBirth: '',
        bloodType: '',
        height: '',
        weight: '',
        emergencyContact: { name: '', relation: '', phone: '' },
        secondaryContact: { name: '', relation: '', phone: '' },
        address: '',
        city: '',
        postalCode: '',
        nationalId: '',
        socialSecurityNumber: '',
        insuranceNumber: '',
        preferredHospital: '',
        organDonor: false,
        advanceDirectives: false
      },
      medicalHistory: {
        allergies: [],
        medications: [],
        conditions: [],
        surgeries: [],
        chronicDiseases: [],
        medicalDevices: [],
        emergencyMedications: []
      },
      emergencyInfo: {
        primaryPhysician: { name: '', phone: '', specialty: '' },
        pharmacist: { name: '', phone: '', address: '' },
        lastUpdate: new Date().toISOString(),
        criticalNotes: '',
        contraindications: [],
        riskFactors: []
      },
      braceletId: '',
      isActive: false
    };
  }
  localStorage.setItem('syl-medicalData', JSON.stringify(medicalData));
  let activeTab = 'emergency';
  render();

  function render() {
    document.getElementById('app').innerHTML = `
    <div class="min-h-screen bg-gray-50">
      <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center h-16">
          <div class="flex items-center">
            ${icons.heart}<h1 class="text-xl font-bold text-gray-900 ml-3">SYL Patient</h1>
          </div>
          <div class="flex items-center space-x-4">
            <div class="text-sm text-gray-600">Bonjour, ${user.profile.firstName}</div>
            <button id="logoutBtn" class="border-2 border-blue-600 text-blue-600 hover:bg-blue-50 font-medium rounded-lg px-4 py-2 flex items-center gap-2">${icons.logout} Déconnexion</button>
          </div>
        </div>
      </header>
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
          <div class="lg:col-span-1">
            <nav class="space-y-2">
              <button class="w-full flex items-center px-4 py-3 text-left rounded-lg transition-colors ${activeTab==='emergency' ? 'bg-red-100 text-red-700 border-l-4 border-red-600':'text-gray-600 hover:bg-gray-100'}" data-tab="emergency">${icons.emergency} <span class="ml-3">🚑 Urgence</span></button>
              <button class="w-full flex items-center px-4 py-3 text-left rounded-lg transition-colors ${activeTab==='profile' ? 'bg-blue-100 text-blue-700 border-l-4 border-blue-600':'text-gray-600 hover:bg-gray-100'}" data-tab="profile">${icons.user} <span class="ml-3">Profil complet</span></button>
              <button class="w-full flex items-center px-4 py-3 text-left rounded-lg transition-colors ${activeTab==='medical' ? 'bg-blue-100 text-blue-700 border-l-4 border-blue-600':'text-gray-600 hover:bg-gray-100'}" data-tab="medical">${icons.medical} <span class="ml-3">Médical</span></button>
              <button class="w-full flex items-center px-4 py-3 text-left rounded-lg transition-colors ${activeTab==='history' ? 'bg-blue-100 text-blue-700 border-l-4 border-blue-600':'text-gray-600 hover:bg-gray-100'}" data-tab="history">${icons.activity} <span class="ml-3">Historique</span></button>
              <button class="w-full flex items-center px-4 py-3 text-left rounded-lg transition-colors ${activeTab==='bracelet' ? 'bg-blue-100 text-blue-700 border-l-4 border-blue-600':'text-gray-600 hover:bg-gray-100'}" data-tab="bracelet">${icons.smartphone} <span class="ml-3">Bracelet</span></button>
              <button class="w-full flex items-center px-4 py-3 text-left rounded-lg transition-colors ${activeTab==='reminders' ? 'bg-blue-100 text-blue-700 border-l-4 border-blue-600':'text-gray-600 hover:bg-gray-100'}" data-tab="reminders">${icons.clock} <span class="ml-3">Rappels</span></button>
            </nav>
          </div>
          <div class="lg:col-span-3">
            ${activeTab === 'emergency' ? renderEmergencyTab() : ''}
            ${activeTab === 'profile' ? renderProfileTab() : ''}
            ${activeTab === 'medical' ? renderMedicalTab() : ''}
            ${activeTab === 'history' ? renderHistoryTab() : ''}
            ${activeTab === 'bracelet' ? renderBraceletTab() : ''}
            ${activeTab === 'reminders' ? renderRemindersTab() : ''}
          </div>
        </div>
      </div>
    </div>
`;
    document.getElementById('logoutBtn').onclick = () => { logout(); };
    document.querySelectorAll('[data-tab]').forEach(btn => btn.onclick = () => { activeTab = btn.getAttribute('data-tab'); render(); });
    if (activeTab === 'emergency') tabEmergencyEvents();
    if (activeTab === 'profile') tabProfileEvents();
    if (activeTab === 'medical') tabMedicalEvents();
    if (activeTab === 'bracelet') tabBraceletEvents();
    if (activeTab === 'reminders') tabRemindersEvents();
  }

  function renderEmergencyTab() {
    return `
      <div class="space-y-6">
        <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-lg">
          <div class="flex items-center">
            <div class="text-red-500 mr-3">${icons.emergency}</div>
            <h2 class="text-2xl font-bold text-red-800">INFORMATIONS D'URGENCE</h2>
          </div>
          <p class="text-red-700 mt-2">Ces informations sont critiques pour les secours</p>
        </div>

        <!-- Carte d'identité d'urgence -->
        <div class="bg-white rounded-xl shadow-lg border-l-4 border-red-500 p-6">
          <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
            ${icons.cross} <span class="ml-2">CARTE D'URGENCE MÉDICALE</span>
          </h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="space-y-4">
              <div class="bg-red-50 p-4 rounded-lg">
                <h4 class="font-bold text-red-800">IDENTITÉ</h4>
                <p><strong>Nom:</strong> ${medicalData.personalInfo.lastName}</p>
                <p><strong>Prénom:</strong> ${medicalData.personalInfo.firstName}</p>
                <p><strong>Né(e) le:</strong> ${medicalData.personalInfo.dateOfBirth}</p>
                <p><strong>Groupe sanguin:</strong> <span class="bg-red-600 text-white px-2 py-1 rounded font-bold">${medicalData.personalInfo.bloodType || 'NON RENSEIGNÉ'}</span></p>
              </div>
              <div class="bg-orange-50 p-4 rounded-lg">
                <h4 class="font-bold text-orange-800">CONTACTS D'URGENCE</h4>
                <p><strong>Principal:</strong> ${medicalData.personalInfo.emergencyContact.name} (${medicalData.personalInfo.emergencyContact.relation})</p>
                <p><strong>Tél:</strong> ${medicalData.personalInfo.emergencyContact.phone}</p>
                <p><strong>Secondaire:</strong> ${medicalData.personalInfo.secondaryContact.name}</p>
                <p><strong>Tél:</strong> ${medicalData.personalInfo.secondaryContact.phone}</p>
              </div>
            </div>
            <div class="space-y-4">
              <div class="bg-yellow-50 p-4 rounded-lg">
                <h4 class="font-bold text-yellow-800">⚠️ ALLERGIES CRITIQUES</h4>
                ${medicalData.medicalHistory.allergies.length ? medicalData.medicalHistory.allergies.map(a => `<span class="bg-red-500 text-white px-2 py-1 rounded text-sm mr-1 mb-1 inline-block">${a}</span>`).join('') : '<p class="text-gray-500">Aucune allergie connue</p>'}
              </div>
              <div class="bg-blue-50 p-4 rounded-lg">
                <h4 class="font-bold text-blue-800">💊 TRAITEMENTS EN COURS</h4>
                ${medicalData.medicalHistory.medications.length ? medicalData.medicalHistory.medications.slice(0,5).map(m => `<span class="bg-blue-500 text-white px-2 py-1 rounded text-sm mr-1 mb-1 inline-block">${m}</span>`).join('') : '<p class="text-gray-500">Aucun traitement</p>'}
              </div>
              <div class="bg-purple-50 p-4 rounded-lg">
                <h4 class="font-bold text-purple-800">🏥 PATHOLOGIES</h4>
                ${medicalData.medicalHistory.chronicDiseases.length ? medicalData.medicalHistory.chronicDiseases.map(c => `<span class="bg-purple-500 text-white px-2 py-1 rounded text-sm mr-1 mb-1 inline-block">${c}</span>`).join('') : '<p class="text-gray-500">Aucune pathologie chronique</p>'}
              </div>
            </div>
          </div>
          ${medicalData.emergencyInfo.criticalNotes ? `
          <div class="mt-6 bg-red-100 border border-red-300 p-4 rounded-lg">
            <h4 class="font-bold text-red-800 mb-2">🚨 NOTES CRITIQUES POUR LES SECOURS</h4>
            <p class="text-red-700">${medicalData.emergencyInfo.criticalNotes}</p>
          </div>
          ` : ''}
        </div>

        <!-- Médecin traitant -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">👨‍⚕️ Médecin traitant</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Dr. Nom" value="${medicalData.emergencyInfo.primaryPhysician.name}" id="physicianName">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Spécialité" value="${medicalData.emergencyInfo.primaryPhysician.specialty}" id="physicianSpecialty">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Téléphone" value="${medicalData.emergencyInfo.primaryPhysician.phone}" id="physicianPhone">
          </div>
        </div>

        <!-- Notes critiques -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">🚨 Notes critiques pour les secours</h3>
          <textarea class="w-full px-3 py-2 border border-gray-300 rounded-lg h-24" placeholder="Informations vitales à communiquer aux secours (ex: risque d'allergie, contre-indications spécifiques...)" id="criticalNotes">${medicalData.emergencyInfo.criticalNotes}</textarea>
        </div>

        <!-- Nouvelles fonctionnalités d'urgence -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
          <button id="generateQR" class="bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg px-4 py-3 flex items-center justify-center gap-2">
            📱 QR Code
          </button>
          <button id="getLocation" class="bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg px-4 py-3 flex items-center justify-center gap-2">
            📍 Localisation
          </button>
          <button id="exportPDF" class="bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-lg px-4 py-3 flex items-center justify-center gap-2">
            📄 Export PDF
          </button>
          <button id="emergencyCall" class="bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg px-4 py-3 flex items-center justify-center gap-2">
            📞 SAMU 15
          </button>
        </div>

        <button id="saveEmergency" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg px-6 py-3 text-lg">
          ${icons.check} SAUVEGARDER LES INFOS D'URGENCE
        </button>
      </div>
    `;
  }

  function renderProfileTab() {
    return `
      <div class="space-y-6">
        <div class="flex justify-between items-center">
          <h2 class="text-2xl font-bold text-gray-900">Profil Complet</h2>
          <button id="saveProfile" class="bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg px-6 py-2 flex items-center gap-2">${icons.check} Sauvegarder</button>
        </div>

        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Informations personnelles</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Prénom" value="${medicalData.personalInfo.firstName}" id="pfFirstName">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Nom" value="${medicalData.personalInfo.lastName}" id="pfLastName">
            <input type="date" class="w-full px-3 py-2 border border-gray-300 rounded-lg" value="${medicalData.personalInfo.dateOfBirth}" id="pfBirth">
            <select class="w-full px-3 py-2 border border-gray-300 rounded-lg" id="pfBlood">
              <option value="">Groupe sanguin</option>
              ${MEDICAL_DATA.bloodTypes.map(type => `<option value="${type}" ${medicalData.personalInfo.bloodType===type?'selected':''}>${type}</option>`).join('')}
            </select>
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Taille (cm)" value="${medicalData.personalInfo.height}" id="pfHeight">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Poids (kg)" value="${medicalData.personalInfo.weight}" id="pfWeight">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="N° Sécurité Sociale" value="${medicalData.personalInfo.socialSecurityNumber}" id="pfSSN">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="N° Mutuelle" value="${medicalData.personalInfo.insuranceNumber}" id="pfInsurance">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Adresse" value="${medicalData.personalInfo.address}" id="pfAddress">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Ville" value="${medicalData.personalInfo.city}" id="pfCity">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Code postal" value="${medicalData.personalInfo.postalCode}" id="pfPostal">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Hôpital de référence" value="${medicalData.personalInfo.preferredHospital}" id="pfHospital">
          </div>
          
          <div class="mt-6 space-y-4">
            <h4 class="font-semibold text-gray-900">Contacts d'urgence</h4>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Contact principal" value="${medicalData.personalInfo.emergencyContact.name}" id="pfContact1Name">
              <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Relation" value="${medicalData.personalInfo.emergencyContact.relation}" id="pfContact1Rel">
              <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Téléphone" value="${medicalData.personalInfo.emergencyContact.phone}" id="pfContact1Phone">
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Contact secondaire" value="${medicalData.personalInfo.secondaryContact.name}" id="pfContact2Name">
              <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Relation" value="${medicalData.personalInfo.secondaryContact.relation}" id="pfContact2Rel">
              <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Téléphone" value="${medicalData.personalInfo.secondaryContact.phone}" id="pfContact2Phone">
            </div>
          </div>

          <div class="mt-6 space-y-2">
            <label class="flex items-center">
              <input type="checkbox" ${medicalData.personalInfo.organDonor ? 'checked' : ''} id="pfOrganDonor" class="mr-2">
              <span>Donneur d'organes</span>
            </label>
            <label class="flex items-center">
              <input type="checkbox" ${medicalData.personalInfo.advanceDirectives ? 'checked' : ''} id="pfDirectives" class="mr-2">
              <span>Directives anticipées rédigées</span>
            </label>
          </div>
        </div>
      </div>
    `;
  }

  function renderMedicalTab() {
    return `
      <div class="space-y-6">
        <h2 class="text-2xl font-bold text-gray-900">Dossier Médical Complet</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          ${renderMedicalListManager('Allergies', 'allergies', MEDICAL_DATA.commonAllergies)}
          ${renderMedicalListManager('Médicaments actuels', 'medications', MEDICAL_DATA.emergencyMedications)}
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          ${renderMedicalListManager('Pathologies chroniques', 'chronicDiseases', MEDICAL_DATA.chronicConditions)}
          ${renderMedicalListManager('Dispositifs médicaux', 'medicalDevices', MEDICAL_DATA.medicalDevices)}
        </div>
        
        ${renderMedicalListManager('Interventions chirurgicales', 'surgeries', [])}
        ${renderMedicalListManager('Médicaments d\'urgence', 'emergencyMedications', MEDICAL_DATA.emergencyMedications)}
        ${renderMedicalListManager('Contre-indications', 'contraindications', [])}
        ${renderMedicalListManager('Facteurs de risque', 'riskFactors', [])}
      </div>
    `;
  }

  function renderMedicalListManager(title, listType, suggestions) {
    const list = listType.includes('.') ? 
      medicalData.medicalHistory[listType.split('.')[1]] || medicalData.emergencyInfo[listType.split('.')[1]] :
      medicalData.medicalHistory[listType] || medicalData.emergencyInfo[listType] || [];
    
    return `
      <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">${title}</h3>
        <div class="space-y-3">
          <div class="flex gap-2">
            <input type="text" list="suggestions_${listType}" placeholder="Ajouter..." class="flex-1 px-3 py-2 border border-gray-300 rounded-lg" id="add_${listType}">
            <datalist id="suggestions_${listType}">
              ${suggestions.map(item => `<option value="${item}">`).join('')}
            </datalist>
            <button class="bg-blue-600 hover:bg-blue-700 text-white rounded-lg px-3 py-2" id="btn_${listType}">${icons.plus}</button>
          </div>
          <div class="space-y-2" id="list_${listType}">
            ${list.map((item, idx) => `
              <div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg">
                <span class="text-gray-700">${item}</span>
                <button class="text-red-600 hover:text-red-700" data-del="${listType}" data-idx="${idx}">${icons.trash}</button>
              </div>
            `).join('')}
          </div>
        </div>
      </div>
    `;
  }

  function renderHistoryTab() {
    return `<div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
      <h2 class="text-xl font-bold text-gray-900 mb-4">Historique médical</h2>
      <p class="text-gray-600">Aucune consultation enregistrée.</p>
      <div class="mt-4 p-4 bg-blue-50 rounded-lg">
        <p class="text-blue-700">Dernière mise à jour: ${new Date(medicalData.emergencyInfo.lastUpdate).toLocaleString('fr-FR')}</p>
      </div>
    </div>`;
  }

  function renderBraceletTab() {
    return `
      <div class="space-y-6">
        <h2 class="text-2xl font-bold text-gray-900">Bracelet SYL d'Urgence</h2>
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
          <div class="text-center">
            <div class="mx-auto w-24 h-24 bg-gradient-to-r from-red-600 to-orange-600 rounded-full flex items-center justify-center mb-4">${icons.smartphone}</div>
            <h3 class="text-xl font-semibold text-gray-900 mb-2">Bracelet d'urgence médicale</h3>
            <p class="text-gray-600 mb-6">${medicalData.isActive ? 'Votre bracelet est actif et accessible aux secours' : 'Activez votre bracelet pour l\'accès d\'urgence'}</p>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
              <div class="bg-red-50 p-4 rounded-lg">${icons.emergency}<p class="text-sm font-medium text-red-700">Accès Urgence 24h/24</p></div>
              <div class="bg-blue-50 p-4 rounded-lg">${icons.shield}<p class="text-sm font-medium text-blue-700">NFC Sécurisé</p></div>
              <div class="bg-green-50 p-4 rounded-lg">${icons.clock}<p class="text-sm font-medium text-green-700">Sync Temps Réel</p></div>
            </div>

            <div class="mb-6 p-4 bg-yellow-50 rounded-lg">
              <h4 class="font-bold text-yellow-800 mb-2">🚨 Code d'accès d'urgence</h4>
              <p class="text-2xl font-mono font-bold text-yellow-900">${medicalData.braceletId || 'SYL-' + Math.random().toString(36).substr(2,6).toUpperCase()}</p>
              <p class="text-sm text-yellow-700 mt-1">À communiquer aux secours pour accès immédiat</p>
            </div>

            <button class="${medicalData.isActive ? 'bg-gray-200 text-gray-600' : 'bg-red-600 text-white hover:bg-red-700'} rounded-lg px-6 py-3 font-bold" id="activateBracelet">
              ${medicalData.isActive ? 'Bracelet d\'Urgence Activé' : 'Activer le Bracelet d\'Urgence'}
            </button>
          </div>
        </div>
      </div>
    `;
  }

  function renderRemindersTab() {
    const reminders = JSON.parse(localStorage.getItem('syl-reminders') || '[]');
    return `
      <div class="space-y-6">
        <div class="flex justify-between items-center">
          <h2 class="text-2xl font-bold text-gray-900">Rappels Médicaux</h2>
          <button id="addReminder" class="bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg px-6 py-2 flex items-center gap-2">${icons.plus} Nouveau rappel</button>
        </div>

        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Créer un rappel</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <input type="text" id="reminderTitle" placeholder="Titre du rappel" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            <select id="reminderType" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
              <option value="medication">💊 Médicament</option>
              <option value="appointment">🏥 Rendez-vous</option>
              <option value="checkup">🔍 Contrôle</option>
              <option value="exercise">🏃 Exercice</option>
              <option value="other">📝 Autre</option>
            </select>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <input type="date" id="reminderDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            <input type="time" id="reminderTime" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
          </div>
          <textarea id="reminderMessage" placeholder="Message du rappel..." class="w-full px-3 py-2 border border-gray-300 rounded-lg h-20 mb-4"></textarea>
          <button id="saveReminder" class="bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg px-6 py-2">Créer le rappel</button>
        </div>

        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Rappels programmés</h3>
          <div class="space-y-3" id="remindersList">
            ${reminders.length ? reminders.map((reminder, idx) => `
              <div class="flex items-center justify-between bg-gray-50 p-4 rounded-lg ${reminder.notified ? 'opacity-50' : ''}">
                <div>
                  <h4 class="font-medium text-gray-900">${reminder.title}</h4>
                  <p class="text-sm text-gray-600">${reminder.message}</p>
                  <p class="text-sm text-blue-600">${new Date(reminder.dateTime).toLocaleString('fr-FR')}</p>
                </div>
                <div class="flex gap-2">
                  ${reminder.notified ? '<span class="text-green-600">✓ Notifié</span>' : '<span class="text-orange-600">⏰ En attente</span>'}
                  <button class="text-red-600 hover:text-red-700" onclick="deleteReminder(${idx})">${icons.trash}</button>
                </div>
              </div>
            `).join('') : '<p class="text-gray-500 text-center py-8">Aucun rappel programmé</p>'}
          </div>
        </div>
      </div>
    `;
  }

  function tabEmergencyEvents() {
    // Nouvelles fonctionnalités d'urgence
    document.getElementById('generateQR')?.addEventListener('click', () => {
      const qrUrl = SYLUtilities.generateEmergencyQR(medicalData);
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-md mx-4">
          <h3 class="text-lg font-bold mb-4">QR Code d'Urgence</h3>
          <img src="${qrUrl}" alt="QR Code" class="w-full max-w-xs mx-auto mb-4" />
          <p class="text-sm text-gray-600 mb-4">Scannez ce code pour accéder rapidement aux informations d'urgence</p>
          <div class="flex gap-2">
            <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white rounded px-4 py-2">Fermer</button>
            <a href="${qrUrl}" download="qr-urgence.png" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white rounded px-4 py-2 text-center">Télécharger</a>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    });

    document.getElementById('getLocation')?.addEventListener('click', async () => {
      try {
        const location = await SYLUtilities.getEmergencyLocation();
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
          <div class="bg-white rounded-lg p-6 max-w-md mx-4">
            <h3 class="text-lg font-bold mb-4">📍 Localisation d'Urgence</h3>
            <p class="mb-2"><strong>Latitude:</strong> ${location.latitude.toFixed(6)}</p>
            <p class="mb-2"><strong>Longitude:</strong> ${location.longitude.toFixed(6)}</p>
            <p class="mb-2"><strong>Précision:</strong> ±${Math.round(location.accuracy)}m</p>
            <p class="text-sm text-gray-600 mb-4">Coordonnées GPS à communiquer aux secours</p>
            <div class="flex gap-2">
              <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white rounded px-4 py-2">Fermer</button>
              <button onclick="navigator.clipboard.writeText('${location.latitude}, ${location.longitude}'); alert('Coordonnées copiées !')" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white rounded px-4 py-2">Copier</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      } catch (error) {
        alert('❌ Impossible d\'obtenir la localisation: ' + error);
      }
    });

    document.getElementById('exportPDF')?.addEventListener('click', () => {
      SYLUtilities.generatePDF(medicalData);
      SYLUtilities.showNotification('Fiche d\'urgence générée', {
        body: 'Votre fiche médicale d\'urgence a été téléchargée'
      });
    });

    document.getElementById('emergencyCall')?.addEventListener('click', () => {
      if (confirm('Composer le 15 (SAMU) ?')) {
        window.open('tel:15');
      }
    });

    document.getElementById('saveEmergency').onclick = async () => {
      medicalData.emergencyInfo.primaryPhysician.name = document.getElementById('physicianName').value;
      medicalData.emergencyInfo.primaryPhysician.specialty = document.getElementById('physicianSpecialty').value;
      medicalData.emergencyInfo.primaryPhysician.phone = document.getElementById('physicianPhone').value;
      medicalData.emergencyInfo.criticalNotes = document.getElementById('criticalNotes').value;
      medicalData.emergencyInfo.lastUpdate = new Date().toISOString();
      localStorage.setItem('syl-medicalData', JSON.stringify(medicalData));
      
      // Synchronisation Firebase automatique
      if (user.uid) {
        const success = await saveToFirebase('patients', medicalData, user.uid + '_medical');
        if (success) {
          SYLUtilities.showNotification('Données sauvegardées', {
            body: 'Vos informations d\'urgence ont été mises à jour'
          });
          alert('✅ Données d\'urgence sauvegardées et synchronisées avec Firebase !');
        } else {
          alert('⚠️ Données sauvegardées localement. Synchronisation Firebase échouée.');
        }
      } else {
        alert('✅ Données d\'urgence sauvegardées !');
      }
      render();
    };
  }

  function tabProfileEvents() {
    document.getElementById('saveProfile').onclick = async () => {
      medicalData.personalInfo.firstName = document.getElementById('pfFirstName').value;
      medicalData.personalInfo.lastName = document.getElementById('pfLastName').value;
      medicalData.personalInfo.dateOfBirth = document.getElementById('pfBirth').value;
      medicalData.personalInfo.bloodType = document.getElementById('pfBlood').value;
      medicalData.personalInfo.height = document.getElementById('pfHeight').value;
      medicalData.personalInfo.weight = document.getElementById('pfWeight').value;
      medicalData.personalInfo.socialSecurityNumber = document.getElementById('pfSSN').value;
      medicalData.personalInfo.insuranceNumber = document.getElementById('pfInsurance').value;
      medicalData.personalInfo.address = document.getElementById('pfAddress').value;
      medicalData.personalInfo.city = document.getElementById('pfCity').value;
      medicalData.personalInfo.postalCode = document.getElementById('pfPostal').value;
      medicalData.personalInfo.preferredHospital = document.getElementById('pfHospital').value;
      medicalData.personalInfo.emergencyContact.name = document.getElementById('pfContact1Name').value;
      medicalData.personalInfo.emergencyContact.relation = document.getElementById('pfContact1Rel').value;
      medicalData.personalInfo.emergencyContact.phone = document.getElementById('pfContact1Phone').value;
      medicalData.personalInfo.secondaryContact.name = document.getElementById('pfContact2Name').value;
      medicalData.personalInfo.secondaryContact.relation = document.getElementById('pfContact2Rel').value;
      medicalData.personalInfo.secondaryContact.phone = document.getElementById('pfContact2Phone').value;
      medicalData.personalInfo.organDonor = document.getElementById('pfOrganDonor').checked;
      medicalData.personalInfo.advanceDirectives = document.getElementById('pfDirectives').checked;
      localStorage.setItem('syl-medicalData', JSON.stringify(medicalData));
      
      // Synchronisation Firebase automatique
      if (user.uid) {
        const success = await saveToFirebase('patients', medicalData, user.uid + '_medical');
        if (success) {
          alert('✅ Profil sauvegardé et synchronisé avec Firebase !');
        } else {
          alert('⚠️ Profil sauvegardé localement. Synchronisation Firebase échouée.');
        }
      } else {
        alert('✅ Profil sauvegardé !');
      }
      render();
    };
  }

  function tabMedicalEvents() {
    const listTypes = ['allergies', 'medications', 'chronicDiseases', 'medicalDevices', 'surgeries', 'emergencyMedications', 'contraindications', 'riskFactors'];
    listTypes.forEach(type => {
      const btnEl = document.getElementById(`btn_${type}`);
      if (btnEl) {
        btnEl.onclick = async () => {
          const v = document.getElementById(`add_${type}`).value.trim();
          if (v) {
            if (medicalData.medicalHistory[type]) {
              medicalData.medicalHistory[type].push(v);
            } else if (medicalData.emergencyInfo[type]) {
              medicalData.emergencyInfo[type].push(v);
            }
            localStorage.setItem('syl-medicalData', JSON.stringify(medicalData));
            
            // Synchronisation Firebase automatique
            if (user.uid) {
              await saveToFirebase('patients', medicalData, user.uid + '_medical');
            }
            render();
          }
        };
      }
      document.querySelectorAll(`[data-del="${type}"]`).forEach(btn => btn.onclick = async () => {
        const idx = parseInt(btn.getAttribute('data-idx'));
        if (medicalData.medicalHistory[type]) {
          medicalData.medicalHistory[type].splice(idx, 1);
        } else if (medicalData.emergencyInfo[type]) {
          medicalData.emergencyInfo[type].splice(idx, 1);
        }
        localStorage.setItem('syl-medicalData', JSON.stringify(medicalData));
        
        // Synchronisation Firebase automatique
        if (user.uid) {
          await saveToFirebase('patients', medicalData, user.uid + '_medical');
        }
        render();
      });
    });
  }

  function tabBraceletEvents() {
    document.getElementById('activateBracelet').onclick = async () => {
      medicalData.isActive = true;
      if (!medicalData.braceletId) {
        medicalData.braceletId = 'SYL-' + Math.random().toString(36).substr(2,6).toUpperCase();
      }
      localStorage.setItem('syl-medicalData', JSON.stringify(medicalData));
      
      // Synchronisation Firebase automatique
      if (user.uid) {
        const success = await saveToFirebase('patients', medicalData, user.uid + '_medical');
        if (success) {
          alert('✅ Bracelet d\'urgence activé et synchronisé avec Firebase !');
        } else {
          alert('⚠️ Bracelet activé localement. Synchronisation Firebase échouée.');
        }
      } else {
        alert('✅ Bracelet d\'urgence activé !');
      }
      render();
    };
  }

  function tabRemindersEvents() {
    document.getElementById('saveReminder')?.addEventListener('click', () => {
      const title = document.getElementById('reminderTitle').value;
      const type = document.getElementById('reminderType').value;
      const date = document.getElementById('reminderDate').value;
      const time = document.getElementById('reminderTime').value;
      const message = document.getElementById('reminderMessage').value;
      
      if (!title || !date || !time) {
        alert('Veuillez remplir tous les champs obligatoires');
        return;
      }
      
      const dateTime = new Date(`${date}T${time}`);
      const finalMessage = message || `Rappel: ${title}`;
      
      ReminderSystem.addReminder(title, finalMessage, dateTime.toISOString());
      
      // Reset form
      document.getElementById('reminderTitle').value = '';
      document.getElementById('reminderMessage').value = '';
      
      SYLUtilities.showNotification('Rappel créé', {
        body: `Rappel programmé pour le ${dateTime.toLocaleString('fr-FR')}`
      });
      
      render();
    });
  }
}

// Fonctions globales pour les rappels
function deleteReminder(index) {
  if (confirm('Supprimer ce rappel ?')) {
    const reminders = JSON.parse(localStorage.getItem('syl-reminders') || '[]');
    reminders.splice(index, 1);
    localStorage.setItem('syl-reminders', JSON.stringify(reminders));
    
    // Re-render si on est sur la page des rappels
    const activeTabEl = document.querySelector('[data-tab].bg-blue-100');
    if (activeTabEl && activeTabEl.getAttribute('data-tab') === 'reminders') {
      // Recharger la section des rappels
      location.reload();
    }
  }
}

// Fonction globale pour charger les patients depuis Firebase
async function loadPatientsFromFirebase() {
  try {
    if (!db || typeof db.collection !== 'function') {
      throw new Error('Firebase non initialisé correctement');
    }

    // Vérifier l'authentification
    const currentUser = firebase.auth().currentUser;
    if (!currentUser) {
      throw new Error('Vous devez être connecté pour accéder aux données Firebase');
    }

    console.log('Utilisateur connecté:', currentUser.email);
    console.log('UID:', currentUser.uid);
    console.log('Tentative de chargement des patients depuis Firebase...');
    
    // Essayer différentes approches selon les permissions
    let firebaseUsers = [];
    let permissionTestPassed = false;
    
    // Test 1: Essayer de lire sa propre donnée utilisateur
    try {
      const userDoc = await db.collection('users').doc(currentUser.uid).get();
      console.log('✅ Lecture du profil utilisateur réussie');
      permissionTestPassed = true;
      
      const userData = userDoc.data();
      if (userData && (userData.role === 'admin' || userData.role === 'Admin')) {
        console.log('✅ Utilisateur admin détecté');
      } else {
        console.log('⚠️ Utilisateur non-admin:', userData?.role);
      }
    } catch (userError) {
      console.error('❌ Impossible de lire le profil utilisateur:', userError);
    }
    
    // Test 2: Essayer de lire tous les utilisateurs (pour admin)
    if (permissionTestPassed) {
      try {
        const usersSnapshot = await db.collection('users').limit(3).get();
        console.log('✅ Test lecture collection users réussi, documents:', usersSnapshot.size);
      } catch (readError) {
        console.error('❌ Lecture collection users refusée:', readError.code);
        
        // Afficher un guide détaillé pour résoudre le problème
        const errorModal = document.createElement('div');
        errorModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        errorModal.innerHTML = `
          <div class="bg-white rounded-lg p-6 max-w-2xl mx-4 max-h-96 overflow-y-auto">
            <h3 class="text-lg font-bold text-red-600 mb-4">🔒 Problème de Permissions Firebase</h3>
            <div class="space-y-4 text-sm">
              <div class="bg-yellow-50 border border-yellow-200 rounded p-3">
                <p><strong>Utilisateur connecté:</strong> ${currentUser.email}</p>
                <p><strong>UID:</strong> ${currentUser.uid}</p>
              </div>
              
              <div class="bg-blue-50 border border-blue-200 rounded p-3">
                <h4 class="font-bold text-blue-800 mb-2">📋 Solutions rapides:</h4>
                <ol class="space-y-1 text-blue-700">
                  <li><strong>1. Règles temporaires (développement):</strong></li>
                  <li class="ml-4 font-mono text-xs bg-gray-100 p-2 rounded">allow read, write: if request.auth != null;</li>
                  <li><strong>2. Ajoutez votre UID comme admin dans Firestore</strong></li>
                  <li><strong>3. Vérifiez que le document users/${currentUser.uid} existe</strong></li>
                </ol>
              </div>
              
              <div class="bg-green-50 border border-green-200 rounded p-3">
                <h4 class="font-bold text-green-800 mb-2">🔧 Règles Firestore recommandées:</h4>
                <pre class="text-xs bg-gray-100 p-2 rounded overflow-x-auto">rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      allow read: if request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    match /patients/{patientId} {
      allow read, write: if request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'medecin'];
    }
  }
}</pre>
              </div>
            </div>
            <button onclick="this.closest('.fixed').remove()" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white rounded px-4 py-2">Fermer</button>
          </div>
        `;
        document.body.appendChild(errorModal);
        
        throw new Error('Permissions insuffisantes pour lire la collection users');
      }
    }
    
    // Charger les utilisateurs patients
    const usersSnapshot = await db.collection('users').where('role', '==', 'patient').get();
    
    usersSnapshot.forEach(doc => {
      const userData = doc.data();
      firebaseUsers.push({
        id: doc.id,
        uid: userData.uid || doc.id,
        email: userData.email,
        role: userData.role,
        ...userData
      });
    });
    
    console.log('Utilisateurs patients trouvés:', firebaseUsers.length);
    
    if (firebaseUsers.length === 0) {
      alert('ℹ️ Aucun patient trouvé dans Firebase.\n\nAssurez-vous que:\n- Des utilisateurs avec role="patient" existent\n- Vos règles Firestore permettent la lecture\n- Vous êtes connecté avec les bonnes permissions');
      return false;
    }
    
    // Récupérer les données médicales
    const patientsSnapshot = await db.collection('patients').get();
    const medicalDataMap = {};
    
    patientsSnapshot.forEach(doc => {
      const data = doc.data();
      const userId = doc.id.replace('_medical', '');
      medicalDataMap[userId] = data;
    });
    
    console.log('Données médicales trouvées:', Object.keys(medicalDataMap).length);
    
    // Fusionner les données
    const completePatients = firebaseUsers.map(user => {
      const medicalData = medicalDataMap[user.uid] || {};
      return {
        ...user,
        personalInfo: medicalData.personalInfo || {
          firstName: user.profile?.firstName || user.displayName?.split(' ')[0] || 'Prénom',
          lastName: user.profile?.lastName || user.displayName?.split(' ').slice(1).join(' ') || 'Nom',
          bloodType: 'N/A'
        },
        medicalHistory: medicalData.medicalHistory || {
          allergies: [],
          medications: [],
          chronicDiseases: []
        },
        emergencyInfo: medicalData.emergencyInfo || {
          criticalNotes: ''
        },
        isActive: medicalData.isActive !== undefined ? medicalData.isActive : true,
        nfcTagId: medicalData.nfcTagId || null,
        createdAt: user.createdAt || new Date().toISOString()
      };
    });
    
    // Supprimer les anciennes données de test
    localStorage.removeItem('syl-patients');
    localStorage.removeItem('syl-nfc-tags');
    
    localStorage.setItem('syl-patients', JSON.stringify(completePatients));
    console.log(`✅ ${completePatients.length} patients chargés depuis Firebase`);
    alert(`✅ ${completePatients.length} patients chargés depuis Firebase !\n\nDonnées de test supprimées.`);
    location.reload();
    return true;
    
  } catch (error) {
    console.error('Erreur chargement Firebase:', error);
    
    let errorMessage = 'Erreur Firebase: ';
    if (error.code === 'permission-denied') {
      errorMessage += 'Permissions insuffisantes.\n\nSolutions possibles:\n1. Vérifiez vos règles Firestore\n2. Assurez-vous d\'être connecté\n3. Contactez l\'administrateur';
    } else if (error.code === 'unavailable') {
      errorMessage += 'Service Firebase indisponible.\nVérifiez votre connexion internet.';
    } else {
      errorMessage += error.message;
    }
    
    alert('❌ ' + errorMessage);
    return false;
  }
}

// ----------- ADMIN DASHBOARD -----------
function renderAdminDashboard(user) {
  let patients = JSON.parse(localStorage.getItem('syl-patients') || '[]');
  let nfcTags = JSON.parse(localStorage.getItem('syl-nfc-tags') || '[]');
  let activeTab = 'patients';
  
  // Initialiser avec des tags NFC vides si nécessaire
  if (nfcTags.length === 0) {
    nfcTags = [];
    localStorage.setItem('syl-nfc-tags', JSON.stringify(nfcTags));
  }
  
  render();

  function render() {
    document.getElementById('app').innerHTML = `
    <div class="min-h-screen bg-gray-50">
      <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center h-16">
          <div class="flex items-center">
            ${icons.settings}<h1 class="text-xl font-bold text-gray-900 ml-3">SYL Admin</h1>
          </div>
          <div class="flex items-center space-x-4">
            <div class="text-sm text-gray-600">Admin: ${user.profile.firstName}</div>
            <button id="logoutBtn" class="border-2 border-purple-600 text-purple-600 hover:bg-purple-50 font-medium rounded-lg px-4 py-2 flex items-center gap-2">${icons.logout} Déconnexion</button>
          </div>
        </div>
      </header>
      
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
          <div class="lg:col-span-1">
            <nav class="space-y-2">
              <button class="w-full flex items-center px-4 py-3 text-left rounded-lg transition-colors ${activeTab==='patients' ? 'bg-purple-100 text-purple-700 border-l-4 border-purple-600':'text-gray-600 hover:bg-gray-100'}" data-tab="patients">${icons.users} <span class="ml-3">Patients</span></button>
              <button class="w-full flex items-center px-4 py-3 text-left rounded-lg transition-colors ${activeTab==='nfc' ? 'bg-purple-100 text-purple-700 border-l-4 border-purple-600':'text-gray-600 hover:bg-gray-100'}" data-tab="nfc">${icons.smartphone} <span class="ml-3">Tags NFC</span></button>
              <button class="w-full flex items-center px-4 py-3 text-left rounded-lg transition-colors ${activeTab==='associations' ? 'bg-purple-100 text-purple-700 border-l-4 border-purple-600':'text-gray-600 hover:bg-gray-100'}" data-tab="associations">${icons.shield} <span class="ml-3">Associations</span></button>
              <button class="w-full flex items-center px-4 py-3 text-left rounded-lg transition-colors ${activeTab==='analytics' ? 'bg-purple-100 text-purple-700 border-l-4 border-purple-600':'text-gray-600 hover:bg-gray-100'}" data-tab="analytics">${icons.activity} <span class="ml-3">Analytics</span></button>
            </nav>
          </div>
          
          <div class="lg:col-span-3">
            ${activeTab === 'patients' ? renderPatientsTab() : ''}
            ${activeTab === 'nfc' ? renderNFCTab() : ''}
            ${activeTab === 'associations' ? renderAssociationsTab() : ''}
            ${activeTab === 'analytics' ? renderAnalyticsTab() : ''}
          </div>
        </div>
      </div>
    </div>
    `;
    
    document.getElementById('logoutBtn').onclick = () => { logout(); };
    document.querySelectorAll('[data-tab]').forEach(btn => btn.onclick = () => { 
      activeTab = btn.getAttribute('data-tab'); 
      render(); 
    });
    
    if (activeTab === 'patients') setupPatientsEvents();
    if (activeTab === 'nfc') setupNFCEvents();
    if (activeTab === 'associations') setupAssociationsEvents();
  }

  function renderPatientsTab() {
    return `
      <div class="space-y-6">
        <div class="flex justify-between items-center">
          <h2 class="text-2xl font-bold text-gray-900">Gestion des Patients</h2>
          <div class="flex gap-2">
            <button id="loadFirebaseUsers" class="bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg px-4 py-2 flex items-center gap-2">${icons.activity} Charger Firebase</button>
            <button id="clearAllData" class="bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg px-4 py-2 flex items-center gap-2">${icons.trash} Vider cache</button>
            <button id="refreshPatients" class="bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-lg px-6 py-2 flex items-center gap-2">${icons.activity} Actualiser</button>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Recherche de patient</h3>
          <div class="flex gap-4 mb-4">
            <input type="text" id="searchPatient" placeholder="Rechercher par nom, email, ID..." class="flex-1 px-3 py-2 border border-gray-300 rounded-lg">
            <button id="searchBtn" class="bg-blue-600 hover:bg-blue-700 text-white rounded-lg px-4 py-2">${icons.search}</button>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Liste des Patients (${patients.length})</h3>
          ${patients.length === 0 ? `
            <div class="text-center py-8">
              <div class="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center mx-auto mb-4">
                ${icons.users}
              </div>
              <h4 class="text-lg font-medium text-gray-900 mb-2">Aucun patient trouvé</h4>
              <p class="text-gray-600 mb-4">Cliquez sur "Charger Firebase" pour récupérer les patients depuis votre base de données.</p>
              <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-left">
                <h5 class="font-medium text-blue-900 mb-2">Pour résoudre l'erreur de permissions :</h5>
                <ol class="text-sm text-blue-800 space-y-1">
                  <li>1. Vérifiez que vous êtes connecté avec un compte admin</li>
                  <li>2. Configurez les règles Firestore pour permettre la lecture</li>
                  <li>3. Assurez-vous que des utilisateurs avec role="patient" existent</li>
                </ol>
              </div>
            </div>
          ` : `
          <div class="overflow-x-auto">
            <table class="w-full table-auto">
              <thead>
                <tr class="border-b border-gray-200">
                  <th class="text-left py-3 px-4">Patient</th>
                  <th class="text-left py-3 px-4">Email</th>
                  <th class="text-left py-3 px-4">Groupe Sang.</th>
                  <th class="text-left py-3 px-4">Tag NFC</th>
                  <th class="text-left py-3 px-4">Statut</th>
                  <th class="text-left py-3 px-4">Actions</th>
                </tr>
              </thead>
              <tbody id="patientsTable">
                ${patients.map(patient => `
                  <tr class="border-b border-gray-100 hover:bg-gray-50">
                    <td class="py-3 px-4">
                      <div>
                        <div class="font-medium">${patient.personalInfo?.firstName || 'N/A'} ${patient.personalInfo?.lastName || 'N/A'}</div>
                        <div class="text-sm text-gray-500">ID: ${patient.id || patient.uid || 'N/A'}</div>
                      </div>
                    </td>
                    <td class="py-3 px-4">${patient.email || 'N/A'}</td>
                    <td class="py-3 px-4">
                      <span class="bg-red-100 text-red-800 px-2 py-1 rounded text-sm">${patient.personalInfo?.bloodType || 'N/A'}</span>
                    </td>
                    <td class="py-3 px-4">
                      ${patient.nfcTagId ? `<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm">${patient.nfcTagId}</span>` : '<span class="text-gray-500">Non assigné</span>'}
                    </td>
                    <td class="py-3 px-4">
                      ${patient.isActive ? '<span class="bg-green-100 text-green-800 px-2 py-1 rounded text-sm">Actif</span>' : '<span class="bg-gray-100 text-gray-800 px-2 py-1 rounded text-sm">Inactif</span>'}
                    </td>
                    <td class="py-3 px-4">
                      <div class="flex gap-2">
                        <button onclick="viewPatient('${patient.id || patient.uid}')" class="text-blue-600 hover:text-blue-700">${icons.eye}</button>
                        <button onclick="assignNFC('${patient.id || patient.uid}')" class="text-green-600 hover:text-green-700">${icons.smartphone}</button>
                      </div>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
          `}
        </div>
      </div>
    `;
  }

  function renderNFCTab() {
    return `
      <div class="space-y-6">
        <div class="flex justify-between items-center">
          <h2 class="text-2xl font-bold text-gray-900">Gestion des Tags NFC</h2>
          <button id="addNFCTag" class="bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-lg px-6 py-2 flex items-center gap-2">${icons.plus} Nouveau Tag</button>
        </div>

        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Enregistrer un nouveau Tag NFC</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <input type="text" id="nfcTagId" placeholder="ID du Tag NFC" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            <input type="text" id="nfcTagDescription" placeholder="Description (optionnelle)" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
          </div>
          <div class="flex gap-4">
            <button id="scanNFC" class="bg-blue-600 hover:bg-blue-700 text-white rounded-lg px-4 py-2 flex items-center gap-2">${icons.smartphone} Scanner Tag</button>
            <button id="writeNFC" class="bg-purple-600 hover:bg-purple-700 text-white rounded-lg px-4 py-2 flex items-center gap-2">${icons.edit} Écrire Tag</button>
            <button id="registerNFC" class="bg-green-600 hover:bg-green-700 text-white rounded-lg px-4 py-2 flex items-center gap-2">${icons.check} Enregistrer</button>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Tags NFC enregistrés (${nfcTags.length})</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            ${nfcTags.map(tag => `
              <div class="border border-gray-200 rounded-lg p-4 ${tag.assignedTo ? 'bg-green-50 border-green-200' : 'bg-gray-50'}">
                <div class="flex justify-between items-start mb-2">
                  <div class="font-medium text-gray-900">${tag.id}</div>
                  <div class="flex gap-1">
                    <button onclick="testNFCTag('${tag.id}')" class="text-blue-600 hover:text-blue-700 text-sm" title="Tester le tag">${icons.activity}</button>
                    <button onclick="writeNFCTagData('${tag.id}')" class="text-purple-600 hover:text-purple-700 text-sm" title="Programmer le tag">${icons.edit}</button>
                    <button onclick="deleteNFCTag('${tag.id}')" class="text-red-600 hover:text-red-700 text-sm" title="Supprimer">${icons.trash}</button>
                  </div>
                </div>
                <div class="text-sm text-gray-600 mb-2">${tag.description || 'Aucune description'}</div>
                <div class="text-sm">
                  ${tag.assignedTo ? 
                    `<span class="text-green-600">Assigné à: ${tag.assignedTo}</span>` : 
                    '<span class="text-gray-500">Non assigné</span>'
                  }
                </div>
                <div class="text-xs text-gray-400 mt-2">Créé: ${new Date(tag.createdAt).toLocaleDateString('fr-FR')}</div>
              </div>
            `).join('')}
          </div>
        </div>
      </div>
    `;
  }

  function renderAssociationsTab() {
    const associations = nfcTags.filter(tag => tag.assignedTo);
    return `
      <div class="space-y-6">
        <h2 class="text-2xl font-bold text-gray-900">Associations Patient-NFC</h2>
        
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Créer une nouvelle association</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <select id="selectPatient" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
              <option value="">Sélectionner un patient</option>
              ${patients.map(patient => `
                <option value="${patient.id || patient.uid}">${patient.personalInfo?.firstName} ${patient.personalInfo?.lastName} (${patient.email})</option>
              `).join('')}
            </select>
            <select id="selectNFCTag" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
              <option value="">Sélectionner un Tag NFC</option>
              ${nfcTags.filter(tag => !tag.assignedTo).map(tag => `
                <option value="${tag.id}">${tag.id} ${tag.description ? `(${tag.description})` : ''}</option>
              `).join('')}
            </select>
            <button id="createAssociation" class="bg-purple-600 hover:bg-purple-700 text-white rounded-lg px-4 py-2">${icons.shield} Associer</button>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Associations actives (${associations.length})</h3>
          <div class="space-y-4">
            ${associations.map(tag => {
              const patient = patients.find(p => (p.id || p.uid) === tag.assignedTo);
              return `
                <div class="flex items-center justify-between bg-gradient-to-r from-purple-50 to-blue-50 p-4 rounded-lg border">
                  <div class="flex items-center space-x-4">
                    <div class="w-12 h-12 bg-purple-600 rounded-full flex items-center justify-center text-white font-bold">
                      ${icons.smartphone}
                    </div>
                    <div>
                      <div class="font-medium text-gray-900">Tag: ${tag.id}</div>
                      <div class="text-sm text-gray-600">Patient: ${patient ? `${patient.personalInfo?.firstName} ${patient.personalInfo?.lastName}` : 'Patient non trouvé'}</div>
                      <div class="text-sm text-blue-600">Associé le: ${new Date(tag.assignedAt).toLocaleDateString('fr-FR')}</div>
                    </div>
                  </div>
                  <div class="flex gap-2">
                    <button onclick="testNFC('${tag.id}')" class="bg-blue-600 hover:bg-blue-700 text-white rounded px-3 py-1 text-sm">${icons.activity} Test</button>
                    <button onclick="removeAssociation('${tag.id}')" class="bg-red-600 hover:bg-red-700 text-white rounded px-3 py-1 text-sm">${icons.trash} Dissocier</button>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      </div>
    `;
  }

  function renderAnalyticsTab() {
    const analytics = JSON.parse(localStorage.getItem('syl-analytics') || '[]');
    const totalPatients = patients.length;
    const activePatients = patients.filter(p => p.isActive).length;
    const totalNFCTags = nfcTags.length;
    const assignedTags = nfcTags.filter(tag => tag.assignedTo).length;
    
    return `
      <div class="space-y-6">
        <h2 class="text-2xl font-bold text-gray-900">Tableau de bord Analytics</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
            <div class="flex items-center">
              <div class="w-12 h-12 bg-blue-600 rounded-lg flex items-center justify-center text-white">
                ${icons.users}
              </div>
              <div class="ml-4">
                <div class="text-2xl font-bold text-gray-900">${totalPatients}</div>
                <div class="text-sm text-gray-600">Total Patients</div>
              </div>
            </div>
          </div>
          
          <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
            <div class="flex items-center">
              <div class="w-12 h-12 bg-green-600 rounded-lg flex items-center justify-center text-white">
                ${icons.check}
              </div>
              <div class="ml-4">
                <div class="text-2xl font-bold text-gray-900">${activePatients}</div>
                <div class="text-sm text-gray-600">Patients Actifs</div>
              </div>
            </div>
          </div>
          
          <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
            <div class="flex items-center">
              <div class="w-12 h-12 bg-purple-600 rounded-lg flex items-center justify-center text-white">
                ${icons.smartphone}
              </div>
              <div class="ml-4">
                <div class="text-2xl font-bold text-gray-900">${totalNFCTags}</div>
                <div class="text-sm text-gray-600">Tags NFC</div>
              </div>
            </div>
          </div>
          
          <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
            <div class="flex items-center">
              <div class="w-12 h-12 bg-orange-600 rounded-lg flex items-center justify-center text-white">
                ${icons.shield}
              </div>
              <div class="ml-4">
                <div class="text-2xl font-bold text-gray-900">${assignedTags}</div>
                <div class="text-sm text-gray-600">Tags Assignés</div>
              </div>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Événements récents</h3>
          <div class="space-y-3">
            ${analytics.slice(-10).reverse().map(event => `
              <div class="flex items-center justify-between py-2 border-b border-gray-100">
                <div>
                  <div class="font-medium text-gray-900">${event.name}</div>
                  <div class="text-sm text-gray-600">${new Date(event.timestamp).toLocaleString('fr-FR')}</div>
                </div>
                <div class="text-sm text-gray-500">${event.sessionId}</div>
              </div>
            `).join('')}
          </div>
        </div>
      </div>
    `;
  }

  function setupPatientsEvents() {
    document.getElementById('refreshPatients')?.addEventListener('click', async () => {
      // Recharger les patients depuis Firebase
      try {
        if (db && typeof db.collection === 'function') {
          console.log('Chargement des utilisateurs depuis Firebase...');
          
          // Récupérer tous les utilisateurs avec le rôle 'patient'
          const usersSnapshot = await db.collection('users').where('role', '==', 'patient').get();
          const firebaseUsers = [];
          
          usersSnapshot.forEach(doc => {
            const userData = doc.data();
            firebaseUsers.push({
              id: doc.id,
              uid: userData.uid || doc.id,
              email: userData.email,
              role: userData.role,
              ...userData
            });
          });
          
          console.log('Utilisateurs trouvés:', firebaseUsers.length);
          
          // Récupérer aussi les données médicales associées
          const patientsSnapshot = await db.collection('patients').get();
          const medicalDataMap = {};
          
          patientsSnapshot.forEach(doc => {
            const data = doc.data();
            const userId = doc.id.replace('_medical', '');
            medicalDataMap[userId] = data;
          });
          
          console.log('Données médicales trouvées:', Object.keys(medicalDataMap).length);
          
          // Fusionner les données utilisateur et médicales
          const completePatients = firebaseUsers.map(user => {
            const medicalData = medicalDataMap[user.uid] || {};
            return {
              ...user,
              personalInfo: medicalData.personalInfo || {
                firstName: user.profile?.firstName || 'Prénom',
                lastName: user.profile?.lastName || 'Nom',
                bloodType: 'N/A'
              },
              medicalHistory: medicalData.medicalHistory || {
                allergies: [],
                medications: [],
                chronicDiseases: []
              },
              emergencyInfo: medicalData.emergencyInfo || {
                criticalNotes: ''
              },
              isActive: medicalData.isActive !== undefined ? medicalData.isActive : true,
              nfcTagId: medicalData.nfcTagId || null,
              createdAt: user.createdAt || new Date().toISOString()
            };
          });
          
          if (completePatients.length > 0) {
            patients = completePatients;
            localStorage.setItem('syl-patients', JSON.stringify(patients));
            render();
            alert(`✅ ${patients.length} patients chargés depuis Firebase !`);
            return;
          } else {
            alert('ℹ️ Aucun patient trouvé dans Firebase. Utilisation des données de démonstration.');
          }
        }
        
        // Fallback : réinitialiser avec des données de démonstration
        if (confirm('Voulez-vous charger les données de démonstration ?')) {
          localStorage.removeItem('syl-patients');
          localStorage.removeItem('syl-nfc-tags');
          location.reload();
        }
        
      } catch (error) {
        console.error('Erreur refresh patients:', error);
        alert('❌ Erreur Firebase: ' + error.message + '\n\nUtilisation des données de démonstration.');
      }
    });

    document.getElementById('loadFirebaseUsers')?.addEventListener('click', async () => {
      if (confirm('Charger les utilisateurs depuis Firebase ? Cela remplacera les données actuelles.')) {
        try {
          // Utiliser la même logique que refreshPatients mais force le chargement
          await loadPatientsFromFirebase();
        } catch (error) {
          console.error('Erreur:', error);
          alert('❌ Erreur lors du chargement: ' + error.message);
        }
      }
    });

    document.getElementById('clearAllData')?.addEventListener('click', () => {
      if (confirm('Êtes-vous sûr de vouloir vider le cache local ? Cette action supprimera tous les patients et tags NFC en local. Vous devrez recharger depuis Firebase.')) {
        localStorage.removeItem('syl-patients');
        localStorage.removeItem('syl-nfc-tags');
        localStorage.removeItem('syl-medicalData');
        localStorage.removeItem('syl-analytics');
        localStorage.removeItem('syl-reminders');
        alert('Cache vidé ! Rechargement de la page...');
        location.reload();
      }
    });

    document.getElementById('searchPatient')?.addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      const filteredPatients = patients.filter(patient => 
        (patient.personalInfo?.firstName?.toLowerCase().includes(searchTerm)) ||
        (patient.personalInfo?.lastName?.toLowerCase().includes(searchTerm)) ||
        (patient.email?.toLowerCase().includes(searchTerm)) ||
        (patient.id?.toLowerCase().includes(searchTerm))
      );
      // Re-render la table avec les patients filtrés
      // TODO: Implémenter le filtrage en temps réel
    });
  }

  function setupNFCEvents() {
    document.getElementById('scanNFC')?.addEventListener('click', async () => {
      try {
        // Vérifier le support NFC
        if (!('NDEFReader' in window)) {
          // Fallback avec simulation
          showNFCSimulationModal();
          return;
        }

        // Vérifier les permissions
        const permission = await navigator.permissions.query({ name: 'nfc' });
        if (permission.state === 'denied') {
          throw new Error('Permissions NFC refusées. Activez le NFC dans les paramètres du navigateur.');
        }

        // Vérifier HTTPS
        if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
          throw new Error('NFC nécessite HTTPS. Utilisez un serveur HTTPS ou localhost.');
        }

        // Démarrer le scan NFC
        const ndef = new NDEFReader();
        
        // Afficher un modal de scan en cours
        const scanModal = document.createElement('div');
        scanModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        scanModal.innerHTML = `
          <div class="bg-white rounded-lg p-6 max-w-md mx-4 text-center">
            <div class="animate-pulse mb-4">
              <div class="w-16 h-16 bg-blue-600 rounded-full mx-auto flex items-center justify-center text-white text-2xl">
                📱
              </div>
            </div>
            <h3 class="text-lg font-bold text-gray-900 mb-2">Scan NFC en cours...</h3>
            <p class="text-gray-600 mb-4">Approchez votre tag NFC du téléphone</p>
            <button id="cancelNFCScan" class="bg-gray-500 hover:bg-gray-600 text-white rounded px-4 py-2">Annuler</button>
          </div>
        `;
        document.body.appendChild(scanModal);

        // Gérer l'annulation
        document.getElementById('cancelNFCScan').onclick = () => {
          scanModal.remove();
        };

        // Démarrer le scan
        await ndef.scan();
        console.log('📡 Scan NFC démarré');

        // Écouter la détection
        ndef.addEventListener('reading', ({ message, serialNumber }) => {
          scanModal.remove();
          
          let tagId = '';
          
          // Essayer de lire les données du tag
          if (message.records.length > 0) {
            const record = message.records[0];
            if (record.recordType === 'text') {
              tagId = new TextDecoder().decode(record.data);
            } else if (record.recordType === 'url') {
              tagId = new TextDecoder().decode(record.data);
            } else {
              // Utiliser le numéro de série si pas de données
              tagId = serialNumber || 'NFC_' + Date.now();
            }
          } else {
            // Utiliser le numéro de série
            tagId = serialNumber || 'NFC_' + Date.now();
          }

          // Formater l'ID
          if (!tagId.startsWith('NFC_') && !tagId.startsWith('SYL_')) {
            tagId = 'NFC_' + tagId;
          }

          // Mettre à jour le champ seulement s'il existe (interface admin)
          const nfcTagIdField = document.getElementById('nfcTagId');
          if (nfcTagIdField) {
            nfcTagIdField.value = tagId;
          }
          
          // Afficher une confirmation
          showNFCSuccessModal(tagId);
        });

        // Timeout pour le scan
        setTimeout(() => {
          if (document.body.contains(scanModal)) {
            scanModal.remove();
            alert('⏰ Timeout du scan NFC. Réessayez.');
          }
        }, 30000); // 30 secondes

      } catch (error) {
        console.error('Erreur NFC:', error);
        
        let errorMessage = 'Erreur NFC: ';
        if (error.name === 'NotAllowedError') {
          errorMessage += 'Permissions NFC refusées. Activez le NFC dans les paramètres.';
        } else if (error.name === 'NotSupportedError') {
          errorMessage += 'NFC non supporté sur cet appareil.';
        } else if (error.message.includes('HTTPS')) {
          errorMessage += 'NFC nécessite HTTPS. Testez sur un serveur sécurisé.';
        } else {
          errorMessage += error.message;
        }
        
        // Proposer une simulation
        if (confirm(errorMessage + '\n\nVoulez-vous utiliser la simulation NFC ?')) {
          showNFCSimulationModal();
        }
      }
    });

    // Fonction pour la simulation NFC
    function showNFCSimulationModal() {
      const simModal = document.createElement('div');
      simModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      simModal.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-md mx-4">
          <h3 class="text-lg font-bold text-gray-900 mb-4">🎭 Simulation NFC</h3>
          <p class="text-gray-600 mb-4">Génération d'un tag NFC virtuel pour les tests</p>
          <div class="space-y-3">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Type de tag</label>
              <select id="nfcSimType" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                <option value="random">Générer aléatoirement</option>
                <option value="bracelet">Bracelet médical</option>
                <option value="card">Carte médicale</option>
                <option value="keychain">Porte-clés</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ID personnalisé (optionnel)</label>
              <input type="text" id="nfcSimCustom" placeholder="Ex: MON_TAG_123" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            </div>
          </div>
          <div class="flex gap-2 mt-6">
            <button id="generateNFCTag" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white rounded px-4 py-2">Générer</button>
            <button onclick="this.closest('.fixed').remove()" class="bg-gray-500 hover:bg-gray-600 text-white rounded px-4 py-2">Annuler</button>
          </div>
        </div>
      `;
      document.body.appendChild(simModal);

      document.getElementById('generateNFCTag').onclick = () => {
        const type = document.getElementById('nfcSimType').value;
        const custom = document.getElementById('nfcSimCustom').value.trim();
        
        let tagId = '';
        if (custom) {
          tagId = custom.startsWith('NFC_') || custom.startsWith('SYL_') ? custom : 'NFC_' + custom;
        } else {
          const random = Math.random().toString(36).substr(2, 8).toUpperCase();
          switch (type) {
            case 'bracelet': tagId = 'SYL_BRACELET_' + random; break;
            case 'card': tagId = 'SYL_CARD_' + random; break;
            case 'keychain': tagId = 'SYL_KEY_' + random; break;
            default: tagId = 'NFC_' + random;
          }
        }
        
        // Mettre à jour le champ seulement s'il existe (interface admin)
        const nfcTagIdField = document.getElementById('nfcTagId');
        if (nfcTagIdField) {
          nfcTagIdField.value = tagId;
        }
        simModal.remove();
        showNFCSuccessModal(tagId, true);
      };
    }

    // Fonction pour afficher le succès
    function showNFCSuccessModal(tagId, isSimulated = false) {
      const successModal = document.createElement('div');
      successModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      successModal.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-md mx-4 text-center">
          <div class="w-16 h-16 bg-green-600 rounded-full mx-auto flex items-center justify-center text-white text-2xl mb-4">
            ${isSimulated ? '🎭' : '📱'}
          </div>
          <h3 class="text-lg font-bold text-green-600 mb-2">Tag NFC ${isSimulated ? 'simulé' : 'détecté'} !</h3>
          <div class="bg-gray-100 rounded p-3 mb-4">
            <code class="text-sm font-mono">${tagId}</code>
          </div>
          <p class="text-gray-600 text-sm mb-4">${isSimulated ? 'Tag virtuel généré pour les tests' : 'Tag physique détecté avec succès'}</p>
          <button onclick="this.closest('.fixed').remove()" class="bg-green-600 hover:bg-green-700 text-white rounded px-6 py-2">Continuer</button>
        </div>
      `;
      document.body.appendChild(successModal);
      
      // Auto-fermer après 3 secondes
      setTimeout(() => {
        if (document.body.contains(successModal)) {
          successModal.remove();
        }
      }, 3000);
    }

    // Fonction pour écrire des données sur un tag NFC
    document.getElementById('writeNFC')?.addEventListener('click', async () => {
      const nfcTagIdField = document.getElementById('nfcTagId');
      const nfcTagDescriptionField = document.getElementById('nfcTagDescription');
      
      if (!nfcTagIdField || !nfcTagDescriptionField) {
        console.error('Éléments NFC non trouvés dans le DOM');
        return;
      }
      
      const tagId = nfcTagIdField.value.trim();
      const description = nfcTagDescriptionField.value.trim();
      
      if (!tagId) {
        alert('Veuillez d\'abord entrer un ID de tag ou scanner un tag');
        return;
      }

      try {
        if (!('NDEFReader' in window)) {
          alert('⚠️ Écriture NFC non supportée sur cet appareil.\n\nLe tag sera enregistré sans données physiques.');
          return;
        }

        // Vérifier HTTPS
        if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
          throw new Error('NFC nécessite HTTPS pour l\'écriture');
        }

        // Créer le modal d'écriture
        const writeModal = document.createElement('div');
        writeModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        writeModal.innerHTML = `
          <div class="bg-white rounded-lg p-6 max-w-md mx-4">
            <h3 class="text-lg font-bold text-gray-900 mb-4">✍️ Écriture NFC</h3>
            <div class="space-y-3 mb-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ID du tag</label>
                <div class="bg-gray-100 rounded p-2">
                  <code class="text-sm">${tagId}</code>
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                <div class="bg-gray-100 rounded p-2 text-sm">
                  ${description || 'Aucune description'}
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Type de données</label>
                <select id="nfcDataType" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                  <option value="text">Texte (ID du tag)</option>
                  <option value="url">URL (accès d'urgence)</option>
                  <option value="contact">Contact d'urgence</option>
                  <option value="patient">Lien fiche médicale patient</option>
                </select>
              </div>
              <div id="patientSelection" class="hidden">
                <label class="block text-sm font-medium text-gray-700 mb-1">Sélectionner un patient</label>
                <select id="nfcPatientSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                  <option value="">Choisir un patient...</option>
                  ${patients.map(patient => `
                    <option value="${patient.id || patient.uid}">
                      ${patient.personalInfo?.firstName || ''} ${patient.personalInfo?.lastName || ''} 
                      ${patient.email ? `(${patient.email})` : ''}
                    </option>
                  `).join('')}
                </select>
              </div>
            </div>
            <div class="bg-blue-50 border border-blue-200 rounded p-3 mb-4">
              <p class="text-sm text-blue-800">📱 Approchez le tag NFC de votre appareil pour écrire les données</p>
            </div>
            <div class="flex gap-2">
              <button id="startNFCWrite" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white rounded px-4 py-2">Écrire</button>
              <button onclick="this.closest('.fixed').remove()" class="bg-gray-500 hover:bg-gray-600 text-white rounded px-4 py-2">Annuler</button>
            </div>
          </div>
        `;
        document.body.appendChild(writeModal);

        // Gérer l'affichage de la sélection de patient
        document.getElementById('nfcDataType').onchange = (e) => {
          const patientSelection = document.getElementById('patientSelection');
          if (e.target.value === 'patient') {
            patientSelection.classList.remove('hidden');
          } else {
            patientSelection.classList.add('hidden');
          }
        };

        document.getElementById('startNFCWrite').onclick = async () => {
          try {
            const dataType = document.getElementById('nfcDataType').value;
            const ndef = new NDEFReader();
            
            // Préparer les données selon le type
            let ndefMessage;
            switch (dataType) {
              case 'url':
                const emergencyUrl = `${window.location.origin}${window.location.pathname}?nfc=${tagId}`;
                ndefMessage = { records: [{ recordType: 'url', data: emergencyUrl }] };
                break;
              case 'contact':
                const vcard = `BEGIN:VCARD
VERSION:3.0
FN:SYL Medical Emergency
ORG:SYL Medical
TEL:15
NOTE:Tag d'urgence médicale ID: ${tagId}
END:VCARD`;
                ndefMessage = { records: [{ recordType: 'mime', mediaType: 'text/vcard', data: vcard }] };
                break;
              case 'patient':
                const selectedPatientId = document.getElementById('nfcPatientSelect').value;
                if (!selectedPatientId) {
                  alert('Veuillez sélectionner un patient');
                  return;
                }
                const selectedPatient = patients.find(p => (p.id || p.uid) === selectedPatientId);
                if (!selectedPatient) {
                  alert('Patient non trouvé');
                  return;
                }
                // Créer l'URL vers la fiche médicale du patient
                const patientMedicalUrl = `${window.location.origin}${window.location.pathname}?patient=${selectedPatientId}&access=medical`;
                ndefMessage = { records: [{ recordType: 'url', data: patientMedicalUrl }] };
                break;
              default: // text
                ndefMessage = { records: [{ recordType: 'text', data: tagId }] };
            }

            // Afficher le statut d'écriture
            writeModal.querySelector('.bg-white').innerHTML = `
              <div class="text-center py-8">
                <div class="animate-pulse mb-4">
                  <div class="w-16 h-16 bg-purple-600 rounded-full mx-auto flex items-center justify-center text-white text-2xl">
                    ✍️
                  </div>
                </div>
                <h3 class="text-lg font-bold text-gray-900 mb-2">Écriture en cours...</h3>
                <p class="text-gray-600 mb-4">Maintenez le tag NFC proche de l'appareil</p>
                <button onclick="this.closest('.fixed').remove()" class="bg-gray-500 hover:bg-gray-600 text-white rounded px-4 py-2">Annuler</button>
              </div>
            `;

            // Écrire sur le tag
            await ndef.write(ndefMessage);
            
            // Succès
            writeModal.querySelector('.bg-white').innerHTML = `
              <div class="text-center py-8">
                <div class="w-16 h-16 bg-green-600 rounded-full mx-auto flex items-center justify-center text-white text-2xl mb-4">
                  ✅
                </div>
                <h3 class="text-lg font-bold text-green-600 mb-2">Écriture réussie !</h3>
                <div class="bg-gray-100 rounded p-3 mb-4">
                  <code class="text-sm font-mono">${tagId}</code>
                </div>
                <p class="text-gray-600 text-sm mb-4">Données écrites avec succès sur le tag NFC</p>
                <button onclick="this.closest('.fixed').remove()" class="bg-green-600 hover:bg-green-700 text-white rounded px-6 py-2">Terminer</button>
              </div>
            `;

            // Auto-fermer après 3 secondes
            setTimeout(() => {
              if (document.body.contains(writeModal)) {
                writeModal.remove();
              }
            }, 3000);

          } catch (writeError) {
            console.error('Erreur écriture NFC:', writeError);
            writeModal.querySelector('.bg-white').innerHTML = `
              <div class="text-center py-8">
                <div class="w-16 h-16 bg-red-600 rounded-full mx-auto flex items-center justify-center text-white text-2xl mb-4">
                  ❌
                </div>
                <h3 class="text-lg font-bold text-red-600 mb-2">Erreur d'écriture</h3>
                <p class="text-gray-600 text-sm mb-4">${writeError.message}</p>
                <button onclick="this.closest('.fixed').remove()" class="bg-red-600 hover:bg-red-700 text-white rounded px-6 py-2">Fermer</button>
              </div>
            `;
          }
        };

      } catch (error) {
        console.error('Erreur NFC:', error);
        alert('❌ Erreur: ' + error.message);
      }
    });

    document.getElementById('registerNFC')?.addEventListener('click', () => {
      const nfcTagIdField = document.getElementById('nfcTagId');
      const nfcTagDescriptionField = document.getElementById('nfcTagDescription');
      
      if (!nfcTagIdField || !nfcTagDescriptionField) {
        console.error('Éléments NFC non trouvés dans le DOM');
        return;
      }
      
      const tagId = nfcTagIdField.value.trim();
      const description = nfcTagDescriptionField.value.trim();
      
      if (!tagId) {
        alert('Veuillez entrer un ID de tag NFC');
        return;
      }
      
      if (nfcTags.find(tag => tag.id === tagId)) {
        alert('Ce tag NFC existe déjà');
        return;
      }
      
      const newTag = {
        id: tagId,
        description: description,
        createdAt: new Date().toISOString(),
        assignedTo: null,
        assignedAt: null
      };
      
      nfcTags.push(newTag);
      localStorage.setItem('syl-nfc-tags', JSON.stringify(nfcTags));
      
      // Reset form
      if (nfcTagIdField) nfcTagIdField.value = '';
      if (nfcTagDescriptionField) nfcTagDescriptionField.value = '';
      
      SYLUtilities.showNotification('Tag NFC enregistré', { body: `Tag ${tagId} ajouté avec succès` });
      SYLAnalytics.trackEvent('nfc_tag_registered', { tagId });
      render();
    });
  }

  function setupAssociationsEvents() {
    document.getElementById('createAssociation')?.addEventListener('click', () => {
      const patientId = document.getElementById('selectPatient').value;
      const tagId = document.getElementById('selectNFCTag').value;
      
      if (!patientId || !tagId) {
        alert('Veuillez sélectionner un patient et un tag NFC');
        return;
      }
      
      // Mettre à jour le tag NFC
      const tag = nfcTags.find(t => t.id === tagId);
      if (tag) {
        tag.assignedTo = patientId;
        tag.assignedAt = new Date().toISOString();
      }
      
      // Mettre à jour le patient
      const patient = patients.find(p => (p.id || p.uid) === patientId);
      if (patient) {
        patient.nfcTagId = tagId;
      }
      
      localStorage.setItem('syl-nfc-tags', JSON.stringify(nfcTags));
      localStorage.setItem('syl-patients', JSON.stringify(patients));
      
      SYLUtilities.showNotification('Association créée', { 
        body: `Tag ${tagId} associé au patient` 
      });
      SYLAnalytics.trackEvent('nfc_association_created', { patientId, tagId });
      render();
    });
  }
}

// Fonctions globales pour l'admin
function viewPatient(patientId) {
  const patient = JSON.parse(localStorage.getItem('syl-patients') || '[]').find(p => (p.id || p.uid) === patientId);
  if (!patient) {
    alert('Patient non trouvé');
    return;
  }
  
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
  modal.innerHTML = `
    <div class="bg-white rounded-lg p-6 max-w-2xl mx-4 max-h-96 overflow-y-auto">
      <h3 class="text-lg font-bold mb-4">Détails du Patient</h3>
      <div class="grid grid-cols-2 gap-4">
        <div><strong>Nom:</strong> ${patient.personalInfo?.firstName} ${patient.personalInfo?.lastName}</div>
        <div><strong>Email:</strong> ${patient.email}</div>
        <div><strong>Groupe sanguin:</strong> ${patient.personalInfo?.bloodType || 'N/A'}</div>
        <div><strong>Date de naissance:</strong> ${patient.personalInfo?.dateOfBirth || 'N/A'}</div>
        <div><strong>Téléphone urgence:</strong> ${patient.personalInfo?.emergencyContact?.phone || 'N/A'}</div>
        <div><strong>Tag NFC:</strong> ${patient.nfcTagId || 'Non assigné'}</div>
      </div>
      <div class="mt-4">
        <strong>Allergies:</strong> ${patient.medicalHistory?.allergies?.join(', ') || 'Aucune'}
      </div>
      <div class="mt-4">
        <strong>Médicaments:</strong> ${patient.medicalHistory?.medications?.join(', ') || 'Aucun'}
      </div>
      <button onclick="this.closest('.fixed').remove()" class="mt-4 w-full bg-gray-500 hover:bg-gray-600 text-white rounded px-4 py-2">Fermer</button>
    </div>
  `;
  document.body.appendChild(modal);
}

function assignNFC(patientId) {
  const nfcTags = JSON.parse(localStorage.getItem('syl-nfc-tags') || '[]');
  const availableTags = nfcTags.filter(tag => !tag.assignedTo);
  
  if (availableTags.length === 0) {
    alert('Aucun tag NFC disponible. Veuillez d\'abord enregistrer des tags.');
    return;
  }
  
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
  modal.innerHTML = `
    <div class="bg-white rounded-lg p-6 max-w-md mx-4">
      <h3 class="text-lg font-bold mb-4">Assigner un Tag NFC</h3>
      <select id="modalSelectTag" class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-4">
        <option value="">Sélectionner un tag</option>
        ${availableTags.map(tag => `<option value="${tag.id}">${tag.id} ${tag.description ? `(${tag.description})` : ''}</option>`).join('')}
      </select>
      <div class="flex gap-2">
        <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white rounded px-4 py-2">Annuler</button>
        <button onclick="confirmAssignNFC('${patientId}')" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white rounded px-4 py-2">Assigner</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

function confirmAssignNFC(patientId) {
  const tagId = document.getElementById('modalSelectTag').value;
  if (!tagId) {
    alert('Veuillez sélectionner un tag');
    return;
  }
  
  const nfcTags = JSON.parse(localStorage.getItem('syl-nfc-tags') || '[]');
  const patients = JSON.parse(localStorage.getItem('syl-patients') || '[]');
  
  // Mettre à jour le tag
  const tag = nfcTags.find(t => t.id === tagId);
  if (tag) {
    tag.assignedTo = patientId;
    tag.assignedAt = new Date().toISOString();
  }
  
  // Mettre à jour le patient
  const patient = patients.find(p => (p.id || p.uid) === patientId);
  if (patient) {
    patient.nfcTagId = tagId;
  }
  
  localStorage.setItem('syl-nfc-tags', JSON.stringify(nfcTags));
  localStorage.setItem('syl-patients', JSON.stringify(patients));
  
  document.querySelector('.fixed').remove();
  SYLUtilities.showNotification('Tag assigné', { body: `Tag ${tagId} assigné avec succès` });
  location.reload(); // Recharger pour mettre à jour l'affichage
}

function deleteNFCTag(tagId) {
  if (!confirm('Supprimer ce tag NFC ? Cette action est irréversible.')) {
    return;
  }
  
  let nfcTags = JSON.parse(localStorage.getItem('syl-nfc-tags') || '[]');
  nfcTags = nfcTags.filter(tag => tag.id !== tagId);
  localStorage.setItem('syl-nfc-tags', JSON.stringify(nfcTags));
  
  SYLUtilities.showNotification('Tag supprimé', { body: `Tag ${tagId} supprimé` });
  location.reload();
}

function removeAssociation(tagId) {
  if (!confirm('Dissocier ce tag NFC du patient ?')) {
    return;
  }
  
  const nfcTags = JSON.parse(localStorage.getItem('syl-nfc-tags') || '[]');
  const patients = JSON.parse(localStorage.getItem('syl-patients') || '[]');
  
  // Mettre à jour le tag
  const tag = nfcTags.find(t => t.id === tagId);
  if (tag) {
    const patientId = tag.assignedTo;
    tag.assignedTo = null;
    tag.assignedAt = null;
    
    // Mettre à jour le patient
    const patient = patients.find(p => (p.id || p.uid) === patientId);
    if (patient) {
      patient.nfcTagId = null;
    }
  }
  
  localStorage.setItem('syl-nfc-tags', JSON.stringify(nfcTags));
  localStorage.setItem('syl-patients', JSON.stringify(patients));
  
  SYLUtilities.showNotification('Association supprimée', { body: `Tag ${tagId} dissocié` });
  location.reload();
}

// Fonction pour tester un tag NFC spécifique
function testNFCTag(tagId) {
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
  modal.innerHTML = `
    <div class="bg-white rounded-lg p-6 max-w-md mx-4 text-center">
      <div class="w-16 h-16 bg-blue-600 rounded-full mx-auto flex items-center justify-center text-white text-2xl mb-4">
        🧪
      </div>
      <h3 class="text-lg font-bold text-gray-900 mb-4">Test du Tag NFC</h3>
      <div class="bg-gray-100 rounded p-3 mb-4">
        <code class="text-sm font-mono">${tagId}</code>
      </div>
      <div class="space-y-3">
        <button onclick="testNFCRead('${tagId}')" class="w-full bg-blue-600 hover:bg-blue-700 text-white rounded px-4 py-2">📱 Tester la lecture</button>
        <button onclick="testNFCEmergency('${tagId}')" class="w-full bg-red-600 hover:bg-red-700 text-white rounded px-4 py-2">🚑 Simuler accès d'urgence</button>
        <button onclick="this.closest('.fixed').remove()" class="w-full bg-gray-500 hover:bg-gray-600 text-white rounded px-4 py-2">Fermer</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

// Fonction pour programmer un tag NFC avec des données
function writeNFCTagData(tagId) {
  const nfcTags = JSON.parse(localStorage.getItem('syl-nfc-tags') || '[]');
  const tag = nfcTags.find(t => t.id === tagId);
  
  if (!tag) {
    alert('Tag non trouvé');
    return;
  }

  // Remplir les champs et déclencher l'écriture
  const nfcTagIdField = document.getElementById('nfcTagId');
  const nfcTagDescriptionField = document.getElementById('nfcTagDescription');
  const writeNFCButton = document.getElementById('writeNFC');
  
  if (!nfcTagIdField || !nfcTagDescriptionField || !writeNFCButton) {
    alert('Interface d\'écriture NFC non disponible dans ce contexte');
    return;
  }
  
  nfcTagIdField.value = tagId;
  nfcTagDescriptionField.value = tag.description || '';
  
  // Déclencher l'événement d'écriture
  writeNFCButton.click();
}

// Tester la lecture d'un tag NFC
async function testNFCRead(tagId) {
  try {
    if (!('NDEFReader' in window)) {
      alert('📱 API NFC non supportée sur cet appareil.\n\nTest simulé : Le tag contiendrait les données d\'urgence du patient associé.');
      return;
    }

    const readModal = document.createElement('div');
    readModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    readModal.innerHTML = `
      <div class="bg-white rounded-lg p-6 max-w-md mx-4 text-center">
        <div class="animate-pulse mb-4">
          <div class="w-16 h-16 bg-blue-600 rounded-full mx-auto flex items-center justify-center text-white text-2xl">
            📱
          </div>
        </div>
        <h3 class="text-lg font-bold text-gray-900 mb-2">Lecture NFC en cours...</h3>
        <p class="text-gray-600 mb-4">Approchez le tag ${tagId} de votre appareil</p>
        <button onclick="this.closest('.fixed').remove()" class="bg-gray-500 hover:bg-gray-600 text-white rounded px-4 py-2">Annuler</button>
      </div>
    `;
    document.body.appendChild(readModal);

    const ndef = new NDEFReader();
    await ndef.scan();

    ndef.addEventListener('reading', ({ message, serialNumber }) => {
      readModal.remove();
      
      let content = 'Aucune donnée lisible';
      if (message.records.length > 0) {
        const record = message.records[0];
        if (record.recordType === 'text') {
          content = new TextDecoder().decode(record.data);
        } else if (record.recordType === 'url') {
          content = new TextDecoder().decode(record.data);
        }
      }

      const resultModal = document.createElement('div');
      resultModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      resultModal.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-md mx-4">
          <h3 class="text-lg font-bold text-green-600 mb-4">✅ Lecture réussie</h3>
          <div class="space-y-3">
            <div>
              <label class="block text-sm font-medium text-gray-700">Tag ID:</label>
              <div class="bg-gray-100 rounded p-2 text-sm font-mono">${tagId}</div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Numéro de série:</label>
              <div class="bg-gray-100 rounded p-2 text-sm font-mono">${serialNumber || 'Non disponible'}</div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Contenu:</label>
              <div class="bg-gray-100 rounded p-2 text-sm">${content}</div>
            </div>
          </div>
          <button onclick="this.closest('.fixed').remove()" class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white rounded px-4 py-2">Fermer</button>
        </div>
      `;
      document.body.appendChild(resultModal);
    });

    // Timeout
    setTimeout(() => {
      if (document.body.contains(readModal)) {
        readModal.remove();
        alert('⏰ Timeout de lecture. Réessayez.');
      }
    }, 30000);

  } catch (error) {
    console.error('Erreur test lecture NFC:', error);
    alert('❌ Erreur de lecture: ' + error.message);
  }
}

// Simuler un accès d'urgence
function testNFCEmergency(tagId) {
  const nfcTags = JSON.parse(localStorage.getItem('syl-nfc-tags') || '[]');
  const patients = JSON.parse(localStorage.getItem('syl-patients') || '[]');
  
  const tag = nfcTags.find(t => t.id === tagId);
  const patient = patients.find(p => (p.id || p.uid) === tag?.assignedTo);
  
  if (!patient) {
    alert('❌ Aucun patient associé à ce tag.\n\nAssociez d\'abord un patient au tag pour tester l\'accès d\'urgence.');
    return;
  }
  
  // Simuler l'interface d'urgence
  const emergencyModal = document.createElement('div');
  emergencyModal.className = 'fixed inset-0 bg-red-900 bg-opacity-95 flex items-center justify-center z-50';
  emergencyModal.innerHTML = `
    <div class="bg-white rounded-lg p-6 max-w-2xl mx-4 border-4 border-red-600">
      <div class="text-center mb-6">
        <div class="w-16 h-16 bg-red-600 rounded-full mx-auto flex items-center justify-center text-white text-2xl mb-4">
          🚑
        </div>
        <h2 class="text-2xl font-bold text-red-600 mb-2">ACCÈS D'URGENCE ACTIVÉ</h2>
        <p class="text-gray-600">Tag NFC: ${tagId}</p>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bg-red-50 border-2 border-red-200 rounded-lg p-4">
          <h3 class="font-bold text-red-800 mb-3">👤 Patient</h3>
          <div class="space-y-2 text-sm">
            <div><strong>Nom:</strong> ${patient.personalInfo?.firstName} ${patient.personalInfo?.lastName}</div>
            <div><strong>Né(e) le:</strong> ${patient.personalInfo?.dateOfBirth || 'Non renseigné'}</div>
            <div><strong>Groupe sanguin:</strong> <span class="bg-red-600 text-white px-2 py-1 rounded text-xs">${patient.personalInfo?.bloodType || 'Non renseigné'}</span></div>
          </div>
        </div>
        
        <div class="bg-orange-50 border-2 border-orange-200 rounded-lg p-4">
          <h3 class="font-bold text-orange-800 mb-3">⚠️ Alertes Médicales</h3>
          <div class="space-y-2 text-sm">
            <div><strong>Allergies:</strong> ${patient.medicalHistory?.allergies?.join(', ') || 'Aucune connue'}</div>
            <div><strong>Médicaments:</strong> ${patient.medicalHistory?.medications?.join(', ') || 'Aucun'}</div>
            <div><strong>Maladies chroniques:</strong> ${patient.medicalHistory?.chronicDiseases?.join(', ') || 'Aucune'}</div>
          </div>
        </div>
        
        <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4">
          <h3 class="font-bold text-blue-800 mb-3">📞 Contact d'Urgence</h3>
          <div class="space-y-2 text-sm">
            <div><strong>Nom:</strong> ${patient.personalInfo?.emergencyContact?.name || 'Non renseigné'}</div>
            <div><strong>Relation:</strong> ${patient.personalInfo?.emergencyContact?.relation || 'Non renseigné'}</div>
            <div><strong>Téléphone:</strong> 
              <a href="tel:${patient.personalInfo?.emergencyContact?.phone}" class="text-blue-600 underline">
                ${patient.personalInfo?.emergencyContact?.phone || 'Non renseigné'}
              </a>
            </div>
          </div>
        </div>
        
        <div class="bg-yellow-50 border-2 border-yellow-200 rounded-lg p-4">
          <h3 class="font-bold text-yellow-800 mb-3">📝 Notes Critiques</h3>
          <div class="text-sm">
            ${patient.emergencyInfo?.criticalNotes || 'Aucune note critique'}
          </div>
        </div>
      </div>
      
      <div class="flex gap-2 mt-6">
        <button onclick="window.open('tel:15')" class="flex-1 bg-red-600 hover:bg-red-700 text-white rounded px-4 py-2 font-bold">📞 SAMU (15)</button>
        <button onclick="this.closest('.fixed').remove()" class="bg-gray-500 hover:bg-gray-600 text-white rounded px-4 py-2">Fermer Test</button>
      </div>
    </div>
  `;
  document.body.appendChild(emergencyModal);
  
  // Enregistrer l'accès d'urgence
  SYLAnalytics.trackEvent('emergency_access_test', { tagId, patientId: patient.id || patient.uid });
}

function testNFC(tagId) {
  const nfcTags = JSON.parse(localStorage.getItem('syl-nfc-tags') || '[]');
  const patients = JSON.parse(localStorage.getItem('syl-patients') || '[]');
  
  const tag = nfcTags.find(t => t.id === tagId);
  const patient = patients.find(p => (p.id || p.uid) === tag?.assignedTo);
  
  if (!patient) {
    alert('Patient non trouvé pour ce tag');
    return;
  }
  
  // Simuler l'accès d'urgence
  const emergencyData = {
    patient: `${patient.personalInfo?.firstName} ${patient.personalInfo?.lastName}`,
    bloodType: patient.personalInfo?.bloodType,
    allergies: patient.medicalHistory?.allergies,
    emergencyContact: patient.personalInfo?.emergencyContact?.phone,
    lastAccess: new Date().toISOString()
  };
  
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
  modal.innerHTML = `
    <div class="bg-white rounded-lg p-6 max-w-md mx-4">
      <h3 class="text-lg font-bold mb-4 text-green-600">✅ Test NFC Réussi</h3>
      <div class="space-y-2">
        <div><strong>Tag:</strong> ${tagId}</div>
        <div><strong>Patient:</strong> ${emergencyData.patient}</div>
        <div><strong>Groupe sanguin:</strong> ${emergencyData.bloodType || 'N/A'}</div>
        <div><strong>Contact urgence:</strong> ${emergencyData.emergencyContact || 'N/A'}</div>
      </div>
      <button onclick="this.closest('.fixed').remove()" class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white rounded px-4 py-2">Fermer</button>
    </div>
  `;
  document.body.appendChild(modal);
  
  SYLAnalytics.trackEvent('nfc_test', { tagId, patientId: patient.id });
}

// ----------- MEDECIN DASHBOARD -----------
function renderMedecinDashboard(user) {
  let patients = JSON.parse(localStorage.getItem('syl-patients') || 'null');
  if (!patients) {
    patients = [
      {
        id: '1',
        personalInfo: { firstName: 'Jean', lastName: 'Martin', dateOfBirth: '1978-05-15', bloodType: 'O+', height: '175', weight: '80' },
        medicalHistory: { allergies: ['Pénicilline', 'Pollen'], medications: ['Metformine 500mg'], conditions: ['Diabète type 2'], chronicDiseases: ['Diabète type 2', 'Hypertension'] },
        emergencyInfo: { criticalNotes: 'Risque hypoglycémie', contraindications: ['Corticoïdes'] },
        lastAccess: '2024-01-15',
        isActive: true
      },
      {
        id: '2',
        personalInfo: { firstName: 'Marie', lastName: 'Dubois', dateOfBirth: '1985-08-22', bloodType: 'A+', height: '165', weight: '65' },
        medicalHistory: { allergies: ['Aspirine'], medications: ['Levothyrox'], conditions: ['Hypothyroïdie'], chronicDiseases: ['Hypothyroïdie'] },
        emergencyInfo: { criticalNotes: '', contraindications: [] },
        lastAccess: '2024-01-14',
        isActive: true
      }
    ];
    localStorage.setItem('syl-patients', JSON.stringify(patients));
  }
  let searchTerm = '';
  let selectedPatient = null;
  let activeTab = 'patients';
  render();

  function render() {
    const filteredPatients = patients.filter(patient =>
      `${patient.personalInfo.firstName} ${patient.personalInfo.lastName}`.toLowerCase().includes(searchTerm.toLowerCase())
    );
    document.getElementById('app').innerHTML = `
      <div class="min-h-screen bg-gray-50">
        <header class="bg-white shadow-sm border-b">
          <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center h-16">
            <div class="flex items-center">
              ${icons.stethoscope}
              <div class="ml-3">
                <h1 class="text-xl font-bold text-gray-900">SYL Medical Pro</h1>
                <p class="text-xs text-gray-500">${user.profile.speciality||''} • ${user.profile.hospital||''}</p>
              </div>
            </div>
            <div class="flex items-center space-x-4">
              <div class="text-sm text-gray-600">Dr. ${user.profile.firstName} ${user.profile.lastName}</div>
              <button id="logoutBtn" class="border-2 border-green-600 text-green-600 hover:bg-green-50 font-medium rounded-lg px-4 py-2 flex items-center gap-2">${icons.logout} Déconnexion</button>
            </div>
          </div>
        </header>
        
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
          <div class="mb-8">
            <!-- Navigation tabs -->
            <div class="flex space-x-4 mb-6">
              <button class="px-4 py-2 rounded-lg ${activeTab==='patients' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'}" data-tab="patients">Patients</button>
              <button class="px-4 py-2 rounded-lg ${activeTab==='emergency' ? 'bg-red-600 text-white' : 'bg-gray-200 text-gray-700'}" data-tab="emergency">🚑 Accès Urgence</button>
            </div>

            ${activeTab === 'patients' ? renderPatientsTab(filteredPatients) : ''}
            ${activeTab === 'emergency' ? renderEmergencyAccessTab() : ''}
          </div>
        </div>

        ${selectedPatient ? renderPatientModal(selectedPatient) : ''}
      </div>
    `;
    
    document.getElementById('logoutBtn').onclick = () => { logout(); };
    document.querySelectorAll('[data-tab]').forEach(btn => btn.onclick = () => { activeTab = btn.getAttribute('data-tab'); render(); });
    
    if (activeTab === 'patients') patientsTabEvents(filteredPatients);
    if (activeTab === 'emergency') emergencyTabEvents();
    if (selectedPatient) modalEvents();
  }

  function renderPatientsTab(filteredPatients) {
    return `
      <h2 class="text-2xl font-bold text-gray-900 mb-4">Patients</h2>
      
      <!-- Barre de recherche -->
      <div class="flex items-center space-x-4 mb-6">
        <div class="flex-1 relative">
          ${icons.search}
          <input type="text" placeholder="Rechercher un patient..." value="${searchTerm}" id="searchPatient" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
        </div>
        <button class="bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg px-6 py-2 flex items-center gap-2" id="addPatient">${icons.userPlus} Nouveau patient</button>
      </div>

      <!-- Stats rapides -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4 flex items-center">
          ${icons.users}<div class="ml-3"><p class="text-2xl font-bold text-gray-900">${patients.length}</p><p class="text-sm text-gray-600">Patients totaux</p></div>
        </div>
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4 flex items-center">
          ${icons.activity}<div class="ml-3"><p class="text-2xl font-bold text-gray-900">${patients.filter(p=>p.isActive).length}</p><p class="text-sm text-gray-600">Actifs</p></div>
        </div>
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4 flex items-center">
          ${icons.alert}<div class="ml-3"><p class="text-2xl font-bold text-gray-900">${patients.filter(p=>p.emergencyInfo?.criticalNotes).length}</p><p class="text-sm text-gray-600">Alertes</p></div>
        </div>
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4 flex items-center">
          ${icons.clock}<div class="ml-3"><p class="text-2xl font-bold text-gray-900">5</p><p class="text-sm text-gray-600">RDV aujourd'hui</p></div>
        </div>
      </div>

      <!-- Liste des patients -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        ${filteredPatients.map(patient => `
          <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4 mb-4 hover:shadow-lg transition-shadow cursor-pointer ${patient.emergencyInfo?.criticalNotes ? 'border-l-4 border-red-500' : ''}" data-patient="${patient.id}">
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-3">
                <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-green-500 rounded-full flex items-center justify-center">${icons.user}</div>
                <div>
                  <h3 class="font-semibold text-gray-900">${patient.personalInfo.firstName} ${patient.personalInfo.lastName}</h3>
                  <p class="text-sm text-gray-500">Groupe: ${patient.personalInfo.bloodType || 'Non renseigné'} • ${patient.lastAccess}</p>
                  ${patient.emergencyInfo?.criticalNotes ? `<p class="text-xs text-red-600 font-bold">⚠️ Notes d'urgence</p>` : ''}
                </div>
              </div>
              <div class="flex items-center space-x-2">
                ${patient.isActive ? '<div class="w-3 h-3 bg-green-500 rounded-full"></div>' : ''}
                <span class="text-xs text-gray-400">Actif</span>
              </div>
            </div>
            
            <div class="mt-3 flex flex-wrap gap-2">
              ${(patient.medicalHistory.chronicDiseases || patient.medicalHistory.conditions || []).slice(0, 2).map(condition => `<span class="px-2 py-1 bg-orange-100 text-orange-700 text-xs rounded-full">${condition}</span>`).join('')}
              ${(patient.medicalHistory.chronicDiseases || patient.medicalHistory.conditions || []).length > 2 ? `<span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded-full">+${(patient.medicalHistory.chronicDiseases || patient.medicalHistory.conditions || []).length - 2} autres</span>` : ''}
            </div>
            
            ${patient.medicalHistory.allergies?.length ? `
            <div class="mt-2 p-2 bg-red-50 rounded">
              <p class="text-xs text-red-700 font-bold">Allergies: ${patient.medicalHistory.allergies.slice(0,3).join(', ')}</p>
            </div>
            ` : ''}
          </div>
        `).join('')}
      </div>
    `;
  }

  function renderEmergencyAccessTab() {
    return `
      <div class="space-y-6">
        <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-lg">
          <h2 class="text-2xl font-bold text-red-800 flex items-center">
            ${icons.emergency} <span class="ml-2">ACCÈS D'URGENCE MÉDICAL</span>
          </h2>
          <p class="text-red-700 mt-2">Recherche rapide par code d'urgence ou nom</p>
        </div>

        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Recherche d'urgence</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Code d'urgence (bracelet)</label>
              <input type="text" placeholder="SYL-XXXXXX" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-lg font-mono" id="emergencyCode">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Nom du patient</label>
              <input type="text" placeholder="Nom ou prénom" class="w-full px-3 py-2 border border-gray-300 rounded-lg" id="emergencyName">
            </div>
          </div>
          <div class="mt-4 flex space-x-4">
            <button class="bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg px-6 py-3 flex items-center gap-2" id="searchEmergency">
              ${icons.search} RECHERCHE D'URGENCE
            </button>
            <button class="bg-orange-600 hover:bg-orange-700 text-white font-bold rounded-lg px-6 py-3 flex items-center gap-2">
              ${icons.phone} APPELER SAMU (15)
            </button>
          </div>
        </div>

        <!-- Patients avec alertes -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">⚠️ Patients avec alertes d'urgence</h3>
          <div class="space-y-3">
            ${patients.filter(p => p.emergencyInfo?.criticalNotes).map(patient => `
              <div class="border-l-4 border-red-500 bg-red-50 p-4 rounded cursor-pointer hover:bg-red-100" data-patient="${patient.id}">
                <div class="flex justify-between items-start">
                  <div>
                    <h4 class="font-bold text-red-800">${patient.personalInfo.firstName} ${patient.personalInfo.lastName}</h4>
                    <p class="text-red-700">${patient.emergencyInfo.criticalNotes}</p>
                    <p class="text-sm text-red-600">Groupe sanguin: ${patient.personalInfo.bloodType || 'Non renseigné'}</p>
                  </div>
                  <span class="bg-red-600 text-white px-2 py-1 rounded text-xs font-bold">CRITIQUE</span>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      </div>
    `;
  }

  function renderPatientModal(patient) {
    return `
      <div class="fixed inset-0 modal-bg flex items-center justify-center p-4 modal">
        <div class="bg-white rounded-xl max-w-6xl w-full max-h-[95vh] overflow-y-auto shadow-lg">
          <div class="p-6 border-b border-gray-200 flex justify-between items-center">
            <div>
              <h2 class="text-2xl font-bold text-gray-900">${patient.personalInfo.firstName} ${patient.personalInfo.lastName}</h2>
              <p class="text-gray-600">Dossier médical d'urgence complet</p>
            </div>
            <button class="bg-gray-200 text-gray-800 rounded-lg px-4 py-2" id="closeModal">✕</button>
          </div>

          <div class="p-6 space-y-6">
            <!-- Informations d'urgence critiques -->
            ${patient.emergencyInfo?.criticalNotes ? `
            <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-lg">
              <h3 class="font-bold text-red-800 mb-2">🚨 NOTES CRITIQUES D'URGENCE</h3>
              <p class="text-red-700 font-medium">${patient.emergencyInfo.criticalNotes}</p>
            </div>
            ` : ''}

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <!-- Identité -->
              <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4">
                <h3 class="font-semibold text-gray-900 mb-3">👤 Identité</h3>
                <div class="space-y-2 text-sm">
                  <p><strong>Né(e) le:</strong> ${patient.personalInfo.dateOfBirth}</p>
                  <p><strong>Groupe sanguin:</strong> <span class="bg-red-600 text-white px-2 py-1 rounded font-bold">${patient.personalInfo.bloodType || 'NON RENSEIGNÉ'}</span></p>
                  <p><strong>Taille:</strong> ${patient.personalInfo.height} cm</p>
                  <p><strong>Poids:</strong> ${patient.personalInfo.weight} kg</p>
                </div>
              </div>

              <!-- Allergies -->
              <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4">
                <h3 class="font-semibold text-gray-900 mb-3">⚠️ Allergies</h3>
                <div class="space-y-1">
                  ${(patient.medicalHistory.allergies || []).length ? patient.medicalHistory.allergies.map(allergy => `<span class="inline-block px-2 py-1 bg-red-100 text-red-700 text-xs rounded-full mr-2 mb-1">${allergy}</span>`).join('') : '<p class="text-gray-500 text-sm">Aucune allergie connue</p>'}
                </div>
              </div>

              <!-- Médicaments -->
              <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4">
                <h3 class="font-semibold text-gray-900 mb-3">💊 Traitements</h3>
                <div class="space-y-1">
                  ${(patient.medicalHistory.medications || []).length ? patient.medicalHistory.medications.map(medication => `<span class="inline-block px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full mr-2 mb-1">${medication}</span>`).join('') : '<p class="text-gray-500 text-sm">Aucun traitement</p>'}
                </div>
              </div>

              <!-- Pathologies -->
              <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4">
                <h3 class="font-semibold text-gray-900 mb-3">🏥 Pathologies</h3>
                <div class="space-y-1">
                  ${(patient.medicalHistory.chronicDiseases || patient.medicalHistory.conditions || []).length ? (patient.medicalHistory.chronicDiseases || patient.medicalHistory.conditions).map(condition => `<span class="inline-block px-2 py-1 bg-orange-100 text-orange-700 text-xs rounded-full mr-2 mb-1">${condition}</span>`).join('') : '<p class="text-gray-500 text-sm">Aucune pathologie</p>'}
                </div>
              </div>

              <!-- Contre-indications -->
              <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4">
                <h3 class="font-semibold text-gray-900 mb-3">🚫 Contre-indications</h3>
                <div class="space-y-1">
                  ${(patient.emergencyInfo?.contraindications || []).length ? patient.emergencyInfo.contraindications.map(contra => `<span class="inline-block px-2 py-1 bg-yellow-100 text-yellow-700 text-xs rounded-full mr-2 mb-1">${contra}</span>`).join('') : '<p class="text-gray-500 text-sm">Aucune contre-indication</p>'}
                </div>
              </div>

              <!-- Dispositifs médicaux -->
              <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4">
                <h3 class="font-semibold text-gray-900 mb-3">🔧 Dispositifs</h3>
                <div class="space-y-1">
                  ${(patient.medicalHistory.medicalDevices || []).length ? patient.medicalHistory.medicalDevices.map(device => `<span class="inline-block px-2 py-1 bg-purple-100 text-purple-700 text-xs rounded-full mr-2 mb-1">${device}</span>`).join('') : '<p class="text-gray-500 text-sm">Aucun dispositif</p>'}
                </div>
              </div>
            </div>

            <div class="flex justify-end space-x-4">
              <button class="border-2 border-blue-600 text-blue-600 hover:bg-blue-50 font-medium rounded-lg px-4 py-2 flex items-center gap-2" id="editPatient">${icons.edit} Modifier</button>
              <button class="bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg px-4 py-2 flex items-center gap-2">${icons.activity} Nouvelle consultation</button>
              <button class="bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg px-4 py-2 flex items-center gap-2">${icons.emergency} Déclarer urgence</button>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  function patientsTabEvents(filteredPatients) {
    document.getElementById('searchPatient').oninput = (e) => { searchTerm = e.target.value; render(); };
    document.getElementById('addPatient').onclick = () => showAddPatientModal();
    document.querySelectorAll('[data-patient]').forEach(card => card.onclick = () => {
      selectedPatient = patients.find(p=>p.id===card.getAttribute('data-patient'));
      render();
    });
  }

  function emergencyTabEvents() {
    document.getElementById('searchEmergency').onclick = () => {
      const code = document.getElementById('emergencyCode').value;
      const name = document.getElementById('emergencyName').value;
      
      let foundPatient = null;
      if (code) {
        foundPatient = patients.find(p => p.braceletId === code);
      } else if (name) {
        foundPatient = patients.find(p => 
          p.personalInfo.firstName.toLowerCase().includes(name.toLowerCase()) || 
          p.personalInfo.lastName.toLowerCase().includes(name.toLowerCase())
        );
      }
      
      if (foundPatient) {
        selectedPatient = foundPatient;
        render();
      } else {
        alert('Patient non trouvé');
      }
    };
    
    document.querySelectorAll('[data-patient]').forEach(card => card.onclick = () => {
      selectedPatient = patients.find(p=>p.id===card.getAttribute('data-patient'));
      render();
    });
  }

  function modalEvents() {
    document.getElementById('closeModal').onclick = () => { selectedPatient = null; render(); };
    if (document.getElementById('editPatient')) {
      document.getElementById('editPatient').onclick = () => showEditPatientModal(selectedPatient);
    }
  }

  function showEditPatientModal(patient) {
    // Modal d'édition du patient
    document.getElementById('app').querySelector('.modal').innerHTML = `
      <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto shadow-lg">
        <div class="p-6 border-b border-gray-200 flex justify-between items-center">
          <h2 class="text-2xl font-bold text-gray-900">Modifier ${patient.personalInfo.firstName} ${patient.personalInfo.lastName}</h2>
          <button class="bg-gray-200 text-gray-800 rounded-lg px-4 py-2" id="closeEditModal">✕</button>
        </div>
        <div class="p-6 space-y-4">
          <div class="grid grid-cols-2 gap-4">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" id="editFirstName" value="${patient.personalInfo.firstName}" placeholder="Prénom">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" id="editLastName" value="${patient.personalInfo.lastName}" placeholder="Nom">
            <input type="date" class="w-full px-3 py-2 border border-gray-300 rounded-lg" id="editBirth" value="${patient.personalInfo.dateOfBirth}">
            <select class="w-full px-3 py-2 border border-gray-300 rounded-lg" id="editBlood">
              <option value="">Groupe sanguin</option>
              ${MEDICAL_DATA.bloodTypes.map(type => `<option value="${type}" ${patient.personalInfo.bloodType===type?'selected':''}>${type}</option>`).join('')}
            </select>
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" id="editHeight" value="${patient.personalInfo.height}" placeholder="Taille (cm)">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" id="editWeight" value="${patient.personalInfo.weight}" placeholder="Poids (kg)">
          </div>
          <textarea class="w-full px-3 py-2 border border-gray-300 rounded-lg h-20" id="editCriticalNotes" placeholder="Notes critiques d'urgence">${patient.emergencyInfo?.criticalNotes || ''}</textarea>
          <button class="bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg px-6 py-2" id="saveEditPatient">Sauvegarder</button>
        </div>
      </div>
    `;
    document.getElementById('closeEditModal').onclick = () => render();
    document.getElementById('saveEditPatient').onclick = async () => {
      patient.personalInfo.firstName = document.getElementById('editFirstName').value;
      patient.personalInfo.lastName = document.getElementById('editLastName').value;
      patient.personalInfo.dateOfBirth = document.getElementById('editBirth').value;
      patient.personalInfo.bloodType = document.getElementById('editBlood').value;
      patient.personalInfo.height = document.getElementById('editHeight').value;
      patient.personalInfo.weight = document.getElementById('editWeight').value;
      if (!patient.emergencyInfo) patient.emergencyInfo = {};
      patient.emergencyInfo.criticalNotes = document.getElementById('editCriticalNotes').value;
      localStorage.setItem('syl-patients', JSON.stringify(patients));
      
      // Synchronisation Firebase automatique
      await saveToFirebase('patients', patient, patient.id);
      alert('✅ Patient modifié et synchronisé avec Firebase !');
      render();
    };
  }

  function showAddPatientModal() {
    document.body.insertAdjacentHTML('beforeend', `
      <div class="fixed inset-0 modal-bg flex items-center justify-center p-4 modal">
        <div class="bg-white rounded-xl max-w-md w-full overflow-y-auto shadow-lg p-6">
          <h2 class="text-2xl font-bold text-gray-900 mb-4">Nouveau patient</h2>
          <div class="space-y-3">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" id="newFirstName" placeholder="Prénom">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" id="newLastName" placeholder="Nom">
            <input type="date" class="w-full px-3 py-2 border border-gray-300 rounded-lg" id="newBirth">
            <select class="w-full px-3 py-2 border border-gray-300 rounded-lg" id="newBlood">
              <option value="">Groupe sanguin</option>
              ${MEDICAL_DATA.bloodTypes.map(type => `<option value="${type}">${type}</option>`).join('')}
            </select>
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" id="newHeight" placeholder="Taille (cm)">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" id="newWeight" placeholder="Poids (kg)">
          </div>
          <div class="flex space-x-2 mt-4">
            <button class="bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg px-6 py-2" id="saveNewPatient">Ajouter</button>
            <button class="bg-gray-200 text-gray-800 rounded-lg px-6 py-2" id="cancelNewPatient">Annuler</button>
          </div>
        </div>
      </div>
    `);
    document.getElementById('cancelNewPatient').onclick = () => { document.querySelector('.modal').remove(); };
    document.getElementById('saveNewPatient').onclick = async () => {
      const patient = {
        id: Math.random().toString(36).substr(2,9),
        personalInfo: {
          firstName: document.getElementById('newFirstName').value,
          lastName: document.getElementById('newLastName').value,
          dateOfBirth: document.getElementById('newBirth').value,
          bloodType: document.getElementById('newBlood').value,
          height: document.getElementById('newHeight').value,
          weight: document.getElementById('newWeight').value
        },
        medicalHistory: { allergies: [], medications: [], conditions: [], chronicDiseases: [], medicalDevices: [] },
        emergencyInfo: { criticalNotes: '', contraindications: [] },
        lastAccess: new Date().toISOString().split('T')[0],
        isActive: true
      };
      patients.push(patient);
      localStorage.setItem('syl-patients', JSON.stringify(patients));
      
      // Synchronisation Firebase automatique
      await saveToFirebase('patients', patient, patient.id);
      alert('✅ Nouveau patient ajouté et synchronisé avec Firebase !');
      document.querySelector('.modal').remove();
      render();
    };
  }
}

// Fonction pour afficher la fiche médicale d'un patient via NFC
function showPatientMedicalRecord(patientId) {
  const patients = JSON.parse(localStorage.getItem('syl-patients') || '[]');
  const patient = patients.find(p => (p.id || p.uid) === patientId);
  
  if (!patient) {
    document.getElementById('app').innerHTML = `
      <div class="min-h-screen bg-red-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-lg p-8 max-w-md text-center">
          <div class="w-16 h-16 bg-red-600 rounded-full mx-auto flex items-center justify-center text-white text-2xl mb-4">
            ❌
          </div>
          <h2 class="text-xl font-bold text-red-600 mb-2">Patient non trouvé</h2>
          <p class="text-gray-600 mb-4">L'ID patient "${patientId}" n'existe pas dans la base de données.</p>
          <button onclick="location.href='${window.location.pathname}'" class="bg-blue-600 hover:bg-blue-700 text-white rounded px-4 py-2">
            Retour à l'application
          </button>
        </div>
      </div>
    `;
    return;
  }
  
  // Calculer l'âge
  const calculateAge = (birthDate) => {
    if (!birthDate) return 'N/A';
    const today = new Date();
    const birth = new Date(birthDate);
    let age = today.getFullYear() - birth.getFullYear();
    const monthDiff = today.getMonth() - birth.getMonth();
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
      age--;
    }
    return age + ' ans';
  };
  
  // Afficher la fiche d'information médicale d'urgence (lecture seule)
  document.getElementById('app').innerHTML = `
    <div class="min-h-screen bg-gradient-to-br from-red-50 to-pink-100">
      <!-- En-tête d'urgence -->
      <div class="bg-red-600 text-white py-4">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="flex items-center justify-between">
            <div class="flex items-center">
              <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center text-red-600 font-bold mr-4">
                🚑
              </div>
              <div>
                <h1 class="text-2xl font-bold">FICHE MÉDICALE D'URGENCE</h1>
                <p class="text-red-100">Informations vitales - Accès via NFC</p>
              </div>
            </div>
            <button onclick="location.href='${window.location.pathname}'" class="bg-red-700 hover:bg-red-800 text-white rounded-lg px-4 py-2">
              Fermer
            </button>
          </div>
        </div>
      </div>
      
      <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Identification du patient -->
        <div class="bg-white rounded-xl shadow-xl border-2 border-red-200 p-6 mb-6">
          <div class="text-center mb-6">
            <h2 class="text-3xl font-bold text-gray-900 mb-2">
              ${patient.personalInfo?.firstName || ''} ${patient.personalInfo?.lastName || ''}
            </h2>
            <div class="inline-flex items-center px-4 py-2 bg-blue-100 rounded-full">
              <span class="text-blue-800 font-medium">Âge: ${calculateAge(patient.personalInfo?.dateOfBirth)}</span>
            </div>
          </div>
          
          <!-- Informations vitales en grand -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="text-center p-4 bg-red-50 rounded-xl border-2 border-red-200">
              <div class="text-2xl font-bold text-red-600 mb-1">${patient.personalInfo?.bloodType || '?'}</div>
              <div class="text-sm font-medium text-gray-700">Groupe sanguin</div>
            </div>
            <div class="text-center p-4 bg-blue-50 rounded-xl border-2 border-blue-200">
              <div class="text-2xl font-bold text-blue-600 mb-1">${patient.personalInfo?.height || '?'}</div>
              <div class="text-sm font-medium text-gray-700">Taille (cm)</div>
            </div>
            <div class="text-center p-4 bg-green-50 rounded-xl border-2 border-green-200">
              <div class="text-2xl font-bold text-green-600 mb-1">${patient.personalInfo?.weight || '?'}</div>
              <div class="text-sm font-medium text-gray-700">Poids (kg)</div>
            </div>
            <div class="text-center p-4 bg-purple-50 rounded-xl border-2 border-purple-200">
              <div class="text-2xl font-bold text-purple-600 mb-1">${patient.personalInfo?.dateOfBirth || '?'}</div>
              <div class="text-sm font-medium text-gray-700">Naissance</div>
            </div>
          </div>
        </div>
        
        ${patient.emergencyInfo?.criticalNotes ? `
        <!-- ALERTE CRITIQUE -->
        <div class="bg-red-600 text-white rounded-xl p-6 mb-6 border-4 border-red-700">
          <div class="flex items-center mb-3">
            <span class="text-3xl mr-3">⚠️</span>
            <h3 class="text-xl font-bold">ALERTE MÉDICALE CRITIQUE</h3>
          </div>
          <p class="text-lg font-medium">${patient.emergencyInfo.criticalNotes}</p>
        </div>
        ` : ''}
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- ALLERGIES -->
          <div class="bg-white rounded-xl shadow-lg border-l-4 border-red-500 p-6">
            <h3 class="text-xl font-bold text-red-600 mb-4 flex items-center">
              <span class="text-2xl mr-2">⚠️</span> ALLERGIES
            </h3>
            ${patient.medicalHistory?.allergies?.length ? 
              patient.medicalHistory.allergies.map(allergy => `
                <div class="bg-red-100 border-2 border-red-300 rounded-lg px-4 py-3 mb-2">
                  <span class="text-red-800 font-bold text-lg">${allergy}</span>
                </div>
              `).join('') : 
              '<div class="bg-gray-100 rounded-lg px-4 py-3 text-gray-600 font-medium">Aucune allergie connue</div>'
            }
          </div>
          
          <!-- MÉDICAMENTS -->
          <div class="bg-white rounded-xl shadow-lg border-l-4 border-blue-500 p-6">
            <h3 class="text-xl font-bold text-blue-600 mb-4 flex items-center">
              <span class="text-2xl mr-2">💊</span> MÉDICAMENTS
            </h3>
            ${patient.medicalHistory?.medications?.length ? 
              patient.medicalHistory.medications.map(medication => `
                <div class="bg-blue-100 border-2 border-blue-300 rounded-lg px-4 py-3 mb-2">
                  <span class="text-blue-800 font-medium">${medication}</span>
                </div>
              `).join('') : 
              '<div class="bg-gray-100 rounded-lg px-4 py-3 text-gray-600 font-medium">Aucun médicament</div>'
            }
          </div>
          
          <!-- PATHOLOGIES -->
          <div class="bg-white rounded-xl shadow-lg border-l-4 border-orange-500 p-6">
            <h3 class="text-xl font-bold text-orange-600 mb-4 flex items-center">
              <span class="text-2xl mr-2">🏥</span> PATHOLOGIES
            </h3>
            ${patient.medicalHistory?.chronicDiseases?.length ? 
              patient.medicalHistory.chronicDiseases.map(disease => `
                <div class="bg-orange-100 border-2 border-orange-300 rounded-lg px-4 py-3 mb-2">
                  <span class="text-orange-800 font-medium">${disease}</span>
                </div>
              `).join('') : 
              '<div class="bg-gray-100 rounded-lg px-4 py-3 text-gray-600 font-medium">Aucune pathologie connue</div>'
            }
          </div>
          
          <!-- CONTACT D'URGENCE -->
          <div class="bg-white rounded-xl shadow-lg border-l-4 border-green-500 p-6">
            <h3 class="text-xl font-bold text-green-600 mb-4 flex items-center">
              <span class="text-2xl mr-2">📞</span> CONTACT D'URGENCE
            </h3>
            ${patient.personalInfo?.emergencyContact?.name ? `
              <div class="bg-green-100 border-2 border-green-300 rounded-lg px-4 py-3 mb-3">
                <div class="font-bold text-green-800 text-lg">${patient.personalInfo.emergencyContact.name}</div>
                <div class="text-green-700">${patient.personalInfo.emergencyContact.relationship || ''}</div>
              </div>
            ` : ''}
            ${patient.personalInfo?.emergencyContact?.phone ? `
              <a href="tel:${patient.personalInfo.emergencyContact.phone}" 
                 class="block w-full bg-green-600 hover:bg-green-700 text-white text-center rounded-lg px-4 py-3 font-bold text-lg">
                📞 ${patient.personalInfo.emergencyContact.phone}
              </a>
            ` : '<div class="bg-gray-100 rounded-lg px-4 py-3 text-gray-600 font-medium">Aucun contact d\'urgence</div>'}
          </div>
        </div>
        
        <!-- ACTIONS D'URGENCE -->
        <div class="mt-6 bg-white rounded-xl shadow-xl border-2 border-red-300 p-6">
          <h3 class="text-2xl font-bold text-red-600 mb-4 text-center">🚨 NUMÉROS D'URGENCE</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <a href="tel:15" class="block bg-red-600 hover:bg-red-700 text-white text-center rounded-xl px-6 py-4 font-bold text-lg transition-colors">
              <div class="text-2xl mb-1">🚑</div>
              <div>SAMU</div>
              <div class="text-xl">15</div>
            </a>
            <a href="tel:18" class="block bg-orange-600 hover:bg-orange-700 text-white text-center rounded-xl px-6 py-4 font-bold text-lg transition-colors">
              <div class="text-2xl mb-1">🚒</div>
              <div>POMPIERS</div>
              <div class="text-xl">18</div>
            </a>
            <a href="tel:112" class="block bg-blue-600 hover:bg-blue-700 text-white text-center rounded-xl px-6 py-4 font-bold text-lg transition-colors">
              <div class="text-2xl mb-1">🆘</div>
              <div>URGENCES</div>
              <div class="text-xl">112</div>
            </a>
          </div>
        </div>
        
        <!-- Footer informatif -->
        <div class="mt-6 text-center text-gray-500 text-sm">
          <p>📋 Fiche d'information médicale • Consultation seule • ${new Date().toLocaleString('fr-FR')}</p>
          <p class="mt-1">🔒 Données sensibles - Usage strictement médical</p>
        </div>
      </div>
    </div>
  `;
  
  // Enregistrer l'accès
  SYLAnalytics.trackEvent('patient_medical_access', { 
    patientId: patient.id || patient.uid, 
    accessMethod: 'nfc_link',
    accessTime: new Date().toISOString()
  });
}

// ----------- MAIN -----------
function renderApp() {
  console.log("renderApp appellee");
  
  try {
    // PRIORITÉ 1: Vérifier d'abord si on est en mode accès d'urgence
    const urlParams = new URLSearchParams(window.location.search);
    const patientId = urlParams.get('patient');
    const accessType = urlParams.get('access');
    
    if (patientId && accessType === 'medical') {
      console.log('🚑 Mode accès fiche médicale prioritaire:', patientId);
      showPatientMedicalRecord(patientId);
      return; // Arrêter ici pour éviter d'écraser l'affichage
    }
    
    // Vérifier que Firebase est chargé
    if (typeof firebase === 'undefined') {
      console.error("Firebase n'est pas charge");
      showLogin();
      return;
    }
    
    // Récupérer l'utilisateur local
    const localUser = getUser();
    
    if (localUser) {
      console.log("Utilisateur connecté, rôle:", localUser.role);
      if (localUser.role === 'patient') {
        renderPatientDashboard(localUser);
      } else if (localUser.role === 'medecin') {
        renderMedecinDashboard(localUser);
      } else if (localUser.role === 'admin') {
        renderAdminDashboard(localUser);
      } else {
        console.error("Rôle utilisateur inconnu:", localUser.role);
        clearUser();
        showLogin();
      }
    } else {
      // Pas d'utilisateur connecté
      console.log("Redirection vers login");
      showLogin();
    }
  } catch (error) {
    console.error("Erreur dans renderApp:", error);
    showLogin();
  }
}

// Fonction de déconnexion mise à jour
function logout() {
  try {
    if (auth && typeof auth.signOut === 'function') {
      auth.signOut().then(() => {
        clearUser();
        renderApp();
      }).catch((error) => {
        console.error('Erreur de déconnexion Firebase:', error);
        clearUser();
        renderApp();
      });
    } else {
      // Déconnexion locale seulement
      clearUser();
      renderApp();
    }
  } catch (error) {
    console.error('Erreur de déconnexion:', error);
    clearUser();
    renderApp();
  }
}

// Amélioration des performances - Debounce pour les sauvegardes
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// Sauvegarde automatique avec debounce
const autoSave = debounce((data) => {
  localStorage.setItem('syl-medicalData', JSON.stringify(data));
  console.log('🔄 Sauvegarde automatique effectuée');
}, 2000);

// Monitoring et analytics basiques
class SYLAnalytics {
  static init() {
    this.startTime = Date.now();
    this.trackEvent('app_start');
  }
  
  static trackEvent(eventName, data = {}) {
    const event = {
      name: eventName,
      timestamp: new Date().toISOString(),
      data: data,
      sessionId: this.getSessionId()
    };
    
    const events = JSON.parse(localStorage.getItem('syl-analytics') || '[]');
    events.push(event);
    
    // Garder seulement les 100 derniers événements
    if (events.length > 100) {
      events.splice(0, events.length - 100);
    }
    
    localStorage.setItem('syl-analytics', JSON.stringify(events));
  }
  
  static getSessionId() {
    if (!this.sessionId) {
      this.sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }
    return this.sessionId;
  }
}

// Vérification de la santé de l'application
class HealthChecker {
  static checkSystemHealth() {
    const checks = [];
    
    // Vérifier localStorage
    try {
      localStorage.setItem('test', 'test');
      localStorage.removeItem('test');
      checks.push({ name: 'localStorage', status: 'OK' });
    } catch (e) {
      checks.push({ name: 'localStorage', status: 'ERREUR', error: e.message });
    }
    
    // Vérifier Firebase
    try {
      if (firebase.app()) {
        checks.push({ name: 'Firebase', status: 'OK' });
      }
    } catch (e) {
      checks.push({ name: 'Firebase', status: 'ERREUR', error: e.message });
    }
    
    // Vérifier les API du navigateur
    checks.push({ 
      name: 'Géolocalisation', 
      status: navigator.geolocation ? 'OK' : 'NON SUPPORTÉ' 
    });
    
    checks.push({ 
      name: 'Notifications', 
      status: 'Notification' in window ? 'OK' : 'NON SUPPORTÉ' 
    });
    
    checks.push({ 
      name: 'Service Worker', 
      status: 'serviceWorker' in navigator ? 'OK' : 'NON SUPPORTÉ' 
    });
    
    return checks;
  }
  
  static displayHealthStatus() {
    const checks = this.checkSystemHealth();
    console.group('🏥 État de santé SYL Medical');
    checks.forEach(check => {
      const icon = check.status === 'OK' ? '✅' : check.status === 'NON SUPPORTÉ' ? '⚠️' : '❌';
      console.log(`${icon} ${check.name}: ${check.status}${check.error ? ` (${check.error})` : ''}`);
    });
    console.groupEnd();
  }
}

// Initialisation améliorée
document.addEventListener('DOMContentLoaded', () => {
  // Initialiser les systèmes
  SYLAnalytics.init();
  ReminderSystem.init();
  HealthChecker.displayHealthStatus();
  
  // Vérifier si on est en mode accès d'urgence (URL avec paramètre NFC)
  const urlParams = new URLSearchParams(window.location.search);
  const nfcTagId = urlParams.get('nfc') || urlParams.get('tag');
  const patientId = urlParams.get('patient');
  const accessType = urlParams.get('access');
  
  if (nfcTagId) {
    console.log('🚑 Mode accès d\'urgence détecté pour tag:', nfcTagId);
    SYLUtilities.handleNFCAccess(nfcTagId).catch(error => {
      console.error('Erreur accès NFC:', error);
    });
    return; // Ne pas initialiser l'interface normale
  }
  
  if (patientId && accessType === 'medical') {
    console.log('📋 Mode accès fiche médicale patient détecté:', patientId);
    showPatientMedicalRecord(patientId);
    return; // Ne pas initialiser l'interface normale
  }
  
  // Écouter les événements NFC si supporté
  if ('NDEFReader' in window) {
    try {
      const ndef = new NDEFReader();
      ndef.addEventListener('reading', ({ message }) => {
        const tagId = message.records[0]?.data ? new TextDecoder().decode(message.records[0].data) : null;
        if (tagId && (tagId.startsWith('SYL_') || tagId.startsWith('NFC_'))) {
          console.log('🏷️ Tag NFC SYL détecté:', tagId);
          SYLUtilities.handleNFCAccess(tagId);
        }
      });
      
      // Démarrer la lecture NFC automatiquement
      ndef.scan().then(() => {
        console.log('📡 Lecteur NFC activé');
      }).catch(error => {
        console.log('❌ Impossible d\'activer le lecteur NFC:', error.message);
      });
    } catch (error) {
      console.log('⚠️ API NFC non disponible:', error.message);
    }
  }
  
  // Vérifier les mises à jour périodiquement
  setInterval(() => {
    HealthChecker.displayHealthStatus();
  }, 300000); // Toutes les 5 minutes
  
  // Afficher les informations de version
  console.log('%c🏥 SYL Medical v2.1 Admin Enhanced', 'color: #3B82F6; font-size: 16px; font-weight: bold;');
  console.log('Nouvelles fonctionnalités Admin:');
  console.log('• 👨‍  Tableau de bord administrateur');
  console.log('• 🏷️ Gestion des tags NFC');
  console.log('• 🔗 Association patient-NFC');
  console.log('• 🚑 Accès d\'urgence par NFC');
  console.log('•   Analytics et monitoring');
  console.log('• 🔍 Recherche et filtrage patients');
});

// Init - Attendre que Firebase soit prêt avec timeout
let authInitialized = false;

firebase.auth().onAuthStateChanged((user) => {
  console.log("Auth state changed:", user ? "connecté" : "déconnecté");
  authInitialized = true;
  
  // Vérifier d'abord si on est en mode urgence avant de rendre l'app normale
  const urlParams = new URLSearchParams(window.location.search);
  const patientId = urlParams.get('patient');
  const accessType = urlParams.get('access');
  const nfcTagId = urlParams.get('nfc') || urlParams.get('tag');
  
  if ((patientId && accessType === 'medical') || nfcTagId) {
    console.log("🚑 Mode urgence détecté - éviter renderApp()");
    return; // Ne pas appeler renderApp() en mode urgence
  }
  
  renderApp();
});

// Timeout de sécurité si Firebase ne répond pas
setTimeout(() => {
  if (!authInitialized) {
    // Vérifier d'abord si on est en mode urgence
    const urlParams = new URLSearchParams(window.location.search);
    const patientId = urlParams.get('patient');
    const accessType = urlParams.get('access');
    const nfcTagId = urlParams.get('nfc') || urlParams.get('tag');
    
    if ((patientId && accessType === 'medical') || nfcTagId) {
      console.log("🚑 Mode urgence détecté - pas de timeout");
      return;
    }
    
    console.log("Timeout Firebase - Chargement forcé de l'interface");
    showLogin();
  }
}, 5000); // 5 secondes

// Test immédiat si Firebase est déjà prêt
if (firebase.auth().currentUser !== undefined) {
  // Vérifier d'abord si on est en mode urgence
  const urlParams = new URLSearchParams(window.location.search);
  const patientId = urlParams.get('patient');
  const accessType = urlParams.get('access');
  const nfcTagId = urlParams.get('nfc') || urlParams.get('tag');
  
  if ((patientId && accessType === 'medical') || nfcTagId) {
    console.log("🚑 Mode urgence détecté - pas de renderApp() immédiat");
  } else {
    console.log("Firebase déjà prêt");
    renderApp();
  }
}
</script>
</body>
</html>
