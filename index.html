<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>SYL Medical - Syst√®me d'Urgence</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#3B82F6">
  <meta name="description" content="Application m√©dicale d'urgence - Acc√®s rapide aux informations vitales">
  
  <!-- Cache Control pour √©viter les probl√®mes de cache -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  
  <!-- Version de l'application pour forcer les mises √† jour -->
  <meta name="app-version" content="2.1.0">
  <meta name="build-date" content="2025-07-23">
  
  <!-- PWA -->
  <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIlNZTCBNZWRpY2FsIC0gU3lzdMOobWUgZCdVcmdlbmNlIiwKICAic2hvcnRfbmFtZSI6ICJTWUwgTWVkaWNhbCIsCiAgImRlc2NyaXB0aW9uIjogIkFwcGxpY2F0aW9uIG3DqWRpY2FsZSBkJ3VyZ2VuY2UiLAogICJzdGFydF91cmwiOiAiLyIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI0ZGRkZGRiIsCiAgInRoZW1lX2NvbG9yIjogIiMzQjgyRjYiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUI0Yld4dWN6MGlhSFIwY0RvdkwzZDNkeTUzTXk1dmNtY3ZNakF3TUM5emRtY2lJSFpwWlhkQ2IzZzlJakFnTUNBNE1EQWdPREF3SWo0OFl5QjRQU0k0TURBaUlIazlJalEzTWlJZ1kzZzlJakU1TWlJZ1kzazlJakk0SWlCeVBTSTFNaUl2UGp3dmMzWm5QZz09IiwKICAgICAgInNpemVzIjogIjUxMng1MTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIgogICAgfQogIF0sCiAgImNhdGVnb3JpZXMiOiBbIm1lZGljYWwiLCAiaGVhbHRoIiwgImVtZXJnZW5jeSJdCn0=">
  <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA4MDAgODAwIj48YyB4PSI4MDAiIHk9IjQ3MiIgY3g9IjE5MiIgY3k9IjI4IiByPSI1MiIvPjwvc3ZnPg==">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <style>
    .animate-spin { animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .modal-bg { background: rgba(0,0,0,0.5); }
    .modal { z-index: 50; }
    .icon { width: 1em; height: 1em; display: inline-block; vertical-align: middle; }
    .emergency-card { border-left: 4px solid #ef4444; }
    .critical-info { background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); }
    
    /* Mode sombre */
    @media (prefers-color-scheme: dark) {
      .dark-mode {
        background: #1a1a1a;
        color: #ffffff;
      }
      .dark-mode .bg-white {
        background: #2d2d2d !important;
        color: #ffffff !important;
      }
      .dark-mode .text-gray-900 {
        color: #ffffff !important;
      }
      .dark-mode .border-gray-200 {
        border-color: #404040 !important;
      }
    }
    
    /* Accessibilit√© */
    .high-contrast {
      filter: contrast(150%);
    }
    
    .large-text {
      font-size: 1.2em;
    }
    
    /* Focus am√©lior√© pour navigation clavier */
    button:focus, input:focus, select:focus, textarea:focus {
      outline: 3px solid #3B82F6;
      outline-offset: 2px;
    }
    
    /* Animations r√©duites pour les utilisateurs sensibles */
    @media (prefers-reduced-motion: reduce) {
      .animate-spin {
        animation: none;
      }
      .transition-colors {
        transition: none;
      }
    }
    
    /* Responsive am√©lior√© */
    @media (max-width: 640px) {
      .mobile-stack {
        flex-direction: column;
      }
      .mobile-full {
        width: 100%;
      }
    }
  </style>
</head>
<body class="bg-gray-50">
<div id="app">
  <div class="min-h-screen bg-gray-50 flex items-center justify-center">
    <div class="text-center">
      <div class="w-16 h-16 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
      <p class="text-gray-600">Chargement de SYL Medical...</p>
    </div>
  </div>
</div>
<script>
// Gestion d'erreur globale
window.onerror = function(msg, url, lineNo, columnNo, error) {
  console.error('Erreur JavaScript:', msg, '√† la ligne', lineNo);
  document.getElementById('app').innerHTML = `
    <div class="min-h-screen bg-red-50 flex items-center justify-center p-4">
      <div class="bg-white rounded-lg shadow-lg p-6 max-w-md">
        <h2 class="text-xl font-bold text-red-600 mb-4">Erreur JavaScript</h2>
        <p class="text-gray-700 mb-2"><strong>Message:</strong> ${msg}</p>
        <p class="text-gray-700 mb-4"><strong>Ligne:</strong> ${lineNo}</p>
        <button onclick="location.reload()" class="bg-blue-600 text-white px-4 py-2 rounded">R√©essayer</button>
      </div>
    </div>
  `;
  return true;
};

console.log("SYL Medical - D√©but du chargement");

// ========== SYST√àME DE STOCKAGE FIRESTORE (REMPLACEMENT LOCALSTORAGE) ==========

// Configuration temps r√©el - tout sur Firestore
let isRealtimeEnabled = false;
let firestoreListeners = [];

// Fonction pour initialiser la synchronisation temps r√©el
async function initRealtimeSync() {
  if (!db || isRealtimeEnabled) return;
  
  console.log("üî• Initialisation de la synchronisation temps r√©el Firestore");
  
  try {
    // Listener pour les patients (remplace localStorage syl-patients)
    const patientsListener = db.collection('patients').onSnapshot((snapshot) => {
      console.log("üîÑ Mise √† jour temps r√©el des patients");
      const patients = [];
      snapshot.forEach(doc => {
        patients.push({
          id: doc.id,
          ...doc.data()
        });
      });
      
      // Notifier les changements √† l'interface
      window.dispatchEvent(new CustomEvent('patientsUpdated', { detail: patients }));
    }, (error) => {
      console.warn("‚ö†Ô∏è Listener patients en erreur (utilisation du cache local):", error.message);
      // Continuer avec les donn√©es locales
    });
    
    // Listener pour les utilisateurs (remplace localStorage syl-user)
    const usersListener = db.collection('users').onSnapshot((snapshot) => {
      console.log("üîÑ Mise √† jour temps r√©el des utilisateurs");
      const users = [];
      snapshot.forEach(doc => {
        users.push({
          id: doc.id,
          ...doc.data()
        });
      });
      
      window.dispatchEvent(new CustomEvent('usersUpdated', { detail: users }));
    }, (error) => {
      console.warn("‚ö†Ô∏è Listener utilisateurs en erreur (non critique):", error.message);
    });
    
    firestoreListeners.push(patientsListener, usersListener);
    isRealtimeEnabled = true;
    console.log("‚úÖ Synchronisation temps r√©el activ√©e");
    
  } catch (error) {
    console.warn("‚ö†Ô∏è Synchronisation temps r√©el partielle:", error.message);
    console.log("üì± Utilisation du mode hors ligne");
  }
}

// Fonction pour nettoyer les listeners
function cleanupRealtimeSync() {
  firestoreListeners.forEach(unsubscribe => unsubscribe());
  firestoreListeners = [];
  isRealtimeEnabled = false;
  console.log("üî• Listeners Firestore nettoy√©s");
}

// Remplacements des fonctions localStorage par Firestore

// Sauvegarder un patient (remplace localStorage.setItem pour patients)
async function savePatientToFirestore(patient) {
  if (!db) throw new Error("Firestore non initialis√©");
  
  try {
    // Utiliser l'UID de l'utilisateur comme ID du document patient
    const currentUser = getCurrentUser();
    const userId = currentUser?.uid || patient.uid;
    
    if (!userId) {
      throw new Error("Impossible de sauvegarder: UID utilisateur manquant");
    }
    
    const docRef = db.collection('patients').doc(userId);
    
    const patientData = {
      ...patient,
      uid: userId,
      id: userId, // Synchroniser id et uid
      lastModified: firebase.firestore.FieldValue.serverTimestamp(),
      modifiedBy: currentUser?.email || patient.email || 'unknown'
    };
    
    await docRef.set(patientData, { merge: true });
    console.log("üíæ Patient sauvegard√© sur Firestore:", userId);
    return userId;
    
  } catch (error) {
    console.error("‚ùå Erreur sauvegarde patient:", error);
    throw error;
  }
}

// Charger tous les patients (remplace JSON.parse(localStorage.getItem('syl-patients')))
async function loadPatientsFromFirestore() {
  if (!db) throw new Error("Firestore non initialis√©");
  
  try {
    const snapshot = await db.collection('patients').orderBy('lastModified', 'desc').get();
    const patients = [];
    
    snapshot.forEach(doc => {
      patients.push({
        id: doc.id,
        ...doc.data()
      });
    });
    
    console.log(`üìä ${patients.length} patients charg√©s depuis Firestore`);
    
    // Corriger automatiquement les donn√©es manquantes (admin uniquement)
    await autoFixPatientsData(snapshot);
    
    return patients;
    
  } catch (error) {
    console.error("‚ùå Erreur chargement patients:", error);
    return [];
  }
}

// Fonction pour corriger automatiquement les donn√©es manquantes des patients
async function autoFixPatientsData(snapshot) {
  if (!db || !snapshot) return;
  
  const currentUser = getCurrentUser();
  if (!currentUser || currentUser.role !== 'admin') return; // Seulement pour admin
  
  let fixCount = 0;
  const fixes = [];
  
  snapshot.forEach(doc => {
    const patient = doc.data();
    let needsFix = false;
    const updates = {};
    
    // V√©rifier uid
    if (!patient.uid) {
      updates.uid = doc.id;
      needsFix = true;
    }
    
    // V√©rifier id
    if (!patient.id) {
      updates.id = doc.id;
      needsFix = true;
    }
    
    // V√©rifier email
    if (!patient.email && patient.personalInfo?.email) {
      updates.email = patient.personalInfo.email;
      needsFix = true;
    }
    
    // V√©rifier role
    if (!patient.role) {
      updates.role = 'patient';
      needsFix = true;
    }
    
    if (needsFix) {
      fixes.push(
        db.collection('patients').doc(doc.id).update({
          ...updates,
          autoFixedAt: firebase.firestore.FieldValue.serverTimestamp()
        })
      );
      fixCount++;
    }
  });
  
  if (fixes.length > 0) {
    try {
      await Promise.all(fixes);
      console.log(`üîß ${fixCount} patients corrig√©s automatiquement (champs manquants ajout√©s)`);
    } catch (error) {
      console.warn('‚ö†Ô∏è Correction auto ignor√©e:', error.message);
    }
  }
}

// Supprimer un patient (remplace la logique localStorage)
async function deletePatientFromFirestore(patientId) {
  if (!db) throw new Error("Firestore non initialis√©");
  
  try {
    // Supprimer le document patient
    await db.collection('patients').doc(patientId).delete();
    
    // Supprimer aussi de la collection users si c'est un compte utilisateur
    const userQuery = await db.collection('users').where('patientId', '==', patientId).get();
    const deletePromises = [];
    userQuery.forEach(doc => {
      deletePromises.push(db.collection('users').doc(doc.id).delete());
    });
    
    await Promise.all(deletePromises);
    console.log("üóëÔ∏è Patient supprim√© de Firestore:", patientId);
    
  } catch (error) {
    console.error("‚ùå Erreur suppression patient:", error);
    throw error;
  }
}

// Sauvegarder l'utilisateur connect√© (remplace localStorage syl-user)
async function saveCurrentUserToFirestore(user) {
  if (!db) return;
  
  try {
    // Structure coh√©rente pour tous les utilisateurs
    const userDoc = {
      uid: user.uid,
      email: user.email,
      role: user.role || 'patient',
      displayName: user.displayName || null,
      phone: user.phone || null,
      profile: {
        firstName: user.profile?.firstName || user.firstName || '',
        lastName: user.profile?.lastName || user.lastName || '',
        phone: user.profile?.phone || user.phone || ''
      },
      lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
      isOnline: true,
      createdAt: user.createdAt || new Date().toISOString()
    };
    
    await db.collection('activeUsers').doc(user.email).set(userDoc, { merge: true });
    console.log("üë§ Utilisateur actif sauvegard√©:", user.email);
    
  } catch (error) {
    console.warn("‚ö†Ô∏è Sauvegarde statut utilisateur ignor√©e (non critique):", error.message);
    // Cette erreur n'est pas critique pour le fonctionnement de l'app
  }
}

// Nettoyer l'utilisateur √† la d√©connexion
async function removeCurrentUserFromFirestore(userEmail) {
  if (!db || !userEmail) return;
  
  try {
    await db.collection('activeUsers').doc(userEmail).update({
      isOnline: false,
      lastLogout: firebase.firestore.FieldValue.serverTimestamp()
    });
    console.log("üë§ Utilisateur marqu√© hors ligne:", userEmail);
    
  } catch (error) {
    console.error("‚ùå Erreur mise √† jour statut utilisateur:", error);
  }
}

// Migration automatique des utilisateurs vers patients
async function autoMigrateUsersToPatients() {
  if (!db) return;
  
  try {
    console.log("üîÑ Migration automatique des utilisateurs vers patients...");
    
    // Chercher tous les utilisateurs avec le r√¥le 'patient'
    const usersSnapshot = await db.collection('users').where('role', '==', 'patient').get();
    const migrationPromises = [];
    let migratedCount = 0;
    
    usersSnapshot.forEach(userDoc => {
      const userData = userDoc.data();
      
      // Cr√©er un document patient complet
      const patientData = {
        id: userDoc.id,
        uid: userData.uid || userDoc.id,
        email: userData.email,
        role: 'patient',
        personalInfo: userData.personalInfo || {
          firstName: userData.firstName || '',
          lastName: userData.lastName || '',
          birthDate: userData.birthDate || '',
          phone: userData.phone || '',
          address: userData.address || ''
        },
        medicalInfo: userData.medicalInfo || {
          allergies: [],
          medications: [],
          conditions: [],
          bloodType: '',
          emergencyNotes: ''
        },
        emergencyContact: userData.emergencyContact || {
          name: '',
          relationship: '',
          phone: ''
        },
        emergencyInfo: userData.emergencyInfo || {
          criticalNotes: ''
        },
        isActive: userData.isActive !== undefined ? userData.isActive : true,
        nfcTagId: userData.nfcTagId || null,
        createdAt: userData.createdAt || userData.timestamp || new Date().toISOString(),
        lastModified: firebase.firestore.FieldValue.serverTimestamp(),
        modifiedBy: 'auto-migration'
      };
      
      // Migration vers la collection patients
      const migrationPromise = db.collection('patients').doc(userDoc.id).set(patientData, { merge: true });
      migrationPromises.push(migrationPromise);
      migratedCount++;
    });
    
    if (migrationPromises.length > 0) {
      await Promise.all(migrationPromises);
      console.log(`‚úÖ Migration termin√©e: ${migratedCount} utilisateurs migr√©s vers patients`);
    } else {
      console.log("‚ÑπÔ∏è Aucun utilisateur √† migrer");
    }
    
  } catch (error) {
    console.error("‚ùå Erreur lors de la migration automatique:", error);
  }
}

// ========== GESTION DE VERSION ET CACHE ==========
const APP_VERSION = "2.1.0";
const BUILD_DATE = "2025-07-23";

// Fonction de nettoyage du cache et v√©rification de version
function checkAndUpdateVersion() {
  const storedVersion = localStorage.getItem('syl-app-version');
  const storedBuildDate = localStorage.getItem('syl-build-date');
  
  console.log(`üì± Version actuelle: ${APP_VERSION}, stock√©e: ${storedVersion}`);
  
  if (storedVersion !== APP_VERSION || storedBuildDate !== BUILD_DATE) {
    console.log("üîÑ Nouvelle version d√©tect√©e, nettoyage du cache...");
    
    // Sauvegarder les donn√©es utilisateur importantes
    const userData = localStorage.getItem('syl-user');
    const patientData = localStorage.getItem('syl-patients');
    
    // Nettoyer tout le localStorage sauf les donn√©es critiques
    const itemsToKeep = ['syl-user', 'syl-patients'];
    const allKeys = Object.keys(localStorage);
    
    allKeys.forEach(key => {
      if (!itemsToKeep.includes(key)) {
        localStorage.removeItem(key);
      }
    });
    
    // Mettre √† jour la version
    localStorage.setItem('syl-app-version', APP_VERSION);
    localStorage.setItem('syl-build-date', BUILD_DATE);
    
    // Forcer le rafra√Æchissement du cache du navigateur
    if ('caches' in window) {
      caches.keys().then(names => {
        names.forEach(name => {
          caches.delete(name);
        });
      });
    }
    
    console.log("‚úÖ Cache nettoy√©, version mise √† jour");
    
    // Afficher un message √† l'utilisateur sur mobile
    if (window.innerWidth <= 768) {
      setTimeout(() => {
        alert("üì± Application mise √† jour !\nLes am√©liorations ont √©t√© appliqu√©es.");
      }, 1000);
    }
  }
}

// V√©rification de version au chargement
checkAndUpdateVersion();

// D√©tection de probl√®mes de cache sur mobile
function detectMobileIssues() {
  const isMobile = window.innerWidth <= 768 || /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
  
  if (isMobile) {
    console.log("üì± Mobile d√©tect√©, optimisations activ√©es");
    
    // D√©sactiver le cache agressif sur mobile
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations().then(registrations => {
        registrations.forEach(registration => {
          registration.unregister();
        });
      });
    }
    
    // Nettoyage simple sans rechargement automatique
    console.log("‚úÖ Optimisations mobile appliqu√©es");
  }
}

detectMobileIssues();

// Configuration Firebase s√©curis√©e
const firebaseConfig = {
  apiKey: "AIzaSyDqII2vBhBybNhVcr1QktyhvVeBW2TO0KA",
  authDomain: "syl-medical-app-1c58a.firebaseapp.com",
  databaseURL: "https://syl-medical-app-1c58a-default-rtdb.firebaseio.com",
  projectId: "syl-medical-app-1c58a",
  storageBucket: "syl-medical-app-1c58a.firebasestorage.app",
  messagingSenderId: "765684422018",
  appId: "1:765684422018:web:19320fe1e546631fc86b9b",
  measurementId: "G-PD7TP5J233"
};

// Comptes admin pr√©d√©finis
const adminAccounts = {
  'jadetaraf@hotmail.fr': 'ADMINTARAF'
};

// Variables Firebase globales
let db, auth, googleProvider;

// Initialiser Firebase avec gestion d'erreur robuste
try {
  firebase.initializeApp(firebaseConfig);
  db = firebase.firestore();
  auth = firebase.auth();
  googleProvider = new firebase.auth.GoogleAuthProvider();
  console.log("Firebase initialis√© avec succ√®s");
  
  // Configuration suppl√©mentaire pour mobile
  if (window.innerWidth <= 768) {
    auth.settings.appVerificationDisabledForTesting = false;
    db.settings({
      timestampsInSnapshots: true,
      cacheSizeBytes: 1048576 // 1MB cache
    });
  }
  
} catch (error) {
  console.error("Erreur Firebase:", error);
  document.getElementById('app').innerHTML = `
    <div class="min-h-screen bg-red-50 flex items-center justify-center p-4">
      <div class="bg-white rounded-lg shadow-lg p-6 max-w-md">
        <h2 class="text-xl font-bold text-red-600 mb-4">Erreur Firebase</h2>
        <p class="text-gray-700 mb-4">Impossible d'initialiser Firebase: ${error.message}</p>
        <div class="space-y-2">
          <button onclick="location.reload()" class="w-full bg-blue-600 text-white px-4 py-2 rounded">R√©essayer</button>
          <button onclick="clearAllCache()" class="w-full bg-red-600 text-white px-4 py-2 rounded">Vider le cache</button>
        </div>
      </div>
    </div>
  `;
}

// Fonction pour vider compl√®tement le cache
window.clearAllCache = function() {
  // Vider localStorage
  localStorage.clear();
  
  // Vider sessionStorage
  sessionStorage.clear();
  
  // Vider les caches du service worker
  if ('caches' in window) {
    caches.keys().then(names => {
      names.forEach(name => caches.delete(name));
    });
  }
  
  // D√©sinscrire les service workers
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistrations().then(registrations => {
      registrations.forEach(registration => registration.unregister());
    });
  }
  
  alert("Cache vid√© ! Rechargement en cours...");
  setTimeout(() => {
    window.location.href = window.location.href.split('?')[0] + '?nocache=' + Date.now();
  }, 1000);
};

// Gestion globale des erreurs JavaScript
window.addEventListener('error', function(e) {
  console.error('Erreur JavaScript d√©tect√©e:', e.error);
  
  // Sur mobile, proposer un nettoyage de cache en cas d'erreur
  if (window.innerWidth <= 768 && e.error && e.error.message) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white p-3 rounded-lg shadow-lg z-50 max-w-sm';
    errorDiv.innerHTML = `
      <div class="text-sm font-medium">Erreur d√©tect√©e</div>
      <div class="text-xs mt-1 opacity-90">${e.error.message.substring(0, 50)}...</div>
      <button onclick="this.parentElement.remove()" class="absolute top-1 right-1 text-white opacity-75 hover:opacity-100">√ó</button>
    `;
    document.body.appendChild(errorDiv);
    
    // Auto-suppression apr√®s 5 secondes
    setTimeout(() => {
      if (errorDiv.parentElement) {
        errorDiv.remove();
      }
    }, 5000);
  }
});

// D√©tection de perte de connexion r√©seau
window.addEventListener('online', function() {
  console.log('üì∂ Connexion r√©tablie');
  if (window.innerWidth <= 768) {
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 bg-green-500 text-white p-3 rounded-lg shadow-lg z-50';
    notification.innerHTML = 'üì∂ Connexion r√©tablie';
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 3000);
  }
});

window.addEventListener('offline', function() {
  console.log('üìµ Connexion perdue');
  if (window.innerWidth <= 768) {
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 bg-orange-500 text-white p-3 rounded-lg shadow-lg z-50';
    notification.innerHTML = 'üìµ Mode hors ligne';
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 3000);
  }
});

const icons = {
  heart: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path d="M12 21C12 21 7.5 16.5 4 12.5C1.5 9.5 3.5 5 8 5C10 5 12 7 12 7C12 7 14 5 16 5C20.5 5 22.5 9.5 20 12.5C16.5 16.5 12 21 12 21Z" stroke-width="2"/></svg>',
  user: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><circle cx="12" cy="8" r="4" stroke-width="2"/><path d="M6 20c0-2.22 3.58-4 6-4s6 1.78 6 4" stroke-width="2"/></svg>',
  stethoscope: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path d="M8 7v5a4 4 0 008 0V7" stroke-width="2"/><circle cx="12" cy="17" r="2" stroke-width="2"/></svg>',
  mail: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><rect x="3" y="5" width="18" height="14" rx="2"/><path d="M3 7l9 6 9-6" stroke-width="2"/></svg>',
  lock: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><rect x="5" y="11" width="14" height="9" rx="2"/><path d="M7 11V7a5 5 0 1110 0v4" stroke-width="2"/></svg>',
  eye: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M2 12s4-8 10-8 10 8 10 8-4 8-10 8-10-8-10-8z"/></svg>',
  eyeOff: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path d="M17.94 17.94A10.07 10.07 0 012 12s4-8 10-8a9.93 9.93 0 016.94 3.06"/><line x1="1" y1="1" x2="23" y2="23"/></svg>',
  plus: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>',
  trash: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><rect x="3" y="7" width="18" height="14" rx="2"/><line x1="8" y1="11" x2="8" y2="17"/><line x1="16" y1="11" x2="16" y2="17"/></svg>',
  check: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>',
  shield: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" /></svg>',
  smartphone: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><rect x="5" y="2" width="14" height="20" rx="2"/><circle cx="12" cy="18" r="1"/></svg>',
  clock: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
  alert: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><polygon points="12 2 2 22 22 22 12 2"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12" y2="8"/></svg>',
  activity: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>',
  users: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 00-3-3.87"/><path d="M9 21v-2a4 4 0 013-3.87"/><path d="M7 7a4 4 0 018 0"/><path d="M5 21v-2a4 4 0 013-3.87"/><path d="M5 7a4 4 0 018 0"/></svg>',
  userPlus: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 00-3-3.87"/><path d="M8 21v-2a4 4 0 013-3.87"/><path d="M12 7a4 4 0 018 0"/><path d="M2 8v6"/><path d="M5 11H2"/></svg>',
  edit: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path d="M11 4h2a2 2 0 012 2v6a2 2 0 01-2 2h-2a2 2 0 01-2-2V6a2 2 0 012-2z"/><path d="M19 20v-2a2 2 0 00-2-2h-2a2 2 0 00-2 2v2"/></svg>',
  logout: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>',
  search: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>',
  settings: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 11-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09a1.65 1.65 0 00-1-1.51 1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 11-2.83-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09a1.65 1.65 0 001.51-1 1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06a1.65 1.65 0 001.82.33h.09a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51h.09a1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06a1.65 1.65 0 00-.33 1.82v.09a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>',
  phone: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 16.92z"/></svg>',
  calendar: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>',
  medical: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>',
  emergency: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>',
  cross: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>',
  warning: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
  fire: '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path d="M8.5 14.5A2.5 2.5 0 0011 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 11-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 002.5 2.5z"/></svg>'
};

// Donn√©es de r√©f√©rence m√©dicales
const MEDICAL_DATA = {
  bloodTypes: ['A+', 'A-', 'B+', 'B-', 'AB+', 'AB-', 'O+', 'O-'],
  chronicConditions: [
    'Diab√®te type 1', 'Diab√®te type 2', 'Hypertension art√©rielle', 'Insuffisance cardiaque',
    'Asthme', 'BPCO', '√âpilepsie', 'Maladie de Crohn', 'Polyarthrite rhumato√Øde',
    'Scl√©rose en plaques', 'Maladie de Parkinson', 'Alzheimer', 'Insuffisance r√©nale',
    'Cirrhose', 'Cancer', 'VIH/SIDA', 'H√©patite B', 'H√©patite C', 'Hypothyro√Ødie',
    'Hyperthyro√Ødie', 'Fibromyalgie', 'Lupus', 'Bipolarit√©', 'D√©pression majeure'
  ],
  commonAllergies: [
    'P√©nicilline', 'Aspirine', 'Iode', 'Latex', 'Arachides', 'Fruits de mer',
    '≈íufs', 'Lait', 'Soja', 'Gluten', 'Pollen', 'Acariens', 'Poils d\'animaux',
    'Morphine', 'Cod√©ine', 'AINS', 'Sulfamides', 'Anesth√©siques locaux'
  ],
  emergencyMedications: [
    'Adr√©naline auto-injecteur', 'Ventoline', 'Glucagon', 'Insuline rapide',
    'Diaz√©pam rectal', 'Trinitrine', 'Prednisone', 'Antihistaminiques',
    'Beta-bloquants', 'Digitaline', 'Warfarine', 'H√©parine'
  ],
  medicalDevices: [
    'Pacemaker', 'D√©fibrillateur implantable', 'Pompe √† insuline', 'Proth√®se de hanche',
    'Proth√®se de genou', 'Stent cardiaque', 'Valve cardiaque artificielle',
    'Implant cochl√©aire', 'Neurostimulateur', 'Port-√†-cath', 'Sonde gastrique',
    'Cath√©ter urinaire', 'Dialyse p√©riton√©ale'
  ]
};

// Fonctions de chiffrement pour les donn√©es sensibles
class EncryptionService {
  static async generateKey() {
    return await crypto.subtle.generateKey(
      { name: 'AES-GCM', length: 256 },
      true,
      ['encrypt', 'decrypt']
    );
  }
  
  static async encrypt(data, key) {
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const encodedData = new TextEncoder().encode(JSON.stringify(data));
    const encrypted = await crypto.subtle.encrypt(
      { name: 'AES-GCM', iv: iv },
      key,
      encodedData
    );
    return {
      data: Array.from(new Uint8Array(encrypted)),
      iv: Array.from(iv)
    };
  }
  
  static async decrypt(encryptedData, key) {
    const data = new Uint8Array(encryptedData.data);
    const iv = new Uint8Array(encryptedData.iv);
    const decrypted = await crypto.subtle.decrypt(
      { name: 'AES-GCM', iv: iv },
      key,
      data
    );
    return JSON.parse(new TextDecoder().decode(decrypted));
  }
}

// Fonctions Firebase
async function saveToFirebase(collection, data, id = null) {
  try {
    if (id) {
      await db.collection(collection).doc(id).set(data);
    } else {
      await db.collection(collection).add(data);
    }
    console.log('Donn√©es sauvegard√©es dans Firebase');
    return true;
  } catch (error) {
    console.error('Erreur Firebase:', error);
    return false;
  }
}

async function loadFromFirebase(collection, id) {
  try {
    const doc = await db.collection(collection).doc(id).get();
    if (doc.exists) {
      return doc.data();
    }
    return null;
  } catch (error) {
    console.error('Erreur Firebase:', error);
    return null;
  }
}

// Fonction pour sauvegarder l'utilisateur (VERSION FIRESTORE)
async function saveUser(user) {
  await setUser(user);
  
  // Synchronisation Firebase automatique pour les utilisateurs patients
  if (user.uid && user.role === 'patient') {
    try {
      await db.collection('users').doc(user.uid).set({
        ...user,
        lastModified: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });
      console.log("üë§ Utilisateur sauvegard√© sur Firestore:", user.email);
    } catch (error) {
      console.error("‚ùå Erreur sauvegarde utilisateur Firebase:", error);
    }
  }
}

// Variables globales pour l'utilisateur connect√© (cache en m√©moire)
let currentUserCache = null;

// Fonction pour obtenir l'utilisateur connect√©
function getUser() {
  return currentUserCache;
}

// Fonction pour obtenir l'utilisateur connect√© (alias)
function getCurrentUser() {
  return currentUserCache;
}

// Fonction pour d√©finir l'utilisateur connect√©
async function setUser(user) {
  currentUserCache = user;
  if (user) {
    await saveCurrentUserToFirestore(user);
  }
  console.log("üë§ Utilisateur connect√©:", user?.email || "aucun");
}

// Fonction pour d√©connecter l'utilisateur
async function clearUser() {
  if (currentUserCache?.email) {
    await removeCurrentUserFromFirestore(currentUserCache.email);
  }
  currentUserCache = null;
  console.log("üëã Utilisateur d√©connect√©");
}

// Nouvelles fonctionnalit√©s
class SYLUtilities {
  // G√©n√©ration QR Code d'urgence
  static generateEmergencyQR(medicalData) {
    const emergencyData = {
      name: `${medicalData.personalInfo.firstName} ${medicalData.personalInfo.lastName}`,
      bloodType: medicalData.personalInfo.bloodType,
      allergies: medicalData.medicalHistory.allergies,
      conditions: medicalData.medicalHistory.chronicDiseases,
      emergencyContact: medicalData.personalInfo.emergencyContact,
      criticalNotes: medicalData.emergencyInfo.criticalNotes,
      timestamp: new Date().toISOString()
    };
    
    // QR Code simple avec donn√©es base64
    const qrData = btoa(JSON.stringify(emergencyData));
    return `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(qrData)}`;
  }
  
  // G√©olocalisation d'urgence
  static async getEmergencyLocation() {
    return new Promise((resolve, reject) => {
      if (!navigator.geolocation) {
        reject('G√©olocalisation non support√©e');
        return;
      }
      
      navigator.geolocation.getCurrentPosition(
        position => resolve({
          latitude: position.coords.latitude,
          longitude: position.coords.longitude,
          accuracy: position.coords.accuracy,
          timestamp: new Date().toISOString()
        }),
        error => reject(error.message),
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
      );
    });
  }
  
  // Mode hors ligne
  static setupOfflineMode() {
    if ('serviceWorker' in navigator) {
      const swCode = `
        const CACHE_NAME = 'syl-medical-v1';
        const urlsToCache = [
          '/',
          'https://cdn.tailwindcss.com'
        ];

        self.addEventListener('install', event => {
          event.waitUntil(
            caches.open(CACHE_NAME)
              .then(cache => cache.addAll(urlsToCache))
          );
        });

        self.addEventListener('fetch', event => {
          event.respondWith(
            caches.match(event.request)
              .then(response => response || fetch(event.request))
          );
        });
      `;
      
      const blob = new Blob([swCode], { type: 'application/javascript' });
      const swUrl = URL.createObjectURL(blob);
      
      navigator.serviceWorker.register(swUrl)
        .then(() => console.log('Service Worker enregistr√©'))
        .catch(err => console.log('Erreur Service Worker:', err));
    }
  }
  
  // Notifications push
  static async requestNotificationPermission() {
    if ('Notification' in window) {
      const permission = await Notification.requestPermission();
      return permission === 'granted';
    }
    return false;
  }
  
  static showNotification(title, options) {
    if (Notification.permission === 'granted') {
      new Notification(title, {
        icon: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA4MDAgODAwIj48YyB4PSI4MDAiIHk9IjQ3MiIgY3g9IjE5MiIgY3k9IjI4IiByPSI1MiIvPjwvc3ZnPg==',
        badge: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA4MDAgODAwIj48YyB4PSI4MDAiIHk9IjQ3MiIgY3g9IjE5MiIgY3k9IjI4IiByPSI1MiIvPjwvc3ZnPg==',
        ...options
      });
    }
  }
  
  // Export PDF
  static generatePDF(medicalData) {
    const emergencyInfo = `
<!DOCTYPE html>
<html>
<head>
  <title>SYL Medical - Fiche d'urgence</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .header { text-align: center; color: #dc2626; border-bottom: 3px solid #dc2626; padding-bottom: 10px; }
    .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
    .critical { background-color: #fef2f2; border-color: #dc2626; }
    .label { font-weight: bold; color: #374151; }
    .value { color: #1f2937; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  </style>
</head>
<body>
  <div class="header">
    <h1>üöë FICHE M√âDICALE D'URGENCE</h1>
    <h2>${medicalData.personalInfo.firstName} ${medicalData.personalInfo.lastName}</h2>
  </div>
  
  <div class="section critical">
    <h3>INFORMATIONS CRITIQUES</h3>
    <div class="grid">
      <div><span class="label">Groupe sanguin:</span> <span class="value">${medicalData.personalInfo.bloodType || 'Non renseign√©'}</span></div>
      <div><span class="label">Date de naissance:</span> <span class="value">${medicalData.personalInfo.dateOfBirth}</span></div>
    </div>
  </div>
  
  <div class="section">
    <h3>ALLERGIES</h3>
    <p class="value">${medicalData.medicalHistory.allergies.join(', ') || 'Aucune allergie connue'}</p>
  </div>
  
  <div class="section">
    <h3>TRAITEMENTS EN COURS</h3>
    <p class="value">${medicalData.medicalHistory.medications.join(', ') || 'Aucun traitement'}</p>
  </div>
  
  <div class="section">
    <h3>CONTACT D'URGENCE</h3>
    <p class="value">${medicalData.personalInfo.emergencyContact.name} (${medicalData.personalInfo.emergencyContact.relation})<br>
    T√©l: ${medicalData.personalInfo.emergencyContact.phone}</p>
  </div>
  
  ${medicalData.emergencyInfo.criticalNotes ? `
  <div class="section critical">
    <h3>NOTES CRITIQUES</h3>
    <p class="value">${medicalData.emergencyInfo.criticalNotes}</p>
  </div>
  ` : ''}
  
  <div class="section">
    <p style="text-align: center; color: #6b7280; font-size: 12px;">
      G√©n√©r√© le ${new Date().toLocaleString('fr-FR')} par SYL Medical
    </p>
  </div>
</body>
</html>
    `;
    
    const blob = new Blob([emergencyInfo], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `fiche-urgence-${medicalData.personalInfo.firstName}-${new Date().toISOString().split('T')[0]}.html`;
    a.click();
    URL.revokeObjectURL(url);
  }
  
  // API NFC pour l'acc√®s d'urgence
  static async handleNFCAccess(tagId) {
    try {
      const nfcTags = JSON.parse(localStorage.getItem('syl-nfc-tags') || '[]');
      const patients = JSON.parse(localStorage.getItem('syl-patients') || '[]');
      
      const tag = nfcTags.find(t => t.id === tagId);
      if (!tag || !tag.assignedTo) {
        throw new Error('Tag NFC non reconnu ou non assign√©');
      }
      
      const patient = patients.find(p => (p.id || p.uid) === tag.assignedTo);
      if (!patient) {
        throw new Error('Patient non trouv√© pour ce tag');
      }
      
      // R√©cup√©rer les donn√©es m√©dicales compl√®tes depuis Firebase si possible
      let medicalData = null;
      try {
        const doc = await db.collection('patients').doc(tag.assignedTo + '_medical').get();
        if (doc.exists) {
          medicalData = doc.data();
        }
      } catch (error) {
        console.warn('Impossible de r√©cup√©rer les donn√©es Firebase, utilisation des donn√©es locales');
      }
      
      // Fallback sur les donn√©es du patient si pas de donn√©es m√©dicales
      if (!medicalData && patient.medicalHistory) {
        medicalData = {
          personalInfo: patient.personalInfo,
          medicalHistory: patient.medicalHistory,
          emergencyInfo: patient.emergencyInfo
        };
      }
      
      if (!medicalData) {
        throw new Error('Aucune donn√©e m√©dicale disponible pour ce patient');
      }
      
      // Afficher l'interface d'urgence
      this.displayEmergencyInterface(medicalData, tagId);
      
      // Logger l'acc√®s
      SYLAnalytics.trackEvent('nfc_emergency_access', { 
        tagId, 
        patientId: tag.assignedTo,
        timestamp: new Date().toISOString()
      });
      
      return medicalData;
    } catch (error) {
      console.error('Erreur acc√®s NFC:', error);
      this.displayErrorInterface(error.message);
      throw error;
    }
  }
  
  static displayEmergencyInterface(medicalData, tagId) {
    // Cr√©er une interface d'urgence en plein √©cran
    const emergencyInterface = document.createElement('div');
    emergencyInterface.className = 'fixed inset-0 bg-red-600 z-50 overflow-y-auto';
    emergencyInterface.innerHTML = `
      <div class="min-h-screen p-4">
        <div class="max-w-4xl mx-auto">
          <div class="bg-white rounded-lg shadow-2xl overflow-hidden">
            <div class="bg-red-600 text-white p-6 text-center">
              <h1 class="text-3xl font-bold">üöë ACC√àS D'URGENCE M√âDICALE</h1>
              <p class="text-xl mt-2">Tag NFC: ${tagId}</p>
              <p class="text-lg">Acc√®s le ${new Date().toLocaleString('fr-FR')}</p>
            </div>
            
            <div class="p-6 space-y-6">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-red-50 border-l-4 border-red-500 p-4">
                  <h2 class="text-xl font-bold text-red-800 mb-4">IDENTIT√â PATIENT</h2>
                  <div class="space-y-2">
                    <p><strong>Nom:</strong> ${medicalData.personalInfo.lastName}</p>
                    <p><strong>Pr√©nom:</strong> ${medicalData.personalInfo.firstName}</p>
                    <p><strong>Date de naissance:</strong> ${medicalData.personalInfo.dateOfBirth}</p>
                    <p><strong>Groupe sanguin:</strong> <span class="bg-red-600 text-white px-3 py-1 rounded font-bold text-lg">${medicalData.personalInfo.bloodType || 'NON RENSEIGN√â'}</span></p>
                  </div>
                </div>
                
                <div class="bg-orange-50 border-l-4 border-orange-500 p-4">
                  <h2 class="text-xl font-bold text-orange-800 mb-4">CONTACT D'URGENCE</h2>
                  <div class="space-y-2">
                    <p><strong>Nom:</strong> ${medicalData.personalInfo.emergencyContact.name}</p>
                    <p><strong>Relation:</strong> ${medicalData.personalInfo.emergencyContact.relation}</p>
                    <p><strong>T√©l√©phone:</strong> <a href="tel:${medicalData.personalInfo.emergencyContact.phone}" class="text-blue-600 underline text-lg font-bold">${medicalData.personalInfo.emergencyContact.phone}</a></p>
                  </div>
                </div>
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4">
                  <h2 class="text-xl font-bold text-yellow-800 mb-4">‚ö†Ô∏è ALLERGIES CRITIQUES</h2>
                  <div class="space-y-1">
                    ${medicalData.medicalHistory.allergies?.length ? 
                      medicalData.medicalHistory.allergies.map(a => `<span class="bg-red-500 text-white px-2 py-1 rounded mr-1 mb-1 inline-block">${a}</span>`).join('') : 
                      '<p class="text-gray-500">Aucune allergie connue</p>'
                    }
                  </div>
                </div>
                
                <div class="bg-blue-50 border-l-4 border-blue-500 p-4">
                  <h2 class="text-xl font-bold text-blue-800 mb-4">üíä TRAITEMENTS EN COURS</h2>
                  <div class="space-y-1">
                    ${medicalData.medicalHistory.medications?.length ? 
                      medicalData.medicalHistory.medications.map(m => `<span class="bg-blue-500 text-white px-2 py-1 rounded mr-1 mb-1 inline-block">${m}</span>`).join('') : 
                      '<p class="text-gray-500">Aucun traitement</p>'
                    }
                  </div>
                </div>
              </div>
              
              <div class="bg-purple-50 border-l-4 border-purple-500 p-4">
                <h2 class="text-xl font-bold text-purple-800 mb-4">üè• PATHOLOGIES & CONDITIONS</h2>
                <div class="space-y-1">
                  ${medicalData.medicalHistory.chronicDiseases?.length ? 
                    medicalData.medicalHistory.chronicDiseases.map(c => `<span class="bg-purple-500 text-white px-2 py-1 rounded mr-1 mb-1 inline-block">${c}</span>`).join('') : 
                    '<p class="text-gray-500">Aucune pathologie chronique</p>'
                  }
                </div>
              </div>
              
              ${medicalData.emergencyInfo?.criticalNotes ? `
              <div class="bg-red-100 border-2 border-red-300 p-4 rounded-lg">
                <h2 class="text-xl font-bold text-red-800 mb-4">üö® NOTES CRITIQUES POUR LES SECOURS</h2>
                <p class="text-red-700 text-lg">${medicalData.emergencyInfo.criticalNotes}</p>
              </div>
              ` : ''}
              
              <div class="flex flex-wrap gap-4 justify-center">
                <a href="tel:15" class="bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg px-6 py-3 text-lg">üìû SAMU 15</a>
                <a href="tel:18" class="bg-orange-600 hover:bg-orange-700 text-white font-bold rounded-lg px-6 py-3 text-lg">üöí Pompiers 18</a>
                <a href="tel:112" class="bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg px-6 py-3 text-lg">üÜò Urgences 112</a>
                <button onclick="SYLUtilities.generatePDF(${JSON.stringify(medicalData).replace(/"/g, '&quot;')})" class="bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg px-6 py-3 text-lg">üìÑ Export PDF</button>
                <button onclick="this.closest('.fixed').remove()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold rounded-lg px-6 py-3 text-lg">‚ùå Fermer</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
    
    document.body.appendChild(emergencyInterface);
    
    // Notification sonore si possible
    try {
      const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+HyvmwhBRuBzvLZiTcIGGm98OScTgwOUarm7bZkHgU2jdXxxXkpBSV+zPDckT0IEl+25OqoVRMKRZ/h8r5vIAUdgM3y2Ik3CRZqve/jm04MDlCr5ey2ZSAEOIzU8cV5KgUme8rx3I87CRBtueXrrFgSCUOc3/O+byAFHYDN8tiJNwkWar3v45tODA5Qqubstm');
      audio.play().catch(() => {}); // Ignorer les erreurs audio
    } catch (e) {}
    
    // Auto-fermeture apr√®s 5 minutes par s√©curit√©
    setTimeout(() => {
      if (document.body.contains(emergencyInterface)) {
        emergencyInterface.remove();
      }
    }, 300000);
  }
  
  static displayErrorInterface(errorMessage) {
    const errorInterface = document.createElement('div');
    errorInterface.className = 'fixed inset-0 bg-red-900 bg-opacity-90 z-50 flex items-center justify-center';
    errorInterface.innerHTML = `
      <div class="bg-white rounded-lg p-8 max-w-md mx-4 text-center">
        <div class="text-red-600 text-6xl mb-4">‚ùå</div>
        <h2 class="text-2xl font-bold text-gray-900 mb-4">Erreur d'acc√®s NFC</h2>
        <p class="text-gray-700 mb-6">${errorMessage}</p>
        <div class="space-y-4">
          <button onclick="this.closest('.fixed').remove()" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold rounded-lg px-6 py-3">Fermer</button>
          <div class="flex gap-2">
            <a href="tel:15" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg px-4 py-2">SAMU 15</a>
            <a href="tel:112" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg px-4 py-2">112</a>
          </div>
        </div>
      </div>
    `;
    document.body.appendChild(errorInterface);
  }
}

// Initialisation PWA et mode hors ligne
if (typeof window !== 'undefined') {
  SYLUtilities.setupOfflineMode();
  SYLUtilities.requestNotificationPermission();
}

function showLogin() {
  document.getElementById('app').innerHTML = `
<div class="min-h-screen bg-gradient-to-br from-blue-50 via-white to-green-50 flex items-center justify-center p-4">
  <div class="w-full max-w-md">
    <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-8">
      <div class="text-center mb-8">
        <div class="mx-auto w-16 h-16 bg-gradient-to-r from-blue-600 to-green-600 rounded-full flex items-center justify-center mb-4">
          ${icons.heart}
        </div>
        <h1 class="text-2xl font-bold text-gray-900">SYL Medical</h1>
        <p class="text-gray-600 mt-2">Syst√®me d'Urgence M√©dicale</p>
      </div>

      <!-- Interface simplifi√©e pour patients -->
      <div class="mb-6">
        <div class="text-center p-4 bg-blue-50 rounded-lg border-2 border-blue-600">
          <div class="text-blue-600 text-3xl mb-2">${icons.user}</div>
          <h3 class="text-lg font-semibold text-blue-800">Espace Patient</h3>
          <p class="text-sm text-blue-600">Connectez-vous ou cr√©ez votre compte m√©dical</p>
        </div>
      </div>

      <!-- Onglets de connexion -->
      <div class="flex space-x-2 mb-4">
        <button class="flex-1 py-2 px-4 text-sm rounded-lg bg-blue-600 text-white" id="tabEmail">Email</button>
        <button class="flex-1 py-2 px-4 text-sm rounded-lg bg-gray-200 text-gray-600" id="tabGoogle">Google</button>
        <button class="flex-1 py-2 px-4 text-sm rounded-lg bg-gray-400 text-gray-500 cursor-not-allowed" disabled title="N√©cessite la facturation Firebase">SMS (Bient√¥t)</button>
      </div>

      <!-- Formulaire Email -->
      <div id="emailForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
          <div class="relative">
            <input type="email" id="email" required placeholder="votre@email.com"
              class="w-full px-3 py-2 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">${icons.mail}</span>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Mot de passe</label>
          <input type="password" id="password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"/>
        </div>
        <div class="flex space-x-2">
          <button id="loginEmail" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg px-6 py-3">
            ${icons.lock} Se connecter
          </button>
          <button id="registerEmail" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg px-6 py-3">
            ${icons.user} S'inscrire
          </button>
        </div>
      </div>

      <!-- Formulaire Google -->
      <div id="googleForm" class="hidden">
        <button id="loginGoogle" class="w-full bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg px-6 py-3 flex items-center justify-center gap-2">
          <svg class="w-5 h-5" viewBox="0 0 24 24"><path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
          Se connecter avec Google
        </button>
        <div class="mt-4 p-3 bg-blue-50 rounded-lg">
          <p class="text-blue-700 text-sm">üìù <strong>Note :</strong> Si vous obtenez une erreur "domaine non autoris√©", ajoutez votre domaine dans Firebase Console ‚Üí Authentication ‚Üí Settings ‚Üí Authorized domains</p>
        </div>
      </div>

      <div class="mt-8 pt-6 border-t border-gray-200">
        <div class="text-xs text-gray-500 space-y-1">
          <p>üöë Acc√®s d'urgence instantan√©</p>
          <p>üîí Authentification Firebase s√©curis√©e</p>
          <p>üè• Conforme RGPD & HDS</p>
          <p>‚ö° Synchronisation temps r√©el</p>
        </div>
      </div>
    </div>
  </div>
</div>
  `;

  let role = 'patient'; // Toujours patient par d√©faut
  let activeTab = 'email';

  // Plus besoin de gestion des r√¥les - automatiquement patient

  // Gestion des onglets
  function switchTab(tab) {
    activeTab = tab;
    // Reset tous les onglets
    document.getElementById('tabEmail').classList.remove('bg-blue-600', 'text-white');
    document.getElementById('tabEmail').classList.add('bg-gray-200', 'text-gray-600');
    document.getElementById('tabGoogle').classList.remove('bg-blue-600', 'text-white');
    document.getElementById('tabGoogle').classList.add('bg-gray-200', 'text-gray-600');
    
    // Activer l'onglet s√©lectionn√©
    if (tab === 'email') {
      document.getElementById('tabEmail').classList.remove('bg-gray-200', 'text-gray-600');
      document.getElementById('tabEmail').classList.add('bg-blue-600', 'text-white');
    } else if (tab === 'google') {
      document.getElementById('tabGoogle').classList.remove('bg-gray-200', 'text-gray-600');
      document.getElementById('tabGoogle').classList.add('bg-blue-600', 'text-white');
    }
    
    // Afficher le bon formulaire
    document.getElementById('emailForm').classList.add('hidden');
    document.getElementById('googleForm').classList.add('hidden');
    document.getElementById(tab + 'Form').classList.remove('hidden');
  }

  document.getElementById('tabEmail').onclick = () => switchTab('email');
  document.getElementById('tabGoogle').onclick = () => switchTab('google');

  // Authentification par email
  document.getElementById('loginEmail').onclick = async () => {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    
    if (!email || !password) {
      alert('Veuillez remplir tous les champs');
      return;
    }
    
    try {
      showLoader();
      
      // V√©rification admin en local d'abord (d√©tection automatique)
      if (adminAccounts[email] === password) {
        console.log('üîë Connexion admin d√©tect√©e pour:', email);
        const adminData = {
          uid: 'admin_' + email.replace(/[^a-zA-Z0-9]/g, '_'),
          email: email,
          role: 'admin',
          profile: {
            firstName: 'Admin',
            lastName: 'Syst√®me',
            phone: ''
          },
          createdAt: new Date().toISOString()
        };
        saveUser(adminData);
        hideLoader();
        renderApp();
        return;
      }
      
      // Connexion Firebase pour les patients
      const userCredential = await auth.signInWithEmailAndPassword(email, password);
      await handleAuthSuccess(userCredential.user, 'patient');
    } catch (error) {
      hideLoader();
      console.error('Erreur de connexion:', error);
      alert('Erreur de connexion: ' + getErrorMessage(error.code || 'unknown'));
    }
  };

  document.getElementById('registerEmail').onclick = async () => {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    
    if (password.length < 6) {
      alert('Le mot de passe doit contenir au moins 6 caract√®res');
      return;
    }
    
    try {
      showLoader();
      const userCredential = await auth.createUserWithEmailAndPassword(email, password);
      // Toutes les inscriptions sont des patients (sauf l'admin qui utilise le syst√®me local)
      await handleAuthSuccess(userCredential.user, 'patient');
    } catch (error) {
      hideLoader();
      alert('Erreur d\'inscription: ' + getErrorMessage(error.code));
    }
  };

  // Authentification par Google
  document.getElementById('loginGoogle').onclick = async () => {
    try {
      showLoader();
      const result = await auth.signInWithPopup(googleProvider);
      await handleAuthSuccess(result.user, role);
    } catch (error) {
      hideLoader();
      if (error.code === 'auth/unauthorized-domain') {
        alert('‚ùå Domaine non autoris√©.\n\nüìù Solution :\n1. Allez dans Firebase Console\n2. Authentication ‚Üí Settings ‚Üí Authorized domains\n3. Ajoutez "localhost" et votre domaine');
      } else {
        alert('Erreur de connexion Google: ' + getErrorMessage(error.code));
      }
    }
  };
}

async function handleAuthSuccess(firebaseUser, role) {
  try {
    const userData = {
      uid: firebaseUser.uid,
      email: firebaseUser.email,
      phone: firebaseUser.phoneNumber,
      displayName: firebaseUser.displayName,
      role: role,
      profile: {
        firstName: role === 'patient' ? (firebaseUser.displayName?.split(' ')[0] || 'Patient') : 'Dr. ' + (firebaseUser.displayName?.split(' ')[0] || 'M√©decin'),
        lastName: firebaseUser.displayName?.split(' ').slice(1).join(' ') || '',
        phone: firebaseUser.phoneNumber || '',
        ...(role === 'medecin' && { 
          speciality: 'M√©decine g√©n√©rale', 
          hospital: '√âtablissement de sant√©' 
        })
      },
      createdAt: new Date().toISOString()
    };
    
    saveUser(userData);
    hideLoader();
    renderApp();
  } catch (error) {
    hideLoader();
    console.error('Erreur lors de la sauvegarde:', error);
    alert('Connexion r√©ussie mais erreur de sauvegarde');
  }
}

function getErrorMessage(errorCode) {
  switch (errorCode) {
    case 'auth/user-not-found':
      return 'Aucun compte trouv√© avec cet email';
    case 'auth/wrong-password':
      return 'Mot de passe incorrect';
    case 'auth/email-already-in-use':
      return 'Cet email est d√©j√† utilis√©';
    case 'auth/weak-password':
      return 'Mot de passe trop faible (min 6 caract√®res)';
    case 'auth/invalid-email':
      return 'Email invalide';
    case 'auth/too-many-requests':
      return 'Trop de tentatives, r√©essayez plus tard';
    default:
      return 'Erreur de connexion';
  }
}

function hideLoader() {
  const loader = document.querySelector('.animate-spin')?.parentElement?.parentElement;
  if (loader) loader.remove();
}

function showLoader(callback = null) {
  document.getElementById('app').innerHTML = `
    <div class="min-h-screen bg-gray-50 flex items-center justify-center">
      <div class="text-center">
        <div class="w-16 h-16 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
        <p class="text-gray-600">Authentification en cours...</p>
      </div>
    </div>
  `;
  if (callback) setTimeout(callback, 800);
}

// Syst√®me de rappels et notifications
class ReminderSystem {
  static init() {
    this.checkReminders();
    setInterval(() => this.checkReminders(), 60000); // V√©rification chaque minute
  }
  
  static checkReminders() {
    const medicalData = JSON.parse(localStorage.getItem('syl-medicalData') || '{}');
    const reminders = JSON.parse(localStorage.getItem('syl-reminders') || '[]');
    const now = new Date();
    
    reminders.forEach(reminder => {
      const reminderTime = new Date(reminder.dateTime);
      if (reminderTime <= now && !reminder.notified) {
        SYLUtilities.showNotification(`üíä Rappel: ${reminder.title}`, {
          body: reminder.message,
          icon: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA4MDAgODAwIj48YyB4PSI4MDAiIHk9IjQ3MiIgY3g9IjE5MiIgY3k9IjI4IiByPSI1MiIvPjwvc3ZnPg==',
          tag: reminder.id
        });
        reminder.notified = true;
      }
    });
    
    localStorage.setItem('syl-reminders', JSON.stringify(reminders));
  }
  
  static addReminder(title, message, dateTime) {
    const reminders = JSON.parse(localStorage.getItem('syl-reminders') || '[]');
    const reminder = {
      id: Date.now().toString(),
      title,
      message,
      dateTime,
      notified: false,
      created: new Date().toISOString()
    };
    reminders.push(reminder);
    localStorage.setItem('syl-reminders', JSON.stringify(reminders));
    return reminder;
  }
}

// V√©rification de s√©curit√© et validation des donn√©es
class DataValidator {
  static validateMedicalData(data) {
    const errors = [];
    
    if (!data.personalInfo?.firstName) {
      errors.push('Pr√©nom requis');
    }
    
    if (!data.personalInfo?.lastName) {
      errors.push('Nom requis');
    }
    
    if (!data.personalInfo?.bloodType) {
      errors.push('Groupe sanguin recommand√© pour les urgences');
    }
    
    if (!data.personalInfo?.emergencyContact?.phone) {
      errors.push('Contact d\'urgence requis');
    }
    
    return errors;
  }
  
  static sanitizeInput(input) {
    if (typeof input !== 'string') return input;
    return input.replace(/[<>]/g, '').trim();
  }
}

// Initialisation des syst√®mes
// ============ DEBUG SILENCIEUX AUTOMATIQUE ============
// S'ex√©cute automatiquement au chargement de la page (admin uniquement)
async function silentDebugCheck() {
  const currentUser = getCurrentUser();
  if (!currentUser || currentUser.role !== 'admin') return;
  
  console.log('%cüîç DEBUG SILENCIEUX ACTIV√â', 'background: #3b82f6; color: white; padding: 4px 8px; border-radius: 4px; font-weight: bold;');
  
  try {
    // V√©rifier l'√©tat de Firebase
    if (!db) {
      console.warn('‚ö†Ô∏è Firebase non initialis√©');
      return;
    }
    
    // Analyser les collections principales
    const collections = ['patients', 'users', 'activeUsers', 'admins', 'nfcTags'];
    const stats = {};
    
    for (const collectionName of collections) {
      try {
        const snapshot = await db.collection(collectionName).limit(10).get();
        stats[collectionName] = {
          count: snapshot.size,
          accessible: true
        };
        
        // Analyser la structure des donn√©es
        if (snapshot.size > 0) {
          const firstDoc = snapshot.docs[0].data();
          const fields = Object.keys(firstDoc);
          stats[collectionName].fields = fields.length;
          stats[collectionName].sampleFields = fields.slice(0, 5);
        }
      } catch (error) {
        stats[collectionName] = {
          accessible: false,
          error: error.message
        };
      }
    }
    
    // Logger les r√©sultats
    console.group('üìä √âtat des Collections Firebase');
    Object.entries(stats).forEach(([collection, data]) => {
      if (data.accessible) {
        console.log(`‚úÖ ${collection}: ${data.count} docs, ${data.fields || 0} champs`);
        if (data.sampleFields) {
          console.log(`   Exemples: ${data.sampleFields.join(', ')}`);
        }
      } else {
        console.warn(`‚ùå ${collection}: ${data.error}`);
      }
    });
    console.groupEnd();
    
    // V√©rifier la coh√©rence des IDs
    try {
      const patientsSnapshot = await db.collection('patients').limit(5).get();
      const idIssues = [];
      
      patientsSnapshot.forEach(doc => {
        const data = doc.data();
        if (doc.id !== data.uid && doc.id !== data.id) {
          idIssues.push({
            docId: doc.id,
            dataUid: data.uid,
            dataId: data.id
          });
        }
      });
      
      if (idIssues.length > 0) {
        console.warn('‚ö†Ô∏è Incoh√©rences d\'IDs d√©tect√©es:', idIssues);
      } else {
        console.log('‚úÖ IDs coh√©rents dans la collection patients');
      }
    } catch (error) {
      console.warn('‚ö†Ô∏è Impossible de v√©rifier les IDs:', error.message);
    }
    
  } catch (error) {
    console.error('‚ùå Erreur debug silencieux:', error);
  }
}

document.addEventListener('DOMContentLoaded', () => {
  ReminderSystem.init();
  
  // Lancer le debug silencieux apr√®s 2 secondes (laisser le temps √† l'app de se charger)
  setTimeout(() => {
    silentDebugCheck();
  }, 2000);
});

// ----------- PATIENT DASHBOARD -----------
function renderPatientDashboard(user) {
  let medicalData = JSON.parse(localStorage.getItem('syl-medicalData') || 'null');
  if (!medicalData) {
    medicalData = {
      personalInfo: {
        firstName: user.profile.firstName,
        lastName: user.profile.lastName,
        dateOfBirth: '',
        bloodType: '',
        height: '',
        weight: '',
        emergencyContact: { name: '', relation: '', phone: '' },
        secondaryContact: { name: '', relation: '', phone: '' },
        address: '',
        city: '',
        postalCode: '',
        nationalId: '',
        socialSecurityNumber: '',
        insuranceNumber: '',
        preferredHospital: '',
        organDonor: false,
        advanceDirectives: false
      },
      medicalHistory: {
        allergies: [],
        medications: [],
        conditions: [],
        surgeries: [],
        chronicDiseases: [],
        medicalDevices: [],
        emergencyMedications: []
      },
      emergencyInfo: {
        primaryPhysician: { name: '', phone: '', specialty: '' },
        pharmacist: { name: '', phone: '', address: '' },
        lastUpdate: new Date().toISOString(),
        criticalNotes: '',
        contraindications: [],
        riskFactors: []
      },
      braceletId: '',
      isActive: false
    };
  }
  localStorage.setItem('syl-medicalData', JSON.stringify(medicalData));
  let activeTab = 'emergency';
  render();

  function render() {
    document.getElementById('app').innerHTML = `
    <div class="min-h-screen bg-gray-50">
      <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center h-16">
          <div class="flex items-center">
            ${icons.heart}<h1 class="text-xl font-bold text-gray-900 ml-3">SYL Patient</h1>
          </div>
          <div class="flex items-center space-x-4">
            <div class="text-sm text-gray-600">Bonjour, ${user.profile.firstName}</div>
            <button id="logoutBtn" class="border-2 border-blue-600 text-blue-600 hover:bg-blue-50 font-medium rounded-lg px-4 py-2 flex items-center gap-2">${icons.logout} D√©connexion</button>
          </div>
        </div>
      </header>
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
          <div class="lg:col-span-1">
            <nav class="space-y-2">
              <button class="w-full flex items-center px-4 py-3 text-left rounded-lg transition-colors ${activeTab==='emergency' ? 'bg-red-100 text-red-700 border-l-4 border-red-600':'text-gray-600 hover:bg-gray-100'}" data-tab="emergency">${icons.emergency} <span class="ml-3">üöë Urgence</span></button>
              <button class="w-full flex items-center px-4 py-3 text-left rounded-lg transition-colors ${activeTab==='profile' ? 'bg-blue-100 text-blue-700 border-l-4 border-blue-600':'text-gray-600 hover:bg-gray-100'}" data-tab="profile">${icons.user} <span class="ml-3">Profil complet</span></button>
              <button class="w-full flex items-center px-4 py-3 text-left rounded-lg transition-colors ${activeTab==='medical' ? 'bg-blue-100 text-blue-700 border-l-4 border-blue-600':'text-gray-600 hover:bg-gray-100'}" data-tab="medical">${icons.medical} <span class="ml-3">M√©dical</span></button>
              <button class="w-full flex items-center px-4 py-3 text-left rounded-lg transition-colors ${activeTab==='history' ? 'bg-blue-100 text-blue-700 border-l-4 border-blue-600':'text-gray-600 hover:bg-gray-100'}" data-tab="history">${icons.activity} <span class="ml-3">Historique</span></button>
              <button class="w-full flex items-center px-4 py-3 text-left rounded-lg transition-colors ${activeTab==='bracelet' ? 'bg-blue-100 text-blue-700 border-l-4 border-blue-600':'text-gray-600 hover:bg-gray-100'}" data-tab="bracelet">${icons.smartphone} <span class="ml-3">Bracelet</span></button>
              <button class="w-full flex items-center px-4 py-3 text-left rounded-lg transition-colors ${activeTab==='reminders' ? 'bg-blue-100 text-blue-700 border-l-4 border-blue-600':'text-gray-600 hover:bg-gray-100'}" data-tab="reminders">${icons.clock} <span class="ml-3">Rappels</span></button>
            </nav>
          </div>
          <div class="lg:col-span-3">
            ${activeTab === 'emergency' ? renderEmergencyTab() : ''}
            ${activeTab === 'profile' ? renderProfileTab() : ''}
            ${activeTab === 'medical' ? renderMedicalTab() : ''}
            ${activeTab === 'history' ? renderHistoryTab() : ''}
            ${activeTab === 'bracelet' ? renderBraceletTab() : ''}
            ${activeTab === 'reminders' ? renderRemindersTab() : ''}
          </div>
        </div>
      </div>
    </div>
`;
    document.getElementById('logoutBtn').onclick = () => { logout(); };
    document.querySelectorAll('[data-tab]').forEach(btn => btn.onclick = () => { activeTab = btn.getAttribute('data-tab'); render(); });
    if (activeTab === 'emergency') tabEmergencyEvents();
    if (activeTab === 'profile') tabProfileEvents();
    if (activeTab === 'medical') tabMedicalEvents();
    if (activeTab === 'bracelet') tabBraceletEvents();
    if (activeTab === 'reminders') tabRemindersEvents();
  }

  function renderEmergencyTab() {
    return `
      <div class="space-y-6">
        <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-lg">
          <div class="flex items-center">
            <div class="text-red-500 mr-3">${icons.emergency}</div>
            <h2 class="text-2xl font-bold text-red-800">INFORMATIONS D'URGENCE</h2>
          </div>
          <p class="text-red-700 mt-2">Ces informations sont critiques pour les secours</p>
        </div>

        <!-- Carte d'identit√© d'urgence -->
        <div class="bg-white rounded-xl shadow-lg border-l-4 border-red-500 p-6">
          <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
            ${icons.cross} <span class="ml-2">CARTE D'URGENCE M√âDICALE</span>
          </h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="space-y-4">
              <div class="bg-red-50 p-4 rounded-lg">
                <h4 class="font-bold text-red-800">IDENTIT√â</h4>
                <p><strong>Nom:</strong> ${medicalData.personalInfo.lastName}</p>
                <p><strong>Pr√©nom:</strong> ${medicalData.personalInfo.firstName}</p>
                <p><strong>N√©(e) le:</strong> ${medicalData.personalInfo.dateOfBirth}</p>
                <p><strong>Groupe sanguin:</strong> <span class="bg-red-600 text-white px-2 py-1 rounded font-bold">${medicalData.personalInfo.bloodType || 'NON RENSEIGN√â'}</span></p>
              </div>
              <div class="bg-orange-50 p-4 rounded-lg">
                <h4 class="font-bold text-orange-800">CONTACTS D'URGENCE</h4>
                <p><strong>Principal:</strong> ${medicalData.personalInfo.emergencyContact.name} (${medicalData.personalInfo.emergencyContact.relation})</p>
                <p><strong>T√©l:</strong> ${medicalData.personalInfo.emergencyContact.phone}</p>
                <p><strong>Secondaire:</strong> ${medicalData.personalInfo.secondaryContact.name}</p>
                <p><strong>T√©l:</strong> ${medicalData.personalInfo.secondaryContact.phone}</p>
              </div>
            </div>
            <div class="space-y-4">
              <div class="bg-yellow-50 p-4 rounded-lg">
                <h4 class="font-bold text-yellow-800">‚ö†Ô∏è ALLERGIES CRITIQUES</h4>
                ${medicalData.medicalHistory.allergies.length ? medicalData.medicalHistory.allergies.map(a => `<span class="bg-red-500 text-white px-2 py-1 rounded text-sm mr-1 mb-1 inline-block">${a}</span>`).join('') : '<p class="text-gray-500">Aucune allergie connue</p>'}
              </div>
              <div class="bg-blue-50 p-4 rounded-lg">
                <h4 class="font-bold text-blue-800">üíä TRAITEMENTS EN COURS</h4>
                ${medicalData.medicalHistory.medications.length ? medicalData.medicalHistory.medications.slice(0,5).map(m => `<span class="bg-blue-500 text-white px-2 py-1 rounded text-sm mr-1 mb-1 inline-block">${m}</span>`).join('') : '<p class="text-gray-500">Aucun traitement</p>'}
              </div>
              <div class="bg-purple-50 p-4 rounded-lg">
                <h4 class="font-bold text-purple-800">üè• PATHOLOGIES</h4>
                ${medicalData.medicalHistory.chronicDiseases.length ? medicalData.medicalHistory.chronicDiseases.map(c => `<span class="bg-purple-500 text-white px-2 py-1 rounded text-sm mr-1 mb-1 inline-block">${c}</span>`).join('') : '<p class="text-gray-500">Aucune pathologie chronique</p>'}
              </div>
            </div>
          </div>
          ${medicalData.emergencyInfo.criticalNotes ? `
          <div class="mt-6 bg-red-100 border border-red-300 p-4 rounded-lg">
            <h4 class="font-bold text-red-800 mb-2">üö® NOTES CRITIQUES POUR LES SECOURS</h4>
            <p class="text-red-700">${medicalData.emergencyInfo.criticalNotes}</p>
          </div>
          ` : ''}
        </div>

        <!-- M√©decin traitant -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">üë®‚Äç‚öïÔ∏è M√©decin traitant</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Dr. Nom" value="${medicalData.emergencyInfo.primaryPhysician.name}" id="physicianName">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Sp√©cialit√©" value="${medicalData.emergencyInfo.primaryPhysician.specialty}" id="physicianSpecialty">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="T√©l√©phone" value="${medicalData.emergencyInfo.primaryPhysician.phone}" id="physicianPhone">
          </div>
        </div>

        <!-- Notes critiques -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">üö® Notes critiques pour les secours</h3>
          <textarea class="w-full px-3 py-2 border border-gray-300 rounded-lg h-24" placeholder="Informations vitales √† communiquer aux secours (ex: risque d'allergie, contre-indications sp√©cifiques...)" id="criticalNotes">${medicalData.emergencyInfo.criticalNotes}</textarea>
        </div>

        <!-- Nouvelles fonctionnalit√©s d'urgence -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
          <button id="generateQR" class="bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg px-4 py-3 flex items-center justify-center gap-2">
            üì± QR Code
          </button>
          <button id="getLocation" class="bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg px-4 py-3 flex items-center justify-center gap-2">
            üìç Localisation
          </button>
          <button id="exportPDF" class="bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-lg px-4 py-3 flex items-center justify-center gap-2">
            üìÑ Export PDF
          </button>
          <button id="emergencyCall" class="bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg px-4 py-3 flex items-center justify-center gap-2">
            üìû SAMU 15
          </button>
        </div>

        <button id="saveEmergency" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg px-6 py-3 text-lg">
          ${icons.check} SAUVEGARDER LES INFOS D'URGENCE
        </button>
      </div>
    `;
  }

  function renderProfileTab() {
    return `
      <div class="space-y-6">
        <div class="flex justify-between items-center">
          <h2 class="text-2xl font-bold text-gray-900">Profil Complet</h2>
          <button id="saveProfile" class="bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg px-6 py-2 flex items-center gap-2">${icons.check} Sauvegarder</button>
        </div>

        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Informations personnelles</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Pr√©nom" value="${medicalData.personalInfo.firstName}" id="pfFirstName">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Nom" value="${medicalData.personalInfo.lastName}" id="pfLastName">
            <input type="date" class="w-full px-3 py-2 border border-gray-300 rounded-lg" value="${medicalData.personalInfo.dateOfBirth}" id="pfBirth">
            <select class="w-full px-3 py-2 border border-gray-300 rounded-lg" id="pfBlood">
              <option value="">Groupe sanguin</option>
              ${MEDICAL_DATA.bloodTypes.map(type => `<option value="${type}" ${medicalData.personalInfo.bloodType===type?'selected':''}>${type}</option>`).join('')}
            </select>
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Taille (cm)" value="${medicalData.personalInfo.height}" id="pfHeight">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Poids (kg)" value="${medicalData.personalInfo.weight}" id="pfWeight">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="N¬∞ S√©curit√© Sociale" value="${medicalData.personalInfo.socialSecurityNumber}" id="pfSSN">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="N¬∞ Mutuelle" value="${medicalData.personalInfo.insuranceNumber}" id="pfInsurance">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Adresse" value="${medicalData.personalInfo.address}" id="pfAddress">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Ville" value="${medicalData.personalInfo.city}" id="pfCity">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Code postal" value="${medicalData.personalInfo.postalCode}" id="pfPostal">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="H√¥pital de r√©f√©rence" value="${medicalData.personalInfo.preferredHospital}" id="pfHospital">
          </div>
          
          <div class="mt-6 space-y-4">
            <h4 class="font-semibold text-gray-900">Contacts d'urgence</h4>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Contact principal" value="${medicalData.personalInfo.emergencyContact.name}" id="pfContact1Name">
              <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Relation" value="${medicalData.personalInfo.emergencyContact.relation}" id="pfContact1Rel">
              <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="T√©l√©phone" value="${medicalData.personalInfo.emergencyContact.phone}" id="pfContact1Phone">
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Contact secondaire" value="${medicalData.personalInfo.secondaryContact.name}" id="pfContact2Name">
              <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Relation" value="${medicalData.personalInfo.secondaryContact.relation}" id="pfContact2Rel">
              <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="T√©l√©phone" value="${medicalData.personalInfo.secondaryContact.phone}" id="pfContact2Phone">
            </div>
          </div>

          <div class="mt-6 space-y-2">
            <label class="flex items-center">
              <input type="checkbox" ${medicalData.personalInfo.organDonor ? 'checked' : ''} id="pfOrganDonor" class="mr-2">
              <span>Donneur d'organes</span>
            </label>
            <label class="flex items-center">
              <input type="checkbox" ${medicalData.personalInfo.advanceDirectives ? 'checked' : ''} id="pfDirectives" class="mr-2">
              <span>Directives anticip√©es r√©dig√©es</span>
            </label>
          </div>
        </div>
      </div>
    `;
  }

  function renderMedicalTab() {
    return `
      <div class="space-y-6">
        <h2 class="text-2xl font-bold text-gray-900">Dossier M√©dical Complet</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          ${renderMedicalListManager('Allergies', 'allergies', MEDICAL_DATA.commonAllergies)}
          ${renderMedicalListManager('M√©dicaments actuels', 'medications', MEDICAL_DATA.emergencyMedications)}
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          ${renderMedicalListManager('Pathologies chroniques', 'chronicDiseases', MEDICAL_DATA.chronicConditions)}
          ${renderMedicalListManager('Dispositifs m√©dicaux', 'medicalDevices', MEDICAL_DATA.medicalDevices)}
        </div>
        
        ${renderMedicalListManager('Interventions chirurgicales', 'surgeries', [])}
        ${renderMedicalListManager('M√©dicaments d\'urgence', 'emergencyMedications', MEDICAL_DATA.emergencyMedications)}
        ${renderMedicalListManager('Contre-indications', 'contraindications', [])}
        ${renderMedicalListManager('Facteurs de risque', 'riskFactors', [])}
      </div>
    `;
  }

  function renderMedicalListManager(title, listType, suggestions) {
    const list = listType.includes('.') ? 
      medicalData.medicalHistory[listType.split('.')[1]] || medicalData.emergencyInfo[listType.split('.')[1]] :
      medicalData.medicalHistory[listType] || medicalData.emergencyInfo[listType] || [];
    
    return `
      <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">${title}</h3>
        <div class="space-y-3">
          <div class="flex gap-2">
            <input type="text" list="suggestions_${listType}" placeholder="Ajouter..." class="flex-1 px-3 py-2 border border-gray-300 rounded-lg" id="add_${listType}">
            <datalist id="suggestions_${listType}">
              ${suggestions.map(item => `<option value="${item}">`).join('')}
            </datalist>
            <button class="bg-blue-600 hover:bg-blue-700 text-white rounded-lg px-3 py-2" id="btn_${listType}">${icons.plus}</button>
          </div>
          <div class="space-y-2" id="list_${listType}">
            ${list.map((item, idx) => `
              <div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg">
                <span class="text-gray-700">${item}</span>
                <button class="text-red-600 hover:text-red-700" data-del="${listType}" data-idx="${idx}">${icons.trash}</button>
              </div>
            `).join('')}
          </div>
        </div>
      </div>
    `;
  }

  function renderHistoryTab() {
    return `<div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
      <h2 class="text-xl font-bold text-gray-900 mb-4">Historique m√©dical</h2>
      <p class="text-gray-600">Aucune consultation enregistr√©e.</p>
      <div class="mt-4 p-4 bg-blue-50 rounded-lg">
        <p class="text-blue-700">Derni√®re mise √† jour: ${new Date(medicalData.emergencyInfo.lastUpdate).toLocaleString('fr-FR')}</p>
      </div>
    </div>`;
  }

  function renderBraceletTab() {
    return `
      <div class="space-y-6">
        <h2 class="text-2xl font-bold text-gray-900">Bracelet SYL d'Urgence</h2>
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
          <div class="text-center">
            <div class="mx-auto w-24 h-24 bg-gradient-to-r from-red-600 to-orange-600 rounded-full flex items-center justify-center mb-4">${icons.smartphone}</div>
            <h3 class="text-xl font-semibold text-gray-900 mb-2">Bracelet d'urgence m√©dicale</h3>
            <p class="text-gray-600 mb-6">${medicalData.isActive ? 'Votre bracelet est actif et accessible aux secours' : 'Activez votre bracelet pour l\'acc√®s d\'urgence'}</p>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
              <div class="bg-red-50 p-4 rounded-lg">${icons.emergency}<p class="text-sm font-medium text-red-700">Acc√®s Urgence 24h/24</p></div>
              <div class="bg-blue-50 p-4 rounded-lg">${icons.shield}<p class="text-sm font-medium text-blue-700">NFC S√©curis√©</p></div>
              <div class="bg-green-50 p-4 rounded-lg">${icons.clock}<p class="text-sm font-medium text-green-700">Sync Temps R√©el</p></div>
            </div>

            <div class="mb-6 p-4 bg-yellow-50 rounded-lg">
              <h4 class="font-bold text-yellow-800 mb-2">üö® Code d'acc√®s d'urgence</h4>
              <p class="text-2xl font-mono font-bold text-yellow-900">${medicalData.braceletId || 'SYL-' + Math.random().toString(36).substr(2,6).toUpperCase()}</p>
              <p class="text-sm text-yellow-700 mt-1">√Ä communiquer aux secours pour acc√®s imm√©diat</p>
            </div>

            <button class="${medicalData.isActive ? 'bg-gray-200 text-gray-600' : 'bg-red-600 text-white hover:bg-red-700'} rounded-lg px-6 py-3 font-bold" id="activateBracelet">
              ${medicalData.isActive ? 'Bracelet d\'Urgence Activ√©' : 'Activer le Bracelet d\'Urgence'}
            </button>
          </div>
        </div>
      </div>
    `;
  }

  function renderRemindersTab() {
    const reminders = JSON.parse(localStorage.getItem('syl-reminders') || '[]');
    return `
      <div class="space-y-6">
        <div class="flex justify-between items-center">
          <h2 class="text-2xl font-bold text-gray-900">Rappels M√©dicaux</h2>
          <button id="addReminder" class="bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg px-6 py-2 flex items-center gap-2">${icons.plus} Nouveau rappel</button>
        </div>

        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Cr√©er un rappel</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <input type="text" id="reminderTitle" placeholder="Titre du rappel" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            <select id="reminderType" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
              <option value="medication">üíä M√©dicament</option>
              <option value="appointment">üè• Rendez-vous</option>
              <option value="checkup">üîç Contr√¥le</option>
              <option value="exercise">üèÉ Exercice</option>
              <option value="other">üìù Autre</option>
            </select>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <input type="date" id="reminderDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            <input type="time" id="reminderTime" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
          </div>
          <textarea id="reminderMessage" placeholder="Message du rappel..." class="w-full px-3 py-2 border border-gray-300 rounded-lg h-20 mb-4"></textarea>
          <button id="saveReminder" class="bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg px-6 py-2">Cr√©er le rappel</button>
        </div>

        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Rappels programm√©s</h3>
          <div class="space-y-3" id="remindersList">
            ${reminders.length ? reminders.map((reminder, idx) => `
              <div class="flex items-center justify-between bg-gray-50 p-4 rounded-lg ${reminder.notified ? 'opacity-50' : ''}">
                <div>
                  <h4 class="font-medium text-gray-900">${reminder.title}</h4>
                  <p class="text-sm text-gray-600">${reminder.message}</p>
                  <p class="text-sm text-blue-600">${new Date(reminder.dateTime).toLocaleString('fr-FR')}</p>
                </div>
                <div class="flex gap-2">
                  ${reminder.notified ? '<span class="text-green-600">‚úì Notifi√©</span>' : '<span class="text-orange-600">‚è∞ En attente</span>'}
                  <button class="text-red-600 hover:text-red-700" onclick="deleteReminder(${idx})">${icons.trash}</button>
                </div>
              </div>
            `).join('') : '<p class="text-gray-500 text-center py-8">Aucun rappel programm√©</p>'}
          </div>
        </div>
      </div>
    `;
  }

  function tabEmergencyEvents() {
    // Nouvelles fonctionnalit√©s d'urgence
    document.getElementById('generateQR')?.addEventListener('click', () => {
      const qrUrl = SYLUtilities.generateEmergencyQR(medicalData);
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-md mx-4">
          <h3 class="text-lg font-bold mb-4">QR Code d'Urgence</h3>
          <img src="${qrUrl}" alt="QR Code" class="w-full max-w-xs mx-auto mb-4" />
          <p class="text-sm text-gray-600 mb-4">Scannez ce code pour acc√©der rapidement aux informations d'urgence</p>
          <div class="flex gap-2">
            <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white rounded px-4 py-2">Fermer</button>
            <a href="${qrUrl}" download="qr-urgence.png" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white rounded px-4 py-2 text-center">T√©l√©charger</a>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    });

    document.getElementById('getLocation')?.addEventListener('click', async () => {
      try {
        const location = await SYLUtilities.getEmergencyLocation();
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
          <div class="bg-white rounded-lg p-6 max-w-md mx-4">
            <h3 class="text-lg font-bold mb-4">üìç Localisation d'Urgence</h3>
            <p class="mb-2"><strong>Latitude:</strong> ${location.latitude.toFixed(6)}</p>
            <p class="mb-2"><strong>Longitude:</strong> ${location.longitude.toFixed(6)}</p>
            <p class="mb-2"><strong>Pr√©cision:</strong> ¬±${Math.round(location.accuracy)}m</p>
            <p class="text-sm text-gray-600 mb-4">Coordonn√©es GPS √† communiquer aux secours</p>
            <div class="flex gap-2">
              <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white rounded px-4 py-2">Fermer</button>
              <button onclick="navigator.clipboard.writeText('${location.latitude}, ${location.longitude}'); alert('Coordonn√©es copi√©es !')" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white rounded px-4 py-2">Copier</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      } catch (error) {
        alert('‚ùå Impossible d\'obtenir la localisation: ' + error);
      }
    });

    document.getElementById('exportPDF')?.addEventListener('click', () => {
      SYLUtilities.generatePDF(medicalData);
      SYLUtilities.showNotification('Fiche d\'urgence g√©n√©r√©e', {
        body: 'Votre fiche m√©dicale d\'urgence a √©t√© t√©l√©charg√©e'
      });
    });

    document.getElementById('emergencyCall')?.addEventListener('click', () => {
      if (confirm('Composer le 15 (SAMU) ?')) {
        window.open('tel:15');
      }
    });

    document.getElementById('saveEmergency').onclick = async () => {
      medicalData.emergencyInfo.primaryPhysician.name = document.getElementById('physicianName').value;
      medicalData.emergencyInfo.primaryPhysician.specialty = document.getElementById('physicianSpecialty').value;
      medicalData.emergencyInfo.primaryPhysician.phone = document.getElementById('physicianPhone').value;
      medicalData.emergencyInfo.criticalNotes = document.getElementById('criticalNotes').value;
      medicalData.emergencyInfo.lastUpdate = new Date().toISOString();
      localStorage.setItem('syl-medicalData', JSON.stringify(medicalData));
      
      // Synchronisation Firebase avec UID utilisateur comme ID
      if (user.uid) {
        try {
          const patientData = { ...medicalData, uid: user.uid, email: user.email };
          await savePatientToFirestore(patientData);
          SYLUtilities.showNotification('Donn√©es sauvegard√©es', {
            body: 'Vos informations d\'urgence ont √©t√© mises √† jour'
          });
          alert('‚úÖ Donn√©es d\'urgence sauvegard√©es et synchronis√©es avec Firebase !');
        } catch (error) {
          console.error('Erreur sync Firebase:', error);
          alert('‚ö†Ô∏è Donn√©es sauvegard√©es localement. Synchronisation Firebase √©chou√©e.');
        }
      } else {
        alert('‚úÖ Donn√©es d\'urgence sauvegard√©es !');
      }
      render();
    };
  }

  function tabProfileEvents() {
    document.getElementById('saveProfile').onclick = async () => {
      medicalData.personalInfo.firstName = document.getElementById('pfFirstName').value;
      medicalData.personalInfo.lastName = document.getElementById('pfLastName').value;
      medicalData.personalInfo.dateOfBirth = document.getElementById('pfBirth').value;
      medicalData.personalInfo.bloodType = document.getElementById('pfBlood').value;
      medicalData.personalInfo.height = document.getElementById('pfHeight').value;
      medicalData.personalInfo.weight = document.getElementById('pfWeight').value;
      medicalData.personalInfo.socialSecurityNumber = document.getElementById('pfSSN').value;
      medicalData.personalInfo.insuranceNumber = document.getElementById('pfInsurance').value;
      medicalData.personalInfo.address = document.getElementById('pfAddress').value;
      medicalData.personalInfo.city = document.getElementById('pfCity').value;
      medicalData.personalInfo.postalCode = document.getElementById('pfPostal').value;
      medicalData.personalInfo.preferredHospital = document.getElementById('pfHospital').value;
      medicalData.personalInfo.emergencyContact.name = document.getElementById('pfContact1Name').value;
      medicalData.personalInfo.emergencyContact.relation = document.getElementById('pfContact1Rel').value;
      medicalData.personalInfo.emergencyContact.phone = document.getElementById('pfContact1Phone').value;
      medicalData.personalInfo.secondaryContact.name = document.getElementById('pfContact2Name').value;
      medicalData.personalInfo.secondaryContact.relation = document.getElementById('pfContact2Rel').value;
      medicalData.personalInfo.secondaryContact.phone = document.getElementById('pfContact2Phone').value;
      medicalData.personalInfo.organDonor = document.getElementById('pfOrganDonor').checked;
      medicalData.personalInfo.advanceDirectives = document.getElementById('pfDirectives').checked;
      localStorage.setItem('syl-medicalData', JSON.stringify(medicalData));
      
      // Synchronisation Firebase avec UID utilisateur comme ID
      if (user.uid) {
        try {
          const patientData = { ...medicalData, uid: user.uid, email: user.email };
          await savePatientToFirestore(patientData);
          alert('‚úÖ Profil sauvegard√© et synchronis√© avec Firebase !');
        } catch (error) {
          console.error('Erreur sync Firebase:', error);
          alert('‚ö†Ô∏è Profil sauvegard√© localement. Synchronisation Firebase √©chou√©e.');
        }
      } else {
        alert('‚úÖ Profil sauvegard√© !');
      }
      render();
    };
  }

  function tabMedicalEvents() {
    const listTypes = ['allergies', 'medications', 'chronicDiseases', 'medicalDevices', 'surgeries', 'emergencyMedications', 'contraindications', 'riskFactors'];
    listTypes.forEach(type => {
      const btnEl = document.getElementById(`btn_${type}`);
      if (btnEl) {
        btnEl.onclick = async () => {
          const v = document.getElementById(`add_${type}`).value.trim();
          if (v) {
            if (medicalData.medicalHistory[type]) {
              medicalData.medicalHistory[type].push(v);
            } else if (medicalData.emergencyInfo[type]) {
              medicalData.emergencyInfo[type].push(v);
            }
            localStorage.setItem('syl-medicalData', JSON.stringify(medicalData));
            
            // Synchronisation Firebase avec UID utilisateur comme ID
            if (user.uid) {
              try {
                const patientData = { ...medicalData, uid: user.uid, email: user.email };
                await savePatientToFirestore(patientData);
              } catch (error) {
                console.error('Erreur sync Firebase:', error);
              }
            }
            render();
          }
        };
      }
      document.querySelectorAll(`[data-del="${type}"]`).forEach(btn => btn.onclick = async () => {
        const idx = parseInt(btn.getAttribute('data-idx'));
        if (medicalData.medicalHistory[type]) {
          medicalData.medicalHistory[type].splice(idx, 1);
        } else if (medicalData.emergencyInfo[type]) {
          medicalData.emergencyInfo[type].splice(idx, 1);
        }
        localStorage.setItem('syl-medicalData', JSON.stringify(medicalData));
        
        // Synchronisation Firebase avec UID utilisateur comme ID
        if (user.uid) {
          try {
            const patientData = { ...medicalData, uid: user.uid, email: user.email };
            await savePatientToFirestore(patientData);
          } catch (error) {
            console.error('Erreur sync Firebase:', error);
          }
        }
        render();
      });
    });
  }

  function tabBraceletEvents() {
    document.getElementById('activateBracelet').onclick = async () => {
      medicalData.isActive = true;
      if (!medicalData.braceletId) {
        medicalData.braceletId = 'SYL-' + Math.random().toString(36).substr(2,6).toUpperCase();
      }
      localStorage.setItem('syl-medicalData', JSON.stringify(medicalData));
      
      // Synchronisation Firebase avec UID utilisateur comme ID
      if (user.uid) {
        try {
          const patientData = { ...medicalData, uid: user.uid, email: user.email };
          await savePatientToFirestore(patientData);
          alert('‚úÖ Bracelet d\'urgence activ√© et synchronis√© avec Firebase !');
        } catch (error) {
          console.error('Erreur sync Firebase:', error);
          alert('‚ö†Ô∏è Bracelet activ√© localement. Synchronisation Firebase √©chou√©e.');
        }
      } else {
        alert('‚úÖ Bracelet d\'urgence activ√© !');
      }
      render();
    };
  }

  function tabRemindersEvents() {
    document.getElementById('saveReminder')?.addEventListener('click', () => {
      const title = document.getElementById('reminderTitle').value;
      const type = document.getElementById('reminderType').value;
      const date = document.getElementById('reminderDate').value;
      const time = document.getElementById('reminderTime').value;
      const message = document.getElementById('reminderMessage').value;
      
      if (!title || !date || !time) {
        alert('Veuillez remplir tous les champs obligatoires');
        return;
      }
      
      const dateTime = new Date(`${date}T${time}`);
      const finalMessage = message || `Rappel: ${title}`;
      
      ReminderSystem.addReminder(title, finalMessage, dateTime.toISOString());
      
      // Reset form
      document.getElementById('reminderTitle').value = '';
      document.getElementById('reminderMessage').value = '';
      
      SYLUtilities.showNotification('Rappel cr√©√©', {
        body: `Rappel programm√© pour le ${dateTime.toLocaleString('fr-FR')}`
      });
      
      render();
    });
  }
}

// Fonctions globales pour les rappels
function deleteReminder(index) {
  if (confirm('Supprimer ce rappel ?')) {
    const reminders = JSON.parse(localStorage.getItem('syl-reminders') || '[]');
    reminders.splice(index, 1);
    localStorage.setItem('syl-reminders', JSON.stringify(reminders));
    
    // Re-render si on est sur la page des rappels
    const activeTabEl = document.querySelector('[data-tab].bg-blue-100');
    if (activeTabEl && activeTabEl.getAttribute('data-tab') === 'reminders') {
      // Recharger la section des rappels
      location.reload();
    }
  }
}

// Fonction utilitaire pour sauvegarder les patients avec timestamp
function savePatientsWithTimestamp(patients) {
  const dataWithTimestamp = {
    patients: patients,
    lastUpdate: Date.now(),
    source: 'firebase'
  };
  localStorage.setItem('syl-patients-data', JSON.stringify(dataWithTimestamp));
  // Maintenir aussi l'ancien format pour compatibilit√©
  localStorage.setItem('syl-patients', JSON.stringify(patients));
  console.log('üíæ Patients sauvegard√©s avec timestamp:', new Date(dataWithTimestamp.lastUpdate).toLocaleString());
}

// Fonction utilitaire pour charger les patients avec v√©rification de fra√Æcheur
function loadPatientsWithTimestamp() {
  try {
    const dataStr = localStorage.getItem('syl-patients-data');
    if (dataStr) {
      const data = JSON.parse(dataStr);
      const age = Date.now() - data.lastUpdate;
      const ageHours = age / (1000 * 60 * 60);
      
      console.log('üìä Donn√©es locales:', {
        patients: data.patients?.length || 0,
        age: ageHours.toFixed(1) + 'h',
        source: data.source
      });
      
      // Sur mobile, alerter si les donn√©es sont anciennes (plus de 1 heure)
      const isMobile = window.innerWidth <= 768;
      if (isMobile && ageHours > 1) {
        console.warn('‚ö†Ô∏è Donn√©es potentiellement obsol√®tes sur mobile');
        return {
          patients: data.patients || [],
          isStale: true,
          age: ageHours
        };
      }
      
      return {
        patients: data.patients || [],
        isStale: false,
        age: ageHours
      };
    }
  } catch (e) {
    console.log('Utilisation du format ancien');
  }
  
  // Fallback vers l'ancien format
  const patients = JSON.parse(localStorage.getItem('syl-patients') || '[]');
  return {
    patients,
    isStale: true,
    age: -1
  };
}

// Fonction globale pour charger les patients depuis Firebase
async function loadPatientsFromFirebase() {
  try {
    if (!db || typeof db.collection !== 'function') {
      throw new Error('Firebase non initialis√© correctement');
    }

    // V√©rifier l'authentification (admin local OU Firebase)
    const currentUser = firebase.auth().currentUser;
    const localUser = getUser();
    
    // Accepter les admins locaux m√™me s'ils ne sont pas connect√©s √† Firebase
    if (!currentUser && (!localUser || localUser.role !== 'admin')) {
      throw new Error('Vous devez √™tre connect√© pour acc√©der aux donn√©es Firebase');
    }
    
    if (localUser && localUser.role === 'admin') {
      console.log('üîë Admin local d√©tect√©, acc√®s Firebase autoris√©:', localUser.email);
    } else if (currentUser) {
      console.log('Utilisateur Firebase connect√©:', currentUser.email);
      console.log('UID:', currentUser.uid);
    }
    console.log('Tentative de chargement des patients depuis Firebase...');
    
    // Essayer diff√©rentes approches selon les permissions
    let firebaseUsers = [];
    let permissionTestPassed = false;
    
    // Test 1: Essayer de lire sa propre donn√©e utilisateur
    try {
      const userDoc = await db.collection('users').doc(currentUser.uid).get();
      console.log('‚úÖ Lecture du profil utilisateur r√©ussie');
      permissionTestPassed = true;
      
      const userData = userDoc.data();
      if (userData && (userData.role === 'admin' || userData.role === 'Admin')) {
        console.log('‚úÖ Utilisateur admin d√©tect√©');
      } else {
        console.log('‚ö†Ô∏è Utilisateur non-admin:', userData?.role);
      }
    } catch (userError) {
      console.error('‚ùå Impossible de lire le profil utilisateur:', userError);
    }
    
    // Test 2: Essayer de lire tous les utilisateurs (pour admin)
    if (permissionTestPassed) {
      try {
        const usersSnapshot = await db.collection('users').limit(3).get();
        console.log('‚úÖ Test lecture collection users r√©ussi, documents:', usersSnapshot.size);
      } catch (readError) {
        console.error('‚ùå Lecture collection users refus√©e:', readError.code);
        
        // Afficher un guide d√©taill√© pour r√©soudre le probl√®me
        const errorModal = document.createElement('div');
        errorModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        errorModal.innerHTML = `
          <div class="bg-white rounded-lg p-6 max-w-2xl mx-4 max-h-96 overflow-y-auto">
            <h3 class="text-lg font-bold text-red-600 mb-4">üîí Probl√®me de Permissions Firebase</h3>
            <div class="space-y-4 text-sm">
              <div class="bg-yellow-50 border border-yellow-200 rounded p-3">
                <p><strong>Utilisateur connect√©:</strong> ${currentUser.email}</p>
                <p><strong>UID:</strong> ${currentUser.uid}</p>
              </div>
              
              <div class="bg-blue-50 border border-blue-200 rounded p-3">
                <h4 class="font-bold text-blue-800 mb-2">üìã Solutions rapides:</h4>
                <ol class="space-y-1 text-blue-700">
                  <li><strong>1. R√®gles temporaires (d√©veloppement):</strong></li>
                  <li class="ml-4 font-mono text-xs bg-gray-100 p-2 rounded">allow read, write: if request.auth != null;</li>
                  <li><strong>2. Ajoutez votre UID comme admin dans Firestore</strong></li>
                  <li><strong>3. V√©rifiez que le document users/${currentUser.uid} existe</strong></li>
                </ol>
              </div>
              
              <div class="bg-green-50 border border-green-200 rounded p-3">
                <h4 class="font-bold text-green-800 mb-2">üîß R√®gles Firestore recommand√©es:</h4>
                <pre class="text-xs bg-gray-100 p-2 rounded overflow-x-auto">rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      allow read: if request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    match /patients/{patientId} {
      allow read, write: if request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'medecin'];
    }
  }
}</pre>
              </div>
            </div>
            <button onclick="this.closest('.fixed').remove()" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white rounded px-4 py-2">Fermer</button>
          </div>
        `;
        document.body.appendChild(errorModal);
        
        throw new Error('Permissions insuffisantes pour lire la collection users');
      }
    }
    
    // Charger les utilisateurs patients
    const usersSnapshot = await db.collection('users').where('role', '==', 'patient').get();
    
    usersSnapshot.forEach(doc => {
      const userData = doc.data();
      firebaseUsers.push({
        id: doc.id,
        uid: userData.uid || doc.id,
        email: userData.email,
        role: userData.role,
        ...userData
      });
    });
    
    console.log('Utilisateurs patients trouv√©s:', firebaseUsers.length);
    
    if (firebaseUsers.length === 0) {
      alert('‚ÑπÔ∏è Aucun patient trouv√© dans Firebase.\n\nAssurez-vous que:\n- Des utilisateurs avec role="patient" existent\n- Vos r√®gles Firestore permettent la lecture\n- Vous √™tes connect√© avec les bonnes permissions');
      return false;
    }
    
    // R√©cup√©rer les donn√©es m√©dicales
    const patientsSnapshot = await db.collection('patients').get();
    const medicalDataMap = {};
    
    patientsSnapshot.forEach(doc => {
      const data = doc.data();
      const userId = doc.id.replace('_medical', '');
      medicalDataMap[userId] = data;
    });
    
    console.log('Donn√©es m√©dicales trouv√©es:', Object.keys(medicalDataMap).length);
    
    // Fusionner les donn√©es
    const completePatients = firebaseUsers.map(user => {
      const medicalData = medicalDataMap[user.uid] || {};
      return {
        ...user,
        personalInfo: medicalData.personalInfo || {
          firstName: user.profile?.firstName || user.displayName?.split(' ')[0] || 'Pr√©nom',
          lastName: user.profile?.lastName || user.displayName?.split(' ').slice(1).join(' ') || 'Nom',
          bloodType: 'N/A'
        },
        medicalHistory: medicalData.medicalHistory || {
          allergies: [],
          medications: [],
          chronicDiseases: []
        },
        emergencyInfo: medicalData.emergencyInfo || {
          criticalNotes: ''
        },
        isActive: medicalData.isActive !== undefined ? medicalData.isActive : true,
        nfcTagId: medicalData.nfcTagId || null,
        createdAt: user.createdAt || new Date().toISOString()
      };
    });
    
    // Supprimer les anciennes donn√©es de test
    localStorage.removeItem('syl-patients');
    localStorage.removeItem('syl-nfc-tags');
    
    // Sauvegarder avec timestamp
    savePatientsWithTimestamp(completePatients);
    
    console.log(`‚úÖ ${completePatients.length} patients charg√©s depuis Firebase`);
    alert(`‚úÖ ${completePatients.length} patients charg√©s depuis Firebase !\n\nDonn√©es de test supprim√©es.`);
    location.reload();
    return true;
    
  } catch (error) {
    console.error('Erreur chargement Firebase:', error);
    
    let errorMessage = 'Erreur Firebase: ';
    if (error.code === 'permission-denied') {
      errorMessage += 'Permissions insuffisantes.\n\nSolutions possibles:\n1. V√©rifiez vos r√®gles Firestore\n2. Assurez-vous d\'√™tre connect√©\n3. Contactez l\'administrateur';
    } else if (error.code === 'unavailable') {
      errorMessage += 'Service Firebase indisponible.\nV√©rifiez votre connexion internet.';
    } else {
      errorMessage += error.message;
    }
    
    alert('‚ùå ' + errorMessage);
    return false;
  }
}

// ----------- ADMIN DASHBOARD (VERSION FIRESTORE TEMPS R√âEL) -----------
async function renderAdminDashboard(user) {
  let patients = [];
  let nfcTags = [];
  let activeTab = 'patients';
  
  console.log("üî• Dashboard Admin - Mode Firestore temps r√©el");
  
  // Lancer le debug silencieux pour l'admin
  setTimeout(() => silentDebugCheck(), 3000);
  
  // Initialiser la synchronisation temps r√©el
  await initRealtimeSync();
  
  // Charger les donn√©es initiales depuis Firestore
  try {
    patients = await loadPatientsFromFirestore();
    
    // Migration automatique : v√©rifier s'il y a des utilisateurs patients non migr√©s
    if (patients.length === 0) {
      console.log("üîÑ Aucun patient trouv√©, v√©rification des utilisateurs √† migrer...");
      await autoMigrateUsersToPatients();
      // Recharger apr√®s migration
      patients = await loadPatientsFromFirestore();
    }
    
    // Charger les tags NFC depuis Firestore
    const nfcSnapshot = await db.collection('nfcTags').get();
    nfcTags = [];
    nfcSnapshot.forEach(doc => {
      nfcTags.push({
        id: doc.id,
        ...doc.data()
      });
    });
    
  } catch (error) {
    console.error("‚ùå Erreur chargement donn√©es admin:", error);
    patients = [];
    nfcTags = [];
  }
  
  // √âcouter les mises √† jour temps r√©el
  window.addEventListener('patientsUpdated', (event) => {
    patients = event.detail;
    console.log("üîÑ Patients mis √† jour en temps r√©el:", patients.length);
    render(); // Re-render l'interface
  });
  
  render();

  function render() {
    document.getElementById('app').innerHTML = `
    <div class="min-h-screen bg-gray-50">
      <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center h-16">
          <div class="flex items-center">
            ${icons.settings}<h1 class="text-xl font-bold text-gray-900 ml-3">SYL Admin</h1>
          </div>
          <div class="flex items-center space-x-4">
            <div class="flex items-center space-x-2">
              <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
              <span class="text-sm text-green-600 font-medium">Temps r√©el</span>
            </div>
            <div class="text-sm text-gray-600">Admin: ${user.profile.firstName}</div>
            <button id="logoutBtn" class="border-2 border-purple-600 text-purple-600 hover:bg-purple-50 font-medium rounded-lg px-4 py-2 flex items-center gap-2">${icons.logout} D√©connexion</button>
          </div>
        </div>
      </header>
      
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
        <div class="lg:col-span-1">
          <nav class="space-y-2">
            <button class="w-full flex items-center px-4 py-3 text-left rounded-lg transition-colors ${activeTab==='patients' ? 'bg-purple-100 text-purple-700 border-l-4 border-purple-600':'text-gray-600 hover:bg-gray-100'}" data-tab="patients">${icons.users} <span class="ml-3">Patients</span></button>
            <button class="w-full flex items-center px-4 py-3 text-left rounded-lg transition-colors ${activeTab==='nfc' ? 'bg-purple-100 text-purple-700 border-l-4 border-purple-600':'text-gray-600 hover:bg-gray-100'}" data-tab="nfc">${icons.smartphone} <span class="ml-3">Tags NFC</span></button>
            <button class="w-full flex items-center px-4 py-3 text-left rounded-lg transition-colors ${activeTab==='associations' ? 'bg-purple-100 text-purple-700 border-l-4 border-purple-600':'text-gray-600 hover:bg-gray-100'}" data-tab="associations">${icons.shield} <span class="ml-3">Associations</span></button>
            <button class="w-full flex items-center px-4 py-3 text-left rounded-lg transition-colors ${activeTab==='analytics' ? 'bg-purple-100 text-purple-700 border-l-4 border-purple-600':'text-gray-600 hover:bg-gray-100'}" data-tab="analytics">${icons.activity} <span class="ml-3">Analytics</span></button>
            <button class="w-full flex items-center px-4 py-3 text-left rounded-lg transition-colors ${activeTab==='debug' ? 'bg-purple-100 text-purple-700 border-l-4 border-purple-600':'text-gray-600 hover:bg-gray-100'}" data-tab="debug">üîß <span class="ml-3">Debug & Maintenance</span></button>
          </nav>
        </div>          <div class="lg:col-span-3">
            ${activeTab === 'patients' ? renderPatientsTab() : ''}
            ${activeTab === 'nfc' ? renderNFCTab() : ''}
            ${activeTab === 'associations' ? renderAssociationsTab() : ''}
            ${activeTab === 'analytics' ? renderAnalyticsTab() : ''}
            ${activeTab === 'debug' ? renderDebugTab() : ''}
          </div>
        </div>
      </div>
    </div>
    `;
    
    document.getElementById('logoutBtn').onclick = () => { logout(); };
    document.querySelectorAll('[data-tab]').forEach(btn => btn.onclick = () => { 
      activeTab = btn.getAttribute('data-tab'); 
      render(); 
    });
    
    if (activeTab === 'patients') setupPatientsEvents();
    if (activeTab === 'nfc') setupNFCEvents();
    if (activeTab === 'associations') setupAssociationsEvents();
    if (activeTab === 'debug') setupDebugEvents();
  }

  function renderPatientsTab() {
    return `
      <div class="space-y-6">
        <div class="flex justify-between items-center">
          <h2 class="text-2xl font-bold text-gray-900">Gestion des Patients</h2>
          <div class="flex gap-2">
            <button onclick="deleteAllPatients()" class="bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg px-4 py-2 flex items-center gap-2" title="Supprimer tous les patients">${icons.trash} Supprimer Tout</button>
            <button id="refreshPatients" class="bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg px-4 py-2 flex items-center gap-2">${icons.activity} Actualiser</button>
            ${window.innerWidth <= 768 ? '<button id="forceMobileSyncBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-lg px-4 py-2 flex items-center gap-2" title="Synchronisation forc√©e mobile">üì± Sync Mobile</button>' : ''}
          </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Recherche de patient</h3>
          <div class="flex gap-4 mb-4">
            <input type="text" id="searchPatient" placeholder="Rechercher par nom, email, ID..." class="flex-1 px-3 py-2 border border-gray-300 rounded-lg">
            <button id="searchBtn" class="bg-blue-600 hover:bg-blue-700 text-white rounded-lg px-4 py-2">${icons.search}</button>
          </div>
        </div>

        <!-- Section d'aide pour les suppressions -->
        <div class="bg-amber-50 border border-amber-200 rounded-xl p-4">
          <div class="flex items-center mb-2">
            <div class="text-amber-600 mr-2">${icons.warning}</div>
            <h4 class="font-semibold text-blue-800">Gestion Administrative Simplifi√©e</h4>
          </div>
          <div class="text-sm text-amber-700 space-y-1">
            <p><strong>üóëÔ∏è Suppression individuelle :</strong> Cliquez sur l'ic√¥ne rouge dans la colonne "Actions" de chaque patient</p>
            <p><strong>üö® Suppression massive :</strong> Bouton "SUPPR. TOUT" - ATTENTION: Irr√©versible !</p>
            <p><strong>ÔøΩ Auth Debug :</strong> Diagnostic des probl√®mes "email d√©j√† utilis√©" apr√®s suppression</p>
            <p><strong>ÔøΩüîí S√©curit√© :</strong> Double confirmation + suppression Firebase automatique</p>
            <p><strong>ÔøΩ Astuce :</strong> Si inscription impossible, utilisez "Auth Debug" pour diagnostiquer</p>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Liste des Patients (${patients.length})</h3>
          ${patients.length === 0 ? `
            <div class="text-center py-8">
              <div class="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center mx-auto mb-4">
                ${icons.users}
              </div>
              <h4 class="text-lg font-medium text-gray-900 mb-2">Aucun patient trouv√©</h4>
              <p class="text-gray-600 mb-4">Cliquez sur "Charger Firebase" pour r√©cup√©rer les patients depuis votre base de donn√©es.</p>
              <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-left">
                <h5 class="font-medium text-blue-900 mb-2">Pour r√©soudre l'erreur de permissions :</h5>
                <ol class="text-sm text-blue-800 space-y-1">
                  <li>1. V√©rifiez que vous √™tes connect√© avec un compte admin</li>
                  <li>2. Configurez les r√®gles Firestore pour permettre la lecture</li>
                  <li>3. Assurez-vous que des utilisateurs avec role="patient" existent</li>
                </ol>
              </div>
            </div>
          ` : `
          <div class="overflow-x-auto">
            <table class="w-full table-auto">
              <thead>
                <tr class="border-b border-gray-200">
                  <th class="text-left py-3 px-4">Patient</th>
                  <th class="text-left py-3 px-4">Email</th>
                  <th class="text-left py-3 px-4">Groupe Sang.</th>
                  <th class="text-left py-3 px-4">Tag NFC</th>
                  <th class="text-left py-3 px-4">Statut</th>
                  <th class="text-left py-3 px-4">Actions</th>
                </tr>
              </thead>
              <tbody id="patientsTable">
                ${patients.map(patient => `
                  <tr class="border-b border-gray-100 hover:bg-gray-50">
                    <td class="py-3 px-4">
                      <div>
                        <div class="font-medium">${patient.personalInfo?.firstName || 'N/A'} ${patient.personalInfo?.lastName || 'N/A'}</div>
                        <div class="text-sm text-gray-500">ID: ${patient.id || patient.uid || 'N/A'}</div>
                      </div>
                    </td>
                    <td class="py-3 px-4">${patient.email || 'N/A'}</td>
                    <td class="py-3 px-4">
                      <span class="bg-red-100 text-red-800 px-2 py-1 rounded text-sm">${patient.personalInfo?.bloodType || 'N/A'}</span>
                    </td>
                    <td class="py-3 px-4">
                      ${patient.nfcTagId ? `<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm">${patient.nfcTagId}</span>` : '<span class="text-gray-500">Non assign√©</span>'}
                    </td>
                    <td class="py-3 px-4">
                      ${patient.isActive ? '<span class="bg-green-100 text-green-800 px-2 py-1 rounded text-sm">Actif</span>' : '<span class="bg-gray-100 text-gray-800 px-2 py-1 rounded text-sm">Inactif</span>'}
                    </td>
                    <td class="py-3 px-4">
                      <div class="flex gap-2">
                        <button onclick="viewPatient('${patient.id || patient.uid}')" class="text-blue-600 hover:text-blue-700" title="Voir le patient">${icons.eye}</button>
                        <button onclick="assignNFC('${patient.id || patient.uid}')" class="text-green-600 hover:text-green-700" title="Assigner NFC">${icons.smartphone}</button>
                        <button onclick="deletePatient('${patient.id || patient.uid}', '${patient.personalInfo?.firstName || ''} ${patient.personalInfo?.lastName || ''}')" class="text-red-600 hover:text-red-700" title="Supprimer le patient">${icons.trash}</button>
                      </div>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
          `}
        </div>
      </div>
    `;
  }

  function renderNFCTab() {
    return `
      <div class="space-y-6">
        <div class="flex justify-between items-center">
          <h2 class="text-2xl font-bold text-gray-900">Gestion des Tags NFC</h2>
          <button id="addNFCTag" class="bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-lg px-6 py-2 flex items-center gap-2">${icons.plus} Nouveau Tag</button>
        </div>

        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">üè∑Ô∏è Enregistrer un Tag NFC</h3>
          
          <!-- √âtapes visuelles -->
          <div class="mb-6">
            <div class="flex items-center justify-between mb-4">
              <div class="flex-1">
                <div class="flex items-center">
                  <div class="w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center font-semibold">1</div>
                  <div class="ml-3">
                    <div class="text-sm font-medium text-gray-900">Scanner ou entrer l'ID</div>
                    <div class="text-xs text-gray-500">Utilisez le bouton Scanner ou entrez manuellement</div>
                  </div>
                </div>
              </div>
              <div class="flex-1 border-t-2 border-gray-300 mx-4"></div>
              <div class="flex-1">
                <div class="flex items-center">
                  <div class="w-8 h-8 bg-gray-300 text-white rounded-full flex items-center justify-center font-semibold">2</div>
                  <div class="ml-3">
                    <div class="text-sm font-medium text-gray-900">Ajouter description</div>
                    <div class="text-xs text-gray-500">Optionnel mais recommand√©</div>
                  </div>
                </div>
              </div>
              <div class="flex-1 border-t-2 border-gray-300 mx-4"></div>
              <div class="flex-1">
                <div class="flex items-center">
                  <div class="w-8 h-8 bg-gray-300 text-white rounded-full flex items-center justify-center font-semibold">3</div>
                  <div class="ml-3">
                    <div class="text-sm font-medium text-gray-900">Enregistrer</div>
                    <div class="text-xs text-gray-500">Sauvegarder dans le syst√®me</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">ID du Tag NFC *</label>
              <div class="flex gap-2">
                <input type="text" id="nfcTagId" placeholder="Ex: NFC-001, ABC123..." class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <button id="scanNFC" class="bg-blue-600 hover:bg-blue-700 text-white rounded-lg px-4 py-2 flex items-center gap-2 whitespace-nowrap">${icons.smartphone} Scanner</button>
              </div>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Description (optionnelle)</label>
              <input type="text" id="nfcTagDescription" placeholder="Ex: Bracelet rouge, Tag porte principale..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            
            <div class="flex gap-3 pt-2">
              <button id="registerNFC" class="flex-1 bg-green-600 hover:bg-green-700 text-white rounded-lg px-6 py-3 flex items-center justify-center gap-2 font-medium">${icons.check} Enregistrer le Tag</button>
              <button id="writeNFC" class="bg-purple-600 hover:bg-purple-700 text-white rounded-lg px-4 py-3 flex items-center gap-2" title="Programmer les donn√©es d'urgence sur le tag physique">${icons.edit} Programmer</button>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Tags NFC enregistr√©s (${nfcTags.length})</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            ${nfcTags.map(tag => `
              <div class="border border-gray-200 rounded-lg p-4 ${tag.assignedTo ? 'bg-green-50 border-green-200' : 'bg-gray-50'}">
                <div class="flex justify-between items-start mb-2">
                  <div class="font-medium text-gray-900">${tag.id}</div>
                  <div class="flex gap-1">
                    <button onclick="testNFCTag('${tag.id}')" class="text-blue-600 hover:text-blue-700 text-sm" title="Tester le tag">${icons.activity}</button>
                    <button onclick="writeNFCTagData('${tag.id}')" class="text-purple-600 hover:text-purple-700 text-sm" title="Programmer le tag">${icons.edit}</button>
                    <button onclick="deleteNFCTag('${tag.id}')" class="text-red-600 hover:text-red-700 text-sm" title="Supprimer">${icons.trash}</button>
                  </div>
                </div>
                <div class="text-sm text-gray-600 mb-2">${tag.description || 'Aucune description'}</div>
                <div class="text-sm">
                  ${tag.assignedTo ? 
                    `<span class="text-green-600">Assign√© √†: ${tag.assignedTo}</span>` : 
                    '<span class="text-gray-500">Non assign√©</span>'
                  }
                </div>
                <div class="text-xs text-gray-400 mt-2">Cr√©√©: ${new Date(tag.createdAt).toLocaleDateString('fr-FR')}</div>
              </div>
            `).join('')}
          </div>
        </div>
      </div>
    `;
  }

  function renderAssociationsTab() {
    const associations = nfcTags.filter(tag => tag.assignedTo);
    return `
      <div class="space-y-6">
        <h2 class="text-2xl font-bold text-gray-900">Associations Patient-NFC</h2>
        
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Cr√©er une nouvelle association</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <select id="selectPatient" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
              <option value="">S√©lectionner un patient</option>
              ${patients.map(patient => `
                <option value="${patient.id || patient.uid}">${patient.personalInfo?.firstName} ${patient.personalInfo?.lastName} (${patient.email})</option>
              `).join('')}
            </select>
            <select id="selectNFCTag" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
              <option value="">S√©lectionner un Tag NFC</option>
              ${nfcTags.filter(tag => !tag.assignedTo).map(tag => `
                <option value="${tag.id}">${tag.id} ${tag.description ? `(${tag.description})` : ''}</option>
              `).join('')}
            </select>
            <button id="createAssociation" class="bg-purple-600 hover:bg-purple-700 text-white rounded-lg px-4 py-2">${icons.shield} Associer</button>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Associations actives (${associations.length})</h3>
          <div class="space-y-4">
            ${associations.map(tag => {
              const patient = patients.find(p => (p.id || p.uid) === tag.assignedTo);
              return `
                <div class="flex items-center justify-between bg-gradient-to-r from-purple-50 to-blue-50 p-4 rounded-lg border">
                  <div class="flex items-center space-x-4">
                    <div class="w-12 h-12 bg-purple-600 rounded-full flex items-center justify-center text-white font-bold">
                      ${icons.smartphone}
                    </div>
                    <div>
                      <div class="font-medium text-gray-900">Tag: ${tag.id}</div>
                      <div class="text-sm text-gray-600">Patient: ${patient ? `${patient.personalInfo?.firstName} ${patient.personalInfo?.lastName}` : 'Patient non trouv√©'}</div>
                      <div class="text-sm text-blue-600">Associ√© le: ${new Date(tag.assignedAt).toLocaleDateString('fr-FR')}</div>
                    </div>
                  </div>
                  <div class="flex gap-2">
                    <button onclick="testNFC('${tag.id}')" class="bg-blue-600 hover:bg-blue-700 text-white rounded px-3 py-1 text-sm">${icons.activity} Test</button>
                    <button onclick="removeAssociation('${tag.id}')" class="bg-red-600 hover:bg-red-700 text-white rounded px-3 py-1 text-sm">${icons.trash} Dissocier</button>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      </div>
    `;
  }

  function renderAnalyticsTab() {
    const analytics = JSON.parse(localStorage.getItem('syl-analytics') || '[]');
    const totalPatients = patients.length;
    const activePatients = patients.filter(p => p.isActive).length;
    const totalNFCTags = nfcTags.length;
    const assignedTags = nfcTags.filter(tag => tag.assignedTo).length;
    
    return `
      <div class="space-y-6">
        <h2 class="text-2xl font-bold text-gray-900">Tableau de bord Analytics</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
            <div class="flex items-center">
              <div class="w-12 h-12 bg-blue-600 rounded-lg flex items-center justify-center text-white">
                ${icons.users}
              </div>
              <div class="ml-4">
                <div class="text-2xl font-bold text-gray-900">${totalPatients}</div>
                <div class="text-sm text-gray-600">Total Patients</div>
              </div>
            </div>
          </div>
          
          <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
            <div class="flex items-center">
              <div class="w-12 h-12 bg-green-600 rounded-lg flex items-center justify-center text-white">
                ${icons.check}
              </div>
              <div class="ml-4">
                <div class="text-2xl font-bold text-gray-900">${activePatients}</div>
                <div class="text-sm text-gray-600">Patients Actifs</div>
              </div>
            </div>
          </div>
          
          <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
            <div class="flex items-center">
              <div class="w-12 h-12 bg-purple-600 rounded-lg flex items-center justify-center text-white">
                ${icons.smartphone}
              </div>
              <div class="ml-4">
                <div class="text-2xl font-bold text-gray-900">${totalNFCTags}</div>
                <div class="text-sm text-gray-600">Tags NFC</div>
              </div>
            </div>
          </div>
          
          <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
            <div class="flex items-center">
              <div class="w-12 h-12 bg-orange-600 rounded-lg flex items-center justify-center text-white">
                ${icons.shield}
              </div>
              <div class="ml-4">
                <div class="text-2xl font-bold text-gray-900">${assignedTags}</div>
                <div class="text-sm text-gray-600">Tags Assign√©s</div>
              </div>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">√âv√©nements r√©cents</h3>
          <div class="space-y-3">
            ${analytics.slice(-10).reverse().map(event => `
              <div class="flex items-center justify-between py-2 border-b border-gray-100">
                <div>
                  <div class="font-medium text-gray-900">${event.name}</div>
                  <div class="text-sm text-gray-600">${new Date(event.timestamp).toLocaleString('fr-FR')}</div>
                </div>
                <div class="text-sm text-gray-500">${event.sessionId}</div>
              </div>
            `).join('')}
          </div>
        </div>
      </div>
    `;
  }

  function renderDebugTab() {
    return `
      <div class="space-y-6">
        <div class="flex justify-between items-center">
          <h2 class="text-2xl font-bold text-gray-900">Debug & Maintenance</h2>
          <div class="flex gap-2">
            <button id="runQuickDiag" class="bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg px-4 py-2 flex items-center gap-2">
              üè• Diagnostic Rapide
            </button>
          </div>
        </div>

        <!-- Diagnostic System -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">üîç Analyse des Collections Firebase</h3>
          
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <button id="analyzeCollections" class="bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-lg px-4 py-3 flex items-center justify-center gap-2">
              üìä Analyser Collections
            </button>
            
            <button id="cleanupData" class="bg-orange-600 hover:bg-orange-700 text-white font-medium rounded-lg px-4 py-3 flex items-center justify-center gap-2">
              üßπ Nettoyer (Test)
            </button>
            
            <button id="migrateSchema" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-lg px-4 py-3 flex items-center justify-center gap-2">
              üöÄ Migrer Sch√©ma
            </button>
          </div>

          <div id="debugOutput" class="bg-gray-50 border border-gray-200 rounded-lg p-4 h-64 overflow-y-auto font-mono text-sm">
            <div class="text-gray-500">üîß Debug SYL Medical - Console active</div>
            <div class="text-blue-600">üìù Cliquez sur les boutons ci-dessus pour analyser vos donn√©es</div>
            <div class="text-purple-600">üìä ${patients.length} patients d√©tect√©s</div>
          </div>
        </div>

        <!-- Status Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
            <div class="flex items-center mb-4">
              <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">üî•</div>
              <div class="ml-4">
                <h4 class="text-lg font-semibold text-gray-900">Firebase</h4>
                <p class="text-sm text-gray-600">√âtat connexion</p>
              </div>
            </div>
            <div class="text-green-600 font-medium">‚úÖ Connect√©</div>
          </div>

          <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
            <div class="flex items-center mb-4">
              <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">üìä</div>
              <div class="ml-4">
                <h4 class="text-lg font-semibold text-gray-900">Collections</h4>
                <p class="text-sm text-gray-600">Documents</p>
              </div>
            </div>
            <div class="text-blue-600 font-medium">${patients.length} patients</div>
          </div>

          <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
            <div class="flex items-center mb-4">
              <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">üíæ</div>
              <div class="ml-4">
                <h4 class="text-lg font-semibold text-gray-900">Cache</h4>
                <p class="text-sm text-gray-600">Local</p>
              </div>
            </div>
            <div class="text-green-600 font-medium">‚úÖ Actif</div>
          </div>
        </div>

        <!-- Console Commands -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">üõ†Ô∏è Commandes Console Disponibles</h3>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
            <div class="bg-gray-50 rounded-lg p-3 cursor-pointer hover:bg-gray-100" onclick="window.debugFirebaseCollections?.();">
              <code class="text-purple-600 font-bold">debugFirebaseCollections()</code>
              <p class="text-gray-600 mt-1">Analyse compl√®te des collections</p>
            </div>
            
            <div class="bg-gray-50 rounded-lg p-3 cursor-pointer hover:bg-gray-100" onclick="window.cleanupFirebaseData?.();">
              <code class="text-purple-600 font-bold">cleanupFirebaseData()</code>
              <p class="text-gray-600 mt-1">Nettoie et normalise les donn√©es</p>
            </div>
            
            <div class="bg-gray-50 rounded-lg p-3 cursor-pointer hover:bg-gray-100" onclick="window.migrateToStandardSchema?.();">
              <code class="text-purple-600 font-bold">migrateToStandardSchema()</code>
              <p class="text-gray-600 mt-1">Migration vers sch√©ma standard</p>
            </div>
            
            <div class="bg-gray-50 rounded-lg p-3 cursor-pointer hover:bg-gray-100" onclick="window.quickDiagnosis?.();">
              <code class="text-purple-600 font-bold">quickDiagnosis()</code>
              <p class="text-gray-600 mt-1">Diagnostic rapide du syst√®me</p>
            </div>
          </div>
          
          <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
            <p class="text-blue-700 text-sm">üí° <strong>Astuce :</strong> Ouvrez la console d√©veloppeur (F12) pour voir les r√©sultats d√©taill√©s</p>
          </div>
        </div>
      </div>
    `;
  }

  function setupPatientsEvents() {
    document.getElementById('refreshPatients')?.addEventListener('click', async () => {
      // D√©tection mobile pour synchronisation forc√©e
      const isMobile = window.innerWidth <= 768 || /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      
      if (isMobile && confirm('üì± Mobile d√©tect√©. Faire une synchronisation forc√©e (recommand√©) ?')) {
        window.forceMobileSync();
        return;
      }
      
      // Recharger les patients depuis Firebase (mode normal)
      try {
        if (db && typeof db.collection === 'function') {
          console.log('Chargement des utilisateurs depuis Firebase...');
          
          // R√©cup√©rer tous les utilisateurs avec le r√¥le 'patient'
          const usersSnapshot = await db.collection('users').where('role', '==', 'patient').get();
          const firebaseUsers = [];
          
          usersSnapshot.forEach(doc => {
            const userData = doc.data();
            firebaseUsers.push({
              id: doc.id,
              uid: userData.uid || doc.id,
              email: userData.email,
              role: userData.role,
              ...userData
            });
          });
          
          console.log('Utilisateurs trouv√©s:', firebaseUsers.length);
          
          // R√©cup√©rer aussi les donn√©es m√©dicales associ√©es
          const patientsSnapshot = await db.collection('patients').get();
          const medicalDataMap = {};
          
          patientsSnapshot.forEach(doc => {
            const data = doc.data();
            const userId = doc.id.replace('_medical', '');
            medicalDataMap[userId] = data;
          });
          
          console.log('Donn√©es m√©dicales trouv√©es:', Object.keys(medicalDataMap).length);
          
          // Fusionner les donn√©es utilisateur et m√©dicales
          const completePatients = firebaseUsers.map(user => {
            const medicalData = medicalDataMap[user.uid] || {};
            return {
              ...user,
              personalInfo: medicalData.personalInfo || {
                firstName: user.profile?.firstName || 'Pr√©nom',
                lastName: user.profile?.lastName || 'Nom',
                bloodType: 'N/A'
              },
              medicalHistory: medicalData.medicalHistory || {
                allergies: [],
                medications: [],
                chronicDiseases: []
              },
              emergencyInfo: medicalData.emergencyInfo || {
                criticalNotes: ''
              },
              isActive: medicalData.isActive !== undefined ? medicalData.isActive : true,
              nfcTagId: medicalData.nfcTagId || null,
              createdAt: user.createdAt || new Date().toISOString()
            };
          });
          
          if (completePatients.length > 0) {
            patients = completePatients;
            localStorage.setItem('syl-patients', JSON.stringify(patients));
            render();
            alert(`‚úÖ ${patients.length} patients charg√©s depuis Firebase !`);
            return;
          } else {
            alert('‚ÑπÔ∏è Aucun patient trouv√© dans Firebase. Utilisation des donn√©es de d√©monstration.');
          }
        }
        
        // Fallback : r√©initialiser avec des donn√©es de d√©monstration
        if (confirm('Voulez-vous charger les donn√©es de d√©monstration ?')) {
          localStorage.removeItem('syl-patients');
          localStorage.removeItem('syl-nfc-tags');
          location.reload();
        }
        
      } catch (error) {
        console.error('Erreur refresh patients:', error);
        alert('‚ùå Erreur Firebase: ' + error.message + '\n\nUtilisation des donn√©es de d√©monstration.');
      }
    });

    document.getElementById('syncEmergencyData')?.addEventListener('click', async () => {
      // D'abord, v√©rifier Firebase
      if (typeof firebase === 'undefined' || !firebase.firestore) {
        alert('‚ùå Firebase n\'est pas configur√© !\n\nPour utiliser la synchronisation d\'urgence :\n1. Configurez Firebase dans votre projet\n2. Ajoutez les scripts Firebase\n3. Initialisez la connexion');
        return;
      }
      
      // V√©rifier l'authentification (admin local OU Firebase)
      const currentUser = firebase.auth().currentUser;
      const localUser = getUser();
      
      if (!currentUser && (!localUser || localUser.role !== 'admin')) {
        alert('‚ùå Vous devez √™tre connect√© pour synchroniser !\n\nConnectez-vous d\'abord avec un compte admin.');
        return;
      }
      
      if (!confirm('Synchroniser toutes les donn√©es d\'urgence vers Firebase ?\n\nCela permettra l\'acc√®s d\'urgence depuis tous les appareils.')) {
        return;
      }
      
      // Afficher un indicateur de progression
      const syncModal = document.createElement('div');
      syncModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      syncModal.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-md mx-4 text-center">
          <div class="w-16 h-16 bg-orange-600 rounded-full mx-auto flex items-center justify-center text-white text-2xl mb-4 animate-pulse">
            üîÑ
          </div>
          <h3 class="text-lg font-bold text-gray-900 mb-2">Synchronisation en cours...</h3>
          <p class="text-gray-600 mb-4">Sauvegarde des donn√©es d'urgence dans Firebase</p>
          <div class="bg-gray-200 rounded-full h-2 mb-4">
            <div id="syncProgress" class="bg-orange-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
          </div>
          <p id="syncStatus" class="text-sm text-gray-500">0 / ${patients.length} patients</p>
          <div class="mt-4 text-xs text-gray-500">
            Utilisateur: ${firebase.auth().currentUser?.email || 'Anonyme'}
          </div>
        </div>
      `;
      document.body.appendChild(syncModal);
      
      let syncCount = 0;
      let errorCount = 0;
      
      for (let i = 0; i < patients.length; i++) {
        const patient = patients[i];
        try {
          await saveEmergencyData(patient);
          syncCount++;
          console.log(`‚úÖ Patient ${patient.personalInfo?.firstName} ${patient.personalInfo?.lastName} synchronis√©`);
        } catch (error) {
          errorCount++;
          console.error('‚ùå Erreur sync patient:', patient.id, error);
        }
        
        // Mettre √† jour la progress bar
        const progress = ((i + 1) / patients.length) * 100;
        document.getElementById('syncProgress').style.width = progress + '%';
        document.getElementById('syncStatus').textContent = `${syncCount} / ${patients.length} patients synchronis√©s`;
        
        // Petit d√©lai pour √©viter de surcharger Firebase
        await new Promise(resolve => setTimeout(resolve, 200));
      }
      
      // Fermer le modal et afficher le r√©sultat
      syncModal.remove();
      
      if (errorCount === 0) {
        alert(`‚úÖ ${syncCount} patients synchronis√©s avec succ√®s !\n\nLes fiches sont maintenant accessibles depuis n'importe quel appareil.`);
      } else {
        alert(`‚ö†Ô∏è Synchronisation termin√©e :\n‚Ä¢ ${syncCount} patients synchronis√©s\n‚Ä¢ ${errorCount} erreurs\n\nV√©rifiez la console pour plus de d√©tails.`);
      }
    });

    document.getElementById('testFirebaseAccess')?.addEventListener('click', async () => {
      const testModal = document.createElement('div');
      testModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      testModal.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-2xl mx-4">
          <h3 class="text-lg font-bold text-gray-900 mb-4">üîß Test de connectivit√© Firebase</h3>
          <div id="testResults" class="space-y-3">
            <div class="flex items-center">
              <div class="animate-spin w-4 h-4 border-2 border-blue-600 border-t-transparent rounded-full mr-3"></div>
              <span>Test en cours...</span>
            </div>
          </div>
          <button onclick="this.closest('.fixed').remove()" class="mt-4 w-full bg-gray-500 hover:bg-gray-600 text-white rounded px-4 py-2">Fermer</button>
        </div>
      `;
      document.body.appendChild(testModal);
      
      const results = document.getElementById('testResults');
      results.innerHTML = '';
      
      // Test 1: Firebase disponible
      const addResult = (icon, text, isGood = true) => {
        results.innerHTML += `
          <div class="flex items-center ${isGood ? 'text-green-600' : 'text-red-600'}">
            <span class="mr-3">${icon}</span>
            <span>${text}</span>
          </div>
        `;
      };
      
      if (typeof firebase === 'undefined') {
        addResult('‚ùå', 'Firebase SDK non charg√©', false);
        return;
      }
      addResult('‚úÖ', 'Firebase SDK charg√©');
      
      if (!firebase.firestore) {
        addResult('‚ùå', 'Firestore non initialis√©', false);
        return;
      }
      addResult('‚úÖ', 'Firestore disponible');
      
      // Test 2: Authentification
      const currentUser = firebase.auth().currentUser;
      if (!currentUser) {
        addResult('‚ùå', 'Aucun utilisateur connect√©', false);
        return;
      }
      addResult('‚úÖ', `Utilisateur connect√©: ${currentUser.email}`);
      
      // Test 3: Acc√®s aux collections
      const db = firebase.firestore();
      try {
        const testRead = await db.collection('users').limit(1).get();
        addResult('‚úÖ', `Collection 'users' accessible (${testRead.size} document(s))`);
      } catch (error) {
        addResult('‚ùå', `Erreur collection 'users': ${error.message}`, false);
      }
      
      try {
        const testEmergency = await db.collection('emergency_access').limit(1).get();
        addResult('‚úÖ', `Collection 'emergency_access' accessible (${testEmergency.size} document(s))`);
      } catch (error) {
        addResult('‚ùå', `Erreur collection 'emergency_access': ${error.message}`, false);
      }
      
      // Test 4: Donn√©es patients locales
      const localPatients = JSON.parse(localStorage.getItem('syl-patients') || '[]');
      addResult('‚ÑπÔ∏è', `${localPatients.length} patients en local`);
      
      if (localPatients.length > 0) {
        const samplePatient = localPatients[0];
        addResult('‚ÑπÔ∏è', `Exemple: ${samplePatient.personalInfo?.firstName || 'N/A'} ${samplePatient.personalInfo?.lastName || 'N/A'}`);
      }
    });

    document.getElementById('clearAllData')?.addEventListener('click', () => {
      if (confirm('√ätes-vous s√ªr de vouloir vider le cache local ? Cette action supprimera tous les patients et tags NFC en local. Vous devrez recharger depuis Firebase.')) {
        localStorage.removeItem('syl-patients');
        localStorage.removeItem('syl-nfc-tags');
        localStorage.removeItem('syl-medicalData');
        localStorage.removeItem('syl-analytics');
        localStorage.removeItem('syl-reminders');
        alert('Cache vid√© ! Rechargement de la page...');
        location.reload();
      }
    });

    document.getElementById('searchPatient')?.addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      const filteredPatients = patients.filter(patient => 
        (patient.personalInfo?.firstName?.toLowerCase().includes(searchTerm)) ||
        (patient.personalInfo?.lastName?.toLowerCase().includes(searchTerm)) ||
        (patient.email?.toLowerCase().includes(searchTerm)) ||
        (patient.id?.toLowerCase().includes(searchTerm))
      );
      // Re-render la table avec les patients filtr√©s
      // TODO: Impl√©menter le filtrage en temps r√©el
    });

    // Event listener pour le bouton de synchronisation mobile
    document.getElementById('forceMobileSyncBtn')?.addEventListener('click', () => {
      if (confirm('üîÑ Synchronisation forc√©e mobile ?\n\nCela va :\n‚Ä¢ Nettoyer tout le cache\n‚Ä¢ Recharger les donn√©es depuis Firebase\n‚Ä¢ Peut prendre quelques secondes')) {
        window.forceMobileSync();
      }
    });
  }

  function setupNFCEvents() {
    document.getElementById('scanNFC')?.addEventListener('click', async () => {
      try {
        // V√©rifier le support NFC
        if (!('NDEFReader' in window)) {
          // Fallback avec simulation
          showNFCSimulationModal();
          return;
        }

        // V√©rifier les permissions
        const permission = await navigator.permissions.query({ name: 'nfc' });
        if (permission.state === 'denied') {
          throw new Error('Permissions NFC refus√©es. Activez le NFC dans les param√®tres du navigateur.');
        }

        // V√©rifier HTTPS
        if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
          throw new Error('NFC n√©cessite HTTPS. Utilisez un serveur HTTPS ou localhost.');
        }

        // D√©marrer le scan NFC
        const ndef = new NDEFReader();
        
        // Afficher un modal de scan en cours
        const scanModal = document.createElement('div');
        scanModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        scanModal.innerHTML = `
          <div class="bg-white rounded-lg p-6 max-w-md mx-4 text-center">
            <div class="animate-pulse mb-4">
              <div class="w-16 h-16 bg-blue-600 rounded-full mx-auto flex items-center justify-center text-white text-2xl">
                üì±
              </div>
            </div>
            <h3 class="text-lg font-bold text-gray-900 mb-2">Scan NFC en cours...</h3>
            <p class="text-gray-600 mb-4">Approchez votre tag NFC du t√©l√©phone</p>
            <button id="cancelNFCScan" class="bg-gray-500 hover:bg-gray-600 text-white rounded px-4 py-2">Annuler</button>
          </div>
        `;
        document.body.appendChild(scanModal);

        // G√©rer l'annulation
        document.getElementById('cancelNFCScan').onclick = () => {
          scanModal.remove();
        };

        // D√©marrer le scan
        await ndef.scan();
        console.log('üì° Scan NFC d√©marr√©');

        // √âcouter la d√©tection
        ndef.addEventListener('reading', ({ message, serialNumber }) => {
          scanModal.remove();
          
          let tagId = '';
          
          // Essayer de lire les donn√©es du tag
          if (message.records.length > 0) {
            const record = message.records[0];
            if (record.recordType === 'text') {
              tagId = new TextDecoder().decode(record.data);
            } else if (record.recordType === 'url') {
              tagId = new TextDecoder().decode(record.data);
            } else {
              // Utiliser le num√©ro de s√©rie si pas de donn√©es
              tagId = serialNumber || 'NFC_' + Date.now();
            }
          } else {
            // Utiliser le num√©ro de s√©rie
            tagId = serialNumber || 'NFC_' + Date.now();
          }

          // Formater l'ID
          if (!tagId.startsWith('NFC_') && !tagId.startsWith('SYL_')) {
            tagId = 'NFC_' + tagId;
          }

          // Mettre √† jour le champ seulement s'il existe (interface admin)
          const nfcTagIdField = document.getElementById('nfcTagId');
          if (nfcTagIdField) {
            nfcTagIdField.value = tagId;
          }
          
          // Afficher une confirmation
          showNFCSuccessModal(tagId);
        });

        // Timeout pour le scan
        setTimeout(() => {
          if (document.body.contains(scanModal)) {
            scanModal.remove();
            alert('‚è∞ Timeout du scan NFC. R√©essayez.');
          }
        }, 30000); // 30 secondes

      } catch (error) {
        console.error('Erreur NFC:', error);
        
        let errorMessage = 'Erreur NFC: ';
        if (error.name === 'NotAllowedError') {
          errorMessage += 'Permissions NFC refus√©es. Activez le NFC dans les param√®tres.';
        } else if (error.name === 'NotSupportedError') {
          errorMessage += 'NFC non support√© sur cet appareil.';
        } else if (error.message.includes('HTTPS')) {
          errorMessage += 'NFC n√©cessite HTTPS. Testez sur un serveur s√©curis√©.';
        } else {
          errorMessage += error.message;
        }
        
        // Proposer une simulation
        if (confirm(errorMessage + '\n\nVoulez-vous utiliser la simulation NFC ?')) {
          showNFCSimulationModal();
        }
      }
    });

    // Fonction pour la simulation NFC
    function showNFCSimulationModal() {
      const simModal = document.createElement('div');
      simModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      simModal.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-md mx-4">
          <h3 class="text-lg font-bold text-gray-900 mb-4">üé≠ Simulation NFC</h3>
          <p class="text-gray-600 mb-4">G√©n√©ration d'un tag NFC virtuel pour les tests</p>
          <div class="space-y-3">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Type de tag</label>
              <select id="nfcSimType" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                <option value="random">G√©n√©rer al√©atoirement</option>
                <option value="bracelet">Bracelet m√©dical</option>
                <option value="card">Carte m√©dicale</option>
                <option value="keychain">Porte-cl√©s</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ID personnalis√© (optionnel)</label>
              <input type="text" id="nfcSimCustom" placeholder="Ex: MON_TAG_123" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            </div>
          </div>
          <div class="flex gap-2 mt-6">
            <button id="generateNFCTag" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white rounded px-4 py-2">G√©n√©rer</button>
            <button onclick="this.closest('.fixed').remove()" class="bg-gray-500 hover:bg-gray-600 text-white rounded px-4 py-2">Annuler</button>
          </div>
        </div>
      `;
      document.body.appendChild(simModal);

      document.getElementById('generateNFCTag').onclick = () => {
        const type = document.getElementById('nfcSimType').value;
        const custom = document.getElementById('nfcSimCustom').value.trim();
        
        let tagId = '';
        if (custom) {
          tagId = custom.startsWith('NFC_') || custom.startsWith('SYL_') ? custom : 'NFC_' + custom;
        } else {
          const random = Math.random().toString(36).substr(2, 8).toUpperCase();
          switch (type) {
            case 'bracelet': tagId = 'SYL_BRACELET_' + random; break;
            case 'card': tagId = 'SYL_CARD_' + random; break;
            case 'keychain': tagId = 'SYL_KEY_' + random; break;
            default: tagId = 'NFC_' + random;
          }
        }
        
        // Mettre √† jour le champ seulement s'il existe (interface admin)
        const nfcTagIdField = document.getElementById('nfcTagId');
        if (nfcTagIdField) {
          nfcTagIdField.value = tagId;
        }
        simModal.remove();
        showNFCSuccessModal(tagId, true);
      };
    }

    // Fonction pour afficher le succ√®s
    function showNFCSuccessModal(tagId, isSimulated = false) {
      const successModal = document.createElement('div');
      successModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      successModal.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-md mx-4 text-center">
          <div class="w-16 h-16 bg-green-600 rounded-full mx-auto flex items-center justify-center text-white text-2xl mb-4">
            ${isSimulated ? 'üé≠' : 'üì±'}
          </div>
          <h3 class="text-lg font-bold text-green-600 mb-2">Tag NFC ${isSimulated ? 'simul√©' : 'd√©tect√©'} !</h3>
          <div class="bg-gray-100 rounded p-3 mb-4">
            <code class="text-sm font-mono">${tagId}</code>
          </div>
          <p class="text-gray-600 text-sm mb-4">${isSimulated ? 'Tag virtuel g√©n√©r√© pour les tests' : 'Tag physique d√©tect√© avec succ√®s'}</p>
          <button onclick="this.closest('.fixed').remove()" class="bg-green-600 hover:bg-green-700 text-white rounded px-6 py-2">Continuer</button>
        </div>
      `;
      document.body.appendChild(successModal);
      
      // Auto-fermer apr√®s 3 secondes
      setTimeout(() => {
        if (document.body.contains(successModal)) {
          successModal.remove();
        }
      }, 3000);
    }

    // Fonction pour √©crire des donn√©es sur un tag NFC
    document.getElementById('writeNFC')?.addEventListener('click', async () => {
      const nfcTagIdField = document.getElementById('nfcTagId');
      const nfcTagDescriptionField = document.getElementById('nfcTagDescription');
      
      if (!nfcTagIdField || !nfcTagDescriptionField) {
        console.error('√âl√©ments NFC non trouv√©s dans le DOM');
        return;
      }
      
      const tagId = nfcTagIdField.value.trim();
      const description = nfcTagDescriptionField.value.trim();
      
      if (!tagId) {
        alert('Veuillez d\'abord entrer un ID de tag ou scanner un tag');
        return;
      }

      try {
        if (!('NDEFReader' in window)) {
          alert('‚ö†Ô∏è √âcriture NFC non support√©e sur cet appareil.\n\nLe tag sera enregistr√© sans donn√©es physiques.');
          return;
        }

        // V√©rifier HTTPS
        if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
          throw new Error('NFC n√©cessite HTTPS pour l\'√©criture');
        }

        // Cr√©er le modal d'√©criture
        const writeModal = document.createElement('div');
        writeModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        writeModal.innerHTML = `
          <div class="bg-white rounded-lg p-6 max-w-md mx-4">
            <h3 class="text-lg font-bold text-gray-900 mb-4">‚úçÔ∏è √âcriture NFC</h3>
            <div class="space-y-3 mb-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ID du tag</label>
                <div class="bg-gray-100 rounded p-2">
                  <code class="text-sm">${tagId}</code>
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                <div class="bg-gray-100 rounded p-2 text-sm">
                  ${description || 'Aucune description'}
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Type de donn√©es</label>
                <select id="nfcDataType" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                  <option value="text">Texte (ID du tag)</option>
                  <option value="url">URL (acc√®s d'urgence)</option>
                  <option value="contact">Contact d'urgence</option>
                  <option value="patient">Lien fiche m√©dicale patient</option>
                </select>
              </div>
              <div id="patientSelection" class="hidden">
                <label class="block text-sm font-medium text-gray-700 mb-1">S√©lectionner un patient</label>
                <select id="nfcPatientSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                  <option value="">Choisir un patient...</option>
                  ${patients.map(patient => `
                    <option value="${patient.id || patient.uid}">
                      ${patient.personalInfo?.firstName || ''} ${patient.personalInfo?.lastName || ''} 
                      ${patient.email ? `(${patient.email})` : ''}
                    </option>
                  `).join('')}
                </select>
              </div>
            </div>
            <div class="bg-blue-50 border border-blue-200 rounded p-3 mb-4">
              <p class="text-sm text-blue-800">üì± Approchez le tag NFC de votre appareil pour √©crire les donn√©es</p>
            </div>
            <div class="flex gap-2">
              <button id="startNFCWrite" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white rounded px-4 py-2">√âcrire</button>
              <button onclick="this.closest('.fixed').remove()" class="bg-gray-500 hover:bg-gray-600 text-white rounded px-4 py-2">Annuler</button>
            </div>
          </div>
        `;
        document.body.appendChild(writeModal);

        // G√©rer l'affichage de la s√©lection de patient
        document.getElementById('nfcDataType').onchange = (e) => {
          const patientSelection = document.getElementById('patientSelection');
          if (e.target.value === 'patient') {
            patientSelection.classList.remove('hidden');
          } else {
            patientSelection.classList.add('hidden');
          }
        };

        document.getElementById('startNFCWrite').onclick = async () => {
          try {
            const dataType = document.getElementById('nfcDataType').value;
            const ndef = new NDEFReader();
            
            // Pr√©parer les donn√©es selon le type
            let ndefMessage;
            switch (dataType) {
              case 'url':
                const emergencyUrl = `${window.location.origin}${window.location.pathname}?nfc=${tagId}`;
                ndefMessage = { records: [{ recordType: 'url', data: emergencyUrl }] };
                break;
              case 'contact':
                const vcard = `BEGIN:VCARD
VERSION:3.0
FN:SYL Medical Emergency
ORG:SYL Medical
TEL:15
NOTE:Tag d'urgence m√©dicale ID: ${tagId}
END:VCARD`;
                ndefMessage = { records: [{ recordType: 'mime', mediaType: 'text/vcard', data: vcard }] };
                break;
              case 'patient':
                const selectedPatientId = document.getElementById('nfcPatientSelect').value;
                if (!selectedPatientId) {
                  alert('Veuillez s√©lectionner un patient');
                  return;
                }
                const selectedPatient = patients.find(p => (p.id || p.uid) === selectedPatientId);
                if (!selectedPatient) {
                  alert('Patient non trouv√©');
                  return;
                }
                // Cr√©er l'URL vers la fiche m√©dicale du patient
                const patientMedicalUrl = `${window.location.origin}${window.location.pathname}?patient=${selectedPatientId}&access=medical`;
                ndefMessage = { records: [{ recordType: 'url', data: patientMedicalUrl }] };
                break;
              default: // text
                ndefMessage = { records: [{ recordType: 'text', data: tagId }] };
            }

            // Afficher le statut d'√©criture
            writeModal.querySelector('.bg-white').innerHTML = `
              <div class="text-center py-8">
                <div class="animate-pulse mb-4">
                  <div class="w-16 h-16 bg-purple-600 rounded-full mx-auto flex items-center justify-center text-white text-2xl">
                    ‚úçÔ∏è
                  </div>
                </div>
                <h3 class="text-lg font-bold text-gray-900 mb-2">√âcriture en cours...</h3>
                <p class="text-gray-600 mb-4">Maintenez le tag NFC proche de l'appareil</p>
                <button onclick="this.closest('.fixed').remove()" class="bg-gray-500 hover:bg-gray-600 text-white rounded px-4 py-2">Annuler</button>
              </div>
            `;

            // √âcrire sur le tag
            await ndef.write(ndefMessage);
            
            // Succ√®s
            writeModal.querySelector('.bg-white').innerHTML = `
              <div class="text-center py-8">
                <div class="w-16 h-16 bg-green-600 rounded-full mx-auto flex items-center justify-center text-white text-2xl mb-4">
                  ‚úÖ
                </div>
                <h3 class="text-lg font-bold text-green-600 mb-2">√âcriture r√©ussie !</h3>
                <div class="bg-gray-100 rounded p-3 mb-4">
                  <code class="text-sm font-mono">${tagId}</code>
                </div>
                <p class="text-gray-600 text-sm mb-4">Donn√©es √©crites avec succ√®s sur le tag NFC</p>
                <button onclick="this.closest('.fixed').remove()" class="bg-green-600 hover:bg-green-700 text-white rounded px-6 py-2">Terminer</button>
              </div>
            `;

            // Auto-fermer apr√®s 3 secondes
            setTimeout(() => {
              if (document.body.contains(writeModal)) {
                writeModal.remove();
              }
            }, 3000);

          } catch (writeError) {
            console.error('Erreur √©criture NFC:', writeError);
            writeModal.querySelector('.bg-white').innerHTML = `
              <div class="text-center py-8">
                <div class="w-16 h-16 bg-red-600 rounded-full mx-auto flex items-center justify-center text-white text-2xl mb-4">
                  ‚ùå
                </div>
                <h3 class="text-lg font-bold text-red-600 mb-2">Erreur d'√©criture</h3>
                <p class="text-gray-600 text-sm mb-4">${writeError.message}</p>
                <button onclick="this.closest('.fixed').remove()" class="bg-red-600 hover:bg-red-700 text-white rounded px-6 py-2">Fermer</button>
              </div>
            `;
          }
        };

      } catch (error) {
        console.error('Erreur NFC:', error);
        alert('‚ùå Erreur: ' + error.message);
      }
    });

    document.getElementById('registerNFC')?.addEventListener('click', () => {
      const nfcTagIdField = document.getElementById('nfcTagId');
      const nfcTagDescriptionField = document.getElementById('nfcTagDescription');
      
      if (!nfcTagIdField || !nfcTagDescriptionField) {
        console.error('√âl√©ments NFC non trouv√©s dans le DOM');
        return;
      }
      
      const tagId = nfcTagIdField.value.trim();
      const description = nfcTagDescriptionField.value.trim();
      
      if (!tagId) {
        alert('Veuillez entrer un ID de tag NFC');
        return;
      }
      
      if (nfcTags.find(tag => tag.id === tagId)) {
        alert('Ce tag NFC existe d√©j√†');
        return;
      }
      
      const newTag = {
        id: tagId,
        description: description,
        createdAt: new Date().toISOString(),
        assignedTo: null,
        assignedAt: null
      };
      
      nfcTags.push(newTag);
      localStorage.setItem('syl-nfc-tags', JSON.stringify(nfcTags));
      
      // Reset form
      if (nfcTagIdField) nfcTagIdField.value = '';
      if (nfcTagDescriptionField) nfcTagDescriptionField.value = '';
      
      SYLUtilities.showNotification('Tag NFC enregistr√©', { body: `Tag ${tagId} ajout√© avec succ√®s` });
      SYLAnalytics.trackEvent('nfc_tag_registered', { tagId });
      render();
    });
  }

  function setupAssociationsEvents() {
    document.getElementById('createAssociation')?.addEventListener('click', () => {
      const patientId = document.getElementById('selectPatient').value;
      const tagId = document.getElementById('selectNFCTag').value;
      
      if (!patientId || !tagId) {
        alert('Veuillez s√©lectionner un patient et un tag NFC');
        return;
      }
      
      // Mettre √† jour le tag NFC
      const tag = nfcTags.find(t => t.id === tagId);
      if (tag) {
        tag.assignedTo = patientId;
        tag.assignedAt = new Date().toISOString();
      }
      
      // Mettre √† jour le patient
      const patient = patients.find(p => (p.id || p.uid) === patientId);
      if (patient) {
        patient.nfcTagId = tagId;
        
        // Sauvegarder les donn√©es d'urgence pour l'acc√®s public
        saveEmergencyData(patient);
      }
      
      localStorage.setItem('syl-nfc-tags', JSON.stringify(nfcTags));
      localStorage.setItem('syl-patients', JSON.stringify(patients));
      
      SYLUtilities.showNotification('Association cr√©√©e', { 
        body: `Tag ${tagId} associ√© au patient` 
      });
      SYLAnalytics.trackEvent('nfc_association_created', { patientId, tagId });
      render();
    });
  }

  function setupDebugEvents() {
    // Fonction de log dans l'interface
    function logToDebugOutput(message, type = 'info') {
      const output = document.getElementById('debugOutput');
      if (!output) return;
      
      const timestamp = new Date().toLocaleTimeString();
      const typeClass = type === 'error' ? 'text-red-600' : type === 'success' ? 'text-green-600' : 'text-blue-600';
      
      const logElement = document.createElement('div');
      logElement.className = `mb-1 ${typeClass}`;
      logElement.innerHTML = `<span class="text-gray-500">[${timestamp}]</span> ${message}`;
      
      output.appendChild(logElement);
      output.scrollTop = output.scrollHeight;
    }

    // Diagnostic rapide
    document.getElementById('runQuickDiag')?.addEventListener('click', async () => {
      logToDebugOutput("üè• D√©marrage du diagnostic rapide...", 'info');
      
      try {
        const result = await window.quickDiagnosis();
        logToDebugOutput(`‚úÖ Diagnostic termin√©: Firebase=${result.firebase}, User=${!!result.user}`, 'success');
      } catch (error) {
        logToDebugOutput(`‚ùå Erreur diagnostic: ${error.message}`, 'error');
      }
    });
    
    // Analyse des collections
    document.getElementById('analyzeCollections')?.addEventListener('click', async () => {
      logToDebugOutput("üìä Analyse des collections Firebase...", 'info');
      
      try {
        const analysis = await window.debugFirebaseCollections();
        
        // R√©sumer les r√©sultats
        Object.entries(analysis).forEach(([collection, data]) => {
          if (data.error) {
            logToDebugOutput(`‚ùå ${collection}: ${data.error}`, 'error');
          } else {
            logToDebugOutput(`‚úÖ ${collection}: ${data.count} documents`, 'success');
          }
        });
        
        logToDebugOutput("üìã Analyse termin√©e - Voir console F12", 'info');
        
      } catch (error) {
        logToDebugOutput(`‚ùå Erreur analyse: ${error.message}`, 'error');
      }
    });
    
    // Nettoyage des donn√©es
    document.getElementById('cleanupData')?.addEventListener('click', async () => {
      logToDebugOutput("üßπ Nettoyage (mode test)...", 'info');
      
      try {
        const actions = await window.cleanupFirebaseData({ dryRun: true });
        logToDebugOutput(`üìã ${actions.length} actions identifi√©es`, 'info');
      } catch (error) {
        logToDebugOutput(`‚ùå Erreur: ${error.message}`, 'error');
      }
    });
    
    // Migration du sch√©ma
    document.getElementById('migrateSchema')?.addEventListener('click', async () => {
      if (!confirm('Migration du sch√©ma - Continuer?')) return;
      
      logToDebugOutput("üöÄ Migration...", 'info');
      
      try {
        await window.migrateToStandardSchema();
        logToDebugOutput("‚úÖ Migration termin√©e", 'success');
        setTimeout(() => window.renderApp?.(), 1000);
      } catch (error) {
        logToDebugOutput(`‚ùå Erreur: ${error.message}`, 'error');
      }
    });
  }
}

// Fonctions globales pour l'admin
async function viewPatient(patientId) {
  console.log('üîç Chargement patient:', patientId);
  
  try {
    // Charger depuis Firebase
    const patientDoc = await db.collection('patients').doc(patientId).get();
    
    if (!patientDoc.exists) {
      alert('Patient non trouv√© dans Firebase');
      return;
    }
    
    const patient = patientDoc.data();
    console.log('‚úÖ Patient charg√©:', patient);
    
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
      <div class="bg-white rounded-lg p-6 max-w-2xl mx-4 max-h-96 overflow-y-auto">
        <h3 class="text-lg font-bold mb-4">D√©tails du Patient</h3>
        <div class="grid grid-cols-2 gap-4">
          <div><strong>Nom:</strong> ${patient.personalInfo?.firstName || ''} ${patient.personalInfo?.lastName || ''}</div>
          <div><strong>Email:</strong> ${patient.email || 'N/A'}</div>
          <div><strong>Groupe sanguin:</strong> ${patient.personalInfo?.bloodType || 'N/A'}</div>
          <div><strong>Date de naissance:</strong> ${patient.personalInfo?.dateOfBirth || 'N/A'}</div>
          <div><strong>T√©l√©phone urgence:</strong> ${patient.personalInfo?.emergencyContact?.phone || 'N/A'}</div>
          <div><strong>Tag NFC:</strong> ${patient.nfcTagId || 'Non assign√©'}</div>
        </div>
        <div class="mt-4">
          <strong>Allergies:</strong> ${patient.medicalHistory?.allergies?.join(', ') || 'Aucune'}
        </div>
        <div class="mt-4">
          <strong>M√©dicaments:</strong> ${patient.medicalHistory?.medications?.join(', ') || 'Aucun'}
        </div>
        <button onclick="this.closest('.fixed').remove()" class="mt-4 w-full bg-gray-500 hover:bg-gray-600 text-white rounded px-4 py-2">Fermer</button>
      </div>
    `;
    document.body.appendChild(modal);
    
  } catch (error) {
    console.error('‚ùå Erreur chargement patient:', error);
    alert('Erreur lors du chargement du patient: ' + error.message);
  }
}

function assignNFC(patientId) {
  const nfcTags = JSON.parse(localStorage.getItem('syl-nfc-tags') || '[]');
  const availableTags = nfcTags.filter(tag => !tag.assignedTo);
  
  if (availableTags.length === 0) {
    alert('Aucun tag NFC disponible. Veuillez d\'abord enregistrer des tags.');
    return;
  }
  
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
  modal.innerHTML = `
    <div class="bg-white rounded-lg p-6 max-w-md mx-4">
      <h3 class="text-lg font-bold mb-4">Assigner un Tag NFC</h3>
      <select id="modalSelectTag" class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-4">
        <option value="">S√©lectionner un tag</option>
        ${availableTags.map(tag => `<option value="${tag.id}">${tag.id} ${tag.description ? `(${tag.description})` : ''}</option>`).join('')}
      </select>
      <div class="flex gap-2">
        <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white rounded px-4 py-2">Annuler</button>
        <button onclick="confirmAssignNFC('${patientId}')" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white rounded px-4 py-2">Assigner</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

function confirmAssignNFC(patientId) {
  const tagId = document.getElementById('modalSelectTag').value;
  if (!tagId) {
    alert('Veuillez s√©lectionner un tag');
    return;
  }
  
  const nfcTags = JSON.parse(localStorage.getItem('syl-nfc-tags') || '[]');
  const patients = JSON.parse(localStorage.getItem('syl-patients') || '[]');
  
  // Mettre √† jour le tag
  const tag = nfcTags.find(t => t.id === tagId);
  if (tag) {
    tag.assignedTo = patientId;
    tag.assignedAt = new Date().toISOString();
  }
  
  // Mettre √† jour le patient
  const patient = patients.find(p => (p.id || p.uid) === patientId);
  if (patient) {
    patient.nfcTagId = tagId;
    
    // Sauvegarder les donn√©es d'urgence dans Firebase pour l'acc√®s public
    saveEmergencyData(patient);
  }
  
  localStorage.setItem('syl-nfc-tags', JSON.stringify(nfcTags));
  localStorage.setItem('syl-patients', JSON.stringify(patients));
  
  document.querySelector('.fixed').remove();
  SYLUtilities.showNotification('Tag assign√©', { body: `Tag ${tagId} assign√© avec succ√®s` });
  location.reload(); // Recharger pour mettre √† jour l'affichage
}

// Fonction pour sauvegarder les donn√©es d'urgence dans une collection publique
async function saveEmergencyData(patient) {
  if (typeof firebase === 'undefined' || !firebase.firestore) {
    console.log('‚ö†Ô∏è Firebase non disponible pour sauvegarder les donn√©es d\'urgence');
    return;
  }
  
  try {
    // S'assurer que l'utilisateur est authentifi√©
    const localUser = getCurrentUser();
    if (!firebase.auth().currentUser && !(localUser && localUser.role === 'admin')) {
      console.log('‚ö†Ô∏è Pas d\'utilisateur authentifi√©, impossible de sauvegarder');
      throw new Error('Authentification requise pour sauvegarder dans Firebase');
    }
    
    const db = firebase.firestore();
    const patientId = patient.id || patient.uid;
    
    if (!patientId) {
      throw new Error('ID patient manquant');
    }
    
    // Donn√©es COMPL√àTES n√©cessaires pour l'urgence
    const emergencyData = {
      personalInfo: {
        firstName: patient.personalInfo?.firstName || '',
        lastName: patient.personalInfo?.lastName || '',
        dateOfBirth: patient.personalInfo?.dateOfBirth || '',
        bloodType: patient.personalInfo?.bloodType || '',
        height: patient.personalInfo?.height || '',
        weight: patient.personalInfo?.weight || '',
        emergencyContact: patient.personalInfo?.emergencyContact || {}
      },
      medicalHistory: {
        allergies: patient.medicalHistory?.allergies || [],
        medications: patient.medicalHistory?.medications || [],
        chronicDiseases: patient.medicalHistory?.chronicDiseases || []
      },
      emergencyInfo: {
        criticalNotes: patient.emergencyInfo?.criticalNotes || ''
      },
      lastUpdated: new Date().toISOString(),
      nfcTagId: patient.nfcTagId || null
    };
    
    // Sauvegarder dans la collection emergency_access
    await db.collection('emergency_access').doc(patientId).set(emergencyData);
    console.log('‚úÖ Donn√©es d\'urgence sauvegard√©es pour acc√®s public:', patientId, `${emergencyData.personalInfo.firstName} ${emergencyData.personalInfo.lastName}`);
    
  } catch (error) {
    console.error('‚ùå Erreur lors de la sauvegarde des donn√©es d\'urgence:', error);
    throw error; // Propager l'erreur pour que la synchronisation puisse la capturer
  }
}

// ========== FONCTIONS DE SUPPRESSION ADMIN ==========

// Supprimer un patient
function deletePatient(patientId, patientName) {
  if (!confirm(`‚ö†Ô∏è ATTENTION !\n\nVoulez-vous vraiment supprimer le patient :\n"${patientName}" ?\n\nCette action est IRR√âVERSIBLE et supprimera :\n‚Ä¢ Toutes les donn√©es m√©dicales\n‚Ä¢ L'association NFC (si existante)\n‚Ä¢ Les donn√©es d'urgence Firebase\n\nTapez "SUPPRIMER" pour confirmer.`)) {
    return;
  }
  
  const confirmation = prompt('Pour confirmer la suppression, tapez "SUPPRIMER" :');
  if (confirmation !== 'SUPPRIMER') {
    alert('Suppression annul√©e.');
    return;
  }
  
  try {
    // 1. Supprimer des patients locaux
    let patients = JSON.parse(localStorage.getItem('syl-patients') || '[]');
    const patientIndex = patients.findIndex(p => (p.id || p.uid) === patientId);
    
    if (patientIndex === -1) {
      alert('Patient non trouv√© dans les donn√©es locales.');
      return;
    }
    
    const deletedPatient = patients[patientIndex];
    patients.splice(patientIndex, 1);
    localStorage.setItem('syl-patients', JSON.stringify(patients));
    
    // 2. Lib√©rer le tag NFC associ√©
    if (deletedPatient.nfcTagId) {
      let nfcTags = JSON.parse(localStorage.getItem('syl-nfc-tags') || '[]');
      const tagIndex = nfcTags.findIndex(tag => tag.id === deletedPatient.nfcTagId);
      if (tagIndex !== -1) {
        nfcTags[tagIndex].assignedTo = null;
        nfcTags[tagIndex].assignedAt = null;
        localStorage.setItem('syl-nfc-tags', JSON.stringify(nfcTags));
        console.log(`üè∑Ô∏è Tag NFC ${deletedPatient.nfcTagId} lib√©r√©`);
      }
    }
    
    // 3. Supprimer des donn√©es d'urgence Firebase (si possible)
    deleteEmergencyDataFirebase(patientId);
    
    // 4. Supprimer de Firebase Auth (si c'est un utilisateur Firebase)
    deleteFirebaseUser(deletedPatient.email);
    
    console.log(`‚úÖ Patient supprim√©: ${patientName} (${patientId})`);
    alert(`‚úÖ Patient "${patientName}" supprim√© avec succ√®s.\n\n‚Ä¢ Donn√©es locales supprim√©es\n‚Ä¢ Tag NFC lib√©r√©\n‚Ä¢ Suppression Firebase en cours...`);
    
    // Rafra√Æchir l'affichage
    location.reload();
    
  } catch (error) {
    console.error('‚ùå Erreur lors de la suppression:', error);
    alert(`‚ùå Erreur lors de la suppression: ${error.message}`);
  }
}

// Supprimer les donn√©es d'urgence Firebase
async function deleteEmergencyDataFirebase(patientId) {
  if (typeof firebase === 'undefined' || !firebase.firestore) {
    console.log('‚ö†Ô∏è Firebase non disponible pour supprimer les donn√©es d\'urgence');
    return;
  }
  
  try {
    const db = firebase.firestore();
    
    // Supprimer de la collection emergency_access
    await db.collection('emergency_access').doc(patientId).delete();
    console.log(`‚úÖ Donn√©es d'urgence Firebase supprim√©es: ${patientId}`);
    
    // Supprimer de la collection users si elle existe
    try {
      await db.collection('users').doc(patientId).delete();
      console.log(`‚úÖ Utilisateur Firebase supprim√©: ${patientId}`);
    } catch (userError) {
      console.log(`‚ÑπÔ∏è Utilisateur Firebase non trouv√© ou d√©j√† supprim√©: ${patientId}`);
    }
    
  } catch (error) {
    console.error('‚ùå Erreur lors de la suppression Firebase:', error);
  }
}

// Supprimer un utilisateur Firebase Auth (admin uniquement)
async function deleteFirebaseUser(email) {
  console.log(`üîê Demande de suppression utilisateur Firebase: ${email}`);
  
  // Note: La suppression d'un utilisateur Firebase Auth n√©cessite les privil√®ges Admin SDK
  // Cette fonction notifie seulement l'admin qu'une action manuelle peut √™tre n√©cessaire
  
  const adminEmails = Object.keys(adminAccounts);
  if (adminEmails.includes(email)) {
    console.log('‚ö†Ô∏è Impossible de supprimer un compte admin');
    return;
  }
  
  // Dans un environnement de production, ceci ferait appel √† une Cloud Function
  // qui utilise l'Admin SDK pour supprimer l'utilisateur
  console.log(`‚ÑπÔ∏è Suppression utilisateur Firebase √† effectuer manuellement: ${email}`);
}

// Fonction pour supprimer tous les patients (VERSION FIRESTORE)
async function deleteAllPatients() {
  const adminUser = getUser();
  if (!adminUser || adminUser.role !== 'admin') {
    alert('‚ùå Acc√®s refus√© - Admin uniquement');
    return;
  }
  
  if (!confirm('‚ö†Ô∏è SUPPRIMER TOUS LES PATIENTS ?\n\nCette action supprimera d√©finitivement :\n‚Ä¢ Tous les patients du syst√®me\n‚Ä¢ Toutes leurs donn√©es m√©dicales\n‚Ä¢ Les associations NFC\n\n√ätes-vous s√ªr ?')) {
    return;
  }
  
  const confirmation = prompt('Pour confirmer, tapez "SUPPRIMER" :');
  if (confirmation !== 'SUPPRIMER') {
    alert('Suppression annul√©e.');
    return;
  }
  
  if (!db) {
    alert('‚ùå Erreur: Firebase non initialis√©');
    return;
  }
  
  try {
    // Afficher un indicateur de progression
    const progressDiv = document.createElement('div');
    progressDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    progressDiv.innerHTML = `
      <div class="bg-white rounded-lg p-6 text-center">
        <div class="animate-spin h-8 w-8 border-b-2 border-red-600 mx-auto mb-4"></div>
        <p class="text-lg font-medium">Suppression en cours...</p>
        <p id="deleteProgress" class="text-sm text-gray-600">Initialisation...</p>
      </div>
    `;
    document.body.appendChild(progressDiv);
    
    const updateProgress = (message) => {
      document.getElementById('deleteProgress').textContent = message;
    };
    
    // 1. Supprimer tous les patients
    updateProgress('Suppression des patients...');
    const patientsSnapshot = await db.collection('patients').get();
    const patientCount = patientsSnapshot.size;
    
    const patientDeletePromises = [];
    patientsSnapshot.forEach(doc => {
      patientDeletePromises.push(db.collection('patients').doc(doc.id).delete());
    });
    
    await Promise.all(patientDeletePromises);
    updateProgress(`${patientCount} patients supprim√©s`);
    
    // 2. Supprimer tous les utilisateurs patients
    updateProgress('Suppression des comptes utilisateurs...');
    const usersSnapshot = await db.collection('users').where('role', '==', 'patient').get();
    const userCount = usersSnapshot.size;
    
    const userDeletePromises = [];
    usersSnapshot.forEach(doc => {
      userDeletePromises.push(db.collection('users').doc(doc.id).delete());
    });
    
    await Promise.all(userDeletePromises);
    updateProgress(`${userCount} comptes utilisateurs supprim√©s`);
    
    // 3. Lib√©rer tous les tags NFC
    updateProgress('Lib√©ration des tags NFC...');
    const nfcSnapshot = await db.collection('nfcTags').get();
    const nfcUpdatePromises = [];
    
    nfcSnapshot.forEach(doc => {
      nfcUpdatePromises.push(
        db.collection('nfcTags').doc(doc.id).update({
          assignedTo: null,
          assignedAt: null,
          lastModified: firebase.firestore.FieldValue.serverTimestamp()
        })
      );
    });
    
    await Promise.all(nfcUpdatePromises);
    updateProgress('Tags NFC lib√©r√©s');
    
    // Supprimer l'indicateur de progression
    document.body.removeChild(progressDiv);
    
    console.log(`‚úÖ Suppression termin√©e: ${patientCount} patients, ${userCount} comptes`);
    alert(`‚úÖ Suppression termin√©e !\n\n‚Ä¢ ${patientCount} patients supprim√©s\n‚Ä¢ ${userCount} comptes utilisateurs supprim√©s\n‚Ä¢ Tags NFC lib√©r√©s\n\nLes changements sont synchronis√©s en temps r√©el.`);
    
  } catch (error) {
    // Supprimer l'indicateur de progression en cas d'erreur
    const progressDiv = document.querySelector('.fixed.inset-0');
    if (progressDiv) document.body.removeChild(progressDiv);
    
    console.error('‚ùå Erreur lors de la suppression:', error);
    alert(`‚ùå Erreur lors de la suppression: ${error.message}`);
  }
}

// ========== NETTOYAGE FIREBASE AUTH ==========

// Fonction pour diagnostiquer les comptes "fant√¥mes" Firebase Auth
async function diagnoseFirebaseAuthIssues() {
  const adminUser = getUser();
  if (!adminUser || adminUser.role !== 'admin') {
    alert('‚ùå Acc√®s refus√© - Admin uniquement');
    return;
  }
  
  if (!auth) {
    alert('‚ùå Firebase Auth non initialis√©');
    return;
  }
  
  try {
    console.log('üîç Diagnostic des comptes Firebase Auth...');
    
    // Obtenir la liste des patients locaux
    const localPatients = JSON.parse(localStorage.getItem('syl-patients') || '[]');
    const localEmails = localPatients.map(p => p.email).filter(Boolean);
    
    console.log(`üìä Patients locaux: ${localPatients.length}`);
    console.log(`üìß Emails locaux:`, localEmails);
    
    // Informations pour l'admin
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
      <div class="bg-white rounded-lg p-6 max-w-2xl mx-4 max-h-96 overflow-y-auto">
        <h3 class="text-lg font-bold mb-4 text-red-600">üîç Diagnostic Firebase Auth</h3>
        
        <div class="space-y-4">
          <div class="bg-yellow-50 border border-yellow-200 rounded p-3">
            <h4 class="font-semibold text-yellow-800">Situation d√©tect√©e :</h4>
            <p class="text-sm text-yellow-700">Des comptes Firebase Auth existent encore apr√®s suppression des donn√©es locales.</p>
          </div>
          
          <div class="bg-blue-50 border border-blue-200 rounded p-3">
            <h4 class="font-semibold text-blue-800">Patients locaux actuels :</h4>
            <p class="text-sm text-blue-700">${localPatients.length} patients dans le stockage local</p>
            ${localEmails.length > 0 ? 
              `<div class="text-xs text-blue-600 mt-1">Emails: ${localEmails.join(', ')}</div>` : 
              '<div class="text-xs text-blue-600 mt-1">Aucun email local</div>'
            }
          </div>
          
          <div class="bg-green-50 border border-green-200 rounded p-3">
            <h4 class="font-semibold text-green-800">Solutions recommand√©es :</h4>
            <ol class="text-sm text-green-700 space-y-1 ml-4 list-decimal">
              <li>Essayez de vous connecter avec l'email probl√©matique</li>
              <li>Si connexion impossible, utilisez un email diff√©rent temporairement</li>
              <li>Contactez Firebase Support pour suppression manuelle des comptes Auth</li>
              <li>Ou attendez 30 jours (suppression automatique des comptes inactifs)</li>
            </ol>
          </div>
          
          <div class="bg-red-50 border border-red-200 rounded p-3">
            <h4 class="font-semibold text-red-800">Actions avanc√©es :</h4>
            <div class="text-sm text-red-700 space-y-2">
              <button onclick="attemptAuthRecovery()" class="bg-orange-600 text-white px-3 py-1 rounded text-xs hover:bg-orange-700">
                üîß Tentative de r√©cup√©ration automatique
              </button>
              <button onclick="showFirebaseAuthAdvice()" class="bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700">
                üìö Guide Firebase Auth
              </button>
            </div>
          </div>
        </div>
        
        <button onclick="this.closest('.fixed').remove()" class="mt-4 w-full bg-gray-500 hover:bg-gray-600 text-white rounded px-4 py-2">
          Fermer
        </button>
      </div>
    `;
    document.body.appendChild(modal);
    
  } catch (error) {
    console.error('‚ùå Erreur lors du diagnostic:', error);
    alert(`‚ùå Erreur lors du diagnostic: ${error.message}`);
  }
}

// Tentative de r√©cup√©ration automatique
async function attemptAuthRecovery() {
  try {
    console.log('üîÑ Tentative de r√©cup√©ration automatique...');
    
    // D√©connecter l'utilisateur actuel si connect√©
    if (auth.currentUser) {
      await auth.signOut();
      console.log('üë§ Utilisateur actuel d√©connect√©');
    }
    
    // Nettoyer les donn√©es locales corrompues
    const keysToClean = [
      'firebase:authUser:AIzaSyDqII2vBhBybNhVcr1QktyhvVeBW2TO0KA:[DEFAULT]',
      'firebase:persistence:AIzaSyDqII2vBhBybNhVcr1QktyhvVeBW2TO0KA:[DEFAULT]'
    ];
    
    keysToClean.forEach(key => {
      if (localStorage.getItem(key)) {
        localStorage.removeItem(key);
        console.log(`üßπ Cl√© nettoy√©e: ${key}`);
      }
    });
    
    // Forcer un rafra√Æchissement
    setTimeout(() => {
      alert('üîÑ R√©cup√©ration tent√©e !\n\nLa page va se recharger pour appliquer les changements.');
      location.reload();
    }, 1000);
    
  } catch (error) {
    console.error('‚ùå Erreur lors de la r√©cup√©ration:', error);
    alert(`‚ùå Erreur lors de la r√©cup√©ration: ${error.message}`);
  }
}

// Guide Firebase Auth
function showFirebaseAuthAdvice() {
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
  modal.innerHTML = `
    <div class="bg-white rounded-lg p-6 max-w-3xl mx-4 max-h-96 overflow-y-auto">
      <h3 class="text-lg font-bold mb-4 text-blue-600">üìö Guide Firebase Authentication</h3>
      
      <div class="space-y-4 text-sm">
        <div class="bg-gray-50 border rounded p-3">
          <h4 class="font-semibold text-gray-800">üîß Solution 1: Console Firebase</h4>
          <ol class="text-gray-700 space-y-1 ml-4 list-decimal mt-2">
            <li>Allez sur <code class="bg-gray-200 px-1 rounded">console.firebase.google.com</code></li>
            <li>S√©lectionnez votre projet: <code class="bg-gray-200 px-1 rounded">syl-medical-app-1c58a</code></li>
            <li>Cliquez sur "Authentication" ‚Üí "Users"</li>
            <li>Trouvez l'email probl√©matique et cliquez sur "Delete user"</li>
          </ol>
        </div>
        
        <div class="bg-gray-50 border rounded p-3">
          <h4 class="font-semibold text-gray-800">üí° Solution 2: Email temporaire</h4>
          <p class="text-gray-700 mt-2">Utilisez un email temporaire pour cr√©er un compte test :</p>
          <ul class="text-gray-600 space-y-1 ml-4 list-disc mt-1">
            <li><code class="bg-gray-200 px-1 rounded">test@example.com</code></li>
            <li><code class="bg-gray-200 px-1 rounded">demo+1@gmail.com</code></li>
            <li><code class="bg-gray-200 px-1 rounded">votre.email+test@gmail.com</code></li>
          </ul>
        </div>
        
        <div class="bg-gray-50 border rounded p-3">
          <h4 class="font-semibold text-gray-800">‚è∞ Solution 3: Attendre</h4>
          <p class="text-gray-700 mt-2">Firebase supprime automatiquement les comptes inactifs apr√®s 30 jours sans connexion.</p>
        </div>
      </div>
      
      <button onclick="this.closest('.fixed').remove()" class="mt-4 w-full bg-blue-500 hover:bg-blue-600 text-white rounded px-4 py-2">
        Compris !
      </button>
    </div>
  `;
  document.body.appendChild(modal);
}

function deleteNFCTag(tagId) {
  if (!confirm('Supprimer ce tag NFC ? Cette action est irr√©versible.')) {
    return;
  }
  
  let nfcTags = JSON.parse(localStorage.getItem('syl-nfc-tags') || '[]');
  nfcTags = nfcTags.filter(tag => tag.id !== tagId);
  localStorage.setItem('syl-nfc-tags', JSON.stringify(nfcTags));
  
  SYLUtilities.showNotification('Tag supprim√©', { body: `Tag ${tagId} supprim√©` });
  location.reload();
}

function removeAssociation(tagId) {
  if (!confirm('Dissocier ce tag NFC du patient ?')) {
    return;
  }
  
  const nfcTags = JSON.parse(localStorage.getItem('syl-nfc-tags') || '[]');
  const patients = JSON.parse(localStorage.getItem('syl-patients') || '[]');
  
  // Mettre √† jour le tag
  const tag = nfcTags.find(t => t.id === tagId);
  if (tag) {
    const patientId = tag.assignedTo;
    tag.assignedTo = null;
    tag.assignedAt = null;
    
    // Mettre √† jour le patient
    const patient = patients.find(p => (p.id || p.uid) === patientId);
    if (patient) {
      patient.nfcTagId = null;
    }
  }
  
  localStorage.setItem('syl-nfc-tags', JSON.stringify(nfcTags));
  localStorage.setItem('syl-patients', JSON.stringify(patients));
  
  SYLUtilities.showNotification('Association supprim√©e', { body: `Tag ${tagId} dissoci√©` });
  location.reload();
}

// Fonction pour tester un tag NFC sp√©cifique
function testNFCTag(tagId) {
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
  modal.innerHTML = `
    <div class="bg-white rounded-lg p-6 max-w-md mx-4 text-center">
      <div class="w-16 h-16 bg-blue-600 rounded-full mx-auto flex items-center justify-center text-white text-2xl mb-4">
        üß™
      </div>
      <h3 class="text-lg font-bold text-gray-900 mb-4">Test du Tag NFC</h3>
      <div class="bg-gray-100 rounded p-3 mb-4">
        <code class="text-sm font-mono">${tagId}</code>
      </div>
      <div class="space-y-3">
        <button onclick="testNFCRead('${tagId}')" class="w-full bg-blue-600 hover:bg-blue-700 text-white rounded px-4 py-2">üì± Tester la lecture</button>
        <button onclick="testNFCEmergency('${tagId}')" class="w-full bg-red-600 hover:bg-red-700 text-white rounded px-4 py-2">üöë Simuler acc√®s d'urgence</button>
        <button onclick="this.closest('.fixed').remove()" class="w-full bg-gray-500 hover:bg-gray-600 text-white rounded px-4 py-2">Fermer</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

// Fonction pour programmer un tag NFC avec des donn√©es
function writeNFCTagData(tagId) {
  const nfcTags = JSON.parse(localStorage.getItem('syl-nfc-tags') || '[]');
  const tag = nfcTags.find(t => t.id === tagId);
  
  if (!tag) {
    alert('Tag non trouv√©');
    return;
  }

  // Remplir les champs et d√©clencher l'√©criture
  const nfcTagIdField = document.getElementById('nfcTagId');
  const nfcTagDescriptionField = document.getElementById('nfcTagDescription');
  const writeNFCButton = document.getElementById('writeNFC');
  
  if (!nfcTagIdField || !nfcTagDescriptionField || !writeNFCButton) {
    alert('Interface d\'√©criture NFC non disponible dans ce contexte');
    return;
  }
  
  nfcTagIdField.value = tagId;
  nfcTagDescriptionField.value = tag.description || '';
  
  // D√©clencher l'√©v√©nement d'√©criture
  writeNFCButton.click();
}

// Tester la lecture d'un tag NFC
async function testNFCRead(tagId) {
  try {
    if (!('NDEFReader' in window)) {
      alert('üì± API NFC non support√©e sur cet appareil.\n\nTest simul√© : Le tag contiendrait les donn√©es d\'urgence du patient associ√©.');
      return;
    }

    const readModal = document.createElement('div');
    readModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    readModal.innerHTML = `
      <div class="bg-white rounded-lg p-6 max-w-md mx-4 text-center">
        <div class="animate-pulse mb-4">
          <div class="w-16 h-16 bg-blue-600 rounded-full mx-auto flex items-center justify-center text-white text-2xl">
            üì±
          </div>
        </div>
        <h3 class="text-lg font-bold text-gray-900 mb-2">Lecture NFC en cours...</h3>
        <p class="text-gray-600 mb-4">Approchez le tag ${tagId} de votre appareil</p>
        <button onclick="this.closest('.fixed').remove()" class="bg-gray-500 hover:bg-gray-600 text-white rounded px-4 py-2">Annuler</button>
      </div>
    `;
    document.body.appendChild(readModal);

    const ndef = new NDEFReader();
    await ndef.scan();

    ndef.addEventListener('reading', ({ message, serialNumber }) => {
      readModal.remove();
      
      let content = 'Aucune donn√©e lisible';
      if (message.records.length > 0) {
        const record = message.records[0];
        if (record.recordType === 'text') {
          content = new TextDecoder().decode(record.data);
        } else if (record.recordType === 'url') {
          content = new TextDecoder().decode(record.data);
        }
      }

      const resultModal = document.createElement('div');
      resultModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      resultModal.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-md mx-4">
          <h3 class="text-lg font-bold text-green-600 mb-4">‚úÖ Lecture r√©ussie</h3>
          <div class="space-y-3">
            <div>
              <label class="block text-sm font-medium text-gray-700">Tag ID:</label>
              <div class="bg-gray-100 rounded p-2 text-sm font-mono">${tagId}</div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Num√©ro de s√©rie:</label>
              <div class="bg-gray-100 rounded p-2 text-sm font-mono">${serialNumber || 'Non disponible'}</div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Contenu:</label>
              <div class="bg-gray-100 rounded p-2 text-sm">${content}</div>
            </div>
          </div>
          <button onclick="this.closest('.fixed').remove()" class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white rounded px-4 py-2">Fermer</button>
        </div>
      `;
      document.body.appendChild(resultModal);
    });

    // Timeout
    setTimeout(() => {
      if (document.body.contains(readModal)) {
        readModal.remove();
        alert('‚è∞ Timeout de lecture. R√©essayez.');
      }
    }, 30000);

  } catch (error) {
    console.error('Erreur test lecture NFC:', error);
    alert('‚ùå Erreur de lecture: ' + error.message);
  }
}

// Simuler un acc√®s d'urgence
function testNFCEmergency(tagId) {
  const nfcTags = JSON.parse(localStorage.getItem('syl-nfc-tags') || '[]');
  const patients = JSON.parse(localStorage.getItem('syl-patients') || '[]');
  
  const tag = nfcTags.find(t => t.id === tagId);
  const patient = patients.find(p => (p.id || p.uid) === tag?.assignedTo);
  
  if (!patient) {
    alert('‚ùå Aucun patient associ√© √† ce tag.\n\nAssociez d\'abord un patient au tag pour tester l\'acc√®s d\'urgence.');
    return;
  }
  
  // Simuler l'interface d'urgence
  const emergencyModal = document.createElement('div');
  emergencyModal.className = 'fixed inset-0 bg-red-900 bg-opacity-95 flex items-center justify-center z-50';
  emergencyModal.innerHTML = `
    <div class="bg-white rounded-lg p-6 max-w-2xl mx-4 border-4 border-red-600">
      <div class="text-center mb-6">
        <div class="w-16 h-16 bg-red-600 rounded-full mx-auto flex items-center justify-center text-white text-2xl mb-4">
          üöë
        </div>
        <h2 class="text-2xl font-bold text-red-600 mb-2">ACC√àS D'URGENCE ACTIV√â</h2>
        <p class="text-gray-600">Tag NFC: ${tagId}</p>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bg-red-50 border-2 border-red-200 rounded-lg p-4">
          <h3 class="font-bold text-red-800 mb-3">üë§ Patient</h3>
          <div class="space-y-2 text-sm">
            <div><strong>Nom:</strong> ${patient.personalInfo?.firstName} ${patient.personalInfo?.lastName}</div>
            <div><strong>N√©(e) le:</strong> ${patient.personalInfo?.dateOfBirth || 'Non renseign√©'}</div>
            <div><strong>Groupe sanguin:</strong> <span class="bg-red-600 text-white px-2 py-1 rounded text-xs">${patient.personalInfo?.bloodType || 'Non renseign√©'}</span></div>
          </div>
        </div>
        
        <div class="bg-orange-50 border-2 border-orange-200 rounded-lg p-4">
          <h3 class="font-bold text-orange-800 mb-3">‚ö†Ô∏è Alertes M√©dicales</h3>
          <div class="space-y-2 text-sm">
            <div><strong>Allergies:</strong> ${patient.medicalHistory?.allergies?.join(', ') || 'Aucune connue'}</div>
            <div><strong>M√©dicaments:</strong> ${patient.medicalHistory?.medications?.join(', ') || 'Aucun'}</div>
            <div><strong>Maladies chroniques:</strong> ${patient.medicalHistory?.chronicDiseases?.join(', ') || 'Aucune'}</div>
          </div>
        </div>
        
        <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4">
          <h3 class="font-bold text-blue-800 mb-3">üìû Contact d'Urgence</h3>
          <div class="space-y-2 text-sm">
            <div><strong>Nom:</strong> ${patient.personalInfo?.emergencyContact?.name || 'Non renseign√©'}</div>
            <div><strong>Relation:</strong> ${patient.personalInfo?.emergencyContact?.relation || 'Non renseign√©'}</div>
            <div><strong>T√©l√©phone:</strong> 
              <a href="tel:${patient.personalInfo?.emergencyContact?.phone}" class="text-blue-600 underline">
                ${patient.personalInfo?.emergencyContact?.phone || 'Non renseign√©'}
              </a>
            </div>
          </div>
        </div>
        
        <div class="bg-yellow-50 border-2 border-yellow-200 rounded-lg p-4">
          <h3 class="font-bold text-yellow-800 mb-3">üìù Notes Critiques</h3>
          <div class="text-sm">
            ${patient.emergencyInfo?.criticalNotes || 'Aucune note critique'}
          </div>
        </div>
      </div>
      
      <div class="flex gap-2 mt-6">
        <button onclick="window.open('tel:15')" class="flex-1 bg-red-600 hover:bg-red-700 text-white rounded px-4 py-2 font-bold">üìû SAMU (15)</button>
        <button onclick="this.closest('.fixed').remove()" class="bg-gray-500 hover:bg-gray-600 text-white rounded px-4 py-2">Fermer Test</button>
      </div>
    </div>
  `;
  document.body.appendChild(emergencyModal);
  
  // Enregistrer l'acc√®s d'urgence
  SYLAnalytics.trackEvent('emergency_access_test', { tagId, patientId: patient.id || patient.uid });
}

function testNFC(tagId) {
  const nfcTags = JSON.parse(localStorage.getItem('syl-nfc-tags') || '[]');
  const patients = JSON.parse(localStorage.getItem('syl-patients') || '[]');
  
  const tag = nfcTags.find(t => t.id === tagId);
  const patient = patients.find(p => (p.id || p.uid) === tag?.assignedTo);
  
  if (!patient) {
    alert('Patient non trouv√© pour ce tag');
    return;
  }
  
  // Simuler l'acc√®s d'urgence
  const emergencyData = {
    patient: `${patient.personalInfo?.firstName} ${patient.personalInfo?.lastName}`,
    bloodType: patient.personalInfo?.bloodType,
    allergies: patient.medicalHistory?.allergies,
    emergencyContact: patient.personalInfo?.emergencyContact?.phone,
    lastAccess: new Date().toISOString()
  };
  
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
  modal.innerHTML = `
    <div class="bg-white rounded-lg p-6 max-w-md mx-4">
      <h3 class="text-lg font-bold mb-4 text-green-600">‚úÖ Test NFC R√©ussi</h3>
      <div class="space-y-2">
        <div><strong>Tag:</strong> ${tagId}</div>
        <div><strong>Patient:</strong> ${emergencyData.patient}</div>
        <div><strong>Groupe sanguin:</strong> ${emergencyData.bloodType || 'N/A'}</div>
        <div><strong>Contact urgence:</strong> ${emergencyData.emergencyContact || 'N/A'}</div>
      </div>
      <button onclick="this.closest('.fixed').remove()" class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white rounded px-4 py-2">Fermer</button>
    </div>
  `;
  document.body.appendChild(modal);
  
  SYLAnalytics.trackEvent('nfc_test', { tagId, patientId: patient.id });
}

// ----------- MEDECIN DASHBOARD -----------
function renderMedecinDashboard(user) {
  let patients = JSON.parse(localStorage.getItem('syl-patients') || 'null');
  if (!patients) {
    patients = [
      {
        id: '1',
        personalInfo: { firstName: 'Jean', lastName: 'Martin', dateOfBirth: '1978-05-15', bloodType: 'O+', height: '175', weight: '80' },
        medicalHistory: { allergies: ['P√©nicilline', 'Pollen'], medications: ['Metformine 500mg'], conditions: ['Diab√®te type 2'], chronicDiseases: ['Diab√®te type 2', 'Hypertension'] },
        emergencyInfo: { criticalNotes: 'Risque hypoglyc√©mie', contraindications: ['Cortico√Ødes'] },
        lastAccess: '2024-01-15',
        isActive: true
      },
      {
        id: '2',
        personalInfo: { firstName: 'Marie', lastName: 'Dubois', dateOfBirth: '1985-08-22', bloodType: 'A+', height: '165', weight: '65' },
        medicalHistory: { allergies: ['Aspirine'], medications: ['Levothyrox'], conditions: ['Hypothyro√Ødie'], chronicDiseases: ['Hypothyro√Ødie'] },
        emergencyInfo: { criticalNotes: '', contraindications: [] },
        lastAccess: '2024-01-14',
        isActive: true
      }
    ];
    localStorage.setItem('syl-patients', JSON.stringify(patients));
  }
  let searchTerm = '';
  let selectedPatient = null;
  let activeTab = 'patients';
  render();

  function render() {
    const filteredPatients = patients.filter(patient =>
      `${patient.personalInfo.firstName} ${patient.personalInfo.lastName}`.toLowerCase().includes(searchTerm.toLowerCase())
    );
    document.getElementById('app').innerHTML = `
      <div class="min-h-screen bg-gray-50">
        <header class="bg-white shadow-sm border-b">
          <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center h-16">
            <div class="flex items-center">
              ${icons.stethoscope}
              <div class="ml-3">
                <h1 class="text-xl font-bold text-gray-900">SYL Medical Pro</h1>
                <p class="text-xs text-gray-500">${user.profile.speciality||''} ‚Ä¢ ${user.profile.hospital||''}</p>
              </div>
            </div>
            <div class="flex items-center space-x-4">
              <div class="text-sm text-gray-600">Dr. ${user.profile.firstName} ${user.profile.lastName}</div>
              <button id="logoutBtn" class="border-2 border-green-600 text-green-600 hover:bg-green-50 font-medium rounded-lg px-4 py-2 flex items-center gap-2">${icons.logout} D√©connexion</button>
            </div>
          </div>
        </header>
        
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
          <div class="mb-8">
            <!-- Navigation tabs -->
            <div class="flex space-x-4 mb-6">
              <button class="px-4 py-2 rounded-lg ${activeTab==='patients' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'}" data-tab="patients">Patients</button>
              <button class="px-4 py-2 rounded-lg ${activeTab==='emergency' ? 'bg-red-600 text-white' : 'bg-gray-200 text-gray-700'}" data-tab="emergency">üöë Acc√®s Urgence</button>
            </div>

            ${activeTab === 'patients' ? renderPatientsTab(filteredPatients) : ''}
            ${activeTab === 'emergency' ? renderEmergencyAccessTab() : ''}
          </div>
        </div>

        ${selectedPatient ? renderPatientModal(selectedPatient) : ''}
      </div>
    `;
    
    document.getElementById('logoutBtn').onclick = () => { logout(); };
    document.querySelectorAll('[data-tab]').forEach(btn => btn.onclick = () => { activeTab = btn.getAttribute('data-tab'); render(); });
    
    if (activeTab === 'patients') patientsTabEvents(filteredPatients);
    if (activeTab === 'emergency') emergencyTabEvents();
    if (selectedPatient) modalEvents();
  }

  function renderPatientsTab(filteredPatients) {
    return `
      <h2 class="text-2xl font-bold text-gray-900 mb-4">Patients</h2>
      
      <!-- Barre de recherche -->
      <div class="flex items-center space-x-4 mb-6">
        <div class="flex-1 relative">
          ${icons.search}
          <input type="text" placeholder="Rechercher un patient..." value="${searchTerm}" id="searchPatient" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
        </div>
        <button class="bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg px-6 py-2 flex items-center gap-2" id="addPatient">${icons.userPlus} Nouveau patient</button>
      </div>

      <!-- Stats rapides -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4 flex items-center">
          ${icons.users}<div class="ml-3"><p class="text-2xl font-bold text-gray-900">${patients.length}</p><p class="text-sm text-gray-600">Patients totaux</p></div>
        </div>
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4 flex items-center">
          ${icons.activity}<div class="ml-3"><p class="text-2xl font-bold text-gray-900">${patients.filter(p=>p.isActive).length}</p><p class="text-sm text-gray-600">Actifs</p></div>
        </div>
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4 flex items-center">
          ${icons.alert}<div class="ml-3"><p class="text-2xl font-bold text-gray-900">${patients.filter(p=>p.emergencyInfo?.criticalNotes).length}</p><p class="text-sm text-gray-600">Alertes</p></div>
        </div>
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4 flex items-center">
          ${icons.clock}<div class="ml-3"><p class="text-2xl font-bold text-gray-900">5</p><p class="text-sm text-gray-600">RDV aujourd'hui</p></div>
        </div>
      </div>

      <!-- Liste des patients -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        ${filteredPatients.map(patient => `
          <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4 mb-4 hover:shadow-lg transition-shadow cursor-pointer ${patient.emergencyInfo?.criticalNotes ? 'border-l-4 border-red-500' : ''}" data-patient="${patient.id}">
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-3">
                <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-green-500 rounded-full flex items-center justify-center">${icons.user}</div>
                <div>
                  <h3 class="font-semibold text-gray-900">${patient.personalInfo.firstName} ${patient.personalInfo.lastName}</h3>
                  <p class="text-sm text-gray-500">Groupe: ${patient.personalInfo.bloodType || 'Non renseign√©'} ‚Ä¢ ${patient.lastAccess}</p>
                  ${patient.emergencyInfo?.criticalNotes ? `<p class="text-xs text-red-600 font-bold">‚ö†Ô∏è Notes d'urgence</p>` : ''}
                </div>
              </div>
              <div class="flex items-center space-x-2">
                ${patient.isActive ? '<div class="w-3 h-3 bg-green-500 rounded-full"></div>' : ''}
                <span class="text-xs text-gray-400">Actif</span>
              </div>
            </div>
            
            <div class="mt-3 flex flex-wrap gap-2">
              ${(patient.medicalHistory.chronicDiseases || patient.medicalHistory.conditions || []).slice(0, 2).map(condition => `<span class="px-2 py-1 bg-orange-100 text-orange-700 text-xs rounded-full">${condition}</span>`).join('')}
              ${(patient.medicalHistory.chronicDiseases || patient.medicalHistory.conditions || []).length > 2 ? `<span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded-full">+${(patient.medicalHistory.chronicDiseases || patient.medicalHistory.conditions || []).length - 2} autres</span>` : ''}
            </div>
            
            ${patient.medicalHistory.allergies?.length ? `
            <div class="mt-2 p-2 bg-red-50 rounded">
              <p class="text-xs text-red-700 font-bold">Allergies: ${patient.medicalHistory.allergies.slice(0,3).join(', ')}</p>
            </div>
            ` : ''}
          </div>
        `).join('')}
      </div>
    `;
  }

  function renderEmergencyAccessTab() {
    return `
      <div class="space-y-6">
        <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-lg">
          <h2 class="text-2xl font-bold text-red-800 flex items-center">
            ${icons.emergency} <span class="ml-2">ACC√àS D'URGENCE M√âDICAL</span>
          </h2>
          <p class="text-red-700 mt-2">Recherche rapide par code d'urgence ou nom</p>
        </div>

        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Recherche d'urgence</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Code d'urgence (bracelet)</label>
              <input type="text" placeholder="SYL-XXXXXX" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-lg font-mono" id="emergencyCode">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Nom du patient</label>
              <input type="text" placeholder="Nom ou pr√©nom" class="w-full px-3 py-2 border border-gray-300 rounded-lg" id="emergencyName">
            </div>
          </div>
          <div class="mt-4 flex space-x-4">
            <button class="bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg px-6 py-3 flex items-center gap-2" id="searchEmergency">
              ${icons.search} RECHERCHE D'URGENCE
            </button>
            <button class="bg-orange-600 hover:bg-orange-700 text-white font-bold rounded-lg px-6 py-3 flex items-center gap-2">
              ${icons.phone} APPELER SAMU (15)
            </button>
          </div>
        </div>

        <!-- Patients avec alertes -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">‚ö†Ô∏è Patients avec alertes d'urgence</h3>
          <div class="space-y-3">
            ${patients.filter(p => p.emergencyInfo?.criticalNotes).map(patient => `
              <div class="border-l-4 border-red-500 bg-red-50 p-4 rounded cursor-pointer hover:bg-red-100" data-patient="${patient.id}">
                <div class="flex justify-between items-start">
                  <div>
                    <h4 class="font-bold text-red-800">${patient.personalInfo.firstName} ${patient.personalInfo.lastName}</h4>
                    <p class="text-red-700">${patient.emergencyInfo.criticalNotes}</p>
                    <p class="text-sm text-red-600">Groupe sanguin: ${patient.personalInfo.bloodType || 'Non renseign√©'}</p>
                  </div>
                  <span class="bg-red-600 text-white px-2 py-1 rounded text-xs font-bold">CRITIQUE</span>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      </div>
    `;
  }

  function renderPatientModal(patient) {
    return `
      <div class="fixed inset-0 modal-bg flex items-center justify-center p-4 modal">
        <div class="bg-white rounded-xl max-w-6xl w-full max-h-[95vh] overflow-y-auto shadow-lg">
          <div class="p-6 border-b border-gray-200 flex justify-between items-center">
            <div>
              <h2 class="text-2xl font-bold text-gray-900">${patient.personalInfo.firstName} ${patient.personalInfo.lastName}</h2>
              <p class="text-gray-600">Dossier m√©dical d'urgence complet</p>
            </div>
            <button class="bg-gray-200 text-gray-800 rounded-lg px-4 py-2" id="closeModal">‚úï</button>
          </div>

          <div class="p-6 space-y-6">
            <!-- Informations d'urgence critiques -->
            ${patient.emergencyInfo?.criticalNotes ? `
            <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-lg">
              <h3 class="font-bold text-red-800 mb-2">üö® NOTES CRITIQUES D'URGENCE</h3>
              <p class="text-red-700 font-medium">${patient.emergencyInfo.criticalNotes}</p>
            </div>
            ` : ''}

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <!-- Identit√© -->
              <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4">
                <h3 class="font-semibold text-gray-900 mb-3">üë§ Identit√©</h3>
                <div class="space-y-2 text-sm">
                  <p><strong>N√©(e) le:</strong> ${patient.personalInfo.dateOfBirth}</p>
                  <p><strong>Groupe sanguin:</strong> <span class="bg-red-600 text-white px-2 py-1 rounded font-bold">${patient.personalInfo.bloodType || 'NON RENSEIGN√â'}</span></p>
                  <p><strong>Taille:</strong> ${patient.personalInfo.height} cm</p>
                  <p><strong>Poids:</strong> ${patient.personalInfo.weight} kg</p>
                </div>
              </div>

              <!-- Allergies -->
              <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4">
                <h3 class="font-semibold text-gray-900 mb-3">‚ö†Ô∏è Allergies</h3>
                <div class="space-y-1">
                  ${(patient.medicalHistory.allergies || []).length ? patient.medicalHistory.allergies.map(allergy => `<span class="inline-block px-2 py-1 bg-red-100 text-red-700 text-xs rounded-full mr-2 mb-1">${allergy}</span>`).join('') : '<p class="text-gray-500 text-sm">Aucune allergie connue</p>'}
                </div>
              </div>

              <!-- M√©dicaments -->
              <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4">
                <h3 class="font-semibold text-gray-900 mb-3">üíä Traitements</h3>
                <div class="space-y-1">
                  ${(patient.medicalHistory.medications || []).length ? patient.medicalHistory.medications.map(medication => `<span class="inline-block px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full mr-2 mb-1">${medication}</span>`).join('') : '<p class="text-gray-500 text-sm">Aucun traitement</p>'}
                </div>
              </div>

              <!-- Pathologies -->
              <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4">
                <h3 class="font-semibold text-gray-900 mb-3">üè• Pathologies</h3>
                <div class="space-y-1">
                  ${(patient.medicalHistory.chronicDiseases || patient.medicalHistory.conditions || []).length ? (patient.medicalHistory.chronicDiseases || patient.medicalHistory.conditions).map(condition => `<span class="inline-block px-2 py-1 bg-orange-100 text-orange-700 text-xs rounded-full mr-2 mb-1">${condition}</span>`).join('') : '<p class="text-gray-500 text-sm">Aucune pathologie</p>'}
                </div>
              </div>

              <!-- Contre-indications -->
              <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4">
                <h3 class="font-semibold text-gray-900 mb-3">üö´ Contre-indications</h3>
                <div class="space-y-1">
                  ${(patient.emergencyInfo?.contraindications || []).length ? patient.emergencyInfo.contraindications.map(contra => `<span class="inline-block px-2 py-1 bg-yellow-100 text-yellow-700 text-xs rounded-full mr-2 mb-1">${contra}</span>`).join('') : '<p class="text-gray-500 text-sm">Aucune contre-indication</p>'}
                </div>
              </div>

              <!-- Dispositifs m√©dicaux -->
              <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4">
                <h3 class="font-semibold text-gray-900 mb-3">üîß Dispositifs</h3>
                <div class="space-y-1">
                  ${(patient.medicalHistory.medicalDevices || []).length ? patient.medicalHistory.medicalDevices.map(device => `<span class="inline-block px-2 py-1 bg-purple-100 text-purple-700 text-xs rounded-full mr-2 mb-1">${device}</span>`).join('') : '<p class="text-gray-500 text-sm">Aucun dispositif</p>'}
                </div>
              </div>
            </div>

            <div class="flex justify-end space-x-4">
              <button class="border-2 border-blue-600 text-blue-600 hover:bg-blue-50 font-medium rounded-lg px-4 py-2 flex items-center gap-2" id="editPatient">${icons.edit} Modifier</button>
              <button class="bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg px-4 py-2 flex items-center gap-2">${icons.activity} Nouvelle consultation</button>
              <button class="bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg px-4 py-2 flex items-center gap-2">${icons.emergency} D√©clarer urgence</button>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  function patientsTabEvents(filteredPatients) {
    document.getElementById('searchPatient').oninput = (e) => { searchTerm = e.target.value; render(); };
    document.getElementById('addPatient').onclick = () => showAddPatientModal();
    document.querySelectorAll('[data-patient]').forEach(card => card.onclick = () => {
      selectedPatient = patients.find(p=>p.id===card.getAttribute('data-patient'));
      render();
    });
  }

  function emergencyTabEvents() {
    document.getElementById('searchEmergency').onclick = () => {
      const code = document.getElementById('emergencyCode').value;
      const name = document.getElementById('emergencyName').value;
      
      let foundPatient = null;
      if (code) {
        foundPatient = patients.find(p => p.braceletId === code);
      } else if (name) {
        foundPatient = patients.find(p => 
          p.personalInfo.firstName.toLowerCase().includes(name.toLowerCase()) || 
          p.personalInfo.lastName.toLowerCase().includes(name.toLowerCase())
        );
      }
      
      if (foundPatient) {
        selectedPatient = foundPatient;
        render();
      } else {
        alert('Patient non trouv√©');
      }
    };
    
    document.querySelectorAll('[data-patient]').forEach(card => card.onclick = () => {
      selectedPatient = patients.find(p=>p.id===card.getAttribute('data-patient'));
      render();
    });
  }

  function modalEvents() {
    document.getElementById('closeModal').onclick = () => { selectedPatient = null; render(); };
    if (document.getElementById('editPatient')) {
      document.getElementById('editPatient').onclick = () => showEditPatientModal(selectedPatient);
    }
  }

  function showEditPatientModal(patient) {
    // Modal d'√©dition du patient
    document.getElementById('app').querySelector('.modal').innerHTML = `
      <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto shadow-lg">
        <div class="p-6 border-b border-gray-200 flex justify-between items-center">
          <h2 class="text-2xl font-bold text-gray-900">Modifier ${patient.personalInfo.firstName} ${patient.personalInfo.lastName}</h2>
          <button class="bg-gray-200 text-gray-800 rounded-lg px-4 py-2" id="closeEditModal">‚úï</button>
        </div>
        <div class="p-6 space-y-4">
          <div class="grid grid-cols-2 gap-4">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" id="editFirstName" value="${patient.personalInfo.firstName}" placeholder="Pr√©nom">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" id="editLastName" value="${patient.personalInfo.lastName}" placeholder="Nom">
            <input type="date" class="w-full px-3 py-2 border border-gray-300 rounded-lg" id="editBirth" value="${patient.personalInfo.dateOfBirth}">
            <select class="w-full px-3 py-2 border border-gray-300 rounded-lg" id="editBlood">
              <option value="">Groupe sanguin</option>
              ${MEDICAL_DATA.bloodTypes.map(type => `<option value="${type}" ${patient.personalInfo.bloodType===type?'selected':''}>${type}</option>`).join('')}
            </select>
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" id="editHeight" value="${patient.personalInfo.height}" placeholder="Taille (cm)">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" id="editWeight" value="${patient.personalInfo.weight}" placeholder="Poids (kg)">
          </div>
          <textarea class="w-full px-3 py-2 border border-gray-300 rounded-lg h-20" id="editCriticalNotes" placeholder="Notes critiques d'urgence">${patient.emergencyInfo?.criticalNotes || ''}</textarea>
          <button class="bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg px-6 py-2" id="saveEditPatient">Sauvegarder</button>
        </div>
      </div>
    `;
    document.getElementById('closeEditModal').onclick = () => render();
    document.getElementById('saveEditPatient').onclick = async () => {
      patient.personalInfo.firstName = document.getElementById('editFirstName').value;
      patient.personalInfo.lastName = document.getElementById('editLastName').value;
      patient.personalInfo.dateOfBirth = document.getElementById('editBirth').value;
      patient.personalInfo.bloodType = document.getElementById('editBlood').value;
      patient.personalInfo.height = document.getElementById('editHeight').value;
      patient.personalInfo.weight = document.getElementById('editWeight').value;
      if (!patient.emergencyInfo) patient.emergencyInfo = {};
      patient.emergencyInfo.criticalNotes = document.getElementById('editCriticalNotes').value;
      localStorage.setItem('syl-patients', JSON.stringify(patients));
      
      // Synchronisation Firebase automatique
      await saveToFirebase('patients', patient, patient.id);
      alert('‚úÖ Patient modifi√© et synchronis√© avec Firebase !');
      render();
    };
  }

  function showAddPatientModal() {
    document.body.insertAdjacentHTML('beforeend', `
      <div class="fixed inset-0 modal-bg flex items-center justify-center p-4 modal">
        <div class="bg-white rounded-xl max-w-md w-full overflow-y-auto shadow-lg p-6">
          <h2 class="text-2xl font-bold text-gray-900 mb-4">Nouveau patient</h2>
          <div class="space-y-3">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" id="newFirstName" placeholder="Pr√©nom">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" id="newLastName" placeholder="Nom">
            <input type="date" class="w-full px-3 py-2 border border-gray-300 rounded-lg" id="newBirth">
            <select class="w-full px-3 py-2 border border-gray-300 rounded-lg" id="newBlood">
              <option value="">Groupe sanguin</option>
              ${MEDICAL_DATA.bloodTypes.map(type => `<option value="${type}">${type}</option>`).join('')}
            </select>
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" id="newHeight" placeholder="Taille (cm)">
            <input class="w-full px-3 py-2 border border-gray-300 rounded-lg" id="newWeight" placeholder="Poids (kg)">
          </div>
          <div class="flex space-x-2 mt-4">
            <button class="bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg px-6 py-2" id="saveNewPatient">Ajouter</button>
            <button class="bg-gray-200 text-gray-800 rounded-lg px-6 py-2" id="cancelNewPatient">Annuler</button>
          </div>
        </div>
      </div>
    `);
    document.getElementById('cancelNewPatient').onclick = () => { document.querySelector('.modal').remove(); };
    document.getElementById('saveNewPatient').onclick = async () => {
      const patient = {
        id: Math.random().toString(36).substr(2,9),
        personalInfo: {
          firstName: document.getElementById('newFirstName').value,
          lastName: document.getElementById('newLastName').value,
          dateOfBirth: document.getElementById('newBirth').value,
          bloodType: document.getElementById('newBlood').value,
          height: document.getElementById('newHeight').value,
          weight: document.getElementById('newWeight').value
        },
        medicalHistory: { allergies: [], medications: [], conditions: [], chronicDiseases: [], medicalDevices: [] },
        emergencyInfo: { criticalNotes: '', contraindications: [] },
        lastAccess: new Date().toISOString().split('T')[0],
        isActive: true
      };
      patients.push(patient);
      localStorage.setItem('syl-patients', JSON.stringify(patients));
      
      // Synchronisation Firebase automatique
      await saveToFirebase('patients', patient, patient.id);
      alert('‚úÖ Nouveau patient ajout√© et synchronis√© avec Firebase !');
      document.querySelector('.modal').remove();
      render();
    };
  }
}

// Fonction pour afficher la fiche m√©dicale d'un patient via NFC
async function showPatientMedicalRecord(patientId) {
  // IMPORTANT: Pour permettre l'acc√®s d'urgence depuis n'importe quel appareil,
  // les r√®gles Firebase doivent autoriser la lecture anonyme des collections patients et users
  // 
  // R√àGLES FIRESTORE RECOMMAND√âES :
  /*
  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      // Collection d'acc√®s d'urgence - LECTURE PUBLIQUE
      match /emergency_access/{patientId} {
        allow read: if true;  // ‚ö†Ô∏è ACC√àS PUBLIC pour les urgences
        allow write: if request.auth != null;
      }
      
      // Collections principales - ACC√àS AUTHENTIFI√â
      match /users/{userId} {
        allow read, write: if request.auth != null;
      }
      match /patients/{patientId} {
        allow read, write: if request.auth != null;
      }
    }
  }
  */
  //
  // CONFIGURATION AUTHENTIFICATION :
  // ‚Ä¢ Activer "Authentification anonyme" dans Firebase Console
  // ‚Ä¢ Autoriser les domaines dans les "Domaines autoris√©s"
  //
  
  // D'abord essayer de r√©cup√©rer depuis localStorage
  let patients = JSON.parse(localStorage.getItem('syl-patients') || '[]');
  let patient = patients.find(p => (p.id || p.uid) === patientId);
  
  // Si pas trouv√© localement, essayer de r√©cup√©rer depuis Firebase
  if (!patient && typeof firebase !== 'undefined' && firebase.firestore) {
    console.log('üîç Patient non trouv√© localement, recherche dans Firebase...');
    
    // Afficher un indicateur de chargement
    document.getElementById('app').innerHTML = `
      <div class="min-h-screen bg-blue-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-lg p-8 max-w-md text-center">
          <div class="w-16 h-16 bg-blue-600 rounded-full mx-auto flex items-center justify-center text-white text-2xl mb-4 animate-pulse">
            üîç
          </div>
          <h2 class="text-xl font-bold text-blue-600 mb-2">Recherche du patient...</h2>
          <p class="text-gray-600 mb-4">R√©cup√©ration des donn√©es m√©dicales depuis la base de donn√©es</p>
          <div class="animate-pulse bg-gray-200 h-2 rounded mb-4"></div>
          <p class="text-sm text-gray-500">ID: ${patientId}</p>
        </div>
      </div>
    `;
    
    try {
      const db = firebase.firestore();
      
      // Essayer d'abord une authentification anonyme pour les acc√®s d'urgence
      if (!firebase.auth().currentUser) {
        console.log('üöë Authentification anonyme pour acc√®s d\'urgence...');
        try {
          await firebase.auth().signInAnonymously();
          console.log('‚úÖ Authentification anonyme r√©ussie');
        } catch (authError) {
          console.log('‚ö†Ô∏è √âchec authentification anonyme:', authError.message);
          // Continuer quand m√™me, peut-√™tre que les r√®gles permettent l'acc√®s
        }
      }
      
      // Chercher dans la collection users
      const userDoc = await db.collection('users').doc(patientId).get();
      if (userDoc.exists) {
        const userData = userDoc.data();
        console.log('üë§ Donn√©es utilisateur trouv√©es dans Firebase');
        
        // Chercher les donn√©es m√©dicales associ√©es
        const medicalDoc = await db.collection('patients').doc(patientId).get();
        const medicalData = medicalDoc.exists ? medicalDoc.data() : {};
        
        // Fusionner les donn√©es
        patient = {
          id: patientId,
          uid: patientId,
          email: userData.email,
          role: userData.role,
          personalInfo: medicalData.personalInfo || userData.personalInfo || {},
          medicalHistory: medicalData.medicalHistory || {},
          emergencyInfo: medicalData.emergencyInfo || {},
          isActive: userData.isActive !== false
        };
        
        console.log('‚úÖ Patient reconstitu√© depuis Firebase:', patient.personalInfo?.firstName, patient.personalInfo?.lastName);
      } else {
        console.log('‚ùå Patient non trouv√© dans Firebase users');
        
        // Essayer directement dans la collection patients comme fallback
        console.log('üîÑ Tentative de recherche directe dans collection patients...');
        const directPatientDoc = await db.collection('patients').doc(patientId).get();
        if (directPatientDoc.exists) {
          const patientData = directPatientDoc.data();
          patient = {
            id: patientId,
            uid: patientId,
            ...patientData
          };
          console.log('‚úÖ Patient trouv√© directement dans collection patients');
        } else {
          // Derni√®re tentative : chercher dans une collection publique d'urgence
          console.log('üöë Recherche dans collection emergency_access...');
          try {
            const emergencyDoc = await db.collection('emergency_access').doc(patientId).get();
            if (emergencyDoc.exists) {
              const emergencyData = emergencyDoc.data();
              patient = {
                id: patientId,
                uid: patientId,
                personalInfo: emergencyData.personalInfo || {},
                medicalHistory: emergencyData.medicalHistory || {},
                emergencyInfo: emergencyData.emergencyInfo || {},
                isActive: true
              };
              console.log('‚úÖ Patient trouv√© dans collection emergency_access');
            }
          } catch (emergencyError) {
            console.log('‚ùå Collection emergency_access non accessible:', emergencyError.message);
          }
        }
      }
    } catch (error) {
      console.error('Erreur Firebase lors de la recherche du patient:', error);
      
      // Afficher l'erreur sp√©cifique pour le debug
      document.getElementById('app').innerHTML = `
        <div class="min-h-screen bg-orange-50 flex items-center justify-center">
          <div class="bg-white rounded-lg shadow-lg p-8 max-w-md text-center">
            <div class="w-16 h-16 bg-orange-600 rounded-full mx-auto flex items-center justify-center text-white text-2xl mb-4">
              ‚ö†Ô∏è
            </div>
            <h2 class="text-xl font-bold text-orange-600 mb-2">Erreur d'acc√®s Firebase</h2>
            <p class="text-gray-600 mb-4">Impossible d'acc√©der √† la base de donn√©es</p>
            <div class="text-sm text-left bg-gray-100 rounded p-3 mb-4">
              <strong>Erreur:</strong> ${error.message}<br>
              <strong>Code:</strong> ${error.code || 'N/A'}<br>
              <strong>ID Patient:</strong> ${patientId}
            </div>
            <div class="text-xs text-gray-500 mb-4">
              Cette erreur indique probablement un probl√®me de configuration Firebase ou de r√®gles de s√©curit√©.
            </div>
            <button onclick="location.href='${window.location.pathname}'" class="bg-blue-600 hover:bg-blue-700 text-white rounded px-4 py-2">
              Retour √† l'application
            </button>
          </div>
        </div>
      `;
      return; // Arr√™ter ici pour afficher l'erreur
    }
  }
  
  if (!patient) {
    document.getElementById('app').innerHTML = `
      <div class="min-h-screen bg-red-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-lg p-8 max-w-md text-center">
          <div class="w-16 h-16 bg-red-600 rounded-full mx-auto flex items-center justify-center text-white text-2xl mb-4">
            ‚ùå
          </div>
          <h2 class="text-xl font-bold text-red-600 mb-2">Patient non trouv√©</h2>
          <p class="text-gray-600 mb-4">L'ID patient "${patientId}" n'existe pas dans la base de donn√©es.</p>
          <div class="text-sm text-gray-500 mb-4">
            <p>Causes possibles :</p>
            <ul class="text-left mt-2 space-y-1">
              <li>‚Ä¢ Tag NFC non synchronis√©</li>
              <li>‚Ä¢ Patient supprim√© de la base</li>
              <li>‚Ä¢ Probl√®me de connexion r√©seau</li>
            </ul>
          </div>
          <button onclick="location.href='${window.location.pathname}'" class="bg-blue-600 hover:bg-blue-700 text-white rounded px-4 py-2">
            Retour √† l'application
          </button>
        </div>
      </div>
    `;
    return;
  }
  
  // Calculer l'√¢ge
  const calculateAge = (birthDate) => {
    if (!birthDate) return 'N/A';
    const today = new Date();
    const birth = new Date(birthDate);
    let age = today.getFullYear() - birth.getFullYear();
    const monthDiff = today.getMonth() - birth.getMonth();
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
      age--;
    }
    return age + ' ans';
  };
  
  // Afficher la fiche d'information m√©dicale d'urgence (lecture seule)
  document.getElementById('app').innerHTML = `
    <div class="min-h-screen bg-gradient-to-br from-red-50 to-pink-100">
      <!-- En-t√™te d'urgence -->
      <div class="bg-red-600 text-white py-4">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="flex items-center justify-between">
            <div class="flex items-center">
              <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center text-red-600 font-bold mr-4">
                üöë
              </div>
              <div>
                <h1 class="text-2xl font-bold">FICHE M√âDICALE D'URGENCE</h1>
                <p class="text-red-100">Informations vitales - Acc√®s via NFC</p>
              </div>
            </div>
            <button onclick="location.href='${window.location.pathname}'" class="bg-red-700 hover:bg-red-800 text-white rounded-lg px-4 py-2">
              Fermer
            </button>
          </div>
        </div>
      </div>
      
      <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Identification du patient -->
        <div class="bg-white rounded-xl shadow-xl border-2 border-red-200 p-6 mb-6">
          <div class="text-center mb-6">
            <h2 class="text-3xl font-bold text-gray-900 mb-2">
              ${patient.personalInfo?.firstName || ''} ${patient.personalInfo?.lastName || ''}
            </h2>
            <div class="inline-flex items-center px-4 py-2 bg-blue-100 rounded-full">
              <span class="text-blue-800 font-medium">√Çge: ${calculateAge(patient.personalInfo?.dateOfBirth)}</span>
            </div>
          </div>
          
          <!-- Informations vitales en grand -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="text-center p-4 bg-red-50 rounded-xl border-2 border-red-200">
              <div class="text-2xl font-bold text-red-600 mb-1">${patient.personalInfo?.bloodType || '?'}</div>
              <div class="text-sm font-medium text-gray-700">Groupe sanguin</div>
            </div>
            <div class="text-center p-4 bg-blue-50 rounded-xl border-2 border-blue-200">
              <div class="text-2xl font-bold text-blue-600 mb-1">${patient.personalInfo?.height || '?'}</div>
              <div class="text-sm font-medium text-gray-700">Taille (cm)</div>
            </div>
            <div class="text-center p-4 bg-green-50 rounded-xl border-2 border-green-200">
              <div class="text-2xl font-bold text-green-600 mb-1">${patient.personalInfo?.weight || '?'}</div>
              <div class="text-sm font-medium text-gray-700">Poids (kg)</div>
            </div>
            <div class="text-center p-4 bg-purple-50 rounded-xl border-2 border-purple-200">
              <div class="text-2xl font-bold text-purple-600 mb-1">${patient.personalInfo?.dateOfBirth || '?'}</div>
              <div class="text-sm font-medium text-gray-700">Naissance</div>
            </div>
          </div>
        </div>
        
        ${patient.emergencyInfo?.criticalNotes ? `
        <!-- ALERTE CRITIQUE -->
        <div class="bg-red-600 text-white rounded-xl p-6 mb-6 border-4 border-red-700">
          <div class="flex items-center mb-3">
            <span class="text-3xl mr-3">‚ö†Ô∏è</span>
            <h3 class="text-xl font-bold">ALERTE M√âDICALE CRITIQUE</h3>
          </div>
          <p class="text-lg font-medium">${patient.emergencyInfo.criticalNotes}</p>
        </div>
        ` : ''}
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- ALLERGIES -->
          <div class="bg-white rounded-xl shadow-lg border-l-4 border-red-500 p-6">
            <h3 class="text-xl font-bold text-red-600 mb-4 flex items-center">
              <span class="text-2xl mr-2">‚ö†Ô∏è</span> ALLERGIES
            </h3>
            ${patient.medicalHistory?.allergies?.length ? 
              patient.medicalHistory.allergies.map(allergy => `
                <div class="bg-red-100 border-2 border-red-300 rounded-lg px-4 py-3 mb-2">
                  <span class="text-red-800 font-bold text-lg">${allergy}</span>
                </div>
              `).join('') : 
              '<div class="bg-gray-100 rounded-lg px-4 py-3 text-gray-600 font-medium">Aucune allergie connue</div>'
            }
          </div>
          
          <!-- M√âDICAMENTS -->
          <div class="bg-white rounded-xl shadow-lg border-l-4 border-blue-500 p-6">
            <h3 class="text-xl font-bold text-blue-600 mb-4 flex items-center">
              <span class="text-2xl mr-2">üíä</span> M√âDICAMENTS
            </h3>
            ${patient.medicalHistory?.medications?.length ? 
              patient.medicalHistory.medications.map(medication => `
                <div class="bg-blue-100 border-2 border-blue-300 rounded-lg px-4 py-3 mb-2">
                  <span class="text-blue-800 font-medium">${medication}</span>
                </div>
              `).join('') : 
              '<div class="bg-gray-100 rounded-lg px-4 py-3 text-gray-600 font-medium">Aucun m√©dicament</div>'
            }
          </div>
          
          <!-- PATHOLOGIES -->
          <div class="bg-white rounded-xl shadow-lg border-l-4 border-orange-500 p-6">
            <h3 class="text-xl font-bold text-orange-600 mb-4 flex items-center">
              <span class="text-2xl mr-2">üè•</span> PATHOLOGIES
            </h3>
            ${patient.medicalHistory?.chronicDiseases?.length ? 
              patient.medicalHistory.chronicDiseases.map(disease => `
                <div class="bg-orange-100 border-2 border-orange-300 rounded-lg px-4 py-3 mb-2">
                  <span class="text-orange-800 font-medium">${disease}</span>
                </div>
              `).join('') : 
              '<div class="bg-gray-100 rounded-lg px-4 py-3 text-gray-600 font-medium">Aucune pathologie connue</div>'
            }
          </div>
          
          <!-- CONTACT D'URGENCE -->
          <div class="bg-white rounded-xl shadow-lg border-l-4 border-green-500 p-6">
            <h3 class="text-xl font-bold text-green-600 mb-4 flex items-center">
              <span class="text-2xl mr-2">üìû</span> CONTACT D'URGENCE
            </h3>
            ${patient.personalInfo?.emergencyContact?.name ? `
              <div class="bg-green-100 border-2 border-green-300 rounded-lg px-4 py-3 mb-3">
                <div class="font-bold text-green-800 text-lg">${patient.personalInfo.emergencyContact.name}</div>
                <div class="text-green-700">${patient.personalInfo.emergencyContact.relationship || ''}</div>
              </div>
            ` : ''}
            ${patient.personalInfo?.emergencyContact?.phone ? `
              <a href="tel:${patient.personalInfo.emergencyContact.phone}" 
                 class="block w-full bg-green-600 hover:bg-green-700 text-white text-center rounded-lg px-4 py-3 font-bold text-lg">
                üìû ${patient.personalInfo.emergencyContact.phone}
              </a>
            ` : '<div class="bg-gray-100 rounded-lg px-4 py-3 text-gray-600 font-medium">Aucun contact d\'urgence</div>'}
          </div>
        </div>
        
        <!-- ACTIONS D'URGENCE -->
        <div class="mt-6 bg-white rounded-xl shadow-xl border-2 border-red-300 p-6">
          <h3 class="text-2xl font-bold text-red-600 mb-4 text-center">üö® NUM√âROS D'URGENCE</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <a href="tel:15" class="block bg-red-600 hover:bg-red-700 text-white text-center rounded-xl px-6 py-4 font-bold text-lg transition-colors">
              <div class="text-2xl mb-1">üöë</div>
              <div>SAMU</div>
              <div class="text-xl">15</div>
            </a>
            <a href="tel:18" class="block bg-orange-600 hover:bg-orange-700 text-white text-center rounded-xl px-6 py-4 font-bold text-lg transition-colors">
              <div class="text-2xl mb-1">üöí</div>
              <div>POMPIERS</div>
              <div class="text-xl">18</div>
            </a>
            <a href="tel:112" class="block bg-blue-600 hover:bg-blue-700 text-white text-center rounded-xl px-6 py-4 font-bold text-lg transition-colors">
              <div class="text-2xl mb-1">üÜò</div>
              <div>URGENCES</div>
              <div class="text-xl">112</div>
            </a>
          </div>
        </div>
        
        <!-- Footer informatif -->
        <div class="mt-6 text-center text-gray-500 text-sm">
          <p>üìã Fiche d'information m√©dicale ‚Ä¢ Consultation seule ‚Ä¢ ${new Date().toLocaleString('fr-FR')}</p>
          <p class="mt-1">üîí Donn√©es sensibles - Usage strictement m√©dical</p>
        </div>
      </div>
    </div>
  `;
  
  // Enregistrer l'acc√®s
  SYLAnalytics.trackEvent('patient_medical_access', { 
    patientId: patient.id || patient.uid, 
    accessMethod: 'nfc_link',
    accessTime: new Date().toISOString()
  });
}

// ----------- MAIN -----------
function renderApp() {
  console.log("renderApp appellee");
  
  try {
    // PRIORIT√â 1: V√©rifier d'abord si on est en mode acc√®s d'urgence
    const urlParams = new URLSearchParams(window.location.search);
    const patientId = urlParams.get('patient');
    const accessType = urlParams.get('access');
    
    if (patientId && accessType === 'medical') {
      console.log('üöë Mode acc√®s fiche m√©dicale prioritaire:', patientId);
      showPatientMedicalRecord(patientId);
      return; // Arr√™ter ici pour √©viter d'√©craser l'affichage
    }
    
    // V√©rifier que Firebase est charg√©
    if (typeof firebase === 'undefined') {
      console.error("Firebase n'est pas charge");
      showLogin();
      return;
    }
    
    // R√©cup√©rer l'utilisateur local
    const localUser = getUser();
    
    if (localUser) {
      console.log("Utilisateur connect√©, r√¥le:", localUser.role);
      if (localUser.role === 'patient') {
        renderPatientDashboard(localUser);
      } else if (localUser.role === 'medecin') {
        renderMedecinDashboard(localUser);
      } else if (localUser.role === 'admin') {
        renderAdminDashboard(localUser);
      } else {
        console.error("R√¥le utilisateur inconnu:", localUser.role);
        clearUser();
        showLogin();
      }
    } else {
      // Pas d'utilisateur connect√©
      console.log("Redirection vers login");
      showLogin();
    }
  } catch (error) {
    console.error("Erreur dans renderApp:", error);
    showLogin();
  }
}

// Fonction de d√©connexion mise √† jour
function logout() {
  try {
    if (auth && typeof auth.signOut === 'function') {
      auth.signOut().then(() => {
        clearUser();
        renderApp();
      }).catch((error) => {
        console.error('Erreur de d√©connexion Firebase:', error);
        clearUser();
        renderApp();
      });
    } else {
      // D√©connexion locale seulement
      clearUser();
      renderApp();
    }
  } catch (error) {
    console.error('Erreur de d√©connexion:', error);
    clearUser();
    renderApp();
  }
}

// Am√©lioration des performances - Debounce pour les sauvegardes
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// Sauvegarde automatique avec debounce
const autoSave = debounce((data) => {
  localStorage.setItem('syl-medicalData', JSON.stringify(data));
  console.log('üîÑ Sauvegarde automatique effectu√©e');
}, 2000);

// Monitoring et analytics basiques
class SYLAnalytics {
  static init() {
    this.startTime = Date.now();
    this.trackEvent('app_start');
  }
  
  static trackEvent(eventName, data = {}) {
    const event = {
      name: eventName,
      timestamp: new Date().toISOString(),
      data: data,
      sessionId: this.getSessionId()
    };
    
    const events = JSON.parse(localStorage.getItem('syl-analytics') || '[]');
    events.push(event);
    
    // Garder seulement les 100 derniers √©v√©nements
    if (events.length > 100) {
      events.splice(0, events.length - 100);
    }
    
    localStorage.setItem('syl-analytics', JSON.stringify(events));
  }
  
  static getSessionId() {
    if (!this.sessionId) {
      this.sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }
    return this.sessionId;
  }
}

// V√©rification de la sant√© de l'application
class HealthChecker {
  static checkSystemHealth() {
    const checks = [];
    
    // V√©rifier localStorage
    try {
      localStorage.setItem('test', 'test');
      localStorage.removeItem('test');
      checks.push({ name: 'localStorage', status: 'OK' });
    } catch (e) {
      checks.push({ name: 'localStorage', status: 'ERREUR', error: e.message });
    }
    
    // V√©rifier Firebase
    try {
      if (firebase.app()) {
        checks.push({ name: 'Firebase', status: 'OK' });
      }
    } catch (e) {
      checks.push({ name: 'Firebase', status: 'ERREUR', error: e.message });
    }
    
    // V√©rifier les API du navigateur
    checks.push({ 
      name: 'G√©olocalisation', 
      status: navigator.geolocation ? 'OK' : 'NON SUPPORT√â' 
    });
    
    checks.push({ 
      name: 'Notifications', 
      status: 'Notification' in window ? 'OK' : 'NON SUPPORT√â' 
    });
    
    checks.push({ 
      name: 'Service Worker', 
      status: 'serviceWorker' in navigator ? 'OK' : 'NON SUPPORT√â' 
    });
    
    return checks;
  }
  
  static displayHealthStatus() {
    const checks = this.checkSystemHealth();
    console.group('üè• √âtat de sant√© SYL Medical');
    checks.forEach(check => {
      const icon = check.status === 'OK' ? '‚úÖ' : check.status === 'NON SUPPORT√â' ? '‚ö†Ô∏è' : '‚ùå';
      console.log(`${icon} ${check.name}: ${check.status}${check.error ? ` (${check.error})` : ''}`);
    });
    console.groupEnd();
  }
}

// Initialisation am√©lior√©e
document.addEventListener('DOMContentLoaded', () => {
  // PRIORIT√â ABSOLUE: V√©rifier d'abord les modes d'acc√®s d'urgence
  const urlParams = new URLSearchParams(window.location.search);
  const nfcTagId = urlParams.get('nfc') || urlParams.get('tag');
  const patientId = urlParams.get('patient');
  const accessType = urlParams.get('access');
  
  // Mode acc√®s fiche m√©dicale patient (priorit√© absolue)
  if (patientId && accessType === 'medical') {
    console.log('üöë MODE URGENCE: Acc√®s fiche m√©dicale patient d√©tect√©:', patientId);
    
    // Essayer imm√©diatement, puis avec d√©lai si Firebase n'est pas pr√™t
    showPatientMedicalRecord(patientId).catch(() => {
      console.log('‚è≥ Premi√®re tentative √©chou√©e, attente Firebase...');
      setTimeout(() => {
        showPatientMedicalRecord(patientId);
      }, 2000);
    });
    
    return; // Arr√™t complet pour √©viter toute interf√©rence
  }
  
  // Mode acc√®s NFC d'urgence
  if (nfcTagId) {
    console.log('üöë MODE URGENCE: Acc√®s d\'urgence d√©tect√© pour tag:', nfcTagId);
    SYLUtilities.handleNFCAccess(nfcTagId).catch(error => {
      console.error('Erreur acc√®s NFC:', error);
    });
    return; // Ne pas initialiser l'interface normale
  }
  
  // Initialiser les syst√®mes normaux seulement si pas en mode urgence
  SYLAnalytics.init();
  ReminderSystem.init();
  HealthChecker.displayHealthStatus();
  
  // √âcouter les √©v√©nements NFC si support√©
  if ('NDEFReader' in window) {
    try {
      const ndef = new NDEFReader();
      ndef.addEventListener('reading', ({ message }) => {
        const tagId = message.records[0]?.data ? new TextDecoder().decode(message.records[0].data) : null;
        if (tagId && (tagId.startsWith('SYL_') || tagId.startsWith('NFC_'))) {
          console.log('üè∑Ô∏è Tag NFC SYL d√©tect√©:', tagId);
          SYLUtilities.handleNFCAccess(tagId);
        }
      });
      
      // D√©marrer la lecture NFC automatiquement
      ndef.scan().then(() => {
        console.log('üì° Lecteur NFC activ√©');
      }).catch(error => {
        console.log('‚ùå Impossible d\'activer le lecteur NFC:', error.message);
      });
    } catch (error) {
      console.log('‚ö†Ô∏è API NFC non disponible:', error.message);
    }
  }
  
  // V√©rifier les mises √† jour p√©riodiquement
  setInterval(() => {
    HealthChecker.displayHealthStatus();
  }, 300000); // Toutes les 5 minutes
  
  // Afficher les informations de version
  console.log('%cüè• SYL Medical v2.1 Admin Enhanced', 'color: #3B82F6; font-size: 16px; font-weight: bold;');
  console.log('Nouvelles fonctionnalit√©s Admin:');
  console.log('‚Ä¢ üë®‚Äç  Tableau de bord administrateur');
  console.log('‚Ä¢ üè∑Ô∏è Gestion des tags NFC');
  console.log('‚Ä¢ üîó Association patient-NFC');
  console.log('‚Ä¢ üöë Acc√®s d\'urgence par NFC');
  console.log('‚Ä¢   Analytics et monitoring');
  console.log('‚Ä¢ üîç Recherche et filtrage patients');
});

// Init - Attendre que Firebase soit pr√™t avec timeout
let authInitialized = false;

firebase.auth().onAuthStateChanged((user) => {
  console.log("Auth state changed:", user ? "connect√©" : "d√©connect√©");
  authInitialized = true;
  
  // V√©rifier d'abord si on est en mode urgence avant de rendre l'app normale
  const urlParams = new URLSearchParams(window.location.search);
  const patientId = urlParams.get('patient');
  const accessType = urlParams.get('access');
  const nfcTagId = urlParams.get('nfc') || urlParams.get('tag');
  
  if ((patientId && accessType === 'medical') || nfcTagId) {
    console.log("üöë Mode urgence d√©tect√© - √©viter renderApp()");
    return; // Ne pas appeler renderApp() en mode urgence
  }
  
  renderApp();
  
  // Initialiser la synchronisation temps r√©el Firestore
  setTimeout(async () => {
    try {
      console.log("üî• Initialisation du syst√®me temps r√©el");
      await initRealtimeSync();
    } catch (err) {
      console.log("Erreur init temps r√©el:", err);
    }
  }, 2000); // Attendre 2 secondes apr√®s le rendu
  
  // D√©marrer la synchronisation automatique apr√®s le rendu (avec d√©lai)
  setTimeout(async () => {
    try {
      console.log("üöÄ D√©marrage de la premi√®re auto-synchronisation");
      await window.autoSyncPatients();
    } catch (err) {
      console.log("Premi√®re auto-sync √©chou√©e:", err);
    }
  }, 3000); // Attendre 3 secondes apr√®s le rendu
});

// Timeout de s√©curit√© si Firebase ne r√©pond pas
setTimeout(() => {
  if (!authInitialized) {
    // V√©rifier d'abord si on est en mode urgence
    const urlParams = new URLSearchParams(window.location.search);
    const patientId = urlParams.get('patient');
    const accessType = urlParams.get('access');
    const nfcTagId = urlParams.get('nfc') || urlParams.get('tag');
    
    if ((patientId && accessType === 'medical') || nfcTagId) {
      console.log("üöë Mode urgence d√©tect√© - pas de timeout");
      return;
    }
    
    console.log("Timeout Firebase - Chargement forc√© de l'interface");
    showLogin();
  }
}, 5000); // 5 secondes

// Test imm√©diat si Firebase est d√©j√† pr√™t
if (firebase.auth().currentUser !== undefined) {
  // V√©rifier d'abord si on est en mode urgence
  const urlParams = new URLSearchParams(window.location.search);
  const patientId = urlParams.get('patient');
  const accessType = urlParams.get('access');
  const nfcTagId = urlParams.get('nfc') || urlParams.get('tag');
  
  if ((patientId && accessType === 'medical') || nfcTagId) {
    console.log("üöë Mode urgence d√©tect√© - pas de renderApp() imm√©diat");
  } else {
    console.log("Firebase d√©j√† pr√™t");
    renderApp();
  }
}

// ========== NOUVELLES FONCTIONS SIMPLIFI√âES ==========

// Dashboard patient simplifi√© (sans NFC)
function showPatientDashboard() {
  const user = getUser();
  if (!user || user.role !== USER_TYPES.PATIENT) {
    showLogin();
    return;
  }

  document.getElementById('app').innerHTML = `
    <div class="min-h-screen bg-gray-50">
      <!-- Header Patient -->
      <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="flex justify-between items-center h-16">
            <div class="flex items-center">
              <div class="w-10 h-10 bg-gradient-to-r from-blue-600 to-green-600 rounded-full flex items-center justify-center mr-3">
                ${icons.heart}
              </div>
              <div>
                <h1 class="text-xl font-semibold text-gray-900">SYL Medical</h1>
                <p class="text-sm text-gray-500">Mon espace patient</p>
              </div>
            </div>
            <div class="flex items-center space-x-4">
              <div class="text-right">
                <p class="text-sm font-medium text-gray-900">${user.personalInfo.firstName} ${user.personalInfo.lastName}</p>
                <p class="text-xs text-gray-500">${user.email}</p>
              </div>
              <button onclick="logout()" class="text-gray-500 hover:text-red-600">
                ${icons.logout}
              </button>
            </div>
          </div>
        </div>
      </header>

      <!-- Navigation simplifi√©e -->
      <nav class="bg-white border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="flex space-x-8" id="patientTabs">
            <button class="py-4 px-1 border-b-2 border-blue-500 text-blue-600 font-medium text-sm" data-tab="overview">
              ${icons.activity} Vue d'ensemble
            </button>
            <button class="py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm" data-tab="medical">
              ${icons.medical} Mes donn√©es m√©dicales
            </button>
            <button class="py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm" data-tab="emergency">
              ${icons.emergency} Ma fiche d'urgence
            </button>
            <button class="py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm" data-tab="profile">
              ${icons.settings} Mon profil
            </button>
          </div>
        </div>
      </nav>

      <!-- Contenu principal -->
      <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div id="patientContent">
          <!-- Le contenu sera charg√© ici -->
        </div>
      </main>
    </div>

    <!-- Chat m√©dical simplifi√© -->
    <div id="medicalChatBot" class="fixed bottom-6 right-6 z-50">
      <button id="chatToggle" class="bg-green-600 hover:bg-green-700 text-white rounded-full p-4 shadow-lg transition-all duration-200 transform hover:scale-105">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
        </svg>
      </button>
      <div id="chatWindow" class="hidden absolute bottom-16 right-0 w-80 h-96 bg-white rounded-lg shadow-xl border border-gray-200">
        <div class="bg-green-600 text-white p-4 rounded-t-lg">
          <h3 class="font-semibold">Assistant M√©dical SYL</h3>
          <p class="text-sm opacity-90">Je vous aide √† compl√©ter votre fiche</p>
        </div>
        <div id="chatMessages" class="p-4 h-64 overflow-y-auto">
          <div class="text-sm text-gray-600 mb-4">
            üë®‚Äç‚öïÔ∏è Bonjour ! Je vais vous aider √† compl√©ter votre fiche m√©dicale. Je peux vous poser des questions sur :
            <ul class="mt-2 space-y-1 text-xs">
              <li>ü©∏ Votre groupe sanguin</li>
              <li>üíä Vos m√©dicaments actuels</li>
              <li>üö´ Vos allergies</li>
              <li>üè• Vos ant√©c√©dents m√©dicaux</li>
              <li>üìû Votre contact d'urgence</li>
            </ul>
            <p class="mt-3 text-xs text-green-600">Tapez "commencer" pour d√©buter l'√©valuation m√©dicale</p>
          </div>
        </div>
        <div class="p-4 border-t">
          <div class="flex space-x-2">
            <input type="text" id="chatInput" placeholder="Tapez 'commencer' ou votre question..." 
              class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500"/>
            <button id="chatSend" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
              ${icons.arrow}
            </button>
          </div>
        </div>
      </div>
    </div>
  `;

  // Initialisation des onglets
  initSimplePatientTabs();
  
  // Initialisation du chat m√©dical
  initMedicalChatBot();
  
  // Charger la vue d'ensemble par d√©faut
  showPatientOverview();
}

// Gestion des onglets simplifi√©e
function initSimplePatientTabs() {
  const tabs = document.querySelectorAll('#patientTabs button');
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      // Reset tous les onglets
      tabs.forEach(t => {
        t.classList.remove('border-blue-500', 'text-blue-600');
        t.classList.add('border-transparent', 'text-gray-500');
      });
      
      // Activer l'onglet cliqu√©
      tab.classList.remove('border-transparent', 'text-gray-500');
      tab.classList.add('border-blue-500', 'text-blue-600');
      
      // Charger le contenu correspondant
      const tabName = tab.getAttribute('data-tab');
      switch(tabName) {
        case 'overview':
          showPatientOverview();
          break;
        case 'medical':
          showSimpleMedicalForm();
          break;
        case 'emergency':
          showEmergencyCard();
          break;
        case 'profile':
          showProfileForm();
          break;
      }
    });
  });
}

// Vue d'ensemble simplifi√©e
function showPatientOverview() {
  const user = getUser();
  const content = document.getElementById('patientContent');
  
  const completedFields = calculateCompletionFields(user);
  const completionPercentage = Math.round((completedFields.completed / completedFields.total) * 100);
  
  content.innerHTML = `
    <div class="space-y-6">
      <!-- R√©sum√© de progression -->
      <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">üëã Bienvenue, ${user.personalInfo.firstName}</h2>
        
        <div class="bg-blue-50 p-4 rounded-lg mb-6">
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm font-medium text-blue-700">Compl√©tude de votre fiche m√©dicale</span>
            <span class="text-sm font-bold text-blue-700">${completionPercentage}%</span>
          </div>
          <div class="w-full bg-blue-200 rounded-full h-2">
            <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: ${completionPercentage}%"></div>
          </div>
          <p class="text-xs text-blue-600 mt-2">${completedFields.completed}/${completedFields.total} informations renseign√©es</p>
        </div>

        <!-- Actions rapides -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <button onclick="document.querySelector('[data-tab=medical]').click()" 
            class="p-4 border border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors text-left">
            <div class="text-blue-600 text-2xl mb-2">${icons.medical}</div>
            <h3 class="font-medium text-gray-900">Compl√©ter mes donn√©es</h3>
            <p class="text-sm text-gray-600">Allergies, m√©dicaments, ant√©c√©dents</p>
          </button>
          
          <button onclick="document.querySelector('[data-tab=emergency]').click()" 
            class="p-4 border border-gray-200 rounded-lg hover:border-red-500 hover:bg-red-50 transition-colors text-left">
            <div class="text-red-600 text-2xl mb-2">${icons.emergency}</div>
            <h3 class="font-medium text-gray-900">Ma fiche d'urgence</h3>
            <p class="text-sm text-gray-600">Visualiser et t√©l√©charger</p>
          </button>
          
          <button onclick="document.querySelector('[data-tab=profile]').click()" 
            class="p-4 border border-gray-200 rounded-lg hover:border-green-500 hover:bg-green-50 transition-colors text-left">
            <div class="text-green-600 text-2xl mb-2">${icons.user}</div>
            <h3 class="font-medium text-gray-900">Mon profil</h3>
            <p class="text-sm text-gray-600">Informations personnelles</p>
          </button>
        </div>
      </div>

      <!-- Informations importantes -->
      <div class="bg-green-50 border-l-4 border-green-400 p-4 rounded">
        <div class="flex">
          <div class="flex-shrink-0">
            <div class="text-green-400 text-xl">${icons.check}</div>
          </div>
          <div class="ml-3">
            <h3 class="text-sm font-medium text-green-800">Vos donn√©es sont s√©curis√©es</h3>
            <div class="mt-2 text-sm text-green-700">
              <ul class="list-disc pl-5 space-y-1">
                <li>Chiffrement bout-√†-bout de vos donn√©es m√©dicales</li>
                <li>Acc√®s d'urgence possible via QR Code personnel</li>
                <li>Conformit√© RGPD et respect de votre vie priv√©e</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
}

// Chat m√©dical sp√©cialis√©
function initMedicalChatBot() {
  const chatToggle = document.getElementById('chatToggle');
  const chatWindow = document.getElementById('chatWindow');
  const chatInput = document.getElementById('chatInput');
  const chatSend = document.getElementById('chatSend');

  chatToggle.addEventListener('click', () => {
    chatWindow.classList.toggle('hidden');
  });

  const sendMessage = () => {
    const message = chatInput.value.trim().toLowerCase();
    if (!message) return;

    // Ajouter le message de l'utilisateur
    addMedicalChatMessage(chatInput.value, 'user');
    chatInput.value = '';

    // G√©n√©rer une r√©ponse m√©dicale sp√©cialis√©e
    setTimeout(() => {
      const response = generateMedicalResponse(message);
      addMedicalChatMessage(response, 'bot');
    }, 1000);
  };

  chatSend.addEventListener('click', sendMessage);
  chatInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage();
  });
}

function addMedicalChatMessage(message, sender) {
  const chatMessages = document.getElementById('chatMessages');
  const messageDiv = document.createElement('div');
  messageDiv.className = `mb-3 ${sender === 'user' ? 'text-right' : 'text-left'}`;
  
  messageDiv.innerHTML = `
    <div class="${sender === 'user' ? 'bg-green-600 text-white ml-8' : 'bg-gray-100 text-gray-800 mr-8'} 
                rounded-lg px-3 py-2 text-sm inline-block">
      ${message}
    </div>
  `;
  
  chatMessages.appendChild(messageDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

function generateMedicalResponse(message) {
  const medicalQuestions = {
    'commencer': `Parfait ! Commen√ßons par quelques questions essentielles :

ü©∏ **Connaissez-vous votre groupe sanguin ?** (A+, A-, B+, B-, AB+, AB-, O+, O-)

Tapez votre groupe sanguin ou "je ne sais pas"`,

    'groupe sanguin': 'Excellent ! Votre groupe sanguin est crucial en cas d\'urgence. Maintenant, **prenez-vous actuellement des m√©dicaments ?** Si oui, listez-les avec leur dosage.',

    'medicament': `Merci pour ces informations. Maintenant, **avez-vous des allergies ?** 

Les allergies courantes incluent :
‚Ä¢ P√©nicilline, Aspirine
‚Ä¢ Arachides, Fruits de mer
‚Ä¢ Latex, Iode
‚Ä¢ Autres m√©dicaments

Listez toutes vos allergies connues.`,

    'allergie': `Important ! Vos allergies sont not√©es. **Avez-vous des ant√©c√©dents m√©dicaux ou conditions chroniques ?**

Exemples : Diab√®te, Hypertension, Asthme, √âpilepsie, etc.`,

    'antecedent': `Tr√®s bien. **Qui dois-je contacter en cas d'urgence ?**

Donnez-moi :
‚Ä¢ Nom complet
‚Ä¢ Relation (conjoint, parent, ami...)
‚Ä¢ Num√©ro de t√©l√©phone`,

    'contact': `Excellent ! Vos informations sont maintenant plus compl√®tes. **Y a-t-il des informations critiques que les secours devraient absolument conna√Ætre ?**

Par exemple : pacemaker, dialyse, handicap, etc.`,

    'aide': `Je peux vous aider avec :
‚Ä¢ ü©∏ Groupe sanguin
‚Ä¢ üíä M√©dicaments actuels  
‚Ä¢ üö´ Allergies
‚Ä¢ üè• Ant√©c√©dents m√©dicaux
‚Ä¢ üìû Contact d'urgence
‚Ä¢ ‚ö†Ô∏è Notes critiques

Tapez le sujet qui vous int√©resse !`
  };

  // Rechercher une r√©ponse appropri√©e
  for (const [keyword, response] of Object.entries(medicalQuestions)) {
    if (message.includes(keyword)) {
      return response;
    }
  }

  // R√©ponse par d√©faut
  return `Je ne comprends pas cette question m√©dicale. Tapez "aide" pour voir les sujets que je peux traiter, ou "commencer" pour l'√©valuation compl√®te.`;
}

function calculateCompletionFields(user) {
  let completed = 0;
  const total = 10;
  
  if (user.personalInfo?.firstName) completed++;
  if (user.personalInfo?.lastName) completed++;
  if (user.personalInfo?.dateOfBirth) completed++;
  if (user.personalInfo?.bloodType) completed++;
  if (user.personalInfo?.emergencyContact?.name) completed++;
  if (user.personalInfo?.emergencyContact?.phone) completed++;
  if (user.medicalHistory?.allergies?.length > 0) completed++;
  if (user.medicalHistory?.medications?.length > 0) completed++;
  if (user.medicalHistory?.chronicDiseases?.length > 0) completed++;
  if (user.emergencyInfo?.criticalNotes) completed++;
  
  return { completed, total };
}

// Fonction de d√©connexion simplifi√©e
function logout() {
  if (confirm('Voulez-vous vraiment vous d√©connecter ?')) {
    clearUser();
    if (auth && auth.currentUser) {
      auth.signOut();
    }
    showLogin();
  }
}

// Ic√¥nes manquantes
if (!icons.arrow) {
  icons.arrow = '<svg class="icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>';
}

// ========== OPTIMISATIONS MOBILE FINALES ==========

// Fonction de diagnostic et r√©paration pour mobile
window.diagnosticAndRepair = function() {
  console.log("üîß Diagnostic et r√©paration en cours...");
  
  const issues = [];
  const repairs = [];
  
  // V√©rifier la m√©moire
  if (performance.memory) {
    const memoryUsage = performance.memory.usedJSHeapSize / performance.memory.jsHeapSizeLimit;
    if (memoryUsage > 0.8) {
      issues.push("M√©moire satur√©e");
      repairs.push("Nettoyage de la m√©moire");
    }
  }
  
  // V√©rifier le localStorage
  try {
    const testKey = 'syl-test-' + Date.now();
    localStorage.setItem(testKey, 'test');
    localStorage.removeItem(testKey);
  } catch (e) {
    issues.push("Stockage local plein");
    repairs.push("Nettoyage du stockage");
  }
  
  // V√©rifier Firebase
  if (!firebase || !db || !auth) {
    issues.push("Firebase non initialis√©");
    repairs.push("R√©initialisation Firebase");
  }
  
  // Effectuer les r√©parations
  if (issues.length > 0) {
    console.log("üö® Probl√®mes d√©tect√©s:", issues);
    console.log("üîß R√©parations:", repairs);
    
    // Nettoyer la m√©moire
    if (window.gc) {
      window.gc();
    }
    
    // Nettoyer le cache
    clearExpiredCache();
    
    // Note: Firebase sera r√©initialis√© naturellement au prochain chargement
    console.log("‚ö†Ô∏è Probl√®mes d√©tect√©s mais pas de rechargement automatique");
    
    return false;
  }
  
  console.log("‚úÖ Aucun probl√®me d√©tect√©");
  return true;
};

// Nettoyage du cache expir√©
function clearExpiredCache() {
  const now = Date.now();
  const maxAge = 7 * 24 * 60 * 60 * 1000; // 7 jours
  
  Object.keys(localStorage).forEach(key => {
    if (key.startsWith('syl-cache-')) {
      try {
        const item = JSON.parse(localStorage.getItem(key));
        if (item.timestamp && (now - item.timestamp) > maxAge) {
          localStorage.removeItem(key);
          console.log("üóëÔ∏è Cache expir√© supprim√©:", key);
        }
      } catch (e) {
        // Supprimer les √©l√©ments corrompus
        localStorage.removeItem(key);
      }
    }
  });
}

// Fonction de synchronisation automatique des patients
window.autoSyncPatients = async function() {
  console.log("üîÑ V√©rification automatique des nouveaux patients...");
  
  // V√©rifier si on est admin
  const localUser = getCurrentUser();
  if (!localUser || localUser.role !== 'admin') {
    console.log("üë§ Auto-sync : pas admin, abandon");
    return;
  }
  
  // V√©rifier si Firebase est disponible
  if (!firebase || !db || typeof db.collection !== 'function') {
    console.log("üî• Auto-sync : Firebase non disponible");
    return;
  }
  
  try {
    // Charger les donn√©es locales avec timestamp
    const localData = loadPatientsWithTimestamp();
    const localPatients = localData.patients || [];
    const lastLocalUpdate = localData.lastUpdate || 0;
    
    console.log(`üìä Donn√©es locales: ${localPatients.length} patients, derni√®re MAJ: ${new Date(lastLocalUpdate).toLocaleString()}`);
    
    // V√©rifier s'il y a de nouveaux patients dans Firebase
    const firebaseSnapshot = await db.collection('users').where('role', '==', 'patient').get();
    const firebasePatients = [];
    
    firebaseSnapshot.forEach(doc => {
      const userData = doc.data();
      firebasePatients.push({
        id: doc.id,
        uid: userData.uid || doc.id,
        email: userData.email,
        createdAt: userData.createdAt || userData.timestamp,
        ...userData
      });
    });
    
    console.log(`üî• Firebase: ${firebasePatients.length} patients trouv√©s`);
    
    // Chercher les nouveaux patients (cr√©√©s apr√®s notre derni√®re sync)
    const newPatients = firebasePatients.filter(fbPatient => {
      // V√©rifier si le patient existe d√©j√† localement
      const existsLocally = localPatients.some(localPatient => 
        localPatient.id === fbPatient.id || 
        localPatient.uid === fbPatient.uid ||
        localPatient.email === fbPatient.email
      );
      
      if (existsLocally) return false;
      
      // V√©rifier si c'est un nouveau patient (cr√©√© apr√®s notre derni√®re sync)
      const patientCreatedAt = new Date(fbPatient.createdAt).getTime();
      return patientCreatedAt > lastLocalUpdate;
    });
    
    if (newPatients.length > 0) {
      console.log(`üÜï ${newPatients.length} nouveaux patients d√©tect√©s !`);
      
      // Charger les donn√©es m√©dicales pour les nouveaux patients
      const completeNewPatients = [];
      
      for (const patient of newPatients) {
        try {
          const medicalDoc = await db.collection('patients').doc(patient.id).get();
          const medicalData = medicalDoc.exists ? medicalDoc.data() : {};
          
          completeNewPatients.push({
            ...patient,
            personalInfo: medicalData.personalInfo || {},
            medicalInfo: medicalData.medicalInfo || {},
            emergencyContact: medicalData.emergencyContact || {},
            createdAt: patient.createdAt || new Date().toISOString()
          });
        } catch (err) {
          console.warn(`‚ö†Ô∏è Erreur chargement donn√©es patient ${patient.id}:`, err);
          completeNewPatients.push(patient);
        }
      }
      
      // Fusionner avec les patients existants
      const updatedPatients = [...localPatients, ...completeNewPatients];
      
      // Sauvegarder avec nouveau timestamp
      savePatientsWithTimestamp(updatedPatients);
      
      // Notification discr√®te
      const isMobile = window.innerWidth <= 768;
      if (isMobile) {
        console.log(`‚úÖ Auto-sync: ${newPatients.length} nouveaux patients ajout√©s silencieusement`);
      } else {
        // Sur PC, notification plus visible
        console.log(`‚úÖ Auto-sync: ${newPatients.length} nouveaux patients synchronis√©s`);
        
        // Petit popup discret en bas √† droite
        showDiscreetNotification(`üì• ${newPatients.length} nouveau${newPatients.length > 1 ? 'x' : ''} patient${newPatients.length > 1 ? 's' : ''} synchronis√©${newPatients.length > 1 ? 's' : ''}`);
      }
      
      // Mettre √† jour l'interface si on est sur l'admin
      if (window.location.hash === '' && document.querySelector('[data-tab="patients"]')) {
        console.log("üîÑ Rafra√Æchissement de l'interface admin");
        setTimeout(() => {
          if (window.renderApp) window.renderApp();
        }, 1000);
      }
      
      return newPatients.length;
    } else {
      console.log("‚úÖ Auto-sync: aucun nouveau patient");
      return 0;
    }
    
  } catch (error) {
    console.error("‚ùå Erreur auto-sync:", error);
    return -1;
  }
};

// Fonction pour afficher une notification discr√®te
function showDiscreetNotification(message) {
  const notification = document.createElement('div');
  notification.className = 'fixed bottom-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300';
  notification.textContent = message;
  
  document.body.appendChild(notification);
  
  // Animation d'entr√©e
  setTimeout(() => {
    notification.classList.remove('translate-x-full');
  }, 100);
  
  // Animation de sortie et suppression
  setTimeout(() => {
    notification.classList.add('translate-x-full');
    setTimeout(() => {
      document.body.removeChild(notification);
    }, 300);
  }, 3000);
}

// Fonction de synchronisation forc√©e pour mobile
window.forceMobileSync = function() {
  console.log("üîÑ Synchronisation forc√©e pour mobile...");
  
  // 1. Nettoyer tout le cache navigateur
  if ('caches' in window) {
    caches.keys().then(names => {
      names.forEach(name => caches.delete(name));
      console.log("üóëÔ∏è Cache navigateur nettoy√©");
    });
  }
  
  // 2. Nettoyer le localStorage (sauf donn√©es utilisateur critiques)
  const itemsToKeep = ['syl-user', 'syl-app-version', 'syl-build-date'];
  const allKeys = Object.keys(localStorage);
  
  allKeys.forEach(key => {
    if (!itemsToKeep.includes(key)) {
      localStorage.removeItem(key);
    }
  });
  console.log("üóëÔ∏è LocalStorage nettoy√©");
  
  // 3. D√©sactiver le cache pour cette session
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistrations().then(registrations => {
      registrations.forEach(registration => {
        registration.unregister();
      });
      console.log("üóëÔ∏è Service Workers d√©sactiv√©s");
    });
  }
  
  // 4. Forcer le rechargement des donn√©es depuis Firebase
  if (window.loadPatientsFromFirebase) {
    window.loadPatientsFromFirebase().then(() => {
      console.log("‚úÖ Donn√©es Firebase recharg√©es");
      // Forcer le re-render de l'interface
      if (window.renderApp) {
        window.renderApp();
      }
    }).catch(err => {
      console.error("‚ùå Erreur rechargement Firebase:", err);
      // En cas d'erreur, rechargement complet
      location.reload(true);
    });
  } else {
    // Si pas d'acc√®s Firebase, rechargement complet
    location.reload(true);
  }
  
  return true;
};

// Optimisations automatiques pour mobile
if (window.innerWidth <= 768) {
  console.log("üì± Activation des optimisations mobile");
  
  // Diagnostic √† la demande uniquement (pas automatique)
  console.log("‚úÖ Diagnostic disponible via diagnosticAndRepair()");
  
  // Nettoyage pr√©ventif du cache toutes les heures
  setInterval(clearExpiredCache, 60 * 60 * 1000);
  
  // Auto-synchronisation des nouveaux patients (mobile) - plus fr√©quente
  setInterval(async () => {
    try {
      await window.autoSyncPatients();
    } catch (err) {
      console.log("Auto-sync mobile error:", err);
    }
  }, 2 * 60 * 1000); // Toutes les 2 minutes sur mobile
  
  // Optimiser les performances de Firebase sur mobile
  if (db) {
    db.enablePersistence({ synchronizeTabs: false }).catch(err => {
      console.log("Persistence d√©j√† activ√©e:", err);
    });
  }
  
  // Pr√©charger les images critiques
  const criticalImages = [
    'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA4MDAgODAwIj48YyB4PSI4MDAiIHk9IjQ3MiIgY3g9IjE5MiIgY3k9IjI4IiByPSI1MiIvPjwvc3ZnPg=='
  ];
  
  criticalImages.forEach(src => {
    const img = new Image();
    img.src = src;
  });
} else {
  console.log("üíª Activation des optimisations PC");
  
  // Auto-synchronisation des nouveaux patients (PC) - moins fr√©quente
  setInterval(async () => {
    try {
      await window.autoSyncPatients();
    } catch (err) {
      console.log("Auto-sync PC error:", err);
    }
  }, 5 * 60 * 1000); // Toutes les 5 minutes sur PC
}

// Gestionnaire de visibilit√© de la page pour √©conomiser la batterie
document.addEventListener('visibilitychange', function() {
  if (document.hidden) {
    console.log("üì± Page cach√©e, r√©duction de l'activit√©");
    // R√©duire les timers et animations
  } else {
    console.log("üì± Page visible, reprise normale");
    // V√©rifier si une mise √† jour est n√©cessaire
    checkAndUpdateVersion();
    
    // Synchroniser les nouveaux patients quand l'onglet redevient actif
    setTimeout(async () => {
      try {
        console.log("üëÅÔ∏è Page redevenue visible - auto-sync");
        await window.autoSyncPatients();
      } catch (err) {
        console.log("Auto-sync au retour √©chou√©:", err);
      }
    }, 1000);
  }
});

// Message de debug pour les d√©veloppeurs
console.log(`üöÄ SYL Medical ${APP_VERSION} (${BUILD_DATE}) - Optimis√© pour mobile`);

// ========== SYST√àME DE DEBUG FIREBASE AVANC√â ==========

// Analyseur automatique des collections Firebase
window.debugFirebaseCollections = async function() {
  if (!db) {
    console.error("‚ùå Firebase non initialis√©");
    return;
  }
  
  console.log("üîç ANALYSE COMPL√àTE DES COLLECTIONS FIREBASE");
  console.log("=".repeat(60));
  
  const collections = ['patients', 'users', 'activeUsers', 'nfcTags', 'admins'];
  const analysis = {};
  
  for (const collectionName of collections) {
    try {
      console.log(`\nüìÅ Analyse de la collection "${collectionName}"...`);
      
      const snapshot = await db.collection(collectionName).get();
      const docs = [];
      const fieldStats = {};
      const typeStats = {};
      
      snapshot.forEach(doc => {
        const data = doc.data();
        docs.push({
          id: doc.id,
          data: data,
          size: JSON.stringify(data).length
        });
        
        // Analyser les champs et types
        analyzeFields(data, fieldStats, typeStats, '');
      });
      
      analysis[collectionName] = {
        count: docs.length,
        docs: docs,
        fieldStats: fieldStats,
        typeStats: typeStats,
        totalSize: docs.reduce((sum, doc) => sum + doc.size, 0)
      };
      
      // Afficher l'analyse
      console.log(`üìä Collection "${collectionName}":`);
      console.log(`   ‚Ä¢ Documents: ${docs.length}`);
      console.log(`   ‚Ä¢ Taille totale: ${(analysis[collectionName].totalSize / 1024).toFixed(2)} KB`);
      console.log(`   ‚Ä¢ Champs uniques: ${Object.keys(fieldStats).length}`);
      
      // Afficher les champs les plus fr√©quents
      const sortedFields = Object.entries(fieldStats)
        .sort((a, b) => b[1].count - a[1].count)
        .slice(0, 10);
      
      console.log(`   ‚Ä¢ Top champs:`);
      sortedFields.forEach(([field, stats]) => {
        const coverage = ((stats.count / docs.length) * 100).toFixed(1);
        // Protection pour √©viter les erreurs de type
        const typesSet = stats.types instanceof Set ? stats.types : new Set(Array.isArray(stats.types) ? stats.types : []);
        const typesArray = Array.from(typesSet);
        console.log(`     - ${field}: ${stats.count}/${docs.length} (${coverage}%) [${typesArray.join(', ')}]`);
      });
      
      // D√©tecter les incoh√©rences
      const inconsistencies = detectInconsistencies(docs, fieldStats);
      if (inconsistencies.length > 0) {
        console.warn(`   ‚ö†Ô∏è Incoh√©rences d√©tect√©es:`);
        inconsistencies.forEach(inc => console.warn(`     - ${inc}`));
      }
      
    } catch (error) {
      console.error(`‚ùå Erreur analyse collection "${collectionName}":`, error.message);
      analysis[collectionName] = { error: error.message };
    }
  }
  
  // G√©n√©rer des recommandations de nettoyage
  console.log("\nüõ†Ô∏è RECOMMANDATIONS DE NETTOYAGE:");
  console.log("=".repeat(40));
  generateCleanupRecommendations(analysis);
  
  // R√©sum√© global
  const successCount = Object.values(analysis).filter(data => !data.error).length;
  const errorCount = Object.values(analysis).filter(data => data.error).length;
  console.log(`\nüìä R√âSUM√â: ${successCount} collections analys√©es, ${errorCount} erreurs de permissions`);
  
  if (errorCount > 0) {
    console.log("\nüí° SOLUTION pour les erreurs de permissions:");
    console.log("1. V√©rifiez les r√®gles Firestore dans Firebase Console");
    console.log("2. Ajoutez les permissions pour ces collections:");
    Object.entries(analysis).forEach(([collection, data]) => {
      if (data.error && data.error.includes('permissions')) {
        console.log(`   - ${collection}: allow read: if isAdmin();`);
      }
    });
  }
  
  return analysis;
};

// Fonction d'analyse r√©cursive des champs
function analyzeFields(obj, fieldStats, typeStats, prefix = '') {
  if (!obj || typeof obj !== 'object') return;
  
  Object.entries(obj).forEach(([key, value]) => {
    const fieldPath = prefix ? `${prefix}.${key}` : key;
    const valueType = getDetailedType(value);
    
    if (!fieldStats[fieldPath]) {
      fieldStats[fieldPath] = { count: 0, types: new Set() };
    }
    
    fieldStats[fieldPath].count++;
    fieldStats[fieldPath].types.add(valueType);
    
    typeStats[valueType] = (typeStats[valueType] || 0) + 1;
    
    // Analyse r√©cursive pour les objets
    if (valueType === 'object' && value !== null) {
      analyzeFields(value, fieldStats, typeStats, fieldPath);
    }
  });
}

// D√©tection du type d√©taill√©
function getDetailedType(value) {
  if (value === null) return 'null';
  if (value === undefined) return 'undefined';
  if (Array.isArray(value)) return 'array';
  if (value instanceof Date) return 'date';
  if (typeof value === 'object' && value.seconds !== undefined) return 'timestamp';
  return typeof value;
}

// D√©tection des incoh√©rences
function detectInconsistencies(docs, fieldStats) {
  const issues = [];
  
  // Champs avec types multiples
  Object.entries(fieldStats).forEach(([field, stats]) => {
    // Protection pour √©viter les erreurs de type
    const typesSet = stats.types instanceof Set ? stats.types : new Set(Array.isArray(stats.types) ? stats.types : []);
    if (typesSet.size > 1) {
      const typesArray = Array.from(typesSet);
      issues.push(`"${field}" a plusieurs types: ${typesArray.join(', ')}`);
    }
  });
  
  // Documents avec structures tr√®s diff√©rentes
  if (docs.length > 1) {
    const fieldCounts = docs.map(doc => Object.keys(flattenObject(doc.data)).length);
    const avgFields = fieldCounts.reduce((a, b) => a + b, 0) / fieldCounts.length;
    const outliers = docs.filter((doc, i) => Math.abs(fieldCounts[i] - avgFields) > avgFields * 0.5);
    
    if (outliers.length > 0) {
      issues.push(`${outliers.length} documents avec structure atypique`);
    }
  }
  
  return issues;
}

// Aplatir un objet pour compter les champs
function flattenObject(obj, prefix = '') {
  const flattened = {};
  Object.entries(obj || {}).forEach(([key, value]) => {
    const newKey = prefix ? `${prefix}.${key}` : key;
    if (value && typeof value === 'object' && !Array.isArray(value)) {
      Object.assign(flattened, flattenObject(value, newKey));
    } else {
      flattened[newKey] = value;
    }
  });
  return flattened;
}

// G√©n√©rer des recommandations de nettoyage
function generateCleanupRecommendations(analysis) {
  Object.entries(analysis).forEach(([collection, data]) => {
    if (data.error) {
      if (data.error.includes('permissions')) {
        console.log(`üîí ${collection}: Permissions insuffisantes - Collection accessible mais lecture limit√©e`);
      } else {
        console.log(`‚ùå ${collection}: Erreur technique - ${data.error}`);
      }
      return;
    }
    
    console.log(`\nüìÅ ${collection.toUpperCase()}:`);
    
    if (data.count === 0) {
      console.log(`   ‚Ä¢ Collection vide - ${collection === 'nfcTags' ? 'Normal (fonctionnalit√© future)' : 'Consid√©rer la suppression'}`);
      return;
    }
    
    // Recommandations bas√©es sur les champs
    const requiredFields = getRequiredFieldsForCollection(collection);
    const missingFields = requiredFields.filter(field => 
      !data.fieldStats[field] || data.fieldStats[field].count < data.count * 0.8
    );
    
    if (missingFields.length > 0) {
      console.log(`   ‚Ä¢ Champs manquants (>20%): ${missingFields.join(', ')}`);
    } else {
      console.log(`   ‚Ä¢ ‚úÖ Structure conforme - Tous les champs requis pr√©sents`);
    }
    
    // Champs avec types incoh√©rents
    const inconsistentFields = Object.entries(data.fieldStats)
      .filter(([field, stats]) => {
        const typesSet = stats.types instanceof Set ? stats.types : new Set(Array.isArray(stats.types) ? stats.types : []);
        return typesSet.size > 1;
      })
      .map(([field]) => field);
    
    if (inconsistentFields.length > 0) {
      console.log(`   ‚Ä¢ ‚ö†Ô∏è Types incoh√©rents: ${inconsistentFields.join(', ')}`);
    }
    
    // Taille excessive
    if (data.totalSize > 100000) { // > 100KB
      console.log(`   ‚Ä¢ üì¶ Taille importante: ${(data.totalSize / 1024).toFixed(2)} KB - Optimisation recommand√©e`);
    }
    
    // Complexit√© des documents
    if (data.docs.length > 0) {
      const avgFields = Object.keys(data.fieldStats).length / data.docs.length;
      if (avgFields > 50) {
        console.log(`   ‚Ä¢ üîß Structure complexe: ${avgFields.toFixed(1)} champs/document en moyenne`);
      }
    }
  });
}

// D√©finir les champs requis par collection
function getRequiredFieldsForCollection(collection) {
  const schemas = {
    patients: ['id', 'email', 'personalInfo.firstName', 'personalInfo.lastName', 'role'],
    users: ['uid', 'email', 'role'],
    activeUsers: ['email', 'isOnline', 'lastLogin'],
    nfcTags: ['id', 'patientId', 'isActive'],
    admins: ['uid', 'email', 'permissions']
  };
  return schemas[collection] || [];
}

// Nettoyage automatique des donn√©es
window.cleanupFirebaseData = async function(options = {}) {
  console.log("üßπ NETTOYAGE AUTOMATIQUE DES DONN√âES");
  console.log("=".repeat(40));
  
  const {
    dryRun = true,
    fixTypes = true,
    addMissingFields = true,
    removeEmptyCollections = false
  } = options;
  
  if (dryRun) {
    console.log("üîç MODE TEST - Aucune modification ne sera effectu√©e");
  }
  
  const analysis = await window.debugFirebaseCollections();
  const cleanupActions = [];
  
  for (const [collection, data] of Object.entries(analysis)) {
    if (data.error) continue;
    
    for (const doc of data.docs) {
      const fixes = await generateDocumentFixes(collection, doc, data.fieldStats);
      if (fixes.length > 0) {
        cleanupActions.push({
          collection,
          docId: doc.id,
          fixes: fixes
        });
      }
    }
  }
  
  console.log(`\nüìã ${cleanupActions.length} actions de nettoyage identifi√©es`);
  
  if (!dryRun && cleanupActions.length > 0) {
    console.log("üîß Application des corrections...");
    // Appliquer les corrections ici
    for (const action of cleanupActions) {
      await applyDocumentFixes(action);
    }
    console.log("‚úÖ Nettoyage termin√©");
  }
  
  return cleanupActions;
};

// G√©n√©rer les corrections pour un document
async function generateDocumentFixes(collection, doc, fieldStats) {
  const fixes = [];
  const schema = getStandardSchema(collection);
  
  // Ajouter les champs manquants
  Object.entries(schema).forEach(([field, defaultValue]) => {
    if (!hasNestedField(doc.data, field)) {
      fixes.push({
        type: 'add_field',
        field: field,
        value: defaultValue
      });
    }
  });
  
  // Corriger les types incoh√©rents
  Object.entries(fieldStats).forEach(([field, stats]) => {
    if (stats.types.size > 1) {
      const currentValue = getNestedField(doc.data, field);
      const expectedType = getMostCommonType(stats.types);
      if (currentValue !== undefined && getDetailedType(currentValue) !== expectedType) {
        fixes.push({
          type: 'fix_type',
          field: field,
          currentValue: currentValue,
          expectedType: expectedType
        });
      }
    }
  });
  
  return fixes;
}

// Sch√©mas standards pour chaque collection
function getStandardSchema(collection) {
  const schemas = {
    patients: {
      'id': '',
      'email': '',
      'role': 'patient',
      'personalInfo.firstName': '',
      'personalInfo.lastName': '',
      'personalInfo.birthDate': '',
      'personalInfo.phone': '',
      'personalInfo.address': '',
      'personalInfo.bloodType': '',
      'medicalInfo.allergies': [],
      'medicalInfo.medications': [],
      'medicalInfo.conditions': [],
      'medicalInfo.emergencyNotes': '',
      'emergencyContact.name': '',
      'emergencyContact.relationship': '',
      'emergencyContact.phone': '',
      'isActive': true,
      'nfcTagId': null,
      'createdAt': new Date().toISOString(),
      'lastModified': firebase.firestore.FieldValue.serverTimestamp()
    },
    users: {
      'uid': '',
      'email': '',
      'role': 'patient',
      'profile.firstName': '',
      'profile.lastName': '',
      'profile.phone': '',
      'createdAt': new Date().toISOString()
    },
    nfcTags: {
      'id': '',
      'patientId': null,
      'isActive': true,
      'createdAt': new Date().toISOString()
    }
  };
  return schemas[collection] || {};
}

// Utilitaires pour les champs imbriqu√©s
function hasNestedField(obj, path) {
  return path.split('.').reduce((current, key) => current && current[key] !== undefined, obj);
}

function getNestedField(obj, path) {
  return path.split('.').reduce((current, key) => current && current[key], obj);
}

function getMostCommonType(types) {
  const typeArray = Array.from(types);
  if (typeArray.includes('string')) return 'string';
  if (typeArray.includes('object')) return 'object';
  if (typeArray.includes('array')) return 'array';
  return typeArray[0] || 'unknown';
}

// Fonctions de debug pour la synchronisation automatique (am√©lior√©es)
window.debugAutoSync = function() {
  const data = loadPatientsWithTimestamp();
  console.log("üìä √âtat de la synchronisation:");
  console.log("‚Ä¢ Patients locaux:", data.patients.length);
  console.log("‚Ä¢ Derni√®re mise √† jour:", data.age > 0 ? `${data.age.toFixed(1)}h ago` : "jamais");
  console.log("‚Ä¢ Donn√©es obsol√®tes:", data.isStale ? "OUI" : "NON");
  console.log("‚Ä¢ Plateforme:", window.innerWidth <= 768 ? "Mobile (sync 2min)" : "PC (sync 5min)");
  
  // Analyse rapide des donn√©es locales
  if (data.patients.length > 0) {
    const fields = data.patients.map(p => Object.keys(flattenObject(p)).length);
    console.log("‚Ä¢ Complexit√© moyenne:", (fields.reduce((a,b) => a+b, 0) / fields.length).toFixed(1), "champs/patient");
  }
  
  return data;
};

window.forceAutoSync = function() {
  console.log("üîÑ Synchronisation manuelle forc√©e...");
  return window.autoSyncPatients();
};

// Appliquer les corrections √† un document
async function applyDocumentFixes(action) {
  if (!db) return;
  
  try {
    const docRef = db.collection(action.collection).doc(action.docId);
    const updateData = {};
    
    for (const fix of action.fixes) {
      switch (fix.type) {
        case 'add_field':
          setNestedField(updateData, fix.field, fix.value);
          console.log(`‚ûï Ajout ${fix.field} = ${fix.value} dans ${action.collection}/${action.docId}`);
          break;
          
        case 'fix_type':
          const convertedValue = convertType(fix.currentValue, fix.expectedType);
          setNestedField(updateData, fix.field, convertedValue);
          console.log(`üîß Conversion ${fix.field}: ${fix.currentValue} ‚Üí ${convertedValue} dans ${action.collection}/${action.docId}`);
          break;
      }
    }
    
    if (Object.keys(updateData).length > 0) {
      await docRef.update(updateData);
      console.log(`‚úÖ Document ${action.docId} mis √† jour`);
    }
    
  } catch (error) {
    console.error(`‚ùå Erreur correction ${action.collection}/${action.docId}:`, error.message);
  }
}

// D√©finir une valeur dans un objet avec un chemin imbriqu√©
function setNestedField(obj, path, value) {
  const keys = path.split('.');
  const lastKey = keys.pop();
  const target = keys.reduce((current, key) => {
    if (!current[key]) current[key] = {};
    return current[key];
  }, obj);
  target[lastKey] = value;
}

// Convertir un type vers un autre
function convertType(value, targetType) {
  switch (targetType) {
    case 'string':
      return String(value || '');
    case 'number':
      return Number(value) || 0;
    case 'boolean':
      return Boolean(value);
    case 'array':
      return Array.isArray(value) ? value : [];
    case 'object':
      return (value && typeof value === 'object') ? value : {};
    case 'timestamp':
      return firebase.firestore.FieldValue.serverTimestamp();
    default:
      return value;
  }
}

// Migrer automatiquement les donn√©es vers une structure normalis√©e
window.migrateToStandardSchema = async function(collection = null) {
  console.log("üöÄ MIGRATION VERS SCH√âMA STANDARD");
  console.log("=".repeat(40));
  
  const collectionsToMigrate = collection ? [collection] : ['patients', 'users'];
  
  for (const coll of collectionsToMigrate) {
    console.log(`\nüìÅ Migration de la collection "${coll}"...`);
    
    try {
      const snapshot = await db.collection(coll).get();
      let migratedCount = 0;
      
      for (const doc of snapshot.docs) {
        const data = doc.data();
        const standardizedData = standardizeDocument(coll, data);
        
        if (JSON.stringify(data) !== JSON.stringify(standardizedData)) {
          await doc.ref.set(standardizedData, { merge: true });
          migratedCount++;
          console.log(`‚úÖ Document ${doc.id} standardis√©`);
        }
      }
      
      console.log(`üìä Collection "${coll}": ${migratedCount} documents migr√©s sur ${snapshot.size}`);
      
    } catch (error) {
      console.error(`‚ùå Erreur migration "${coll}":`, error.message);
    }
  }
  
  console.log("\nüéâ Migration termin√©e !");
};

// Standardiser un document selon son type
function standardizeDocument(collection, data) {
  const standardized = { ...data };
  
  switch (collection) {
    case 'patients':
      return standardizePatientDocument(standardized);
    case 'users':
      return standardizeUserDocument(standardized);
    default:
      return standardized;
  }
}

// Standardiser un document patient
function standardizePatientDocument(data) {
  const standard = {
    id: data.id || data.uid || '',
    uid: data.uid || data.id || '',
    email: data.email || '',
    role: 'patient',
    personalInfo: {
      firstName: data.personalInfo?.firstName || data.firstName || data.profile?.firstName || '',
      lastName: data.personalInfo?.lastName || data.lastName || data.profile?.lastName || '',
      birthDate: data.personalInfo?.birthDate || data.birthDate || '',
      phone: data.personalInfo?.phone || data.phone || data.profile?.phone || '',
      address: data.personalInfo?.address || data.address || '',
      bloodType: data.personalInfo?.bloodType || data.bloodType || ''
    },
    medicalInfo: {
      allergies: data.medicalInfo?.allergies || data.allergies || [],
      medications: data.medicalInfo?.medications || data.medications || [],
      conditions: data.medicalInfo?.conditions || data.conditions || [],
      emergencyNotes: data.medicalInfo?.emergencyNotes || data.emergencyNotes || ''
    },
    emergencyContact: {
      name: data.emergencyContact?.name || '',
      relationship: data.emergencyContact?.relationship || '',
      phone: data.emergencyContact?.phone || ''
    },
    isActive: data.isActive !== undefined ? data.isActive : true,
    nfcTagId: data.nfcTagId || null,
    createdAt: data.createdAt || data.timestamp || new Date().toISOString(),
    lastModified: firebase.firestore.FieldValue.serverTimestamp()
  };
  
  return standard;
}

// Standardiser un document utilisateur
function standardizeUserDocument(data) {
  return {
    uid: data.uid || data.id || '',
    email: data.email || '',
    role: data.role || 'patient',
    profile: {
      firstName: data.profile?.firstName || data.firstName || '',
      lastName: data.profile?.lastName || data.lastName || '',
      phone: data.profile?.phone || data.phone || ''
    },
    createdAt: data.createdAt || data.timestamp || new Date().toISOString(),
    lastModified: firebase.firestore.FieldValue.serverTimestamp()
  };
}

console.log("üõ†Ô∏è Fonctions debug disponibles:");
console.log("‚Ä¢ debugAutoSync() - Voir l'√©tat de sync");
console.log("‚Ä¢ forceAutoSync() - Forcer une sync maintenant");
console.log("‚Ä¢ forceMobileSync() - Sync compl√®te mobile");
console.log("‚Ä¢ debugFirebaseCollections() - Analyser toutes les collections");
console.log("‚Ä¢ cleanupFirebaseData({dryRun: false}) - Nettoyer les donn√©es");
console.log("‚Ä¢ migrateToStandardSchema() - Migrer vers sch√©ma standard");

// Fonction de diagnostic rapide
window.quickDiagnosis = async function() {
  console.log("üè• DIAGNOSTIC RAPIDE SYL MEDICAL");
  console.log("=".repeat(40));
  
  // √âtat Firebase
  console.log("üî• Firebase:", typeof firebase !== 'undefined' ? "‚úÖ OK" : "‚ùå Erreur");
  
  // √âtat de l'utilisateur
  const user = getUser();
  console.log("üë§ Utilisateur:", user ? `‚úÖ ${user.email} (${user.role})` : "‚ùå Non connect√©");
  
  // √âtat des collections (rapide)
  if (db) {
    try {
      const patientsCount = (await db.collection('patients').limit(1).get()).size;
      console.log("üìä Collections:", patientsCount >= 0 ? "‚úÖ Accessibles" : "‚ùå Inaccessibles");
    } catch (error) {
      console.log("üìä Collections:", "‚ùå Erreur permissions");
    }
  }
  
  // √âtat localStorage
  const localData = localStorage.getItem('syl-patients');
  console.log("üíæ Cache local:", localData ? "‚úÖ Pr√©sent" : "‚ö†Ô∏è Vide");
  
  // Recommandations
  console.log("\nüí° Actions recommand√©es:");
  if (!user) console.log("   ‚Ä¢ Se connecter avec un compte admin");
  if (db) console.log("   ‚Ä¢ Ex√©cuter debugFirebaseCollections() pour analyse compl√®te");
  else console.log("   ‚Ä¢ V√©rifier la configuration Firebase");
  
  return {
    firebase: typeof firebase !== 'undefined',
    user: user,
    collections: !!db,
    localStorage: !!localData
  };
};

// Test final de fonctionnement
setTimeout(() => {
  if (typeof renderApp === 'function') {
    console.log("‚úÖ Application pr√™te");
  } else {
    console.error("‚ùå Erreur critique: renderApp non d√©finie");
    location.reload();
  }
}, 2000);

// Nettoyage des listeners Firestore √† la fermeture de la page
window.addEventListener('beforeunload', async () => {
  console.log("üîÑ Nettoyage avant fermeture de page");
  cleanupRealtimeSync();
  
  // Marquer l'utilisateur comme hors ligne
  const user = getCurrentUser();
  if (user?.email) {
    await removeCurrentUserFromFirestore(user.email);
  }
});

// Gestion des erreurs globales pour Firestore
window.addEventListener('error', (event) => {
  if (event.error && event.error.message.includes('firestore')) {
    console.error("‚ùå Erreur Firestore globale:", event.error);
  }
});

console.log("üî• Syst√®me Firestore temps r√©el initialis√©");
</script>
</body>
</html>
